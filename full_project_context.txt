# SYSTEM CONTEXT FILE
# This file contains the full source code of the project.
# USE THIS CONTEXT to understand architecture, debugging, and adding features.

üìä PROJECT STATISTICS
=====================
Files: 68
Lines: 7382
Tokens: ~77907

üõ† KEY DEPENDENCIES
====================

--- docker-compose.yml ---
#version: '3.8'

services:
  # --- 1. –°–ï–†–í–Ü–° –¢–û–í–ê–†–Ü–í (Backend) ---
  product_service:
    build: ./product_service
    container_name: pos_product_service
    restart: always
    ports:
      - "8001:8000"
    environment:
      # –ó–≤'—è–∑–æ–∫ –∑ –±–∞–∑–æ—é –¥–∞–Ω–∏—Ö (postgres_db - —Ü–µ –Ω–∞–∑–≤–∞ —Å–µ—Ä–≤—ñ—Å—É –Ω–∏–∂—á–µ)
      - DATABASE_URL=postgresql://user:password@postgres_db:5432/products_db
    depends_on:
      postgres_db: 
        condition: service_healthy  # <--- –ß–µ–∫–∞—Ç–∏, –ø–æ–∫–∏ –±–∞–∑–∞ —Å–∫–∞–∂–µ "–Ø –∑–¥–æ—Ä–æ–≤–∞"
        

  # --- 2. –ë–ê–ó–ê –î–ê–ù–ò–• –¢–û–í–ê–†–Ü–í (PostgreSQL) ---
  postgres_db:
    image: postgres:13
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d products_db"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s
    container_name: pos_postgres
    restart: always
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: products_db
    volumes:
      # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –¥–∞–Ω—ñ –Ω–∞ –¥–∏—Å–∫—É, —â–æ–± –Ω–µ –∑–Ω–∏–∫–∞–ª–∏ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫—É
      - postgres_data:/var/lib/postgresql/data

  # --- 3. –°–ï–†–í–Ü–° –ö–û–®–ò–ö–ê (Backend) ---
  order_service:
    build: ./order_service
    container_name: pos_order_service
    restart: always
    environment:
      # –ó–≤'—è–∑–æ–∫ –∑ Redis
      - REDIS_HOST=redis_db
    depends_on:
      postgres_db:
        condition: service_healthy

  # --- 4. –ë–ê–ó–ê –î–ê–ù–ò–• –ö–û–®–ò–ö–ê (Redis) ---
  redis_db:
    image: redis:alpine
    container_name: pos_redis
    restart: always

  # --- 5. –í–•–Ü–î–ù–Ü –í–û–†–û–¢–ê (Nginx) ---
  frontend:  # <-- –ù–û–í–ê –ù–ê–ó–í–ê (–±—É–ª–æ nginx –∞–±–æ gateway)
    build: ./frontend
    container_name: pos_frontend # <-- –ù–û–í–ï –Ü–ú'–Ø –ö–û–ù–¢–ï–ô–ù–ï–†–ê
    restart: always
    ports:
      - "8080:80"
    depends_on:
      - product_service
      - order_service

# –û–≥–æ–ª–æ—à—É—î–º–æ —Ç–æ–º–∏ –¥–ª—è –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö
volumes:
  postgres_data:


--- package.json ---
{
  "name": "frontend",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "axios": "^1.7.0",
    "vue": "^3.5.24"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4.1.18",
    "@vitejs/plugin-vue": "^6.0.1",
    "autoprefixer": "^10.4.17",
    "postcss": "^8.4.33",
    "tailwindcss": "^3.4.17",
    "vite": "^7.2.4"
  }
}


--- requirements.txt ---
fastapi
uvicorn
redis
pydantic


--- requirements.txt ---
fastapi
uvicorn
sqlalchemy
psycopg2-binary
pydantic
pytest==8.0.0
httpx==0.26.0


üó∫ ARCHITECTURE MAP (Key Symbols)
================================
frontend\src\App.vue
  ‚îî‚îÄ‚îÄ üíæ State: currentPage
  ‚îî‚îÄ‚îÄ üíæ State: isCartOpen
  ‚îî‚îÄ‚îÄ üíæ State: isModalOpen
  ‚îî‚îÄ‚îÄ üíæ State: selectedProduct
frontend\src\components\common\IngredientSelect.vue
  ‚îî‚îÄ‚îÄ üíæ State: isOpen
  ‚îî‚îÄ‚îÄ üíæ State: searchQuery
  ‚îî‚îÄ‚îÄ üíæ State: containerRef
frontend\src\components\crm\Customers.vue
  ‚îî‚îÄ‚îÄ üíæ State: customers
  ‚îî‚îÄ‚îÄ üíæ State: showModal
  ‚îî‚îÄ‚îÄ üíæ State: searchQuery
  ‚îî‚îÄ‚îÄ üíæ State: isEditing
  ‚îî‚îÄ‚îÄ üíæ State: editingId
  ‚îî‚îÄ‚îÄ üíæ State: formData
frontend\src\components\pos\CartDrawer.vue
  ‚îî‚îÄ‚îÄ üíæ State: customerSearch
  ‚îî‚îÄ‚îÄ üíæ State: customerResults
frontend\src\components\pos\ProductModal.vue
  ‚îî‚îÄ‚îÄ üíæ State: selectedVariant
  ‚îî‚îÄ‚îÄ üíæ State: selectedModifiers
  ‚îî‚îÄ‚îÄ üíæ State: selectedProcesses
frontend\src\components\warehouse\Warehouse.vue
  ‚îî‚îÄ‚îÄ üíæ State: activeTab
frontend\src\components\warehouse\modals\HistoryModal.vue
  ‚îî‚îÄ‚îÄ üíæ State: history
  ‚îî‚îÄ‚îÄ üíæ State: loading
  ‚îî‚îÄ‚îÄ üíæ State: error
frontend\src\components\warehouse\tabs\CategoriesTab.vue
  ‚îî‚îÄ‚îÄ üíæ State: newCategory
  ‚îî‚îÄ‚îÄ üíæ State: isEditing
  ‚îî‚îÄ‚îÄ üíæ State: editingId
frontend\src\components\warehouse\tabs\ConsumablesTab.vue
  ‚îî‚îÄ‚îÄ üíæ State: categories
  ‚îî‚îÄ‚îÄ üíæ State: newConsumable
frontend\src\components\warehouse\tabs\IngredientsTab.vue
  ‚îî‚îÄ‚îÄ üíæ State: categories
  ‚îî‚îÄ‚îÄ üíæ State: newIngredient
frontend\src\components\warehouse\tabs\ProcessesTab.vue
  ‚îî‚îÄ‚îÄ üíæ State: newProcessGroup
frontend\src\components\warehouse\tabs\ProductsTab.vue
  ‚îî‚îÄ‚îÄ üíæ State: showTypeModal
  ‚îî‚îÄ‚îÄ üíæ State: showForm
  ‚îî‚îÄ‚îÄ üíæ State: productType
  ‚îî‚îÄ‚îÄ üíæ State: serverCalculatedCost
  ‚îî‚îÄ‚îÄ üíæ State: tempSimpleIngredient
  ‚îî‚îÄ‚îÄ üíæ State: tempSimpleConsumable
frontend\src\components\warehouse\tabs\RecipesTab.vue
  ‚îî‚îÄ‚îÄ üíæ State: editingRecipeId
  ‚îî‚îÄ‚îÄ üíæ State: newRecipe
  ‚îî‚îÄ‚îÄ üíæ State: tempRecipeItem
frontend\src\components\warehouse\tabs\StockTab.vue
  ‚îî‚îÄ‚îÄ üíæ State: activeTab
  ‚îî‚îÄ‚îÄ üíæ State: search
  ‚îî‚îÄ‚îÄ üíæ State: loading
  ‚îî‚îÄ‚îÄ üíæ State: editingItemKey
  ‚îî‚îÄ‚îÄ üíæ State: editValue
  ‚îî‚îÄ‚îÄ üíæ State: isHistoryOpen
  ‚îî‚îÄ‚îÄ üíæ State: historyItem
frontend\src\components\warehouse\tabs\UnitsTab.vue
  ‚îî‚îÄ‚îÄ üíæ State: newUnit
frontend\src\components\warehouse\tabs\products\ProductFormSimple.vue
  ‚îî‚îÄ‚îÄ üíæ State: tempSimpleIngredient
  ‚îî‚îÄ‚îÄ üíæ State: tempProductConsumable
  ‚îî‚îÄ‚îÄ üíæ State: serverCalculatedCost
frontend\src\components\warehouse\tabs\products\ProductFormVariant.vue
  ‚îî‚îÄ‚îÄ üíæ State: activeTab
  ‚îî‚îÄ‚îÄ üíæ State: showVariantForm
  ‚îî‚îÄ‚îÄ üíæ State: tempCommonIngredient
frontend\src\components\warehouse\tabs\products\ProductsTab.vue
  ‚îî‚îÄ‚îÄ üíæ State: showTypeModal
  ‚îî‚îÄ‚îÄ üíæ State: showSimpleForm
  ‚îî‚îÄ‚îÄ üíæ State: showVariantForm
  ‚îî‚îÄ‚îÄ üíæ State: isEditing
frontend\src\composables\useCart.js
  ‚îî‚îÄ‚îÄ üíæ State: cartItems
  ‚îî‚îÄ‚îÄ üíæ State: isProcessing
  ‚îî‚îÄ‚îÄ üíæ State: paymentMethod
  ‚îî‚îÄ‚îÄ üíæ State: selectedCustomer
frontend\src\composables\useCustomers.js
  ‚îî‚îÄ‚îÄ üíæ State: customers
  ‚îî‚îÄ‚îÄ üíæ State: loading
  ‚îî‚îÄ‚îÄ üíæ State: searchQuery
  ‚îî‚îÄ‚îÄ üíæ State: showModal
  ‚îî‚îÄ‚îÄ üíæ State: isEditing
  ‚îî‚îÄ‚îÄ üíæ State: editingId
  ‚îî‚îÄ‚îÄ üíæ State: formData
  ‚îî‚îÄ‚îÄ üíæ State: showHistoryModal
  ‚îî‚îÄ‚îÄ üíæ State: historyLoading
  ‚îî‚îÄ‚îÄ üíæ State: currentCustomerHistory
frontend\src\composables\useProducts.js
  ‚îî‚îÄ‚îÄ üíæ State: newProduct
  ‚îî‚îÄ‚îÄ üíæ State: editingId
  ‚îî‚îÄ‚îÄ üíæ State: isEditing
  ‚îî‚îÄ‚îÄ üíæ State: productSearch
  ‚îî‚îÄ‚îÄ üíæ State: editingVariantIndex
  ‚îî‚îÄ‚îÄ üíæ State: tempProductConsumable
  ‚îî‚îÄ‚îÄ üíæ State: tempVariantConsumable
  ‚îî‚îÄ‚îÄ üíæ State: tempVariantIngredient
  ‚îî‚îÄ‚îÄ üíæ State: variantBuilder
  ‚îî‚îÄ‚îÄ üíæ State: products
frontend\src\composables\useStatistics.js
  ‚îî‚îÄ‚îÄ üíæ State: orders
  ‚îî‚îÄ‚îÄ üíæ State: loading
  ‚îî‚îÄ‚îÄ üíæ State: showDetailModal
  ‚îî‚îÄ‚îÄ üíæ State: selectedOrder
frontend\src\composables\useWarehouse.js
  ‚îî‚îÄ‚îÄ üíæ State: products
  ‚îî‚îÄ‚îÄ üíæ State: categories
  ‚îî‚îÄ‚îÄ üíæ State: units
  ‚îî‚îÄ‚îÄ üíæ State: ingredients
  ‚îî‚îÄ‚îÄ üíæ State: consumables
  ‚îî‚îÄ‚îÄ üíæ State: processGroups
  ‚îî‚îÄ‚îÄ üíæ State: recipes
  ‚îî‚îÄ‚îÄ üíæ State: loading
order_service\main.py
  ‚îî‚îÄ‚îÄ ∆í  def read_root
  ‚îî‚îÄ‚îÄ ∆í  def get_cart
  ‚îî‚îÄ‚îÄ ∆í  def add_item
  ‚îî‚îÄ‚îÄ ∆í  def update_quantity
  ‚îî‚îÄ‚îÄ ∆í  def remove_item
  ‚îî‚îÄ‚îÄ ∆í  def clear_cart
order_service\schemas.py
  ‚îî‚îÄ‚îÄ üì¶ class ModifierItem
  ‚îî‚îÄ‚îÄ üì¶ class CartItemCreate
  ‚îî‚îÄ‚îÄ üì¶ class CartItem
product_service\database.py
  ‚îî‚îÄ‚îÄ ∆í  def get_db
product_service\main.py
  ‚îî‚îÄ‚îÄ ∆í  def read_root
product_service\models.py
  ‚îî‚îÄ‚îÄ üì¶ class Category
  ‚îî‚îÄ‚îÄ üì¶ class Unit
  ‚îî‚îÄ‚îÄ üì¶ class Ingredient
  ‚îî‚îÄ‚îÄ üì¶ class Consumable
  ‚îî‚îÄ‚îÄ üì¶ class MasterRecipe
  ‚îî‚îÄ‚îÄ üì¶ class MasterRecipeItem
  ‚îî‚îÄ‚îÄ üì¶ class ProcessGroup
  ‚îî‚îÄ‚îÄ üì¶ class ProcessOption
  ‚îî‚îÄ‚îÄ üì¶ class ProductConsumable
  ‚îî‚îÄ‚îÄ üì¶ class ProductIngredient
product_service\schemas.py
  ‚îî‚îÄ‚îÄ üì¶ class Category
  ‚îî‚îÄ‚îÄ üì¶ class Config from_attributes = True
  ‚îî‚îÄ‚îÄ üì¶ class CategoryCreate
  ‚îî‚îÄ‚îÄ üì¶ class Unit
  ‚îî‚îÄ‚îÄ üì¶ class Config from_attributes = True
  ‚îî‚îÄ‚îÄ üì¶ class UnitCreate
  ‚îî‚îÄ‚îÄ üì¶ class IngredientCreate
  ‚îî‚îÄ‚îÄ üì¶ class Ingredient
  ‚îî‚îÄ‚îÄ üì¶ class Config from_attributes = True
  ‚îî‚îÄ‚îÄ üì¶ class ConsumableBase
product_service\routers\categories.py
  ‚îî‚îÄ‚îÄ üåê Router: router
  ‚îî‚îÄ‚îÄ ∆í  def create_category
  ‚îî‚îÄ‚îÄ ∆í  def read_categories
  ‚îî‚îÄ‚îÄ ∆í  def update_category
  ‚îî‚îÄ‚îÄ ∆í  def delete_category
product_service\routers\customers.py
  ‚îî‚îÄ‚îÄ üåê Router: router
  ‚îî‚îÄ‚îÄ ∆í  def create_customer
  ‚îî‚îÄ‚îÄ ∆í  def search_customers
  ‚îî‚îÄ‚îÄ ∆í  def read_customers
  ‚îî‚îÄ‚îÄ ∆í  def update_customer
  ‚îî‚îÄ‚îÄ ∆í  def delete_customer
  ‚îî‚îÄ‚îÄ ∆í  def read_customer_orders
product_service\routers\inventory.py
  ‚îî‚îÄ‚îÄ üåê Router: router
  ‚îî‚îÄ‚îÄ ∆í  def create_unit
  ‚îî‚îÄ‚îÄ ∆í  def read_units
  ‚îî‚îÄ‚îÄ ∆í  def create_ingredient
  ‚îî‚îÄ‚îÄ ∆í  def read_ingredients
  ‚îî‚îÄ‚îÄ ∆í  def update_ingredient
  ‚îî‚îÄ‚îÄ ∆í  def delete_ingredient
  ‚îî‚îÄ‚îÄ ∆í  def create_consumable
  ‚îî‚îÄ‚îÄ ∆í  def read_consumables
  ‚îî‚îÄ‚îÄ ∆í  def update_consumable
product_service\routers\orders.py
  ‚îî‚îÄ‚îÄ üåê Router: router
  ‚îî‚îÄ‚îÄ ∆í  def checkout
  ‚îî‚îÄ‚îÄ ∆í  def get_orders
product_service\routers\processes.py
  ‚îî‚îÄ‚îÄ üåê Router: router
  ‚îî‚îÄ‚îÄ ∆í  def create_process_group
  ‚îî‚îÄ‚îÄ ∆í  def read_process_groups
  ‚îî‚îÄ‚îÄ ∆í  def delete_process_group
  ‚îî‚îÄ‚îÄ ∆í  def add_process_option
  ‚îî‚îÄ‚îÄ ∆í  def delete_process_option
product_service\routers\products.py
  ‚îî‚îÄ‚îÄ üåê Router: router
  ‚îî‚îÄ‚îÄ ∆í  def calculate_cost
  ‚îî‚îÄ‚îÄ ∆í  def create_product
  ‚îî‚îÄ‚îÄ ∆í  def update_product
  ‚îî‚îÄ‚îÄ ∆í  def read_products
  ‚îî‚îÄ‚îÄ ∆í  def read_product
  ‚îî‚îÄ‚îÄ ∆í  def delete_product
  ‚îî‚îÄ‚îÄ ∆í  def update_stock
  ‚îî‚îÄ‚îÄ ∆í  def deduct_stock_for_order
product_service\routers\recipes.py
  ‚îî‚îÄ‚îÄ üåê Router: router
  ‚îî‚îÄ‚îÄ ∆í  def create_recipe
  ‚îî‚îÄ‚îÄ ∆í  def read_recipes
  ‚îî‚îÄ‚îÄ ∆í  def update_recipe
  ‚îî‚îÄ‚îÄ ∆í  def delete_recipe
product_service\services\inventory_logger.py
  ‚îî‚îÄ‚îÄ üì¶ class InventoryLogger
  ‚îî‚îÄ‚îÄ ∆í  def log
product_service\services\order_service.py
  ‚îî‚îÄ‚îÄ üì¶ class OrderService
  ‚îî‚îÄ‚îÄ ∆í  def process_checkout
product_service\services\product_service.py
  ‚îî‚îÄ‚îÄ üì¶ class ProductService
  ‚îî‚îÄ‚îÄ ∆í  def calculate_product_cost
  ‚îî‚îÄ‚îÄ ∆í  def create_product
  ‚îî‚îÄ‚îÄ ∆í  def update_product
product_service\tests\conftest.py
  ‚îî‚îÄ‚îÄ ∆í  def db_session
  ‚îî‚îÄ‚îÄ ∆í  def client
  ‚îî‚îÄ‚îÄ ∆í  def override_get_db
product_service\tests\test_categories.py
  ‚îî‚îÄ‚îÄ ∆í  def test_create_category_success
  ‚îî‚îÄ‚îÄ ∆í  def test_create_subcategory
  ‚îî‚îÄ‚îÄ ∆í  def test_create_category_duplicate_slug
  ‚îî‚îÄ‚îÄ ∆í  def test_update_category
  ‚îî‚îÄ‚îÄ ∆í  def test_delete_category
product_service\tests\test_consumables.py
  ‚îî‚îÄ‚îÄ ∆í  def test_create_consumable_basic
  ‚îî‚îÄ‚îÄ ∆í  def test_create_consumable_with_category
  ‚îî‚îÄ‚îÄ ∆í  def test_update_consumable_stock
  ‚îî‚îÄ‚îÄ ∆í  def test_delete_consumable
product_service\tests\test_orders.py
  ‚îî‚îÄ‚îÄ ∆í  def setup_menu
  ‚îî‚îÄ‚îÄ ∆í  def test_create_order_zero_trust
  ‚îî‚îÄ‚îÄ ∆í  def test_order_validation_stock
product_service\tests\test_warehouse.py
  ‚îî‚îÄ‚îÄ ∆í  def test_create_unit
  ‚îî‚îÄ‚îÄ ∆í  def test_create_ingredient_simple
  ‚îî‚îÄ‚îÄ ∆í  def test_create_ingredient_with_category
  ‚îî‚îÄ‚îÄ ∆í  def test_ingredient_validation
  ‚îî‚îÄ‚îÄ ∆í  def test_list_ingredients

üå≥ PROJECT TREE
===============
üìÇ /
    üìÑ docker-compose.prod.yml
    üìÑ docker-compose.yml
    üìÇ .github/
        üìÇ workflows/
            üìÑ deploy.yml
    üìÇ frontend/
        üìÑ Dockerfile
        üìÑ README.md
        üìÑ index.html
        üìÑ nginx.conf
        üìÑ package.json
        üìÑ postcss.config.js
        üìÑ tailwind.config.js
        üìÑ vite.config.js
        üìÇ public/
        üìÇ src/
            üìÑ App.vue
            üìÑ main.js
            üìÑ style.css
            üìÇ components/
                üìÇ common/
                    üìÑ IngredientSelect.vue
                    üìÑ Sidebar.vue
                üìÇ crm/
                    üìÑ Customers.vue
                    üìÑ CustomersTable.vue
                üìÇ pos/
                    üìÑ CartDrawer.vue
                    üìÑ ProductCard.vue
                    üìÑ ProductModal.vue
                üìÇ stats/
                    üìÑ SalesTable.vue
                    üìÑ Statistics.vue
                üìÇ warehouse/
                    üìÑ Warehouse.vue
                    üìÇ modals/
                        üìÑ HistoryModal.vue
                    üìÇ tabs/
                        üìÑ CategoriesTab.vue
                        üìÑ ConsumablesTab.vue
                        üìÑ IngredientsTab.vue
                        üìÑ ProcessesTab.vue
                        üìÑ ProductsTab.vue
                        üìÑ RecipesTab.vue
                        üìÑ StockTab.vue
                        üìÑ UnitsTab.vue
                        üìÇ products/
                            üìÑ ProductFormSimple.vue
                            üìÑ ProductFormVariant.vue
                            üìÑ ProductsTab.vue
            üìÇ composables/
                üìÑ useCart.js
                üìÑ useCustomers.js
                üìÑ useProducts.js
                üìÑ useStatistics.js
                üìÑ useWarehouse.js
    üìÇ order_service/
        üìÑ Dockerfile
        üìÑ main.py
        üìÑ requirements.txt
        üìÑ schemas.py
    üìÇ product_service/
        üìÑ Dockerfile
        üìÑ database.py
        üìÑ main.py
        üìÑ models.py
        üìÑ requirements.txt
        üìÑ schemas.py
        üìÇ routers/
            üìÑ __init__.py
            üìÑ categories.py
            üìÑ customers.py
            üìÑ inventory.py
            üìÑ orders.py
            üìÑ processes.py
            üìÑ products.py
            üìÑ recipes.py
        üìÇ services/
            üìÑ __init__.py
            üìÑ inventory_logger.py
            üìÑ order_service.py
            üìÑ product_service.py
        üìÇ tests/
            üìÑ conftest.py
            üìÑ test_categories.py
            üìÑ test_consumables.py
            üìÑ test_orders.py
            üìÑ test_warehouse.py

üì¶ FILE CONTENTS
================

<file path="docker-compose.prod.yml">
services:
  # --- 1. –°–ï–†–í–Ü–° –¢–û–í–ê–†–Ü–í (Backend) ---
  product_service:
    # –§–æ—Ä–º–∞—Ç: ghcr.io/—é–∑–µ—Ä–Ω–µ–π–º/—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π/–Ω–∞–∑–≤–∞_—Å–µ—Ä–≤—ñ—Å—É:—Ç–µ–≥
    image: ghcr.io/serg333soul/pos-system/product_service:latest
    pull_policy: always 

  # --- 3. –°–ï–†–í–Ü–° –ö–û–®–ò–ö–ê (Backend) ---
  order_service:
    image: ghcr.io/serg333soul/pos-system/order_service:latest
    pull_policy: always

  # --- 5. –í–•–Ü–î–ù–Ü –í–û–†–û–¢–ê (Nginx) ---
  frontend:
    image: ghcr.io/serg333soul/pos-system/frontend:latest
    pull_policy: always
</file>

<file path="docker-compose.yml">
#version: '3.8'

services:
  # --- 1. –°–ï–†–í–Ü–° –¢–û–í–ê–†–Ü–í (Backend) ---
  product_service:
    build: ./product_service
    container_name: pos_product_service
    restart: always
    ports:
      - "8001:8000"
    environment:
      # –ó–≤'—è–∑–æ–∫ –∑ –±–∞–∑–æ—é –¥–∞–Ω–∏—Ö (postgres_db - —Ü–µ –Ω–∞–∑–≤–∞ —Å–µ—Ä–≤—ñ—Å—É –Ω–∏–∂—á–µ)
      - DATABASE_URL=postgresql://user:password@postgres_db:5432/products_db
    depends_on:
      postgres_db: 
        condition: service_healthy  # <--- –ß–µ–∫–∞—Ç–∏, –ø–æ–∫–∏ –±–∞–∑–∞ —Å–∫–∞–∂–µ "–Ø –∑–¥–æ—Ä–æ–≤–∞"
        

  # --- 2. –ë–ê–ó–ê –î–ê–ù–ò–• –¢–û–í–ê–†–Ü–í (PostgreSQL) ---
  postgres_db:
    image: postgres:13
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d products_db"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s
    container_name: pos_postgres
    restart: always
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: products_db
    volumes:
      # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –¥–∞–Ω—ñ –Ω–∞ –¥–∏—Å–∫—É, —â–æ–± –Ω–µ –∑–Ω–∏–∫–∞–ª–∏ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫—É
      - postgres_data:/var/lib/postgresql/data

  # --- 3. –°–ï–†–í–Ü–° –ö–û–®–ò–ö–ê (Backend) ---
  order_service:
    build: ./order_service
    container_name: pos_order_service
    restart: always
    environment:
      # –ó–≤'—è–∑–æ–∫ –∑ Redis
      - REDIS_HOST=redis_db
    depends_on:
      postgres_db:
        condition: service_healthy

  # --- 4. –ë–ê–ó–ê –î–ê–ù–ò–• –ö–û–®–ò–ö–ê (Redis) ---
  redis_db:
    image: redis:alpine
    container_name: pos_redis
    restart: always

  # --- 5. –í–•–Ü–î–ù–Ü –í–û–†–û–¢–ê (Nginx) ---
  frontend:  # <-- –ù–û–í–ê –ù–ê–ó–í–ê (–±—É–ª–æ nginx –∞–±–æ gateway)
    build: ./frontend
    container_name: pos_frontend # <-- –ù–û–í–ï –Ü–ú'–Ø –ö–û–ù–¢–ï–ô–ù–ï–†–ê
    restart: always
    ports:
      - "8080:80"
    depends_on:
      - product_service
      - order_service

# –û–≥–æ–ª–æ—à—É—î–º–æ —Ç–æ–º–∏ –¥–ª—è –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö
volumes:
  postgres_data:

</file>

<file path=".github\workflows\deploy.yml">
name: CI/CD Pipeline

on:
  # –ó–∞–ø—É—Å–∫–∞—î–º–æ –Ω–∞ main (–¥–ª—è –¥–µ–ø–ª–æ—é)
  push:
    branches: [ "main" ]
  # –ó–∞–ø—É—Å–∫–∞—î–º–æ –Ω–∞ –±—É–¥—å-—è–∫–æ–º—É PR –≤ main (–¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–æ–∫)
  pull_request:
    branches: [ "main" ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # --- 1. –¢–ï–°–¢–ò (–ó–∞–ø—É—Å–∫–∞—é—Ç—å—Å—è –ó–ê–í–ñ–î–ò) ---
  test:
    name: Run Unit Tests   # <--- –û—Å—å —Ü–µ —ñ–º'—è –º–∏ —à—É–∫–∞—î–º–æ –≤ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è—Ö
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      # –Ü–º—ñ—Ç–∞—Ü—ñ—è —Ç–µ—Å—Ç—É. –ü—ñ–∑–Ω—ñ—à–µ —Ç—É—Ç –±—É–¥–µ 'pytest'
      - name: Run Dummy Test
        run: echo "All tests passed! System is ready."

  # --- 2. –î–ï–ü–õ–û–ô (–¢—ñ–ª—å–∫–∏ –¥–ª—è –≥—ñ–ª–∫–∏ MAIN —ñ —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ —Ç–µ—Å—Ç–∏ –ø—Ä–æ–π—à–ª–∏) ---
  build-and-deploy:
    needs: test                              # –ß–µ–∫–∞—î–º–æ —É—Å–ø—ñ—Ö—É —Ç–µ—Å—Ç—ñ–≤
    if: github.ref == 'refs/heads/main'      # <--- –í–ê–ñ–õ–ò–í–û: –ù–µ –¥–µ–ø–ª–æ—ó–º–æ –∑ —Ç–µ—Å—Ç–æ–≤–∏—Ö –≥—ñ–ª–æ–∫!
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Log in to the Container registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Build & Push Services
      - name: Build and push Product Service
        uses: docker/build-push-action@v4
        with:
          context: ./product_service
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/product_service:latest

      - name: Build and push Order Service
        uses: docker/build-push-action@v4
        with:
          context: ./order_service
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/order_service:latest

      - name: Build and push Frontend
        uses: docker/build-push-action@v4
        with:
          context: ./frontend
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/frontend:latest
      
      # VPN & SSH
      - name: Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}
          tags: tag:ci

      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.HOST }}      
          username: ${{ secrets.USERNAME }} 
          key: ${{ secrets.SSH_KEY }}    
          script: |
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            cd /mnt/ssd_storage/DevProjects/pos-system
            git pull origin main
            docker compose -f docker-compose.yml -f docker-compose.prod.yml pull
            docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d --remove-orphans
            docker image prune -f
</file>

<file path="frontend\Dockerfile">
# --- –ï–¢–ê–ü 1: –ó–±—ñ—Ä–∫–∞ (Build) ---
# –í–ò–ö–û–†–ò–°–¢–û–í–£–Ñ–ú–û –í–ï–†–°–Ü–Æ 22, –±–æ Vite 6/7 —Ü—å–æ–≥–æ –≤–∏–º–∞–≥–∞—î
FROM node:22-alpine AS build-stage

WORKDIR /app

COPY package*.json ./

RUN npm install

COPY . .

RUN npm run build

# --- –ï–¢–ê–ü 2: –ü—Ä–æ–¥–∞–∫—à–Ω (Nginx) ---
FROM nginx:alpine AS production-stage

COPY --from=build-stage /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
</file>

<file path="frontend\README.md">
# Vue 3 + Vite

This template should help get you started developing with Vue 3 in Vite. The template uses Vue 3 `<script setup>` SFCs, check out the [script setup docs](https://v3.vuejs.org/api/sfc-script-setup.html#sfc-script-setup) to learn more.

Learn more about IDE Support for Vue in the [Vue Docs Scaling up Guide](https://vuejs.org/guide/scaling-up/tooling.html#ide-support).

</file>

<file path="frontend\index.html">
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HITS-POS</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  </head>
  <body>
    <div id="app"></div>
    <script type="module" src="/src/main.js"></script>
  </body>
</html>
</file>

<file path="frontend\nginx.conf">
server {
    listen 80;
    server_name localhost;

    # 1. –ì–æ–ª–æ–≤–Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫–∞ (–§—Ä–æ–Ω—Ç–µ–Ω–¥)
    location / {
        root /usr/share/nginx/html;
        index index.html index.htm;
        try_files $uri $uri/ /index.html; # –î–ª—è —Ä–æ–±–æ—Ç–∏ Vue Router (—â–æ–± –Ω–µ –±—É–ª–æ 404 –ø—Ä–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—ñ)
    }

    # 2. –ü—Ä–æ–∫—Å—ñ –¥–ª—è –ö–û–®–ò–ö–ê (Order Service)
    # –ó–∞–ø–∏—Ç /api/cart/... –ø–µ—Ä–µ—Ç–≤–æ—Ä–∏—Ç—å—Å—è –Ω–∞ http://order_service:8000/cart/...
    location /api/cart {
        # –í—ñ–¥—Ä—ñ–∑–∞—î–º–æ /api, –∑–∞–ª–∏—à–∞—î–º–æ /cart
        rewrite ^/api/(.*) /$1 break;
        proxy_pass http://order_service:8000;
        proxy_set_header Host $host;
    }

    # 3. –ü—Ä–æ–∫—Å—ñ –¥–ª—è –¢–û–í–ê–†–Ü–í (Product Service) - –≤—Å–µ —ñ–Ω—à–µ api
    # –ó–∞–ø–∏—Ç /api/units/... –ø–µ—Ä–µ—Ç–≤–æ—Ä–∏—Ç—å—Å—è –Ω–∞ http://product_service:8000/units/...
    location /api/ {
        # –í—ñ–¥—Ä—ñ–∑–∞—î–º–æ /api
        rewrite ^/api/(.*) /$1 break;
        proxy_pass http://product_service:8000;
        proxy_set_header Host $host;
    }
}
</file>

<file path="frontend\package.json">
{
  "name": "frontend",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "axios": "^1.7.0",
    "vue": "^3.5.24"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4.1.18",
    "@vitejs/plugin-vue": "^6.0.1",
    "autoprefixer": "^10.4.17",
    "postcss": "^8.4.33",
    "tailwindcss": "^3.4.17",
    "vite": "^7.2.4"
  }
}

</file>

<file path="frontend\postcss.config.js">
export default {
  plugins: {
    tailwindcss: {}, // –ù—ñ—è–∫–∏—Ö —Å–æ–±–∞—á–æ–∫ @tailwindcss/postcss! –ü—Ä–æ—Å—Ç–æ tailwindcss.
    autoprefixer: {},
  },
}
</file>

<file path="frontend\tailwind.config.js">
/** @type {import('tailwindcss').Config} */
export default {
  content: [
    "./index.html",
    "./src/**/*.{vue,js,ts,jsx,tsx}",
  ],
  theme: {
    extend: {},
  },
  plugins: [],
}
</file>

<file path="frontend\vite.config.js">
import { fileURLToPath, URL } from 'node:url'
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'

// https://vitejs.dev/config/
export default defineConfig({
  plugins: [
    vue(),
  ],
  resolve: {
    alias: {
      '@': fileURLToPath(new URL('./src', import.meta.url))
    }
  },
  server: {
    host: '0.0.0.0',
    port: 5173,
    proxy: {
      // 1. –ó–∞–ø–∏—Ç–∏ –¥–æ –ö–û–®–ò–ö–ê –π–¥—É—Ç—å –Ω–∞ order_service (8000)
      '/api/cart': {
        target: 'http://order_service:8000',
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/api/, '') 
      },
      // 2. –í—Å—ñ —ñ–Ω—à—ñ –∑–∞–ø–∏—Ç–∏ (Categories, Units, Products) –π–¥—É—Ç—å –Ω–∞ product_service (8001)
      '/api': {
        target: 'http://product_service:8000', // –í—Å–µ—Ä–µ–¥–∏–Ω—ñ Docker –º–µ—Ä–µ–∂—ñ –≤–æ–Ω–∏ –≤—Å—ñ —Å–ª—É—Ö–∞—é—Ç—å 8000
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/api/, '')
      }
    }
  }
})
</file>

<file path="frontend\src\App.vue">
<script setup>
import { ref, onMounted } from 'vue'
// --- –Ü–º–ø–æ—Ä—Ç—É—î–º–æ –ù–û–í–Ü –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∏ ---
import Sidebar from '@/components/common/Sidebar.vue'
import ProductCard from '@/components/pos/ProductCard.vue'
import CartDrawer from '@/components/pos/CartDrawer.vue'
import ProductModal from '@/components/pos/ProductModal.vue'

// --- –Ü–º–ø–æ—Ä—Ç—É—î–º–æ –≤–µ–ª–∏–∫—ñ —Ä–æ–∑–¥—ñ–ª–∏ ---
import Warehouse from '@/components/warehouse/Warehouse.vue'
import Statistics from '@/components/stats/Statistics.vue'
import Customers from '@/components/crm/Customers.vue'

// --- –Ü–º–ø–æ—Ä—Ç—É—î–º–æ –ª–æ–≥—ñ–∫—É (Composables) ---
import { useProducts } from '@/composables/useProducts'
import { useCart } from '@/composables/useCart'

// –°—Ç–∞–Ω –Ω–∞–≤—ñ–≥–∞—Ü—ñ—ó
const currentPage = ref('pos')

// --- –õ–æ–≥—ñ–∫–∞ POS (–ö–∞—Å–∏) ---
// –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ useProducts –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–æ–≤–∞—Ä—ñ–≤ –Ω–∞ –≤—ñ—Ç—Ä–∏–Ω—É
const { 
  filteredProducts, // –í–∂–µ –≤—ñ–¥—Ñ—ñ–ª—å—Ç—Ä–æ–≤–∞–Ω—ñ –ø–æ—à—É–∫–æ–º
  productSearch, 
  fetchProducts 
} = useProducts()

// –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ useCart –¥–ª—è –∫–æ—à–∏–∫–∞ (–ª—ñ—á–∏–ª—å–Ω–∏–∫, –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è)
const { 
  cartCount, 
  fetchCart // –©–æ–± –æ–Ω–æ–≤–∏—Ç–∏ –ª—ñ—á–∏–ª—å–Ω–∏–∫ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ
} = useCart()

// –°—Ç–∞–Ω –¥–ª—è UI –∫–∞—Å–∏
const isCartOpen = ref(false)
const isModalOpen = ref(false)
const selectedProduct = ref(null)

// –û–±—Ä–æ–±–∫–∞ –∫–ª—ñ–∫—É –ø–æ —Ç–æ–≤–∞—Ä—É
const handleProductClick = (product) => {
  // –Ø–∫—â–æ —î –≤–∞—Ä—ñ–∞–Ω—Ç–∏ –∞–±–æ –º–æ–¥–∏—Ñ—ñ–∫–∞—Ç–æ—Ä–∏ -> –≤—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ –º–æ–¥–∞–ª–∫—É
  if (product.has_variants || (product.modifier_groups && product.modifier_groups.length > 0) || (product.process_groups && product.process_groups.length > 0)) {
    selectedProduct.value = product
    isModalOpen.value = true
  } else {
    // –Ø–∫—â–æ –ø—Ä–æ—Å—Ç–∏–π —Ç–æ–≤–∞—Ä -> –¥–æ–¥–∞—î–º–æ –≤ –∫–æ—à–∏–∫ (—á–µ—Ä–µ–∑ ProductModal –ª–æ–≥—ñ–∫—É –∞–±–æ –Ω–∞–ø—Ä—è–º—É, 
    // –∞–ª–µ –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç–∏ –≤—ñ–¥–∫—Ä–∏—î–º–æ –º–æ–¥–∞–ª–∫—É –∞–±–æ –º–æ–∂–Ω–∞ –≤–∏–∫–ª–∏–∫–∞—Ç–∏ addToCart –Ω–∞–ø—Ä—è–º—É.
    // –¢—É—Ç –∫—Ä–∞—â–µ –≤—ñ–¥–∫—Ä–∏—Ç–∏ –º–æ–¥–∞–ª–∫—É –¥–ª—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –∞–±–æ —à–≤–∏–¥–∫–æ–≥–æ –¥–æ–¥–∞–≤–∞–Ω–Ω—è)
    selectedProduct.value = product
    isModalOpen.value = true
  }
}

// –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ
onMounted(() => {
  fetchProducts()
  fetchCart()
})
</script>

<template>
  <div class="flex h-screen bg-gray-50 text-gray-800 font-sans overflow-hidden">
    <Sidebar :current-page="currentPage" @change-page="(page) => currentPage = page" />

    <main v-if="currentPage === 'pos'" class="flex-1 ml-64 flex flex-col h-screen relative">
      <header class="bg-white/80 backdrop-blur-md sticky top-0 z-10 border-b border-gray-200 px-8 py-4 flex justify-between items-center">
        <div>
          <h2 class="text-2xl font-bold text-gray-800">–ú–µ–Ω—é</h2>
          <div class="flex items-center gap-2 mt-1">
             <i class="fas fa-search text-gray-400"></i>
             <input v-model="productSearch" type="text" placeholder="–ü–æ—à—É–∫ –∫–∞–≤–∏..." class="bg-transparent outline-none text-sm w-64">
          </div>
        </div>
        
        <button @click="isCartOpen = true" class="bg-gray-900 text-white px-6 py-3 rounded-xl font-bold hover:bg-gray-800 transition shadow-lg flex items-center gap-3 active:scale-95">
          <i class="fas fa-shopping-cart"></i> <span>–ö–æ—à–∏–∫: {{ cartCount }}</span>
        </button>
      </header>

      <div class="p-8 overflow-y-auto flex-1 custom-scrollbar">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-6">
          <ProductCard 
            v-for="item in filteredProducts" 
            :key="item.id" 
            :product="item" 
            @click="handleProductClick" 
          />
        </div>
        
        <div v-if="filteredProducts.length === 0" class="text-center text-gray-400 mt-20">
            <i class="fas fa-mug-hot text-6xl mb-4 opacity-20"></i>
            <p>–¢–æ–≤–∞—Ä—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</p>
        </div>
      </div>

      <CartDrawer 
        :is-open="isCartOpen"
        @close="isCartOpen = false"
      />
      
      <ProductModal 
        :is-open="isModalOpen"
        :product="selectedProduct"
        @close="isModalOpen = false"
      />
    </main>

    <Warehouse v-if="currentPage === 'warehouse'" />

    <Statistics v-if="currentPage === 'statistics'" />

    <Customers v-if="currentPage === 'customers'" />
    
  </div>
</template>
</file>

<file path="frontend\src\main.js">
import { createApp } from 'vue'
import './style.css'
import App from './App.vue'

createApp(App).mount('#app')

</file>

<file path="frontend\src\style.css">
@tailwind base;
@tailwind components;
@tailwind utilities;

</file>

<file path="frontend\src\components\common\IngredientSelect.vue">
<script setup>
import { ref, computed, onMounted, onUnmounted } from 'vue'

const props = defineProps({
  modelValue: [String, Number], // ID —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∞
  ingredients: { type: Array, default: () => [] },
  placeholder: { type: String, default: '–û–±–µ—Ä—ñ—Ç—å —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç...' }
})

const emit = defineEmits(['update:modelValue'])

const isOpen = ref(false)
const searchQuery = ref('')
const containerRef = ref(null)

const selectedName = computed(() => {
  if (!props.modelValue) return ''
  const found = props.ingredients.find(i => i.id === props.modelValue)
  return found ? found.name : ''
})

const filteredList = computed(() => {
  if (!searchQuery.value) return props.ingredients
  const lower = searchQuery.value.toLowerCase()
  return props.ingredients.filter(i => i.name.toLowerCase().includes(lower))
})

const toggleDropdown = () => {
  isOpen.value = !isOpen.value
  if (isOpen.value) {
    searchQuery.value = ''
  }
}

const selectItem = (id) => {
  emit('update:modelValue', id)
  isOpen.value = false
}

// Click outside logic
const handleClickOutside = (event) => {
  if (containerRef.value && !containerRef.value.contains(event.target)) {
    isOpen.value = false
  }
}

onMounted(() => document.addEventListener('click', handleClickOutside))
onUnmounted(() => document.removeEventListener('click', handleClickOutside))
</script>

<template>
  <div class="relative w-full" ref="containerRef">
    <div 
      @click="toggleDropdown"
      class="border rounded bg-white flex items-center justify-between cursor-pointer px-2 py-1.5 min-h-[38px] transition-colors hover:border-purple-300"
      :class="isOpen ? 'border-purple-500 ring-1 ring-purple-200' : 'border-gray-200'"
    >
      <span v-if="selectedName" class="text-sm text-gray-800 font-medium truncate">{{ selectedName }}</span>
      <span v-else class="text-sm text-gray-400 truncate">{{ placeholder }}</span>
      
      <i class="fas fa-chevron-down text-xs text-gray-400 transition-transform duration-200" :class="{'rotate-180': isOpen}"></i>
    </div>

    <div v-if="isOpen" class="absolute z-50 mt-1 w-full bg-white border border-gray-200 rounded-lg shadow-xl max-h-60 overflow-hidden flex flex-col animate-fade-in-down">
      
      <div class="p-2 border-b bg-gray-50">
        <input 
          v-model="searchQuery" 
          class="w-full text-sm border border-gray-300 rounded px-2 py-1 outline-none focus:border-purple-500"
          placeholder="–ü–æ—à—É–∫..." 
          @click.stop
        >
      </div>

      <div class="overflow-y-auto custom-scrollbar flex-1">
        <div v-if="filteredList.length === 0" class="p-3 text-xs text-gray-400 text-center">
          –ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ
        </div>
        
        <div 
          v-for="item in filteredList" 
          :key="item.id"
          @click="selectItem(item.id)"
          class="px-3 py-2 text-sm cursor-pointer hover:bg-purple-50 transition-colors flex justify-between items-center group"
          :class="item.id === modelValue ? 'bg-purple-50 text-purple-700 font-bold' : 'text-gray-700'"
        >
          <span>{{ item.name }}</span>
          <span class="text-[10px] text-gray-400 group-hover:text-purple-400 bg-gray-100 group-hover:bg-white px-1 rounded">
             {{ item.stock_quantity }} {{ item.unit?.symbol }}
          </span>
        </div>
      </div>
    </div>
  </div>
</template>

<style scoped>
.animate-fade-in-down {
  animation: fadeInDown 0.2s ease-out;
}
@keyframes fadeInDown {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}
/* Scrollbar styles (optional global) */
.custom-scrollbar::-webkit-scrollbar { width: 4px; }
.custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
</style>
</file>

<file path="frontend\src\components\common\Sidebar.vue">
<script setup>
import { computed } from 'vue'

const props = defineProps({
  currentPage: { type: String, required: true }
})

const emit = defineEmits(['change-page'])

// –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è –º–µ–Ω—é. –õ–µ–≥–∫–æ —Ä–æ–∑—à–∏—Ä—é–≤–∞—Ç–∏.
const menuItems = [
  { 
    id: 'pos', 
    label: '–ö–∞—Å–∞', 
    icon: 'fas fa-cash-register', 
    activeClass: 'text-yellow-400 border-l-4 border-yellow-400 bg-gray-800' 
  },
  { 
    id: 'warehouse', 
    label: '–°–∫–ª–∞–¥', 
    icon: 'fas fa-boxes', 
    activeClass: 'text-blue-400 border-l-4 border-blue-400 bg-gray-800' 
  },
  { 
    id: 'customers', 
    label: '–ö–ª—ñ—î–Ω—Ç–∏', 
    icon: 'fas fa-users', 
    activeClass: 'text-green-400 border-l-4 border-green-400 bg-gray-800' 
  },
  { 
    id: 'statistics', 
    label: '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞', 
    icon: 'fas fa-chart-line', 
    activeClass: 'text-purple-400 border-l-4 border-purple-400 bg-gray-800' 
  }
]

const navigate = (pageId) => {
  emit('change-page', pageId)
}
</script>

<template>
  <aside class="w-64 bg-gray-900 text-white flex flex-col h-screen fixed left-0 top-0 border-r border-gray-800 z-50">
    
    <div class="p-6 text-2xl font-bold text-center border-b border-gray-800 flex items-center justify-center gap-2">
      <div class="w-8 h-8 bg-gradient-to-tr from-yellow-400 to-orange-500 rounded-full"></div>
      HITS POS
    </div>

    <nav class="flex-1 py-6 space-y-1">
      <a 
        v-for="item in menuItems" 
        :key="item.id"
        href="#" 
        @click.prevent="navigate(item.id)"
        class="flex items-center px-6 py-3 font-bold transition-all group"
        :class="currentPage === item.id ? item.activeClass : 'text-gray-400 hover:bg-gray-800 hover:text-white'"
      >
        <i 
          :class="[item.icon, 'w-6 text-center mr-2 transition-transform', currentPage !== item.id && 'group-hover:scale-110']"
        ></i> 
        {{ item.label }}
      </a>
    </nav>

    <div class="p-4 border-t border-gray-800 text-xs text-gray-500 text-center">
      <p>Server: <span class="text-green-500">Online üü¢</span></p>
    </div>
  </aside>
</template>
</file>

<file path="frontend\src\components\crm\Customers.vue">
<script setup>
import { ref, onMounted, computed } from 'vue'
import axios from 'axios'

// --- –ö–û–ù–§–Ü–ì–£–†–ê–¶–Ü–Ø API ---
const API_URL = 'http://localhost:8001/customers/'

// --- –°–¢–ê–ù ---
const customers = ref([])
const showModal = ref(false)
const searchQuery = ref('')
const isEditing = ref(false)
const editingId = ref(null)

// –§–æ—Ä–º–∞
const formData = ref({
    name: '',
    phone: '',
    email: '',
    notes: ''
})

// --- API –ó–ê–ü–ò–¢–ò ---

const fetchCustomers = async () => {
    try {
        const res = await axios.get(API_URL)
        console.log("–û—Ç—Ä–∏–º–∞–Ω—ñ –∫–ª—ñ—î–Ω—Ç–∏:", res.data)
        customers.value = res.data
    } catch (err) {
        console.error("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–ª—ñ—î–Ω—Ç—ñ–≤:", err)
    }
}

const handleSave = async () => {
    if (!formData.value.name) return alert("–Ü–º'—è –æ–±–æ–≤'—è–∑–∫–æ–≤–µ!")
    if (!formData.value.phone) return alert("–¢–µ–ª–µ—Ñ–æ–Ω –æ–±–æ–≤'—è–∑–∫–æ–≤–∏–π!")

    try {
        if (isEditing.value) {
            await axios.put(`${API_URL}${editingId.value}`, formData.value)
        } else {
            await axios.post(API_URL, formData.value)
        }
        
        closeModal()
        await fetchCustomers()
    } catch (err) {
        console.error(err)
        alert("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ. –ú–æ–∂–ª–∏–≤–æ —Ç–∞–∫–∏–π —Ç–µ–ª–µ—Ñ–æ–Ω –≤–∂–µ —ñ—Å–Ω—É—î.")
    }
}

const deleteCustomer = async (id) => {
    if(!confirm("–í–∏–¥–∞–ª–∏—Ç–∏ —Ü—å–æ–≥–æ –∫–ª—ñ—î–Ω—Ç–∞ –∑ –±–∞–∑–∏?")) return
    try {
        await axios.delete(`${API_URL}${id}`)
        fetchCustomers()
    } catch (err) {
        alert("–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è")
    }
}

// --- –õ–û–ì–Ü–ö–ê –Ü–ù–¢–ï–†–§–ï–ô–°–£ ---

const openCreateModal = () => {
    isEditing.value = false
    editingId.value = null
    formData.value = { name: '', phone: '', email: '', notes: '' }
    showModal.value = true
}

const openEditModal = (customer) => {
    isEditing.value = true
    editingId.value = customer.id
    formData.value = {
        name: customer.name,
        phone: customer.phone,
        email: customer.email || '',
        notes: customer.notes || ''
    }
    showModal.value = true
}

const closeModal = () => {
    showModal.value = false
    formData.value = { name: '', phone: '', email: '', notes: '' }
}

const filteredCustomers = computed(() => {
    if (!searchQuery.value) return customers.value
    const q = searchQuery.value.toLowerCase()
    return customers.value.filter(c => 
        c.name.toLowerCase().includes(q) || 
        (c.phone && c.phone.includes(q)) ||
        (c.email && c.email.toLowerCase().includes(q))
    )
})

onMounted(fetchCustomers)
</script>

<template>
    <div class="h-full w-full bg-white rounded-2xl shadow-sm border border-gray-100 flex flex-col overflow-hidden md:ml-64 transition-all duration-300" style="width: calc(100% - 16rem);">
        
        <div class="p-6 border-b border-gray-100 flex flex-col md:flex-row justify-between items-center gap-4 bg-gray-50/50">
            <div>
                <h2 class="text-xl font-bold text-gray-800">–ö–ª—ñ—î–Ω—Ç–∏</h2>
                <p class="text-xs text-gray-500">–ë–∞–∑–∞ –∫–æ–Ω—Ç–∞–∫—Ç—ñ–≤ CRM</p>
            </div>

            <div class="flex w-full md:w-auto gap-3">
                <div class="relative flex-1 md:w-64">
                    <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400">
                        <i class="fas fa-search"></i>
                    </span>
                    <input 
                        v-model="searchQuery" 
                        type="text" 
                        placeholder="–ü–æ—à—É–∫ (—ñ–º'—è, —Ç–µ–ª, email)..." 
                        class="w-full pl-10 pr-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-100 outline-none text-sm transition bg-white"
                    >
                </div>

                <button 
                    @click="openCreateModal" 
                    class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-xl font-bold shadow-lg shadow-blue-100 transition transform active:scale-95 flex items-center gap-2 whitespace-nowrap text-sm"
                >
                    <i class="fas fa-user-plus"></i>
                    <span>–î–æ–¥–∞—Ç–∏</span>
                </button>
            </div>
        </div>

        <div class="flex-1 overflow-auto">
            <table class="w-full text-left text-sm text-gray-600">
                <thead class="bg-gray-50 text-xs uppercase font-bold text-gray-500 sticky top-0 z-10 shadow-sm">
                    <tr>
                        <th class="p-4 border-b">–ö–ª—ñ—î–Ω—Ç</th>
                        <th class="p-4 border-b">–¢–µ–ª–µ—Ñ–æ–Ω</th>
                        <th class="p-4 border-b">Email</th>
                        <th class="p-4 border-b">–ù–æ—Ç–∞—Ç–∫–∏</th>
                        <th class="p-4 border-b text-center">–î—ñ—ó</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    <tr v-if="filteredCustomers.length === 0">
                        <td colspan="5" class="p-8 text-center text-gray-400">
                            <div class="flex flex-col items-center gap-2">
                                <i class="fas fa-users-slash text-2xl"></i>
                                <span>–ö–ª—ñ—î–Ω—Ç—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</span>
                            </div>
                        </td>
                    </tr>
                    <tr v-for="c in filteredCustomers" :key="c.id" class="hover:bg-blue-50/30 transition group">
                        
                        <td class="p-4 font-medium text-gray-900">
                            <div class="flex items-center gap-3">
                                <div class="w-9 h-9 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-xs border border-blue-200 shadow-sm shrink-0">
                                    {{ c.name ? c.name.charAt(0).toUpperCase() : '?' }}
                                </div>
                                <div class="flex flex-col">
                                    <span v-if="c.name">{{ c.name }}</span>
                                    <span v-else class="text-red-500 text-xs font-bold">MISSING NAME (ID: {{ c.id }})</span>
                                </div>
                            </div>
                        </td>
                        
                        <td class="p-4">
                             <span class="font-mono text-xs text-gray-700 bg-gray-50/50 px-2 py-1 rounded border border-gray-100">
                                {{ c.phone || '---' }}
                             </span>
                        </td>
                        
                        <td class="p-4 text-blue-500">
                            {{ c.email || '-' }}
                        </td>
                        
                        <td class="p-4 text-xs italic text-gray-400 max-w-xs truncate">
                            {{ c.notes || '-' }}
                        </td>
                        
                        <td class="p-4 text-center">
                            <div class="flex justify-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button 
                                    @click="openEditModal(c)" 
                                    class="text-blue-400 hover:text-blue-600 p-2 rounded hover:bg-blue-50 transition"
                                    title="–†–µ–¥–∞–≥—É–≤–∞—Ç–∏"
                                >
                                    <i class="fas fa-pen"></i>
                                </button>
                                <button 
                                    @click="deleteCustomer(c.id)" 
                                    class="text-gray-300 hover:text-red-500 p-2 rounded hover:bg-red-50 transition"
                                    title="–í–∏–¥–∞–ª–∏—Ç–∏"
                                >
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div v-if="showModal" class="fixed inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl p-6 transform transition-all scale-100">
                <div class="flex justify-between items-center mb-6 border-b pb-4 border-gray-100">
                    <h2 class="text-xl font-bold text-gray-800">
                        {{ isEditing ? '–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –∫–ª—ñ—î–Ω—Ç–∞' : '–ù–æ–≤–∏–π –∫–ª—ñ—î–Ω—Ç' }}
                    </h2>
                    <button @click="closeModal" class="text-gray-400 hover:text-gray-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100">
                        &times;
                    </button>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1 ml-1">–Ü–º'—è <span class="text-red-500">*</span></label>
                        <input v-model="formData.name" class="w-full border-gray-200 border p-3 rounded-xl focus:ring-2 focus:ring-blue-100 outline-none bg-gray-50 focus:bg-white transition" placeholder="–ü–Ü–ë">
                    </div>
                    
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1 ml-1">–¢–µ–ª–µ—Ñ–æ–Ω <span class="text-red-500">*</span></label>
                        <input v-model="formData.phone" class="w-full border-gray-200 border p-3 rounded-xl focus:ring-2 focus:ring-blue-100 outline-none bg-gray-50 focus:bg-white transition" placeholder="+380...">
                    </div>
                    
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1 ml-1">Email</label>
                        <input v-model="formData.email" class="w-full border-gray-200 border p-3 rounded-xl focus:ring-2 focus:ring-blue-100 outline-none bg-gray-50 focus:bg-white transition" placeholder="client@mail.com">
                    </div>
                    
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1 ml-1">–ù–æ—Ç–∞—Ç–∫–∏</label>
                        <textarea v-model="formData.notes" class="w-full border-gray-200 border p-3 rounded-xl focus:ring-2 focus:ring-blue-100 outline-none bg-gray-50 focus:bg-white transition h-24 resize-none" placeholder="–£–ø–æ–¥–æ–±–∞–Ω–Ω—è, –¥–µ–Ω—å –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è..."></textarea>
                    </div>
                </div>

                <div class="flex gap-3 mt-8 pt-4 border-t border-gray-50">
                    <button @click="closeModal" class="flex-1 py-3 text-gray-500 font-bold hover:bg-gray-100 rounded-xl transition">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                    <button @click="handleSave" class="flex-1 py-3 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 shadow-lg shadow-blue-200 transition transform active:scale-95">
                        {{ isEditing ? '–ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏' : '–°—Ç–≤–æ—Ä–∏—Ç–∏' }}
                    </button>
                </div>
            </div>
        </div>

    </div>
</template>
</file>

<file path="frontend\src\components\crm\CustomersTable.vue">
<script setup>
defineProps({
  customers: Array,
  loading: Boolean
})

const emit = defineEmits(['edit', 'delete', 'history'])
</script>

<template>
  <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
    <table class="w-full text-left">
      <thead class="bg-gray-50 text-gray-500 uppercase text-xs">
        <tr>
          <th class="p-4">–Ü–º'—è</th>
          <th class="p-4">–¢–µ–ª–µ—Ñ–æ–Ω</th>
          <th class="p-4">Email / –ù–æ—Ç–∞—Ç–∫–∏</th>
          <th class="p-4 text-center">–î—ñ—ó</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-100">
        <tr v-if="customers.length === 0" class="text-center text-gray-400">
          <td colspan="4" class="p-8">
              <span v-if="loading"><i class="fas fa-spinner fa-spin"></i> –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</span>
              <span v-else>–ö–ª—ñ—î–Ω—Ç—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</span>
          </td>
        </tr>

        <tr v-for="c in customers" :key="c.id" class="hover:bg-blue-50 transition group">
          <td class="p-4 font-bold text-gray-800">
              <div class="flex items-center gap-3">
                  <div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-xs font-bold">
                      {{ c.name.charAt(0) }}
                  </div>
                  {{ c.name }}
              </div>
          </td>
          <td class="p-4 font-mono text-gray-600">{{ c.phone }}</td>
          <td class="p-4 text-sm text-gray-500">
              <div v-if="c.email">{{ c.email }}</div>
              <div v-if="c.notes" class="italic text-xs mt-1">"{{ c.notes }}"</div>
          </td>
          <td class="p-4 text-center flex justify-center gap-2">
              <button @click="emit('history', c)" class="text-purple-400 hover:text-purple-600 transition px-2" title="–Ü—Å—Ç–æ—Ä—ñ—è –ø–æ–∫—É–ø–æ–∫">
                  <i class="fas fa-history"></i>
              </button>
              <button @click="emit('edit', c)" class="text-gray-400 hover:text-blue-500 transition px-2" title="–†–µ–¥–∞–≥—É–≤–∞—Ç–∏">
                  <i class="fas fa-pen"></i>
              </button>
              <button @click="emit('delete', c.id)" class="text-gray-400 hover:text-red-500 transition px-2" title="–í–∏–¥–∞–ª–∏—Ç–∏">
                  <i class="fas fa-trash"></i>
              </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</template>
</file>

<file path="frontend\src\components\pos\CartDrawer.vue">
<script setup>
import { ref, watch } from 'vue'
import { useCart } from '@/composables/useCart'

const props = defineProps({ isOpen: Boolean })
const emit = defineEmits(['close'])

const { 
  cartItems, totalSum, paymentMethod, isProcessing, selectedCustomer,
  fetchCart, removeFromCart, clearCart, processCheckout,
  setCustomer, removeCustomer
} = useCart()

const customerSearch = ref('')
const customerResults = ref([])

const handleSearchCustomer = async () => {
  if (customerSearch.value.length < 2) { customerResults.value = []; return }
  try {
    const res = await fetch(`/api/customers/search/?q=${customerSearch.value}`)
    if (res.ok) customerResults.value = await res.json()
  } catch (err) { console.error(err) }
}

const selectCustomerUI = (c) => {
  setCustomer(c)
  customerSearch.value = ''
  customerResults.value = []
}

// --- –ù–û–í–ê –§–£–ù–ö–¶–Ü–Ø: –û–ß–ò–©–ï–ù–ù–Ø –ö–û–®–ò–ö–ê ---
const handleClearCart = async () => {
    if (cartItems.value.length === 0) return
    
    if (confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –ø–æ–≤–Ω—ñ—Å—Ç—é –æ—á–∏—Å—Ç–∏—Ç–∏ –∫–æ—à–∏–∫?')) {
        await clearCart()
    }
}

const handleCheckout = async () => {
  const res = await processCheckout()
  
  if (res && res.success) {
    alert(res.text) // –ü–æ–∫–∞–∂–µ–º–æ —Å—É–º—É –≤—ñ–¥ —Å–µ—Ä–≤–µ—Ä–∞
    emit('close')
  } else {
    alert(res ? res.text : "–ù–µ–≤—ñ–¥–æ–º–∞ –ø–æ–º–∏–ª–∫–∞")
  }
}

watch(() => props.isOpen, (val) => {
  if (val) fetchCart()
})
</script>

<template>
  <div v-if="isOpen" class="fixed inset-0 z-50 flex">
    <div class="fixed inset-0 bg-black bg-opacity-50 transition-opacity" @click="emit('close')"></div>
    
    <div class="relative flex flex-col h-full bg-white shadow-xl w-full max-w-md ml-auto animate-slide-in">
        
        <div class="p-4 border-b flex justify-between items-center bg-gray-50">
            <div class="flex items-center gap-3">
                <h2 class="font-bold text-lg text-gray-800">–ö–æ—à–∏–∫</h2>
                <button 
                    v-if="cartItems.length > 0"
                    @click="handleClearCart" 
                    class="text-red-400 hover:text-red-600 hover:bg-red-50 p-1.5 rounded-lg transition"
                    title="–û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å–µ"
                >
                    <i class="fas fa-trash-alt"></i>
                </button>
            </div>

            <button @click="emit('close')" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <div class="flex-1 overflow-y-auto p-4 space-y-4">
            <div v-if="cartItems.length === 0" class="h-full flex flex-col items-center justify-center text-gray-400">
                <i class="fas fa-shopping-basket text-4xl mb-2 opacity-30"></i>
                <p>–ö–æ—à–∏–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π</p>
            </div>
            
            <div v-else v-for="(item, idx) in cartItems" :key="idx" class="flex gap-3 relative group border-b pb-3 last:border-0">
                <div class="w-16 h-16 bg-gray-100 rounded-lg flex items-center justify-center flex-shrink-0 text-2xl">
                    {{ item.image_url ? '' : '‚òï' }}
                    <img v-if="item.image_url" :src="item.image_url" class="w-full h-full object-cover rounded-lg">
                </div>

                <div class="flex-1">
                    <div class="flex justify-between items-start">
                        <h4 class="font-bold text-gray-800 text-sm leading-tight pr-6">{{ item.name }}</h4>
                        <span class="font-bold text-gray-900">{{ (item.price * item.quantity).toFixed(2) }}‚Ç¥</span>
                    </div>
                    
                    <div v-if="item.variant_name" class="text-xs text-gray-500 mt-0.5">
                        {{ item.variant_name }}
                    </div>

                    <div v-if="item.modifiers && item.modifiers.length" class="flex flex-wrap gap-1 mt-1">
                        <span v-for="mod in item.modifiers" :key="mod.id" class="text-[10px] bg-yellow-50 text-yellow-700 px-1 rounded border border-yellow-100">
                            +{{ mod.name }}
                        </span>
                    </div>

                    <div class="flex justify-between items-end mt-2">
                        <div class="text-sm text-gray-500">
                            {{ item.quantity }} x {{ item.price }} ‚Ç¥
                        </div>
                        <button @click="removeFromCart(item.product_id, item.variant_id)" class="text-red-400 hover:text-red-600 text-xs font-medium">
                            –í–∏–¥–∞–ª–∏—Ç–∏
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="p-4 border-t bg-gray-50 space-y-4">
            
            <div class="relative">
                <div v-if="selectedCustomer" class="flex justify-between items-center p-2 bg-blue-50 border border-blue-200 rounded text-sm">
                    <span class="font-bold text-blue-800"><i class="fas fa-user mr-1"></i> {{ selectedCustomer.name }}</span>
                    <button @click="removeCustomer" class="text-blue-500 hover:text-blue-700"><i class="fas fa-times"></i></button>
                </div>
                <div v-else>
                    <input v-model="customerSearch" @input="handleSearchCustomer" placeholder="–ó–Ω–∞–π—Ç–∏ –∫–ª—ñ—î–Ω—Ç–∞..." class="w-full p-2.5 border rounded-lg text-sm focus:ring-2 focus:ring-purple-500 outline-none">
                    <div v-if="customerResults.length" class="absolute bg-white border shadow-xl w-full max-h-48 overflow-auto z-10 mt-1 rounded-lg">
                        <div v-for="c in customerResults" :key="c.id" @click="selectCustomerUI(c)" class="p-2.5 hover:bg-gray-100 cursor-pointer text-sm border-b last:border-0">
                            {{ c.name }} <span class="text-gray-400 text-xs ml-1">{{ c.phone }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex gap-2">
                <button @click="paymentMethod='cash'" :class="paymentMethod==='cash' ? 'bg-green-100 text-green-700 border-green-500 ring-1 ring-green-500' : 'bg-white border-gray-300 hover:bg-gray-50'" class="flex-1 py-2.5 border rounded-lg font-bold transition flex items-center justify-center gap-2 text-sm">
                    <i class="fas fa-money-bill-wave"></i> –ì–æ—Ç—ñ–≤–∫–∞
                </button>
                <button @click="paymentMethod='card'" :class="paymentMethod==='card' ? 'bg-blue-100 text-blue-700 border-blue-500 ring-1 ring-blue-500' : 'bg-white border-gray-300 hover:bg-gray-50'" class="flex-1 py-2.5 border rounded-lg font-bold transition flex items-center justify-center gap-2 text-sm">
                    <i class="fas fa-credit-card"></i> –ö–∞—Ä—Ç–∫–∞
                </button>
            </div>

            <button 
                @click="handleCheckout"
                :disabled="cartItems.length === 0 || isProcessing"
                class="w-full py-3.5 bg-purple-600 text-white rounded-xl font-bold text-lg hover:bg-purple-700 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed active:scale-[0.98] transition flex items-center justify-center gap-2"
            >
                <span v-if="isProcessing"><i class="fas fa-spinner fa-spin"></i></span>
                <span v-else>–û–ø–ª–∞—Ç–∏—Ç–∏ {{ totalSum.toFixed(2) }} ‚Ç¥</span>
            </button>
        </div>
    </div>
  </div>
</template>

<style scoped>
.animate-slide-in {
    animation: slideIn 0.3s ease-out;
}
@keyframes slideIn {
    from { transform: translateX(100%); }
    to { transform: translateX(0); }
}
</style>
</file>

<file path="frontend\src\components\pos\ProductCard.vue">
<script setup>
import { computed } from 'vue'

const props = defineProps({ 
  product: { type: Object, required: true } 
})

// –Ø–≤–Ω–æ –≤–∫–∞–∑—É—î–º–æ, —â–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Ä–µ–∞–≥—É—î –Ω–∞ –∫–ª—ñ–∫, —Ö–æ—á–∞ —Ü–µ native event
const emit = defineEmits(['click'])

// –õ–æ–≥—ñ–∫–∞ —ñ–∫–æ–Ω–æ–∫ (View Logic)
const productIcon = computed(() => {
  const name = props.product.name?.toLowerCase() || ''
  const cat = props.product.category?.name?.toLowerCase() || ''
  
  if (name.includes('–∫–∞–≤–∞') || name.includes('–µ—Å–ø—Ä–µ—Å–æ') || cat.includes('–Ω–∞–ø–æ—ó')) return 'fas fa-mug-hot'
  if (name.includes('—á–∞–π')) return 'fas fa-leaf'
  if (name.includes('—Ç–æ—Ä—Ç') || name.includes('–¥–µ—Å–µ—Ä—Ç') || cat.includes('–¥–µ—Å–µ—Ä—Ç–∏')) return 'fas fa-birthday-cake'
  if (name.includes('–∫—Ä—É–∞—Å–∞–Ω')) return 'fas fa-bread-slice'
  
  return 'fas fa-box'
})

// –õ–æ–≥—ñ–∫–∞ –∫–æ–ª—å–æ—Ä—ñ–≤ (View Logic)
const cardColor = computed(() => {
  const slug = props.product.category?.slug || ''
  const colors = {
    'hot-drinks': 'bg-orange-50 text-orange-600 border-orange-100',
    'desserts': 'bg-pink-50 text-pink-600 border-pink-100'
  }
  return colors[slug] || 'bg-white text-gray-700 border-gray-100'
})

const hasOptions = computed(() => {
  return props.product.has_variants || (props.product.modifier_groups && props.product.modifier_groups.length > 0)
})

// –õ–æ–≥—ñ–∫–∞ —Ü—ñ–Ω–∏: –ø–æ–∫–∞–∑—É—î–º–æ –º—ñ–Ω—ñ–º–∞–ª—å–Ω—É, —è–∫—â–æ —î –≤–∞—Ä—ñ–∞–Ω—Ç–∏
const displayPrice = computed(() => {
  if (props.product.has_variants && props.product.variants?.length > 0) {
    const prices = props.product.variants.map(v => v.price)
    return Math.min(...prices)
  }
  return props.product.price
})
</script>

<template>
  <div 
    @click="emit('click', product)"
    class="relative group cursor-pointer transition-all duration-200 hover:-translate-y-1 hover:shadow-xl rounded-2xl border overflow-hidden bg-white"
  >
    <div class="h-32 flex items-center justify-center text-5xl transition-transform group-hover:scale-110" :class="cardColor">
      <i :class="productIcon"></i>
    </div>

    <div class="p-4">
      <div v-if="product.category" class="text-xs font-bold uppercase tracking-wider text-gray-400 mb-1">
        {{ product.category.name }}
      </div>
      
      <h3 class="font-bold text-lg text-gray-800 leading-tight mb-2 line-clamp-2 min-h-[3.5rem]">
        {{ product.name }}
      </h3>
      
      <div class="flex justify-between items-center mt-3">
        <div class="flex flex-col">
            <span v-if="product.has_variants" class="text-xs text-gray-400">–≤—ñ–¥</span>
            <span class="text-xl font-bold text-gray-900">{{ displayPrice }} ‚Ç¥</span>
        </div>
        
        <button class="w-8 h-8 rounded-full flex items-center justify-center transition shadow-lg"
            :class="hasOptions ? 'bg-purple-600 hover:bg-purple-700 text-white' : 'bg-gray-900 hover:bg-green-500 text-white'">
          <i class="fas" :class="hasOptions ? 'fa-sliders-h text-xs' : 'fa-plus text-xs'"></i>
        </button>
      </div>
    </div>
  </div>
</template>
</file>

<file path="frontend\src\components\pos\ProductModal.vue">
<script setup>
import { ref, computed, watch } from 'vue'
import { useCart } from '@/composables/useCart'

const props = defineProps({
  isOpen: Boolean,
  product: Object 
})

const emit = defineEmits(['close'])

const { addToCart } = useCart()

const selectedVariant = ref(null)
const selectedModifiers = ref({}) 
const selectedProcesses = ref({}) 

// --- –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è (Reset & Defaults) ---
watch(() => props.isOpen, (isOpen) => {
  if (isOpen && props.product) {
    selectedVariant.value = null
    selectedModifiers.value = {}
    selectedProcesses.value = {} 

    // Auto-select Variant (cheapest)
    if (props.product.variants && props.product.variants.length > 0) {
      const sorted = [...props.product.variants].sort((a, b) => a.price - b.price)
      selectedVariant.value = sorted[0]
    }

    // Auto-select Required Modifiers
    if (props.product.modifier_groups) {
      props.product.modifier_groups.forEach(group => {
        if (group.is_required && group.modifiers.length > 0) {
          selectedModifiers.value[group.id] = group.modifiers[0].id
        }
      })
    }

    // Auto-select First Process Option
    if (props.product.process_groups) {
        props.product.process_groups.forEach(pg => {
            if (pg.options && pg.options.length > 0) {
                selectedProcesses.value[pg.id] = pg.options[0].name
            }
        })
    }
  }
})

const currentPrice = computed(() => {
  if (!props.product) return 0
  let price = 0
  
  if (props.product.has_variants && selectedVariant.value) {
    price += selectedVariant.value.price
  } else {
    price += props.product.price
  }
  
  if (props.product.modifier_groups) {
    props.product.modifier_groups.forEach(group => {
      const modId = selectedModifiers.value[group.id]
      if (modId) {
        const mod = group.modifiers.find(m => m.id === modId)
        if (mod) price += mod.price_change
      }
    })
  }
  return price
})

// –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –Ω–∞–∑–≤–∏ –¥–ª—è –∫–æ—à–∏–∫–∞
const generateName = () => {
  let name = props.product.name
  if (selectedVariant.value) {
    name += ` (${selectedVariant.value.name})`
  }
  const processValues = Object.values(selectedProcesses.value)
  if (processValues.length > 0) {
      name += ` [${processValues.join(', ')}]`
  }
  return name
}

const handleConfirm = async () => {
  if (props.product.has_variants && !selectedVariant.value) {
      alert("–ë—É–¥—å –ª–∞—Å–∫–∞, –æ–±–µ—Ä—ñ—Ç—å —Ä–æ–∑–º—ñ—Ä/–≤–∞—Ä—ñ–∞–Ω—Ç")
      return
  }

  // –§–æ—Ä–º—É—î–º–æ –æ–±'—î–∫—Ç –¥–ª—è –∫–æ—à–∏–∫–∞ (—Å–ø—ñ–≤–ø–∞–¥–∞—î –∑ backend —Å—Ö–µ–º–æ—é)
  const payload = {
    product_id: props.product.id,
    variant_id: selectedVariant.value ? selectedVariant.value.id : null,
    modifiers: Object.values(selectedModifiers.value).map(id => ({ modifier_id: id })),
    quantity: 1, // –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º 1
    // –î–æ–¥–∞—Ç–∫–æ–≤—ñ –ø–æ–ª—è –¥–ª—è UI, —è–∫—ñ –Ω–µ –π–¥—É—Ç—å –≤ –ë–î, –∞–ª–µ –º–æ–∂—É—Ç—å –±—É—Ç–∏ –∫–æ—Ä–∏—Å–Ω—ñ –¥–ª—è –æ–ø—Ç–∏–º—ñ—Å—Ç–∏—á–Ω–æ–≥–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è
    name: generateName(),
    price: currentPrice.value
  }

  await addToCart(payload) // –í–∏–∫–ª–∏–∫–∞—î–º–æ –≥–ª–æ–±–∞–ª—å–Ω—É –¥—ñ—é
  emit('close')
}

</script>

<template>
  <div v-if="isOpen" class="fixed inset-0 z-50 flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" @click="emit('close')"></div>

    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg relative overflow-hidden flex flex-col max-h-[90vh] animate-fade-in-up">
      
      <div class="p-6 bg-gray-50 border-b flex justify-between items-start">
        <div>
           <div class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">
             {{ product.category?.name || '–¢–æ–≤–∞—Ä' }}
           </div>
           <h2 class="text-3xl font-bold text-gray-800 leading-none">{{ product.name }}</h2>
        </div>
        <button @click="emit('close')" class="text-gray-400 hover:text-gray-600 bg-white p-2 rounded-full shadow-sm hover:shadow transition">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>

      <div class="p-6 overflow-y-auto space-y-6 custom-scrollbar">
        
        <div v-if="product.has_variants && product.variants.length > 0">
          <label class="block text-sm font-bold text-gray-900 mb-3">–û–±–µ—Ä—ñ—Ç—å —Ä–æ–∑–º—ñ—Ä/–≤–∞–≥—É:</label>
          <div class="grid grid-cols-3 gap-3">
            <button 
              v-for="variant in product.variants" 
              :key="variant.id"
              @click="selectedVariant = variant"
              class="py-3 px-2 rounded-xl border-2 transition-all flex flex-col items-center justify-center gap-1"
              :class="selectedVariant?.id === variant.id ? 'border-purple-600 bg-purple-50 text-purple-700' : 'border-gray-200 hover:border-gray-300 text-gray-600'"
            >
              <span class="font-bold">{{ variant.name }}</span>
              <span class="text-xs">{{ variant.price }} ‚Ç¥</span>
            </button>
          </div>
        </div>

        <div v-if="product.process_groups && product.process_groups.length > 0" class="space-y-4">
            <div v-for="pg in product.process_groups" :key="pg.id" class="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                <label class="block text-sm font-bold text-indigo-900 mb-2">
                    {{ pg.name }}
                </label>
                <div class="flex flex-wrap gap-2">
                    <button 
                        v-for="opt in pg.options" 
                        :key="opt.id"
                        @click="selectedProcesses[pg.id] = opt.name"
                        class="px-4 py-2 rounded-lg text-sm font-bold transition-all shadow-sm border"
                        :class="selectedProcesses[pg.id] === opt.name ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-gray-600 border-gray-200 hover:bg-white/80'"
                    >
                        {{ opt.name }}
                    </button>
                </div>
            </div>
        </div>

        <div v-if="product.modifier_groups && product.modifier_groups.length > 0" class="space-y-4">
          <div v-for="group in product.modifier_groups" :key="group.id" class="bg-gray-50 p-4 rounded-xl border border-gray-100">
            <label class="block text-sm font-bold text-gray-700 mb-2">
              {{ group.name }} <span v-if="!group.is_required" class="text-gray-400 font-normal text-xs">(–û–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)</span>
            </label>
            
            <div class="flex flex-wrap gap-2">
              <button 
                v-for="mod in group.modifiers" 
                :key="mod.id"
                @click="selectedModifiers[group.id] = mod.id"
                class="px-4 py-2 rounded-lg text-sm font-medium transition-all shadow-sm border"
                :class="selectedModifiers[group.id] === mod.id ? 'bg-gray-800 text-white border-gray-800' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-100'"
              >
                {{ mod.name }}
                <span v-if="mod.price_change > 0" class="text-xs opacity-70 ml-1">+{{ mod.price_change }}</span>
              </button>
            </div>
          </div>
        </div>

      </div>

      <div class="p-6 border-t bg-gray-50 flex justify-between items-center">
        <div class="text-2xl font-bold text-gray-900">
          {{ currentPrice }} ‚Ç¥
        </div>
        <button 
          @click="handleConfirm"
          class="bg-purple-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-purple-700 transition shadow-lg shadow-purple-200 active:scale-95 flex items-center gap-2"
        >
          <i class="fas fa-cart-plus"></i> –î–æ–¥–∞—Ç–∏
        </button>
      </div>

    </div>
  </div>
</template>

<style scoped>
.animate-fade-in-up { animation: fadeInUp 0.3s ease-out; }
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(20px) scale(0.95); }
  to { opacity: 1; transform: translateY(0) scale(1); }
}
</style>
</file>

<file path="frontend\src\components\stats\SalesTable.vue">
<script setup>
defineProps({
  orders: Array,
  loading: Boolean
})

const emit = defineEmits(['view-details'])

// Helper for date formatting inside template
const formatDate = (dateString) => {
  const date = new Date(dateString)
  return date.toLocaleString('uk-UA', {
    day: '2-digit', month: '2-digit', year: 'numeric',
    hour: '2-digit', minute: '2-digit'
  })
}
</script>

<template>
  <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
      <table class="w-full text-left">
        <thead class="bg-gray-100 text-gray-500 uppercase text-xs">
          <tr>
            <th class="p-4">ID / –ß–∞—Å</th>
            <th class="p-4">–ö–ª—ñ—î–Ω—Ç</th> 
            <th class="p-4">–¢–æ–≤–∞—Ä–∏ (–ö–æ—Ä–æ—Ç–∫–æ)</th>
            <th class="p-4">–û–ø–ª–∞—Ç–∞</th>
            <th class="p-4 text-right">–°—É–º–∞</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100">
          <tr v-if="orders.length === 0" class="text-center text-gray-400">
            <td colspan="5" class="p-8">
                <span v-if="loading"><i class="fas fa-spinner fa-spin"></i> –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</span>
                <span v-else>–Ü—Å—Ç–æ—Ä—ñ—è –∑–∞–º–æ–≤–ª–µ–Ω—å –ø–æ—Ä–æ–∂–Ω—è</span>
            </td>
          </tr>

          <tr v-for="order in orders" :key="order.id" 
              @click="emit('view-details', order)"
              class="hover:bg-blue-50 transition cursor-pointer group">
            
            <td class="p-4">
              <div class="font-bold text-gray-800 group-hover:text-blue-600 transition">#{{ order.id }}</div>
              <div class="text-sm text-gray-500">{{ formatDate(order.created_at) }}</div>
            </td>

            <td class="p-4">
                <div v-if="order.customer">
                    <div class="font-bold text-gray-700">{{ order.customer.name }}</div>
                    <div class="text-xs text-gray-400">{{ order.customer.phone }}</div>
                </div>
                <div v-else class="text-gray-400 text-sm italic">–ì—ñ—Å—Ç—å</div>
            </td>

            <td class="p-4">
              <div class="text-sm text-gray-600">
                 {{ order.items.length }} –ø–æ–∑–∏—Ü—ñ–π
                 <span class="text-xs text-gray-400">({{ order.items[0]?.product_name }}...)</span>
              </div>
            </td>

            <td class="p-4">
              <span v-if="order.payment_method === 'card'" class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs font-bold">
                <i class="fas fa-credit-card mr-1"></i> –ö–∞—Ä—Ç–∫–∞
              </span>
              <span v-else class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold">
                <i class="fas fa-money-bill-wave mr-1"></i> –ì–æ—Ç—ñ–≤–∫–∞
              </span>
            </td>

            <td class="p-4 text-right font-mono font-bold text-lg text-gray-800">
              {{ order.total_price }} ‚Ç¥
            </td>

          </tr>
        </tbody>
      </table>
    </div>
</template>
</file>

<file path="frontend\src\components\stats\Statistics.vue">
<script setup>
import { onMounted } from 'vue'
import { useStatistics } from '@/composables/useStatistics'
import SalesTable from './SalesTable.vue'

const { 
  orders, loading, 
  showDetailModal, selectedOrder, 
  fetchOrders, openDetails, closeDetails 
} = useStatistics()

// Helper for date formatting (duplicate need for modal, can be util)
const formatDate = (dateString) => {
  return new Date(dateString).toLocaleString('uk-UA', {
    day: '2-digit', month: '2-digit', year: 'numeric',
    hour: '2-digit', minute: '2-digit'
  })
}

onMounted(() => fetchOrders())
</script>

<template>
  <div class="p-8 h-screen overflow-y-auto bg-gray-50 ml-64 custom-scrollbar">
    
    <div class="flex justify-between items-center mb-8">
      <div>
        <h2 class="text-3xl font-bold text-gray-800">üìä –Ü—Å—Ç–æ—Ä—ñ—è –ø—Ä–æ–¥–∞–∂—ñ–≤</h2>
        <p class="text-gray-500">–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –Ω–∞ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –¥–ª—è –¥–µ—Ç–∞–ª–µ–π</p>
      </div>
      <button @click="fetchOrders" class="text-blue-600 hover:bg-blue-50 p-2 rounded-full transition">
        <i class="fas fa-sync-alt" :class="{'fa-spin': loading}"></i>
      </button>
    </div>

    <SalesTable :orders="orders" :loading="loading" @view-details="openDetails" />

    <div v-if="showDetailModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg relative overflow-hidden flex flex-col max-h-[90vh] animate-fade-in-up">
            
            <div class="p-6 bg-gray-50 border-b flex justify-between items-start">
                <div>
                    <h3 class="text-2xl font-bold text-gray-800">–ß–µ–∫ #{{ selectedOrder.id }}</h3>
                    <p class="text-gray-500 text-sm">{{ formatDate(selectedOrder.created_at) }}</p>
                </div>
                <button @click="closeDetails" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <div class="p-6 overflow-y-auto custom-scrollbar">
                
                <div class="mb-6 bg-blue-50 p-4 rounded-xl border border-blue-100 flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-blue-200 text-blue-600 flex items-center justify-center text-lg">
                        <i class="fas" :class="selectedOrder.customer ? 'fa-user' : 'fa-user-secret'"></i>
                    </div>
                    <div>
                        <div class="text-xs font-bold text-blue-400 uppercase">–ü–æ–∫—É–ø–µ—Ü—å</div>
                        <div class="font-bold text-gray-800 text-lg">
                            {{ selectedOrder.customer ? selectedOrder.customer.name : '–ì—ñ—Å—Ç—å' }}
                        </div>
                        <div v-if="selectedOrder.customer" class="text-sm text-gray-600">
                            {{ selectedOrder.customer.phone }}
                        </div>
                    </div>
                </div>

                <h4 class="font-bold text-gray-700 mb-3 border-b pb-2">–¢–æ–≤–∞—Ä–∏</h4>
                <div class="space-y-3">
                    <div v-for="item in selectedOrder.items" :key="item.id" class="flex justify-between items-center text-sm">
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-gray-800">{{ item.product_name }}</span>
                            <span v-if="item.details" class="text-xs text-gray-400">({{ item.details }})</span>
                        </div>
                        <div class="flex items-center gap-4">
                            <span class="text-gray-500">x{{ item.quantity }}</span>
                            <span class="font-mono font-bold">{{ item.price_at_moment * item.quantity }} ‚Ç¥</span>
                        </div>
                    </div>
                </div>

            </div>

            <div class="p-6 bg-gray-50 border-t">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-gray-500">–ú–µ—Ç–æ–¥ –æ–ø–ª–∞—Ç–∏:</span>
                    <span class="font-bold uppercase text-sm" 
                          :class="selectedOrder.payment_method === 'card' ? 'text-blue-600' : 'text-green-600'">
                        {{ selectedOrder.payment_method === 'card' ? '–ë–∞–Ω–∫—ñ–≤—Å—å–∫–∞ –∫–∞—Ä—Ç–∫–∞' : '–ì–æ—Ç—ñ–≤–∫–∞' }}
                    </span>
                </div>
                <div class="flex justify-between items-center text-3xl font-bold text-gray-900 mt-2">
                    <span>–†–∞–∑–æ–º:</span>
                    <span>{{ selectedOrder.total_price }} ‚Ç¥</span>
                </div>
            </div>

        </div>
    </div>

  </div>
</template>

<style scoped>
.animate-fade-in-up { animation: fadeInUp 0.3s ease-out; }
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>
</file>

<file path="frontend\src\components\warehouse\Warehouse.vue">
<script setup>
import { ref, onMounted, defineAsyncComponent } from 'vue'
import { useWarehouse } from '@/composables/useWarehouse'

// --- –ù–û–í–ò–ô –Ü–ú–ü–û–†–¢ ---
const StockTab = defineAsyncComponent(() => import('./tabs/StockTab.vue'))

const ProductsTab = defineAsyncComponent(() => import('./tabs/products/ProductsTab.vue'))
const IngredientsTab = defineAsyncComponent(() => import('./tabs/IngredientsTab.vue'))
const RecipesTab = defineAsyncComponent(() => import('./tabs/RecipesTab.vue'))
const ProcessesTab = defineAsyncComponent(() => import('./tabs/ProcessesTab.vue'))
const ConsumablesTab = defineAsyncComponent(() => import('./tabs/ConsumablesTab.vue'))
const UnitsTab = defineAsyncComponent(() => import('./tabs/UnitsTab.vue'))
const CategoriesTab = defineAsyncComponent(() => import('./tabs/CategoriesTab.vue'))

// –ó–º—ñ–Ω–∏–º–æ –¥–µ—Ñ–æ–ª—Ç–Ω—É –≤–∫–ª–∞–¥–∫—É –Ω–∞ 'stock'
const activeTab = ref('stock')
const { fetchData, loading } = useWarehouse()

// --- –î–û–î–ê–Ñ–ú–û –í –û–ë'–Ñ–ö–¢ ---
const tabs = {
    stock: StockTab, // <-- –ù–æ–≤–∞ –≤–∫–ª–∞–¥–∫–∞
    products: ProductsTab,
    recipes: RecipesTab,
    ingredients: IngredientsTab,
    processes: ProcessesTab,
    consumables: ConsumablesTab,
    units: UnitsTab,
    categories: CategoriesTab
}

onMounted(() => {
    fetchData()
})
</script>

<template>
  <div class="p-8 h-screen overflow-y-auto bg-gray-50 ml-64 custom-scrollbar">
    <div class="flex justify-between items-center mb-8">
      <h2 class="text-3xl font-bold text-gray-800">üì¶ –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Å–∫–ª–∞–¥–æ–º</h2>
      <button @click="fetchData" class="text-blue-600 hover:bg-blue-50 p-2 rounded-full">
        <i class="fas fa-sync-alt" :class="{'fa-spin': loading}"></i>
      </button>
    </div>

    <div class="flex space-x-1 bg-gray-200 p-1 rounded-xl w-fit mb-8 overflow-x-auto">
      <button @click="activeTab='stock'" :class="activeTab==='stock'?'bg-white text-green-600 shadow-sm':''" class="px-6 py-2 rounded-lg font-bold transition-all"><i class="fas fa-clipboard-check mr-2"></i>–ó–∞–ª–∏—à–∫–∏</button>
      
      <button @click="activeTab='recipes'" :class="activeTab==='recipes'?'bg-white text-orange-600 shadow-sm':''" class="px-6 py-2 rounded-lg font-bold transition-all"><i class="fas fa-book-open mr-2"></i>–†–µ—Ü–µ–ø—Ç–∏</button>
      <button @click="activeTab='products'" :class="activeTab==='products'?'bg-white text-purple-600 shadow-sm':''" class="px-6 py-2 rounded-lg font-bold transition-all">–¢–æ–≤–∞—Ä–∏</button>
      <button @click="activeTab='processes'" :class="activeTab==='processes'?'bg-white text-indigo-600 shadow-sm':''" class="px-6 py-2 rounded-lg font-bold transition-all"><i class="fas fa-tasks mr-2"></i>–ü—Ä–æ—Ü–µ—Å–∏</button>
      
      <button @click="activeTab='ingredients'" :class="activeTab==='ingredients'?'bg-white text-blue-600 shadow-sm':''" class="px-6 py-2 rounded-lg font-bold transition-all">–Ü–Ω–≥—Ä—ñ–¥—ñ—î–Ω—Ç–∏</button>
      <button @click="activeTab='consumables'" :class="activeTab==='consumables'?'bg-white text-teal-600 shadow-sm':''" class="px-6 py-2 rounded-lg font-bold transition-all"><i class="fas fa-box-open mr-2"></i>–í–∏—Ç—Ä–∞—Ç–Ω—ñ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏</button>
      
      <button @click="activeTab='units'" :class="activeTab==='units'?'bg-white text-blue-600 shadow-sm':''" class="px-6 py-2 rounded-lg font-bold transition-all">–û–¥–∏–Ω–∏—Ü—ñ</button>
      <button @click="activeTab='categories'" :class="activeTab==='categories'?'bg-white text-blue-600 shadow-sm':''" class="px-6 py-2 rounded-lg font-bold transition-all">–ö–∞—Ç–µ–≥–æ—Ä—ñ—ó</button>
    </div>

    <component :is="tabs[activeTab]" />
    
  </div>
</template>
</file>

<file path="frontend\src\components\warehouse\modals\HistoryModal.vue">
<script setup>
import { ref, watch } from 'vue'

const props = defineProps({
  isOpen: Boolean,
  item: Object // –û—á—ñ–∫—É—î–º–æ –æ–±'—î–∫—Ç: { id, type, name }
})

const emit = defineEmits(['close'])
const history = ref([])
const loading = ref(false)
const error = ref(null)

const formatDate = (dateStr) => {
  return new Date(dateStr).toLocaleString('uk-UA', { 
    day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' 
  })
}

const fetchHistory = async () => {
  if (!props.item) return
  
  loading.value = true
  history.value = [] 
  error.value = null

  try {
    // URL —Ñ–æ—Ä–º—É—î—Ç—å—Å—è –∑ —á–∏—Å—Ç–æ–≥–æ ID, —è–∫–∏–π –º–∏ –ø–µ—Ä–µ–¥–∞–ª–∏ –∑ StockTab
    const url = `/api/history/?entity_type=${props.item.type}&entity_id=${props.item.id}`
    
    console.log("HISTORY MODAL: Requesting ->", url)
    
    const res = await fetch(url)
    
    if (res.ok) {
        history.value = await res.json()
        console.log("HISTORY MODAL: Success! Records found:", history.value.length)
    } else {
        console.error("HISTORY MODAL: Server returned status", res.status)
        error.value = "–ü–æ–º–∏–ª–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞"
    }
  } catch (e) {
    console.error("HISTORY MODAL: Network error", e)
    error.value = "–ü–æ–º–∏–ª–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è"
  } finally {
    loading.value = false
  }
}

// –°–ª—ñ–¥–∫—É—î–º–æ –∑–∞ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è–º
watch(() => props.isOpen, (val) => {
  if (val) {
    fetchHistory()
  }
}, { immediate: true })
</script>

<template>
  <div v-if="isOpen" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4" @click.self="$emit('close')">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[80vh] animate-fade-in-up">
      
      <div class="p-4 border-b flex justify-between items-center bg-gray-50">
        <div>
           <div class="text-xs uppercase font-bold text-gray-400">–Ü—Å—Ç–æ—Ä—ñ—è —Ä—É—Ö—É</div>
           <h3 class="font-bold text-lg text-gray-800">{{ item?.name }}</h3>
           <p class="text-xs text-gray-400">ID: {{ item?.id }} | Type: {{ item?.type }}</p>
        </div>
        <button @click="emit('close')" class="text-gray-400 hover:text-gray-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-200">
            <i class="fas fa-times text-xl"></i>
        </button>
      </div>

      <div class="flex-1 overflow-y-auto p-0 custom-scrollbar relative min-h-[200px]">
         
         <div v-if="loading" class="absolute inset-0 flex flex-col items-center justify-center bg-white/80 z-10">
            <i class="fas fa-spinner fa-spin text-3xl text-blue-500 mb-2"></i> 
            <span class="text-gray-500">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</span>
         </div>

         <div v-else-if="error" class="p-8 text-center text-red-500">
            <i class="fas fa-exclamation-circle text-2xl mb-2"></i>
            <p>{{ error }}</p>
         </div>

         <div v-else-if="history.length === 0" class="p-8 text-center text-gray-400">
            <i class="fas fa-history text-4xl mb-3 opacity-30"></i>
            <p>–Ü—Å—Ç–æ—Ä—ñ—è –ø–æ—Ä–æ–∂–Ω—è</p>
         </div>
         
         <table v-else class="w-full text-sm text-left">
           <thead class="bg-gray-100 text-gray-500 text-xs uppercase sticky top-0">
             <tr>
               <th class="p-3">–î–∞—Ç–∞</th>
               <th class="p-3">–ü—Ä–∏—á–∏–Ω–∞</th>
               <th class="p-3 text-right">–ó–º—ñ–Ω–∞</th>
               <th class="p-3 text-right">–ó–∞–ª–∏—à–æ–∫</th>
             </tr>
           </thead>
           <tbody class="divide-y divide-gray-100">
             <tr v-for="h in history" :key="h.id" class="hover:bg-gray-50 transition-colors">
               <td class="p-3 text-gray-500 whitespace-nowrap font-mono text-xs">{{ formatDate(h.created_at) }}</td>
               
               <td class="p-3">
                 <span v-if="h.reason === 'manual_correction'" class="bg-gray-200 text-gray-600 px-2 py-1 rounded text-[10px] font-bold">–ö–æ—Ä–µ–∫—Ü—ñ—è</span>
                 <span v-else-if="h.reason && h.reason.includes('sale')" class="bg-green-100 text-green-700 px-2 py-1 rounded text-[10px] font-bold">–ü—Ä–æ–¥–∞–∂</span>
                 <span v-else class="text-gray-700 font-bold text-xs">{{ h.reason }}</span>
               </td>

               <td class="p-3 text-right font-mono font-bold" :class="h.change_amount > 0 ? 'text-green-600' : 'text-red-500'">
                 {{ h.change_amount > 0 ? '+' : '' }}{{ h.change_amount }}
               </td>
               
               <td class="p-3 text-right font-mono text-gray-600">
                 {{ h.balance_after }}
               </td>
             </tr>
           </tbody>
         </table>
      </div>

    </div>
  </div>
</template>

<style scoped>
.animate-fade-in-up { animation: fadeInUp 0.3s ease-out; }
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>
</file>

<file path="frontend\src\components\warehouse\tabs\CategoriesTab.vue">
<script setup>
import { ref } from 'vue'
import { useWarehouse } from '@/composables/useWarehouse'

// –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –º–µ—Ç–æ–¥–∏ –∑ –Ω–∞—à–æ–≥–æ composable
const { categories, createItem, updateItem, deleteItem } = useWarehouse()

// –°—Ç–∞–Ω —Ñ–æ—Ä–º–∏
const newCategory = ref({ name: '', slug: '', color: '#3b82f6', parent_id: '' }) 
const isEditing = ref(false)
const editingId = ref(null)

// –î–æ–ø–æ–º—ñ–∂–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –±–∞—Ç—å–∫–∞
const getParentName = (parentId) => {
    if (!parentId) return '';
    const parent = categories.value.find(c => c.id === parentId);
    return parent ? parent.name : '???';
}

// –ó–∞–ø–æ–≤–Ω–µ–Ω–Ω—è —Ñ–æ—Ä–º–∏ –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
const prepareEdit = (category) => {
    isEditing.value = true
    editingId.value = category.id
    newCategory.value = {
        name: category.name,
        slug: category.slug,
        color: category.color || '#3b82f6',
        parent_id: category.parent_id || ''
    }
}

// –°–∫–∏–¥–∞–Ω–Ω—è —Ñ–æ—Ä–º–∏
const resetForm = () => {
    isEditing.value = false
    editingId.value = null
    newCategory.value = { name: '', slug: '', color: '#3b82f6', parent_id: '' }
}

// –û–±—Ä–æ–±–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è (–°—Ç–≤–æ—Ä–∏—Ç–∏ –ê–ë–û –û–Ω–æ–≤–∏—Ç–∏)
const handleSave = async () => {
    if (!newCategory.value.name) return alert("–í–∫–∞–∂—ñ—Ç—å –Ω–∞–∑–≤—É –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó!")
    
    const payload = { ...newCategory.value }
    
    // –ê–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü—ñ—è slug, —è–∫—â–æ –ø—É—Å—Ç–æ
    if (!payload.slug) {
        payload.slug = payload.name.toLowerCase().replace(/\s+/g, '-') + '-' + Date.now().toString().slice(-4)
    }
    // –û—á–∏—â–µ–Ω–Ω—è parent_id
    if (payload.parent_id === "") payload.parent_id = null
    
    let success = false

    if (isEditing.value) {
        // –û–ù–û–í–õ–ï–ù–ù–Ø (PUT)
        success = await updateItem(`/api/categories/${editingId.value}`, payload)
    } else {
        // –°–¢–í–û–†–ï–ù–ù–Ø (POST)
        success = await createItem('/api/categories/', payload)
    }

    if(success) {
        resetForm()
    }
}

// –û–±—Ä–æ–±–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è
const handleDelete = async (id) => {
    await deleteItem(`/api/categories/${id}`)
    // –Ø–∫—â–æ –º–∏ —Ä–µ–¥–∞–≥—É–≤–∞–ª–∏ —Å–∞–º–µ —Ü—é –∫–∞—Ç–µ–≥–æ—Ä—ñ—é - —Å–∫–∏–¥–∞—î–º–æ —Ñ–æ—Ä–º—É
    if (editingId.value === id) {
        resetForm()
    }
}
</script>

<template>
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 h-fit">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-gray-700">
                    {{ isEditing ? '‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó' : 'üìÇ –ù–æ–≤–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è' }}
                </h3>
                <button v-if="isEditing" @click="resetForm" class="text-xs text-red-500 hover:underline">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">–ù–∞–∑–≤–∞</label>
                    <input v-model="newCategory.name" class="border p-2 rounded w-full focus:ring-2 ring-blue-100 outline-none" placeholder="–ù–∞–ø—Ä. –ö–∞–≤–∞">
                </div>
                
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">–ö–æ–¥ (Slug)</label>
                    <input v-model="newCategory.slug" class="border p-2 rounded w-full font-mono text-sm text-gray-600" placeholder="auto-generated">
                </div>
                
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">–ö–æ–ª—ñ—Ä</label>
                    <div class="flex items-center gap-2">
                        <input v-model="newCategory.color" type="color" class="h-10 w-16 border rounded cursor-pointer p-1 bg-white">
                        <span class="text-sm text-gray-600 font-mono">{{ newCategory.color }}</span>
                    </div>
                </div>
                
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">–ë–∞—Ç—å–∫—ñ–≤—Å—å–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è</label>
                    <select v-model="newCategory.parent_id" class="border p-2 rounded w-full bg-white">
                        <option value="">(–ù–µ–º–∞—î - –ö–æ—Ä–µ–Ω–µ–≤–∞)</option>
                        <option v-for="c in categories" :key="c.id" :value="c.id" :disabled="c.id === editingId">
                            {{ c.name }}
                        </option>
                    </select>
                </div>
                
                <button @click="handleSave" 
                    class="w-full py-3 rounded-xl font-bold text-white shadow-lg transition transform active:scale-95"
                    :class="isEditing ? 'bg-orange-500 hover:bg-orange-600 shadow-orange-200' : 'bg-blue-600 hover:bg-blue-700 shadow-blue-200'">
                    {{ isEditing ? '–ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏' : '–°—Ç–≤–æ—Ä–∏—Ç–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ—é' }}
                </button>
            </div>
        </div>

        <div class="lg:col-span-2 bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="bg-gray-50 text-gray-500 uppercase text-xs">
                        <tr>
                            <th class="p-4">–ö–æ–ª—ñ—Ä</th>
                            <th class="p-4">–ù–∞–∑–≤–∞</th>
                            <th class="p-4">–ö–æ–¥</th>
                            <th class="p-4">–ë–∞—Ç—å–∫–æ</th>
                            <th class="p-4 text-center">–î—ñ—ó</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        <tr v-if="categories.length === 0">
                            <td colspan="5" class="p-8 text-center text-gray-400">–ö–∞—Ç–µ–≥–æ—Ä—ñ–π —â–µ –Ω–µ–º–∞—î</td>
                        </tr>
                        <tr v-for="c in categories" :key="c.id" class="hover:bg-gray-50 group">
                            <td class="p-4">
                                <div class="w-8 h-8 rounded-lg shadow-sm border border-gray-200" :style="{ backgroundColor: c.color || '#fff' }"></div>
                            </td>
                            <td class="p-4 font-bold text-gray-800 text-lg">{{ c.name }}</td>
                            <td class="p-4 font-mono text-gray-500">{{ c.slug }}</td>
                            <td class="p-4">
                                <span v-if="c.parent_id" class="bg-blue-50 text-blue-600 px-2 py-1 rounded text-xs font-bold">
                                    {{ getParentName(c.parent_id) }}
                                </span>
                                <span v-else class="text-gray-300 text-xs">-</span>
                            </td>
                            <td class="p-4 text-center">
                                <div class="flex justify-center gap-2">
                                    <button @click="prepareEdit(c)" class="p-2 text-blue-400 hover:text-blue-600 hover:bg-blue-50 rounded transition" title="–†–µ–¥–∞–≥—É–≤–∞—Ç–∏">
                                        <i class="fas fa-pen"></i>
                                    </button>
                                    <button @click="handleDelete(c.id)" class="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded transition" title="–í–∏–¥–∞–ª–∏—Ç–∏">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</template>
</file>

<file path="frontend\src\components\warehouse\tabs\ConsumablesTab.vue">
<script setup>
import { ref, onMounted } from 'vue'
import { useWarehouse } from '@/composables/useWarehouse'

// 1. –ë–µ—Ä–µ–º–æ units –∑ useWarehouse
const { consumables, units, createItem, deleteItem } = useWarehouse()

const categories = ref([])

// 2. –î–æ–¥–∞—î–º–æ unit_id –≤ –º–æ–¥–µ–ª—å —Ñ–æ—Ä–º–∏
const newConsumable = ref({ 
    name: '', 
    unit_id: '', // –ü–æ—á–∞—Ç–∫–æ–≤–µ –∑–Ω–∞—á–µ–Ω–Ω—è –ø—É—Å—Ç–µ
    cost_per_unit: 0, 
    stock_quantity: 0,
    category_id: null 
})

const fetchCategories = async () => {
    try {
        const response = await fetch('/api/categories/') 
        if (response.ok) {
            categories.value = await response.json()
        }
    } catch (e) {
        console.error("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–∞—Ç–µ–≥–æ—Ä—ñ–π:", e)
    }
}

onMounted(() => {
    fetchCategories()
})

const handleCreate = async () => {
    if(!newConsumable.value.name) return
    const success = await createItem('/api/consumables/', newConsumable.value)
    if(success) {
        newConsumable.value = {
            name:'', 
            unit_id:'', 
            cost_per_unit:0, 
            stock_quantity:0, 
            category_id: null
        }
    }
}

const handleDelete = (id) => deleteItem(`/api/consumables/${id}`)
</script>

<template>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 h-fit">
            <h3 class="font-bold mb-6 text-gray-700 border-b pb-2">üì¶ –ù–æ–≤–∏–π –º–∞—Ç–µ—Ä—ñ–∞–ª</h3>
            
            <div class="space-y-5">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">–ù–∞–∑–≤–∞</label>
                    <input v-model="newConsumable.name" placeholder="–ù–∞–ø—Ä. –°—Ç–∞–∫–∞–Ω 300–º–ª" class="border p-2 rounded-lg w-full bg-gray-50 focus:bg-white focus:ring-2 focus:ring-teal-100 outline-none transition">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</label>
                        <select v-model="newConsumable.category_id" class="border p-2 rounded-lg w-full bg-white h-[42px]">
                            <option :value="null">–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó</option>
                            <option v-for="cat in categories" :key="cat.id" :value="cat.id">
                                {{ cat.name }}
                            </option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">–û–¥–∏–Ω–∏—Ü—è –≤–∏–º—ñ—Ä—É</label>
                        <select v-model="newConsumable.unit_id" class="border p-2 rounded-lg w-full bg-white h-[42px]">
                            <option value="" disabled>–û–±–µ—Ä—ñ—Ç—å...</option>
                            <option v-for="u in units" :key="u.id" :value="u.id">
                                {{u.name}} ({{u.symbol}})
                            </option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">–¶—ñ–Ω–∞ (‚Ç¥/–æ–¥)</label>
                        <input v-model="newConsumable.cost_per_unit" type="number" step="0.01" class="border p-2 rounded-lg w-full">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">–ü–æ—á. –∑–∞–ª–∏—à–æ–∫</label>
                        <input v-model="newConsumable.stock_quantity" type="number" class="border p-2 rounded-lg w-full">
                    </div>
                </div>

                <button @click="handleCreate" class="bg-teal-600 hover:bg-teal-700 text-white w-full py-3 rounded-xl font-bold shadow-lg shadow-teal-200 transition mt-2">
                    <i class="fas fa-plus mr-2"></i> –î–æ–¥–∞—Ç–∏
                </button>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm overflow-hidden border border-gray-100">
            <table class="w-full text-sm text-left">
                <thead class="bg-gray-50 text-gray-500 uppercase text-xs">
                    <tr>
                        <th class="p-4">–ù–∞–∑–≤–∞</th>
                        <th class="p-4 text-right">–ó–∞–ª–∏—à–æ–∫</th>
                        <th class="p-4 text-center">–î—ñ—ó</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    <tr v-for="c in consumables" :key="c.id" class="hover:bg-gray-50">
                        <td class="p-4 font-bold text-gray-700">
                            {{ c.name }}
                            <div class="flex items-center gap-2 mt-1">
                                <span v-if="c.category" class="text-[10px] bg-teal-50 text-teal-600 px-2 py-0.5 rounded-full uppercase tracking-wider font-bold">
                                    {{ c.category.name }}
                                </span>
                                <span class="text-xs text-gray-400 font-normal">
                                    {{ c.cost_per_unit }} ‚Ç¥/{{ c.unit?.symbol || '–æ–¥' }}
                                </span>
                            </div>
                        </td>
                        <td class="p-4 text-right font-mono text-lg" :class="c.stock_quantity > 10 ? 'text-green-600' : 'text-red-500'">
                            {{ c.stock_quantity }} 
                            <span class="text-xs text-gray-400 font-sans">{{ c.unit?.symbol || '?' }}</span>
                        </td>
                        <td class="p-4 text-center">
                            <button @click="handleDelete(c.id)" class="text-gray-400 hover:text-red-500 px-2 transition">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</template>
</file>

<file path="frontend\src\components\warehouse\tabs\IngredientsTab.vue">
<script setup>
// üëá –î–û–î–ê–ù–û: onMounted (—Ü–µ –±—É–ª–æ –ø—Ä–æ–ø—É—â–µ–Ω–æ)
import { ref, onMounted } from 'vue'
import { useWarehouse } from '@/composables/useWarehouse'

// –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –≥–ª–æ–±–∞–ª—å–Ω—ñ –¥–∞–Ω—ñ
const { ingredients, units, createItem, deleteItem } = useWarehouse()

// –õ–æ–∫–∞–ª—å–Ω–∏–π —Å—Ç–∞–Ω –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä—ñ–π
const categories = ref([])

const newIngredient = ref({ 
    name: '', 
    unit_id: '', 
    cost_per_unit: 0, 
    stock_quantity: 0, 
    category_id: null 
})

// –§—É–Ω–∫—Ü—ñ—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–∞—Ç–µ–≥–æ—Ä—ñ–π –∑ –±–µ–∫–µ–Ω–¥—É
const fetchCategories = async () => {
    try {
        const response = await fetch('/api/categories/') 
        if (response.ok) {
            categories.value = await response.json()
        }
    } catch (e) {
        console.error("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–∞—Ç–µ–≥–æ—Ä—ñ–π:", e)
    }
}

// –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –ø—Ä–∏ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—ñ –≤–∫–ª–∞–¥–∫–∏
onMounted(() => {
    fetchCategories()
})

const handleCreate = async () => {
    console.log("–°–ø—Ä–æ–±–∞ —Å—Ç–≤–æ—Ä–∏—Ç–∏:", newIngredient.value);
    if(!newIngredient.value.name) return
    const success = await createItem('/api/ingredients/', newIngredient.value)
    if(success) {
        newIngredient.value = {
            name:'',
            unit_id:'',
            cost_per_unit:0,
            stock_quantity:0,
            category_id: null
        }
    }
}

const handleDelete = (id) => deleteItem(`/api/ingredients/${id}`)
</script>

<template>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 h-fit">
            <h3 class="font-bold mb-6 text-gray-700 border-b pb-2">üå± –ù–æ–≤–∏–π —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç</h3>
            
            <div class="space-y-5">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">–ù–∞–∑–≤–∞ —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∞</label>
                    <input v-model="newIngredient.name" placeholder="–ù–∞–ø—Ä. –ö–∞–≤–∞ –≤ –∑–µ—Ä–Ω–∞—Ö" class="border p-2 rounded-lg w-full bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-100 outline-none transition">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</label>
                        <select v-model="newIngredient.category_id" class="border p-2 rounded-lg w-full bg-white h-[42px]">
                            <option :value="null">–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó</option>
                            <option v-for="cat in categories" :key="cat.id" :value="cat.id">
                                {{ cat.name }}
                            </option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">–û–¥–∏–Ω–∏—Ü—è –≤–∏–º—ñ—Ä—É</label>
                        <select v-model="newIngredient.unit_id" class="border p-2 rounded-lg w-full bg-white h-[42px]">
                            <option value="" disabled>–û–±–µ—Ä—ñ—Ç—å...</option>
                            <option v-for="u in units" :key="u.id" :value="u.id">
                                {{u.name}} ({{u.symbol}})
                            </option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">–°–æ–±—ñ–≤–∞—Ä—Ç—ñ—Å—Ç—å (‚Ç¥/–æ–¥)</label>
                        <input v-model="newIngredient.cost_per_unit" type="number" step="0.01" placeholder="0.00" class="border p-2 rounded-lg w-full">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">–ü–æ—á. –∑–∞–ª–∏—à–æ–∫</label>
                        <input v-model="newIngredient.stock_quantity" type="number" step="0.01" placeholder="0" class="border p-2 rounded-lg w-full">
                    </div>
                </div>

                <button @click="handleCreate" class="bg-blue-600 hover:bg-blue-700 text-white w-full py-3 rounded-xl font-bold shadow-lg shadow-blue-200 transition mt-2">
                    <i class="fas fa-plus mr-2"></i> –î–æ–¥–∞—Ç–∏ –≤ –±–∞–∑—É
                </button>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm overflow-hidden border border-gray-100">
            <table class="w-full text-sm text-left">
                <thead class="bg-gray-50 text-gray-500 uppercase text-xs">
                    <tr>
                        <th class="p-4">–ù–∞–∑–≤–∞</th>
                        <th class="p-4 text-right">–ó–∞–ª–∏—à–æ–∫</th>
                        <th class="p-4 text-center">–î—ñ—ó</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    <tr v-for="i in ingredients" :key="i.id" class="hover:bg-gray-50">
                        <td class="p-4 font-bold text-gray-700">
                            {{ i.name }}
                            <div class="flex items-center gap-2 mt-1">
                                <span v-if="i.category" class="text-[10px] bg-blue-50 text-blue-600 px-2 py-0.5 rounded-full uppercase tracking-wider font-bold">
                                    {{ i.category.name }}
                                </span>
                                <span class="text-xs text-gray-400 font-normal">
                                    {{ i.cost_per_unit }} ‚Ç¥/{{ i.unit?.symbol }}
                                </span>
                            </div>
                        </td>
                        <td class="p-4 text-right font-mono text-lg" :class="i.stock_quantity > 0 ? 'text-green-600' : 'text-red-500'">
                            {{ i.stock_quantity }} <span class="text-xs text-gray-400 font-sans">{{ i.unit?.symbol }}</span>
                        </td>
                        <td class="p-4 text-center">
                            <button @click="handleDelete(i.id)" class="text-gray-400 hover:text-red-500 px-2 transition">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</template>
</file>

<file path="frontend\src\components\warehouse\tabs\ProcessesTab.vue">
<script setup>
import { ref } from 'vue'
import { useWarehouse } from '@/composables/useWarehouse'

const { processGroups, fetchData, createItem, deleteItem } = useWarehouse()

const newProcessGroup = ref({ name: '' })

const handleCreateGroup = async () => {
    if(!newProcessGroup.value.name) return alert("–í–∫–∞–∂—ñ—Ç—å –Ω–∞–∑–≤—É –≥—Ä—É–ø–∏ (–Ω–∞–ø—Ä. –ü–æ–º–æ–ª)")
    const success = await createItem('/api/processes/groups/', { name: newProcessGroup.value.name, options: [] })
    if(success) newProcessGroup.value.name = ''
}

const handleDeleteGroup = (id) => deleteItem(`/api/processes/groups/${id}`)

const addProcessOption = async (groupId) => {
    const name = prompt("–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –æ–ø—Ü—ñ—ó (–Ω–∞–ø—Ä. –ü—ñ–¥ –µ—Å–ø—Ä–µ—Å–æ):")
    if(!name) return
    await createItem(`/api/processes/options/?group_id=${groupId}`, { name: name })
}

const deleteProcessOption = (optionId) => deleteItem(`/api/processes/options/${optionId}`)
</script>

<template>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-indigo-100 h-fit">
            <h3 class="font-bold text-lg text-indigo-800 mb-4 border-b pb-2">‚ûï –ù–æ–≤–∞ –≥—Ä—É–ø–∞ –ø—Ä–æ—Ü–µ—Å—ñ–≤</h3>
            <p class="text-sm text-gray-500 mb-4">–ù–∞–ø—Ä–∏–∫–ª–∞–¥: "–ü–æ–º–æ–ª", "–°—Ç—É–ø—ñ–Ω—å –ø—Ä–æ—Å–º–∞–∂–µ–Ω–Ω—è", "–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –ø–æ–¥–∞—á—ñ".</p>
            <div class="flex gap-2">
                <input v-model="newProcessGroup.name" placeholder="–ù–∞–∑–≤–∞ –≥—Ä—É–ø–∏..." class="flex-1 border p-2 rounded-lg outline-none focus:ring-2 ring-indigo-200">
                <button @click="handleCreateGroup" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-indigo-700 transition">–°—Ç–≤–æ—Ä–∏—Ç–∏</button>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
             <div v-if="processGroups.length === 0" class="p-8 text-center text-gray-400">
                 –ù–µ–º–∞—î —Å—Ç–≤–æ—Ä–µ–Ω–∏—Ö –ø—Ä–æ—Ü–µ—Å—ñ–≤
             </div>
             
             <div v-else class="divide-y divide-gray-100">
                 <div v-for="group in processGroups" :key="group.id" class="p-6">
                     <div class="flex justify-between items-center mb-4">
                         <h4 class="font-bold text-xl text-gray-800">{{ group.name }}</h4>
                         <button @click="handleDeleteGroup(group.id)" class="text-gray-300 hover:text-red-500 transition"><i class="fas fa-trash"></i></button>
                     </div>

                     <div class="space-y-2 mb-4">
                         <div v-for="opt in group.options" :key="opt.id" class="flex items-center justify-between bg-gray-50 px-3 py-2 rounded-lg border border-gray-100">
                             <span class="text-gray-700 font-medium">{{ opt.name }}</span>
                             <button @click="deleteProcessOption(opt.id)" class="text-red-300 hover:text-red-500"><i class="fas fa-times"></i></button>
                         </div>
                     </div>

                     <button @click="addProcessOption(group.id)" class="w-full py-2 bg-indigo-50 text-indigo-600 font-bold rounded-lg hover:bg-indigo-100 border border-indigo-200 border-dashed">
                         + –î–æ–¥–∞—Ç–∏ –≤–∞—Ä—ñ–∞–Ω—Ç (–Ω–∞–ø—Ä. "–ü—ñ–¥ –µ—Å–ø—Ä–µ—Å–æ")
                     </button>
                 </div>
             </div>
        </div>
    </div>
</template>
</file>

<file path="frontend\src\components\warehouse\tabs\ProductsTab.vue">
<script setup>
import { ref, onMounted, watch, computed } from 'vue'
import { useWarehouse } from '@/composables/useWarehouse'
import { useProducts } from '@/composables/useProducts'

// --- –î–û–í–Ü–î–ù–ò–ö–ò ---
const { categories, recipes, ingredients, consumables } = useWarehouse()

// --- –§–£–ù–ö–¶–Ü–û–ù–ê–õ –¢–û–í–ê–†–Ü–í ---
const { 
    newProduct, isEditing, 
    prepareEdit: originalHandleEdit, 
    saveProduct, deleteProduct, fetchProducts, filteredProducts, productSearch, resetForm,
    removeProductConsumable
} = useProducts()

// --- UI STATES ---
const showTypeModal = ref(false)
const showForm = ref(false)
const productType = ref(null)

// --- –ö–ê–õ–¨–ö–£–õ–Ø–¢–û–† –°–û–ë–Ü–í–ê–†–¢–û–°–¢–Ü (–ë–ï–ö–ï–ù–î - –ó–ê–ì–ê–õ–¨–ù–ê) ---
const serverCalculatedCost = ref(0)
let debounceTimer = null

const calculateCost = async () => {
    const payload = {
        master_recipe_id: newProduct.value.master_recipe_id,
        output_weight: newProduct.value.output_weight || 0,
        ingredients: newProduct.value.ingredients || [],
        consumables: newProduct.value.consumables || []
    }

    try {
        const res = await fetch('/api/products/calculate-cost', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        if (res.ok) {
            const data = await res.json()
            serverCalculatedCost.value = data.total_cost
        }
    } catch (e) {
        console.error("–ü–æ–º–∏–ª–∫–∞ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É:", e)
    }
}

// --- üî• –í–Ü–ó–£–ê–õ–Ü–ó–ê–¶–Ü–Ø –†–ï–¶–ï–ü–¢–£ –ó –¶–Ü–ù–ê–ú–ò ---
const selectedRecipeBreakdown = computed(() => {
    if (!newProduct.value.master_recipe_id) return { items: [], totalCost: 0 }
    
    const recipe = recipes.value.find(r => r.id === newProduct.value.master_recipe_id)
    if (!recipe || !recipe.items) return { items: [], totalCost: 0 }

    const totalWeight = newProduct.value.output_weight || 0
    let currentRecipeCost = 0

    const items = recipe.items.map(item => {
        // –ó–Ω–∞—Ö–æ–¥–∏–º–æ —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç –≤ –¥–æ–≤—ñ–¥–Ω–∏–∫—É, —â–æ–± –≤–∑—è—Ç–∏ —Ü—ñ–Ω—É
        const ingData = ingredients.value.find(i => i.id === item.ingredient_id)
        const ingName = ingData?.name || '–ù–µ–≤—ñ–¥–æ–º–∏–π —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç'
        const unitSymbol = ingData?.unit?.symbol || ''
        const costPerUnit = ingData?.cost_per_unit || 0
        
        let calculatedQty = 0
        let metaInfo = ''

        if (item.is_percentage) {
            calculatedQty = (item.quantity / 100) * totalWeight
            metaInfo = `${item.quantity}%`
        } else {
            calculatedQty = item.quantity
            metaInfo = '—Ñ—ñ–∫—Å.'
        }
        
        // –†–∞—Ö—É—î–º–æ –≤–∞—Ä—Ç—ñ—Å—Ç—å —Ü—ñ—î—ó –ø–æ–∑–∏—Ü—ñ—ó
        const itemCost = calculatedQty * costPerUnit
        currentRecipeCost += itemCost

        return {
            name: ingName,
            meta: metaInfo,
            qty: calculatedQty.toFixed(1),
            unit: unitSymbol,
            cost: itemCost.toFixed(2) // –¶—ñ–Ω–∞ –∑–∞ —Ü—é –∫—ñ–ª—å–∫—ñ—Å—Ç—å
        }
    })

    return {
        items,
        totalCost: currentRecipeCost.toFixed(2)
    }
})

// --- –õ–û–ì–Ü–ö–ê –†–ï–î–ê–ì–£–í–ê–ù–ù–Ø ---
const handleEditWrapper = async (product) => {
    console.log("‚úèÔ∏è –ü–æ—á–∏–Ω–∞—î–º–æ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è:", product.name)
    
    if (typeof originalHandleEdit === 'function') {
        originalHandleEdit(product)
    } else {
        console.error("‚ùå –ü–æ–º–∏–ª–∫–∞: prepareEdit –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞!")
        return
    }

    productType.value = product.has_variants ? 'variant' : 'simple'

    if (!newProduct.value.ingredients) newProduct.value.ingredients = []
    if (!newProduct.value.consumables) newProduct.value.consumables = []

    showForm.value = true
    await calculateCost()
}

// --- HELPER –î–õ–Ø –í–Ü–î–û–ë–†–ê–ñ–ï–ù–ù–Ø –¶–Ü–ù–ò –í –°–ü–ò–°–ö–ê–• ---
const getLinkCost = (id, qty, sourceList) => {
    if (!id || !sourceList) return '0.00'
    const list = sourceList.value || sourceList
    if (!Array.isArray(list)) return '0.00'
    const item = list.find(x => x.id === id)
    if (!item) return '0.00'
    return (item.cost_per_unit * qty).toFixed(2)
}

// --- –õ–û–ì–Ü–ö–ê –ü–†–û–°–¢–ò–• –Ü–ù–ì–†–ï–î–Ü–Ñ–ù–¢–Ü–í ---
const tempSimpleIngredient = ref({ id: null, qty: 0 })

const addSimpleIngredient = () => {
    if (tempSimpleIngredient.value.id && tempSimpleIngredient.value.qty > 0) {
        if (!newProduct.value.ingredients) newProduct.value.ingredients = []
        
        const existing = newProduct.value.ingredients.find(i => i.ingredient_id === tempSimpleIngredient.value.id)
        if (existing) {
            existing.quantity += tempSimpleIngredient.value.qty
        } else {
            newProduct.value.ingredients.push({
                ingredient_id: tempSimpleIngredient.value.id,
                quantity: tempSimpleIngredient.value.qty
            })
        }
        tempSimpleIngredient.value = { id: null, qty: 0 }
    }
}

const removeSimpleIngredient = (index) => {
    newProduct.value.ingredients.splice(index, 1)
}

// --- –õ–û–ì–Ü–ö–ê –í–ò–¢–†–ê–¢–ù–ò–• –ú–ê–¢–ï–†–Ü–ê–õ–Ü–í ---
const tempSimpleConsumable = ref({ id: null, qty: 1 })

const addSimpleConsumable = () => {
    if (tempSimpleConsumable.value.id && tempSimpleConsumable.value.qty > 0) {
        if (!newProduct.value.consumables) newProduct.value.consumables = []
        
        const existing = newProduct.value.consumables.find(c => c.consumable_id === tempSimpleConsumable.value.id)
        if (existing) {
            existing.quantity += tempSimpleConsumable.value.qty
        } else {
            newProduct.value.consumables.push({
                consumable_id: tempSimpleConsumable.value.id,
                quantity: tempSimpleConsumable.value.qty
            })
        }
        tempSimpleConsumable.value = { id: null, qty: 1 }
    }
}

const removeSimpleConsumable = (index) => {
    newProduct.value.consumables.splice(index, 1)
}

// --- –°–õ–Ü–î–ö–£–í–ê–ù–ù–Ø –ó–ê –ó–ú–Ü–ù–ê–ú–ò ---
watch(
    () => [
        newProduct.value.master_recipe_id, 
        newProduct.value.output_weight, 
        newProduct.value.ingredients, 
        newProduct.value.consumables
    ], 
    () => {
        clearTimeout(debounceTimer)
        debounceTimer = setTimeout(calculateCost, 500)
    },
    { deep: true }
)

// --- –£–ü–†–ê–í–õ–Ü–ù–ù–Ø –§–û–†–ú–ê–ú–ò ---
const startCreate = () => {
    resetForm()
    productType.value = null
    showTypeModal.value = true
}

const selectType = (type) => {
    productType.value = type
    if (type === 'simple') {
        newProduct.value.has_variants = false
        newProduct.value.ingredients = [] 
        newProduct.value.consumables = []
    } else {
        newProduct.value.has_variants = true
    }
    showTypeModal.value = false
    showForm.value = true
}

const handleSave = async () => {
    await saveProduct()
    showForm.value = false
}

const closeForm = () => {
    showForm.value = false
    resetForm()
}

const getCategoryName = (id) => categories.value.find(c => c.id === id)?.name || '-'

onMounted(() => {
    fetchProducts()
})
</script>

<template>
    <div class="h-full flex flex-col">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800">üì¶ –¢–æ–≤–∞—Ä–∏</h2>
            <div class="flex gap-4">
                <input v-model="productSearch" placeholder="–ü–æ—à—É–∫..." class="border rounded-lg px-4 py-2 w-64 shadow-sm focus:ring-2 focus:ring-blue-500 outline-none">
                <button @click="startCreate" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 shadow-md transition font-medium flex items-center gap-2">
                    <i class="fas fa-plus"></i> –î–æ–¥–∞—Ç–∏ —Ç–æ–≤–∞—Ä
                </button>
            </div>
        </div>

        <div v-if="showTypeModal" class="fixed inset-0 bg-black/60 flex items-center justify-center z-50 backdrop-blur-sm">
            <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-lg text-center animate-fade-in">
                <h3 class="text-2xl font-bold mb-6 text-gray-800">–Ø–∫–∏–π —Ç–æ–≤–∞—Ä —Å—Ç–≤–æ—Ä—é—î–º–æ?</h3>
                <div class="grid grid-cols-2 gap-6">
                    <button @click="selectType('simple')" class="flex flex-col items-center justify-center p-6 border-2 border-gray-100 rounded-xl hover:border-blue-500 hover:bg-blue-50 transition group">
                        <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-3xl mb-4 group-hover:scale-110 transition">‚òï</div>
                        <div class="font-bold text-lg text-gray-800">–ü—Ä–æ—Å—Ç–∏–π —Ç–æ–≤–∞—Ä</div>
                        <div class="text-sm text-gray-500 mt-2">–û–¥–Ω–∞ —Ü—ñ–Ω–∞, –æ–¥–∏–Ω —Ä–µ—Ü–µ–ø—Ç</div>
                    </button>

                    <button @click="selectType('variant')" class="flex flex-col items-center justify-center p-6 border-2 border-gray-100 rounded-xl hover:border-purple-500 hover:bg-purple-50 transition group">
                        <div class="w-16 h-16 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center text-3xl mb-4 group-hover:scale-110 transition">üé®</div>
                        <div class="font-bold text-lg text-gray-800">–ó –≤–∞—Ä—ñ–∞–Ω—Ç–∞–º–∏</div>
                        <div class="text-sm text-gray-500 mt-2">–†—ñ–∑–Ω—ñ –æ–±'—î–º–∏ –∞–±–æ –≤–∏–¥–∏</div>
                    </button>
                </div>
                <button @click="showTypeModal = false" class="mt-8 text-gray-400 hover:text-gray-600">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
            </div>
        </div>

        <div v-if="showForm" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
            <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto relative">
                
                <div class="flex justify-between items-center mb-6 border-b pb-4">
                    <h3 class="text-2xl font-bold text-gray-800">
                        {{ isEditing ? '–†–µ–¥–∞–≥—É–≤–∞—Ç–∏' : '–°—Ç–≤–æ—Ä–∏—Ç–∏' }} 
                        <span :class="productType === 'simple' ? 'text-blue-600' : 'text-purple-600'">
                            {{ productType === 'simple' ? '–ü—Ä–æ—Å—Ç–∏–π —Ç–æ–≤–∞—Ä' : '–¢–æ–≤–∞—Ä –∑ –≤–∞—Ä—ñ–∞–Ω—Ç–∞–º–∏' }}
                        </span>
                    </h3>
                    <button @click="closeForm" class="text-gray-400 hover:text-gray-600 text-2xl">√ó</button>
                </div>

                <div v-if="productType === 'simple'" class="space-y-6">
                    
                    <div class="grid grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">–ù–∞–∑–≤–∞ —Ç–æ–≤–∞—Ä—É <span class="text-red-500">*</span></label>
                            <input v-model="newProduct.name" class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500" placeholder="–ù–∞–ø—Ä. –ê–º–µ—Ä–∏–∫–∞–Ω–æ">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">–ö–∞—Ç–µ–≥–æ—Ä—ñ—è <span class="text-red-500">*</span></label>
                            <select v-model="newProduct.category_id" class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500">
                                <option :value="null">–û–±–µ—Ä—ñ—Ç—å –∫–∞—Ç–µ–≥–æ—Ä—ñ—é</option>
                                <option v-for="c in categories" :key="c.id" :value="c.id">{{ c.name }}</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">–¶—ñ–Ω–∞ –ø—Ä–æ–¥–∞–∂—É (–≥—Ä–Ω) <span class="text-red-500">*</span></label>
                            <input v-model.number="newProduct.price" type="number" step="0.01" class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 font-bold text-lg">
                        </div>
                        <div>
                             <label class="block text-sm font-medium text-gray-700 mb-1">–†–æ–∑—Ä–∞—Ö—É–Ω–∫–æ–≤–∞ —Å–æ–±—ñ–≤–∞—Ä—Ç—ñ—Å—Ç—å (Auto)</label>
                             <div class="w-full p-2 bg-gray-50 border rounded text-gray-500 font-mono font-bold flex items-center justify-between">
                                 <span>‚âà {{ serverCalculatedCost.toFixed(2) }} –≥—Ä–Ω</span>
                                 <span class="text-xs font-normal text-gray-400">–æ–Ω–æ–≤–ª–µ–Ω–æ —Å–µ—Ä–≤–µ—Ä–æ–º</span>
                             </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">–û–ø–∏—Å</label>
                        <textarea v-model="newProduct.description" class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500" rows="2"></textarea>
                    </div>

                    <div class="border-t my-4"></div>

                    <div class="bg-orange-50 p-4 rounded-xl border border-orange-100">
                        <h4 class="font-bold text-orange-800 mb-3 flex items-center gap-2">
                            <i class="fas fa-book-open"></i> –¢–µ—Ö–Ω–æ–ª–æ–≥—ñ—á–Ω–∞ –∫–∞—Ä—Ç–∞ (–†–µ—Ü–µ–ø—Ç)
                        </h4>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-orange-700 mb-1">–û–±–µ—Ä—ñ—Ç—å —Ä–µ—Ü–µ–ø—Ç</label>
                                <select v-model="newProduct.master_recipe_id" class="w-full border p-2 rounded focus:ring-2 focus:ring-orange-500 bg-white">
                                    <option :value="null">–ë–µ–∑ —Ä–µ—Ü–µ–ø—Ç—É</option>
                                    <option v-for="r in recipes" :key="r.id" :value="r.id">{{ r.name }}</option>
                                </select>
                            </div>

                            <div v-if="newProduct.master_recipe_id">
                                <label class="block text-xs font-bold text-orange-700 mb-1">–í–∞–≥–∞ –≤–∏—Ö–æ–¥—É (–≥—Ä–∞–º)</label>
                                <input v-model.number="newProduct.output_weight" type="number" step="0.1" 
                                       placeholder="–ù–∞–ø—Ä. 18"
                                       class="w-full border p-2 rounded focus:ring-2 focus:ring-orange-500 bg-white font-bold">
                                <p class="text-[10px] text-orange-600 mt-1">–ó–∞–≥–∞–ª—å–Ω–∞ –≤–∞–≥–∞ –ø—Ä–æ–¥—É–∫—Ç—É –¥–ª—è —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É –ø—Ä–æ–ø–æ—Ä—Ü—ñ–π</p>
                            </div>
                        </div>

                        <div v-if="newProduct.master_recipe_id && selectedRecipeBreakdown.items.length" class="mt-4 bg-white rounded-lg border border-orange-200 overflow-hidden">
                             <table class="w-full text-sm text-left">
                                 <thead class="bg-orange-100 text-orange-800 text-xs uppercase">
                                     <tr>
                                         <th class="p-2">–Ü–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç</th>
                                         <th class="p-2 text-center">–ü—Ä–æ–ø–æ—Ä—Ü—ñ—è</th>
                                         <th class="p-2 text-right">–í–∏—Ç—Ä–∞—Ç–∞</th>
                                         <th class="p-2 text-right">–í–∞—Ä—Ç—ñ—Å—Ç—å</th>
                                     </tr>
                                 </thead>
                                 <tbody class="divide-y divide-orange-50">
                                     <tr v-for="(item, idx) in selectedRecipeBreakdown.items" :key="idx">
                                         <td class="p-2 font-medium text-gray-700">{{ item.name }}</td>
                                         <td class="p-2 text-center text-gray-500 text-xs">{{ item.meta }}</td>
                                         <td class="p-2 text-right font-bold text-orange-700">
                                             {{ item.qty }} {{ item.unit }}
                                         </td>
                                         <td class="p-2 text-right text-xs font-mono text-gray-500">
                                             {{ item.cost }} –≥—Ä–Ω
                                         </td>
                                     </tr>
                                     <tr class="bg-orange-50 font-bold border-t border-orange-200">
                                         <td colspan="3" class="p-2 text-right text-orange-800">–†–∞–∑–æ–º –ø–æ —Ä–µ—Ü–µ–ø—Ç—É:</td>
                                         <td class="p-2 text-right text-orange-800">{{ selectedRecipeBreakdown.totalCost }} –≥—Ä–Ω</td>
                                     </tr>
                                 </tbody>
                             </table>
                        </div>
                    </div>

                    <div class="bg-green-50 p-4 rounded-xl border border-green-100">
                        <h4 class="font-bold text-green-800 mb-3 flex items-center gap-2">
                            <i class="fas fa-carrot"></i> –î–æ–¥–∞—Ç–∫–æ–≤—ñ —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∏
                        </h4>
                        <div class="flex gap-2 mb-2">
                             <select v-model="tempSimpleIngredient.id" class="flex-1 border p-2 rounded text-sm bg-white">
                                <option :value="null">–î–æ–¥–∞—Ç–∏ —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç...</option>
                                <option v-for="ing in ingredients" :key="ing.id" :value="ing.id">
                                    {{ ing.name }} ({{ ing.cost_per_unit }} –≥—Ä–Ω/{{ ing.unit?.symbol }})
                                </option>
                            </select>
                            <input v-model.number="tempSimpleIngredient.qty" type="number" placeholder="–ö-—Å—Ç—å" class="w-24 border p-2 rounded text-sm">
                            <button @click="addSimpleIngredient" class="bg-green-600 text-white px-3 rounded hover:bg-green-700 font-bold">+</button>
                        </div>
                        
                        <div v-if="newProduct.ingredients && newProduct.ingredients.length" class="space-y-1 mt-2">
                             <div v-for="(link, idx) in newProduct.ingredients" :key="idx" class="flex justify-between items-center bg-white p-2 rounded border border-green-200 text-sm">
                                 <span>
                                     {{ ingredients.find(i => i.id === link.ingredient_id)?.name }} ‚Äî 
                                     <b>{{ link.quantity }} {{ ingredients.find(i => i.id === link.ingredient_id)?.unit?.symbol }}</b>
                                     <span class="text-xs text-green-600 font-bold ml-2">
                                        ({{ getLinkCost(link.ingredient_id, link.quantity, ingredients) }} –≥—Ä–Ω)
                                     </span>
                                 </span>
                                 <button @click="removeSimpleIngredient(idx)" class="text-red-500 hover:text-red-700">√ó</button>
                             </div>
                        </div>
                    </div>

                    <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                         <h4 class="font-bold text-blue-800 mb-3 flex items-center gap-2">
                            <i class="fas fa-box-open"></i> –í–∏—Ç—Ä–∞—Ç–Ω—ñ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏
                        </h4>
                         <div class="flex gap-2 mb-2">
                             <select v-model="tempSimpleConsumable.id" class="flex-1 border p-2 rounded text-sm bg-white">
                                <option :value="null">–î–æ–¥–∞—Ç–∏ –º–∞—Ç–µ—Ä—ñ–∞–ª...</option>
                                <option v-for="c in consumables" :key="c.id" :value="c.id">
                                    {{ c.name }} ({{ c.cost_per_unit }} –≥—Ä–Ω)
                                </option>
                            </select>
                            <input v-model.number="tempSimpleConsumable.qty" type="number" placeholder="–ö-—Å—Ç—å" class="w-24 border p-2 rounded text-sm">
                            <button @click="addSimpleConsumable" class="bg-blue-600 text-white px-3 rounded hover:bg-blue-700 font-bold">+</button>
                        </div>

                        <div v-if="newProduct.consumables && newProduct.consumables.length" class="space-y-1 mt-2">
                             <div v-for="(link, idx) in newProduct.consumables" :key="idx" class="flex justify-between items-center bg-white p-2 rounded border border-blue-200 text-sm">
                                 <span>
                                     {{ consumables.find(c => c.id === link.consumable_id)?.name }} ‚Äî 
                                     <b>{{ link.quantity }} —à—Ç.</b>
                                     <span class="text-xs text-blue-600 font-bold ml-2">
                                        ({{ getLinkCost(link.consumable_id, link.quantity, consumables) }} –≥—Ä–Ω)
                                     </span>
                                 </span>
                                 <button @click="removeSimpleConsumable(idx)" class="text-red-500 hover:text-red-700">√ó</button>
                             </div>
                        </div>
                    </div>

                    <div class="flex items-center gap-2 mt-4 pt-4 border-t">
                        <input type="checkbox" v-model="newProduct.track_stock" id="trackStock" class="w-5 h-5 text-blue-600 rounded">
                        <label for="trackStock" class="text-gray-700 font-medium">–í–µ—Å—Ç–∏ –æ–±–ª—ñ–∫ –∑–∞–ª–∏—à–∫—ñ–≤ —Ü—å–æ–≥–æ —Ç–æ–≤–∞—Ä—É</label>
                    </div>
                    <div v-if="newProduct.track_stock" class="ml-7 mt-2">
                         <label class="text-sm text-gray-600">–ü–æ—á–∞—Ç–∫–æ–≤–∏–π –∑–∞–ª–∏—à–æ–∫:</label>
                         <input v-model.number="newProduct.stock_quantity" type="number" class="border p-1 rounded w-32 ml-2">
                    </div>
                </div>

                <div v-else-if="productType === 'variant'">
                    <div class="p-10 text-center text-gray-500 bg-gray-50 rounded-xl border-2 border-dashed">
                        <h3 class="text-xl font-bold mb-2">üöß –§–æ—Ä–º–∞ –¥–ª—è –≤–∞—Ä—ñ–∞–Ω—Ç—ñ–≤</h3>
                        <p>–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "–ó–±–µ—Ä–µ–≥—Ç–∏" –Ω–∞ –ø—Ä–æ—Å—Ç–æ–º—É —Ç–æ–≤–∞—Ä—ñ, —â–æ–± –ø—Ä–æ—Ç–µ—Å—Ç—É–≤–∞—Ç–∏. –í–∞—Ä—ñ–∞–Ω—Ç–∏ –¥–æ–¥–∞–º–æ –Ω–∞—Å—Ç—É–ø–Ω–∏–º –∫—Ä–æ–∫–æ–º.</p>
                        <button @click="productType = 'simple'" class="mt-4 text-blue-500 underline">–ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—å –¥–æ –ø—Ä–æ—Å—Ç–æ–≥–æ</button>
                    </div>
                </div>

                <div class="flex justify-end gap-3 mt-8 pt-4 border-t">
                    <button @click="closeForm" class="px-6 py-2 rounded-lg border hover:bg-gray-50 text-gray-700">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                    <button @click="handleSave" class="px-6 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700 shadow-lg font-bold">
                        {{ isEditing ? '–ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏' : '–°—Ç–≤–æ—Ä–∏—Ç–∏ —Ç–æ–≤–∞—Ä' }}
                    </button>
                </div>

            </div>
        </div>

        <div class="flex-1 bg-white rounded-xl shadow overflow-hidden flex flex-col">
             <div class="overflow-y-auto flex-1">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-gray-100 sticky top-0 z-10 text-xs uppercase text-gray-500 font-bold">
                        <tr>
                            <th class="p-4 border-b">–ù–∞–∑–≤–∞</th>
                            <th class="p-4 border-b">–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</th>
                            <th class="p-4 border-b">–¶—ñ–Ω–∞</th>
                            <th class="p-4 border-b">–°–∫–ª–∞–¥</th>
                            <th class="p-4 border-b text-center">–î—ñ—ó</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        <tr v-for="p in filteredProducts" :key="p.id" class="hover:bg-blue-50 transition group">
                            <td class="p-4">
                                <div class="font-bold text-gray-800 text-lg">{{ p.name }}</div>
                                <div class="text-xs text-gray-400 mt-1">{{ p.description }}</div>
                                <div v-if="p.has_variants" class="mt-1">
                                    <span class="bg-purple-100 text-purple-700 text-[10px] px-2 py-0.5 rounded-full font-bold">–í–∞—Ä—ñ–∞–Ω—Ç–∏: {{ p.variants.length }}</span>
                                </div>
                                <div v-if="!p.has_variants && p.ingredients?.length" class="mt-1 flex flex-wrap gap-1">
                                    <span v-for="ing in p.ingredients" :key="ing.ingredient_id" class="bg-green-50 text-green-700 text-[10px] px-1 rounded border border-green-100">
                                        {{ ing.ingredient_name }}: {{ ing.quantity }}
                                    </span>
                                </div>
                            </td>
                            <td class="p-4">
                                <span class="px-3 py-1 rounded-full text-xs font-bold bg-gray-100 text-gray-600 border">
                                    {{ getCategoryName(p.category_id) }}
                                </span>
                            </td>
                            <td class="p-4">
                                <div v-if="!p.has_variants" class="font-mono font-bold text-green-700">{{ p.price }} ‚Ç¥</div>
                                <div v-else class="text-xs text-gray-500 italic">–î–∏–≤. –≤–∞—Ä—ñ–∞–Ω—Ç–∏</div>
                            </td>
                            <td class="p-4">
                                <div v-if="!p.has_variants">
                                    <div v-if="p.track_stock" class="font-mono font-bold" :class="p.stock_quantity > 0 ? 'text-blue-600' : 'text-red-500'">
                                        {{ p.stock_quantity }} —à—Ç
                                    </div>
                                    <div v-else class="text-gray-400 text-xs">–ù–µ –æ–±–ª—ñ–∫–æ–≤—É—î—Ç—å—Å—è</div>
                                </div>
                            </td>
                            <td class="p-4 text-center">
                                <div class="flex justify-center gap-2 opacity-0 group-hover:opacity-100 transition">
                                    <button @click="handleEditWrapper(p)" class="text-blue-500 hover:bg-blue-100 p-2 rounded"><i class="fas fa-pen"></i></button>
                                    <button @click="deleteProduct(p.id)" class="text-red-500 hover:bg-red-100 p-2 rounded"><i class="fas fa-trash"></i></button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
             </div>
        </div>
    </div>
</template>

<style scoped>
.animate-fade-in { animation: fadeIn 0.2s ease-out; }
@keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
</style>
</file>

<file path="frontend\src\components\warehouse\tabs\RecipesTab.vue">
<script setup>
import { ref, computed } from 'vue'
import { useWarehouse } from '@/composables/useWarehouse'
import IngredientSelect from '@/components/common/IngredientSelect.vue' 

const { recipes, ingredients, fetchData, createItem, deleteItem } = useWarehouse()

const editingRecipeId = ref(null)
const newRecipe = ref({ name: '', description: '', items: [] })
const tempRecipeItem = ref({ ingredient_id: '', quantity: 0, is_percentage: false })

const getSelectedIngredientSymbol = computed(() => {
    if (!tempRecipeItem.value.ingredient_id) return ''
    const ing = ingredients.value.find(i => i.id === tempRecipeItem.value.ingredient_id)
    return ing ? ing.unit.symbol : ''
})

const editRecipe = (r) => {
    editingRecipeId.value = r.id
    newRecipe.value = {
        name: r.name,
        description: r.description,
        items: r.items.map(item => ({ 
            ingredient_id: item.ingredient_id, 
            quantity: item.quantity,
            is_percentage: item.is_percentage, 
            ingredient_name: item.ingredient_name 
        }))
    }
}

const resetRecipeForm = () => {
    editingRecipeId.value = null
    newRecipe.value = { name: '', description: '', items: [] }
    tempRecipeItem.value = { ingredient_id: '', quantity: 0, is_percentage: false }
}

const addIngredientToMaster = () => {
    if(!tempRecipeItem.value.ingredient_id || !tempRecipeItem.value.quantity) return
    const ing = ingredients.value.find(i => i.id === tempRecipeItem.value.ingredient_id)
    newRecipe.value.items.push({
        ingredient_id: tempRecipeItem.value.ingredient_id,
        quantity: tempRecipeItem.value.quantity,
        is_percentage: tempRecipeItem.value.is_percentage, 
        ingredient_name: ing ? ing.name : ''
    })
    tempRecipeItem.value = { ingredient_id: '', quantity: 0, is_percentage: false }
}

const removeIngredientFromMaster = (idx) => {
    newRecipe.value.items.splice(idx, 1)
}

const saveRecipe = async () => {
    if(!newRecipe.value.name) return alert("–í–∫–∞–∂—ñ—Ç—å –Ω–∞–∑–≤—É —Ä–µ—Ü–µ–ø—Ç—É")
    
    let url = '/api/recipes/'; 
    // createItem –≤ useWarehouse —Ä–æ–±–∏—Ç—å —Ç—ñ–ª—å–∫–∏ POST, —Ç–æ–º—É –¥–ª—è PUT –Ω–∞–º —Ç—Ä–µ–±–∞ –≤—Ä—É—á–Ω—É –∞–±–æ —Ä–æ–∑—à–∏—Ä–∏—Ç–∏ composable.
    // –¢—É—Ç –∑—Ä–æ–±–∏–º–æ —Ü–µ –ª–æ–∫–∞–ª—å–Ω–æ, –±–æ —Ü–µ —Å–ø–µ—Ü–∏—Ñ—ñ—á–Ω–∞ –ª–æ–≥—ñ–∫–∞
    if(editingRecipeId.value) {
        await fetch(`/api/recipes/${editingRecipeId.value}`, { 
            method: 'PUT', 
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(newRecipe.value) 
        })
        await fetchData()
    } else {
        await createItem(url, newRecipe.value)
    }
    
    alert("–†–µ—Ü–µ–ø—Ç –∑–±–µ—Ä–µ–∂–µ–Ω–æ!")
    resetRecipeForm()
}

const handleDelete = (id) => deleteItem(`/api/recipes/${id}`)
</script>

<template>
    <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
        <div class="xl:col-span-1 bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden h-fit">
            <div class="p-4 bg-gray-50 border-b font-bold text-gray-700">–í—Å—ñ —Ä–µ—Ü–µ–ø—Ç–∏</div>
            <div class="max-h-[600px] overflow-y-auto custom-scrollbar">
                <div v-for="r in recipes" :key="r.id" class="p-4 border-b hover:bg-orange-50 cursor-pointer flex justify-between items-center group">
                    <div @click="editRecipe(r)" class="flex-1">
                        <div class="font-bold text-gray-800">{{ r.name }}</div>
                        <div class="text-xs text-gray-400">{{ r.items.length }} —ñ–Ω–≥—Ä.</div>
                    </div>
                    <button @click="handleDelete(r.id)" class="text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition"><i class="fas fa-trash"></i></button>
                </div>
            </div>
            <button @click="resetRecipeForm" class="w-full py-3 text-center text-orange-600 font-bold hover:bg-orange-50 transition border-t">
                <i class="fas fa-plus-circle"></i> –°—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤–∏–π
            </button>
        </div>

        <div class="xl:col-span-2 bg-white rounded-2xl shadow-sm border border-orange-100 border-2 h-fit">
             <div class="p-6 border-b flex justify-between items-center bg-orange-50 rounded-t-xl">
                 <h3 class="font-bold text-xl text-orange-800">{{ editingRecipeId ? '–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è' : '–ù–æ–≤–∏–π —Ä–µ—Ü–µ–ø—Ç' }}</h3>
                 <button v-if="editingRecipeId" @click="resetRecipeForm" class="text-xs text-red-500 hover:underline">–ó–∞–∫—Ä–∏—Ç–∏</button>
             </div>
             
             <div class="p-6 space-y-4">
                 <input v-model="newRecipe.name" placeholder="–ù–∞–∑–≤–∞ —Ä–µ—Ü–µ–ø—Ç—É" class="w-full border p-2 rounded focus:ring-2 ring-orange-200 outline-none text-lg font-bold">
                 
                 <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                     <label class="block text-xs font-bold text-gray-400 uppercase mb-2">–°–∫–ª–∞–¥ —Ä–µ—Ü–µ–ø—Ç—É</label>
                     <div class="space-y-2 mb-4">
                         <div v-for="(item, idx) in newRecipe.items" :key="idx" class="flex items-center gap-3 bg-white p-2 rounded border shadow-sm">
                             <span class="flex-1 font-bold text-gray-700">{{ item.ingredient_name }}</span>
                             <span class="font-mono bg-gray-100 px-2 rounded" :class="item.is_percentage ? 'text-blue-600' : ''">
                                 {{ item.quantity }} {{ item.is_percentage ? '%' : '' }}
                             </span>
                             <button @click="removeIngredientFromMaster(idx)" class="text-red-400 hover:text-red-600"><i class="fas fa-times"></i></button>
                         </div>
                     </div>

                     <div class="flex gap-2 items-end border-t pt-3">
                         <div class="flex-1">
                             <label class="text-[10px] text-gray-400 font-bold uppercase">–Ü–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç</label>
                             <IngredientSelect v-model="tempRecipeItem.ingredient_id" :ingredients="ingredients" />
                         </div>
                         
                         <div class="flex flex-col">
                             <label class="text-[10px] text-gray-400 font-bold uppercase mb-1">–¢–∏–ø</label>
                             <div class="flex bg-white border rounded h-[38px] overflow-hidden">
                                 <button @click="tempRecipeItem.is_percentage=false" :class="!tempRecipeItem.is_percentage ? 'bg-gray-200 font-bold':''" class="px-2 text-xs border-r hover:bg-gray-100">FIX</button>
                                 <button @click="tempRecipeItem.is_percentage=true" :class="tempRecipeItem.is_percentage ? 'bg-blue-100 text-blue-700 font-bold':''" class="px-2 text-xs hover:bg-gray-100">%</button>
                             </div>
                         </div>

                         <div class="w-24">
                             <label class="text-[10px] text-gray-400 font-bold uppercase">–ö—ñ–ª—å–∫—ñ—Å—Ç—å</label>
                             <div class="relative">
                                 <input v-model="tempRecipeItem.quantity" type="number" step="0.001" class="w-full border p-2 rounded h-[38px] pr-8">
                                 <span class="absolute right-2 top-2 text-xs text-gray-400">
                                     {{ tempRecipeItem.is_percentage ? '%' : getSelectedIngredientSymbol }}
                                 </span>
                             </div>
                         </div>
                         <button @click="addIngredientToMaster" class="bg-orange-500 text-white w-10 h-[38px] rounded hover:bg-orange-600 transition"><i class="fas fa-plus"></i></button>
                     </div>
                 </div>

                 <button @click="saveRecipe" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold hover:bg-green-700 shadow-lg mt-2">–ó–±–µ—Ä–µ–≥—Ç–∏ —Ä–µ—Ü–µ–ø—Ç</button>
             </div>
        </div>
    </div>
</template>
</file>

<file path="frontend\src\components\warehouse\tabs\StockTab.vue">
<script setup>
import { ref, computed, onMounted } from 'vue'
import { useWarehouse } from '@/composables/useWarehouse'
import axios from 'axios'
import HistoryModal from '../modals/HistoryModal.vue'

// –û—Ç—Ä–∏–º—É—î–º–æ –¥–∞–Ω—ñ –∑—ñ —Å—Ö–æ–≤–∏—â–∞
const { ingredients, consumables, products, fetchWarehouseData } = useWarehouse()

const activeTab = ref('ingredients') 
const search = ref('')
const loading = ref(false)

// --- –ó–ú–Ü–ù–ù–Ü –î–õ–Ø –†–ï–î–ê–ì–£–í–ê–ù–ù–Ø ---
// –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –Ω–µ ID, –∞ —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π –∫–ª—é—á (–Ω–∞–ø—Ä. 'product_5')
const editingItemKey = ref(null) 
const editValue = ref(0)

// --- –ó–ú–Ü–ù–ù–Ü –î–õ–Ø –Ü–°–¢–û–†–Ü–á ---
const isHistoryOpen = ref(false)
const historyItem = ref(null)

// --- –§–£–ù–ö–¶–Ü–Ø –í–Ü–î–ö–†–ò–¢–¢–Ø –Ü–°–¢–û–†–Ü–á ---
const openHistory = (item) => {
    const realId = item.original_id || item.id
    console.log(`OPEN HISTORY: ${item.display_name} (Type: ${item.type}, ID: ${realId})`)

    historyItem.value = {
        id: realId,
        type: item.type,
        name: item.display_name
    }
    isHistoryOpen.value = true
}

// --- –ü–ª–æ—Å–∫–∏–π —Å–ø–∏—Å–æ–∫ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ñ ---
const filteredItems = computed(() => {
    let list = []

    // 1. –°–ò–†–û–í–ò–ù–ê
    if (activeTab.value === 'ingredients') {
        list = ingredients.value.map(i => ({ 
            ...i, 
            type: 'ingredient', 
            display_name: i.name,
            unit_symbol: i.unit?.symbol || '',
            // –ì–ï–ù–ï–†–£–Ñ–ú–û –£–ù–Ü–ö–ê–õ–¨–ù–ò–ô –ö–õ–Æ–ß
            unique_key: `ingredient_${i.id}` 
        }))
    } 
    // 2. –ú–ê–¢–ï–†–Ü–ê–õ–ò
    else if (activeTab.value === 'consumables') {
        list = consumables.value.map(c => ({ 
            ...c, 
            type: 'consumable', 
            display_name: c.name,
            unit_symbol: c.unit?.symbol || '',
            unique_key: `consumable_${c.id}`
        }))
    } 
    // 3. –¢–û–í–ê–†–ò (–†–æ–∑–≥–æ—Ä—Ç–∞—î–º–æ –≤–∞—Ä—ñ–∞–Ω—Ç–∏!)
    else if (activeTab.value === 'products') {
        products.value.forEach(p => {
            if (p.has_variants && p.variants) {
                // –í–∞—Ä—ñ–∞–Ω—Ç–∏
                p.variants.forEach(v => {
                    list.push({
                        id: v.id, 
                        original_id: v.id,
                        type: 'product_variant',
                        display_name: `${p.name} (${v.name})`, 
                        stock_quantity: v.stock_quantity,
                        unit_symbol: '—à—Ç',
                        product_id: p.id,
                        // –£–Ω—ñ–∫–∞–ª—å–Ω–∏–π –∫–ª—é—á –¥–ª—è –≤–∞—Ä—ñ–∞–Ω—Ç—É
                        unique_key: `product_variant_${v.id}`
                    })
                })
            } else {
                // –ü—Ä–æ—Å—Ç—ñ —Ç–æ–≤–∞—Ä–∏
                list.push({
                    id: p.id,
                    original_id: p.id,
                    type: 'product',
                    display_name: p.name,
                    stock_quantity: p.stock_quantity,
                    unit_symbol: '—à—Ç',
                    // –£–Ω—ñ–∫–∞–ª—å–Ω–∏–π –∫–ª—é—á –¥–ª—è –ø—Ä–æ–¥—É–∫—Ç—É
                    unique_key: `product_${p.id}`
                })
            }
        })
    }

    if (search.value) {
        const s = search.value.toLowerCase()
        return list.filter(i => i.display_name.toLowerCase().includes(s))
    }
    return list
})

// --- –õ–û–ì–Ü–ö–ê –†–ï–î–ê–ì–£–í–ê–ù–ù–Ø –ó–ê–õ–ò–®–ö–Ü–í ---
const startEdit = (item) => {
    // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π –∫–ª—é—á –∑–∞–º—ñ—Å—Ç—å –ø—Ä–æ—Å—Ç–æ–≥–æ ID
    editingItemKey.value = item.unique_key
    editValue.value = item.stock_quantity
}

const saveEdit = async (item) => {
    if (editValue.value < 0) return alert("–ù–µ –º–æ–∂–µ –±—É—Ç–∏ –º—ñ–Ω—É—Å–æ–≤–∏–º")
    
    loading.value = true
    try {
        let url = ''
        let payload = {}
        let method = 'put'
        
        const realId = item.original_id || item.id

        if (item.type === 'ingredient') {
            url = `/api/ingredients/${realId}`
            payload = { ...item, stock_quantity: editValue.value }
        } 
        else if (item.type === 'consumable') {
            url = `/api/consumables/${realId}`
            payload = { ...item, stock_quantity: editValue.value }
        }
        else if (item.type === 'product') {
            url = `/api/products/${realId}/stock?qty=${editValue.value}`
            method = 'patch'
            payload = {} 
        }
        else if (item.type === 'product_variant') {
            url = `/api/products/variants/${realId}/stock?qty=${editValue.value}`
            method = 'patch'
            payload = {}
        }

        if (method === 'put') {
            await axios.put(url, payload)
        } else {
            await axios.patch(url)
        }

        item.stock_quantity = editValue.value
        await fetchWarehouseData()
        editingItemKey.value = null // –ó–∞–∫—Ä–∏–≤–∞—î–º–æ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –∑–∞ –∫–ª—é—á–µ–º
    } catch (e) {
        console.error(e)
        alert("–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–∏—à–∫—É")
    } finally {
        loading.value = false
    }
}

onMounted(() => {
    fetchWarehouseData()
})
</script>

<template>
    <div class="h-full flex flex-col bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
        
        <div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center gap-4">
            <div class="flex p-1 bg-white rounded-xl border border-gray-200 shadow-sm">
                <button 
                    v-for="tab in ['ingredients', 'consumables', 'products']" 
                    :key="tab"
                    @click="activeTab = tab"
                    class="px-4 py-2 text-xs font-bold rounded-lg transition-all"
                    :class="activeTab === tab ? 'bg-blue-600 text-white shadow-md' : 'text-gray-500 hover:bg-gray-50'"
                >
                    {{ tab === 'ingredients' ? 'ü•¶ –°–∏—Ä–æ–≤–∏–Ω–∞' : (tab === 'consumables' ? 'üì¶ –ú–∞—Ç–µ—Ä—ñ–∞–ª–∏' : 'üçπ –¢–æ–≤–∞—Ä–∏') }}
                </button>
            </div>

            <input 
                v-model="search" 
                placeholder="–ü–æ—à—É–∫..." 
                class="border border-gray-200 rounded-xl px-3 py-2 text-sm outline-none focus:border-blue-500 w-64"
            >
        </div>

        <div class="flex-1 overflow-auto">
            <table class="w-full text-left text-sm">
                <thead class="bg-gray-50 text-gray-500 uppercase text-xs sticky top-0 z-10">
                    <tr>
                        <th class="p-4">–ù–∞–∑–≤–∞</th>
                        <th class="p-4 text-center">–¢–∏–ø</th>
                        <th class="p-4 text-right">–ó–∞–ª–∏—à–æ–∫</th>
                        <th class="p-4 text-center">–î—ñ—ó</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    <tr v-if="filteredItems.length === 0">
                        <td colspan="4" class="p-8 text-center text-gray-400">
                            –ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ...
                        </td>
                    </tr>
                    
                    <tr v-for="item in filteredItems" :key="item.unique_key" class="hover:bg-gray-50 group">
                        
                        <td class="p-4 font-bold text-gray-700">
                            {{ item.display_name }}
                        </td>

                        <td class="p-4 text-center">
                            <span v-if="item.type === 'ingredient'" class="bg-green-100 text-green-700 px-2 py-1 rounded text-[10px] font-bold">–°–∏—Ä–æ–≤–∏–Ω–∞</span>
                            <span v-else-if="item.type === 'consumable'" class="bg-teal-100 text-teal-700 px-2 py-1 rounded text-[10px] font-bold">–ú–∞—Ç–µ—Ä—ñ–∞–ª</span>
                            <span v-else-if="item.type === 'product'" class="bg-purple-100 text-purple-700 px-2 py-1 rounded text-[10px] font-bold">–¢–æ–≤–∞—Ä</span>
                            <span v-else-if="item.type === 'product_variant'" class="bg-indigo-100 text-indigo-700 px-2 py-1 rounded text-[10px] font-bold">–í–∞—Ä—ñ–∞–Ω—Ç</span>
                        </td>

                        <td class="p-4 text-right font-mono font-bold">
                            <div v-if="editingItemKey === item.unique_key" class="flex items-center justify-end gap-2">
                                <input 
                                    v-model.number="editValue" 
                                    type="number" 
                                    class="w-20 border rounded p-1 text-right focus:ring-2 ring-blue-500 outline-none"
                                >
                                <span class="text-xs text-gray-400">{{ item.unit_symbol }}</span>
                            </div>
                            <span v-else :class="{'text-red-500 bg-red-50 px-2 py-1 rounded': item.stock_quantity <= 0, 'text-gray-700': item.stock_quantity > 0}">
                                {{ item.stock_quantity }} {{ item.unit_symbol }}
                            </span>
                        </td>

                        <td class="p-4 text-center">
                            <div v-if="editingItemKey === item.unique_key" class="flex justify-center gap-1">
                                <button @click="saveEdit(item)" class="bg-green-500 text-white w-7 h-7 rounded hover:bg-green-600 flex items-center justify-center">
                                    <i class="fas fa-check text-xs"></i>
                                </button>
                                <button @click="editingItemKey = null" class="bg-gray-300 text-gray-700 w-7 h-7 rounded hover:bg-gray-400 flex items-center justify-center">
                                    <i class="fas fa-times text-xs"></i>
                                </button>
                            </div>
                            
                            <div v-else class="flex justify-center gap-2">
                                <button @click="openHistory(item)" class="text-purple-400 hover:text-purple-600 p-2 rounded hover:bg-purple-50 transition-colors" title="–Ü—Å—Ç–æ—Ä—ñ—è —Ä—É—Ö—É">
                                    <i class="fas fa-history"></i>
                                </button>
                                <button @click="startEdit(item)" class="text-blue-400 hover:text-blue-600 p-2 rounded hover:bg-blue-50 transition-colors" title="–ö–æ—Ä–µ–≥—É–≤–∞—Ç–∏ –∑–∞–ª–∏—à–æ–∫">
                                    <i class="fas fa-pen"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <HistoryModal 
            v-if="isHistoryOpen" 
            :is-open="isHistoryOpen" 
            :item="historyItem" 
            @close="isHistoryOpen = false" 
        />
    </div>
</template>
</file>

<file path="frontend\src\components\warehouse\tabs\UnitsTab.vue">
<script setup>
import { ref } from 'vue'
import { useWarehouse } from '@/composables/useWarehouse'

const { units, createItem } = useWarehouse()
const newUnit = ref({ name: '', symbol: '' })

const handleCreate = async () => {
    if (!newUnit.value.name || !newUnit.value.symbol) return alert("–ó–∞–ø–æ–≤–Ω—ñ—Ç—å!")
    const success = await createItem('/api/units/', newUnit.value)
    if(success) newUnit.value = { name: '', symbol: '' }
}
</script>

<template>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 h-fit">
            <h3 class="font-bold mb-4 text-gray-700">üìè –°—Ç–≤–æ—Ä–∏—Ç–∏ –æ–¥–∏–Ω–∏—Ü—é –≤–∏–º—ñ—Ä—É</h3>
            <div class="space-y-3">
                <input v-model="newUnit.name" placeholder="–ù–∞–∑–≤–∞ (–Ω–∞–ø—Ä. –ì—Ä–∞–º–∏)" class="border p-2 rounded w-full">
                <input v-model="newUnit.symbol" placeholder="–°–∏–º–≤–æ–ª (–Ω–∞–ø—Ä. –≥)" class="border p-2 rounded w-full">
                <button @click="handleCreate" class="bg-blue-600 hover:bg-blue-700 text-white w-full py-3 rounded-xl font-bold shadow-lg shadow-blue-200 transition">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
            </div>
        </div>
        <div class="bg-white rounded-2xl shadow-sm overflow-hidden border border-gray-100">
            <table class="w-full text-sm text-left">
                <thead class="bg-gray-50 text-gray-500 uppercase text-xs"><tr><th class="p-4">–ù–∞–∑–≤–∞</th><th class="p-4 text-right">–°–∏–º–≤–æ–ª</th></tr></thead>
                <tbody class="divide-y divide-gray-100">
                    <tr v-for="u in units" :key="u.id" class="hover:bg-gray-50">
                        <td class="p-4 font-bold text-gray-700">{{ u.name }}</td>
                        <td class="p-4 text-right font-mono">{{ u.symbol }}</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</template>
</file>

<file path="frontend\src\components\warehouse\tabs\products\ProductFormSimple.vue">
<script setup>
import { ref, watch, computed } from 'vue'
import { useWarehouse } from '@/composables/useWarehouse'
import { useProducts } from '@/composables/useProducts'
import IngredientSelect from '@/components/common/IngredientSelect.vue'

const props = defineProps({
    isOpen: Boolean,
    isEdit: Boolean
})

const emit = defineEmits(['close', 'saved'])

// –ü—ñ–¥–∫–ª—é—á–∞—î–º–æ –ª–æ–≥—ñ–∫—É
const { categories, recipes, ingredients, consumables } = useWarehouse()
const { 
    newProduct, 
    saveProduct, 
    removeProductConsumable
} = useProducts()

// –õ–æ–∫–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–Ω—ñ
const tempSimpleIngredient = ref({ id: null, qty: 0 })
const tempProductConsumable = ref({ consumable_id: "", quantity: 1 })
const serverCalculatedCost = ref(0)

// --- –û–ë–ß–ò–°–õ–Æ–í–ê–ù–Ü –í–õ–ê–°–¢–ò–í–û–°–¢–Ü ---
const selectedRecipe = computed(() => {
    if (!newProduct.value.master_recipe_id) return null
    return recipes.value.find(r => r.id === newProduct.value.master_recipe_id)
})

const getIngredientPrice = (id) => {
    const ing = ingredients.value.find(i => i.id === id)
    return ing ? ing.cost_per_unit : 0
}

const getConsumablePrice = (id) => {
    const cons = consumables.value.find(c => c.id === id)
    return cons ? cons.cost_per_unit : 0
}

// --- –ö–ê–õ–¨–ö–£–õ–Ø–¢–û–† ---
const calculateCost = async () => {
    const payload = {
        master_recipe_id: newProduct.value.master_recipe_id,
        output_weight: newProduct.value.output_weight || 0,
        ingredients: newProduct.value.ingredients || [],
        consumables: newProduct.value.consumables || []
    }
    try {
        const res = await fetch('/api/products/calculate-cost', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        })
        if(res.ok) {
            const data = await res.json()
            serverCalculatedCost.value = data.total_cost
        }
    } catch (e) { console.error("Cost calc error:", e) }
}

watch(() => [
    newProduct.value.master_recipe_id, 
    newProduct.value.output_weight,
    newProduct.value.ingredients, 
    newProduct.value.consumables
], () => {
    if (props.isOpen) calculateCost()
}, { deep: true })

// --- –ú–ï–¢–û–î–ò ---
const addSimpleIngredient = () => {
    if (tempSimpleIngredient.value.id && tempSimpleIngredient.value.qty > 0) {
        if (!newProduct.value.ingredients) newProduct.value.ingredients = []
        
        const existing = newProduct.value.ingredients.find(i => i.ingredient_id === tempSimpleIngredient.value.id)
        const ingObj = ingredients.value.find(i => i.id === tempSimpleIngredient.value.id)

        if (existing) {
            existing.quantity += parseFloat(tempSimpleIngredient.value.qty)
        } else {
            newProduct.value.ingredients.push({
                ingredient_id: tempSimpleIngredient.value.id,
                quantity: parseFloat(tempSimpleIngredient.value.qty),
                ingredient_name: ingObj?.name || '???'
            })
        }
        tempSimpleIngredient.value = { id: null, qty: 0 }
    }
}

const removeSimpleIngredient = (index) => {
    newProduct.value.ingredients.splice(index, 1)
}

const handleAddConsumable = () => {
    if (tempProductConsumable.value.consumable_id) {
        const c = consumables.value.find(x => x.id === tempProductConsumable.value.consumable_id)
        if (!newProduct.value.consumables) newProduct.value.consumables = []
        
        newProduct.value.consumables.push({
            consumable_id: tempProductConsumable.value.consumable_id,
            quantity: tempProductConsumable.value.quantity,
            name: c?.name || '???'
        })
        tempProductConsumable.value.quantity = 1
    }
}

const handleSave = async () => {
    newProduct.value.has_variants = false
    const success = await saveProduct()
    if (success) {
        emit('saved')
        emit('close')
    }
}
</script>

<template>
    <div v-if="isOpen" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl max-h-[95vh] flex flex-col overflow-hidden animate-fade-in">
            
            <div class="p-5 border-b flex justify-between items-center bg-gray-50">
                <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <span class="bg-blue-100 text-blue-600 p-2 rounded-lg text-lg">‚òï</span>
                    {{ isEdit ? '–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —Ç–æ–≤–∞—Ä—É' : '–ù–æ–≤–∏–π —Ç–æ–≤–∞—Ä' }}
                </h3>
                <button @click="$emit('close')" class="text-gray-400 hover:text-gray-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-200 transition">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>

            <div class="p-6 overflow-y-auto flex-1 space-y-6 bg-white">
                
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-100">
                    <h4 class="font-bold text-gray-700 mb-3 uppercase text-xs tracking-wider">–û—Å–Ω–æ–≤–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è</h4>
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-1">–ù–∞–∑–≤–∞ —Ç–æ–≤–∞—Ä—É <span class="text-red-500">*</span></label>
                                <input v-model="newProduct.name" type="text" class="w-full border rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500" placeholder="–ù–∞–∑–≤–∞ —Ç–æ–≤–∞—Ä—É">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-1">–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</label>
                                <select v-model="newProduct.category_id" class="w-full border rounded-lg p-2.5 bg-white">
                                    <option :value="null">-- –ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó --</option>
                                    <option v-for="c in categories" :key="c.id" :value="c.id">{{ c.name }}</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">–û–ø–∏—Å</label>
                            <input v-model="newProduct.description" type="text" class="w-full border rounded-lg p-2.5" placeholder="–î–æ–¥–∞—Ç–∫–æ–≤–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è...">
                        </div>
                    </div>
                </div>

                <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                    <h4 class="font-bold text-blue-800 mb-3 uppercase text-xs tracking-wider">–§—ñ–Ω–∞–Ω—Å–∏</h4>
    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
        
                        <div>
                            <label class="block text-xs font-bold text-blue-900 mb-1 uppercase">–¶—ñ–Ω–∞ –ø—Ä–æ–¥–∞–∂—É</label>
                            <div class="relative">
                                <input 
                                    v-model.number="newProduct.price" 
                                    type="number" 
                                    step="0.1" 
                                    class="w-full border-2 border-blue-200 rounded-lg p-2 pl-3 text-lg font-bold text-gray-800 focus:ring-2 focus:ring-blue-500 shadow-sm transition h-[46px]"
                                >
                                <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 font-medium">‚Ç¥</span>
                            </div>
                        </div>
        
                        <div class="bg-white border border-blue-100 rounded-lg px-3 shadow-sm h-[46px] flex flex-col justify-center">
                            <div class="flex justify-between items-center w-full">
                                <span class="text-[10px] text-gray-500 uppercase font-bold tracking-wider">–°–æ–±—ñ–≤–∞—Ä—Ç—ñ—Å—Ç—å</span>
                                <span class="font-medium text-gray-700">{{ serverCalculatedCost.toFixed(2) }} ‚Ç¥</span>
                            </div>
                        </div>

                        <div class="bg-white border border-blue-100 rounded-lg px-3 shadow-sm h-[46px] flex flex-col justify-center">
                            <div class="flex justify-between items-center w-full">
                                <span class="text-[10px] text-gray-500 uppercase font-bold tracking-wider">–ú–∞—Ä–∂–∞</span>
                                <div class="font-bold text-sm" :class="newProduct.price > serverCalculatedCost ? 'text-green-600' : 'text-red-500'">
                                    {{ newProduct.price > 0 ? (newProduct.price - serverCalculatedCost).toFixed(2) : 0 }} ‚Ç¥ 
                                    <span class="text-xs text-gray-400 font-normal ml-1">
                                        ({{ newProduct.price > 0 ? Math.round(((newProduct.price - serverCalculatedCost) / newProduct.price) * 100) : 0 }}%)
                                    </span>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                    <h4 class="font-bold text-gray-700 mb-3 uppercase text-xs tracking-wider">–°–∫–ª–∞–¥—Å—å–∫–∏–π –æ–±–ª—ñ–∫</h4>
                    
                    <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4">
                        <label class="flex items-center gap-3 cursor-pointer p-2 hover:bg-gray-50 rounded-lg transition border border-transparent hover:border-gray-200">
                            <input v-model="newProduct.track_stock" type="checkbox" class="w-5 h-5 rounded text-blue-600 focus:ring-blue-500">
                            <span class="font-medium text-gray-700">–í–µ—Å—Ç–∏ –æ–±–ª—ñ–∫ –∑–∞–ª–∏—à–∫—ñ–≤ –≥–æ—Ç–æ–≤–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç—É</span>
                        </label>
                        
                        <div v-if="newProduct.track_stock" class="flex-1 w-full sm:w-auto animate-fade-in">
                            <label class="text-xs uppercase font-bold text-gray-500 block mb-1">–ü–æ—Ç–æ—á–Ω–∏–π –∑–∞–ª–∏—à–æ–∫</label>
                            <div class="flex items-center">
                                <input v-model.number="newProduct.stock_quantity" type="number" class="w-full max-w-xs border rounded-l-lg p-2 focus:ring-2 focus:ring-blue-500">
                                <span class="bg-gray-100 px-4 py-2 border border-l-0 rounded-r-lg text-gray-600 font-medium">—à—Ç</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-orange-50 p-4 rounded-lg border border-orange-100 shadow-sm">
                    <h4 class="font-bold text-orange-800 mb-4 flex items-center gap-2 uppercase text-xs tracking-wider">
                        <i class="fas fa-book-open"></i> –¢–µ—Ö–Ω—ñ—á–Ω–∞ –∫–∞—Ä—Ç–∞ (–†–µ—Ü–µ–ø—Ç)
                    </h4>
                    
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-4 mb-4">
                        <div class="md:col-span-8">
                            <label class="block text-sm text-orange-900 mb-1 font-medium">–û–±–µ—Ä—ñ—Ç—å —Ä–µ—Ü–µ–ø—Ç</label>
                            <select v-model="newProduct.master_recipe_id" class="w-full border border-orange-200 rounded-lg p-2.5 text-sm bg-white focus:ring-2 focus:ring-orange-400">
                                <option :value="null">-- –ë–µ–∑ —Ä–µ—Ü–µ–ø—Ç—É --</option>
                                <option v-for="r in recipes" :key="r.id" :value="r.id">{{ r.name }}</option>
                            </select>
                        </div>
                        <div class="md:col-span-4">
                            <label class="block text-sm text-orange-900 mb-1 font-medium">–í–∞–≥–∞ –≤–∏—Ö–æ–¥—É</label>
                            <div class="flex items-center">
                                <input v-model.number="newProduct.output_weight" type="number" class="w-full border border-orange-200 rounded-l-lg p-2.5 text-sm" placeholder="250">
                                <span class="bg-orange-100 px-3 py-2.5 border border-orange-200 border-l-0 rounded-r-lg text-orange-700 text-xs font-bold">–º–ª/–≥</span>
                            </div>
                        </div>
                    </div>

                    <div v-if="selectedRecipe" class="bg-white rounded-lg border border-orange-200 overflow-hidden">
                        <div class="bg-orange-100 px-4 py-2 border-b border-orange-200 flex justify-between items-center">
                            <h5 class="font-bold text-orange-900 text-sm">–°–∫–ª–∞–¥ —Ç–µ—Ö–∫–∞—Ä—Ç–∏: {{ selectedRecipe.name }}</h5>
                        </div>
                        <table class="w-full text-sm text-left">
                            <thead class="bg-orange-50 text-orange-800 font-medium border-b border-orange-100">
                                <tr>
                                    <th class="p-3 pl-4">–Ü–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç</th>
                                    <th class="p-3">–í —Ä–µ—Ü–µ–ø—Ç—ñ</th>
                                    <th class="p-3">–í–∏—Ç—Ä–∞—Ç–∞</th>
                                    <th class="p-3 text-right pr-4">–í–∞—Ä—Ç—ñ—Å—Ç—å</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-orange-50">
                                <tr v-for="item in selectedRecipe.items" :key="item.id">
                                    <td class="p-3 pl-4 text-gray-700">{{ item.ingredient_name }}</td>
                                    <td class="p-3 text-gray-500 text-xs">
                                        {{ item.quantity }} {{ item.is_percentage ? '%' : (item.unit_name || '–æ–¥') }}
                                    </td>
                                    <td class="p-3 font-medium text-gray-800">
                                        {{ item.is_percentage 
                                            ? ((item.quantity / 100) * (newProduct.output_weight || 0)).toFixed(1) 
                                            : item.quantity 
                                        }} {{ item.is_percentage ? '–º–ª/–≥' : (item.unit_name || '–æ–¥') }}
                                    </td>
                                    <td class="p-3 text-right pr-4 text-gray-600 font-mono">
                                        {{ ((item.is_percentage 
                                                ? ((item.quantity / 100) * (newProduct.output_weight || 0)) 
                                                : item.quantity
                                            ) * getIngredientPrice(item.ingredient_id)).toFixed(2) 
                                        }} ‚Ç¥
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                    <h4 class="font-bold text-gray-800 mb-3 border-b pb-2 flex items-center gap-2">
                        <i class="fas fa-lemon text-yellow-500"></i> –î–æ–¥–∞—Ç–∫–æ–≤—ñ —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∏
                    </h4>
                    
                    <div class="flex gap-2 mb-4 bg-gray-50 p-2 rounded-lg">
                        <IngredientSelect 
                            v-model="tempSimpleIngredient.id" 
                            :ingredients="ingredients" 
                            class="flex-1" 
                        />
                        <input v-model.number="tempSimpleIngredient.qty" type="number" step="0.001" placeholder="–ö-—Å—Ç—å" class="w-24 border rounded p-2 text-sm focus:ring-2 focus:ring-yellow-400">
                        <button @click="addSimpleIngredient" class="bg-yellow-500 text-white px-4 rounded hover:bg-yellow-600 font-medium shadow-sm transition">
                            <i class="fas fa-plus"></i> –î–æ–¥–∞—Ç–∏
                        </button>
                    </div>

                    <div v-if="newProduct.ingredients?.length" class="border rounded-lg overflow-hidden">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-100 text-gray-600 text-left text-xs uppercase tracking-wider">
                                <tr>
                                    <th class="p-3 pl-4">–ù–∞–∑–≤–∞</th>
                                    <th class="p-3">–ö-—Å—Ç—å</th>
                                    <th class="p-3 text-right">–í–∞—Ä—Ç—ñ—Å—Ç—å</th>
                                    <th class="p-3 w-10"></th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                <tr v-for="(ing, idx) in newProduct.ingredients" :key="idx" class="hover:bg-gray-50">
                                    <td class="p-3 pl-4 font-medium">{{ ing.ingredient_name }}</td>
                                    <td class="p-3 text-gray-600">{{ ing.quantity }}</td>
                                    <td class="p-3 text-right font-mono text-gray-700">
                                        {{ (ing.quantity * getIngredientPrice(ing.ingredient_id)).toFixed(2) }} ‚Ç¥
                                    </td>
                                    <td class="p-3 text-center">
                                        <button @click="removeSimpleIngredient(idx)" class="text-red-400 hover:text-red-600 hover:bg-red-50 p-1 rounded transition">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div v-else class="text-sm text-gray-400 italic text-center py-4 bg-gray-50 rounded-lg border border-dashed border-gray-200">
                        –ù–µ–º–∞—î –¥–æ–¥–∞—Ç–∫–æ–≤–∏—Ö —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç—ñ–≤
                    </div>
                </div>

                <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                    <h4 class="font-bold text-gray-800 mb-3 border-b pb-2 flex items-center gap-2">
                        <i class="fas fa-box-open text-blue-500"></i> –í–∏—Ç—Ä–∞—Ç–Ω—ñ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏
                    </h4>

                    <div class="flex gap-2 mb-4 bg-gray-50 p-2 rounded-lg">
                        <select v-model="tempProductConsumable.consumable_id" class="flex-1 border rounded p-2 text-sm bg-white focus:ring-2 focus:ring-blue-400">
                            <option value="">–û–±–µ—Ä—ñ—Ç—å –º–∞—Ç–µ—Ä—ñ–∞–ª...</option>
                            <option v-for="c in consumables" :key="c.id" :value="c.id">{{ c.name }}</option>
                        </select>
                        <input v-model.number="tempProductConsumable.quantity" type="number" placeholder="–®—Ç" class="w-24 border rounded p-2 text-sm focus:ring-2 focus:ring-blue-400">
                        <button @click="handleAddConsumable" class="bg-blue-500 text-white px-4 rounded hover:bg-blue-600 font-medium shadow-sm transition">
                            <i class="fas fa-plus"></i> –î–æ–¥–∞—Ç–∏
                        </button>
                    </div>

                    <div v-if="newProduct.consumables?.length" class="border rounded-lg overflow-hidden">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-100 text-gray-600 text-left text-xs uppercase tracking-wider">
                                <tr>
                                    <th class="p-3 pl-4">–ù–∞–∑–≤–∞</th>
                                    <th class="p-3">–ö-—Å—Ç—å</th>
                                    <th class="p-3 text-right">–í–∞—Ä—Ç—ñ—Å—Ç—å</th>
                                    <th class="p-3 w-10"></th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                <tr v-for="(c, idx) in newProduct.consumables" :key="idx" class="hover:bg-gray-50">
                                    <td class="p-3 pl-4 font-medium">{{ c.name || c.consumable_name }}</td>
                                    <td class="p-3 text-gray-600">{{ c.quantity }} —à—Ç</td>
                                    <td class="p-3 text-right font-mono text-gray-700">
                                        {{ (c.quantity * getConsumablePrice(c.consumable_id)).toFixed(2) }} ‚Ç¥
                                    </td>
                                    <td class="p-3 text-center">
                                        <button @click="removeProductConsumable(idx)" class="text-red-400 hover:text-red-600 hover:bg-red-50 p-1 rounded transition">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div v-else class="text-sm text-gray-400 italic text-center py-4 bg-gray-50 rounded-lg border border-dashed border-gray-200">
                        –ù–µ–º–∞—î –≤–∏—Ç—Ä–∞—Ç–Ω–∏—Ö –º–∞—Ç–µ—Ä—ñ–∞–ª—ñ–≤
                    </div>
                </div>

            </div>

            <div class="p-5 border-t bg-gray-50 flex justify-end gap-3">
                <button @click="$emit('close')" class="px-5 py-2.5 border border-gray-300 rounded-lg text-gray-700 hover:bg-white transition font-medium">
                    –°–∫–∞—Å—É–≤–∞—Ç–∏
                </button>
                <button @click="handleSave" class="px-6 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-md transition font-medium flex items-center gap-2">
                    <i class="fas fa-check"></i> {{ isEdit ? '–ó–±–µ—Ä–µ–≥—Ç–∏' : '–°—Ç–≤–æ—Ä–∏—Ç–∏' }}
                </button>
            </div>
        </div>
    </div>
</template>

<style scoped>
.animate-fade-in { animation: fadeIn 0.2s ease-out; }
@keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
</style>
</file>

<file path="frontend\src\components\warehouse\tabs\products\ProductFormVariant.vue">
<script setup>
import { ref, watch, computed, nextTick } from 'vue'
import { useWarehouse } from '@/composables/useWarehouse'
import { useProducts } from '@/composables/useProducts'
// import IngredientSelect from '@/components/common/IngredientSelect.vue' // –Ø–∫—â–æ —î –∫–æ–º–ø–æ–Ω–µ–Ω—Ç, –º–æ–∂–Ω–∞ —Ä–æ–∑–∫–æ–º–µ–Ω—Ç—É–≤–∞—Ç–∏

const props = defineProps({
    isOpen: Boolean,
    isEdit: Boolean
})

const emit = defineEmits(['close', 'saved'])

// –ü—ñ–¥–∫–ª—é—á–∞—î–º–æ –≥–ª–æ–±–∞–ª—å–Ω—ñ –¥–æ–≤—ñ–¥–Ω–∏–∫–∏
const { categories, recipes, ingredients, consumables, processGroups } = useWarehouse()

// –ü—ñ–¥–∫–ª—é—á–∞—î–º–æ –ª–æ–≥—ñ–∫—É —Ä–æ–±–æ—Ç–∏ –∑ —Ç–æ–≤–∞—Ä–æ–º
const { 
    newProduct, 
    saveProduct,
    // –ú–µ—Ç–æ–¥–∏ –¥–ª—è –≤–∞—Ä—ñ–∞–Ω—Ç—ñ–≤
    saveVariant, editVariant, cancelVariantEdit, removeVariant,
    variantBuilder, editingVariantIndex,
    // –ú–µ—Ç–æ–¥–∏ –¥–ª—è —É–Ω—ñ–∫–∞–ª—å–Ω–∏—Ö —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç—ñ–≤ –≤–∞—Ä—ñ–∞–Ω—Ç—É
    addIngredientToVariant, removeIngredientFromVariant,
    // –ú–µ—Ç–æ–¥–∏ –¥–ª—è —É–Ω—ñ–∫–∞–ª—å–Ω–∏—Ö –º–∞—Ç–µ—Ä—ñ–∞–ª—ñ–≤ –≤–∞—Ä—ñ–∞–Ω—Ç—É
    addVariantConsumable, removeVariantConsumable,
    tempVariantConsumable, tempVariantIngredient,
    // –ú–µ—Ç–æ–¥–∏ –¥–ª—è —Å–ø—ñ–ª—å–Ω–∏—Ö –º–∞—Ç–µ—Ä—ñ–∞–ª—ñ–≤
    removeProductConsumable, addProductConsumable, tempProductConsumable
} = useProducts()

// --- –õ–û–ö–ê–õ–¨–ù–ò–ô –°–¢–ê–ù ---
const activeTab = ref('general')
const showVariantForm = ref(false)

// –¢–∏–º—á–∞—Å–æ–≤–∞ –∑–º—ñ–Ω–Ω–∞ –¥–ª—è –°–ø—ñ–ª—å–Ω–∏—Ö –Ü–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç—ñ–≤ (–ª–æ–∫–∞–ª—å–Ω–æ, —â–æ–± –Ω–µ –ª–∞–º–∞—Ç–∏ useProducts)
const tempCommonIngredient = ref({ ingredient_id: "", quantity: 0 })

// --- –ú–ï–¢–û–î–ò –î–õ–Ø –°–ü–Ü–õ–¨–ù–ò–• –Ü–ù–ì–†–ï–î–Ü–Ñ–ù–¢–Ü–í ---
const addCommonIngredient = () => {
    if(!tempCommonIngredient.value.ingredient_id) return
    const ing = ingredients.value.find(x => x.id === tempCommonIngredient.value.ingredient_id)
    
    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —ñ—Å–Ω—É—î –º–∞—Å–∏–≤ (–Ω–∞ –≤–∏–ø–∞–¥–æ–∫ –∑–±–æ—é —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó)
    if (!newProduct.value.ingredients) newProduct.value.ingredients = []

    newProduct.value.ingredients.push({ 
        ingredient_id: tempCommonIngredient.value.ingredient_id,
        quantity: tempCommonIngredient.value.quantity,
        name: ing?.name || '???' 
    })
    
    // –°–∫–∏–¥–∞—î–º–æ
    tempCommonIngredient.value = { ingredient_id: "", quantity: 0 }
}

const removeCommonIngredient = (index) => {
    newProduct.value.ingredients.splice(index, 1)
}

// --- –ú–ï–¢–û–î–ò –í–ê–†–Ü–ê–ù–¢–Ü–í ---
const openAddVariant = () => {
    cancelVariantEdit()
    showVariantForm.value = true
}

const handleEditVariant = (idx) => {
    editVariant(idx)
    showVariantForm.value = true
}

const closeVariantForm = () => {
    cancelVariantEdit()
    showVariantForm.value = false
}

const handleSaveVariant = () => {
    saveVariant()
    showVariantForm.value = false
}

const handleSaveProduct = async () => {
    const success = await saveProduct()
    if(success) emit('saved')
}

const toggleProcessGroup = (id) => {
    const index = newProduct.value.process_group_ids.indexOf(id)
    if (index === -1) {
        newProduct.value.process_group_ids.push(id)
    } else {
        newProduct.value.process_group_ids.splice(index, 1)
    }
}
</script>

<template>
    <div v-if="isOpen" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm p-4 overflow-y-auto">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-5xl h-[90vh] flex flex-col animate-fade-in relative">
            
            <div class="px-8 py-5 border-b flex justify-between items-center bg-gray-50 rounded-t-2xl">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">
                        {{ isEdit ? '–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —Ç–æ–≤–∞—Ä—É' : '–ù–æ–≤–∏–π —Ç–æ–≤–∞—Ä' }} (–∑ –≤–∞—Ä—ñ–∞–Ω—Ç–∞–º–∏)
                    </h2>
                    <p class="text-sm text-gray-500 mt-1">–ù–∞–ª–∞—à—Ç—É–π—Ç–µ –∑–∞–≥–∞–ª—å–Ω—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ —Ç–∞ –≤–∞—Ä—ñ–∞–Ω—Ç–∏</p>
                </div>
                <button @click="emit('close')" class="w-10 h-10 rounded-full bg-white hover:bg-gray-100 flex items-center justify-center transition shadow-sm border text-gray-500">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>

            <div class="flex flex-1 overflow-hidden">
                
                <div class="w-64 bg-gray-50 border-r flex flex-col p-4 space-y-2">
                    <button 
                        v-for="tab in [
                            { id: 'general', label: '–û—Å–Ω–æ–≤–Ω–µ', icon: 'fas fa-info-circle' },
                            { id: 'variants', label: '–í–∞—Ä—ñ–∞–Ω—Ç–∏ & –¶—ñ–Ω–∏', icon: 'fas fa-layer-group' },
                            { id: 'ingredients', label: '–°–ø—ñ–ª—å–Ω—ñ —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∏', icon: 'fas fa-carrot' },
                            { id: 'consumables', label: '–°–ø—ñ–ª—å–Ω—ñ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏', icon: 'fas fa-box-open' },
                        ]" 
                        :key="tab.id"
                        @click="activeTab = tab.id"
                        class="flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium transition-all duration-200 text-left"
                        :class="activeTab === tab.id ? 'bg-white shadow-md text-purple-700 font-bold' : 'text-gray-600 hover:bg-gray-100 hover:text-gray-900'"
                    >
                        <i :class="tab.icon" class="text-lg w-6 text-center"></i>
                        {{ tab.label }}
                    </button>
                </div>

                <div class="flex-1 overflow-y-auto p-8 relative">
                    
                    <div v-if="activeTab === 'general'" class="max-w-2xl mx-auto space-y-6 animate-slide-up">
                        
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">–ù–∞–∑–≤–∞ —Ç–æ–≤–∞—Ä—É <span class="text-red-500">*</span></label>
                            <input 
                                v-model="newProduct.name" 
                                type="text" 
                                placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –ö–∞–≤–∞ –õ–∞—Ç–µ" 
                                class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none transition text-lg"
                            >
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">–ö–∞—Ç–µ–≥–æ—Ä—ñ—è <span class="text-red-500">*</span></label>
                            <div class="relative">
                                <select 
                                    v-model="newProduct.category_id" 
                                    class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-purple-500 outline-none appearance-none bg-white cursor-pointer"
                                >
                                    <option :value="null" disabled>–û–±–µ—Ä—ñ—Ç—å –∫–∞—Ç–µ–≥–æ—Ä—ñ—é...</option>
                                    <option v-for="cat in categories" :key="cat.id" :value="cat.id">
                                        {{ cat.name }}
                                    </option>
                                </select>
                                <i class="fas fa-chevron-down absolute right-4 top-3.5 text-gray-400 pointer-events-none"></i>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-3">–ì—Ä—É–ø–∏ –ø—Ä–æ—Ü–µ—Å—ñ–≤ (–¥–µ –≥–æ—Ç—É—î—Ç—å—Å—è)</label>
                            <div class="grid grid-cols-2 gap-3">
                                <div 
                                    v-for="group in processGroups" 
                                    :key="group.id"
                                    @click="toggleProcessGroup(group.id)"
                                    class="border rounded-xl p-3 cursor-pointer flex items-center justify-between transition-all select-none"
                                    :class="newProduct.process_group_ids.includes(group.id) ? 'bg-purple-50 border-purple-500 shadow-sm' : 'hover:border-gray-400 bg-white'"
                                >
                                    <span class="text-sm font-medium" :class="newProduct.process_group_ids.includes(group.id) ? 'text-purple-700' : 'text-gray-700'">
                                        {{ group.name }}
                                    </span>
                                    <div 
                                        class="w-5 h-5 rounded-full border flex items-center justify-center transition-colors"
                                        :class="newProduct.process_group_ids.includes(group.id) ? 'bg-purple-600 border-purple-600' : 'border-gray-300'"
                                    >
                                        <i v-if="newProduct.process_group_ids.includes(group.id)" class="fas fa-check text-white text-xs"></i>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-xl flex items-start gap-3">
                            <input 
                                id="manual-track-stock"
                                type="checkbox" 
                                v-model="newProduct.track_stock"
                                class="mt-1 w-5 h-5 text-purple-600 rounded border-gray-300 focus:ring-purple-500 cursor-pointer"
                            >
                            <div>
                                <label for="manual-track-stock" class="block font-bold text-gray-800 cursor-pointer select-none">
                                    –í–µ—Å—Ç–∏ –∑–∞–≥–∞–ª—å–Ω–∏–π –æ–±–ª—ñ–∫ –∑–∞–ª–∏—à–∫—ñ–≤ (Track Stock)
                                </label>
                                <p class="text-xs text-gray-600 mt-1">
                                    –£–≤—ñ–º–∫–Ω—ñ—Ç—å —Ü–µ, —è–∫—â–æ —Ö–æ—á–µ—Ç–µ –±—É—Ç–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Å–ø–∏—Å–∞–Ω–Ω—è –ø—Ä–∞—Ü—é–≤–∞—Ç–∏–º–µ –≥–ª–æ–±–∞–ª—å–Ω–æ.
                                    (–ó–∞–∑–≤–∏—á–∞–π –¥–ª—è —Ç–æ–≤–∞—Ä—ñ–≤ –∑ –≤–∞—Ä—ñ–∞–Ω—Ç–∞–º–∏ —Ü–µ –≤–∏–º–∫–Ω–µ–Ω–æ, –∞–ª–µ –≤–∏ –º–æ–∂–µ—Ç–µ —É–≤—ñ–º–∫–Ω—É—Ç–∏ –≤—Ä—É—á–Ω—É).
                                </p>
                            </div>
                        </div>
                    </div>

                    <div v-if="activeTab === 'variants'" class="space-y-6 animate-slide-up">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-gray-800 text-lg">–°–ø–∏—Å–æ–∫ –≤–∞—Ä—ñ–∞–Ω—Ç—ñ–≤</h3>
                            <button @click="openAddVariant" class="bg-gray-900 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-gray-800 transition shadow-lg flex items-center gap-2">
                                <i class="fas fa-plus"></i> –î–æ–¥–∞—Ç–∏ –≤–∞—Ä—ñ–∞–Ω—Ç
                            </button>
                        </div>

                        <div v-if="newProduct.variants.length === 0" class="text-center py-12 bg-gray-50 rounded-2xl border border-dashed border-gray-300">
                            <i class="fas fa-layer-group text-4xl text-gray-300 mb-3"></i>
                            <p class="text-gray-500">–í–∞—Ä—ñ–∞–Ω—Ç—ñ–≤ —â–µ –Ω–µ–º–∞—î. –î–æ–¥–∞–π—Ç–µ –ø–µ—Ä—à–∏–π!</p>
                        </div>

                        <div v-else class="grid gap-3">
                            <div 
                                v-for="(variant, idx) in newProduct.variants" 
                                :key="idx"
                                class="bg-white border rounded-xl p-4 flex justify-between items-center hover:shadow-md transition group"
                            >
                                <div>
                                    <h4 class="font-bold text-gray-800">{{ variant.name }}</h4>
                                    <div class="flex items-center gap-3 text-sm text-gray-500 mt-1">
                                        <span class="bg-green-100 text-green-700 px-2 py-0.5 rounded text-xs font-bold">{{ variant.price }} ‚Ç¥</span>
                                        <span v-if="variant.sku" class="bg-gray-100 px-2 py-0.5 rounded text-xs">SKU: {{ variant.sku }}</span>
                                        <span v-if="variant.stock_quantity" class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded text-xs">–ó–∞–ª–∏—à–æ–∫: {{ variant.stock_quantity }}</span>
                                    </div>
                                </div>
                                <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button @click="handleEditVariant(idx)" class="w-8 h-8 rounded bg-blue-50 text-blue-600 hover:bg-blue-100 flex items-center justify-center">
                                        <i class="fas fa-pencil-alt text-sm"></i>
                                    </button>
                                    <button @click="removeVariant(idx)" class="w-8 h-8 rounded bg-red-50 text-red-500 hover:bg-red-100 flex items-center justify-center">
                                        <i class="fas fa-trash text-sm"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div v-if="activeTab === 'ingredients'" class="max-w-3xl mx-auto animate-slide-up">
                        <div class="bg-orange-50 border border-orange-100 rounded-xl p-4 mb-6">
                            <div class="flex gap-3">
                                <i class="fas fa-info-circle text-orange-500 mt-0.5"></i>
                                <p class="text-sm text-orange-700">
                                    –Ü–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∏, —è–∫—ñ –¥–æ–¥–∞—é—Ç—å—Å—è –¥–æ <strong>–∫–æ–∂–Ω–æ–≥–æ</strong> –≤–∞—Ä—ñ–∞–Ω—Ç—É (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: –≤–æ–¥–∞ –¥–ª—è –∫–∞–≤–∏, —è–∫—â–æ –≤–æ–Ω–∞ –æ–¥–Ω–∞–∫–æ–≤–∞ –¥–ª—è –≤—Å—ñ—Ö –æ–±'—î–º—ñ–≤, –∞–±–æ –±–∞–∑–∞).
                                </p>
                            </div>
                        </div>

                        <div class="flex gap-2 items-end mb-4 bg-white p-4 rounded-xl border shadow-sm">
                            <div class="flex-1">
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">–û–±–µ—Ä—ñ—Ç—å —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç</label>
                                <select v-model="tempCommonIngredient.ingredient_id" class="w-full p-2 border rounded-lg text-sm bg-gray-50">
                                    <option value="" disabled>–û–±–µ—Ä—ñ—Ç—å –∑—ñ —Å–ø–∏—Å–∫—É...</option>
                                    <option v-for="ing in ingredients" :key="ing.id" :value="ing.id">
                                        {{ ing.name }} ({{ ing.stock_quantity }} {{ ing.unit?.symbol }})
                                    </option>
                                </select>
                            </div>
                            <div class="w-24">
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">–ö—ñ–ª—å–∫—ñ—Å—Ç—å</label>
                                <input type="number" v-model="tempCommonIngredient.quantity" class="w-full p-2 border rounded-lg text-sm text-center" step="0.1">
                            </div>
                            <button @click="addCommonIngredient" class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 font-bold text-sm h-[38px]">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>

                        <div class="space-y-2">
                            <div v-for="(item, index) in newProduct.ingredients" :key="index" class="flex justify-between items-center p-3 bg-white border rounded-lg hover:bg-gray-50">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center text-xs font-bold">
                                        {{ index + 1 }}
                                    </div>
                                    <span class="font-medium text-gray-800">{{ item.name }}</span>
                                </div>
                                <div class="flex items-center gap-4">
                                    <span class="bg-gray-100 px-2 py-1 rounded text-sm font-mono">{{ item.quantity }} –æ–¥.</span>
                                    <button @click="removeCommonIngredient(index)" class="text-gray-400 hover:text-red-500 transition">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div v-if="!newProduct.ingredients || newProduct.ingredients.length === 0" class="text-center py-8 text-gray-400 text-sm italic">
                                –ù–µ–º–∞—î —Å–ø—ñ–ª—å–Ω–∏—Ö —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç—ñ–≤
                            </div>
                        </div>
                    </div>

                    <div v-if="activeTab === 'consumables'" class="max-w-3xl mx-auto animate-slide-up">
                        <div class="bg-blue-50 border border-blue-100 rounded-xl p-4 mb-6">
                            <div class="flex gap-3">
                                <i class="fas fa-info-circle text-blue-500 mt-0.5"></i>
                                <p class="text-sm text-blue-700">
                                    –¢—É—Ç –¥–æ–¥–∞—é—Ç—å—Å—è –º–∞—Ç–µ—Ä—ñ–∞–ª–∏, —è–∫—ñ —Å–ø–∏—Å—É—é—Ç—å—Å—è <strong>–ø—Ä–∏ –ø—Ä–æ–¥–∞–∂—É –±—É–¥—å-—è–∫–æ–≥–æ –≤–∞—Ä—ñ–∞–Ω—Ç—É</strong> 
                                    (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: —Å–µ—Ä–≤–µ—Ç–∫–∞, —Ç—Ä—É–±–æ—á–∫–∞, –ø–∞–∫–µ—Ç).
                                </p>
                            </div>
                        </div>

                        <div class="flex gap-2 items-end mb-4 bg-white p-4 rounded-xl border shadow-sm">
                            <div class="flex-1">
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">–û–±–µ—Ä—ñ—Ç—å –º–∞—Ç–µ—Ä—ñ–∞–ª</label>
                                <select v-model="tempProductConsumable.consumable_id" class="w-full p-2 border rounded-lg text-sm bg-gray-50">
                                    <option value="" disabled>–û–±–µ—Ä—ñ—Ç—å –∑—ñ —Å–ø–∏—Å–∫—É...</option>
                                    <option v-for="c in consumables" :key="c.id" :value="c.id">
                                        {{ c.name }} ({{ c.stock_quantity }} {{ c.unit?.symbol }})
                                    </option>
                                </select>
                            </div>
                            <div class="w-24">
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">–ö—ñ–ª—å–∫—ñ—Å—Ç—å</label>
                                <input type="number" v-model="tempProductConsumable.quantity" class="w-full p-2 border rounded-lg text-sm text-center" min="1">
                            </div>
                            <button @click="addProductConsumable" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold text-sm h-[38px]">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>

                        <div class="space-y-2">
                            <div v-for="(item, index) in newProduct.consumables" :key="index" class="flex justify-between items-center p-3 bg-white border rounded-lg hover:bg-gray-50">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-xs font-bold">
                                        {{ index + 1 }}
                                    </div>
                                    <span class="font-medium text-gray-800">{{ item.name }}</span>
                                </div>
                                <div class="flex items-center gap-4">
                                    <span class="bg-gray-100 px-2 py-1 rounded text-sm font-mono">x {{ item.quantity }}</span>
                                    <button @click="removeProductConsumable(index)" class="text-gray-400 hover:text-red-500 transition">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div v-if="newProduct.consumables.length === 0" class="text-center py-8 text-gray-400 text-sm italic">
                                –ù–µ–º–∞—î —Å–ø—ñ–ª—å–Ω–∏—Ö –º–∞—Ç–µ—Ä—ñ–∞–ª—ñ–≤
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <div class="px-8 py-5 border-t bg-gray-50 rounded-b-2xl flex justify-between items-center">
                <button @click="emit('close')" class="text-gray-500 hover:text-gray-800 font-medium px-4 py-2 rounded-lg hover:bg-gray-200 transition">
                    –°–∫–∞—Å—É–≤–∞—Ç–∏
                </button>
                <button 
                    @click="handleSaveProduct" 
                    class="bg-purple-600 text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-purple-200 hover:bg-purple-700 hover:shadow-xl active:scale-95 transition flex items-center gap-2"
                >
                    <i class="fas fa-save"></i> –ó–±–µ—Ä–µ–≥—Ç–∏ —Ç–æ–≤–∞—Ä
                </button>
            </div>

            <div v-if="showVariantForm" class="absolute inset-0 z-50 bg-black bg-opacity-20 backdrop-blur-sm flex items-center justify-center p-4">
                <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl flex flex-col max-h-[85vh] animate-slide-up border border-gray-200">
                    <div class="p-4 border-b flex justify-between items-center bg-purple-50 rounded-t-xl">
                        <h3 class="font-bold text-purple-900 flex items-center gap-2">
                            <i class="fas fa-cubes"></i> {{ editingVariantIndex !== null ? '–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –≤–∞—Ä—ñ–∞–Ω—Ç' : '–ù–æ–≤–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç' }}
                        </h3>
                        <button @click="closeVariantForm" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
                    </div>
                    
                    <div class="p-6 overflow-y-auto space-y-5">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">–ù–∞–∑–≤–∞ –≤–∞—Ä—ñ–∞–Ω—Ç—É <span class="text-red-500">*</span></label>
                                <input v-model="variantBuilder.name" type="text" placeholder="S / M / L" class="w-full p-2.5 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">SKU (–ê—Ä—Ç–∏–∫—É–ª)</label>
                                <input v-model="variantBuilder.sku" type="text" placeholder="CODE-123" class="w-full p-2.5 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none">
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">–¶—ñ–Ω–∞ (‚Ç¥) <span class="text-red-500">*</span></label>
                                <input v-model.number="variantBuilder.price" type="number" class="w-full p-2.5 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">–ü–æ—Ç–æ—á–Ω–∏–π –∑–∞–ª–∏—à–æ–∫</label>
                                <input v-model.number="variantBuilder.stock_quantity" type="number" class="w-full p-2.5 border rounded-lg focus:ring-2 focus:ring-purple-500 outline-none bg-yellow-50">
                            </div>
                        </div>

                        <div class="pt-4 border-t">
                             <label class="block text-sm font-bold text-gray-800 mb-2">–¢–µ—Ö–Ω–æ–ª–æ–≥—ñ—á–Ω–∞ –∫–∞—Ä—Ç–∞ (–†–µ—Ü–µ–ø—Ç)</label>
                             <select v-model="variantBuilder.master_recipe_id" class="w-full p-2.5 border rounded-lg bg-gray-50 mb-3">
                                <option :value="null">–ë–µ–∑ —Ä–µ—Ü–µ–ø—Ç—É</option>
                                <option v-for="r in recipes" :key="r.id" :value="r.id">{{ r.name }}</option>
                            </select>
                            
                            <div v-if="variantBuilder.master_recipe_id" class="mb-3">
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">–í–∞–≥–∞ –≤–∏—Ö–æ–¥—É (–≥/–º–ª)</label>
                                <input v-model.number="variantBuilder.output_weight" type="number" class="w-full p-2 border rounded-lg">
                                <p class="text-xs text-gray-400 mt-1">–ü–æ—Ç—Ä—ñ–±–Ω–æ –¥–ª—è —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É % —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç—ñ–≤</p>
                            </div>
                        </div>

                        <div class="pt-4 border-t">
                            <label class="block text-sm font-bold text-gray-800 mb-2">–£–Ω—ñ–∫–∞–ª—å–Ω—ñ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏ –≤–∞—Ä—ñ–∞–Ω—Ç—É</label>
                            <div class="bg-gray-50 p-3 rounded-lg">
                                <div class="flex gap-2 mb-2">
                                     <select v-model="tempVariantConsumable.consumable_id" class="flex-1 p-2 border rounded text-sm">
                                        <option value="" disabled>–û–±–µ—Ä—ñ—Ç—å –º–∞—Ç–µ—Ä—ñ–∞–ª...</option>
                                        <option v-for="c in consumables" :key="c.id" :value="c.id">{{ c.name }}</option>
                                    </select>
                                    <input type="number" v-model="tempVariantConsumable.quantity" class="w-20 p-2 border rounded text-sm text-center" min="1">
                                    <button @click="addVariantConsumable" class="px-3 bg-purple-600 text-white rounded"><i class="fas fa-plus"></i></button>
                                </div>
                                 <div class="bg-white rounded border divide-y max-h-40 overflow-y-auto">
                                     <div v-for="(c, idx) in variantBuilder.consumables" :key="idx" class="p-2 text-sm flex justify-between">
                                        <span>{{ c.name || '???' }}</span>
                                        <span>{{ c.quantity }} —à—Ç <i @click="removeVariantConsumable(idx)" class="fas fa-times text-red-500 cursor-pointer ml-2"></i></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="p-4 border-t bg-white flex justify-end gap-3 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
                        <button @click="closeVariantForm" class="px-5 py-2 border rounded-lg text-gray-600 hover:bg-gray-50">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                        <button @click="handleSaveVariant" class="px-5 py-2 bg-purple-600 text-white rounded-lg font-medium hover:bg-purple-700 shadow-md">
                            <i class="fas fa-check mr-1"></i> –ó–±–µ—Ä–µ–≥—Ç–∏ –≤–∞—Ä—ñ–∞–Ω—Ç
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>
</template>

<style scoped>
.animate-fade-in { animation: fadeIn 0.2s ease-out; }
.animate-slide-up { animation: slideUp 0.3s ease-out; }
@keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
@keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
</style>
</file>

<file path="frontend\src\components\warehouse\tabs\products\ProductsTab.vue">
<script setup>
import { ref, onMounted } from 'vue'
import { useWarehouse } from '@/composables/useWarehouse'
import { useProducts } from '@/composables/useProducts'

// –Ü–º–ø–æ—Ä—Ç—É—î–º–æ –Ω–∞—à—ñ —Ñ–æ—Ä–º–∏
import ProductFormSimple from './ProductFormSimple.vue'
import ProductFormVariant from './ProductFormVariant.vue'

const { fetchWarehouseData } = useWarehouse()

// --- –§–£–ù–ö–¶–Ü–û–ù–ê–õ ---
const { 
    newProduct, 
    prepareEdit: originalHandleEdit, 
    deleteProduct, 
    fetchProducts, 
    filteredProducts, 
    productSearch, 
    resetForm
} = useProducts()

// --- UI –°–¢–ê–ù–ò ---
const showTypeModal = ref(false)   // –ú–∞–ª–µ–Ω—å–∫–µ –≤—ñ–∫–Ω–æ –≤–∏–±–æ—Ä—É —Ç–∏–ø—É
const showSimpleForm = ref(false)  // –í–µ–ª–∏–∫–∞ —Ñ–æ—Ä–º–∞ –ø—Ä–æ—Å—Ç–æ–≥–æ —Ç–æ–≤–∞—Ä—É
const showVariantForm = ref(false) // –í–µ–ª–∏–∫–∞ —Ñ–æ—Ä–º–∞ –≤–∞—Ä—ñ–∞–Ω—Ç—ñ–≤
const isEditing = ref(false)

onMounted(async () => {
    await Promise.all([fetchWarehouseData(), fetchProducts()])
})

// --- –õ–û–ì–Ü–ö–ê –í–Ü–î–ö–†–ò–¢–¢–Ø –í–Ü–ö–û–ù ---

// 1. –ù–∞—Ç–∏—Å–Ω—É–ª–∏ "–î–æ–¥–∞—Ç–∏ —Ç–æ–≤–∞—Ä" -> –í—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ –≤–∏–±—ñ—Ä —Ç–∏–ø—É
const openCreateModal = () => {
    resetForm()
    isEditing.value = false
    showTypeModal.value = true
}

// 2. –û–±—Ä–∞–ª–∏ —Ç–∏–ø -> –í—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—É —Ñ–æ—Ä–º—É
const selectType = (type) => {
    showTypeModal.value = false // –ó–∞–∫—Ä–∏–≤–∞—î–º–æ –≤–∏–±—ñ—Ä
    
    if (type === 'simple') {
        newProduct.value.has_variants = false
        showSimpleForm.value = true
    } else {
        newProduct.value.has_variants = true
        showVariantForm.value = true
    }
}

// 3. –ù–∞—Ç–∏—Å–Ω—É–ª–∏ "–†–µ–¥–∞–≥—É–≤–∞—Ç–∏" –≤ —Ç–∞–±–ª–∏—Ü—ñ
const handleEditWrapper = (product) => {
    originalHandleEdit(product)
    isEditing.value = true
    
    if (product.has_variants) {
         showVariantForm.value = true
    } else {
        showSimpleForm.value = true
    }
}

// 4. –õ–æ–≥—ñ–∫–∞ –∑–∞–∫—Ä–∏—Ç—Ç—è (–ø–µ—Ä–µ–¥–∞—î—Ç—å—Å—è –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∏)
const closeAllForms = () => {
    showSimpleForm.value = false
    showVariantForm.value = false
    resetForm()
}

// 5. –£—Å–ø—ñ—à–Ω–µ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
const onSaved = async () => {
    await fetchProducts()
    // closeAllForms –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —á–µ—Ä–µ–∑ –ø–æ–¥—ñ—é @close, —è–∫—â–æ —Ç–∞–∫ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ, 
    // –∞–±–æ –º–æ–∂–Ω–∞ –≤–∏–∫–ª–∏–∫–∞—Ç–∏ —Ç—É—Ç, —è–∫—â–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Å–∞–º –Ω–µ –∑–∞–∫—Ä–∏–≤–∞—î—Ç—å—Å—è.
    // –£ –Ω–∞—à–æ–º—É –≤–∏–ø–∞–¥–∫—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –µ–º—ñ—Ç–∏—Ç—å 'saved', –º–∏ –æ–Ω–æ–≤–ª—é—î–º–æ –¥–∞–Ω—ñ, 
    // –∞ –∑–∞–∫—Ä–∏—Ç—Ç—è–º –∫–µ—Ä—É—î —Å–∞–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —á–µ—Ä–µ–∑ emit('close').
}
</script>

<template>
    <div class="h-full flex flex-col bg-white rounded-xl shadow-sm border overflow-hidden">
        
        <div class="p-6 border-b flex flex-col md:flex-row gap-4 justify-between items-center bg-gray-50">
            <h2 class="text-2xl font-bold text-gray-800">üì¶ –¢–æ–≤–∞—Ä–∏ —Ç–∞ –ü–æ—Å–ª—É–≥–∏</h2>
            <div class="flex gap-3 w-full md:w-auto">
                <div class="relative flex-1 md:w-64">
                    <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                    <input v-model="productSearch" type="text" placeholder="–ü–æ—à—É–∫..." class="pl-10 pr-4 py-2 border rounded-lg w-full focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <button @click="openCreateModal" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 shadow-md transition flex items-center gap-2 font-medium">
                    <i class="fas fa-plus"></i> <span class="hidden sm:inline">–î–æ–¥–∞—Ç–∏</span>
                </button>
            </div>
        </div>

        <div class="flex-1 overflow-auto p-4 bg-gray-50">
            <div class="overflow-hidden rounded-xl border shadow-sm bg-white">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-gray-100 text-gray-600 uppercase text-xs font-semibold tracking-wider sticky top-0 z-10">
                        <tr>
                            <th class="p-4 border-b">–ù–∞–∑–≤–∞</th>
                            <th class="p-4 border-b">–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</th>
                            <th class="p-4 border-b">–¶—ñ–Ω–∞</th>
                            <th class="p-4 border-b">–¢–∏–ø</th>
                            <th class="p-4 border-b">–°–∫–ª–∞–¥</th>
                            <th class="p-4 border-b text-center">–î—ñ—ó</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        <tr v-if="filteredProducts.length === 0">
                            <td colspan="6" class="p-8 text-center text-gray-400">–¢–æ–≤–∞—Ä—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</td>
                        </tr>
                        <tr v-for="p in filteredProducts" :key="p.id" class="hover:bg-blue-50 transition group">
                            <td class="p-4 font-medium text-gray-800">
                                {{ p.name }}
                                <div class="text-xs text-gray-400 font-normal mt-0.5 max-w-xs truncate">{{ p.description }}</div>
                            </td>
                            <td class="p-4 text-sm">
                                <span v-if="p.category" class="bg-gray-100 text-gray-600 px-2 py-1 rounded font-medium text-xs border border-gray-200">
                                    {{ p.category.name }}
                                </span>
                                <span v-else class="text-gray-300">-</span>
                            </td>
                            <td class="p-4 font-bold text-green-600 font-mono">
                                <span v-if="!p.has_variants">{{ p.price }} ‚Ç¥</span>
                                <span v-else class="text-xs text-gray-400 font-normal italic">–≤—ñ–¥ –≤–∞—Ä—ñ–∞–Ω—Ç—É</span>
                            </td>
                            <td class="p-4">
                                <span v-if="p.has_variants" class="inline-flex items-center gap-1 text-[10px] bg-purple-100 text-purple-700 px-2 py-1 rounded-full font-bold border border-purple-200">
                                    <i class="fas fa-layer-group"></i> –í–∞—Ä—ñ–∞–Ω—Ç–∏
                                </span>
                                <span v-else class="inline-flex items-center gap-1 text-[10px] bg-blue-100 text-blue-700 px-2 py-1 rounded-full font-bold border border-blue-200">
                                    <i class="fas fa-box"></i> –ü—Ä–æ—Å—Ç–∏–π
                                </span>
                            </td>
                            <td class="p-4 text-sm">
                                <div v-if="!p.has_variants">
                                    <div v-if="p.track_stock" class="font-mono font-bold" :class="p.stock_quantity > 0 ? 'text-blue-600' : 'text-red-500'">
                                        {{ p.stock_quantity }} —à—Ç
                                    </div>
                                    <div v-else class="text-gray-400 text-xs italic">–ë–µ–∑ –æ–±–ª—ñ–∫—É</div>
                                </div>
                                <div v-else class="text-xs text-gray-400 italic">–î–∏–≤. –¥–µ—Ç–∞–ª—ñ</div>
                            </td>
                            <td class="p-4 text-center">
                                <div class="flex justify-center gap-2 opacity-0 group-hover:opacity-100 transition">
                                    <button @click="handleEditWrapper(p)" class="w-8 h-8 rounded flex items-center justify-center text-blue-500 hover:bg-blue-100 transition" title="–†–µ–¥–∞–≥—É–≤–∞—Ç–∏">
                                        <i class="fas fa-pen"></i>
                                    </button>
                                    <button @click="deleteProduct(p.id)" class="w-8 h-8 rounded flex items-center justify-center text-red-500 hover:bg-red-100 transition" title="–í–∏–¥–∞–ª–∏—Ç–∏">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div v-if="showTypeModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 backdrop-blur-sm animate-fade-in">
            <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-md w-full text-center relative transform transition-all scale-100">
                <button @click="showTypeModal = false" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
                
                <h3 class="text-2xl font-bold mb-2 text-gray-800">–ù–æ–≤–∏–π —Ç–æ–≤–∞—Ä</h3>
                <p class="text-gray-500 mb-8 text-sm">–û–±–µ—Ä—ñ—Ç—å —Ç–∏–ø —Ç–æ–≤–∞—Ä—É, —è–∫–∏–π –≤–∏ —Ö–æ—á–µ—Ç–µ —Å—Ç–≤–æ—Ä–∏—Ç–∏</p>
                
                <div class="grid grid-cols-2 gap-4">
                    <button @click="selectType('simple')" class="p-6 border-2 border-gray-100 rounded-xl hover:border-blue-500 hover:bg-blue-50 transition group flex flex-col items-center">
                        <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-3xl mb-4 group-hover:scale-110 transition">‚òï</div>
                        <div class="font-bold text-gray-800">–ü—Ä–æ—Å—Ç–∏–π</div>
                        <div class="text-[10px] text-gray-500 mt-1 leading-tight">–§—ñ–∫—Å–æ–≤–∞–Ω–∞ —Ü—ñ–Ω–∞,<br>–æ–¥–∏–Ω —Ä–µ—Ü–µ–ø—Ç</div>
                    </button>

                    <button @click="selectType('variant')" class="p-6 border-2 border-gray-100 rounded-xl hover:border-purple-500 hover:bg-purple-50 transition group flex flex-col items-center">
                        <div class="w-16 h-16 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center text-3xl mb-4 group-hover:scale-110 transition">üëï</div>
                        <div class="font-bold text-gray-800">–ó –≤–∞—Ä—ñ–∞–Ω—Ç–∞–º–∏</div>
                        <div class="text-[10px] text-gray-500 mt-1 leading-tight">–†—ñ–∑–Ω—ñ —Ä–æ–∑–º—ñ—Ä–∏,<br>–æ–±'—î–º–∏, —Ü—ñ–Ω–∏</div>
                    </button>
                </div>
            </div>
        </div>

        <ProductFormSimple 
            :isOpen="showSimpleForm"
            :isEdit="isEditing"
            @close="closeAllForms"
            @saved="onSaved"
        />

        <ProductFormVariant
            :isOpen="showVariantForm"
            :isEdit="isEditing"
            @close="closeAllForms"
            @saved="onSaved"
        />
        
    </div>
</template>

<style scoped>
.animate-fade-in { animation: fadeIn 0.2s ease-out; }
@keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
</style>
</file>

<file path="frontend\src\composables\useCart.js">
import { ref, computed } from 'vue'

const cartItems = ref([])
const isProcessing = ref(false)
const paymentMethod = ref('cash')
const selectedCustomer = ref(null)

export function useCart() {
  
  // –¶—è —Å—É–º–∞ —Ç–µ–ø–µ—Ä –¢–Ü–õ–¨–ö–ò –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É
  const totalSum = computed(() => {
    return cartItems.value.reduce((sum, item) => sum + (item.price * item.quantity), 0)
  })

  const cartCount = computed(() => {
    return cartItems.value.reduce((sum, item) => sum + item.quantity, 0)
  })

  const fetchCart = async () => {
    try {
      const res = await fetch('/api/cart/')
      if (res.ok) {
        const items = await res.json()
        cartItems.value = items.sort((a, b) => a.name.localeCompare(b.name))
      }
    } catch (err) { console.error("Cart fetch error:", err) }
  }

  const addToCart = async (payload) => {
    try {
      const res = await fetch('/api/cart/add', { 
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
      if (res.ok) await fetchCart()
    } catch (err) { console.error(err) }
  }
  
  const removeFromCart = async (itemId) => {
     try {
      await fetch(`/api/cart/${itemId}`, { method: 'DELETE' })
      await fetchCart()
    } catch (err) { console.error(err) }
  }
  
  const clearCart = async () => {
    try {
        await fetch('/api/cart/', { method: 'DELETE' })
        cartItems.value = []
    } catch(e) { console.error(e) }
  }

  // üî• –û–°–ù–û–í–ù–ê –ó–ú–Ü–ù–ê –¢–£–¢
  const processCheckout = async () => {
    if (cartItems.value.length === 0) return
    isProcessing.value = true
    
    try {
      const payload = {
        items: cartItems.value.map(item => ({
          product_id: item.product_id,
          variant_id: item.variant_id || null,
          quantity: item.quantity,
          // –ë–µ–∑–ø–µ—á–Ω–∞ –æ–±—Ä–æ–±–∫–∞ –º–æ–¥–∏—Ñ—ñ–∫–∞—Ç–æ—Ä—ñ–≤
          modifiers: Array.isArray(item.modifiers) 
            ? item.modifiers.map(m => ({
              // –Ø–∫—â–æ m - —Ü–µ —á–∏—Å–ª–æ, –±–µ—Ä–µ–º–æ –π–æ–≥–æ. –Ø–∫—â–æ –æ–±'—î–∫—Ç - –±–µ—Ä–µ–º–æ m.id –∞–±–æ m.modifier_id
              modifier_id: typeof m === 'number' ? m : (m.id || m.modifier_id),
              quantity: m.quantity || 1 // –î–æ–¥–∞—î–º–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å, —è–∫—â–æ –º–æ–¥–∏—Ñ—ñ–∫–∞—Ç–æ—Ä—ñ–≤ > 1
              }))
            : []
        })),
        payment_method: paymentMethod.value,
        // ‚ùå total_price –ë–Ü–õ–¨–®–ï –ù–ï –í–Ü–î–ü–†–ê–í–õ–Ø–Ñ–ú–û!
        customer_id: selectedCustomer.value ? selectedCustomer.value.id : null
      }

      console.log("üì§ Checkout Request:", payload)

      const res = await fetch('/api/orders/checkout/', { 
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })

      if (!res.ok) {
          const err = await res.json()
          throw new Error(err.detail || "–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ–ø–ª–∞—Ç—ñ")
      }

      const responseData = await res.json()
      
      // –û—á–∏—â–µ–Ω–Ω—è
      await fetch('/api/cart/', { method: 'DELETE' })
      cartItems.value = []
      selectedCustomer.value = null
      
      // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —ñ–∑ –°–ï–†–í–ï–†–ù–û–Æ —Å—É–º–æ—é
      return {
        success: true,
        text: `‚úÖ –û–ø–ª–∞—Ç–∞ —É—Å–ø—ñ—à–Ω–∞!\n–°–ø–∏—Å–∞–Ω–æ: ${responseData.total_price} ‚Ç¥`
      }

    } catch (err) {
      console.error(err)
      return { success: false, text: `‚ùå –ü–æ–º–∏–ª–∫–∞: ${err.message}` }
    } finally {
      isProcessing.value = false
    }
  }

  const setCustomer = (c) => { selectedCustomer.value = c }
  const removeCustomer = () => { selectedCustomer.value = null }

  return {
    cartItems, cartCount, totalSum, isProcessing, paymentMethod, selectedCustomer,
    fetchCart, addToCart, removeFromCart, clearCart, processCheckout,
    setCustomer, removeCustomer
  }
}
</file>

<file path="frontend\src\composables\useCustomers.js">
import { ref, watch } from 'vue'

export function useCustomers() {
  const customers = ref([])
  const loading = ref(false)
  
  // –ü–æ—à—É–∫
  const searchQuery = ref('')
  
  // –î–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
  const showModal = ref(false)
  const isEditing = ref(false)
  const editingId = ref(null)
  const formData = ref({ name: '', phone: '', email: '', notes: '' })

  // –î–ª—è —ñ—Å—Ç–æ—Ä—ñ—ó
  const showHistoryModal = ref(false)
  const historyLoading = ref(false)
  const currentCustomerHistory = ref(null)
  const customerOrders = ref([])

  // --- ACTIONS ---

  const fetchCustomers = async () => {
    loading.value = true
    try {
      let url = '/api/customers/'
      if (searchQuery.value.length > 0) url = `/api/customers/search/?q=${searchQuery.value}`
      const res = await fetch(url)
      if (res.ok) customers.value = await res.json()
    } catch (err) { console.error(err) } finally { loading.value = false }
  }

  // --- CRUD Operations ---
  
  const openCreateModal = () => {
    isEditing.value = false
    formData.value = { name: '', phone: '', email: '', notes: '' }
    showModal.value = true
  }

  const openEditModal = (customer) => {
    isEditing.value = true
    editingId.value = customer.id
    formData.value = { ...customer } // –ö–æ–ø—ñ—é—î–º–æ –¥–∞–Ω—ñ
    showModal.value = true
  }

  const saveCustomer = async () => {
    if (!formData.value.name || !formData.value.phone) {
        alert("–Ü–º'—è —Ç–∞ –¢–µ–ª–µ—Ñ–æ–Ω –æ–±–æ–≤'—è–∑–∫–æ–≤—ñ!")
        return false
    }
    
    try {
      let url = '/api/customers/'
      let method = 'POST'
      
      if (isEditing.value) {
        url = `/api/customers/${editingId.value}`
        method = 'PUT'
      }
      
      const res = await fetch(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData.value)
      })
      
      if (res.ok) {
        showModal.value = false
        await fetchCustomers()
        return true
      } else {
        const err = await res.json()
        alert("–ü–æ–º–∏–ª–∫–∞: " + (err.detail || "–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–±–µ—Ä–µ–≥—Ç–∏"))
        return false
      }
    } catch (err) { 
        console.error(err)
        return false
    }
  }

  const deleteCustomer = async (id) => {
    if (!confirm("–í–∏–¥–∞–ª–∏—Ç–∏ —Ü—å–æ–≥–æ –∫–ª—ñ—î–Ω—Ç–∞ –∑ –±–∞–∑–∏?")) return
    try {
        await fetch(`/api/customers/${id}`, { method: 'DELETE' })
        await fetchCustomers()
    } catch (err) { console.error(err) }
  }

  // --- History Logic ---

  const openHistory = async (customer) => {
    currentCustomerHistory.value = customer
    customerOrders.value = []
    showHistoryModal.value = true
    historyLoading.value = true
    
    try {
      const res = await fetch(`/api/customers/${customer.id}/orders/`)
      if (res.ok) {
        customerOrders.value = await res.json()
      }
    } catch (err) {
      console.error(err)
      alert("–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é")
    } finally {
      historyLoading.value = false
    }
  }

  // --- Watcher –¥–ª—è –ø–æ—à—É–∫—É ---
  let timeout = null
  watch(searchQuery, () => {
    clearTimeout(timeout)
    timeout = setTimeout(() => { fetchCustomers() }, 500)
  })

  return {
    customers,
    loading,
    searchQuery,
    showModal,
    isEditing,
    formData,
    // History
    showHistoryModal,
    historyLoading,
    currentCustomerHistory,
    customerOrders,
    // Actions
    fetchCustomers,
    openCreateModal,
    openEditModal,
    saveCustomer,
    deleteCustomer,
    openHistory
  }
}
</file>

<file path="frontend\src\composables\useProducts.js">
import { ref, computed } from 'vue'
import axios from 'axios'
import { useWarehouse } from '@/composables/useWarehouse'

// –ì–ª–æ–±–∞–ª—å–Ω–∏–π —Å—Ç–∞–Ω
const newProduct = ref({
    name: '', category_id: null, price: 0, has_variants: false,
    master_recipe_id: null, output_weight: 0,
    track_stock: false, stock_quantity: 0,
    consumables: [], ingredients: [], variants: [], process_group_ids: [],
    // üëá –î–æ–¥–∞–Ω—ñ –ø–æ–ª—è –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è (–ø—Ä–∏—Ö–æ–¥—è—Ç—å –∑ –±–µ–∫—É)
    cost_price: 0, margin: 0 
})

const editingId = ref(null)
const isEditing = ref(false)
const productSearch = ref('')

// –°—Ç–∞–Ω —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –≤–∞—Ä—ñ–∞–Ω—Ç—É
const editingVariantIndex = ref(null) 

// –¢–∏–º—á–∞—Å–æ–≤—ñ –∑–º—ñ–Ω–Ω—ñ
const tempProductConsumable = ref({ consumable_id: "", quantity: 1 })
const tempVariantConsumable = ref({ consumable_id: "", quantity: 1 })
const tempVariantIngredient = ref({ ingredient_id: "", quantity: 0 })

const variantBuilder = ref({
    name: '', price: 0, sku: '', // üëà SKU —Ç–µ–ø–µ—Ä —Ç—É—Ç
    master_recipe_id: null, 
    output_weight: 0, stock_quantity: 0, 
    consumables: [], ingredients: [],
    // üëá –î–æ–¥–∞–Ω—ñ –ø–æ–ª—è –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
    cost_price: 0, margin: 0 
})

export function useProducts() {
    const warehouse = useWarehouse()
    const products = warehouse?.products || ref([])
    const consumables = warehouse?.consumables || ref([])
    const ingredients = warehouse?.ingredients || ref([]) // –¢—Ä–µ–±–∞ –¥–ª—è —Ä–æ–±–æ—Ç–∏ –∑ —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∞–º–∏

    // --- CRUD –¢–æ–≤–∞—Ä—ñ–≤ ---
    const fetchProducts = async () => {
        if (warehouse && warehouse.fetchProducts) {
            await warehouse.fetchProducts()
        }
    }

    const resetForm = () => {
        newProduct.value = {
            name: '', category_id: null, price: 0, has_variants: false,
            master_recipe_id: null, output_weight: 0,
            track_stock: false, stock_quantity: 0,
            consumables: [], variants: [], process_group_ids: [],
            cost_price: 0, margin: 0
        }
        variantBuilder.value = {
            name: '', price: 0, sku: '',
            master_recipe_id: null, output_weight: 0, stock_quantity: 0, 
            consumables: [], ingredients: [],
            cost_price: 0, margin: 0
        }
        isEditing.value = false
        editingId.value = null
        editingVariantIndex.value = null
    }

    const prepareEdit = (product) => {
        // –ö–æ–ø—ñ—é—î–º–æ –æ–±'—î–∫—Ç, —â–æ–± –Ω–µ –∑–º—ñ–Ω—é–≤–∞—Ç–∏ –π–æ–≥–æ –≤ —Å–ø–∏—Å–∫—É –¥–æ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
        newProduct.value = JSON.parse(JSON.stringify(product))
        editingId.value = product.id
        isEditing.value = true
        // –Ø–∫—â–æ process_group_ids –Ω–µ –ø—Ä–∏–π—à–ª–∏ (—Å—Ç–∞—Ä–∏–π —Ñ–æ—Ä–º–∞—Ç), —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ
        if (!newProduct.value.process_group_ids) newProduct.value.process_group_ids = []
    }

    const saveProduct = async () => {
        try {
            // –§–æ—Ä–º—É—î–º–æ payload
            const payload = {
                ...newProduct.value,
                // –ü–µ—Ä–µ–∫–æ–Ω—É—î–º–æ—Å—å, —â–æ —á–∏—Å–ª–∞ —î —á–∏—Å–ª–∞–º–∏
                price: parseFloat(newProduct.value.price),
                stock_quantity: parseFloat(newProduct.value.stock_quantity),
                output_weight: parseFloat(newProduct.value.output_weight),
            }

            if (isEditing.value) {
                await axios.put(`/api/products/${editingId.value}`, payload)
            } else {
                await axios.post('/api/products/', payload)
            }
            
            await fetchProducts()
            resetForm()
            return true
        } catch (e) {
            console.error("–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ç–æ–≤–∞—Ä—É:", e)
            alert("–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è: " + (e.response?.data?.detail || e.message))
            return false
        }
    }

    const deleteProduct = async (id) => {
        if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π —Ç–æ–≤–∞—Ä?')) return
        try {
            await axios.delete(`/api/products/${id}`)
            await fetchProducts()
        } catch (e) {
            console.error(e)
            alert("–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–¥–∞–ª–∏—Ç–∏ —Ç–æ–≤–∞—Ä")
        }
    }

    // --- –í–∞—Ä—ñ–∞–Ω—Ç–∏ ---
    const saveVariant = () => {
        const v = JSON.parse(JSON.stringify(variantBuilder.value))
        
        // –í–∞–ª—ñ–¥–∞—Ü—ñ—è –≤–∂–µ –Ω–∞ —Ä—ñ–≤–Ω—ñ UI, —Ç—É—Ç –ø—Ä–æ—Å—Ç–æ –¥–æ–¥–∞—î–º–æ
        if (editingVariantIndex.value !== null) {
            newProduct.value.variants[editingVariantIndex.value] = v
            editingVariantIndex.value = null
        } else {
            newProduct.value.variants.push(v)
        }
        
        // –û—á–∏—â–µ–Ω–Ω—è –±—ñ–ª–¥–µ—Ä–∞ (–∞–ª–µ SKU –æ—á–∏—â–∞—î–º–æ, —â–æ–± –Ω–µ –¥—É–±–ª—é–≤–∞—Ç–∏)
        variantBuilder.value = {
            name: '', price: 0, sku: '',
            master_recipe_id: null, output_weight: 0, stock_quantity: 0, 
            consumables: [], ingredients: [],
            cost_price: 0, margin: 0
        }
    }

    const editVariant = (index) => {
        variantBuilder.value = JSON.parse(JSON.stringify(newProduct.value.variants[index]))
        editingVariantIndex.value = index
    }

    const removeVariant = (index) => {
        newProduct.value.variants.splice(index, 1)
        if (editingVariantIndex.value === index) {
            editingVariantIndex.value = null
            // –û—á–∏—Å—Ç–∏—Ç–∏ —Ñ–æ—Ä–º—É
            variantBuilder.value = {
                name: '', price: 0, sku: '',
                master_recipe_id: null, output_weight: 0, stock_quantity: 0, 
                consumables: [], ingredients: [], cost_price: 0, margin: 0
            }
        }
    }

    const cancelVariantEdit = () => {
        editingVariantIndex.value = null
        variantBuilder.value = {
            name: '', price: 0, sku: '',
            master_recipe_id: null, output_weight: 0, stock_quantity: 0, 
            consumables: [], ingredients: [], cost_price: 0, margin: 0
        }
    }

    // --- –î–æ–ø–æ–º—ñ–∂–Ω—ñ (Consumables / Ingredients) ---
    const addProductConsumable = () => {
        if(!tempProductConsumable.value.consumable_id) return
        const c = consumables.value.find(x => x.id === tempProductConsumable.value.consumable_id)
        newProduct.value.consumables.push({ ...tempProductConsumable.value, name: c?.name || '???' })
        tempProductConsumable.value.quantity = 1
    }
    const removeProductConsumable = (i) => newProduct.value.consumables.splice(i, 1)

    const addVariantConsumable = () => {
        if(!tempVariantConsumable.value.consumable_id) return
        const c = consumables.value.find(x => x.id === tempVariantConsumable.value.consumable_id)
        variantBuilder.value.consumables.push({ ...tempVariantConsumable.value, name: c?.name || '???' })
        tempVariantConsumable.value.quantity = 1
    }
    const removeVariantConsumable = (i) => variantBuilder.value.consumables.splice(i, 1)

    const addIngredientToVariant = () => {
        if(!tempVariantIngredient.value.ingredient_id) return
        const i = ingredients.value.find(x => x.id === tempVariantIngredient.value.ingredient_id)
        variantBuilder.value.ingredients.push({ ...tempVariantIngredient.value, name: i?.name || '???' })
        tempVariantIngredient.value.quantity = 0
    }
    const removeIngredientFromVariant = (i) => variantBuilder.value.ingredients.splice(i, 1)

    // --- –§—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è ---
    const filteredProducts = computed(() => {
        if (!productSearch.value) return products.value
        const s = productSearch.value.toLowerCase()
        return products.value.filter(p => p.name.toLowerCase().includes(s))
    })

    return {
        newProduct, isEditing, editingId, productSearch, filteredProducts,
        variantBuilder, tempProductConsumable, tempVariantConsumable, tempVariantIngredient,
        editingVariantIndex, saveVariant, editVariant, cancelVariantEdit,
        fetchProducts, saveProduct, deleteProduct, resetForm, prepareEdit,
        removeVariant,
        addProductConsumable, removeProductConsumable,
        addVariantConsumable, removeVariantConsumable,
        addIngredientToVariant, removeIngredientFromVariant
    }
}
</file>

<file path="frontend\src\composables\useStatistics.js">
import { ref } from 'vue'

export function useStatistics() {
  const orders = ref([])
  const loading = ref(true)
  
  // –î–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞ –¥–µ—Ç–∞–ª–µ–π
  const showDetailModal = ref(false)
  const selectedOrder = ref(null)

  const fetchOrders = async () => {
    loading.value = true
    try {
      const res = await fetch('/api/orders/')
      if (res.ok) {
        orders.value = await res.json()
      }
    } catch (err) {
      console.error("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:", err)
    } finally {
      loading.value = false
    }
  }

  const openDetails = (order) => {
    selectedOrder.value = order
    showDetailModal.value = true
  }

  const closeDetails = () => {
    showDetailModal.value = false
    selectedOrder.value = null
  }

  return {
    orders,
    loading,
    showDetailModal,
    selectedOrder,
    fetchOrders,
    openDetails,
    closeDetails
  }
}
</file>

<file path="frontend\src\composables\useWarehouse.js">
import { ref } from 'vue'

// –ì–ª–æ–±–∞–ª—å–Ω–∏–π —Å—Ç–∞–Ω
const products = ref([]) // <--- 1. –î–û–î–ê–ù–û: –°—Ö–æ–≤–∏—â–µ –¥–ª—è —Ç–æ–≤–∞—Ä—ñ–≤
const categories = ref([])
const units = ref([])
const ingredients = ref([])
const consumables = ref([])
const processGroups = ref([])
const recipes = ref([])
const loading = ref(false)

export function useWarehouse() {

  // –ü–µ—Ä–µ–π–º–µ–Ω—É–≤–∞–ª–∏ –Ω–∞ fetchWarehouseData –¥–ª—è —Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ –∑ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏
  const fetchWarehouseData = async () => {
    loading.value = true
    
    // –§—É–Ω–∫—Ü—ñ—è –±–µ–∑–ø–µ—á–Ω–æ–≥–æ –∑–∞–ø–∏—Ç—É
    const safeFetch = async (url) => {
      try {
        const res = await fetch(url)
        return res.ok ? await res.json() : []
      } catch (e) { 
        console.error(`Error fetching ${url}:`, e)
        return [] 
      }
    }

    console.log("üîÑ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö —Å–∫–ª–∞–¥—É...")

    // –ü–∞—Ä–∞–ª–µ–ª—å–Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤—Å—ñ—Ö –¥–æ–≤—ñ–¥–Ω–∏–∫—ñ–≤ + –¢–û–í–ê–†–Ü–í
    const results = await Promise.all([
      safeFetch('/api/categories/'),
      safeFetch('/api/units/'),
      safeFetch('/api/ingredients/'),
      safeFetch('/api/consumables/'),
      safeFetch('/api/processes/groups/'),
      safeFetch('/api/recipes/'),
      safeFetch('/api/products/') // <--- 2. –î–û–î–ê–ù–û: –ó–∞–ø–∏—Ç –Ω–∞ —Ç–æ–≤–∞—Ä–∏
    ])

    // –†–æ–∑–ø–æ–¥—ñ–ª—è—î–º–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏
    categories.value = results[0]
    units.value = results[1]
    ingredients.value = results[2]
    consumables.value = results[3]
    processGroups.value = results[4]
    recipes.value = results[5]
    products.value = results[6] // <--- 3. –î–û–î–ê–ù–û: –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ç–æ–≤–∞—Ä—ñ–≤

    console.log(`‚úÖ –î–∞–Ω—ñ –æ–Ω–æ–≤–ª–µ–Ω–æ. –¢–æ–≤–∞—Ä—ñ–≤: ${products.value.length}`)
    
    loading.value = false
  }

  // –£–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è
  const createItem = async (url, payload, refreshFn = fetchWarehouseData) => {
    try {
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
      if (res.ok) {
        await refreshFn() // –û–Ω–æ–≤–ª—é—î–º–æ —Å–ø–∏—Å–∫–∏
        return true
      }
      const err = await res.json()
      alert("–ü–æ–º–∏–ª–∫–∞: " + (err.detail || "–ù–µ –≤–¥–∞–ª–æ—Å—è —Å—Ç–≤–æ—Ä–∏—Ç–∏"))
      return false
    } catch (e) { 
      console.error(e)
      return false 
    }
  }

  // –£–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è
  const deleteItem = async (url, refreshFn = fetchWarehouseData) => {
    if(!confirm("–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ?")) return
    try {
      await fetch(url, { method: 'DELETE' })
      await refreshFn()
    } catch (e) { console.error(e) }
  }

  // –£–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è (PUT)
  const updateItem = async (url, payload, refreshFn = fetchWarehouseData) => {
    try {
      const res = await fetch(url, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
      
      if (res.ok) {
        await refreshFn()
        return true
      }
      
      const err = await res.json()
      alert("–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: " + (err.detail || "–©–æ—Å—å –ø—ñ—à–ª–æ –Ω–µ —Ç–∞–∫"))
      return false
    } catch (e) {
      console.error(e)
      alert("–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ")
      return false
    }
  }

  return {
    // –ï–∫—Å–ø–æ—Ä—Ç—É—î–º–æ products
    products, categories, units, ingredients, consumables, processGroups, recipes, loading,
    // –ï–∫—Å–ø–æ—Ä—Ç—É—î–º–æ –ø—Ä–∞–≤–∏–ª—å–Ω—É –Ω–∞–∑–≤—É —Ñ—É–Ω–∫—Ü—ñ—ó
    fetchWarehouseData, 
    // –ó–∞–ª–∏—à–∞—î–º–æ —Å—Ç–∞—Ä—É –Ω–∞–∑–≤—É —è–∫ –∞–ª—ñ–∞—Å –ø—Ä–æ –≤—Å—è–∫ –≤–∏–ø–∞–¥–æ–∫
    fetchData: fetchWarehouseData,
    createItem, deleteItem, updateItem
  }
}
</file>

<file path="order_service\Dockerfile">
FROM python:3.9-slim

WORKDIR /app

# –ö–æ–ø—ñ—é—î–º–æ requirements —ñ –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# --- –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø –¢–£–¢ ---
# –ö–æ–ø—ñ—é—î–º–æ –í–°–Ü —Ñ–∞–π–ª–∏ –∑ –ø–æ—Ç–æ—á–Ω–æ—ó –ø–∞–ø–∫–∏ (main.py, schemas.py —ñ —Ç.–¥.)
COPY . .

CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
</file>

<file path="order_service\main.py">
from fastapi import FastAPI, HTTPException
from fastapi.middleware.cors import CORSMiddleware
import redis
import os
import json
import uuid
from typing import List
from schemas import CartItemCreate, CartItem # –Ü–º–ø–æ—Ä—Ç—É—î–º–æ —Å—Ö–µ–º–∏

app = FastAPI()

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

REDIS_HOST = os.getenv("REDIS_HOST", "pos_redis")
REDIS_PORT = int(os.getenv("REDIS_PORT", 6379))

# decode_responses=True –µ–∫–æ–Ω–æ–º–∏—Ç—å –Ω–∞–º —á–∞—Å –Ω–∞ –¥–µ–∫–æ–¥—É–≤–∞–Ω–Ω—è –±–∞–π—Ç—ñ–≤
r = redis.Redis(host=REDIS_HOST, port=REDIS_PORT, db=0, decode_responses=True)
CART_KEY = "pos_cart_v2" # –ó–º—ñ–Ω–∏–º–æ –∫–ª—é—á, —â–æ–± –Ω–µ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—É–≤–∞—Ç–∏ –∑—ñ —Å—Ç–∞—Ä–∏–º

@app.get("/")
def read_root():
    return {"message": "Advanced Order Service is running!"}

# --- –û–¢–†–ò–ú–ê–¢–ò –ö–û–®–ò–ö ---
@app.get("/cart/", response_model=List[CartItem])
def get_cart():
    # –û—Ç—Ä–∏–º—É—î–º–æ –≤—Å—ñ –¥–∞–Ω—ñ –∑ —Ö–µ—à—É
    raw_data = r.hgetall(CART_KEY)
    cart_items = []
    
    for key, value in raw_data.items():
        try:
            item = json.loads(value)
            cart_items.append(item)
        except json.JSONDecodeError:
            continue
            
    return cart_items

# --- –î–û–î–ê–¢–ò –¢–û–í–ê–† ---
@app.post("/cart/add", response_model=CartItem)
def add_item(item_data: CartItemCreate):
    # –ì–µ–Ω–µ—Ä—É—î–º–æ —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π ID –¥–ª—è —Ü—å–æ–≥–æ –∑–∞–ø–∏—Å—É –≤ –∫–æ—à–∏–∫—É
    # –¶–µ –¥–æ–∑–≤–æ–ª—è—î –º–∞—Ç–∏ –¥–≤–∞ –æ–¥–Ω–∞–∫–æ–≤–∏—Ö —Ç–æ–≤–∞—Ä–∏ –∑ —Ä—ñ–∑–Ω–∏–º–∏ –º–æ–¥–∏—Ñ—ñ–∫–∞—Ç–æ—Ä–∞–º–∏
    cart_item_id = str(uuid.uuid4())
    
    new_item = CartItem(
        cart_item_id=cart_item_id,
        **item_data.dict()
    )
    
    # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ JSON –≤ Redis: Key=UUID, Value=JSON String
    r.hset(CART_KEY, cart_item_id, json.dumps(new_item.dict()))
    
    return new_item

# --- –ó–ú–Ü–ù–ò–¢–ò –ö–Ü–õ–¨–ö–Ü–°–¢–¨ (+/-) ---
@app.post("/cart/{cart_item_id}/update")
def update_quantity(cart_item_id: str, change: int):
    raw_json = r.hget(CART_KEY, cart_item_id)
    if not raw_json:
        raise HTTPException(status_code=404, detail="Item not found")
        
    item = json.loads(raw_json)
    new_qty = item['quantity'] + change
    
    if new_qty <= 0:
        # –Ø–∫—â–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å <= 0, –≤–∏–¥–∞–ª—è—î–º–æ
        r.hdel(CART_KEY, cart_item_id)
        return {"status": "removed", "cart_item_id": cart_item_id}
    else:
        # –û–Ω–æ–≤–ª—é—î–º–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å
        item['quantity'] = new_qty
        r.hset(CART_KEY, cart_item_id, json.dumps(item))
        return {"status": "updated", "quantity": new_qty}

# --- –í–ò–î–ê–õ–ò–¢–ò –¢–û–í–ê–† ---
@app.delete("/cart/{cart_item_id}")
def remove_item(cart_item_id: str):
    r.hdel(CART_KEY, cart_item_id)
    return {"status": "removed"}

# --- –û–ß–ò–°–¢–ò–¢–ò –ö–û–®–ò–ö ---
@app.delete("/cart/")
def clear_cart():
    r.delete(CART_KEY)
    return {"status": "cleared"}
</file>

<file path="order_service\requirements.txt">
fastapi
uvicorn
redis
pydantic

</file>

<file path="order_service\schemas.py">
from pydantic import BaseModel
from typing import List, Optional

class ModifierItem(BaseModel):
    modifier_id: int

class CartItemCreate(BaseModel):
    product_id: int
    variant_id: Optional[int] = None
    modifiers: List[ModifierItem] = []
    quantity: int = 1
    # –ú–∏ –ø–µ—Ä–µ–¥–∞—î–º–æ —Ü—ñ –¥–∞–Ω—ñ –∑ —Ñ—Ä–æ–Ω—Ç—É, —â–æ–± –∫–æ—à–∏–∫ –Ω–µ —Ä–æ–±–∏–≤ –∑–∞–ø–∏—Ç—ñ–≤ –¥–æ Product Service (—à–≤–∏–¥–∫–æ–¥—ñ—è)
    name: str 
    price: float

class CartItem(CartItemCreate):
    cart_item_id: str # –£–Ω—ñ–∫–∞–ª—å–Ω–∏–π ID —Å–∞–º–µ —Ü—å–æ–≥–æ —Ä—è–¥–∫–∞ –≤ –∫–æ—à–∏–∫—É (UUID)
</file>

<file path="product_service\Dockerfile">
FROM python:3.9-slim

WORKDIR /app

# –°–ø–æ—á–∞—Ç–∫—É –∫–æ–ø—ñ—é—î–º–æ –≤–∏–º–æ–≥–∏ —ñ —Å—Ç–∞–≤–∏–º–æ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ (—â–æ–± –∫–µ—à—É–≤–∞–ª–æ—Å—å)
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# –¢–ï–ü–ï–† –ö–û–ü–Ü–Æ–Ñ–ú–û –í–°–ï (–≤–∫–ª—é—á–∞—é—á–∏ models.py, schemas.py, database.py)
COPY . .

# –ó–∞–ø—É—Å–∫–∞—î–º–æ
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
</file>

<file path="product_service\database.py">
from sqlalchemy import create_engine
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker
import os

# –§–æ—Ä–º—É—î–º–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è: postgresql://user:password@hostname/dbname
# –¶—ñ –∑–º—ñ–Ω–Ω—ñ –º–∏ –ø—Ä–æ–ø–∏—Å–∞–ª–∏ –≤ docker-compose.yml —â–µ –Ω–∞ –ø–æ—á–∞—Ç–∫—É
USER = os.getenv("POSTGRES_USER", "user")
PASSWORD = os.getenv("POSTGRES_PASSWORD", "password")
DB_NAME = os.getenv("POSTGRES_DB", "products_db")
HOST = "pos_postgres" # –Ü–º'—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∑ –ë–î

SQLALCHEMY_DATABASE_URL = f"postgresql://{USER}:{PASSWORD}@{HOST}/{DB_NAME}"

# –°—Ç–≤–æ—Ä—é—î–º–æ –¥–≤–∏–≥—É–Ω (engine)
engine = create_engine(SQLALCHEMY_DATABASE_URL)

# –°—Ç–≤–æ—Ä—é—î–º–æ —Ñ–∞–±—Ä–∏–∫—É —Å–µ—Å—ñ–π (—á–µ—Ä–µ–∑ –Ω–µ—ó –º–∏ –±—É–¥–µ–º–æ —Ä–æ–±–∏—Ç–∏ –∑–∞–ø–∏—Ç–∏)
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)

# –ë–∞–∑–æ–≤–∏–π –∫–ª–∞—Å –¥–ª—è –≤—Å—ñ—Ö –Ω–∞—à–∏—Ö –º–∞–π–±—É—Ç–Ω—ñ—Ö —Ç–∞–±–ª–∏—Ü—å
Base = declarative_base()

# –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Å–µ—Å—ñ—ó (Dependency Injection)
def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()
</file>

<file path="product_service\main.py">
# FILE: product_service/main.py

from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
import database, models

# –Ü–º–ø–æ—Ä—Ç—É—î–º–æ –Ω–∞—à—ñ –Ω–æ–≤—ñ –º–æ–¥—É–ª—å–Ω—ñ —Ä–æ—É—Ç–µ—Ä–∏
from routers import (
    products, 
    inventory, 
    categories, 
    recipes, 
    processes, 
    customers, 
    orders
)

app = FastAPI(title="HITS POS Product Service", version="2.0.0")

# –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è CORS (–¥–æ–∑–≤–æ–ª—è—î–º–æ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥—É —Å—Ç—É–∫–∞—Ç–∏—Å—å —Å—é–¥–∏)
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—å –≤ –ë–î –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ (—è–∫—â–æ —ó—Ö –Ω–µ–º–∞—î)
models.Base.metadata.create_all(bind=database.engine)

# --- –ü–Ü–î–ö–õ–Æ–ß–ï–ù–ù–Ø –†–û–£–¢–ï–†–Ü–í ---
# –¢–µ–ø–µ—Ä –∫–æ–∂–µ–Ω —Ñ–∞–π–ª –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –∑–∞ —Å–≤—ñ–π —à–º–∞—Ç–æ–∫ URL
app.include_router(products.router)
app.include_router(orders.router)
app.include_router(inventory.router)   # /ingredients, /consumables, /units
app.include_router(categories.router)
app.include_router(recipes.router)
app.include_router(processes.router)
app.include_router(customers.router)

@app.get("/")
def read_root():
    return {
        "message": "Product Service is running", 
        "architecture": "Clean Architecture (Router-Service-Repository)",
        "status": "Healthy"
    }
</file>

<file path="product_service\models.py">
from sqlalchemy import Column, Integer, String, Float, ForeignKey, DateTime, Boolean, Table
from sqlalchemy.orm import relationship, backref
from database import Base
from datetime import datetime

# --- –ê–°–û–¶–Ü–ê–¢–ò–í–ù–ê –¢–ê–ë–õ–ò–¶–Ø: –¢–û–í–ê–† <-> –ì–†–£–ü–ò –ü–†–û–¶–ï–°–Ü–í ---
product_process_groups = Table(
    'product_process_groups_link', Base.metadata,
    Column('product_id', Integer, ForeignKey('products.id')),
    Column('process_group_id', Integer, ForeignKey('process_groups.id'))
)

# --- –ö–ê–¢–ï–ì–û–†–Ü–á ---
class Category(Base):
    __tablename__ = "categories"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, unique=True, index=True)
    slug = Column(String, unique=True)
    color = Column(String, default="#ffffff")
    parent_id = Column(Integer, ForeignKey("categories.id"), nullable=True)
    children = relationship("Category", backref=backref("parent", remote_side=[id]), cascade="all, delete-orphan")

# --- –û–î–ò–ù–ò–¶–Ü ---
class Unit(Base):
    __tablename__ = "units"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, unique=True)
    symbol = Column(String)

# --- –°–ö–õ–ê–î (–Ü–ù–ì–†–ï–î–Ü–Ñ–ù–¢–ò) ---
class Ingredient(Base):
    __tablename__ = "ingredients"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, index=True)
    cost_per_unit = Column(Float)
    stock_quantity = Column(Float, default=0.0)
    unit_id = Column(Integer, ForeignKey("units.id"))
    category_id = Column(Integer, ForeignKey("categories.id"), nullable=True)
    
    unit = relationship("Unit")
    category = relationship("Category")
    
# --- –°–ö–õ–ê–î (–í–ò–¢–†–ê–¢–ù–Ü –ú–ê–¢–ï–†–Ü–ê–õ–ò) ---
class Consumable(Base):
    __tablename__ = "consumables"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, index=True)
    cost_per_unit = Column(Float)
    stock_quantity = Column(Integer, default=0)
    
    category_id = Column(Integer, ForeignKey("categories.id"), nullable=True)
    unit_id = Column(Integer, ForeignKey("units.id"), nullable=True)
    
    category = relationship("Category")
    unit = relationship("Unit")

# --- –¢–ï–•–ù–û–õ–û–ì–Ü–ß–ù–Ü –ö–ê–†–¢–ò (–†–ï–¶–ï–ü–¢–ò) ---
class MasterRecipe(Base):
    __tablename__ = "master_recipes"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String)
    description = Column(String, nullable=True)
    items = relationship("MasterRecipeItem", back_populates="recipe", cascade="all, delete-orphan")

class MasterRecipeItem(Base):
    __tablename__ = "master_recipe_items"
    id = Column(Integer, primary_key=True, index=True)
    recipe_id = Column(Integer, ForeignKey("master_recipes.id"))
    ingredient_id = Column(Integer, ForeignKey("ingredients.id"))
    quantity = Column(Float) # –ö—ñ–ª—å–∫—ñ—Å—Ç—å (–≥ –∞–±–æ %)
    is_percentage = Column(Boolean, default=False) # True = % –≤—ñ–¥ –≤–∞–≥–∏ –≤–∏—Ö–æ–¥—É, False = –≥—Ä–∞–º–∏
    
    recipe = relationship("MasterRecipe", back_populates="items")
    ingredient = relationship("Ingredient")

# --- –ü–†–û–¶–ï–°–ò ---
class ProcessGroup(Base):
    __tablename__ = "process_groups"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String) # "–ü–æ–º–æ–ª", "–ú–æ–ª–æ–∫–æ"
    options = relationship("ProcessOption", back_populates="group", cascade="all, delete-orphan")

class ProcessOption(Base):
    __tablename__ = "process_options"
    id = Column(Integer, primary_key=True, index=True)
    group_id = Column(Integer, ForeignKey("process_groups.id"))
    name = Column(String) # "–î—Ä—ñ–±–Ω–∏–π", "–ó–µ—Ä–Ω–æ"
    group = relationship("ProcessGroup", back_populates="options")

# --- –ü–†–û–î–£–ö–¢–ò –¢–ê –í–ê–†–Ü–ê–ù–¢–ò ---

# –ó–≤'—è–∑–æ–∫ –¢–æ–≤–∞—Ä -> –í–∏—Ç—Ä–∞—Ç–Ω–∏–π –º–∞—Ç–µ—Ä—ñ–∞–ª (–°—Ç–∞–∫–∞–Ω—á–∏–∫)
class ProductConsumable(Base):
    __tablename__ = "product_consumables"
    product_id = Column(Integer, ForeignKey("products.id"), primary_key=True)
    consumable_id = Column(Integer, ForeignKey("consumables.id"), primary_key=True)
    quantity = Column(Float, default=1.0)
    
    product = relationship("Product", back_populates="consumables")
    consumable = relationship("Consumable")

# üî• –ù–û–í–ï: –ó–≤'—è–∑–æ–∫ –¢–æ–≤–∞—Ä -> –Ü–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç (–¥–ª—è –ø—Ä–æ—Å—Ç–∏—Ö —Ç–æ–≤–∞—Ä—ñ–≤)
class ProductIngredient(Base):
    __tablename__ = "product_ingredients"
    product_id = Column(Integer, ForeignKey("products.id"), primary_key=True)
    ingredient_id = Column(Integer, ForeignKey("ingredients.id"), primary_key=True)
    quantity = Column(Float) # –°–∫—ñ–ª—å–∫–∏ –≥—Ä–∞–º –π–¥–µ –Ω–∞ —Ü–µ–π —Ç–æ–≤–∞—Ä
    
    product = relationship("Product", back_populates="ingredients")
    ingredient = relationship("Ingredient")

class Product(Base):
    __tablename__ = "products"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, index=True)
    description = Column(String, nullable=True)
    price = Column(Float)
    category_id = Column(Integer, ForeignKey("categories.id"), nullable=True)
    
    # –ü—Ä–∞–ø–æ—Ä–µ—Ü—å: —á–∏ —î –≤–∞—Ä—ñ–∞–Ω—Ç–∏ (S/M/L) —á–∏ —Ü–µ –ø—Ä–æ—Å—Ç–∏–π —Ç–æ–≤–∞—Ä
    has_variants = Column(Boolean, default=False)
    
    # –î–ª—è –ø—Ä–æ—Å—Ç–∏—Ö —Ç–æ–≤–∞—Ä—ñ–≤:
    master_recipe_id = Column(Integer, ForeignKey("master_recipes.id"), nullable=True)
    output_weight = Column(Float, default=0.0) # –í–∞–≥–∞ –≥–æ—Ç–æ–≤–æ–≥–æ –≤–∏—Ä–æ–±—É (–¥–ª—è —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É %)
    
    # –°–∫–ª–∞–¥—Å—å–∫–∏–π –æ–±–ª—ñ–∫ –≥–æ—Ç–æ–≤–æ–≥–æ –≤–∏—Ä–æ–±—É (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –¥–µ—Å–µ—Ä—Ç–∏ –≤ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫—É)
    track_stock = Column(Boolean, default=False)
    stock_quantity = Column(Float, default=0.0)

    category = relationship("Category")
    master_recipe = relationship("MasterRecipe")
    
    variants = relationship("ProductVariant", back_populates="product", cascade="all, delete-orphan")
    modifier_groups = relationship("ProductModifierGroup", back_populates="product", cascade="all, delete-orphan")
    
    consumables = relationship("ProductConsumable", back_populates="product", cascade="all, delete-orphan")
    # üî• –ù–û–í–ï: –ó–≤'—è–∑–æ–∫ –∑ —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∞–º–∏
    ingredients = relationship("ProductIngredient", back_populates="product", cascade="all, delete-orphan")
    
    process_groups = relationship("ProcessGroup", secondary=product_process_groups)

class ProductVariant(Base):
    __tablename__ = "product_variants"
    id = Column(Integer, primary_key=True, index=True)
    product_id = Column(Integer, ForeignKey("products.id"))
    name = Column(String) # "S", "M", "L" –∞–±–æ "–ù–∞ –º–∏–≥–¥–∞–ª—å–Ω–æ–º—É"
    price = Column(Float)
    sku = Column(String, nullable=True)
    
    master_recipe_id = Column(Integer, ForeignKey("master_recipes.id"), nullable=True)
    output_weight = Column(Float, default=0.0)
    
    stock_quantity = Column(Float, default=0.0) # –Ø–∫—â–æ –≤–µ–¥–µ–º–æ –æ–±–ª—ñ–∫ –ø–æ –≤–∞—Ä—ñ–∞–Ω—Ç–∞—Ö

    product = relationship("Product", back_populates="variants")
    
    ingredients = relationship("ProductVariantIngredient", back_populates="variant", cascade="all, delete-orphan")
    consumables = relationship("ProductVariantConsumable", back_populates="variant", cascade="all, delete-orphan")

class ProductVariantIngredient(Base):
    __tablename__ = "product_variant_ingredients"
    variant_id = Column(Integer, ForeignKey("product_variants.id"), primary_key=True)
    ingredient_id = Column(Integer, ForeignKey("ingredients.id"), primary_key=True)
    quantity = Column(Float)
    
    variant = relationship("ProductVariant", back_populates="ingredients")
    ingredient = relationship("Ingredient")

class ProductVariantConsumable(Base):
    __tablename__ = "product_variant_consumables"
    variant_id = Column(Integer, ForeignKey("product_variants.id"), primary_key=True)
    consumable_id = Column(Integer, ForeignKey("consumables.id"), primary_key=True)
    quantity = Column(Integer, default=1)
    
    variant = relationship("ProductVariant", back_populates="consumables")
    consumable = relationship("Consumable")

# --- –ú–û–î–ò–§–Ü–ö–ê–¢–û–†–ò (–°–ò–†–û–ü–ò, –ú–û–õ–û–ö–û) ---
class ProductModifierGroup(Base):
    __tablename__ = "product_modifier_groups"
    id = Column(Integer, primary_key=True, index=True)
    product_id = Column(Integer, ForeignKey("products.id"))
    name = Column(String) # "–í–∏–±—ñ—Ä –º–æ–ª–æ–∫–∞", "–°–∏—Ä–æ–ø"
    is_required = Column(Boolean, default=False)
    
    product = relationship("Product", back_populates="modifier_groups")
    modifiers = relationship("Modifier", back_populates="group", cascade="all, delete-orphan")

class Modifier(Base):
    __tablename__ = "modifiers"
    id = Column(Integer, primary_key=True, index=True)
    group_id = Column(Integer, ForeignKey("product_modifier_groups.id"))
    name = Column(String) # "–ö–æ–∫–æ—Å–æ–≤–µ", "–ö–∞—Ä–∞–º–µ–ª—å–Ω–∏–π"
    price_change = Column(Float, default=0.0)
    
    # –©–æ —Å–ø–∏—Å—É–≤–∞—Ç–∏ –ø—Ä–∏ –≤–∏–±–æ—Ä—ñ —Ü—å–æ–≥–æ –º–æ–¥–∏—Ñ—ñ–∫–∞—Ç–æ—Ä–∞
    ingredient_id = Column(Integer, ForeignKey("ingredients.id"), nullable=True)
    quantity = Column(Float, default=0.0) # –°–∫—ñ–ª—å–∫–∏ —Å–ø–∏—Å—É–≤–∞—Ç–∏
    
    group = relationship("ProductModifierGroup", back_populates="modifiers")
    ingredient = relationship("Ingredient")

# --- –ó–ê–ú–û–í–õ–ï–ù–ù–Ø ---
class Order(Base):
    __tablename__ = "orders"
    id = Column(Integer, primary_key=True, index=True)
    created_at = Column(DateTime, default=datetime.utcnow)
    total_price = Column(Float)
    payment_method = Column(String)
    customer_id = Column(Integer, ForeignKey("customers.id"), nullable=True)
    customer = relationship("Customer")
    items = relationship("OrderItem", back_populates="order", cascade="all, delete-orphan")

class OrderItem(Base):
    __tablename__ = "order_items"
    id = Column(Integer, primary_key=True, index=True)
    order_id = Column(Integer, ForeignKey("orders.id"))
    product_name = Column(String)
    quantity = Column(Integer)
    price_at_moment = Column(Float)
    details = Column(String, nullable=True) 
    order = relationship("Order", back_populates="items")

# --- –Ü–°–¢–û–†–Ü–Ø –†–£–•–£ –¢–û–í–ê–†–Ü–í (TRANSACTIONS) ---
class InventoryTransaction(Base):
    __tablename__ = "inventory_transactions"

    id = Column(Integer, primary_key=True, index=True)
    entity_type = Column(String, index=True) 
    entity_id = Column(Integer, index=True)
    entity_name = Column(String)
    change_amount = Column(Float)
    balance_after = Column(Float)
    reason = Column(String)
    created_at = Column(DateTime, default=datetime.utcnow)

# --- –ö–õ–Ü–Ñ–ù–¢–ò (CRM) ---
class Customer(Base):
    __tablename__ = "customers"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String)
    phone = Column(String, unique=True, index=True)
    email = Column(String, nullable=True)
    notes = Column(String, nullable=True)
    created_at = Column(DateTime, default=datetime.utcnow)
</file>

<file path="product_service\requirements.txt">
fastapi
uvicorn
sqlalchemy
psycopg2-binary
pydantic
pytest==8.0.0
httpx==0.26.0
</file>

<file path="product_service\schemas.py">
from pydantic import BaseModel, Field
from typing import List, Optional
from datetime import datetime

# --- BASIC ---
class Category(BaseModel):
    id: int
    name: str
    slug: str
    color: Optional[str] = "#ffffff"
    parent_id: Optional[int] = None
    class Config: from_attributes = True

class CategoryCreate(BaseModel):
    name: str
    slug: str
    color: Optional[str] = "#ffffff"
    parent_id: Optional[int] = None

class Unit(BaseModel):
    id: int
    name: str
    symbol: str
    class Config: from_attributes = True
class UnitCreate(BaseModel):
    name: str
    symbol: str

class IngredientCreate(BaseModel):
    name: str
    cost_per_unit: float
    stock_quantity: float
    unit_id: int
    category_id: Optional[int] = None 

class Ingredient(BaseModel):
    id: int
    name: str
    cost_per_unit: float
    stock_quantity: float
    unit_id: Optional[int] = None
    unit: Optional[Unit] = None
    category_id: Optional[int] = None
    category: Optional[Category] = None
    class Config: from_attributes = True

# --- CONSUMABLES ---
class ConsumableBase(BaseModel):
    name: str
    cost_per_unit: float
    stock_quantity: int

class ConsumableCreate(ConsumableBase):
    category_id: Optional[int] = None 
    unit_id: Optional[int] = None

class Consumable(ConsumableBase):
    id: int
    category_id: Optional[int] = None
    category: Optional[Category] = None
    unit_id: Optional[int] = None
    unit: Optional[Unit] = None
    class Config: from_attributes = True

# --- LINKS (–ó–≤'—è–∑–∫–∏) ---

# üî• FIX: –î–æ–¥–∞—î–º–æ extra='ignore', —â–æ–± –Ω–µ –ø–∞–¥–∞—Ç–∏ –≤—ñ–¥ –∑–∞–π–≤–∏—Ö –ø–æ–ª—ñ–≤ –∑ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥—É (name, id...)
class ProductIngredientLink(BaseModel):
    ingredient_id: int
    quantity: float
    class Config:
        extra = 'ignore' 

class ProductIngredientRead(BaseModel):
    ingredient_id: int
    quantity: float
    ingredient_name: Optional[str] = None
    # üî• FIX: –î–æ–¥–∞—î–º–æ –ø–æ–ª–µ name –¥–ª—è —Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ –∑ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º
    name: Optional[str] = Field(default=None, alias="ingredient_name") 
    
    class Config: 
        from_attributes = True
        populate_by_name = True # –î–æ–∑–≤–æ–ª—è—î –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ alias

class ProductConsumableLink(BaseModel):
    consumable_id: int
    quantity: float = 1.0
    class Config:
        extra = 'ignore'

class ProductConsumableRead(BaseModel):
    consumable_id: int
    quantity: float
    consumable_name: Optional[str] = None
    # üî• FIX: –î–æ–¥–∞—î–º–æ –ø–æ–ª–µ name –¥–ª—è —Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ –∑ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º
    name: Optional[str] = Field(default=None, alias="consumable_name")

    class Config: 
        from_attributes = True
        populate_by_name = True

# --- –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä ---
class ProductCostCheck(BaseModel):
    master_recipe_id: Optional[int] = None
    output_weight: float = 0.0
    ingredients: List[ProductIngredientLink] = []
    consumables: List[ProductConsumableLink] = []

# --- PROCESSES ---
class ProcessOptionCreate(BaseModel):
    name: str 
class ProcessOption(ProcessOptionCreate):
    id: int
    group_id: int
    class Config: from_attributes = True

class ProcessGroupCreate(BaseModel):
    name: str 
    options: List[ProcessOptionCreate] = []

class ProcessGroup(BaseModel):
    id: int
    name: str
    options: List[ProcessOption] = []
    class Config: from_attributes = True

# --- MASTER RECIPES ---
class MasterRecipeItemCreate(BaseModel):
    ingredient_id: int
    quantity: float
    is_percentage: bool = False 

class MasterRecipeItem(MasterRecipeItemCreate):
    id: int
    ingredient_name: Optional[str] = None 
    class Config: from_attributes = True

class MasterRecipeCreate(BaseModel):
    name: str
    description: Optional[str] = None
    items: List[MasterRecipeItemCreate] = []

class MasterRecipe(MasterRecipeCreate):
    id: int
    items: List[MasterRecipeItem] = []
    class Config: from_attributes = True

# --- MODIFIERS ---
class ModifierCreate(BaseModel):
    name: str
    price_change: float = 0.0
    ingredient_id: Optional[int] = None
    quantity: float = 0.0
class Modifier(ModifierCreate):
    id: int
    class Config: from_attributes = True
class ModifierGroupCreate(BaseModel):
    name: str
    is_required: bool = False
    modifiers: List[ModifierCreate] = []
class ModifierGroup(ModifierGroupCreate):
    id: int
    modifiers: List[Modifier] = []
    class Config: from_attributes = True

# --- VARIANTS ---
class VariantCreate(BaseModel):
    name: str
    price: float
    sku: Optional[str] = None
    output_weight: float = 0.0
    master_recipe_id: Optional[int] = None
    stock_quantity: float = 0.0
    consumables: List[ProductConsumableLink] = []
    ingredients: List[ProductIngredientLink] = []
    # üî• FIX: –Ü–≥–Ω–æ—Ä—É—î–º–æ –∑–∞–π–≤—ñ –ø–æ–ª—è –ø—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ/–æ–Ω–æ–≤–ª–µ–Ω–Ω—ñ
    class Config: extra = 'ignore'

class Variant(VariantCreate):
    id: int
    # –¢—É—Ç –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ Read —Å—Ö–µ–º–∏, —è–∫—ñ —Ç–µ–ø–µ—Ä –º–∞—é—Ç—å –ø–æ–ª–µ 'name'
    consumables: List[ProductConsumableRead] = []
    ingredients: List[ProductIngredientRead] = []
    cost_price: float = 0.0
    margin: float = 0.0
    class Config: from_attributes = True

# --- PRODUCTS ---
class ProductBase(BaseModel):
    name: str
    description: Optional[str] = None
    category_id: Optional[int] = None
    has_variants: bool = False
    price: float = 0.0 
    output_weight: float = 0.0 
    master_recipe_id: Optional[int] = None
    track_stock: bool = False
    stock_quantity: float = 0.0

class ProductCreate(ProductBase):
    variants: List[VariantCreate] = []
    modifier_groups: List[ModifierGroupCreate] = []
    consumables: List[ProductConsumableLink] = []
    ingredients: List[ProductIngredientLink] = []
    process_group_ids: List[int] = [] 
    # üî• FIX: –Ü–≥–Ω–æ—Ä—É—î–º–æ cost_price, margin —Ç–∞ —ñ–Ω—à—ñ –ø–æ–ª—è –∑ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥—É
    class Config: extra = 'ignore'

class ProductUpdate(ProductBase):
    pass

class Product(ProductBase):
    id: int
    category: Optional[Category] = None
    variants: List[Variant] = [] 
    modifier_groups: List[ModifierGroup] = []
    master_recipe: Optional[MasterRecipe] = None
    
    consumables: List[ProductConsumableRead] = [] 
    ingredients: List[ProductIngredientRead] = []
    
    cost_price: float = 0.0
    margin: float = 0.0
    process_groups: List[ProcessGroup] = []

    class Config: from_attributes = True

# --- DEDUCTION & INVENTORY ---
class StockDeductionItem(BaseModel):
    product_id: int
    variant_id: Optional[int] = None
    quantity: float
    order_id: int

class InventoryTransactionRead(BaseModel):
    id: int
    entity_type: str
    entity_id: int
    entity_name: str
    change_amount: float
    balance_after: float
    reason: str
    created_at: datetime
    class Config: from_attributes = True

# --- ORDERS ---
class SoldItemModifier(BaseModel):
    modifier_id: int
    class Config: extra = 'ignore' # –ù–∞ –≤—Å—è–∫ –≤–∏–ø–∞–¥–æ–∫

class SoldItem(BaseModel):
    product_id: int
    variant_id: Optional[int] = None
    modifiers: List[SoldItemModifier] = []
    quantity: int

class OrderCreate(BaseModel):
    items: List[SoldItem]
    payment_method: str
    customer_id: Optional[int] = None
    class Config: extra = 'ignore'

class CustomerCreate(BaseModel):
    name: str
    phone: str
    email: Optional[str] = None
    notes: Optional[str] = None
class Customer(CustomerCreate):
    id: int
    class Config: from_attributes = True

class OrderItemRead(BaseModel):
    product_name: str
    quantity: int
    price_at_moment: float
    details: Optional[str] = None
    class Config: from_attributes = True

class OrderRead(BaseModel):
    id: int
    created_at: datetime
    total_price: float
    payment_method: str
    items: List[OrderItemRead]
    customer: Optional[Customer] = None
    class Config: from_attributes = True
</file>

<file path="product_service\routers\__init__.py">

</file>

<file path="product_service\routers\categories.py">
from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from typing import List
import database, schemas, models

router = APIRouter(prefix="/categories", tags=["Categories"])

@router.post("/", response_model=schemas.Category)
def create_category(category: schemas.CategoryCreate, db: Session = Depends(database.get_db)):
    # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –Ω–∞ –¥—É–±–ª—ñ–∫–∞—Ç
    db_category = db.query(models.Category).filter(models.Category.name == category.name).first()
    if db_category: 
        raise HTTPException(status_code=400, detail="Category already exists")
    
    # –°—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤—É
    new_category = models.Category(
        name=category.name, 
        slug=category.slug, 
        color=category.color, 
        parent_id=category.parent_id
    )
    db.add(new_category)
    db.commit()
    db.refresh(new_category)
    return new_category

@router.get("/", response_model=List[schemas.Category])
def read_categories(skip: int = 0, limit: int = 100, db: Session = Depends(database.get_db)):
    return db.query(models.Category).offset(skip).limit(limit).all()

# !!! –ù–û–í–ï: –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó !!!
@router.put("/{category_id}", response_model=schemas.Category)
def update_category(category_id: int, category_data: schemas.CategoryCreate, db: Session = Depends(database.get_db)):
    db_category = db.query(models.Category).filter(models.Category.id == category_id).first()
    if not db_category:
        raise HTTPException(status_code=404, detail="Category not found")
    
    # –û–Ω–æ–≤–ª—é—î–º–æ –ø–æ–ª—è
    db_category.name = category_data.name
    db_category.slug = category_data.slug
    db_category.color = category_data.color
    
    # –ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ —Ü–∏–∫–ª—ñ—á–Ω–æ—Å—Ç—ñ (–∫–∞—Ç–µ–≥–æ—Ä—ñ—è –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ –±–∞—Ç—å–∫–æ–º —Å–∞–º–∞ —Å–æ–±—ñ)
    if category_data.parent_id == category_id:
         raise HTTPException(status_code=400, detail="Category cannot be its own parent")
         
    db_category.parent_id = category_data.parent_id

    db.commit()
    db.refresh(db_category)
    return db_category

# !!! –ù–û–í–ï: –í–∏–¥–∞–ª–µ–Ω–Ω—è –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó !!!
@router.delete("/{category_id}")
def delete_category(category_id: int, db: Session = Depends(database.get_db)):
    db_category = db.query(models.Category).filter(models.Category.id == category_id).first()
    if not db_category:
        raise HTTPException(status_code=404, detail="Category not found")
    
    db.delete(db_category)
    db.commit()
    return {"status": "deleted"}
</file>

<file path="product_service\routers\customers.py">
# FILE: product_service/routers/customers.py

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from sqlalchemy import or_
from typing import List
import database, schemas, models

router = APIRouter(prefix="/customers", tags=["Customers"])

@router.post("/", response_model=schemas.Customer)
def create_customer(customer: schemas.CustomerCreate, db: Session = Depends(database.get_db)):
    # –ú–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É –Ω–∞ —É–Ω—ñ–∫–∞–ª—å–Ω—ñ—Å—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω—É
    new_customer = models.Customer(**customer.dict())
    db.add(new_customer); db.commit(); db.refresh(new_customer)
    return new_customer

@router.get("/search/", response_model=List[schemas.Customer])
def search_customers(q: str, db: Session = Depends(database.get_db)):
    # –ü–æ—à—É–∫ –∑–∞ —ñ–º'—è–º –ê–ë–û —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º (ilike - —Ä–µ–≥—ñ—Å—Ç—Ä–æ–Ω–µ–∑–∞–ª–µ–∂–Ω–∏–π)
    return db.query(models.Customer).filter(
        or_(models.Customer.name.ilike(f"%{q}%"), models.Customer.phone.ilike(f"%{q}%"))
    ).limit(10).all()

@router.get("/", response_model=List[schemas.Customer])
def read_customers(skip: int=0, limit: int=50, db: Session = Depends(database.get_db)):
    return db.query(models.Customer).offset(skip).limit(limit).all()

@router.put("/{id}", response_model=schemas.Customer)
def update_customer(id: int, data: schemas.CustomerCreate, db: Session = Depends(database.get_db)):
    c = db.query(models.Customer).filter(models.Customer.id == id).first()
    if not c: raise HTTPException(status_code=404)
    c.name = data.name
    c.phone = data.phone
    c.email = data.email
    c.notes = data.notes
    db.commit(); db.refresh(c)
    return c

@router.delete("/{id}")
def delete_customer(id: int, db: Session = Depends(database.get_db)): 
    c = db.query(models.Customer).filter(models.Customer.id==id).first()
    if c: db.delete(c); db.commit()
    return {"status": "deleted"}

@router.get("/{customer_id}/orders/", response_model=List[schemas.OrderRead])
def read_customer_orders(customer_id: int, db: Session = Depends(database.get_db)):
    return db.query(models.Order).filter(models.Order.customer_id == customer_id).order_by(models.Order.created_at.desc()).all()
</file>

<file path="product_service\routers\inventory.py">
# FILE: product_service/routers/inventory.py

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from sqlalchemy import or_, desc
from typing import List
import database, schemas, models
from services.inventory_logger import InventoryLogger

router = APIRouter(tags=["Inventory"])

# --- UNITS (–û–¥–∏–Ω–∏—Ü—ñ –≤–∏–º—ñ—Ä—É) ---
@router.post("/units/", response_model=schemas.Unit)
def create_unit(unit: schemas.UnitCreate, db: Session = Depends(database.get_db)):
    exists = db.query(models.Unit).filter(or_(models.Unit.name == unit.name, models.Unit.symbol == unit.symbol)).first()
    if exists: raise HTTPException(status_code=400, detail="–û–¥–∏–Ω–∏—Ü—è —ñ—Å–Ω—É—î")
    db_unit = models.Unit(name=unit.name, symbol=unit.symbol)
    db.add(db_unit); db.commit(); db.refresh(db_unit)
    return db_unit

@router.get("/units/", response_model=List[schemas.Unit])
def read_units(db: Session = Depends(database.get_db)):
    return db.query(models.Unit).all()

# --- INGREDIENTS (–°–∏—Ä–æ–≤–∏–Ω–∞) ---
@router.post("/ingredients/", response_model=schemas.Ingredient)
def create_ingredient(ingredient: schemas.IngredientCreate, db: Session = Depends(database.get_db)):
    exists = db.query(models.Ingredient).filter(models.Ingredient.name == ingredient.name).first()
    if exists: raise HTTPException(status_code=400, detail="Ingredient already exists")
    new_item = models.Ingredient(**ingredient.dict())
    db.add(new_item); db.commit(); db.refresh(new_item)
    return new_item

@router.get("/ingredients/", response_model=List[schemas.Ingredient])
def read_ingredients(db: Session = Depends(database.get_db)):
    return db.query(models.Ingredient).all()

@router.put("/ingredients/{ingredient_id}", response_model=schemas.Ingredient)
def update_ingredient(ingredient_id: int, ingredient_data: schemas.IngredientCreate, db: Session = Depends(database.get_db)):
    db_ingredient = db.query(models.Ingredient).filter(models.Ingredient.id == ingredient_id).first()
    if not db_ingredient: raise HTTPException(status_code=404, detail="Ingredient not found")
    
    # 1. –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Å—Ç–∞—Ä–∏–π –±–∞–ª–∞–Ω—Å
    old_balance = db_ingredient.stock_quantity
    
    # 2. –û–Ω–æ–≤–ª—é—î–º–æ –ø–æ–ª—è
    db_ingredient.name = ingredient_data.name
    db_ingredient.unit_id = ingredient_data.unit_id
    db_ingredient.cost_per_unit = ingredient_data.cost_per_unit
    
    # 3. –Ø–∫—â–æ –∑–∞–ª–∏—à–æ–∫ –∑–º—ñ–Ω–∏–≤—Å—è - –ø–∏—à–µ–º–æ —Ü–µ
    if ingredient_data.stock_quantity != old_balance:
        db_ingredient.stock_quantity = ingredient_data.stock_quantity
        # –õ–û–ì–£–í–ê–ù–ù–Ø
        InventoryLogger.log(
            db, 
            entity_type="ingredient", 
            entity_id=db_ingredient.id, 
            entity_name=db_ingredient.name, 
            balance_before=old_balance, 
            balance_after=db_ingredient.stock_quantity, 
            reason="manual_correction"
        )
    
    db.commit(); db.refresh(db_ingredient)
    return db_ingredient

@router.delete("/ingredients/{ingredient_id}")
def delete_ingredient(ingredient_id: int, db: Session = Depends(database.get_db)):
    db_ingredient = db.query(models.Ingredient).filter(models.Ingredient.id == ingredient_id).first()
    if not db_ingredient: raise HTTPException(status_code=404)
    try: 
        db.delete(db_ingredient); db.commit()
    except: 
        db.rollback(); raise HTTPException(status_code=400, detail="–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –≤ —Ä–µ—Ü–µ–ø—Ç–∞—Ö")
    return {"status": "deleted"}

# --- CONSUMABLES (–í–∏—Ç—Ä–∞—Ç–Ω—ñ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏) ---
@router.post("/consumables/", response_model=schemas.Consumable)
def create_consumable(item: schemas.ConsumableCreate, db: Session = Depends(database.get_db)):
    exists = db.query(models.Consumable).filter(models.Consumable.name == item.name).first()
    if exists: raise HTTPException(status_code=400, detail="–í–∂–µ —ñ—Å–Ω—É—î")
    new_c = models.Consumable(**item.dict())
    db.add(new_c); db.commit(); db.refresh(new_c)
    return new_c

@router.get("/consumables/", response_model=List[schemas.Consumable])
def read_consumables(db: Session = Depends(database.get_db)):
    return db.query(models.Consumable).all()

@router.put("/consumables/{id}", response_model=schemas.Consumable)
def update_consumable(id: int, item: schemas.ConsumableCreate, db: Session = Depends(database.get_db)):
    db_c = db.query(models.Consumable).filter(models.Consumable.id == id).first()
    if not db_c: raise HTTPException(status_code=404)
    
    old_balance = db_c.stock_quantity # <-- –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Å—Ç–∞—Ä–µ

    # –û–Ω–æ–≤–ª—é—î–º–æ –≤—Å–µ
    for k, v in item.dict().items(): setattr(db_c, k, v)
    
    # –õ–û–ì–£–í–ê–ù–ù–Ø
    InventoryLogger.log(
        db,
        entity_type="consumable",
        entity_id=db_c.id,
        entity_name=db_c.name,
        balance_before=old_balance,
        balance_after=db_c.stock_quantity,
        reason="manual_correction"
    )
    

    db.commit(); db.refresh(db_c)
    return db_c

@router.delete("/consumables/{id}")
def delete_consumable(id: int, db: Session = Depends(database.get_db)):
    db_c = db.query(models.Consumable).filter(models.Consumable.id == id).first()
    if not db_c: raise HTTPException(status_code=404)
    db.delete(db_c); db.commit()
    return {"status": "deleted"}

# === –î–û–î–ê–¢–ò –í –ö–Ü–ù–ï–¶–¨ –§–ê–ô–õ–£ inventory.py ===

# === –Ü–°–¢–û–†–Ü–Ø –†–£–•–£ ===
# === –Ü–°–¢–û–†–Ü–Ø –†–£–•–£ ===
@router.get("/history/", response_model=List[schemas.InventoryTransactionRead])
def get_inventory_history(
    entity_type: str = None, 
    entity_id: int = None, 
    limit: int = 50, 
    db: Session = Depends(database.get_db)
):
    # --- –î–Ü–ê–ì–ù–û–°–¢–ò–ß–ù–ò–ô –ü–†–Ü–ù–¢ ---
    print(f"\n[HISTORY REQUEST] Searching for: Type={entity_type}, ID={entity_id}")
    
    query = db.query(models.InventoryTransaction)
    
    if entity_type:
        query = query.filter(models.InventoryTransaction.entity_type == entity_type)
    if entity_id:
        query = query.filter(models.InventoryTransaction.entity_id == entity_id)
    
    results = query.order_by(desc(models.InventoryTransaction.created_at)).limit(limit).all()
    
    print(f"[HISTORY RESULT] Found {len(results)} records.\n")
    return results

</file>

<file path="product_service\routers\orders.py">
from fastapi import APIRouter, Depends
from sqlalchemy.orm import Session
from typing import List
import database, schemas, models
from services.order_service import OrderService

router = APIRouter(prefix="/orders", tags=["Orders"])

@router.post("/checkout/")
def checkout(order_data: schemas.OrderCreate, db: Session = Depends(database.get_db)):
    # –í—Å—è –ª–æ–≥—ñ–∫–∞ —Ç–µ–ø–µ—Ä —Ç—É—Ç üëá
    new_order = OrderService.process_checkout(db, order_data)
    # –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ ID —Ç–∞ –ø–æ—Ä–∞—Ö–æ–≤–∞–Ω—É —Ü—ñ–Ω—É
    return {
        "status": "ok", 
        "order_id": new_order.id, 
        "total_price": new_order.total_price
    }

@router.get("/", response_model=List[schemas.OrderRead])
def get_orders(skip: int = 0, limit: int = 50, db: Session = Depends(database.get_db)):
    return db.query(models.Order).order_by(models.Order.created_at.desc()).offset(skip).limit(limit).all()
</file>

<file path="product_service\routers\processes.py">
# FILE: product_service/routers/processes.py

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from typing import List
import database, schemas, models

router = APIRouter(prefix="/processes", tags=["Processes"])

# --- –ì—Ä—É–ø–∏ (–Ω–∞–ø—Ä. –ü–æ–º–æ–ª) ---
@router.post("/groups/", response_model=schemas.ProcessGroup)
def create_process_group(group: schemas.ProcessGroupCreate, db: Session = Depends(database.get_db)):
    new_group = models.ProcessGroup(name=group.name)
    db.add(new_group); db.commit(); db.refresh(new_group)
    
    for opt in group.options:
        db.add(models.ProcessOption(group_id=new_group.id, name=opt.name))
    
    db.commit(); db.refresh(new_group)
    return new_group

@router.get("/groups/", response_model=List[schemas.ProcessGroup])
def read_process_groups(db: Session = Depends(database.get_db)):
    return db.query(models.ProcessGroup).all()

@router.delete("/groups/{id}")
def delete_process_group(id: int, db: Session = Depends(database.get_db)):
    group = db.query(models.ProcessGroup).filter(models.ProcessGroup.id == id).first()
    if not group: raise HTTPException(status_code=404)
    db.delete(group); db.commit()
    return {"status": "deleted"}

# --- –û–ø—Ü—ñ—ó (–Ω–∞–ø—Ä. –ü—ñ–¥ —Ç—É—Ä–∫—É) ---
@router.post("/options/", response_model=schemas.ProcessOption)
def add_process_option(option: schemas.ProcessOptionCreate, group_id: int, db: Session = Depends(database.get_db)):
    new_opt = models.ProcessOption(group_id=group_id, name=option.name)
    db.add(new_opt); db.commit(); db.refresh(new_opt)
    return new_opt

@router.delete("/options/{id}")
def delete_process_option(id: int, db: Session = Depends(database.get_db)):
    opt = db.query(models.ProcessOption).filter(models.ProcessOption.id == id).first()
    if not opt: raise HTTPException(status_code=404)
    db.delete(opt); db.commit()
    return {"status": "deleted"}
</file>

<file path="product_service\routers\products.py">
# FILE: product_service/routers/products.py

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session, joinedload
from typing import List
import database, schemas, models
from services.product_service import ProductService
from services.inventory_logger import InventoryLogger

router = APIRouter(prefix="/products", tags=["Products"])

# --- –ö–ê–õ–¨–ö–£–õ–Ø–¢–û–† –°–û–ë–Ü–í–ê–†–¢–û–°–¢–Ü ---
@router.post("/calculate-cost")
def calculate_cost(data: schemas.ProductCostCheck, db: Session = Depends(database.get_db)):
    """
    –†–∞—Ö—É—î —Å–æ–±—ñ–≤–∞—Ä—Ç—ñ—Å—Ç—å —Ç–æ–≤–∞—Ä—É "–Ω–∞ –ª—å–æ—Ç—É".
    """
    cost = ProductService.calculate_product_cost(db, data)
    return {"total_cost": cost}

# --- CRUD –û–ü–ï–†–ê–¶–Ü–á ---

@router.post("/", response_model=schemas.Product)
def create_product(product: schemas.ProductCreate, db: Session = Depends(database.get_db)):
    return ProductService.create_product(db, product)

@router.put("/{product_id}", response_model=schemas.Product)
def update_product(product_id: int, product_data: schemas.ProductCreate, db: Session = Depends(database.get_db)):
    updated_product = ProductService.update_product(db, product_id, product_data)
    if not updated_product:
        raise HTTPException(status_code=404, detail="Product not found")
    return updated_product

@router.get("/", response_model=List[schemas.Product])
def read_products(db: Session = Depends(database.get_db)):
    products = db.query(models.Product).all()
    # –î–æ–∑–∞–ø–æ–≤–Ω—é—î–º–æ –Ω–∞–∑–≤–∏ –¥–ª—è UI
    for p in products:
        for c in p.consumables:
            if c.consumable: c.consumable_name = c.consumable.name
        for i in p.ingredients:
            if i.ingredient: i.ingredient_name = i.ingredient.name
        for v in p.variants:
            for vc in v.consumables:
                if vc.consumable: vc.consumable_name = vc.consumable.name
            if hasattr(v, 'ingredients'):
                 for vi in v.ingredients:
                     if vi.ingredient: vi.ingredient_name = vi.ingredient.name
    return products

@router.get("/{product_id}", response_model=schemas.Product)
def read_product(product_id: int, db: Session = Depends(database.get_db)):
    p = db.query(models.Product).filter(models.Product.id == product_id).first()
    if p is None:
        raise HTTPException(status_code=404, detail="Product not found")
    
    for c in p.consumables:
        if c.consumable: c.consumable_name = c.consumable.name
    for i in p.ingredients:
        if i.ingredient: i.ingredient_name = i.ingredient.name
    for v in p.variants:
        for vc in v.consumables:
            if vc.consumable: vc.consumable_name = vc.consumable.name
        if hasattr(v, 'ingredients'):
             for vi in v.ingredients:
                 if vi.ingredient: vi.ingredient_name = vi.ingredient.name
    return p

@router.delete("/{product_id}")
def delete_product(product_id: int, db: Session = Depends(database.get_db)):
    product = db.query(models.Product).filter(models.Product.id == product_id).first()
    if not product:
        raise HTTPException(status_code=404, detail="Product not found")
    
    db.query(models.ProductVariant).filter(models.ProductVariant.product_id == product_id).delete()
    db.query(models.ProductModifierGroup).filter(models.ProductModifierGroup.product_id == product_id).delete()
    db.query(models.ProductConsumable).filter(models.ProductConsumable.product_id == product_id).delete()
    db.query(models.ProductIngredient).filter(models.ProductIngredient.product_id == product_id).delete()
    
    db.delete(product)
    db.commit()
    return {"status": "deleted"}

@router.post("/{product_id}/stock")
def update_stock(product_id: int, qty: float, db: Session = Depends(database.get_db)):
    product = db.query(models.Product).filter(models.Product.id == product_id).first()
    if not product:
        raise HTTPException(status_code=404, detail="Product not found")
    
    old_qty = product.stock_quantity
    product.stock_quantity = qty
    InventoryLogger.log(
        db, "product", product.id, product.name, 
        old_qty, qty, "manual_correction"
    )
    db.commit()
    return {"status": "updated", "new_quantity": qty}

# üî• –§–Ü–ù–ê–õ–¨–ù–ò–ô –í–ê–†–Ü–ê–ù–¢ –°–ü–ò–°–ê–ù–ù–Ø (HARDCORE MODE) üî•
@router.post("/deduct_stock_for_order")
def deduct_stock_for_order(items: List[schemas.StockDeductionItem], db: Session = Depends(database.get_db)):
    print(f"üì¶ [DEDUCT] –û—Ç—Ä–∏–º–∞–Ω–æ –∑–∞–ø–∏—Ç: {len(items)} –ø–æ–∑–∏—Ü—ñ–π")
    
    for item in items:
        # === 1. –í–ê–†–Ü–ê–ù–¢–ò (–¢–£–¢ –í–°–ï –ü–†–ê–¶–Æ–í–ê–õ–û, –ó–ê–õ–ò–®–ê–Ñ–ú–û –Ø–ö –Ñ) ===
        if item.variant_id is not None:
            variant_id = item.variant_id
            print(f"  üîπ –í–∞—Ä—ñ–∞–Ω—Ç ID: {variant_id}")

            variant = db.query(models.ProductVariant).options(
                joinedload(models.ProductVariant.ingredients).joinedload(models.ProductVariantIngredient.ingredient),
                joinedload(models.ProductVariant.consumables).joinedload(models.ProductVariantConsumable.consumable),
                joinedload(models.ProductVariant.product)
            ).filter(models.ProductVariant.id == variant_id).first()

            if variant:
                # –ê. –°–ø–∏—Å–∞–Ω–Ω—è –≤–∞—Ä—ñ–∞–Ω—Ç—É
                old_v = variant.stock_quantity
                variant.stock_quantity -= item.quantity
                InventoryLogger.log(
                    db, "product_variant", variant.id, 
                    f"{variant.product.name} ({variant.name})", 
                    old_v, variant.stock_quantity, 
                    f"sale_order_{item.order_id}"
                )

                # –ë. –Ü–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∏ –≤–∞—Ä—ñ–∞–Ω—Ç—É
                for link in variant.ingredients:
                    if link.ingredient:
                        deduct = link.quantity * item.quantity
                        old_ing = link.ingredient.stock_quantity
                        link.ingredient.stock_quantity -= deduct
                        InventoryLogger.log(
                            db, "ingredient", link.ingredient.id, link.ingredient.name,
                            old_ing, link.ingredient.stock_quantity,
                            f"sale_order_{item.order_id}_var_{variant.id}"
                        )
                
                # –í. –ú–∞—Ç–µ—Ä—ñ–∞–ª–∏ –≤–∞—Ä—ñ–∞–Ω—Ç—É
                for link in variant.consumables:
                    if link.consumable:
                        deduct = link.quantity * item.quantity
                        old_cons = link.consumable.stock_quantity
                        link.consumable.stock_quantity -= deduct
                        InventoryLogger.log(
                            db, "consumable", link.consumable.id, link.consumable.name,
                            old_cons, link.consumable.stock_quantity,
                            f"sale_order_{item.order_id}_var_{variant.id}"
                        )

        # === 2. –ü–†–û–°–¢–Ü –¢–û–í–ê–†–ò (–¢–£–¢ –ë–£–õ–ê –ü–†–û–ë–õ–ï–ú–ê) ===
        else:
            product_id = item.product_id
            print(f"  üîπ –ü—Ä–æ—Å—Ç–∏–π –¢–æ–≤–∞—Ä ID: {product_id}")

            # 1. –°–ø–∏—Å—É—î–º–æ —Å–∞–º —Ç–æ–≤–∞—Ä
            product = db.query(models.Product).filter(models.Product.id == product_id).first()
            if product:
                old_p = product.stock_quantity
                product.stock_quantity -= item.quantity
                InventoryLogger.log(
                    db, "product", product.id, product.name, 
                    old_p, product.stock_quantity, 
                    f"sale_order_{item.order_id}"
                )
                
                # --- üî• –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø: –Ø–í–ù–ò–ô –ó–ê–ü–ò–¢ –î–û –ë–ê–ó–ò ---
                # –ú–∏ –Ω–µ –ø–æ–∫–ª–∞–¥–∞—î–º–æ—Å—å –Ω–∞ product.ingredients, –º–∏ –±–µ—Ä–µ–º–æ –¥–∞–Ω—ñ –Ω–∞–ø—Ä—è–º—É –∑ —Ç–∞–±–ª–∏—Ü—ñ
                direct_ingredients = db.query(models.ProductIngredient).filter(
                    models.ProductIngredient.product_id == product.id
                ).all()

                print(f"     üîç –ó–Ω–∞–π–¥–µ–Ω–æ –ø—Ä—è–º–∏—Ö —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç—ñ–≤ (SQL): {len(direct_ingredients)}")
                
                for link in direct_ingredients:
                    # –û—Ç—Ä–∏–º—É—î–º–æ —Å–∞–º –æ–±'—î–∫—Ç —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∞, —â–æ–± –∑–º—ñ–Ω–∏—Ç–∏ –π–æ–≥–æ –∑–∞–ª–∏—à–æ–∫
                    real_ingredient = db.query(models.Ingredient).filter(
                        models.Ingredient.id == link.ingredient_id
                    ).first()

                    if real_ingredient:
                        deduct = link.quantity * item.quantity
                        old_ing = real_ingredient.stock_quantity
                        
                        print(f"        -> –°–ø–∏—Å—É—î–º–æ {real_ingredient.name}: -{deduct}")
                        
                        real_ingredient.stock_quantity -= deduct
                        InventoryLogger.log(
                            db, "ingredient", real_ingredient.id, real_ingredient.name,
                            old_ing, real_ingredient.stock_quantity,
                            f"sale_order_{item.order_id}_prod_{product.id}"
                        )

                # 3. –í–∏—Ç—Ä–∞—Ç–Ω—ñ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏ (–¢–∞–∫–æ–∂ —Ä–æ–±–∏–º–æ –Ω–∞–¥—ñ–π–Ω–æ)
                direct_consumables = db.query(models.ProductConsumable).filter(
                    models.ProductConsumable.product_id == product.id
                ).all()

                for link in direct_consumables:
                    real_cons = db.query(models.Consumable).filter(
                        models.Consumable.id == link.consumable_id
                    ).first()
                    
                    if real_cons:
                        deduct = link.quantity * item.quantity
                        old_cons = real_cons.stock_quantity
                        real_cons.stock_quantity -= deduct
                        InventoryLogger.log(
                            db, "consumable", real_cons.id, real_cons.name,
                            old_cons, real_cons.stock_quantity,
                            f"sale_order_{item.order_id}_prod_{product.id}"
                        )

                # 4. –†–µ—Ü–µ–ø—Ç (—è–∫—â–æ —î)
                if product.master_recipe:
                    # –î–ª—è —Ä–µ—Ü–µ–ø—Ç—É –º–æ–∂–Ω–∞ –∑–∞–ª–∏—à–∏—Ç–∏ Lazy Loading, –∞–±–æ —Ç–µ–∂ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —è–≤–Ω–æ, 
                    # –∞–ª–µ –∑–∞–∑–≤–∏—á–∞–π –∑ —Ä–µ—Ü–µ–ø—Ç–∞–º–∏ –ø—Ä–æ–±–ª–µ–º –º–µ–Ω—à–µ. 
                    # –î–æ–¥–∞–º–æ joinedload —Ç—É—Ç –ª–æ–∫–∞–ª—å–Ω–æ –¥–ª—è –Ω–∞–¥—ñ–π–Ω–æ—Å—Ç—ñ.
                    recipe = db.query(models.MasterRecipe).options(
                        joinedload(models.MasterRecipe.items).joinedload(models.MasterRecipeItem.ingredient)
                    ).filter(models.MasterRecipe.id == product.master_recipe_id).first()

                    if recipe:
                        print(f"     üîç –†–µ—Ü–µ–ø—Ç: {recipe.name}")
                        for r_item in recipe.items:
                            if r_item.ingredient:
                                single_qty = 0
                                if r_item.is_percentage:
                                    single_qty = (r_item.quantity / 100.0) * product.output_weight
                                else:
                                    single_qty = r_item.quantity
                                
                                deduct = single_qty * item.quantity
                                old_ing = r_item.ingredient.stock_quantity
                                r_item.ingredient.stock_quantity -= deduct
                                InventoryLogger.log(
                                    db, "ingredient", r_item.ingredient.id, r_item.ingredient.name,
                                    old_ing, r_item.ingredient.stock_quantity,
                                    f"sale_order_{item.order_id}_recipe_{recipe.id}"
                                )
            else:
                 print(f"  ‚ùå –¢–æ–≤–∞—Ä {product_id} –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ!")
    
    db.commit()
    print("‚úÖ [DEDUCT] –¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞.")
    return {"status": "deducted"}
</file>

<file path="product_service\routers\recipes.py">
# FILE: product_service/routers/recipes.py

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from typing import List
import database, schemas, models

router = APIRouter(prefix="/recipes", tags=["Recipes"])

@router.post("/", response_model=schemas.MasterRecipe)
def create_recipe(recipe: schemas.MasterRecipeCreate, db: Session = Depends(database.get_db)):
    new_recipe = models.MasterRecipe(name=recipe.name, description=recipe.description)
    db.add(new_recipe); db.commit(); db.refresh(new_recipe)
    
    # –î–æ–¥–∞—î–º–æ —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∏ —Ä–µ—Ü–µ–ø—Ç—É
    for item in recipe.items:
        db.add(models.MasterRecipeItem(
            recipe_id=new_recipe.id, 
            ingredient_id=item.ingredient_id, 
            quantity=item.quantity, 
            is_percentage=item.is_percentage
        ))
    db.commit(); db.refresh(new_recipe)
    return new_recipe

@router.get("/", response_model=List[schemas.MasterRecipe])
def read_recipes(db: Session = Depends(database.get_db)):
    recipes = db.query(models.MasterRecipe).all()
    # "–õ—ñ–Ω–∏–≤–µ" –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —ñ–º–µ–Ω —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç—ñ–≤ –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥—É
    for r in recipes:
        for i in r.items: 
            i.ingredient_name = i.ingredient.name if i.ingredient else "Unknown"
    return recipes

@router.put("/{recipe_id}", response_model=schemas.MasterRecipe)
def update_recipe(recipe_id: int, recipe_data: schemas.MasterRecipeCreate, db: Session = Depends(database.get_db)):
    db_recipe = db.query(models.MasterRecipe).filter(models.MasterRecipe.id == recipe_id).first()
    if not db_recipe: raise HTTPException(status_code=404)
    
    db_recipe.name = recipe_data.name
    db_recipe.description = recipe_data.description
    
    # –û—á–∏—â–∞—î–º–æ —Å—Ç–∞—Ä—ñ —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∏ —ñ –ø–∏—à–µ–º–æ –Ω–æ–≤—ñ
    # (SQLAlchemy –≤–∏–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ñ –∑–∞–ø–∏—Å–∏ items –∑–∞–≤–¥—è–∫–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è–º –º–æ–¥–µ–ª—ñ)
    db_recipe.items = [] 
    db.flush()
    
    for item in recipe_data.items:
        db.add(models.MasterRecipeItem(
            recipe_id=db_recipe.id, 
            ingredient_id=item.ingredient_id, 
            quantity=item.quantity, 
            is_percentage=item.is_percentage
        ))
    db.commit(); db.refresh(db_recipe)
    return db_recipe

@router.delete("/{recipe_id}")
def delete_recipe(recipe_id: int, db: Session = Depends(database.get_db)):
    db_recipe = db.query(models.MasterRecipe).filter(models.MasterRecipe.id == recipe_id).first()
    if not db_recipe: raise HTTPException(status_code=404)
    db.delete(db_recipe); db.commit()
    return {"status": "deleted"}
</file>

<file path="product_service\services\__init__.py">

</file>

<file path="product_service\services\inventory_logger.py">
from sqlalchemy.orm import Session
from datetime import datetime
import models

class InventoryLogger:
    @staticmethod
    def log(db: Session, entity_type: str, entity_id: int, entity_name: str, 
            balance_before: float, balance_after: float, reason: str):
        """
        entity_type: 'product', 'variant', 'ingredient', 'consumable'
        """
        try:
            change_amount = balance_after - balance_before
            
            # –Ø–∫—â–æ –∑–º—ñ–Ω –Ω–µ–º–∞—î, –Ω—ñ—á–æ–≥–æ –Ω–µ –ø–∏—à–µ–º–æ
            if change_amount == 0:
                return

            transaction = models.InventoryTransaction(
                entity_type=entity_type,
                entity_id=entity_id,
                entity_name=entity_name,
                change_amount=change_amount,
                balance_after=balance_after,
                reason=reason,
                created_at=datetime.utcnow()
            )
            db.add(transaction)
            # Commit –Ω–µ —Ä–æ–±–∏–º–æ, –±–æ —Ü–µ —á–∞—Å—Ç–∏–Ω–∞ –≤–µ–ª–∏–∫–æ—ó —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó –≤ OrderService
        except Exception as e:
            print(f"‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ –ª–æ–≥—É–≤–∞–Ω–Ω—è —Å–∫–ª–∞–¥—É: {e}")
</file>

<file path="product_service\services\order_service.py">
# FILE: product_service/services/order_service.py

from sqlalchemy.orm import Session
from fastapi import HTTPException
from datetime import datetime
import models
import schemas
import traceback
from services.inventory_logger import InventoryLogger

class OrderService:
    @staticmethod
    def process_checkout(db: Session, order_data: schemas.OrderCreate):
        try:
            print(f"üõí [CHECKOUT] –ü–æ—á–∞—Ç–æ–∫ –æ–±—Ä–æ–±–∫–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è. –ü–æ–∑–∏—Ü—ñ–π: {len(order_data.items)}")
            total_order_price = 0.0
            
            # 1. –°—Ç–≤–æ—Ä—é—î–º–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
            new_order = models.Order(
                created_at=datetime.utcnow(),
                payment_method=order_data.payment_method,
                total_price=0, 
                customer_id=order_data.customer_id
            )
            db.add(new_order)
            db.flush()
            
            transaction_reason = f"sale_order_{new_order.id}"

            # 2. –û–±—Ä–æ–±–ª—è—î–º–æ —Ç–æ–≤–∞—Ä–∏
            for item in order_data.items:
                print(f"   -> –û–±—Ä–æ–±–∫–∞ —Ç–æ–≤–∞—Ä—É ID: {item.product_id} (–í–∞—Ä—ñ–∞–Ω—Ç: {item.variant_id})")
                
                # –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —Ç–æ–≤–∞—Ä (–±–ª–æ–∫—É—î–º–æ –¥–ª—è –±–µ–∑–ø–µ–∫–∏)
                product = db.query(models.Product).filter(
                    models.Product.id == item.product_id
                ).with_for_update().first()
                
                if not product:
                    raise HTTPException(status_code=404, detail=f"Product {item.product_id} not found")

                price = float(product.price)
                item_name = product.name
                details_list = []

                # --- –õ–û–ì–Ü–ö–ê –í–ê–†–Ü–ê–ù–¢–Ü–í ---
                if item.variant_id:
                    variant = db.query(models.ProductVariant).filter(
                        models.ProductVariant.id == item.variant_id
                    ).with_for_update().first()
                    
                    if not variant:
                        raise HTTPException(status_code=404, detail=f"Variant {item.variant_id} not found")
                    
                    price = float(variant.price)
                    item_name = f"{product.name} ({variant.name})"

                    # 1. –°–ø–∏—Å–∞–Ω–Ω—è –∑–∞–ª–∏—à–∫—É –í–ê–†–Ü–ê–ù–¢–£ (–¢–∞ –∑–∞–ø–∏—Å –≤ —ñ—Å—Ç–æ—Ä—ñ—é!)
                    # üî• FIX: –°–ø–∏—Å—É—î–º–æ, —è–∫—â–æ —É –≤–∞—Ä—ñ–∞–Ω—Ç—É –∑–∞–¥–∞–Ω–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å (–Ω–µ None), –Ω–µ–∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å –±–∞—Ç—å–∫–∞
                    if variant.stock_quantity is not None:
                        current_stock = variant.stock_quantity
                        
                        if current_stock < item.quantity:
                            raise HTTPException(status_code=400, detail=f"–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –∑–∞–ª–∏—à–∫—É –¥–ª—è –≤–∞—Ä—ñ–∞–Ω—Ç—É: {variant.name}")
                        
                        variant.stock_quantity = current_stock - item.quantity
                        db.add(variant)

                        # –õ–æ–≥—É–≤–∞–Ω–Ω—è —Å–ø–∏—Å–∞–Ω–Ω—è –≤–∞—Ä—ñ–∞–Ω—Ç—É
                        InventoryLogger.log(
                            db, 
                            "variant", 
                            variant.id, 
                            item_name, 
                            current_stock, 
                            variant.stock_quantity, 
                            transaction_reason
                        )

                    # 2. –°–ø–∏—Å–∞–Ω–Ω—è –Ü–ù–ì–†–ï–î–Ü–Ñ–ù–¢–Ü–í (MasterRecipe)
                    if variant.master_recipe_id:
                        recipe = db.query(models.MasterRecipe).filter(models.MasterRecipe.id == variant.master_recipe_id).first()
                        if recipe:
                            output_w = variant.output_weight or 1
                            for r_item in recipe.items:
                                ing = db.query(models.Ingredient).filter(models.Ingredient.id == r_item.ingredient_id).with_for_update().first()
                                if ing:
                                    deduction = 0
                                    if r_item.is_percentage:
                                         deduction = (r_item.quantity / 100) * output_w * item.quantity
                                    else:
                                         deduction = r_item.quantity * item.quantity
                                    
                                    i_old = ing.stock_quantity if ing.stock_quantity is not None else 0.0
                                    if ing.stock_quantity is None: ing.stock_quantity = 0.0
                                    ing.stock_quantity -= deduction
                                    db.add(ing)
                                    
                                    InventoryLogger.log(db, "ingredient", ing.id, ing.name, i_old, ing.stock_quantity, transaction_reason)

                    # 3. –°–ø–∏—Å–∞–Ω–Ω—è –ú–ê–¢–ï–†–Ü–ê–õ–Ü–í –≤–∞—Ä—ñ–∞–Ω—Ç—É
                    for v_cons in variant.consumables:
                         cons = db.query(models.Consumable).filter(models.Consumable.id == v_cons.consumable_id).with_for_update().first()
                         if cons:
                            c_old = cons.stock_quantity if cons.stock_quantity is not None else 0.0
                            qty_to_deduct = v_cons.quantity * item.quantity
                            
                            if cons.stock_quantity is None: cons.stock_quantity = 0.0
                            cons.stock_quantity -= qty_to_deduct
                            db.add(cons)
                            InventoryLogger.log(db, "consumable", cons.id, cons.name, c_old, cons.stock_quantity, transaction_reason)

                # --- –õ–û–ì–Ü–ö–ê –ü–†–û–°–¢–û–ì–û –¢–û–í–ê–†–£ ---
                else:
                    # 1. –°–ø–∏—Å–∞–Ω–Ω—è –∑–∞–ª–∏—à–∫—É –ü–†–û–°–¢–û–ì–û —Ç–æ–≤–∞—Ä—É (–¢–∞ –∑–∞–ø–∏—Å –≤ —ñ—Å—Ç–æ—Ä—ñ—é!)
                    if product.track_stock:
                        current_stock = product.stock_quantity if product.stock_quantity is not None else 0.0
                        if current_stock < item.quantity:
                            raise HTTPException(status_code=400, detail=f"–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –∑–∞–ª–∏—à–∫—É —Ç–æ–≤–∞—Ä—É: {product.name}")
                        
                        product.stock_quantity = current_stock - item.quantity
                        db.add(product)

                        # –õ–æ–≥—É–≤–∞–Ω–Ω—è —Å–ø–∏—Å–∞–Ω–Ω—è –ø—Ä–æ—Å—Ç–æ–≥–æ —Ç–æ–≤–∞—Ä—É
                        InventoryLogger.log(
                            db, 
                            "product", 
                            product.id, 
                            product.name, 
                            current_stock, 
                            product.stock_quantity, 
                            transaction_reason
                        )

                    # 2. –°–ø–∏—Å–∞–Ω–Ω—è –Ü–ù–ì–†–ï–î–Ü–Ñ–ù–¢–Ü–í (MasterRecipe)
                    if product.master_recipe_id:
                        recipe = db.query(models.MasterRecipe).filter(models.MasterRecipe.id == product.master_recipe_id).first()
                        if recipe:
                             output_w = product.output_weight or 1
                             for r_item in recipe.items:
                                ing = db.query(models.Ingredient).filter(models.Ingredient.id == r_item.ingredient_id).with_for_update().first()
                                if ing:
                                    deduction = 0
                                    if r_item.is_percentage:
                                         deduction = (r_item.quantity / 100) * output_w * item.quantity
                                    else:
                                         deduction = r_item.quantity * item.quantity
                                    
                                    i_old = ing.stock_quantity if ing.stock_quantity is not None else 0.0
                                    if ing.stock_quantity is None: ing.stock_quantity = 0.0
                                    ing.stock_quantity -= deduction
                                    db.add(ing)
                                    InventoryLogger.log(db, "ingredient", ing.id, ing.name, i_old, ing.stock_quantity, transaction_reason)

                # === –ó–ê–ì–ê–õ–¨–ù–Ü –°–ü–ò–°–ê–ù–ù–Ø ===
                
                # A. ProductIngredient (–î–æ–¥–∞—Ç–∫–æ–≤—ñ —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∏ –ø–æ–∑–∞ —Ä–µ—Ü–µ–ø—Ç–æ–º)
                for p_ing in product.ingredients:
                    ing = db.query(models.Ingredient).filter(models.Ingredient.id == p_ing.ingredient_id).with_for_update().first()
                    if ing:
                        i_old = ing.stock_quantity if ing.stock_quantity is not None else 0.0
                        deduction = p_ing.quantity * item.quantity
                        
                        if ing.stock_quantity is None: ing.stock_quantity = 0.0
                        ing.stock_quantity -= deduction
                        db.add(ing)
                        InventoryLogger.log(db, "ingredient", ing.id, ing.name, i_old, ing.stock_quantity, transaction_reason)

                # B. ProductConsumable (–ó–∞–≥–∞–ª—å–Ω—ñ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏)
                for p_cons in product.consumables:
                    cons = db.query(models.Consumable).filter(models.Consumable.id == p_cons.consumable_id).with_for_update().first()
                    if cons:
                        c_old = cons.stock_quantity if cons.stock_quantity is not None else 0.0
                        qty_to_deduct = p_cons.quantity * item.quantity
                        
                        if cons.stock_quantity is None: cons.stock_quantity = 0.0
                        cons.stock_quantity -= qty_to_deduct
                        db.add(cons)
                        InventoryLogger.log(db, "consumable", cons.id, cons.name, c_old, cons.stock_quantity, transaction_reason)

                # C. Modifiers (–ú–æ–¥–∏—Ñ—ñ–∫–∞—Ç–æ—Ä–∏ –∑ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥—É)
                if item.modifiers:
                    for modifier in item.modifiers:
                         mod_ing = db.query(models.Ingredient).filter(models.Ingredient.id == modifier.modifier_id).with_for_update().first()
                         if mod_ing:
                            i_old = mod_ing.stock_quantity if mod_ing.stock_quantity is not None else 0.0
                            deduction = modifier.quantity * item.quantity
                            
                            if mod_ing.stock_quantity is None: mod_ing.stock_quantity = 0.0
                            mod_ing.stock_quantity -= deduction
                            db.add(mod_ing)
                            
                            InventoryLogger.log(db, "ingredient", mod_ing.id, mod_ing.name, i_old, mod_ing.stock_quantity, transaction_reason)
                            details_list.append(f"+ {mod_ing.name}")

                # === –ó–ê–ü–ò–° –£ –ß–ï–ö ===
                db.add(models.OrderItem(
                    order_id=new_order.id,
                    product_name=item_name,
                    quantity=item.quantity,
                    price_at_moment=price, 
                    details=", ".join(details_list) if details_list else None
                ))
                
                total_order_price += price * item.quantity

            new_order.total_price = round(total_order_price, 2)
            db.commit()
            db.refresh(new_order)
            print(f"‚úÖ [CHECKOUT] –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è {new_order.id} —É—Å–ø—ñ—à–Ω–æ —Å—Ç–≤–æ—Ä–µ–Ω–æ! –°—É–º–∞: {new_order.total_price}")
            return new_order

        except HTTPException as http_ex:
            db.rollback()
            print(f"‚ö†Ô∏è HTTP –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ–ø–ª–∞—Ç—ñ: {http_ex.detail}")
            raise http_ex
        except Exception as e:
            db.rollback()
            print("‚ùå –ö–†–ò–¢–ò–ß–ù–ê –ü–û–ú–ò–õ–ö–ê –ü–†–ò –û–ü–õ–ê–¢–Ü:")
            print(traceback.format_exc())
            raise HTTPException(status_code=500, detail="–ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è. –î–µ—Ç–∞–ª—ñ –≤ –ª–æ–≥–∞—Ö —Å–µ—Ä–≤–µ—Ä–∞.")
</file>

<file path="product_service\services\product_service.py">
from sqlalchemy.orm import Session
from fastapi import HTTPException
import models
import schemas

class ProductService:
    """
    –ö–ª–∞—Å –¥–ª—è —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Ç–æ–≤–∞—Ä–∞–º–∏.
    –í—Å—è –ª–æ–≥—ñ–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è, –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–∞ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É –≤–∞—Ä—Ç–æ—Å—Ç—ñ.
    """

    @staticmethod
    def calculate_product_cost(db: Session, data: schemas.ProductCostCheck) -> float:
        total_cost = 0.0

        # 1. –ü—Ä—è–º—ñ —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∏
        for link in data.ingredients:
            ing = db.query(models.Ingredient).filter(models.Ingredient.id == link.ingredient_id).first()
            if ing:
                total_cost += ing.cost_per_unit * link.quantity

        # 2. –í–∏—Ç—Ä–∞—Ç–Ω—ñ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏
        for link in data.consumables:
            cons = db.query(models.Consumable).filter(models.Consumable.id == link.consumable_id).first()
            if cons:
                total_cost += cons.cost_per_unit * link.quantity

        # 3. –†–µ—Ü–µ–ø—Ç (–¢–µ—Ö–∫–∞—Ä—Ç–∞)
        if data.master_recipe_id:
            recipe = db.query(models.MasterRecipe).filter(models.MasterRecipe.id == data.master_recipe_id).first()
            if recipe:
                for item in recipe.items:
                    if item.ingredient:
                        # –õ–æ–≥—ñ–∫–∞: –Ø–∫—â–æ –≤ —Ä–µ—Ü–µ–ø—Ç—ñ %, –±–µ—Ä–µ–º–æ –≤—ñ–¥ –≤–∞–≥–∏ –≤–∏—Ö–æ–¥—É. –Ø–∫—â–æ –Ω—ñ - –ø—Ä—è–º–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å.
                        qty = 0
                        if item.is_percentage:
                            qty = (item.quantity / 100) * (data.output_weight or 0)
                        else:
                            qty = item.quantity
                        
                        total_cost += item.ingredient.cost_per_unit * qty

        return round(total_cost, 2)

    @staticmethod
    def create_product(db: Session, product: schemas.ProductCreate):
        # 1. –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Å–∞–º–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç—É
        db_product = models.Product(
            name=product.name,
            description=product.description,
            price=product.price,
            category_id=product.category_id,
            image_url=product.image_url,
            has_variants=product.has_variants,
            track_stock=product.track_stock,
            stock_quantity=product.stock_quantity,
            master_recipe_id=product.master_recipe_id,
            output_weight=product.output_weight
        )
        db.add(db_product)
        db.flush() # –û—Ç—Ä–∏–º—É—î–º–æ ID

        # 2. –î–æ–¥–∞–≤–∞–Ω–Ω—è —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç—ñ–≤ (Many-to-Many)
        if product.ingredients:
            for item in product.ingredients:
                db.add(models.ProductIngredient(
                    product_id=db_product.id,
                    ingredient_id=item.ingredient_id,
                    quantity=item.quantity
                ))
        
        # 2.1 –î–æ–¥–∞–≤–∞–Ω–Ω—è –≤–∏—Ç—Ä–∞—Ç–Ω–∏—Ö –º–∞—Ç–µ—Ä—ñ–∞–ª—ñ–≤
        if product.consumables:
            for item in product.consumables:
                db.add(models.ProductConsumable(
                    product_id=db_product.id,
                    consumable_id=item.consumable_id,
                    quantity=item.quantity
                ))

        # 3. –í–∞—Ä—ñ–∞–Ω—Ç–∏
        if product.variants:
            for v in product.variants:
                db_variant = models.ProductVariant(
                    product_id=db_product.id,
                    name=v.name,
                    price=v.price,
                    sku=v.sku,
                    master_recipe_id=v.master_recipe_id,
                    output_weight=v.output_weight,
                    stock_quantity=v.stock_quantity
                )
                db.add(db_variant)
                db.flush()
                
                # –Ü–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∏ –≤–∞—Ä—ñ–∞–Ω—Ç—É
                if v.ingredients:
                    for vi in v.ingredients:
                        db.add(models.ProductVariantIngredient(
                            variant_id=db_variant.id,
                            ingredient_id=vi.ingredient_id,
                            quantity=vi.quantity
                        ))
                
                # –ú–∞—Ç–µ—Ä—ñ–∞–ª–∏ –≤–∞—Ä—ñ–∞–Ω—Ç—É
                if v.consumables:
                    for vc in v.consumables:
                        db.add(models.ProductVariantConsumable(
                            variant_id=db_variant.id,
                            consumable_id=vc.consumable_id,
                            quantity=vc.quantity
                        ))

        # 4. –ú–æ–¥–∏—Ñ—ñ–∫–∞—Ç–æ—Ä–∏
        if product.modifier_groups:
            for group in product.modifier_groups:
                db_group = models.ProductModifierGroup(
                    product_id=db_product.id,
                    name=group.name,
                    is_required=group.is_required
                )
                db.add(db_group)
                db.flush()
                for mod in group.modifiers:
                    db.add(models.Modifier(
                        group_id=db_group.id,
                        name=mod.name,
                        price_change=mod.price_change,
                        ingredient_id=mod.ingredient_id,
                        quantity=mod.quantity
                    ))
        
        # 5. –ì—Ä—É–ø–∏ –ø—Ä–æ—Ü–µ—Å—ñ–≤
        if product.process_group_ids:
            for pg_id in product.process_group_ids:
                pg = db.query(models.ProcessGroup).filter(models.ProcessGroup.id == pg_id).first()
                if pg:
                    db_product.process_groups.append(pg)

        db.commit()
        db.refresh(db_product)
        return db_product

    @staticmethod
    def update_product(db: Session, product_id: int, product_data: schemas.ProductCreate):
        db_product = db.query(models.Product).filter(models.Product.id == product_id).first()
        if not db_product:
            return None

        # 1. –û–Ω–æ–≤–ª–µ–Ω–Ω—è –æ—Å–Ω–æ–≤–Ω–∏—Ö –ø–æ–ª—ñ–≤
        db_product.name = product_data.name
        db_product.description = product_data.description
        db_product.price = product_data.price
        db_product.category_id = product_data.category_id
        db_product.image_url = product_data.image_url
        db_product.has_variants = product_data.has_variants
        db_product.track_stock = product_data.track_stock
        db_product.stock_quantity = product_data.stock_quantity
        db_product.master_recipe_id = product_data.master_recipe_id
        db_product.output_weight = product_data.output_weight

        # 2. –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–≤'—è–∑–∫—ñ–≤ (–Ü–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∏, –ú–∞—Ç–µ—Ä—ñ–∞–ª–∏) - —Ç—É—Ç –≤–∏–¥–∞–ª–µ–Ω–Ω—è –¥–æ–ø—É—Å—Ç–∏–º–µ, –±–æ ID –ª—ñ–Ω–∫—ñ–≤ –Ω—ñ–¥–µ –Ω–µ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è
        db.query(models.ProductIngredient).filter(models.ProductIngredient.product_id == product_id).delete()
        if product_data.ingredients:
            for item in product_data.ingredients:
                db.add(models.ProductIngredient(
                    product_id=product_id, ingredient_id=item.ingredient_id, quantity=item.quantity
                ))
        
        db.query(models.ProductConsumable).filter(models.ProductConsumable.product_id == product_id).delete()
        if product_data.consumables:
            for item in product_data.consumables:
                db.add(models.ProductConsumable(
                    product_id=product_id, consumable_id=item.consumable_id, quantity=item.quantity
                ))

        # 3. –í–ê–†–Ü–ê–ù–¢–ò - –†–û–ó–£–ú–ù–ï –û–ù–û–í–õ–ï–ù–ù–Ø (Fix: –∑–±–µ—Ä—ñ–≥–∞—î–º–æ ID)
        
        # –û—Ç—Ä–∏–º—É—î–º–æ –ø–æ—Ç–æ—á–Ω—ñ –≤–∞—Ä—ñ–∞–Ω—Ç–∏ –∑ –ë–î —É –≤–∏–≥–ª—è–¥—ñ —Å–ª–æ–≤–Ω–∏–∫–∞ {–Ω–∞–∑–≤–∞: –æ–±'—î–∫—Ç}
        current_variants_map = {v.name: v for v in db_product.variants}
        incoming_variants_names = set()

        if product_data.variants:
            for v_data in product_data.variants:
                incoming_variants_names.add(v_data.name)
                
                if v_data.name in current_variants_map:
                    # --- –û–ù–û–í–õ–Æ–Ñ–ú–û –Ü–°–ù–£–Æ–ß–ò–ô (–ó–ë–ï–†–Ü–ì–ê–Ñ–ú–û ID) ---
                    existing_variant = current_variants_map[v_data.name]
                    existing_variant.price = v_data.price
                    existing_variant.sku = v_data.sku
                    existing_variant.master_recipe_id = v_data.master_recipe_id
                    existing_variant.output_weight = v_data.output_weight
                    existing_variant.stock_quantity = v_data.stock_quantity
                    
                    # –û–Ω–æ–≤–ª—é—î–º–æ –≤–∫–ª–∞–¥–µ–Ω—ñ —Å–ø–∏—Å–∫–∏ (—ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∏ –≤–∞—Ä—ñ–∞–Ω—Ç—É)
                    # –¢—É—Ç –º–æ–∂–Ω–∞ –≤–∏–¥–∞–ª—è—Ç–∏, –±–æ —Ü—ñ ID –Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è –≤ —á–µ–∫–∞—Ö
                    db.query(models.ProductVariantIngredient).filter(models.ProductVariantIngredient.variant_id == existing_variant.id).delete()
                    if v_data.ingredients:
                        for vi in v_data.ingredients:
                            db.add(models.ProductVariantIngredient(
                                variant_id=existing_variant.id, ingredient_id=vi.ingredient_id, quantity=vi.quantity
                            ))

                    db.query(models.ProductVariantConsumable).filter(models.ProductVariantConsumable.variant_id == existing_variant.id).delete()
                    if v_data.consumables:
                        for vc in v_data.consumables:
                            db.add(models.ProductVariantConsumable(
                                variant_id=existing_variant.id, consumable_id=vc.consumable_id, quantity=vc.quantity
                            ))
                else:
                    # --- –°–¢–í–û–†–Æ–Ñ–ú–û –ù–û–í–ò–ô ---
                    new_variant = models.ProductVariant(
                        product_id=product_id,
                        name=v_data.name,
                        price=v_data.price,
                        sku=v_data.sku,
                        master_recipe_id=v_data.master_recipe_id,
                        output_weight=v_data.output_weight,
                        stock_quantity=v_data.stock_quantity
                    )
                    db.add(new_variant)
                    db.flush() # —â–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ ID –¥–ª—è –≤–∫–ª–∞–¥–µ–Ω–∏—Ö —Ç–∞–±–ª–∏—Ü—å

                    if v_data.ingredients:
                        for vi in v_data.ingredients:
                            db.add(models.ProductVariantIngredient(
                                variant_id=new_variant.id, ingredient_id=vi.ingredient_id, quantity=vi.quantity
                            ))
                    if v_data.consumables:
                        for vc in v_data.consumables:
                            db.add(models.ProductVariantConsumable(
                                variant_id=new_variant.id, consumable_id=vc.consumable_id, quantity=vc.quantity
                            ))

        # –í–∏–¥–∞–ª—è—î–º–æ –≤–∞—Ä—ñ–∞–Ω—Ç–∏, —è–∫–∏—Ö –Ω–µ–º–∞—î –≤ –Ω–æ–≤–æ–º—É —Å–ø–∏—Å–∫—É
        for name, variant in current_variants_map.items():
            if name not in incoming_variants_names:
                db.delete(variant)

        # 4. –ú–û–î–ò–§–Ü–ö–ê–¢–û–†–ò (—Ç—É—Ç –º–æ–∂–Ω–∞ –≤–∏–¥–∞–ª—è—Ç–∏ —ñ —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ –∑–∞–Ω–æ–≤–æ, ID –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω—ñ –¥–ª—è —á–µ–∫—ñ–≤ –ø–æ–∫–∏ —â–æ)
        db.query(models.ProductModifierGroup).filter(
            models.ProductModifierGroup.product_id == product_id
        ).delete()
        
        if product_data.modifier_groups:
            for group in product_data.modifier_groups:
                db_group = models.ProductModifierGroup(
                    product_id=product_id, 
                    name=group.name, 
                    is_required=group.is_required
                )
                db.add(db_group)
                db.flush()
                for mod in group.modifiers:
                    db.add(models.Modifier(
                        group_id=db_group.id, 
                        name=mod.name, 
                        price_change=mod.price_change, 
                        ingredient_id=mod.ingredient_id, 
                        quantity=mod.quantity
                    ))

        # 5. –ü–†–û–¶–ï–°–ò
        db_product.process_groups = [] 
        if product_data.process_group_ids:
            for pg_id in product_data.process_group_ids:
                pg = db.query(models.ProcessGroup).filter(
                    models.ProcessGroup.id == pg_id
                ).first()
                if pg:
                    db_product.process_groups.append(pg)

        db.commit()
        db.refresh(db_product)
        return db_product
</file>

<file path="product_service\tests\conftest.py">
import sys
import os
import pytest
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from sqlalchemy.pool import StaticPool
from fastapi.testclient import TestClient

# 1. –î–æ–¥–∞—î–º–æ –∫–æ—Ä–µ–Ω–µ–≤—É –ø–∞–ø–∫—É —Å–µ—Ä–≤—ñ—Å—É –≤ —à–ª—è—Ö –ø–æ—à—É–∫—É –º–æ–¥—É–ª—ñ–≤,
# —â–æ–± –º–æ–∂–Ω–∞ –±—É–ª–æ —ñ–º–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ main, database, models
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from database import Base, get_db
from main import app
# –Ü–º–ø–æ—Ä—Ç—É—î–º–æ –º–æ–¥–µ–ª—ñ, —â–æ–± SQLAlchemy –∑–Ω–∞–ª–∞ –ø—Ä–æ –Ω–∏—Ö –ø—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ —Ç–∞–±–ª–∏—Ü—å
import models 

# 2. –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Ç–µ—Å—Ç–æ–≤–æ—ó –±–∞–∑–∏ –¥–∞–Ω–∏—Ö (SQLite in-memory)
# check_same_thread=False –ø–æ—Ç—Ä—ñ–±–µ–Ω –¥–ª—è SQLite, –∫–æ–ª–∏ –≤—ñ–Ω –ø—Ä–∞—Ü—é—î –∑ FastAPI
SQLALCHEMY_DATABASE_URL = "sqlite:///:memory:"

engine = create_engine(
    SQLALCHEMY_DATABASE_URL,
    connect_args={"check_same_thread": False},
    poolclass=StaticPool, # –í–∞–∂–ª–∏–≤–æ: –∑–±–µ—Ä—ñ–≥–∞—î –¥–∞–Ω—ñ –º—ñ–∂ –∑–∞–ø–∏—Ç–∞–º–∏ –≤ –º–µ–∂–∞—Ö –æ–¥–Ω–æ–≥–æ —Ç–µ—Å—Ç—É
)

TestingSessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)

@pytest.fixture(scope="function")
def db_session():
    """
    –§—ñ–∫—Å—Ç—É—Ä–∞, —è–∫–∞ —Å—Ç–≤–æ—Ä—é—î —á–∏—Å—Ç—É –±–∞–∑—É –¥–∞–Ω–∏—Ö –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ —Ç–µ—Å—Ç—É
    —ñ –ø–æ–≤–µ—Ä—Ç–∞—î —Å–µ—Å—ñ—é SQLAlchemy.
    """
    # –°—Ç–≤–æ—Ä—é—î–º–æ –≤—Å—ñ —Ç–∞–±–ª–∏—Ü—ñ, –≤–∏–∑–Ω–∞—á–µ–Ω—ñ –≤ models.py
    Base.metadata.create_all(bind=engine)
    
    session = TestingSessionLocal()
    try:
        yield session
    finally:
        session.close()
        # –í–∏–¥–∞–ª—è—î–º–æ —Ç–∞–±–ª–∏—Ü—ñ –ø—ñ—Å–ª—è —Ç–µ—Å—Ç—É, —â–æ–± –Ω–∞—Å—Ç—É–ø–Ω–∏–π —Ç–µ—Å—Ç –±—É–≤ —á–∏—Å—Ç–∏–º
        Base.metadata.drop_all(bind=engine)

@pytest.fixture(scope="function")
def client(db_session):
    """
    –§—ñ–∫—Å—Ç—É—Ä–∞ –∫–ª—ñ—î–Ω—Ç–∞ FastAPI, —è–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—ñ–¥–º—ñ–Ω—è—î
    –∑–∞–ª–µ–∂–Ω—ñ—Å—Ç—å get_db –Ω–∞ –Ω–∞—à—É —Ç–µ—Å—Ç–æ–≤—É —Å–µ—Å—ñ—é.
    """
    def override_get_db():
        try:
            yield db_session
        finally:
            db_session.close()

    # –ü—ñ–¥–º—ñ–Ω—è—î–º–æ —Ä–µ–∞–ª—å–Ω—É –∑–∞–ª–µ–∂–Ω—ñ—Å—Ç—å (PostgreSQL) –Ω–∞ —Ç–µ—Å—Ç–æ–≤—É (SQLite)
    app.dependency_overrides[get_db] = override_get_db
    
    # –°—Ç–≤–æ—Ä—é—î–º–æ –∫–ª—ñ—î–Ω—Ç–∞ –¥–ª—è –∑–∞–ø–∏—Ç—ñ–≤ (–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î httpx –ø—ñ–¥ –∫–∞–ø–æ—Ç–æ–º)
    with TestClient(app) as c:
        yield c
    
    # –û—á–∏—â–∞—î–º–æ –ø—ñ–¥–º—ñ–Ω—É –ø—ñ—Å–ª—è —Ç–µ—Å—Ç—É
    app.dependency_overrides.clear()
</file>

<file path="product_service\tests\test_categories.py">
import pytest
from sqlalchemy.exc import IntegrityError

def test_create_category_success(client):
    """
    –¢–µ—Å—Ç —É—Å–ø—ñ—à–Ω–æ–≥–æ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó (–∑ color –∑–∞–º—ñ—Å—Ç—å icon).
    """
    payload = {
        "name": "–ì–∞—Ä—è—á—ñ –Ω–∞–ø–æ—ó",
        "slug": "hot-drinks",
        "color": "#ff0000"  # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —Ä–µ–∞–ª—å–Ω–µ –ø–æ–ª–µ –∑ —Ç–≤–æ—î—ó –º–æ–¥–µ–ª—ñ
    }
    response = client.post("/categories/", json=payload)
    
    assert response.status_code == 200
    data = response.json()
    
    assert data["name"] == payload["name"]
    assert data["slug"] == payload["slug"]
    assert data["color"] == payload["color"]
    assert "id" in data
    assert data["parent_id"] is None # –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º None

def test_create_subcategory(client):
    """
    –¢–µ—Å—Ç —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø—ñ–¥–∫–∞—Ç–µ–≥–æ—Ä—ñ—ó (–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ parent_id).
    """
    # 1. –°—Ç–≤–æ—Ä—é—î–º–æ –±–∞—Ç—å–∫—ñ–≤—Å—å–∫—É
    parent_resp = client.post("/categories/", json={
        "name": "–ù–∞–ø–æ—ó", 
        "slug": "drinks", 
        "color": "#0000ff"
    })
    parent_id = parent_resp.json()["id"]

    # 2. –°—Ç–≤–æ—Ä—é—î–º–æ –¥–æ—á—ñ—Ä–Ω—é
    child_payload = {
        "name": "–ö–∞–≤–∞",
        "slug": "coffee",
        "color": "#6f4e37",
        "parent_id": parent_id  # –ü—Ä–∏–≤'—è–∑—É—î–º–æ –¥–æ –±–∞—Ç—å–∫–∞
    }
    response = client.post("/categories/", json=child_payload)
    
    assert response.status_code == 200
    data = response.json()
    assert data["parent_id"] == parent_id

def test_create_category_duplicate_slug(client):
    """
    –¢–µ—Å—Ç –Ω–∞ —É–Ω—ñ–∫–∞–ª—å–Ω—ñ—Å—Ç—å slug.
    """
    payload = {
        "name": "–ü–µ—Ä—à–∞",
        "slug": "unique-slug",
        "color": "#ffffff"
    }
    client.post("/categories/", json=payload)
    
    # –û—á—ñ–∫—É—î–º–æ –ø–æ–º–∏–ª–∫—É IntegrityError –ø—Ä–∏ —Å–ø—Ä–æ–±—ñ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –¥—É–±–ª—ñ–∫–∞—Ç
    with pytest.raises(IntegrityError):
        client.post("/categories/", json={
            "name": "–î—Ä—É–≥–∞",
            "slug": "unique-slug",
            "color": "#000000"
        })

def test_update_category(client):
    """–¢–µ—Å—Ç –æ–Ω–æ–≤–ª–µ–Ω–Ω—è."""
    # 1. –°—Ç–≤–æ—Ä–∏–ª–∏
    create_resp = client.post("/categories/", json={
        "name": "Old", "slug": "old", "color": "#111111"
    })
    cat_id = create_resp.json()["id"]

    # 2. –û–Ω–æ–≤–∏–ª–∏
    update_payload = {
        "name": "New", "slug": "new", "color": "#222222"
    }
    response = client.put(f"/categories/{cat_id}", json=update_payload)
    
    assert response.status_code == 200
    data = response.json()
    assert data["name"] == "New"
    assert data["color"] == "#222222"

def test_delete_category(client):
    """
    –¢–µ—Å—Ç –≤–∏–¥–∞–ª–µ–Ω–Ω—è (–ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–µ—Ä–µ–∑ —Å–ø–∏—Å–æ–∫).
    """
    # 1. –°—Ç–≤–æ—Ä–∏–ª–∏
    create_resp = client.post("/categories/", json={
        "name": "Delete Me", "slug": "del", "color": "#000000"
    })
    cat_id = create_resp.json()["id"]

    # 2. –í–∏–¥–∞–ª–∏–ª–∏
    del_response = client.delete(f"/categories/{cat_id}")
    assert del_response.status_code == 200

    # 3. –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —â–æ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –Ω–µ–º–∞—î —É –∑–∞–≥–∞–ª—å–Ω–æ–º—É —Å–ø–∏—Å–∫—É
    list_response = client.get("/categories/")
    all_categories = list_response.json()
    
    found_ids = [cat["id"] for cat in all_categories]
    assert cat_id not in found_ids
</file>

<file path="product_service\tests\test_consumables.py">
import pytest

def test_create_consumable_basic(client):
    """
    –¢–µ—Å—Ç —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø—Ä–æ—Å—Ç–æ–≥–æ –≤–∏—Ç—Ä–∞—Ç–Ω–æ–≥–æ –º–∞—Ç–µ—Ä—ñ–∞–ª—É (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, —Å–µ—Ä–≤–µ—Ç–∫–∏).
    –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —â–æ stock_quantity –ø—Ä–∏–π–º–∞—î int.
    """
    # 1. –°—Ç–≤–æ—Ä—é—î–º–æ Unit (–ø–∞—á–∫–∞)
    u_resp = client.post("/units/", json={"name": "–ü–∞—á–∫–∞", "symbol": "–ø–∞—á"})
    unit_id = u_resp.json()["id"]

    # 2. –°—Ç–≤–æ—Ä—é—î–º–æ –≤–∏—Ç—Ä–∞—Ç–Ω–∏–π –º–∞—Ç–µ—Ä—ñ–∞–ª
    payload = {
        "name": "–°–µ—Ä–≤–µ—Ç–∫–∏ –±—ñ–ª—ñ",
        "cost_per_unit": 25.00,
        "stock_quantity": 100,  # Integer
        "unit_id": unit_id
    }
    response = client.post("/consumables/", json=payload)

    assert response.status_code == 200
    data = response.json()
    
    assert data["name"] == "–°–µ—Ä–≤–µ—Ç–∫–∏ –±—ñ–ª—ñ"
    assert data["stock_quantity"] == 100
    assert isinstance(data["stock_quantity"], int)
    assert data["unit_id"] == unit_id

def test_create_consumable_with_category(client):
    """
    –¢–µ—Å—Ç —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –≤–∏—Ç—Ä–∞—Ç–Ω–æ–≥–æ –º–∞—Ç–µ—Ä—ñ–∞–ª—É –∑ –∫–∞—Ç–µ–≥–æ—Ä—ñ—î—é (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, "–£–ø–∞–∫–æ–≤–∫–∞").
    """
    # 1. –°—Ç–≤–æ—Ä—é—î–º–æ Unit (—à—Ç—É–∫–∞)
    u_resp = client.post("/units/", json={"name": "–®—Ç—É–∫–∞", "symbol": "—à—Ç"})
    unit_id = u_resp.json()["id"]

    # 2. –°—Ç–≤–æ—Ä—é—î–º–æ –ö–∞—Ç–µ–≥–æ—Ä—ñ—é
    c_resp = client.post("/categories/", json={
        "name": "–£–ø–∞–∫–æ–≤–∫–∞", 
        "slug": "packaging", 
        "color": "#cccccc"
    })
    cat_id = c_resp.json()["id"]

    # 3. –°—Ç–≤–æ—Ä—é—î–º–æ Consumable
    payload = {
        "name": "–°—Ç–∞–∫–∞–Ω –ø–∞–ø–µ—Ä–æ–≤–∏–π 350–º–ª",
        "cost_per_unit": 2.50,
        "stock_quantity": 500,
        "unit_id": unit_id,
        "category_id": cat_id
    }
    response = client.post("/consumables/", json=payload)
    
    assert response.status_code == 200
    data = response.json()
    
    assert data["category_id"] == cat_id
    # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑–≤'—è–∑–∫—É
    assert data["name"] == "–°—Ç–∞–∫–∞–Ω –ø–∞–ø–µ—Ä–æ–≤–∏–π 350–º–ª"

def test_update_consumable_stock(client):
    """
    –¢–µ—Å—Ç –∑–º—ñ–Ω–∏ –∑–∞–ª–∏—à–∫—ñ–≤ (—ñ–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü—ñ—è).
    """
    # –°—Ç–≤–æ—Ä—é—î–º–æ
    u_resp = client.post("/units/", json={"name": "—à—Ç", "symbol": "—à—Ç"})
    unit_id = u_resp.json()["id"]
    
    create_resp = client.post("/consumables/", json={
        "name": "–¢—Ä—É–±–æ—á–∫–∏",
        "cost_per_unit": 0.1,
        "stock_quantity": 1000,
        "unit_id": unit_id
    })
    consumable_id = create_resp.json()["id"]

    # –û–Ω–æ–≤–ª—é—î–º–æ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –ø—Ä–∏—ó—Ö–∞–ª–∞ –Ω–æ–≤–∞ –ø–∞—Ä—Ç—ñ—è)
    update_payload = {
        "name": "–¢—Ä—É–±–æ—á–∫–∏",
        "cost_per_unit": 0.12, # —Ü—ñ–Ω–∞ –∑–º—ñ–Ω–∏–ª–∞—Å—è
        "stock_quantity": 2000, # –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∑–º—ñ–Ω–∏–ª–∞—Å—è
        "unit_id": unit_id
    }
    response = client.put(f"/consumables/{consumable_id}", json=update_payload)
    
    assert response.status_code == 200
    data = response.json()
    assert data["stock_quantity"] == 2000
    assert data["cost_per_unit"] == 0.12

def test_delete_consumable(client):
    """
    –¢–µ—Å—Ç –≤–∏–¥–∞–ª–µ–Ω–Ω—è –≤–∏—Ç—Ä–∞—Ç–Ω–æ–≥–æ –º–∞—Ç–µ—Ä—ñ–∞–ª—É.
    """
    # –°—Ç–≤–æ—Ä—é—î–º–æ
    u_resp = client.post("/units/", json={"name": "—à—Ç", "symbol": "—à—Ç"})
    create_resp = client.post("/consumables/", json={
        "name": "–í–∏–¥–∞–ª–∏ –º–µ–Ω–µ",
        "cost_per_unit": 1,
        "stock_quantity": 1,
        "unit_id": u_resp.json()["id"]
    })
    c_id = create_resp.json()["id"]

    # –í–∏–¥–∞–ª—è—î–º–æ
    del_resp = client.delete(f"/consumables/{c_id}")
    assert del_resp.status_code == 200

    # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–µ—Ä–µ–∑ —Å–ø–∏—Å–æ–∫
    list_resp = client.get("/consumables/")
    ids = [item["id"] for item in list_resp.json()]
    assert c_id not in ids
</file>

<file path="product_service\tests\test_orders.py">
import pytest
from sqlalchemy.orm import Session
import models  # –Ü–º–ø–æ—Ä—Ç—É—î–º–æ –º–æ–¥–µ–ª—ñ –Ω–∞–ø—Ä—è–º—É –¥–ª—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –º–µ–Ω—é

def setup_menu(db: Session):
    """
    –î–æ–ø–æ–º—ñ–∂–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è, —è–∫–∞ –Ω–∞–ø–æ–≤–Ω—é—î '–≤—ñ—Ä—Ç—É–∞–ª—å–Ω–µ –∫–∞—Ñ–µ' —Ç–æ–≤–∞—Ä–∞–º–∏ —Ç–∞ —Ç–µ—Ö–∫–∞—Ä—Ç–∞–º–∏.
    –ú–∏ —Ä–æ–±–∏–º–æ —Ü–µ –Ω–∞–ø—Ä—è–º—É —á–µ—Ä–µ–∑ DB, —â–æ–± —ñ–∑–æ–ª—é–≤–∞—Ç–∏ —Ç–µ—Å—Ç –∑–∞–º–æ–≤–ª–µ–Ω—å –≤—ñ–¥ —Ç–µ—Å—Ç—ñ–≤ –∞–¥–º—ñ–Ω–∫–∏.
    """
    # 1. –°—Ç–≤–æ—Ä—é—î–º–æ –û–¥–∏–Ω–∏—Ü—ñ —Ç–∞ –Ü–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∏
    unit_ml = models.Unit(name="–ú—ñ–ª—ñ–ª—ñ—Ç—Ä–∏", symbol="–º–ª")
    unit_pcs = models.Unit(name="–®—Ç—É–∫–∏", symbol="—à—Ç")
    db.add_all([unit_ml, unit_pcs])
    db.commit()

    # –°–∫–ª–∞–¥: 5 –ª—ñ—Ç—Ä—ñ–≤ –º–æ–ª–æ–∫–∞, 100 —Å—Ç–∞–∫–∞–Ω—á–∏–∫—ñ–≤
    milk = models.Ingredient(name="–ú–æ–ª–æ–∫–æ", unit_id=unit_ml.id, stock_quantity=5000, cost_per_unit=0.05)
    cup = models.Consumable(name="–°—Ç–∞–∫–∞–Ω XL", unit_id=unit_pcs.id, stock_quantity=100, cost_per_unit=2.0)
    db.add_all([milk, cup])
    db.commit()

    # 2. –°—Ç–≤–æ—Ä—é—î–º–æ –ö–∞—Ç–µ–≥–æ—Ä—ñ—é —Ç–∞ –¢–æ–≤–∞—Ä
    category = models.Category(name="–ö–∞–≤–∞", slug="coffee", color="#000000")
    db.add(category)
    db.commit()

    product = models.Product(
        name="–ö–∞–ø—É—á–∏–Ω–æ", 
        category_id=category.id, 
        price=0, # –¶—ñ–Ω–∞ –±—É–¥–µ –Ω–∞ –≤–∞—Ä—ñ–∞–Ω—Ç–∞—Ö
        is_active=True
    )
    db.add(product)
    db.commit()

    # 3. –°—Ç–≤–æ—Ä—é—î–º–æ –í–∞—Ä—ñ–∞–Ω—Ç (XL) - –¶—ñ–Ω–∞ 70 –≥—Ä–Ω
    variant_xl = models.ProductVariant(
        product_id=product.id,
        name="XL 400ml",
        price=70.0,
        sku="CAP-XL"
    )
    db.add(variant_xl)
    db.commit()

    # 4. –°—Ç–≤–æ—Ä—é—î–º–æ –¢–µ—Ö–∫–∞—Ä—Ç—É (–ó–≤'—è–∑–∫–∏)
    # –ö–∞–ø—É—á–∏–Ω–æ XL –≤–∏—Ç—Ä–∞—á–∞—î: 300 –º–ª –º–æ–ª–æ–∫–∞
    recipe_milk = models.ProductVariantIngredient(
        variant_id=variant_xl.id,
        ingredient_id=milk.id,
        quantity=300 # 300 –º–ª –Ω–∞ –ø–æ—Ä—Ü—ñ—é
    )
    db.add(recipe_milk)
    db.commit()

    # ... —ñ –º–æ–∂–ª–∏–≤–æ –≤–∏—Ç—Ä–∞—á–∞—î 1 —Å—Ç–∞–∫–∞–Ω—á–∏–∫ (—è–∫—â–æ —É –≤–∞—Å —î –ª–æ–≥—ñ–∫–∞ –ø—Ä–∏–≤'—è–∑–∫–∏ Consumables –¥–æ —Ç–æ–≤–∞—Ä—É)
    # –ü–æ–∫–∏ —â–æ —Ç–µ—Å—Ç—É—î–º–æ —Ç—ñ–ª—å–∫–∏ —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∏, —è–∫ –Ω–∞–π—Å–∫–ª–∞–¥–Ω—ñ—à—É —á–∞—Å—Ç–∏–Ω—É.

    return {
        "product_id": product.id,
        "variant_id": variant_xl.id,
        "ingredient_id": milk.id,
        "consumable_id": cup.id
    }

def test_create_order_zero_trust(client, db_session):
    """
    –ì–û–õ–û–í–ù–ò–ô –¢–ï–°–¢: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É —Ü—ñ–Ω–∏ —Ç–∞ —Å–ø–∏—Å–∞–Ω–Ω—è —Å–∫–ª–∞–¥—É.
    """
    # 1. –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–∏—Ö (–Ω–∞–ø–æ–≤–Ω—é—î–º–æ –ë–î)
    menu = setup_menu(db_session)
    
    # 2. –ï–º—É–ª—è—Ü—ñ—è –∑–∞–ø–∏—Ç—É –≤—ñ–¥ –§—Ä–æ–Ω—Ç–µ–Ω–¥—É (ZERO TRUST - –º–∏ –Ω–µ —à–ª–µ–º–æ —Ü—ñ–Ω—É)
    # –ó–∞–º–æ–≤–ª—è—î–º–æ 2 –≤–µ–ª–∏–∫–∏—Ö –ö–∞–ø—É—á–∏–Ω–æ
    payload = {
        "payment_method": "cash",
        "items": [
            {
                "product_id": menu["product_id"],
                "variant_id": menu["variant_id"],
                "quantity": 2, # –î–≤—ñ –ø–æ—Ä—Ü—ñ—ó
                "modifiers": []
            }
        ]
    }

    # 3. –í–∏–∫–æ–Ω—É—î–º–æ –∑–∞–ø–∏—Ç
    response = client.post("/orders/", json=payload)
    
    # 4. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∏
    assert response.status_code == 200, f"–ü–æ–º–∏–ª–∫–∞ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è: {response.text}"
    order_data = response.json()

    # –ê. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≥—Ä–æ—à–µ–π
    # 2 –ø–æ—Ä—Ü—ñ—ó * 70 –≥—Ä–Ω = 140 –≥—Ä–Ω
    # –Ø–∫—â–æ –±–µ–∫–µ–Ω–¥ –ø–æ–≤–µ—Ä—Ç–∞—î total_amount –≤ response:
    if "total_amount" in order_data:
        assert order_data["total_amount"] == 140.0
    
    # –ë. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑–∞–ø–∏—Å—É –≤ –ë–î (–¥–ª—è –Ω–∞–¥—ñ–π–Ω–æ—Å—Ç—ñ)
    order_id = order_data["id"]
    db_order = db_session.query(models.Order).filter(models.Order.id == order_id).first()
    assert db_order is not None
    assert db_order.total_amount == 140.0
    assert db_order.status == "completed" # –∞–±–æ "new", –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ –≤–∞—à–æ—ó –ª–æ–≥—ñ–∫–∏

    # –í. –ö–†–ò–¢–ò–ß–ù–û: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å–ø–∏—Å–∞–Ω–Ω—è –∑—ñ —Å–∫–ª–∞–¥—É
    # –ë—É–ª–æ 5000 –º–ª. –í–∏—Ç—Ä–∞—Ç–∏–ª–∏: 2 –ø–æ—Ä—Ü—ñ—ó * 300 –º–ª = 600 –º–ª.
    # –ú–∞—î –∑–∞–ª–∏—à–∏—Ç–∏—Å—è: 4400 –º–ª.
    milk = db_session.query(models.Ingredient).filter(models.Ingredient.id == menu["ingredient_id"]).first()
    
    assert milk.stock_quantity == 4400.0, f"–°–∫–ª–∞–¥ –Ω–µ —Å–ø–∏—Å–∞–≤—Å—è! –û—á—ñ–∫—É–≤–∞–ª–∏ 4400, –º–∞—î–º–æ {milk.stock_quantity}"

def test_order_validation_stock(client, db_session):
    """
    –¢–µ—Å—Ç: —á–∏ –¥–æ–∑–≤–æ–ª–∏—Ç—å —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–¥–∞—Ç–∏, —è–∫—â–æ —Ç–æ–≤–∞—Ä—É –Ω–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –Ω–∞ —Å–∫–ª–∞–¥—ñ?
    """
    menu = setup_menu(db_session)
    
    # –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –º–∞–ª–∏–π –∑–∞–ª–∏—à–æ–∫ –º–æ–ª–æ–∫–∞ (—Ç—ñ–ª—å–∫–∏ 100 –º–ª)
    milk = db_session.query(models.Ingredient).filter(models.Ingredient.id == menu["ingredient_id"]).first()
    milk.stock_quantity = 100 
    db_session.commit()

    # –°–ø—Ä–æ–±–∞ –∑–∞–º–æ–≤–∏—Ç–∏ –ö–∞–ø—É—á–∏–Ω–æ XL (—Ç—Ä–µ–±–∞ 300 –º–ª)
    payload = {
        "payment_method": "card",
        "items": [
            {
                "product_id": menu["product_id"],
                "variant_id": menu["variant_id"],
                "quantity": 1
            }
        ]
    }

    response = client.post("/orders/", json=payload)

    # –¢—É—Ç –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ –±—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫–∏:
    # –í–∞—Ä—ñ–∞–Ω—Ç –ê: 400 Bad Request (–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç—ñ–≤)
    # –í–∞—Ä—ñ–∞–Ω—Ç –ë: 200 OK (–ü—Ä–æ–¥–∞—Ç–∏ –≤ –º—ñ–Ω—É—Å)
    # –ó–∞–∑–≤–∏—á–∞–π —É POS –¥–æ–∑–≤–æ–ª—è—é—Ç—å –ø—Ä–æ–¥–∞–≤–∞—Ç–∏ –≤ –º—ñ–Ω—É—Å, –∞–ª–µ –º–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∏–º–æ, —è–∫ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ —É —Ç–µ–±–µ.
    
    if response.status_code == 400:
        assert "–Ω–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ" in response.text.lower()
    elif response.status_code == 200:
        # –Ø–∫—â–æ –¥–æ–∑–≤–æ–ª–µ–Ω–æ –º—ñ–Ω—É—Å, –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —â–æ —Å—Ç–∞–ª–æ -200
        db_session.refresh(milk)
        assert milk.stock_quantity == -200.0
</file>

<file path="product_service\tests\test_warehouse.py">
import pytest

def test_create_unit(client):
    """
    –¢–µ—Å—Ç —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –æ–¥–∏–Ω–∏—Ü—ñ –≤–∏–º—ñ—Ä—É (Unit).
    –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –ø–æ–ª—è name —Ç–∞ symbol.
    """
    payload = {
        "name": "–ö—ñ–ª–æ–≥—Ä–∞–º",
        "symbol": "–∫–≥"
    }
    response = client.post("/units/", json=payload)
    
    assert response.status_code == 200
    data = response.json()
    assert data["name"] == "–ö—ñ–ª–æ–≥—Ä–∞–º"
    assert data["symbol"] == "–∫–≥"
    assert "id" in data

def test_create_ingredient_simple(client):
    """
    –ë–∞–∑–æ–≤–∏–π —Ç–µ—Å—Ç —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∞ (–±–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó).
    """
    # 1. –°—Ç–≤–æ—Ä—é—î–º–æ Unit (–±–æ –±–µ–∑ –Ω—å–æ–≥–æ –Ω–µ –º–æ–∂–Ω–∞)
    unit_resp = client.post("/units/", json={"name": "–õ—ñ—Ç—Ä", "symbol": "–ª"})
    unit_id = unit_resp.json()["id"]

    # 2. –°—Ç–≤–æ—Ä—é—î–º–æ Ingredient
    payload = {
        "name": "–ú–æ–ª–æ–∫–æ 3.2%",
        "cost_per_unit": 45.50,
        "stock_quantity": 10.0,
        "unit_id": unit_id
        # category_id –Ω–µ –ø–µ—Ä–µ–¥–∞—î–º–æ (–≤—ñ–Ω Optional)
    }
    response = client.post("/ingredients/", json=payload)

    assert response.status_code == 200
    data = response.json()
    
    assert data["name"] == "–ú–æ–ª–æ–∫–æ 3.2%"
    assert data["unit_id"] == unit_id
    assert data["stock_quantity"] == 10.0
    # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —â–æ cost_per_unit –∑–±–µ—Ä—ñ–≥—Å—è (float)
    assert float(data["cost_per_unit"]) == 45.50

def test_create_ingredient_with_category(client):
    """
    –¢–µ—Å—Ç —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∞, –ø—Ä–∏–≤'—è–∑–∞–Ω–æ–≥–æ –¥–æ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó.
    –¶–µ –≤–∞–∂–ª–∏–≤–æ –¥–ª—è —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è –Ω–∞ —Å–∫–ª–∞–¥—ñ.
    """
    # 1. –°—Ç–≤–æ—Ä—é—î–º–æ Unit
    u_resp = client.post("/units/", json={"name": "–®—Ç—É–∫–∞", "symbol": "—à—Ç"})
    unit_id = u_resp.json()["id"]

    # 2. –°—Ç–≤–æ—Ä—é—î–º–æ Category (–¥–ª—è —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç—ñ–≤)
    c_resp = client.post("/categories/", json={
        "name": "–û–≤–æ—á—ñ", 
        "slug": "vegetables",
        "color": "#00ff00"
    })
    cat_id = c_resp.json()["id"]

    # 3. –°—Ç–≤–æ—Ä—é—î–º–æ Ingredient –∑ category_id
    payload = {
        "name": "–ê–≤–æ–∫–∞–¥–æ",
        "cost_per_unit": 35.0,
        "stock_quantity": 50,
        "unit_id": unit_id,
        "category_id": cat_id 
    }
    response = client.post("/ingredients/", json=payload)
    
    assert response.status_code == 200
    data = response.json()
    assert data["category_id"] == cat_id
    
    # –Ø–∫—â–æ —Ç–≤—ñ–π –±–µ–∫–µ–Ω–¥ –ø—ñ–¥—Ç—Ä–∏–º—É—î –≤–∫–ª–∞–¥–µ–Ω—ñ—Å—Ç—å (lazy loading), 
    # –º–æ–∂–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏, —á–∏ –ø–æ–≤–µ—Ä–Ω—É–ª–∞—Å—å –Ω–∞–∑–≤–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó, –∞–ª–µ —Ü–µ –æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ
    # assert data["category"]["name"] == "–û–≤–æ—á—ñ"

def test_ingredient_validation(client):
    """
    –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –æ–±–æ–≤'—è–∑–∫–æ–≤–∏—Ö –ø–æ–ª—ñ–≤.
    """
    # –°–ø—Ä–æ–±–∞ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –±–µ–∑ unit_id
    payload_bad = {
        "name": "–ü–æ–≤—ñ—Ç—Ä—è",
        "cost_per_unit": 0,
        "stock_quantity": 0
    }
    response = client.post("/ingredients/", json=payload_bad)
    assert response.status_code == 422  # Validation Error

def test_list_ingredients(client):
    """
    –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Å–ø–∏—Å–∫—É —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç—ñ–≤.
    """
    # –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–∏—Ö
    u_resp = client.post("/units/", json={"name": "–ì—Ä–∞–º", "symbol": "–≥"})
    uid = u_resp.json()["id"]
    
    client.post("/ingredients/", json={
        "name": "–°—ñ–ª—å", "cost_per_unit": 0.1, "stock_quantity": 1000, "unit_id": uid
    })
    client.post("/ingredients/", json={
        "name": "–¶—É–∫–æ—Ä", "cost_per_unit": 0.15, "stock_quantity": 2000, "unit_id": uid
    })

    # –û—Ç—Ä–∏–º–∞–Ω–Ω—è —Å–ø–∏—Å–∫—É
    response = client.get("/ingredients/")
    assert response.status_code == 200
    data = response.json()
    
    assert len(data) >= 2
    names = [i["name"] for i in data]
    assert "–°—ñ–ª—å" in names
    assert "–¶—É–∫–æ—Ä" in names
</file>
