==================================================
PROJECT STRUCTURE (TREE VIEW)
==================================================
ğŸ“‚ pos-system/
    ğŸ“„ .gitignore
    ğŸ“„ docker-compose.yml
    ğŸ“„ context_packer.py
    ğŸ“‚ .history/
        ğŸ“„ docker-compose_20260123212905.yml
        ğŸ“„ docker-compose_20260123161624.yml
        ğŸ“„ docker-compose_20260123214026.yml
        ğŸ“„ context_packer_20260124194053.py
        ğŸ“„ docker-compose_20260123213422.yml
        ğŸ“„ context_packer_20260112193821.py
        ğŸ“‚ order_service/
            ğŸ“„ main_20260124232946.py
            ğŸ“„ main_20260114205817.py
            ğŸ“„ main_20260125095616.py
            ğŸ“„ main_20260124233136.py
        ğŸ“‚ frontend/
            ğŸ“„ package_20260121112129.json
            ğŸ“„ vite.config_20260125093415.js
            ğŸ“„ vite.config_20260125093209.js
            ğŸ“„ package_20260123212441.json
            ğŸ“„ vite.config_20260125094300.js
            ğŸ“„ package_20260123213935.json
            ğŸ“„ Dockerfile_20260121112209
            ğŸ“„ vite.config_20260125093710.js
            ğŸ“„ vite.config_20260125093424.js
            ğŸ“„ Dockerfile_20260123213915
            ğŸ“„ vite.config_20260111184527.js
            ğŸ“„ vite.config_20260125093649.js
            ğŸ“‚ src/
                ğŸ“„ App_20260118165650.vue
                ğŸ“„ App_20260123213853.vue
                ğŸ“‚ components/
                    ğŸ“‚ warehouse/
                        ğŸ“„ Warehouse_20260120225340.vue
                        ğŸ“„ Warehouse_20260123213738.vue
                        ğŸ“‚ tabs/
                            ğŸ“„ CategoriesTab_20260123213624.vue
                            ğŸ“„ ProductsTab_20260123144603.vue
                            ğŸ“„ ProductsTab_20260125144754.vue
                            ğŸ“„ ProductsTab_20260125111040.vue
                            ğŸ“„ CategoriesTab_20260120224534.vue
                            ğŸ“„ StockTab_20260126154010.vue
                            ğŸ“„ UnitsTab_20260123212632.vue
                            ğŸ“„ ProductsTab_20260124215646.vue
                            ğŸ“„ ProductsTab_20260123212706.vue
                            ğŸ“„ ProductsTab_20260125113604.vue
                            ğŸ“„ StockTab_20260125195932.vue
                            ğŸ“„ StockTab_20260124215144.vue
                            ğŸ“„ UnitsTab_20260123123656.vue
                            ğŸ“„ ProductsTab_20260125111944.vue
                            ğŸ“„ StockTab_20260123212645.vue
                            ğŸ“„ StockTab_20260126154519.vue
                            ğŸ“„ ProductsTab_20260125124734.vue
                            ğŸ“„ ProductsTab_20260125111222.vue
                            ğŸ“„ ProductsTab_20260124195231.vue
                            ğŸ“„ StockTab_20260124215257.vue
                            ğŸ“„ StockTab_20260123213718.vue
                            ğŸ“„ StockTab_20260124203436.vue
                            ğŸ“„ ProductsTab_20260125191026.vue
                            ğŸ“„ StockTab_20260125201428.vue
                            ğŸ“„ ProductsTab_20260123213650.vue
                            ğŸ“„ StockTab_20260123205151.vue
                            ğŸ“„ ProductsTab_20260125121120.vue
                        ğŸ“‚ modals/
                            ğŸ“„ HistoryModal_20260125094534.vue
                            ğŸ“„ HistoryModal_20260125094125.vue
                            ğŸ“„ HistoryModal_20260126175653.vue
                            ğŸ“„ HistoryModal_20260126154533.vue
                            ğŸ“„ HistoryModal_20260125093943.vue
                            ğŸ“„ HistoryModal_20260126175545.vue
                            ğŸ“„ HistoryModal_20260124233306.vue
                            ğŸ“„ HistoryModal_20260123213613.vue
                            ğŸ“„ HistoryModal_20260126155353.vue
                            ğŸ“„ HistoryModal_20260126181946.vue
                            ğŸ“„ HistoryModal_20260125102650.vue
                            ğŸ“„ HistoryModal_20260125102154.vue
                            ğŸ“„ HistoryModal_20260126160502.vue
                            ğŸ“„ HistoryModal_20260126154913.vue
                            ğŸ“„ HistoryModal_20260118195805.vue
                            ğŸ“„ HistoryModal_20260126153922.vue
                ğŸ“‚ composables/
                    ğŸ“„ useProducts_20260125120953.js
                    ğŸ“„ useProducts_20260124215454.js
                    ğŸ“„ useProducts_20260123162643.js
                    ğŸ“„ useProducts_20260123213821.js
                    ğŸ“„ useProducts_20260124195040.js
                    ğŸ“„ useProducts_20260124201408.js
                    ğŸ“„ useWarehouse_20260123212512.js
                    ğŸ“„ useWarehouse_20260123213838.js
                    ğŸ“„ useWarehouse_20260124222845.js
                    ğŸ“„ useWarehouse_20260123205302.js
                    ğŸ“„ useProducts_20260123212543.js
        ğŸ“‚ product_service/
            ğŸ“„ models_20260126160805.py
            ğŸ“„ models_20260120112422.py
            ğŸ“„ schemas_20260123211329.py
            ğŸ“„ models_20260126085154.py
            ğŸ“„ models_20260123212114.py
            ğŸ“„ schemas_20260120113306.py
            ğŸ“„ models_20260123212354.py
            ğŸ“„ models_20260126084638.py
            ğŸ“‚ routers/
                ğŸ“„ inventory_20260123122832.py
                ğŸ“„ products_20260125124228.py
                ğŸ“„ inventory_20260123212423.py
                ğŸ“„ inventory_20260125204227.py
                ğŸ“„ inventory_20260123212211.py
                ğŸ“„ inventory_20260125095952.py
                ğŸ“„ products_20260125204117.py
                ğŸ“„ categories_20260123212245.py
                ğŸ“„ inventory_20260126181505.py
                ğŸ“„ products_20260125222457.py
                ğŸ“„ inventory_20260125204046.py
                ğŸ“„ products_20260125223503.py
                ğŸ“„ products_20260123212139.py
                ğŸ“„ inventory_20260124232207.py
                ğŸ“„ inventory_20260125222418.py
                ğŸ“„ categories_20260123212412.py
                ğŸ“„ inventory_20260125223438.py
                ğŸ“„ inventory_20260124232611.py
                ğŸ“„ products_20260120130137.py
                ğŸ“„ products_20260125124231.py
                ğŸ“„ inventory_20260126160649.py
                ğŸ“„ products_20260125204218.py
                ğŸ“„ categories_20260120224434.py
            ğŸ“‚ services/
                ğŸ“„ product_service_20260123212342.py
                ğŸ“„ inventory_logger_20260123212315.py
                ğŸ“„ product_service_20260120122235.py
                ğŸ“„ product_service_20260125182057.py
                ğŸ“„ product_service_20260125182053.py
                ğŸ“„ order_service_20260120181647.py
                ğŸ“„ product_service_20260125170408.py
                ğŸ“„ order_service_20260124232907.py
                ğŸ“„ order_service_20260123212328.py
                ğŸ“„ product_service_20260125184645.py
                ğŸ“„ inventory_logger_20260118195317.py
                ğŸ“„ inventory_logger_20260126180651.py
    ğŸ“‚ order_service/
        ğŸ“„ requirements.txt
        ğŸ“„ schemas.py
        ğŸ“„ main.py
        ğŸ“„ Dockerfile
    ğŸ“‚ test_folder/
    ğŸ“‚ frontend/
        ğŸ“„ index.html
        ğŸ“„ vite.config.js
        ğŸ“„ .gitignore
        ğŸ“„ README.md
        ğŸ“„ package.json
        ğŸ“„ postcss.config.js
        ğŸ“„ nginx.conf
        ğŸ“„ Dockerfile
        ğŸ“„ tailwind.config.js
        ğŸ“‚ src/
            ğŸ“„ App.vue
            ğŸ“„ style.css
            ğŸ“„ main.js
            ğŸ“‚ components/
                ğŸ“‚ common/
                    ğŸ“„ Sidebar.vue
                    ğŸ“„ IngredientSelect.vue
                ğŸ“‚ warehouse/
                    ğŸ“„ Warehouse.vue
                    ğŸ“‚ tabs/
                        ğŸ“„ ProcessesTab.vue
                        ğŸ“„ RecipesTab.vue
                        ğŸ“„ CategoriesTab.vue
                        ğŸ“„ StockTab.vue
                        ğŸ“„ IngredientsTab.vue
                        ğŸ“„ UnitsTab.vue
                        ğŸ“„ ConsumablesTab.vue
                        ğŸ“„ ProductsTab.vue
                    ğŸ“‚ modals/
                        ğŸ“„ HistoryModal.vue
                ğŸ“‚ pos/
                    ğŸ“„ ProductCard.vue
                    ğŸ“„ ProductModal.vue
                    ğŸ“„ CartDrawer.vue
                ğŸ“‚ crm/
                    ğŸ“„ Customers.vue
                    ğŸ“„ CustomersTable.vue
                ğŸ“‚ stats/
                    ğŸ“„ Statistics.vue
                    ğŸ“„ SalesTable.vue
            ğŸ“‚ assets/
                ğŸ“„ vue.svg
            ğŸ“‚ composables/
                ğŸ“„ useCustomers.js
                ğŸ“„ useCart.js
                ğŸ“„ useStatistics.js
                ğŸ“„ useWarehouse.js
                ğŸ“„ useProducts.js
        ğŸ“‚ public/
            ğŸ“„ vite.svg
    ğŸ“‚ product_service/
        ğŸ“„ requirements.txt
        ğŸ“„ schemas.py
        ğŸ“„ database.py
        ğŸ“„ main.py
        ğŸ“„ models.py
        ğŸ“„ Dockerfile
        ğŸ“‚ routers/
            ğŸ“„ recipes.py
            ğŸ“„ categories.py
            ğŸ“„ orders.py
            ğŸ“„ inventory.py
            ğŸ“„ __init__.py
            ğŸ“„ products.py
            ğŸ“„ processes.py
            ğŸ“„ customers.py
        ğŸ“‚ services/
            ğŸ“„ order_service.py
            ğŸ“„ __init__.py
            ğŸ“„ inventory_logger.py
            ğŸ“„ product_service.py

==================================================
FILE CONTENTS
==================================================


--------------------------------------------------
PATH: ./docker-compose.yml
--------------------------------------------------
#version: '3.8'

services:
  # --- 1. Ğ¡Ğ•Ğ Ğ’Ğ†Ğ¡ Ğ¢ĞĞ’ĞĞ Ğ†Ğ’ (Backend) ---
  product_service:
    build: ./product_service
    container_name: pos_product_service
    restart: always
    ports:
      - "8001:8000"
    environment:
      # Ğ—Ğ²'ÑĞ·Ğ¾Ğº Ğ· Ğ±Ğ°Ğ·Ğ¾Ñ Ğ´Ğ°Ğ½Ğ¸Ñ… (postgres_db - Ñ†Ğµ Ğ½Ğ°Ğ·Ğ²Ğ° ÑĞµÑ€Ğ²Ñ–ÑÑƒ Ğ½Ğ¸Ğ¶Ñ‡Ğµ)
      - DATABASE_URL=postgresql://user:password@postgres_db:5432/products_db
    depends_on:
      - postgres_db
        

  # --- 2. Ğ‘ĞĞ—Ğ Ğ”ĞĞĞ˜Ğ¥ Ğ¢ĞĞ’ĞĞ Ğ†Ğ’ (PostgreSQL) ---
  postgres_db:
    image: postgres:13
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d products_db"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s
    container_name: pos_postgres
    restart: always
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: products_db
    volumes:
      # Ğ—Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ñ”Ğ¼Ğ¾ Ğ´Ğ°Ğ½Ñ– Ğ½Ğ° Ğ´Ğ¸ÑĞºÑƒ, Ñ‰Ğ¾Ğ± Ğ½Ğµ Ğ·Ğ½Ğ¸ĞºĞ°Ğ»Ğ¸ Ğ¿Ñ€Ğ¸ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞºÑƒ
      - postgres_data:/var/lib/postgresql/data

  # --- 3. Ğ¡Ğ•Ğ Ğ’Ğ†Ğ¡ ĞšĞĞ¨Ğ˜ĞšĞ (Backend) ---
  order_service:
    build: ./order_service
    container_name: pos_order_service
    restart: always
    environment:
      # Ğ—Ğ²'ÑĞ·Ğ¾Ğº Ğ· Redis
      - REDIS_HOST=redis_db
    depends_on:
      - redis_db

  # --- 4. Ğ‘ĞĞ—Ğ Ğ”ĞĞĞ˜Ğ¥ ĞšĞĞ¨Ğ˜ĞšĞ (Redis) ---
  redis_db:
    image: redis:alpine
    container_name: pos_redis
    restart: always

  # --- 5. Ğ’Ğ¥Ğ†Ğ”ĞĞ† Ğ’ĞĞ ĞĞ¢Ğ (Nginx) ---
  frontend:  # <-- ĞĞĞ’Ğ ĞĞĞ—Ğ’Ğ (Ğ±ÑƒĞ»Ğ¾ nginx Ğ°Ğ±Ğ¾ gateway)
    build: ./frontend
    container_name: pos_frontend # <-- ĞĞĞ’Ğ• Ğ†Ğœ'Ğ¯ ĞšĞĞĞ¢Ğ•Ğ™ĞĞ•Ğ Ğ
    restart: always
    ports:
      - "8080:80"
    depends_on:
      - product_service
      - order_service

# ĞĞ³Ğ¾Ğ»Ğ¾ÑˆÑƒÑ”Ğ¼Ğ¾ Ñ‚Ğ¾Ğ¼Ğ¸ Ğ´Ğ»Ñ Ğ·Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ğ½Ğ½Ñ Ğ´Ğ°Ğ½Ğ¸Ñ…
volumes:
  postgres_data:


--------------------------------------------------
PATH: ./context_packer.py
--------------------------------------------------
import os

# --- ĞšĞĞĞ¤Ğ†Ğ“Ğ£Ğ ĞĞ¦Ğ†Ğ¯ ---

# ĞŸĞ°Ğ¿ĞºĞ¸, ÑĞºÑ– Ğ¼Ğ¸ ĞŸĞĞ’ĞĞ†Ğ¡Ğ¢Ğ® Ñ–Ğ³Ğ½Ğ¾Ñ€ÑƒÑ”Ğ¼Ğ¾ (Ğ½Ğµ Ğ·Ğ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ Ğ²ÑĞµÑ€ĞµĞ´Ğ¸Ğ½Ñƒ)
IGNORE_DIRS = {
    '.git', 'node_modules', '__pycache__', 'venv', 'env', '.idea', '.vscode', 
    'dist', 'build', 'postgres_data', '.pytest_cache', 'migrations'
}

# Ğ¤Ğ°Ğ¹Ğ»Ğ¸, ÑĞºÑ– Ğ¼Ğ¸ Ñ–Ğ³Ğ½Ğ¾Ñ€ÑƒÑ”Ğ¼Ğ¾ (Ğ½Ğµ Ğ¿Ğ¾ĞºĞ°Ğ·ÑƒÑ”Ğ¼Ğ¾ Ğ² Ğ´ĞµÑ€ĞµĞ²Ñ– Ñ– Ğ½Ğµ Ñ‡Ğ¸Ñ‚Ğ°Ñ”Ğ¼Ğ¾)
IGNORE_FILES = {
    'package-lock.json', 'yarn.lock', 'collect_code.py', '.DS_Store', 
    'pnpm-lock.yaml', 'poetry.lock', 'full_project_context.txt' # Ğ†Ğ³Ğ½Ğ¾Ñ€ÑƒÑ”Ğ¼Ğ¾ ÑĞ°Ğ¼ Ñ„Ğ°Ğ¹Ğ» Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñƒ
}

# Ğ Ğ¾Ğ·ÑˆĞ¸Ñ€ĞµĞ½Ğ½Ñ Ñ„Ğ°Ğ¹Ğ»Ñ–Ğ², ĞºĞ¾Ğ´ ÑĞºĞ¸Ñ… Ğ½Ğ°Ğ¼ ĞŸĞĞ¢Ğ Ğ†Ğ‘Ğ•Ğ
# (Ğ’ÑÑ– Ñ–Ğ½ÑˆÑ– Ñ„Ğ°Ğ¹Ğ»Ğ¸ Ğ±ÑƒĞ´ÑƒÑ‚ÑŒ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ğ½Ñ– Ğ² Ğ´ĞµÑ€ĞµĞ²Ñ–, Ğ°Ğ»Ğµ Ñ—Ñ… Ğ²Ğ¼Ñ–ÑÑ‚ Ğ½Ğµ Ğ±ÑƒĞ´Ğµ Ğ·Ñ‡Ğ¸Ñ‚Ğ°Ğ½Ğ¾)
ALLOWED_EXTENSIONS = {
    '.py', '.js', '.vue', '.html', '.css', '.scss', 
    '.yml', '.yaml', '.json', '.sql', '.dockerfile', 
    '.sh', '.md', '.txt'
}

EXACT_FILES_TO_READ = {'Dockerfile', 'docker-compose.yml', 'requirements.txt', 'package.json'}

def get_size_format(b, factor=1024, suffix="B"):
    """ĞšĞ¾Ğ½Ğ²ĞµÑ€Ñ‚ÑƒÑ” Ğ±Ğ°Ğ¹Ñ‚Ğ¸ Ğ² Ñ‡Ğ¸Ñ‚Ğ°Ğ±ĞµĞ»ÑŒĞ½Ğ¸Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ (KB, MB, etc.)"""
    for unit in ["", "K", "M", "G", "T", "P", "E", "Z"]:
        if b < factor:
            return f"{b:.2f}{unit}{suffix}"
        b /= factor
    return f"{b:.2f}Y{suffix}"

def get_project_tree(start_path='.'):
    """Ğ“ĞµĞ½ĞµÑ€ÑƒÑ” Ğ²Ñ–Ğ·ÑƒĞ°Ğ»ÑŒĞ½Ğµ Ğ´ĞµÑ€ĞµĞ²Ğ¾ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ñƒ."""
    tree_output = []
    
    for root, dirs, files in os.walk(start_path):
        # Ğ¤Ñ–Ğ»ÑŒÑ‚Ñ€ÑƒÑ”Ğ¼Ğ¾ Ğ¿Ğ°Ğ¿ĞºĞ¸ "Ğ½Ğ° Ğ»ÑŒĞ¾Ñ‚Ñƒ"
        dirs[:] = [d for d in dirs if d not in IGNORE_DIRS]
        
        level = root.replace(start_path, '').count(os.sep)
        indent = ' ' * 4 * level
        folder_name = os.path.basename(root)
        if folder_name == '.':
            folder_name = os.path.basename(os.getcwd())
            
        tree_output.append(f"{indent}ğŸ“‚ {folder_name}/")
        
        subindent = ' ' * 4 * (level + 1)
        for f in files:
            if f not in IGNORE_FILES:
                tree_output.append(f"{subindent}ğŸ“„ {f}")
                
    return "\n".join(tree_output)

def collect_project_code(output_file='full_project_context.txt'):
    print("â³ ĞĞ½Ğ°Ğ»Ñ–Ğ·ÑƒÑ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñƒ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ñƒ Ñ‚Ğ° Ğ·Ğ±Ğ¸Ñ€Ğ°Ñ ĞºĞ¾Ğ´...")
    
    with open(output_file, 'w', encoding='utf-8') as outfile:
        # 1. Ğ—ĞĞŸĞ˜Ğ¡Ğ£Ğ„ĞœĞ Ğ¡Ğ¢Ğ Ğ£ĞšĞ¢Ğ£Ğ Ğ£ ĞŸĞ ĞĞ•ĞšĞ¢Ğ£
        outfile.write("="*50 + "\n")
        outfile.write("PROJECT STRUCTURE (TREE VIEW)\n")
        outfile.write("="*50 + "\n")
        outfile.write(get_project_tree('.'))
        outfile.write("\n\n" + "="*50 + "\n")
        outfile.write("FILE CONTENTS\n")
        outfile.write("="*50 + "\n\n")

        # 2. Ğ—ĞĞŸĞ˜Ğ¡Ğ£Ğ„ĞœĞ Ğ’ĞœĞ†Ğ¡Ğ¢ Ğ¤ĞĞ™Ğ›Ğ†Ğ’
        file_count = 0
        for root, dirs, files in os.walk('.'):
            # Ğ¤Ñ–Ğ»ÑŒÑ‚Ñ€ÑƒÑ”Ğ¼Ğ¾ Ğ¿Ğ°Ğ¿ĞºĞ¸
            dirs[:] = [d for d in dirs if d not in IGNORE_DIRS]
            
            for file in files:
                if file in IGNORE_FILES:
                    continue
                
                ext = os.path.splitext(file)[1]
                
                # Ğ§Ğ¸Ñ‚Ğ°Ñ”Ğ¼Ğ¾ Ñ„Ğ°Ğ¹Ğ», Ñ‚Ñ–Ğ»ÑŒĞºĞ¸ ÑĞºÑ‰Ğ¾ Ğ²Ñ–Ğ½ Ñƒ ÑĞ¿Ğ¸ÑĞºÑƒ Ğ´Ğ¾Ğ·Ğ²Ğ¾Ğ»ĞµĞ½Ğ¸Ñ…
                if ext in ALLOWED_EXTENSIONS or file in EXACT_FILES_TO_READ:
                    file_path = os.path.join(root, file)
                    
                    # Ğ—Ğ°Ğ¿Ğ¸ÑÑƒÑ”Ğ¼Ğ¾ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº Ñ„Ğ°Ğ¹Ğ»Ñƒ
                    outfile.write(f"\n{'-'*50}\n")
                    outfile.write(f"PATH: {file_path}\n")
                    outfile.write(f"{'-'*50}\n")
                    
                    try:
                        with open(file_path, 'r', encoding='utf-8', errors='ignore') as infile:
                            content = infile.read()
                            if not content.strip():
                                outfile.write("[EMPTY FILE]\n")
                            else:
                                outfile.write(content)
                                outfile.write("\n") 
                        file_count += 1
                    except Exception as e:
                        outfile.write(f"[ERROR READING FILE: {e}]\n")

    # --- ĞĞ¢Ğ Ğ˜ĞœĞĞĞĞ¯ Ğ ĞĞ—ĞœĞ†Ğ Ğ£ Ğ¤ĞĞ™Ğ›Ğ£ ---
    file_size = os.path.getsize(output_file)
    readable_size = get_size_format(file_size)

    print("-" * 40)
    print(f"âœ… Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾! Ğ—Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ¾ {file_count} Ñ„Ğ°Ğ¹Ğ»Ñ–Ğ².")
    print(f"ğŸ“ Ğ¤Ğ°Ğ¹Ğ» Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñƒ: {output_file}")
    print(f"ğŸ“Š Ğ Ğ¾Ğ·Ğ¼Ñ–Ñ€ Ñ„Ğ°Ğ¹Ğ»Ñƒ: {readable_size}")
    print("-" * 40)
    
    # ĞŸĞ¾Ğ¿ĞµÑ€ĞµĞ´Ğ¶ĞµĞ½Ğ½Ñ, ÑĞºÑ‰Ğ¾ Ñ„Ğ°Ğ¹Ğ» Ğ·Ğ°Ğ²ĞµĞ»Ğ¸ĞºĞ¸Ğ¹ Ğ´Ğ»Ñ Ñ‡Ğ°Ñ‚Ñƒ
    if file_size > 10 * 1024 * 1024: # 10 MB
        print("âš ï¸ Ğ£Ğ’ĞĞ“Ğ: Ğ¤Ğ°Ğ¹Ğ» Ğ´Ğ¾ÑĞ¸Ñ‚ÑŒ Ğ²ĞµĞ»Ğ¸ĞºĞ¸Ğ¹ (>10MB). ĞœĞ¾Ğ¶Ğ»Ğ¸Ğ²Ğ¾, Ğ²Ğ°Ñ€Ñ‚Ğ¾ Ğ´Ğ¾Ğ´Ğ°Ñ‚Ğ¸ Ñ‰Ğ¾ÑÑŒ Ñƒ IGNORE_DIRS.")

if __name__ == '__main__':
    collect_project_code()

--------------------------------------------------
PATH: ./.history/docker-compose_20260123212905.yml
--------------------------------------------------
#version: '3.8'

services:
  # --- 1. Ğ¡Ğ•Ğ Ğ’Ğ†Ğ¡ Ğ¢ĞĞ’ĞĞ Ğ†Ğ’ (Backend) ---
  product_service:
    build: ./product_service
    container_name: pos_product_service
    restart: always
    ports:
      - "8001:8000"
    environment:
      # Ğ—Ğ²'ÑĞ·Ğ¾Ğº Ğ· Ğ±Ğ°Ğ·Ğ¾Ñ Ğ´Ğ°Ğ½Ğ¸Ñ… (postgres_db - Ñ†Ğµ Ğ½Ğ°Ğ·Ğ²Ğ° ÑĞµÑ€Ğ²Ñ–ÑÑƒ Ğ½Ğ¸Ğ¶Ñ‡Ğµ)
      - DATABASE_URL=postgresql://user:password@postgres_db:5432/products_db
    depends_on:
      - postgres_db
        

  # --- 2. Ğ‘ĞĞ—Ğ Ğ”ĞĞĞ˜Ğ¥ Ğ¢ĞĞ’ĞĞ Ğ†Ğ’ (PostgreSQL) ---
  postgres_db:
    image: postgres:13
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d products_db"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s
    container_name: pos_postgres
    restart: always
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: products_db
    volumes:
      # Ğ—Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ñ”Ğ¼Ğ¾ Ğ´Ğ°Ğ½Ñ– Ğ½Ğ° Ğ´Ğ¸ÑĞºÑƒ, Ñ‰Ğ¾Ğ± Ğ½Ğµ Ğ·Ğ½Ğ¸ĞºĞ°Ğ»Ğ¸ Ğ¿Ñ€Ğ¸ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞºÑƒ
      - postgres_data:/var/lib/postgresql/data

  # --- 3. Ğ¡Ğ•Ğ Ğ’Ğ†Ğ¡ ĞšĞĞ¨Ğ˜ĞšĞ (Backend) ---
  order_service:
    build: ./order_service
    container_name: pos_order_service
    restart: always
    environment:
      # Ğ—Ğ²'ÑĞ·Ğ¾Ğº Ğ· Redis
      - REDIS_HOST=redis_db
    depends_on:
      - redis_db

  # --- 4. Ğ‘ĞĞ—Ğ Ğ”ĞĞĞ˜Ğ¥ ĞšĞĞ¨Ğ˜ĞšĞ (Redis) ---
  redis_db:
    image: redis:alpine
    container_name: pos_redis
    restart: always

  # --- FRONTEND (DEVELOPMENT MODE) ---
  frontend:
    build:
      context: ./frontend
      # Ğ’Ğ°Ğ¶Ğ»Ğ¸Ğ²Ğ¾: Ğ¼Ğ¸ Ğ½Ğµ Ğ²Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ Nginx, Ğ¼Ğ¸ Ğ·ÑƒĞ¿Ğ¸Ğ½ÑÑ”Ğ¼Ğ¾ÑÑŒ Ğ½Ğ° ĞµÑ‚Ğ°Ğ¿Ñ– Ğ·Ñ– Node.js
      dockerfile: Dockerfile 
      target: build-stage 
    container_name: pos_frontend
    restart: always
    volumes:
      # ĞœĞĞ“Ğ†Ğ¯: ĞœĞ¸ "Ğ¿Ñ€Ğ¾ĞºĞ¸Ğ´Ğ°Ñ”Ğ¼Ğ¾" Ñ‚Ğ²Ğ¾Ñ Ğ¿Ğ°Ğ¿ĞºÑƒ Ğ· ĞºĞ¾Ğ´Ğ¾Ğ¼ Ğ²ÑĞµÑ€ĞµĞ´Ğ¸Ğ½Ñƒ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ°.
      # Ğ¢ĞµĞ¿ĞµÑ€ Ğ·Ğ¼Ñ–Ğ½Ğ¸ Ñ„Ğ°Ğ¹Ğ»Ñ–Ğ² Ğ½Ğ° Ñ‚Ğ²Ğ¾Ñ”Ğ¼Ñƒ ĞŸĞš Ğ¼Ğ¸Ñ‚Ñ‚Ñ”Ğ²Ğ¾ Ğ²Ğ¸Ğ´Ğ½Ğ¾ Ğ² ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ñ–.
      - ./frontend:/app
      # Ğ¦Ğµ Ğ·Ğ°Ñ…Ğ¸Ñ‰Ğ°Ñ” Ğ¿Ğ°Ğ¿ĞºÑƒ node_modules ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ° Ğ²Ñ–Ğ´ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿Ğ¸ÑÑƒ Ñ‚Ğ²Ğ¾Ñ”Ñ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ñ (ÑĞºÑ‰Ğ¾ Ñ‚Ğ°Ğ¼ Ñ€Ñ–Ğ·Ğ½Ñ– ĞĞ¡)
      - /app/node_modules
    ports:
      # Vite Ğ·Ğ° Ğ·Ğ°Ğ¼Ğ¾Ğ²Ñ‡ÑƒĞ²Ğ°Ğ½Ğ½ÑĞ¼ Ğ¿Ñ€Ğ°Ñ†ÑÑ” Ğ½Ğ° 5173. ĞŸÑ€Ğ¾ĞºĞ¸Ğ´Ğ°Ñ”Ğ¼Ğ¾ Ğ¹Ğ¾Ğ³Ğ¾ Ğ½Ğ°Ğ·Ğ¾Ğ²Ğ½Ñ–.
      - "5173:5173"
    # ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° Ğ·Ğ°Ğ¿ÑƒÑĞºÑƒ Dev-ÑĞµÑ€Ğ²ĞµÑ€Ğ° Ğ·Ğ°Ğ¼Ñ–ÑÑ‚ÑŒ Nginx
    command: npm run dev -- --host
    environment:
      - VITE_API_URL=http://localhost:8001

# ĞĞ³Ğ¾Ğ»Ğ¾ÑˆÑƒÑ”Ğ¼Ğ¾ Ñ‚Ğ¾Ğ¼Ğ¸ Ğ´Ğ»Ñ Ğ·Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ğ½Ğ½Ñ Ğ´Ğ°Ğ½Ğ¸Ñ…
volumes:
  postgres_data:


--------------------------------------------------
PATH: ./.history/docker-compose_20260123161624.yml
--------------------------------------------------
#version: '3.8'

services:
  # --- 1. Ğ¡Ğ•Ğ Ğ’Ğ†Ğ¡ Ğ¢ĞĞ’ĞĞ Ğ†Ğ’ (Backend) ---
  product_service:
    build: ./product_service
    container_name: pos_product_service
    restart: always
    ports:
      - "8001:8000"
    environment:
      # Ğ—Ğ²'ÑĞ·Ğ¾Ğº Ğ· Ğ±Ğ°Ğ·Ğ¾Ñ Ğ´Ğ°Ğ½Ğ¸Ñ… (postgres_db - Ñ†Ğµ Ğ½Ğ°Ğ·Ğ²Ğ° ÑĞµÑ€Ğ²Ñ–ÑÑƒ Ğ½Ğ¸Ğ¶Ñ‡Ğµ)
      - DATABASE_URL=postgresql://user:password@postgres_db:5432/products_db
    depends_on:
      - postgres_db
        

  # --- 2. Ğ‘ĞĞ—Ğ Ğ”ĞĞĞ˜Ğ¥ Ğ¢ĞĞ’ĞĞ Ğ†Ğ’ (PostgreSQL) ---
  postgres_db:
    image: postgres:13
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d products_db"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s
    container_name: pos_postgres
    restart: always
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: products_db
    volumes:
      # Ğ—Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ñ”Ğ¼Ğ¾ Ğ´Ğ°Ğ½Ñ– Ğ½Ğ° Ğ´Ğ¸ÑĞºÑƒ, Ñ‰Ğ¾Ğ± Ğ½Ğµ Ğ·Ğ½Ğ¸ĞºĞ°Ğ»Ğ¸ Ğ¿Ñ€Ğ¸ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞºÑƒ
      - postgres_data:/var/lib/postgresql/data

  # --- 3. Ğ¡Ğ•Ğ Ğ’Ğ†Ğ¡ ĞšĞĞ¨Ğ˜ĞšĞ (Backend) ---
  order_service:
    build: ./order_service
    container_name: pos_order_service
    restart: always
    environment:
      # Ğ—Ğ²'ÑĞ·Ğ¾Ğº Ğ· Redis
      - REDIS_HOST=redis_db
    depends_on:
      - redis_db

  # --- 4. Ğ‘ĞĞ—Ğ Ğ”ĞĞĞ˜Ğ¥ ĞšĞĞ¨Ğ˜ĞšĞ (Redis) ---
  redis_db:
    image: redis:alpine
    container_name: pos_redis
    restart: always

  # --- FRONTEND (DEVELOPMENT MODE) ---
  frontend:
    build:
      context: ./frontend
      # Ğ’Ğ°Ğ¶Ğ»Ğ¸Ğ²Ğ¾: Ğ¼Ğ¸ Ğ½Ğµ Ğ²Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ Nginx, Ğ¼Ğ¸ Ğ·ÑƒĞ¿Ğ¸Ğ½ÑÑ”Ğ¼Ğ¾ÑÑŒ Ğ½Ğ° ĞµÑ‚Ğ°Ğ¿Ñ– Ğ·Ñ– Node.js
      dockerfile: Dockerfile 
      target: build-stage 
    container_name: pos_frontend
    restart: always
    volumes:
      # ĞœĞĞ“Ğ†Ğ¯: ĞœĞ¸ "Ğ¿Ñ€Ğ¾ĞºĞ¸Ğ´Ğ°Ñ”Ğ¼Ğ¾" Ñ‚Ğ²Ğ¾Ñ Ğ¿Ğ°Ğ¿ĞºÑƒ Ğ· ĞºĞ¾Ğ´Ğ¾Ğ¼ Ğ²ÑĞµÑ€ĞµĞ´Ğ¸Ğ½Ñƒ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ°.
      # Ğ¢ĞµĞ¿ĞµÑ€ Ğ·Ğ¼Ñ–Ğ½Ğ¸ Ñ„Ğ°Ğ¹Ğ»Ñ–Ğ² Ğ½Ğ° Ñ‚Ğ²Ğ¾Ñ”Ğ¼Ñƒ ĞŸĞš Ğ¼Ğ¸Ñ‚Ñ‚Ñ”Ğ²Ğ¾ Ğ²Ğ¸Ğ´Ğ½Ğ¾ Ğ² ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ñ–.
      - ./frontend:/app
      # Ğ¦Ğµ Ğ·Ğ°Ñ…Ğ¸Ñ‰Ğ°Ñ” Ğ¿Ğ°Ğ¿ĞºÑƒ node_modules ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ° Ğ²Ñ–Ğ´ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿Ğ¸ÑÑƒ Ñ‚Ğ²Ğ¾Ñ”Ñ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ñ (ÑĞºÑ‰Ğ¾ Ñ‚Ğ°Ğ¼ Ñ€Ñ–Ğ·Ğ½Ñ– ĞĞ¡)
      - /app/node_modules
    ports:
      # Vite Ğ·Ğ° Ğ·Ğ°Ğ¼Ğ¾Ğ²Ñ‡ÑƒĞ²Ğ°Ğ½Ğ½ÑĞ¼ Ğ¿Ñ€Ğ°Ñ†ÑÑ” Ğ½Ğ° 5173. ĞŸÑ€Ğ¾ĞºĞ¸Ğ´Ğ°Ñ”Ğ¼Ğ¾ Ğ¹Ğ¾Ğ³Ğ¾ Ğ½Ğ°Ğ·Ğ¾Ğ²Ğ½Ñ–.
      - "5173:5173"
    # ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° Ğ·Ğ°Ğ¿ÑƒÑĞºÑƒ Dev-ÑĞµÑ€Ğ²ĞµÑ€Ğ° Ğ·Ğ°Ğ¼Ñ–ÑÑ‚ÑŒ Nginx
    command: npm run dev -- --host
    environment:
      - VITE_API_URL=http://localhost:8001

# ĞĞ³Ğ¾Ğ»Ğ¾ÑˆÑƒÑ”Ğ¼Ğ¾ Ñ‚Ğ¾Ğ¼Ğ¸ Ğ´Ğ»Ñ Ğ·Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ğ½Ğ½Ñ Ğ´Ğ°Ğ½Ğ¸Ñ…
volumes:
  postgres_data:


--------------------------------------------------
PATH: ./.history/docker-compose_20260123214026.yml
--------------------------------------------------
#version: '3.8'

services:
  # --- 1. Ğ¡Ğ•Ğ Ğ’Ğ†Ğ¡ Ğ¢ĞĞ’ĞĞ Ğ†Ğ’ (Backend) ---
  product_service:
    build: ./product_service
    container_name: pos_product_service
    restart: always
    ports:
      - "8001:8000"
    environment:
      # Ğ—Ğ²'ÑĞ·Ğ¾Ğº Ğ· Ğ±Ğ°Ğ·Ğ¾Ñ Ğ´Ğ°Ğ½Ğ¸Ñ… (postgres_db - Ñ†Ğµ Ğ½Ğ°Ğ·Ğ²Ğ° ÑĞµÑ€Ğ²Ñ–ÑÑƒ Ğ½Ğ¸Ğ¶Ñ‡Ğµ)
      - DATABASE_URL=postgresql://user:password@postgres_db:5432/products_db
    depends_on:
      - postgres_db
        

  # --- 2. Ğ‘ĞĞ—Ğ Ğ”ĞĞĞ˜Ğ¥ Ğ¢ĞĞ’ĞĞ Ğ†Ğ’ (PostgreSQL) ---
  postgres_db:
    image: postgres:13
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d products_db"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s
    container_name: pos_postgres
    restart: always
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: products_db
    volumes:
      # Ğ—Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ñ”Ğ¼Ğ¾ Ğ´Ğ°Ğ½Ñ– Ğ½Ğ° Ğ´Ğ¸ÑĞºÑƒ, Ñ‰Ğ¾Ğ± Ğ½Ğµ Ğ·Ğ½Ğ¸ĞºĞ°Ğ»Ğ¸ Ğ¿Ñ€Ğ¸ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞºÑƒ
      - postgres_data:/var/lib/postgresql/data

  # --- 3. Ğ¡Ğ•Ğ Ğ’Ğ†Ğ¡ ĞšĞĞ¨Ğ˜ĞšĞ (Backend) ---
  order_service:
    build: ./order_service
    container_name: pos_order_service
    restart: always
    environment:
      # Ğ—Ğ²'ÑĞ·Ğ¾Ğº Ğ· Redis
      - REDIS_HOST=redis_db
    depends_on:
      - redis_db

  # --- 4. Ğ‘ĞĞ—Ğ Ğ”ĞĞĞ˜Ğ¥ ĞšĞĞ¨Ğ˜ĞšĞ (Redis) ---
  redis_db:
    image: redis:alpine
    container_name: pos_redis
    restart: always

  # --- FRONTEND (DEVELOPMENT MODE) ---
  frontend:
    build:
      context: ./frontend
      # Ğ’Ğ°Ğ¶Ğ»Ğ¸Ğ²Ğ¾: Ğ¼Ğ¸ Ğ½Ğµ Ğ²Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ Nginx, Ğ¼Ğ¸ Ğ·ÑƒĞ¿Ğ¸Ğ½ÑÑ”Ğ¼Ğ¾ÑÑŒ Ğ½Ğ° ĞµÑ‚Ğ°Ğ¿Ñ– Ğ·Ñ– Node.js
      dockerfile: Dockerfile 
      target: build-stage 
    container_name: pos_frontend
    restart: always
    volumes:
      # ĞœĞĞ“Ğ†Ğ¯: ĞœĞ¸ "Ğ¿Ñ€Ğ¾ĞºĞ¸Ğ´Ğ°Ñ”Ğ¼Ğ¾" Ñ‚Ğ²Ğ¾Ñ Ğ¿Ğ°Ğ¿ĞºÑƒ Ğ· ĞºĞ¾Ğ´Ğ¾Ğ¼ Ğ²ÑĞµÑ€ĞµĞ´Ğ¸Ğ½Ñƒ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ°.
      # Ğ¢ĞµĞ¿ĞµÑ€ Ğ·Ğ¼Ñ–Ğ½Ğ¸ Ñ„Ğ°Ğ¹Ğ»Ñ–Ğ² Ğ½Ğ° Ñ‚Ğ²Ğ¾Ñ”Ğ¼Ñƒ ĞŸĞš Ğ¼Ğ¸Ñ‚Ñ‚Ñ”Ğ²Ğ¾ Ğ²Ğ¸Ğ´Ğ½Ğ¾ Ğ² ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ñ–.
      - ./frontend:/app
      # Ğ¦Ğµ Ğ·Ğ°Ñ…Ğ¸Ñ‰Ğ°Ñ” Ğ¿Ğ°Ğ¿ĞºÑƒ node_modules ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ° Ğ²Ñ–Ğ´ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿Ğ¸ÑÑƒ Ñ‚Ğ²Ğ¾Ñ”Ñ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ñ (ÑĞºÑ‰Ğ¾ Ñ‚Ğ°Ğ¼ Ñ€Ñ–Ğ·Ğ½Ñ– ĞĞ¡)
      - /app/node_modules
    ports:
      # Vite Ğ·Ğ° Ğ·Ğ°Ğ¼Ğ¾Ğ²Ñ‡ÑƒĞ²Ğ°Ğ½Ğ½ÑĞ¼ Ğ¿Ñ€Ğ°Ñ†ÑÑ” Ğ½Ğ° 5173. ĞŸÑ€Ğ¾ĞºĞ¸Ğ´Ğ°Ñ”Ğ¼Ğ¾ Ğ¹Ğ¾Ğ³Ğ¾ Ğ½Ğ°Ğ·Ğ¾Ğ²Ğ½Ñ–.
      - "5173:5173"
    # ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° Ğ·Ğ°Ğ¿ÑƒÑĞºÑƒ Dev-ÑĞµÑ€Ğ²ĞµÑ€Ğ° Ğ·Ğ°Ğ¼Ñ–ÑÑ‚ÑŒ Nginx
    command: npm run dev -- --host
    environment:
      - VITE_API_URL=http://localhost:8001

# ĞĞ³Ğ¾Ğ»Ğ¾ÑˆÑƒÑ”Ğ¼Ğ¾ Ñ‚Ğ¾Ğ¼Ğ¸ Ğ´Ğ»Ñ Ğ·Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ğ½Ğ½Ñ Ğ´Ğ°Ğ½Ğ¸Ñ…
volumes:
  postgres_data:


--------------------------------------------------
PATH: ./.history/context_packer_20260124194053.py
--------------------------------------------------
import os

# --- ĞšĞĞĞ¤Ğ†Ğ“Ğ£Ğ ĞĞ¦Ğ†Ğ¯ ---

# ĞŸĞ°Ğ¿ĞºĞ¸, ÑĞºÑ– Ğ¼Ğ¸ ĞŸĞĞ’ĞĞ†Ğ¡Ğ¢Ğ® Ñ–Ğ³Ğ½Ğ¾Ñ€ÑƒÑ”Ğ¼Ğ¾ (Ğ½Ğµ Ğ·Ğ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ Ğ²ÑĞµÑ€ĞµĞ´Ğ¸Ğ½Ñƒ)
IGNORE_DIRS = {
    '.git', 'node_modules', '__pycache__', 'venv', 'env', '.idea', '.vscode', 
    'dist', 'build', 'postgres_data', '.pytest_cache', 'migrations'
}

# Ğ¤Ğ°Ğ¹Ğ»Ğ¸, ÑĞºÑ– Ğ¼Ğ¸ Ñ–Ğ³Ğ½Ğ¾Ñ€ÑƒÑ”Ğ¼Ğ¾ (Ğ½Ğµ Ğ¿Ğ¾ĞºĞ°Ğ·ÑƒÑ”Ğ¼Ğ¾ Ğ² Ğ´ĞµÑ€ĞµĞ²Ñ– Ñ– Ğ½Ğµ Ñ‡Ğ¸Ñ‚Ğ°Ñ”Ğ¼Ğ¾)
IGNORE_FILES = {
    'package-lock.json', 'yarn.lock', 'collect_code.py', '.DS_Store', 
    'pnpm-lock.yaml', 'poetry.lock', 'full_project_context.txt' # Ğ†Ğ³Ğ½Ğ¾Ñ€ÑƒÑ”Ğ¼Ğ¾ ÑĞ°Ğ¼ Ñ„Ğ°Ğ¹Ğ» Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñƒ
}

# Ğ Ğ¾Ğ·ÑˆĞ¸Ñ€ĞµĞ½Ğ½Ñ Ñ„Ğ°Ğ¹Ğ»Ñ–Ğ², ĞºĞ¾Ğ´ ÑĞºĞ¸Ñ… Ğ½Ğ°Ğ¼ ĞŸĞĞ¢Ğ Ğ†Ğ‘Ğ•Ğ
# (Ğ’ÑÑ– Ñ–Ğ½ÑˆÑ– Ñ„Ğ°Ğ¹Ğ»Ğ¸ Ğ±ÑƒĞ´ÑƒÑ‚ÑŒ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ğ½Ñ– Ğ² Ğ´ĞµÑ€ĞµĞ²Ñ–, Ğ°Ğ»Ğµ Ñ—Ñ… Ğ²Ğ¼Ñ–ÑÑ‚ Ğ½Ğµ Ğ±ÑƒĞ´Ğµ Ğ·Ñ‡Ğ¸Ñ‚Ğ°Ğ½Ğ¾)
ALLOWED_EXTENSIONS = {
    '.py', '.js', '.vue', '.html', '.css', '.scss', 
    '.yml', '.yaml', '.json', '.sql', '.dockerfile', 
    '.sh', '.md', '.txt'
}

EXACT_FILES_TO_READ = {'Dockerfile', 'docker-compose.yml', 'requirements.txt', 'package.json'}

def get_size_format(b, factor=1024, suffix="B"):
    """ĞšĞ¾Ğ½Ğ²ĞµÑ€Ñ‚ÑƒÑ” Ğ±Ğ°Ğ¹Ñ‚Ğ¸ Ğ² Ñ‡Ğ¸Ñ‚Ğ°Ğ±ĞµĞ»ÑŒĞ½Ğ¸Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ (KB, MB, etc.)"""
    for unit in ["", "K", "M", "G", "T", "P", "E", "Z"]:
        if b < factor:
            return f"{b:.2f}{unit}{suffix}"
        b /= factor
    return f"{b:.2f}Y{suffix}"

def get_project_tree(start_path='.'):
    """Ğ“ĞµĞ½ĞµÑ€ÑƒÑ” Ğ²Ñ–Ğ·ÑƒĞ°Ğ»ÑŒĞ½Ğµ Ğ´ĞµÑ€ĞµĞ²Ğ¾ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ñƒ."""
    tree_output = []
    
    for root, dirs, files in os.walk(start_path):
        # Ğ¤Ñ–Ğ»ÑŒÑ‚Ñ€ÑƒÑ”Ğ¼Ğ¾ Ğ¿Ğ°Ğ¿ĞºĞ¸ "Ğ½Ğ° Ğ»ÑŒĞ¾Ñ‚Ñƒ"
        dirs[:] = [d for d in dirs if d not in IGNORE_DIRS]
        
        level = root.replace(start_path, '').count(os.sep)
        indent = ' ' * 4 * level
        folder_name = os.path.basename(root)
        if folder_name == '.':
            folder_name = os.path.basename(os.getcwd())
            
        tree_output.append(f"{indent}ğŸ“‚ {folder_name}/")
        
        subindent = ' ' * 4 * (level + 1)
        for f in files:
            if f not in IGNORE_FILES:
                tree_output.append(f"{subindent}ğŸ“„ {f}")
                
    return "\n".join(tree_output)

def collect_project_code(output_file='full_project_context.txt'):
    print("â³ ĞĞ½Ğ°Ğ»Ñ–Ğ·ÑƒÑ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñƒ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ñƒ Ñ‚Ğ° Ğ·Ğ±Ğ¸Ñ€Ğ°Ñ ĞºĞ¾Ğ´...")
    
    with open(output_file, 'w', encoding='utf-8') as outfile:
        # 1. Ğ—ĞĞŸĞ˜Ğ¡Ğ£Ğ„ĞœĞ Ğ¡Ğ¢Ğ Ğ£ĞšĞ¢Ğ£Ğ Ğ£ ĞŸĞ ĞĞ•ĞšĞ¢Ğ£
        outfile.write("="*50 + "\n")
        outfile.write("PROJECT STRUCTURE (TREE VIEW)\n")
        outfile.write("="*50 + "\n")
        outfile.write(get_project_tree('.'))
        outfile.write("\n\n" + "="*50 + "\n")
        outfile.write("FILE CONTENTS\n")
        outfile.write("="*50 + "\n\n")

        # 2. Ğ—ĞĞŸĞ˜Ğ¡Ğ£Ğ„ĞœĞ Ğ’ĞœĞ†Ğ¡Ğ¢ Ğ¤ĞĞ™Ğ›Ğ†Ğ’
        file_count = 0
        for root, dirs, files in os.walk('.'):
            # Ğ¤Ñ–Ğ»ÑŒÑ‚Ñ€ÑƒÑ”Ğ¼Ğ¾ Ğ¿Ğ°Ğ¿ĞºĞ¸
            dirs[:] = [d for d in dirs if d not in IGNORE_DIRS]
            
            for file in files:
                if file in IGNORE_FILES:
                    continue
                
                ext = os.path.splitext(file)[1]
                
                # Ğ§Ğ¸Ñ‚Ğ°Ñ”Ğ¼Ğ¾ Ñ„Ğ°Ğ¹Ğ», Ñ‚Ñ–Ğ»ÑŒĞºĞ¸ ÑĞºÑ‰Ğ¾ Ğ²Ñ–Ğ½ Ñƒ ÑĞ¿Ğ¸ÑĞºÑƒ Ğ´Ğ¾Ğ·Ğ²Ğ¾Ğ»ĞµĞ½Ğ¸Ñ…
                if ext in ALLOWED_EXTENSIONS or file in EXACT_FILES_TO_READ:
                    file_path = os.path.join(root, file)
                    
                    # Ğ—Ğ°Ğ¿Ğ¸ÑÑƒÑ”Ğ¼Ğ¾ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº Ñ„Ğ°Ğ¹Ğ»Ñƒ
                    outfile.write(f"\n{'-'*50}\n")
                    outfile.write(f"PATH: {file_path}\n")
                    outfile.write(f"{'-'*50}\n")
                    
                    try:
                        with open(file_path, 'r', encoding='utf-8', errors='ignore') as infile:
                            content = infile.read()
                            if not content.strip():
                                outfile.write("[EMPTY FILE]\n")
                            else:
                                outfile.write(content)
                                outfile.write("\n") 
                        file_count += 1
                    except Exception as e:
                        outfile.write(f"[ERROR READING FILE: {e}]\n")

    # --- ĞĞ¢Ğ Ğ˜ĞœĞĞĞĞ¯ Ğ ĞĞ—ĞœĞ†Ğ Ğ£ Ğ¤ĞĞ™Ğ›Ğ£ ---
    file_size = os.path.getsize(output_file)
    readable_size = get_size_format(file_size)

    print("-" * 40)
    print(f"âœ… Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾! Ğ—Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ¾ {file_count} Ñ„Ğ°Ğ¹Ğ»Ñ–Ğ².")
    print(f"ğŸ“ Ğ¤Ğ°Ğ¹Ğ» Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñƒ: {output_file}")
    print(f"ğŸ“Š Ğ Ğ¾Ğ·Ğ¼Ñ–Ñ€ Ñ„Ğ°Ğ¹Ğ»Ñƒ: {readable_size}")
    print("-" * 40)
    
    # ĞŸĞ¾Ğ¿ĞµÑ€ĞµĞ´Ğ¶ĞµĞ½Ğ½Ñ, ÑĞºÑ‰Ğ¾ Ñ„Ğ°Ğ¹Ğ» Ğ·Ğ°Ğ²ĞµĞ»Ğ¸ĞºĞ¸Ğ¹ Ğ´Ğ»Ñ Ñ‡Ğ°Ñ‚Ñƒ
    if file_size > 10 * 1024 * 1024: # 10 MB
        print("âš ï¸ Ğ£Ğ’ĞĞ“Ğ: Ğ¤Ğ°Ğ¹Ğ» Ğ´Ğ¾ÑĞ¸Ñ‚ÑŒ Ğ²ĞµĞ»Ğ¸ĞºĞ¸Ğ¹ (>10MB). ĞœĞ¾Ğ¶Ğ»Ğ¸Ğ²Ğ¾, Ğ²Ğ°Ñ€Ñ‚Ğ¾ Ğ´Ğ¾Ğ´Ğ°Ñ‚Ğ¸ Ñ‰Ğ¾ÑÑŒ Ñƒ IGNORE_DIRS.")

if __name__ == '__main__':
    collect_project_code()

--------------------------------------------------
PATH: ./.history/docker-compose_20260123213422.yml
--------------------------------------------------
#version: '3.8'

services:
  # --- 1. Ğ¡Ğ•Ğ Ğ’Ğ†Ğ¡ Ğ¢ĞĞ’ĞĞ Ğ†Ğ’ (Backend) ---
  product_service:
    build: ./product_service
    container_name: pos_product_service
    restart: always
    ports:
      - "8001:8000"
    environment:
      # Ğ—Ğ²'ÑĞ·Ğ¾Ğº Ğ· Ğ±Ğ°Ğ·Ğ¾Ñ Ğ´Ğ°Ğ½Ğ¸Ñ… (postgres_db - Ñ†Ğµ Ğ½Ğ°Ğ·Ğ²Ğ° ÑĞµÑ€Ğ²Ñ–ÑÑƒ Ğ½Ğ¸Ğ¶Ñ‡Ğµ)
      - DATABASE_URL=postgresql://user:password@postgres_db:5432/products_db
    depends_on:
      - postgres_db
        

  # --- 2. Ğ‘ĞĞ—Ğ Ğ”ĞĞĞ˜Ğ¥ Ğ¢ĞĞ’ĞĞ Ğ†Ğ’ (PostgreSQL) ---
  postgres_db:
    image: postgres:13
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d products_db"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s
    container_name: pos_postgres
    restart: always
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: products_db
    volumes:
      # Ğ—Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ñ”Ğ¼Ğ¾ Ğ´Ğ°Ğ½Ñ– Ğ½Ğ° Ğ´Ğ¸ÑĞºÑƒ, Ñ‰Ğ¾Ğ± Ğ½Ğµ Ğ·Ğ½Ğ¸ĞºĞ°Ğ»Ğ¸ Ğ¿Ñ€Ğ¸ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞºÑƒ
      - postgres_data:/var/lib/postgresql/data

  # --- 3. Ğ¡Ğ•Ğ Ğ’Ğ†Ğ¡ ĞšĞĞ¨Ğ˜ĞšĞ (Backend) ---
  order_service:
    build: ./order_service
    container_name: pos_order_service
    restart: always
    environment:
      # Ğ—Ğ²'ÑĞ·Ğ¾Ğº Ğ· Redis
      - REDIS_HOST=redis_db
    depends_on:
      - redis_db

  # --- 4. Ğ‘ĞĞ—Ğ Ğ”ĞĞĞ˜Ğ¥ ĞšĞĞ¨Ğ˜ĞšĞ (Redis) ---
  redis_db:
    image: redis:alpine
    container_name: pos_redis
    restart: always

  # --- FRONTEND (DEVELOPMENT MODE) ---
  frontend:
    build:
      context: ./frontend
      # Ğ’Ğ°Ğ¶Ğ»Ğ¸Ğ²Ğ¾: Ğ¼Ğ¸ Ğ½Ğµ Ğ²Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ Nginx, Ğ¼Ğ¸ Ğ·ÑƒĞ¿Ğ¸Ğ½ÑÑ”Ğ¼Ğ¾ÑÑŒ Ğ½Ğ° ĞµÑ‚Ğ°Ğ¿Ñ– Ğ·Ñ– Node.js
      dockerfile: Dockerfile 
      target: build-stage 
    container_name: pos_frontend
    restart: always
    volumes:
      # ĞœĞĞ“Ğ†Ğ¯: ĞœĞ¸ "Ğ¿Ñ€Ğ¾ĞºĞ¸Ğ´Ğ°Ñ”Ğ¼Ğ¾" Ñ‚Ğ²Ğ¾Ñ Ğ¿Ğ°Ğ¿ĞºÑƒ Ğ· ĞºĞ¾Ğ´Ğ¾Ğ¼ Ğ²ÑĞµÑ€ĞµĞ´Ğ¸Ğ½Ñƒ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ°.
      # Ğ¢ĞµĞ¿ĞµÑ€ Ğ·Ğ¼Ñ–Ğ½Ğ¸ Ñ„Ğ°Ğ¹Ğ»Ñ–Ğ² Ğ½Ğ° Ñ‚Ğ²Ğ¾Ñ”Ğ¼Ñƒ ĞŸĞš Ğ¼Ğ¸Ñ‚Ñ‚Ñ”Ğ²Ğ¾ Ğ²Ğ¸Ğ´Ğ½Ğ¾ Ğ² ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ñ–.
      - ./frontend:/app
      # Ğ¦Ğµ Ğ·Ğ°Ñ…Ğ¸Ñ‰Ğ°Ñ” Ğ¿Ğ°Ğ¿ĞºÑƒ node_modules ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ° Ğ²Ñ–Ğ´ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿Ğ¸ÑÑƒ Ñ‚Ğ²Ğ¾Ñ”Ñ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ñ (ÑĞºÑ‰Ğ¾ Ñ‚Ğ°Ğ¼ Ñ€Ñ–Ğ·Ğ½Ñ– ĞĞ¡)
      - /app/node_modules
    ports:
      # Vite Ğ·Ğ° Ğ·Ğ°Ğ¼Ğ¾Ğ²Ñ‡ÑƒĞ²Ğ°Ğ½Ğ½ÑĞ¼ Ğ¿Ñ€Ğ°Ñ†ÑÑ” Ğ½Ğ° 5173. ĞŸÑ€Ğ¾ĞºĞ¸Ğ´Ğ°Ñ”Ğ¼Ğ¾ Ğ¹Ğ¾Ğ³Ğ¾ Ğ½Ğ°Ğ·Ğ¾Ğ²Ğ½Ñ–.
      - "5173:5173"
    # ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° Ğ·Ğ°Ğ¿ÑƒÑĞºÑƒ Dev-ÑĞµÑ€Ğ²ĞµÑ€Ğ° Ğ·Ğ°Ğ¼Ñ–ÑÑ‚ÑŒ Nginx
    command: npm run dev -- --host
    environment:
      - VITE_API_URL=http://localhost:8001

# ĞĞ³Ğ¾Ğ»Ğ¾ÑˆÑƒÑ”Ğ¼Ğ¾ Ñ‚Ğ¾Ğ¼Ğ¸ Ğ´Ğ»Ñ Ğ·Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ğ½Ğ½Ñ Ğ´Ğ°Ğ½Ğ¸Ñ…
volumes:
  postgres_data:


--------------------------------------------------
PATH: ./.history/context_packer_20260112193821.py
--------------------------------------------------
import os

# --- ĞĞĞ›ĞĞ¨Ğ¢Ğ£Ğ’ĞĞĞĞ¯ ---
OUTPUT_FILE = 'full_project_context.txt'

# ĞŸĞ°Ğ¿ĞºĞ¸, ÑĞºÑ– ĞœĞ˜ Ğ†Ğ“ĞĞĞ Ğ£Ğ„ĞœĞ (Ğ½Ğ°Ğ¹Ğ²Ğ°Ğ¶Ğ»Ğ¸Ğ²Ñ–ÑˆĞµ Ğ´Ğ»Ñ ĞµĞºĞ¾Ğ½Ğ¾Ğ¼Ñ–Ñ— Ğ¼Ñ–ÑÑ†Ñ)
IGNORE_DIRS = {
    '.git', 'node_modules', '__pycache__', 'venv', '.idea', '.vscode', 
    'dist', 'build', 'coverage', 'tmp', 'logs', 'pg_data', 'redis_data'
}

# Ğ¤Ğ°Ğ¹Ğ»Ğ¸, ÑĞºÑ– ĞœĞ˜ Ğ†Ğ“ĞĞĞ Ğ£Ğ„ĞœĞ (Ğ±Ğ¾ Ğ²Ğ¾Ğ½Ğ¸ Ğ²ĞµĞ»Ğ¸ĞºÑ– Ğ°Ğ±Ğ¾ Ğ½Ğµ Ğ½ĞµÑÑƒÑ‚ÑŒ Ğ»Ğ¾Ğ³Ñ–ĞºĞ¸ ĞºĞ¾Ğ´Ñƒ)
IGNORE_FILES = {
    'package-lock.json', 'yarn.lock', 'pnpm-lock.yaml', 'poetry.lock',
    'context_packer.py', OUTPUT_FILE, '.DS_Store', 'favicon.ico'
}

# Ğ Ğ¾Ğ·ÑˆĞ¸Ñ€ĞµĞ½Ğ½Ñ Ñ„Ğ°Ğ¹Ğ»Ñ–Ğ², ÑĞºÑ– Ğ¼Ğ¸ Ğ¥ĞĞ§Ğ•ĞœĞ Ğ±Ğ°Ñ‡Ğ¸Ñ‚Ğ¸ (Ñ‚Ñ–Ğ»ÑŒĞºĞ¸ ĞºĞ¾Ğ´ Ñ– ĞºĞ¾Ğ½Ñ„Ñ–Ğ³Ğ¸)
ALLOWED_EXTENSIONS = {
    '.py', '.js', '.vue', '.html', '.css', '.json', 
    '.yml', '.yaml', '.sql', '.conf', '.sh', '.md', '.txt', '.env.example'
}

def get_file_size_mb(file_path):
    return os.path.getsize(file_path) / (1024 * 1024)

def pack_project():
    project_content = ""
    root_dir = os.getcwd()
    file_count = 0
    
    print(f"ğŸš€ ĞŸĞ¾Ñ‡Ğ¸Ğ½Ğ°Ñ ÑĞºĞ°Ğ½ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ¿Ñ€Ğ¾Ñ”ĞºÑ‚Ñƒ: {root_dir}")
    print(f"ğŸš« Ğ†Ğ³Ğ½Ğ¾Ñ€ÑƒÑ Ğ¿Ğ°Ğ¿ĞºĞ¸: {', '.join(IGNORE_DIRS)}")

    for dirpath, dirnames, filenames in os.walk(root_dir):
        # Ğ’Ğ¸Ğ´Ğ°Ğ»ÑÑ”Ğ¼Ğ¾ Ñ–Ğ³Ğ½Ğ¾Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ– Ğ¿Ğ°Ğ¿ĞºĞ¸ Ğ·Ñ– ÑĞ¿Ğ¸ÑĞºÑƒ ÑĞºĞ°Ğ½ÑƒĞ²Ğ°Ğ½Ğ½Ñ
        dirnames[:] = [d for d in dirnames if d not in IGNORE_DIRS]

        for filename in filenames:
            if filename in IGNORE_FILES:
                continue
            
            ext = os.path.splitext(filename)[1]
            
            # Ğ¡Ğ¿ĞµÑ†Ñ–Ğ°Ğ»ÑŒĞ½Ğ° Ğ¿ĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ°: Dockerfile Ğ½Ğµ Ğ¼Ğ°Ñ” Ñ€Ğ¾Ğ·ÑˆĞ¸Ñ€ĞµĞ½Ğ½Ñ, Ğ°Ğ»Ğµ Ğ²Ñ–Ğ½ Ğ½Ğ°Ğ¼ Ğ¿Ğ¾Ñ‚Ñ€Ñ–Ğ±ĞµĞ½
            is_dockerfile = filename.startswith('Dockerfile')
            
            if ext in ALLOWED_EXTENSIONS or is_dockerfile:
                file_path = os.path.join(dirpath, filename)
                rel_path = os.path.relpath(file_path, root_dir)
                
                try:
                    with open(file_path, 'r', encoding='utf-8') as f:
                        content = f.read()
                        
                    # Ğ”Ğ¾Ğ´Ğ°Ñ”Ğ¼Ğ¾ Ñ€Ğ¾Ğ·Ğ´Ñ–Ğ»ÑĞ²Ğ°Ñ‡Ñ–, Ñ‰Ğ¾Ğ± AI Ñ€Ğ¾Ğ·ÑƒĞ¼Ñ–Ğ² Ğ´Ğµ Ğ¿Ğ¾Ñ‡Ğ°Ñ‚Ğ¾Ğº Ñ„Ğ°Ğ¹Ğ»Ñƒ
                    project_content += f"\n{'='*40}\n"
                    project_content += f"FILE: {rel_path}\n"
                    project_content += f"{'='*40}\n"
                    project_content += content + "\n"
                    
                    file_count += 1
                    print(f"  ğŸ“„ Ğ”Ğ¾Ğ´Ğ°Ğ½Ğ¾: {rel_path}")
                except Exception as e:
                    print(f"  âš ï¸ ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ñ‡Ğ¸Ñ‚Ğ°Ğ½Ğ½Ñ {rel_path}: {e}")

    # Ğ—Ğ°Ğ¿Ğ¸ÑÑƒÑ”Ğ¼Ğ¾ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚
    with open(OUTPUT_FILE, 'w', encoding='utf-8') as f:
        f.write(project_content)
    
    # --- Ğ—Ğ’Ğ†Ğ¢ ĞŸĞ Ğ Ğ ĞĞ—ĞœĞ†Ğ  ---
    size_mb = get_file_size_mb(OUTPUT_FILE)
    print(f"\nâœ… Ğ“ĞĞ¢ĞĞ’Ğ! ĞĞ±Ñ€Ğ¾Ğ±Ğ»ĞµĞ½Ğ¾ Ñ„Ğ°Ğ¹Ğ»Ñ–Ğ²: {file_count}")
    print(f"ğŸ“¦ Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ğ·Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ¾ Ñƒ: {OUTPUT_FILE}")
    print(f"ğŸ“Š Ğ Ğ¾Ğ·Ğ¼Ñ–Ñ€ Ñ„Ğ°Ğ¹Ğ»Ñƒ: {size_mb:.2f} MB")
    
    if size_mb > 5.0:
        print("\nâš ï¸  Ğ£Ğ’ĞĞ“Ğ: Ğ¤Ğ°Ğ¹Ğ» Ğ´Ğ¾ÑĞ¸Ñ‚ÑŒ Ğ²ĞµĞ»Ğ¸ĞºĞ¸Ğ¹ (> 5 MB).")
        print("   ĞœĞ¾Ğ¶Ğ»Ğ¸Ğ²Ğ¾, Ñ‚Ğ¸ Ğ·Ğ°Ñ…Ğ¾Ğ¿Ğ¸Ğ² Ñ‰Ğ¾ÑÑŒ Ğ·Ğ°Ğ¹Ğ²Ğµ (Ğ½Ğ°Ğ¿Ñ€Ğ¸ĞºĞ»Ğ°Ğ´, Ñ„Ğ°Ğ¹Ğ»Ğ¸ Ğ‘Ğ” Ğ°Ğ±Ğ¾ build).")
        print("   ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ IGNORE_DIRS Ñƒ ÑĞºÑ€Ğ¸Ğ¿Ñ‚Ñ–.")
    elif size_mb > 1.0:
         print("\nâ„¹ï¸  ĞĞ¾Ñ€Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¸Ğ¹ Ñ€Ğ¾Ğ·Ğ¼Ñ–Ñ€ Ğ´Ğ»Ñ ÑĞµÑ€ĞµĞ´Ğ½ÑŒĞ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¾Ñ”ĞºÑ‚Ñƒ.")
    else:
         print("\nâœ¨ ĞšĞ¾Ğ¼Ğ¿Ğ°ĞºÑ‚Ğ½Ğ¸Ğ¹ Ñ€Ğ¾Ğ·Ğ¼Ñ–Ñ€. ĞœĞ¾Ğ¶Ğ½Ğ° ÑĞ¼Ñ–Ğ»Ğ¸Ğ²Ğ¾ ĞºĞ¸Ğ´Ğ°Ñ‚Ğ¸ Ğ² Ñ‡Ğ°Ñ‚.")

if __name__ == "__main__":
    pack_project()

--------------------------------------------------
PATH: ./.history/order_service/main_20260124232946.py
--------------------------------------------------
from fastapi import FastAPI, HTTPException
from fastapi.middleware.cors import CORSMiddleware
import redis
import os
import json
import uuid
from typing import List
from schemas import CartItemCreate, CartItem # Ğ†Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ÑƒÑ”Ğ¼Ğ¾ ÑÑ…ĞµĞ¼Ğ¸
import requests

app = FastAPI()

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

REDIS_HOST = os.getenv("REDIS_HOST", "pos_redis")
REDIS_PORT = int(os.getenv("REDIS_PORT", 6379))

# decode_responses=True ĞµĞºĞ¾Ğ½Ğ¾Ğ¼Ğ¸Ñ‚ÑŒ Ğ½Ğ°Ğ¼ Ñ‡Ğ°Ñ Ğ½Ğ° Ğ´ĞµĞºĞ¾Ğ´ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ±Ğ°Ğ¹Ñ‚Ñ–Ğ²
r = redis.Redis(host=REDIS_HOST, port=REDIS_PORT, db=0, decode_responses=True)
CART_KEY = "pos_cart_v2" # Ğ—Ğ¼Ñ–Ğ½Ğ¸Ğ¼Ğ¾ ĞºĞ»ÑÑ‡, Ñ‰Ğ¾Ğ± Ğ½Ğµ ĞºĞ¾Ğ½Ñ„Ğ»Ñ–ĞºÑ‚ÑƒĞ²Ğ°Ñ‚Ğ¸ Ğ·Ñ– ÑÑ‚Ğ°Ñ€Ğ¸Ğ¼

@app.get("/")
def read_root():
    return {"message": "Advanced Order Service is running!"}

# --- ĞĞ¢Ğ Ğ˜ĞœĞĞ¢Ğ˜ ĞšĞĞ¨Ğ˜Ğš ---
@app.get("/cart/", response_model=List[CartItem])
def get_cart():
    # ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ğ²ÑÑ– Ğ´Ğ°Ğ½Ñ– Ğ· Ñ…ĞµÑˆÑƒ
    raw_data = r.hgetall(CART_KEY)
    cart_items = []
    
    for key, value in raw_data.items():
        try:
            item = json.loads(value)
            cart_items.append(item)
        except json.JSONDecodeError:
            continue
            
    return cart_items

# --- Ğ”ĞĞ”ĞĞ¢Ğ˜ Ğ¢ĞĞ’ĞĞ  ---
@app.post("/cart/add", response_model=CartItem)
def add_item(item_data: CartItemCreate):
    # Ğ“ĞµĞ½ĞµÑ€ÑƒÑ”Ğ¼Ğ¾ ÑƒĞ½Ñ–ĞºĞ°Ğ»ÑŒĞ½Ğ¸Ğ¹ ID Ğ´Ğ»Ñ Ñ†ÑŒĞ¾Ğ³Ğ¾ Ğ·Ğ°Ğ¿Ğ¸ÑÑƒ Ğ² ĞºĞ¾ÑˆĞ¸ĞºÑƒ
    # Ğ¦Ğµ Ğ´Ğ¾Ğ·Ğ²Ğ¾Ğ»ÑÑ” Ğ¼Ğ°Ñ‚Ğ¸ Ğ´Ğ²Ğ° Ğ¾Ğ´Ğ½Ğ°ĞºĞ¾Ğ²Ğ¸Ñ… Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¸ Ğ· Ñ€Ñ–Ğ·Ğ½Ğ¸Ğ¼Ğ¸ Ğ¼Ğ¾Ğ´Ğ¸Ñ„Ñ–ĞºĞ°Ñ‚Ğ¾Ñ€Ğ°Ğ¼Ğ¸
    cart_item_id = str(uuid.uuid4())
    
    new_item = CartItem(
        cart_item_id=cart_item_id,
        **item_data.dict()
    )
    
    # Ğ—Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ñ”Ğ¼Ğ¾ JSON Ğ² Redis: Key=UUID, Value=JSON String
    r.hset(CART_KEY, cart_item_id, json.dumps(new_item.dict()))
    
    return new_item

# --- Ğ—ĞœĞ†ĞĞ˜Ğ¢Ğ˜ ĞšĞ†Ğ›Ğ¬ĞšĞ†Ğ¡Ğ¢Ğ¬ (+/-) ---
@app.post("/cart/{cart_item_id}/update")
def update_quantity(cart_item_id: str, change: int):
    raw_json = r.hget(CART_KEY, cart_item_id)
    if not raw_json:
        raise HTTPException(status_code=404, detail="Item not found")
        
    item = json.loads(raw_json)
    new_qty = item['quantity'] + change
    
    if new_qty <= 0:
        # Ğ¯ĞºÑ‰Ğ¾ ĞºÑ–Ğ»ÑŒĞºÑ–ÑÑ‚ÑŒ <= 0, Ğ²Ğ¸Ğ´Ğ°Ğ»ÑÑ”Ğ¼Ğ¾
        r.hdel(CART_KEY, cart_item_id)
        return {"status": "removed", "cart_item_id": cart_item_id}
    else:
        # ĞĞ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ ĞºÑ–Ğ»ÑŒĞºÑ–ÑÑ‚ÑŒ
        item['quantity'] = new_qty
        r.hset(CART_KEY, cart_item_id, json.dumps(item))
        return {"status": "updated", "quantity": new_qty}

# --- Ğ’Ğ˜Ğ”ĞĞ›Ğ˜Ğ¢Ğ˜ Ğ¢ĞĞ’ĞĞ  ---
@app.delete("/cart/{cart_item_id}")
def remove_item(cart_item_id: str):
    r.hdel(CART_KEY, cart_item_id)
    return {"status": "removed"}

# --- ĞĞ§Ğ˜Ğ¡Ğ¢Ğ˜Ğ¢Ğ˜ ĞšĞĞ¨Ğ˜Ğš ---
@app.delete("/cart/")
def clear_cart():
    r.delete(CART_KEY)
    return {"status": "cleared"}

--------------------------------------------------
PATH: ./.history/order_service/main_20260114205817.py
--------------------------------------------------
from fastapi import FastAPI, HTTPException
from fastapi.middleware.cors import CORSMiddleware
import redis
import os
import json
import uuid
from typing import List
from schemas import CartItemCreate, CartItem # Ğ†Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ÑƒÑ”Ğ¼Ğ¾ ÑÑ…ĞµĞ¼Ğ¸

app = FastAPI()

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

REDIS_HOST = os.getenv("REDIS_HOST", "pos_redis")
REDIS_PORT = int(os.getenv("REDIS_PORT", 6379))

# decode_responses=True ĞµĞºĞ¾Ğ½Ğ¾Ğ¼Ğ¸Ñ‚ÑŒ Ğ½Ğ°Ğ¼ Ñ‡Ğ°Ñ Ğ½Ğ° Ğ´ĞµĞºĞ¾Ğ´ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ±Ğ°Ğ¹Ñ‚Ñ–Ğ²
r = redis.Redis(host=REDIS_HOST, port=REDIS_PORT, db=0, decode_responses=True)
CART_KEY = "pos_cart_v2" # Ğ—Ğ¼Ñ–Ğ½Ğ¸Ğ¼Ğ¾ ĞºĞ»ÑÑ‡, Ñ‰Ğ¾Ğ± Ğ½Ğµ ĞºĞ¾Ğ½Ñ„Ğ»Ñ–ĞºÑ‚ÑƒĞ²Ğ°Ñ‚Ğ¸ Ğ·Ñ– ÑÑ‚Ğ°Ñ€Ğ¸Ğ¼

@app.get("/")
def read_root():
    return {"message": "Advanced Order Service is running!"}

# --- ĞĞ¢Ğ Ğ˜ĞœĞĞ¢Ğ˜ ĞšĞĞ¨Ğ˜Ğš ---
@app.get("/cart/", response_model=List[CartItem])
def get_cart():
    # ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ğ²ÑÑ– Ğ´Ğ°Ğ½Ñ– Ğ· Ñ…ĞµÑˆÑƒ
    raw_data = r.hgetall(CART_KEY)
    cart_items = []
    
    for key, value in raw_data.items():
        try:
            item = json.loads(value)
            cart_items.append(item)
        except json.JSONDecodeError:
            continue
            
    return cart_items

# --- Ğ”ĞĞ”ĞĞ¢Ğ˜ Ğ¢ĞĞ’ĞĞ  ---
@app.post("/cart/add", response_model=CartItem)
def add_item(item_data: CartItemCreate):
    # Ğ“ĞµĞ½ĞµÑ€ÑƒÑ”Ğ¼Ğ¾ ÑƒĞ½Ñ–ĞºĞ°Ğ»ÑŒĞ½Ğ¸Ğ¹ ID Ğ´Ğ»Ñ Ñ†ÑŒĞ¾Ğ³Ğ¾ Ğ·Ğ°Ğ¿Ğ¸ÑÑƒ Ğ² ĞºĞ¾ÑˆĞ¸ĞºÑƒ
    # Ğ¦Ğµ Ğ´Ğ¾Ğ·Ğ²Ğ¾Ğ»ÑÑ” Ğ¼Ğ°Ñ‚Ğ¸ Ğ´Ğ²Ğ° Ğ¾Ğ´Ğ½Ğ°ĞºĞ¾Ğ²Ğ¸Ñ… Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¸ Ğ· Ñ€Ñ–Ğ·Ğ½Ğ¸Ğ¼Ğ¸ Ğ¼Ğ¾Ğ´Ğ¸Ñ„Ñ–ĞºĞ°Ñ‚Ğ¾Ñ€Ğ°Ğ¼Ğ¸
    cart_item_id = str(uuid.uuid4())
    
    new_item = CartItem(
        cart_item_id=cart_item_id,
        **item_data.dict()
    )
    
    # Ğ—Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ñ”Ğ¼Ğ¾ JSON Ğ² Redis: Key=UUID, Value=JSON String
    r.hset(CART_KEY, cart_item_id, json.dumps(new_item.dict()))
    
    return new_item

# --- Ğ—ĞœĞ†ĞĞ˜Ğ¢Ğ˜ ĞšĞ†Ğ›Ğ¬ĞšĞ†Ğ¡Ğ¢Ğ¬ (+/-) ---
@app.post("/cart/{cart_item_id}/update")
def update_quantity(cart_item_id: str, change: int):
    raw_json = r.hget(CART_KEY, cart_item_id)
    if not raw_json:
        raise HTTPException(status_code=404, detail="Item not found")
        
    item = json.loads(raw_json)
    new_qty = item['quantity'] + change
    
    if new_qty <= 0:
        # Ğ¯ĞºÑ‰Ğ¾ ĞºÑ–Ğ»ÑŒĞºÑ–ÑÑ‚ÑŒ <= 0, Ğ²Ğ¸Ğ´Ğ°Ğ»ÑÑ”Ğ¼Ğ¾
        r.hdel(CART_KEY, cart_item_id)
        return {"status": "removed", "cart_item_id": cart_item_id}
    else:
        # ĞĞ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ ĞºÑ–Ğ»ÑŒĞºÑ–ÑÑ‚ÑŒ
        item['quantity'] = new_qty
        r.hset(CART_KEY, cart_item_id, json.dumps(item))
        return {"status": "updated", "quantity": new_qty}

# --- Ğ’Ğ˜Ğ”ĞĞ›Ğ˜Ğ¢Ğ˜ Ğ¢ĞĞ’ĞĞ  ---
@app.delete("/cart/{cart_item_id}")
def remove_item(cart_item_id: str):
    r.hdel(CART_KEY, cart_item_id)
    return {"status": "removed"}

# --- ĞĞ§Ğ˜Ğ¡Ğ¢Ğ˜Ğ¢Ğ˜ ĞšĞĞ¨Ğ˜Ğš ---
@app.delete("/cart/")
def clear_cart():
    r.delete(CART_KEY)
    return {"status": "cleared"}

--------------------------------------------------
PATH: ./.history/order_service/main_20260125095616.py
--------------------------------------------------
from fastapi import FastAPI, HTTPException
from fastapi.middleware.cors import CORSMiddleware
import redis
import os
import json
import uuid
from typing import List
from schemas import CartItemCreate, CartItem # Ğ†Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ÑƒÑ”Ğ¼Ğ¾ ÑÑ…ĞµĞ¼Ğ¸

app = FastAPI()

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

REDIS_HOST = os.getenv("REDIS_HOST", "pos_redis")
REDIS_PORT = int(os.getenv("REDIS_PORT", 6379))

# decode_responses=True ĞµĞºĞ¾Ğ½Ğ¾Ğ¼Ğ¸Ñ‚ÑŒ Ğ½Ğ°Ğ¼ Ñ‡Ğ°Ñ Ğ½Ğ° Ğ´ĞµĞºĞ¾Ğ´ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ±Ğ°Ğ¹Ñ‚Ñ–Ğ²
r = redis.Redis(host=REDIS_HOST, port=REDIS_PORT, db=0, decode_responses=True)
CART_KEY = "pos_cart_v2" # Ğ—Ğ¼Ñ–Ğ½Ğ¸Ğ¼Ğ¾ ĞºĞ»ÑÑ‡, Ñ‰Ğ¾Ğ± Ğ½Ğµ ĞºĞ¾Ğ½Ñ„Ğ»Ñ–ĞºÑ‚ÑƒĞ²Ğ°Ñ‚Ğ¸ Ğ·Ñ– ÑÑ‚Ğ°Ñ€Ğ¸Ğ¼

@app.get("/")
def read_root():
    return {"message": "Advanced Order Service is running!"}

# --- ĞĞ¢Ğ Ğ˜ĞœĞĞ¢Ğ˜ ĞšĞĞ¨Ğ˜Ğš ---
@app.get("/cart/", response_model=List[CartItem])
def get_cart():
    # ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ğ²ÑÑ– Ğ´Ğ°Ğ½Ñ– Ğ· Ñ…ĞµÑˆÑƒ
    raw_data = r.hgetall(CART_KEY)
    cart_items = []
    
    for key, value in raw_data.items():
        try:
            item = json.loads(value)
            cart_items.append(item)
        except json.JSONDecodeError:
            continue
            
    return cart_items

# --- Ğ”ĞĞ”ĞĞ¢Ğ˜ Ğ¢ĞĞ’ĞĞ  ---
@app.post("/cart/add", response_model=CartItem)
def add_item(item_data: CartItemCreate):
    # Ğ“ĞµĞ½ĞµÑ€ÑƒÑ”Ğ¼Ğ¾ ÑƒĞ½Ñ–ĞºĞ°Ğ»ÑŒĞ½Ğ¸Ğ¹ ID Ğ´Ğ»Ñ Ñ†ÑŒĞ¾Ğ³Ğ¾ Ğ·Ğ°Ğ¿Ğ¸ÑÑƒ Ğ² ĞºĞ¾ÑˆĞ¸ĞºÑƒ
    # Ğ¦Ğµ Ğ´Ğ¾Ğ·Ğ²Ğ¾Ğ»ÑÑ” Ğ¼Ğ°Ñ‚Ğ¸ Ğ´Ğ²Ğ° Ğ¾Ğ´Ğ½Ğ°ĞºĞ¾Ğ²Ğ¸Ñ… Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¸ Ğ· Ñ€Ñ–Ğ·Ğ½Ğ¸Ğ¼Ğ¸ Ğ¼Ğ¾Ğ´Ğ¸Ñ„Ñ–ĞºĞ°Ñ‚Ğ¾Ñ€Ğ°Ğ¼Ğ¸
    cart_item_id = str(uuid.uuid4())
    
    new_item = CartItem(
        cart_item_id=cart_item_id,
        **item_data.dict()
    )
    
    # Ğ—Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ñ”Ğ¼Ğ¾ JSON Ğ² Redis: Key=UUID, Value=JSON String
    r.hset(CART_KEY, cart_item_id, json.dumps(new_item.dict()))
    
    return new_item

# --- Ğ—ĞœĞ†ĞĞ˜Ğ¢Ğ˜ ĞšĞ†Ğ›Ğ¬ĞšĞ†Ğ¡Ğ¢Ğ¬ (+/-) ---
@app.post("/cart/{cart_item_id}/update")
def update_quantity(cart_item_id: str, change: int):
    raw_json = r.hget(CART_KEY, cart_item_id)
    if not raw_json:
        raise HTTPException(status_code=404, detail="Item not found")
        
    item = json.loads(raw_json)
    new_qty = item['quantity'] + change
    
    if new_qty <= 0:
        # Ğ¯ĞºÑ‰Ğ¾ ĞºÑ–Ğ»ÑŒĞºÑ–ÑÑ‚ÑŒ <= 0, Ğ²Ğ¸Ğ´Ğ°Ğ»ÑÑ”Ğ¼Ğ¾
        r.hdel(CART_KEY, cart_item_id)
        return {"status": "removed", "cart_item_id": cart_item_id}
    else:
        # ĞĞ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ ĞºÑ–Ğ»ÑŒĞºÑ–ÑÑ‚ÑŒ
        item['quantity'] = new_qty
        r.hset(CART_KEY, cart_item_id, json.dumps(item))
        return {"status": "updated", "quantity": new_qty}

# --- Ğ’Ğ˜Ğ”ĞĞ›Ğ˜Ğ¢Ğ˜ Ğ¢ĞĞ’ĞĞ  ---
@app.delete("/cart/{cart_item_id}")
def remove_item(cart_item_id: str):
    r.hdel(CART_KEY, cart_item_id)
    return {"status": "removed"}

# --- ĞĞ§Ğ˜Ğ¡Ğ¢Ğ˜Ğ¢Ğ˜ ĞšĞĞ¨Ğ˜Ğš ---
@app.delete("/cart/")
def clear_cart():
    r.delete(CART_KEY)
    return {"status": "cleared"}

--------------------------------------------------
PATH: ./.history/order_service/main_20260124233136.py
--------------------------------------------------
from fastapi import FastAPI, HTTPException
from fastapi.middleware.cors import CORSMiddleware
import redis
import os
import json
import uuid
from typing import List
from schemas import CartItemCreate, CartItem # Ğ†Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ÑƒÑ”Ğ¼Ğ¾ ÑÑ…ĞµĞ¼Ğ¸
import requests

app = FastAPI()

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

REDIS_HOST = os.getenv("REDIS_HOST", "pos_redis")
REDIS_PORT = int(os.getenv("REDIS_PORT", 6379))

# decode_responses=True ĞµĞºĞ¾Ğ½Ğ¾Ğ¼Ğ¸Ñ‚ÑŒ Ğ½Ğ°Ğ¼ Ñ‡Ğ°Ñ Ğ½Ğ° Ğ´ĞµĞºĞ¾Ğ´ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ±Ğ°Ğ¹Ñ‚Ñ–Ğ²
r = redis.Redis(host=REDIS_HOST, port=REDIS_PORT, db=0, decode_responses=True)
CART_KEY = "pos_cart_v2" # Ğ—Ğ¼Ñ–Ğ½Ğ¸Ğ¼Ğ¾ ĞºĞ»ÑÑ‡, Ñ‰Ğ¾Ğ± Ğ½Ğµ ĞºĞ¾Ğ½Ñ„Ğ»Ñ–ĞºÑ‚ÑƒĞ²Ğ°Ñ‚Ğ¸ Ğ·Ñ– ÑÑ‚Ğ°Ñ€Ğ¸Ğ¼

@app.get("/")
def read_root():
    return {"message": "Advanced Order Service is running!"}

# --- ĞĞ¢Ğ Ğ˜ĞœĞĞ¢Ğ˜ ĞšĞĞ¨Ğ˜Ğš ---
@app.get("/cart/", response_model=List[CartItem])
def get_cart():
    # ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ğ²ÑÑ– Ğ´Ğ°Ğ½Ñ– Ğ· Ñ…ĞµÑˆÑƒ
    raw_data = r.hgetall(CART_KEY)
    cart_items = []
    
    for key, value in raw_data.items():
        try:
            item = json.loads(value)
            cart_items.append(item)
        except json.JSONDecodeError:
            continue
            
    return cart_items

# --- Ğ”ĞĞ”ĞĞ¢Ğ˜ Ğ¢ĞĞ’ĞĞ  ---
@app.post("/cart/add", response_model=CartItem)
def add_item(item_data: CartItemCreate):
    # Ğ“ĞµĞ½ĞµÑ€ÑƒÑ”Ğ¼Ğ¾ ÑƒĞ½Ñ–ĞºĞ°Ğ»ÑŒĞ½Ğ¸Ğ¹ ID Ğ´Ğ»Ñ Ñ†ÑŒĞ¾Ğ³Ğ¾ Ğ·Ğ°Ğ¿Ğ¸ÑÑƒ Ğ² ĞºĞ¾ÑˆĞ¸ĞºÑƒ
    # Ğ¦Ğµ Ğ´Ğ¾Ğ·Ğ²Ğ¾Ğ»ÑÑ” Ğ¼Ğ°Ñ‚Ğ¸ Ğ´Ğ²Ğ° Ğ¾Ğ´Ğ½Ğ°ĞºĞ¾Ğ²Ğ¸Ñ… Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¸ Ğ· Ñ€Ñ–Ğ·Ğ½Ğ¸Ğ¼Ğ¸ Ğ¼Ğ¾Ğ´Ğ¸Ñ„Ñ–ĞºĞ°Ñ‚Ğ¾Ñ€Ğ°Ğ¼Ğ¸
    cart_item_id = str(uuid.uuid4())
    
    new_item = CartItem(
        cart_item_id=cart_item_id,
        **item_data.dict()
    )
    
    # Ğ—Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ñ”Ğ¼Ğ¾ JSON Ğ² Redis: Key=UUID, Value=JSON String
    r.hset(CART_KEY, cart_item_id, json.dumps(new_item.dict()))
    
    return new_item

# --- Ğ—ĞœĞ†ĞĞ˜Ğ¢Ğ˜ ĞšĞ†Ğ›Ğ¬ĞšĞ†Ğ¡Ğ¢Ğ¬ (+/-) ---
@app.post("/cart/{cart_item_id}/update")
def update_quantity(cart_item_id: str, change: int):
    raw_json = r.hget(CART_KEY, cart_item_id)
    if not raw_json:
        raise HTTPException(status_code=404, detail="Item not found")
        
    item = json.loads(raw_json)
    new_qty = item['quantity'] + change
    
    if new_qty <= 0:
        # Ğ¯ĞºÑ‰Ğ¾ ĞºÑ–Ğ»ÑŒĞºÑ–ÑÑ‚ÑŒ <= 0, Ğ²Ğ¸Ğ´Ğ°Ğ»ÑÑ”Ğ¼Ğ¾
        r.hdel(CART_KEY, cart_item_id)
        return {"status": "removed", "cart_item_id": cart_item_id}
    else:
        # ĞĞ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ ĞºÑ–Ğ»ÑŒĞºÑ–ÑÑ‚ÑŒ
        item['quantity'] = new_qty
        r.hset(CART_KEY, cart_item_id, json.dumps(item))
        return {"status": "updated", "quantity": new_qty}

# Ğ¦ĞµĞ¹ ĞºĞ»Ğ°Ñ Ğ¿Ğ¾Ñ‚Ñ€Ñ–Ğ±ĞµĞ½ Ğ´Ğ»Ñ Ğ²Ñ…Ñ–Ğ´Ğ½Ğ¸Ñ… Ğ´Ğ°Ğ½Ğ¸Ñ… Ñ‡ĞµĞºĞ°ÑƒÑ‚Ñƒ
class CheckoutRequest(BaseModel):
    payment_method: str = "cash"
    customer_id: int = None

@app.post("/checkout")
def checkout(order_data: CheckoutRequest):
    # 1. Ğ”Ñ–ÑÑ‚Ğ°Ñ”Ğ¼Ğ¾ ĞºĞ¾ÑˆĞ¸Ğº Ğ· Redis
    raw_data = r.hgetall(CART_KEY)
    if not raw_data:
        raise HTTPException(status_code=400, detail="Cart is empty")

    cart_items = []
    deduction_list = []
    
    total_price = 0

    for key, value in raw_data.items():
        item_dict = json.loads(value)
        cart_items.append(item_dict)
        
        # Ğ Ğ°Ñ…ÑƒÑ”Ğ¼Ğ¾ ÑÑƒĞ¼Ñƒ
        total_price += item_dict['price'] * item_dict['quantity']

        # Ğ“Ğ¾Ñ‚ÑƒÑ”Ğ¼Ğ¾ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ´Ğ»Ñ ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ½Ñ Ğ·Ñ– ÑĞºĞ»Ğ°Ğ´Ñƒ
        # Ğ›Ğ¾Ğ³Ñ–ĞºĞ°: ÑĞºÑ‰Ğ¾ Ñ” variant_id -> Ñ†Ğµ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚, Ñ–Ğ½Ğ°ĞºÑˆĞµ -> Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¸Ğ¹ Ñ‚Ğ¾Ğ²Ğ°Ñ€
        if item_dict.get('variant_id'):
            deduction_list.append({
                "entity_type": "product_variant",
                "entity_id": item_dict['variant_id'],
                "quantity": item_dict['quantity']
            })
        else:
            deduction_list.append({
                "entity_type": "product",
                "entity_id": item_dict['product_id'],
                "quantity": item_dict['quantity']
            })

    # 2. Ğ’Ğ†Ğ”ĞŸĞ ĞĞ’Ğ›Ğ¯Ğ„ĞœĞ Ğ—ĞĞŸĞ˜Ğ¢ ĞĞ Ğ¡ĞšĞ›ĞĞ” (Ğ¡Ğ¿Ğ¸ÑĞ°Ğ½Ğ½Ñ)
    # ĞœĞ¸ Ğ·Ğ²ĞµÑ€Ñ‚Ğ°Ñ”Ğ¼Ğ¾ÑÑŒ Ğ´Ğ¾ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ° product_service Ğ¿Ğ¾ Ğ²Ğ½ÑƒÑ‚Ñ€Ñ–ÑˆĞ½Ñ–Ğ¹ Ğ¼ĞµÑ€ĞµĞ¶Ñ– Docker (Ğ¿Ğ¾Ñ€Ñ‚ 8000)
    try:
        # URL Ğ¼Ğ°Ñ” Ğ²Ñ–Ğ´Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ°Ñ‚Ğ¸ Ñ‚Ğ¾Ğ¼Ñƒ, Ğ´Ğµ Ğ¼Ğ¸ Ğ´Ğ¾Ğ´Ğ°Ğ»Ğ¸ reduce-batch (ÑˆĞ²Ğ¸Ğ´ÑˆĞµ Ğ·Ğ° Ğ²ÑĞµ Ñ†Ğµ /inventory/reduce-batch)
        # Ğ¯ĞºÑ‰Ğ¾ Ñ‚Ğ²Ñ–Ğ¹ inventory.py Ğ¿Ñ–Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğ¹ ÑĞº /inventory, Ñ‚Ğ¾ ÑˆĞ»ÑÑ… Ñ‚Ğ°ĞºĞ¸Ğ¹:
        requests.post(
            "http://product_service:8000/inventory/reduce-batch", 
            json=deduction_list
        )
    except Exception as e:
        print(f"Error deducting stock: {e}")
        # Ğ¢ÑƒÑ‚ Ğ¼Ğ¾Ğ¶Ğ½Ğ° Ğ²Ğ¸Ñ€Ñ–ÑˆĞ¸Ñ‚Ğ¸: Ğ¿ĞµÑ€ĞµÑ€Ğ¸Ğ²Ğ°Ñ‚Ğ¸ Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶ Ñ‡Ğ¸ Ğ½Ñ–. ĞŸĞ¾ĞºĞ¸ Ñ‰Ğ¾ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ»Ğ¾Ğ³ÑƒÑ”Ğ¼Ğ¾.

    # 3. Ğ¢ÑƒÑ‚ Ğ¼Ğ°Ğ»Ğ¾ Ğ± Ğ±ÑƒÑ‚Ğ¸ Ğ·Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ½Ñ Ğ·Ğ°Ğ¼Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ Ğ² Ğ‘Ğ” orders (Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ğ¼Ğ¾ Ğ´Ğ»Ñ ÑÑ‚Ğ¸ÑĞ»Ğ¾ÑÑ‚Ñ–)
    # ... save_order_to_db(...)

    # 4. ĞÑ‡Ğ¸Ñ‰ÑƒÑ”Ğ¼Ğ¾ ĞºĞ¾ÑˆĞ¸Ğº
    r.delete(CART_KEY)

    return {"status": "success", "total_price": total_price}

# --- Ğ’Ğ˜Ğ”ĞĞ›Ğ˜Ğ¢Ğ˜ Ğ¢ĞĞ’ĞĞ  ---
@app.delete("/cart/{cart_item_id}")
def remove_item(cart_item_id: str):
    r.hdel(CART_KEY, cart_item_id)
    return {"status": "removed"}

# --- ĞĞ§Ğ˜Ğ¡Ğ¢Ğ˜Ğ¢Ğ˜ ĞšĞĞ¨Ğ˜Ğš ---
@app.delete("/cart/")
def clear_cart():
    r.delete(CART_KEY)
    return {"status": "cleared"}

--------------------------------------------------
PATH: ./.history/frontend/package_20260121112129.json
--------------------------------------------------
{
  "name": "frontend",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "axios": "^1.7.0",
    "vue": "^3.5.24"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4.1.18",
    "@vitejs/plugin-vue": "^6.0.1",
    "autoprefixer": "^10.4.17",
    "postcss": "^8.4.33",
    "tailwindcss": "^3.4.17",
    "vite": "^7.2.4"
  }
}


--------------------------------------------------
PATH: ./.history/frontend/vite.config_20260125093415.js
--------------------------------------------------
import { fileURLToPath, URL } from 'node:url'
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'

// https://vitejs.dev/config/
export default defineConfig({
  plugins: [
    vue(),
  ],
  resolve: {
    alias: {
      '@': fileURLToPath(new URL('./src', import.meta.url))
    }
  },
  server: {
    host: '0.0.0.0',
    port: 5173,
    watch: {
      usePolling: true
    },
    proxy: {
      // 1. Ğ—Ğ°Ğ¿Ğ¸Ñ‚Ğ¸ Ğ´Ğ¾ ĞšĞĞ¨Ğ˜ĞšĞ Ğ¹Ğ´ÑƒÑ‚ÑŒ Ğ½Ğ° order_service (8000)
      '^/api/(cart|checkout)': {
        target: 'http://order_service:8000',
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/api/, '') 
      },
      // 2. Ğ’ÑÑ– Ñ–Ğ½ÑˆÑ– Ğ·Ğ°Ğ¿Ğ¸Ñ‚Ğ¸ (Categories, Units, Products) Ğ¹Ğ´ÑƒÑ‚ÑŒ Ğ½Ğ° product_service (8001)
      '/api': {
        target: 'http://product_service:8000', // Ğ’ÑĞµÑ€ĞµĞ´Ğ¸Ğ½Ñ– Docker Ğ¼ĞµÑ€ĞµĞ¶Ñ– Ğ²Ğ¾Ğ½Ğ¸ Ğ²ÑÑ– ÑĞ»ÑƒÑ…Ğ°ÑÑ‚ÑŒ 8000
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/api/, '')
      }
    }
  }
})

--------------------------------------------------
PATH: ./.history/frontend/vite.config_20260125093209.js
--------------------------------------------------
import { fileURLToPath, URL } from 'node:url'
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'

// https://vitejs.dev/config/
export default defineConfig({
  plugins: [
    vue(),
  ],
  resolve: {
    alias: {
      '@': fileURLToPath(new URL('./src', import.meta.url))
    }
  },
  server: {
    host: '0.0.0.0',
    port: 5173,
    watch: {
      usePolling: true
    },
    proxy: {
      // 1. Ğ—Ğ°Ğ¿Ğ¸Ñ‚Ğ¸ Ğ´Ğ¾ ĞšĞĞ¨Ğ˜ĞšĞ Ğ¹Ğ´ÑƒÑ‚ÑŒ Ğ½Ğ° order_service (8000)
      '/api/cart': {
        target: 'http://order_service:8000',
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/api/, '') 
      },
      // 2. Ğ’ÑÑ– Ñ–Ğ½ÑˆÑ– Ğ·Ğ°Ğ¿Ğ¸Ñ‚Ğ¸ (Categories, Units, Products) Ğ¹Ğ´ÑƒÑ‚ÑŒ Ğ½Ğ° product_service (8001)
      '/api': {
        target: 'http://product_service:8000', // Ğ’ÑĞµÑ€ĞµĞ´Ğ¸Ğ½Ñ– Docker Ğ¼ĞµÑ€ĞµĞ¶Ñ– Ğ²Ğ¾Ğ½Ğ¸ Ğ²ÑÑ– ÑĞ»ÑƒÑ…Ğ°ÑÑ‚ÑŒ 8000
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/api/, '')
      }
    }
  }
})

--------------------------------------------------
PATH: ./.history/frontend/package_20260123212441.json
--------------------------------------------------
{
  "name": "frontend",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "axios": "^1.7.0",
    "vue": "^3.5.24"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4.1.18",
    "@vitejs/plugin-vue": "^6.0.1",
    "autoprefixer": "^10.4.17",
    "postcss": "^8.4.33",
    "tailwindcss": "^3.4.17",
    "vite": "^7.2.4"
  }
}


--------------------------------------------------
PATH: ./.history/frontend/vite.config_20260125094300.js
--------------------------------------------------
import { fileURLToPath, URL } from 'node:url'
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'

// https://vitejs.dev/config/
export default defineConfig({
  plugins: [
    vue(),
  ],
  resolve: {
    alias: {
      '@': fileURLToPath(new URL('./src', import.meta.url))
    }
  },
  server: {
    host: '0.0.0.0',
    port: 5173,
    proxy: {
      // 1. Ğ—Ğ°Ğ¿Ğ¸Ñ‚Ğ¸ Ğ´Ğ¾ ĞšĞĞ¨Ğ˜ĞšĞ Ğ¹Ğ´ÑƒÑ‚ÑŒ Ğ½Ğ° order_service (8000)
      '/api/cart': {
        target: 'http://order_service:8000',
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/api/, '') 
      },
      // 2. Ğ’ÑÑ– Ñ–Ğ½ÑˆÑ– Ğ·Ğ°Ğ¿Ğ¸Ñ‚Ğ¸ (Categories, Units, Products) Ğ¹Ğ´ÑƒÑ‚ÑŒ Ğ½Ğ° product_service (8001)
      '/api': {
        target: 'http://product_service:8000', // Ğ’ÑĞµÑ€ĞµĞ´Ğ¸Ğ½Ñ– Docker Ğ¼ĞµÑ€ĞµĞ¶Ñ– Ğ²Ğ¾Ğ½Ğ¸ Ğ²ÑÑ– ÑĞ»ÑƒÑ…Ğ°ÑÑ‚ÑŒ 8000
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/api/, '')
      }
    }
  }
})

--------------------------------------------------
PATH: ./.history/frontend/package_20260123213935.json
--------------------------------------------------
{
  "name": "frontend",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "axios": "^1.7.0",
    "vue": "^3.5.24"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4.1.18",
    "@vitejs/plugin-vue": "^6.0.1",
    "autoprefixer": "^10.4.17",
    "postcss": "^8.4.33",
    "tailwindcss": "^3.4.17",
    "vite": "^7.2.4"
  }
}


--------------------------------------------------
PATH: ./.history/frontend/vite.config_20260125093710.js
--------------------------------------------------
import { fileURLToPath, URL } from 'node:url'
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'

// https://vitejs.dev/config/
export default defineConfig({
  plugins: [
    vue(),
  ],
  resolve: {
    alias: {
      '@': fileURLToPath(new URL('./src', import.meta.url))
    }
  },
  server: {
    host: '0.0.0.0',
    port: 5173,
    watch: {
      usePolling: true
    },
    proxy: {
      // 1. Ğ—Ğ°Ğ¿Ğ¸Ñ‚Ğ¸ Ğ´Ğ¾ ĞšĞĞ¨Ğ˜ĞšĞ Ğ¹Ğ´ÑƒÑ‚ÑŒ Ğ½Ğ° order_service (8000)
      '/api/(cart|checkout)': {
        target: 'http://order_service:8002',
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/api/, '') 
      },
      // 2. Ğ’ÑÑ– Ñ–Ğ½ÑˆÑ– Ğ·Ğ°Ğ¿Ğ¸Ñ‚Ğ¸ (Categories, Units, Products) Ğ¹Ğ´ÑƒÑ‚ÑŒ Ğ½Ğ° product_service (8001)
      '/api': {
        target: 'http://product_service:8000', // Ğ’ÑĞµÑ€ĞµĞ´Ğ¸Ğ½Ñ– Docker Ğ¼ĞµÑ€ĞµĞ¶Ñ– Ğ²Ğ¾Ğ½Ğ¸ Ğ²ÑÑ– ÑĞ»ÑƒÑ…Ğ°ÑÑ‚ÑŒ 8000
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/api/, '')
      }
    }
  }
})

--------------------------------------------------
PATH: ./.history/frontend/vite.config_20260125093424.js
--------------------------------------------------
import { fileURLToPath, URL } from 'node:url'
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'

// https://vitejs.dev/config/
export default defineConfig({
  plugins: [
    vue(),
  ],
  resolve: {
    alias: {
      '@': fileURLToPath(new URL('./src', import.meta.url))
    }
  },
  server: {
    host: '0.0.0.0',
    port: 5173,
    watch: {
      usePolling: true
    },
    proxy: {
      // 1. Ğ—Ğ°Ğ¿Ğ¸Ñ‚Ğ¸ Ğ´Ğ¾ ĞšĞĞ¨Ğ˜ĞšĞ Ğ¹Ğ´ÑƒÑ‚ÑŒ Ğ½Ğ° order_service (8000)
      '/api/cart': {
        target: 'http://order_service:8000',
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/api/, '') 
      },
      // 2. Ğ’ÑÑ– Ñ–Ğ½ÑˆÑ– Ğ·Ğ°Ğ¿Ğ¸Ñ‚Ğ¸ (Categories, Units, Products) Ğ¹Ğ´ÑƒÑ‚ÑŒ Ğ½Ğ° product_service (8001)
      '/api': {
        target: 'http://product_service:8000', // Ğ’ÑĞµÑ€ĞµĞ´Ğ¸Ğ½Ñ– Docker Ğ¼ĞµÑ€ĞµĞ¶Ñ– Ğ²Ğ¾Ğ½Ğ¸ Ğ²ÑÑ– ÑĞ»ÑƒÑ…Ğ°ÑÑ‚ÑŒ 8000
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/api/, '')
      }
    }
  }
})

--------------------------------------------------
PATH: ./.history/frontend/vite.config_20260111184527.js
--------------------------------------------------
import { fileURLToPath, URL } from 'node:url'
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'

// https://vitejs.dev/config/
export default defineConfig({
  plugins: [
    vue(),
  ],
  resolve: {
    alias: {
      '@': fileURLToPath(new URL('./src', import.meta.url))
    }
  },
  server: {
    host: '0.0.0.0',
    port: 5173,
    proxy: {
      // 1. Ğ—Ğ°Ğ¿Ğ¸Ñ‚Ğ¸ Ğ´Ğ¾ ĞšĞĞ¨Ğ˜ĞšĞ Ğ¹Ğ´ÑƒÑ‚ÑŒ Ğ½Ğ° order_service (8000)
      '/api/cart': {
        target: 'http://order_service:8000',
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/api/, '') 
      },
      // 2. Ğ’ÑÑ– Ñ–Ğ½ÑˆÑ– Ğ·Ğ°Ğ¿Ğ¸Ñ‚Ğ¸ (Categories, Units, Products) Ğ¹Ğ´ÑƒÑ‚ÑŒ Ğ½Ğ° product_service (8001)
      '/api': {
        target: 'http://product_service:8000', // Ğ’ÑĞµÑ€ĞµĞ´Ğ¸Ğ½Ñ– Docker Ğ¼ĞµÑ€ĞµĞ¶Ñ– Ğ²Ğ¾Ğ½Ğ¸ Ğ²ÑÑ– ÑĞ»ÑƒÑ…Ğ°ÑÑ‚ÑŒ 8000
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/api/, '')
      }
    }
  }
})

--------------------------------------------------
PATH: ./.history/frontend/vite.config_20260125093649.js
--------------------------------------------------
import { fileURLToPath, URL } from 'node:url'
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'

// https://vitejs.dev/config/
export default defineConfig({
  plugins: [
    vue(),
  ],
  resolve: {
    alias: {
      '@': fileURLToPath(new URL('./src', import.meta.url))
    }
  },
  server: {
    host: '0.0.0.0',
    port: 5173,
    watch: {
      usePolling: true
    },
    proxy: {
      // 1. Ğ—Ğ°Ğ¿Ğ¸Ñ‚Ğ¸ Ğ´Ğ¾ ĞšĞĞ¨Ğ˜ĞšĞ Ğ¹Ğ´ÑƒÑ‚ÑŒ Ğ½Ğ° order_service (8000)
      '/api/(cart|checkout)': {
        target: 'http://order_service:8000',
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/api/, '') 
      },
      // 2. Ğ’ÑÑ– Ñ–Ğ½ÑˆÑ– Ğ·Ğ°Ğ¿Ğ¸Ñ‚Ğ¸ (Categories, Units, Products) Ğ¹Ğ´ÑƒÑ‚ÑŒ Ğ½Ğ° product_service (8001)
      '/api': {
        target: 'http://product_service:8000', // Ğ’ÑĞµÑ€ĞµĞ´Ğ¸Ğ½Ñ– Docker Ğ¼ĞµÑ€ĞµĞ¶Ñ– Ğ²Ğ¾Ğ½Ğ¸ Ğ²ÑÑ– ÑĞ»ÑƒÑ…Ğ°ÑÑ‚ÑŒ 8000
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/api/, '')
      }
    }
  }
})

--------------------------------------------------
PATH: ./.history/frontend/src/App_20260118165650.vue
--------------------------------------------------
<script setup>
import { ref, onMounted } from 'vue'
// --- Ğ†Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ÑƒÑ”Ğ¼Ğ¾ ĞĞĞ’Ğ† ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ¸ ---
import Sidebar from '@/components/common/Sidebar.vue'
import ProductCard from '@/components/pos/ProductCard.vue'
import CartDrawer from '@/components/pos/CartDrawer.vue'
import ProductModal from '@/components/pos/ProductModal.vue'

// --- Ğ†Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ÑƒÑ”Ğ¼Ğ¾ Ğ²ĞµĞ»Ğ¸ĞºÑ– Ñ€Ğ¾Ğ·Ğ´Ñ–Ğ»Ğ¸ ---
import Warehouse from '@/components/warehouse/Warehouse.vue'
import Statistics from '@/components/stats/Statistics.vue'
import Customers from '@/components/crm/Customers.vue'

// --- Ğ†Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ÑƒÑ”Ğ¼Ğ¾ Ğ»Ğ¾Ğ³Ñ–ĞºÑƒ (Composables) ---
import { useProducts } from '@/composables/useProducts'
import { useCart } from '@/composables/useCart'

// Ğ¡Ñ‚Ğ°Ğ½ Ğ½Ğ°Ğ²Ñ–Ğ³Ğ°Ñ†Ñ–Ñ—
const currentPage = ref('pos')

// --- Ğ›Ğ¾Ğ³Ñ–ĞºĞ° POS (ĞšĞ°ÑĞ¸) ---
// Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ useProducts Ğ´Ğ»Ñ Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ–Ğ² Ğ½Ğ° Ğ²Ñ–Ñ‚Ñ€Ğ¸Ğ½Ñƒ
const { 
  filteredProducts, // Ğ’Ğ¶Ğµ Ğ²Ñ–Ğ´Ñ„Ñ–Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ– Ğ¿Ğ¾ÑˆÑƒĞºĞ¾Ğ¼
  productSearch, 
  fetchProducts 
} = useProducts()

// Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ useCart Ğ´Ğ»Ñ ĞºĞ¾ÑˆĞ¸ĞºĞ° (Ğ»Ñ–Ñ‡Ğ¸Ğ»ÑŒĞ½Ğ¸Ğº, Ğ²Ñ–Ğ´ĞºÑ€Ğ¸Ñ‚Ñ‚Ñ)
const { 
  cartCount, 
  fetchCart // Ğ©Ğ¾Ğ± Ğ¾Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğ¸ Ğ»Ñ–Ñ‡Ğ¸Ğ»ÑŒĞ½Ğ¸Ğº Ğ¿Ñ€Ğ¸ ÑÑ‚Ğ°Ñ€Ñ‚Ñ–
} = useCart()

// Ğ¡Ñ‚Ğ°Ğ½ Ğ´Ğ»Ñ UI ĞºĞ°ÑĞ¸
const isCartOpen = ref(false)
const isModalOpen = ref(false)
const selectedProduct = ref(null)

// ĞĞ±Ñ€Ğ¾Ğ±ĞºĞ° ĞºĞ»Ñ–ĞºÑƒ Ğ¿Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ
const handleProductClick = (product) => {
  // Ğ¯ĞºÑ‰Ğ¾ Ñ” Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸ Ğ°Ğ±Ğ¾ Ğ¼Ğ¾Ğ´Ğ¸Ñ„Ñ–ĞºĞ°Ñ‚Ğ¾Ñ€Ğ¸ -> Ğ²Ñ–Ğ´ĞºÑ€Ğ¸Ğ²Ğ°Ñ”Ğ¼Ğ¾ Ğ¼Ğ¾Ğ´Ğ°Ğ»ĞºÑƒ
  if (product.has_variants || (product.modifier_groups && product.modifier_groups.length > 0) || (product.process_groups && product.process_groups.length > 0)) {
    selectedProduct.value = product
    isModalOpen.value = true
  } else {
    // Ğ¯ĞºÑ‰Ğ¾ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¸Ğ¹ Ñ‚Ğ¾Ğ²Ğ°Ñ€ -> Ğ´Ğ¾Ğ´Ğ°Ñ”Ğ¼Ğ¾ Ğ² ĞºĞ¾ÑˆĞ¸Ğº (Ñ‡ĞµÑ€ĞµĞ· ProductModal Ğ»Ğ¾Ğ³Ñ–ĞºÑƒ Ğ°Ğ±Ğ¾ Ğ½Ğ°Ğ¿Ñ€ÑĞ¼Ñƒ, 
    // Ğ°Ğ»Ğµ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾Ñ‚Ğ¸ Ğ²Ñ–Ğ´ĞºÑ€Ğ¸Ñ”Ğ¼Ğ¾ Ğ¼Ğ¾Ğ´Ğ°Ğ»ĞºÑƒ Ğ°Ğ±Ğ¾ Ğ¼Ğ¾Ğ¶Ğ½Ğ° Ğ²Ğ¸ĞºĞ»Ğ¸ĞºĞ°Ñ‚Ğ¸ addToCart Ğ½Ğ°Ğ¿Ñ€ÑĞ¼Ñƒ.
    // Ğ¢ÑƒÑ‚ ĞºÑ€Ğ°Ñ‰Ğµ Ğ²Ñ–Ğ´ĞºÑ€Ğ¸Ñ‚Ğ¸ Ğ¼Ğ¾Ğ´Ğ°Ğ»ĞºÑƒ Ğ´Ğ»Ñ Ğ¿Ñ–Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¶ĞµĞ½Ğ½Ñ Ğ°Ğ±Ğ¾ ÑˆĞ²Ğ¸Ğ´ĞºĞ¾Ğ³Ğ¾ Ğ´Ğ¾Ğ´Ğ°Ğ²Ğ°Ğ½Ğ½Ñ)
    selectedProduct.value = product
    isModalOpen.value = true
  }
}

// Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ´Ğ°Ğ½Ğ¸Ñ… Ğ¿Ñ€Ğ¸ ÑÑ‚Ğ°Ñ€Ñ‚Ñ–
onMounted(() => {
  fetchProducts()
  fetchCart()
})
</script>

<template>
  <div class="flex h-screen bg-gray-50 text-gray-800 font-sans overflow-hidden">
    <Sidebar :current-page="currentPage" @change-page="(page) => currentPage = page" />

    <main v-if="currentPage === 'pos'" class="flex-1 ml-64 flex flex-col h-screen relative">
      <header class="bg-white/80 backdrop-blur-md sticky top-0 z-10 border-b border-gray-200 px-8 py-4 flex justify-between items-center">
        <div>
          <h2 class="text-2xl font-bold text-gray-800">ĞœĞµĞ½Ñ</h2>
          <div class="flex items-center gap-2 mt-1">
             <i class="fas fa-search text-gray-400"></i>
             <input v-model="productSearch" type="text" placeholder="ĞŸĞ¾ÑˆÑƒĞº ĞºĞ°Ğ²Ğ¸..." class="bg-transparent outline-none text-sm w-64">
          </div>
        </div>
        
        <button @click="isCartOpen = true" class="bg-gray-900 text-white px-6 py-3 rounded-xl font-bold hover:bg-gray-800 transition shadow-lg flex items-center gap-3 active:scale-95">
          <i class="fas fa-shopping-cart"></i> <span>ĞšĞ¾ÑˆĞ¸Ğº: {{ cartCount }}</span>
        </button>
      </header>

      <div class="p-8 overflow-y-auto flex-1 custom-scrollbar">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-6">
          <ProductCard 
            v-for="item in filteredProducts" 
            :key="item.id" 
            :product="item" 
            @click="handleProductClick" 
          />
        </div>
        
        <div v-if="filteredProducts.length === 0" class="text-center text-gray-400 mt-20">
            <i class="fas fa-mug-hot text-6xl mb-4 opacity-20"></i>
            <p>Ğ¢Ğ¾Ğ²Ğ°Ñ€Ñ–Ğ² Ğ½Ğµ Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾</p>
        </div>
      </div>

      <CartDrawer 
        :is-open="isCartOpen"
        @close="isCartOpen = false"
      />
      
      <ProductModal 
        :is-open="isModalOpen"
        :product="selectedProduct"
        @close="isModalOpen = false"
      />
    </main>

    <Warehouse v-if="currentPage === 'warehouse'" />

    <Statistics v-if="currentPage === 'statistics'" />

    <Customers v-if="currentPage === 'customers'" />
    
  </div>
</template>

--------------------------------------------------
PATH: ./.history/frontend/src/App_20260123213853.vue
--------------------------------------------------
<script setup>
import { ref, onMounted } from 'vue'
// --- Ğ†Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ÑƒÑ”Ğ¼Ğ¾ ĞĞĞ’Ğ† ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ¸ ---
import Sidebar from '@/components/common/Sidebar.vue'
import ProductCard from '@/components/pos/ProductCard.vue'
import CartDrawer from '@/components/pos/CartDrawer.vue'
import ProductModal from '@/components/pos/ProductModal.vue'

// --- Ğ†Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ÑƒÑ”Ğ¼Ğ¾ Ğ²ĞµĞ»Ğ¸ĞºÑ– Ñ€Ğ¾Ğ·Ğ´Ñ–Ğ»Ğ¸ ---
import Warehouse from '@/components/warehouse/Warehouse.vue'
import Statistics from '@/components/stats/Statistics.vue'
import Customers from '@/components/crm/Customers.vue'

// --- Ğ†Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ÑƒÑ”Ğ¼Ğ¾ Ğ»Ğ¾Ğ³Ñ–ĞºÑƒ (Composables) ---
import { useProducts } from '@/composables/useProducts'
import { useCart } from '@/composables/useCart'

// Ğ¡Ñ‚Ğ°Ğ½ Ğ½Ğ°Ğ²Ñ–Ğ³Ğ°Ñ†Ñ–Ñ—
const currentPage = ref('pos')

// --- Ğ›Ğ¾Ğ³Ñ–ĞºĞ° POS (ĞšĞ°ÑĞ¸) ---
// Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ useProducts Ğ´Ğ»Ñ Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ–Ğ² Ğ½Ğ° Ğ²Ñ–Ñ‚Ñ€Ğ¸Ğ½Ñƒ
const { 
  filteredProducts, // Ğ’Ğ¶Ğµ Ğ²Ñ–Ğ´Ñ„Ñ–Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ– Ğ¿Ğ¾ÑˆÑƒĞºĞ¾Ğ¼
  productSearch, 
  fetchProducts 
} = useProducts()

// Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ useCart Ğ´Ğ»Ñ ĞºĞ¾ÑˆĞ¸ĞºĞ° (Ğ»Ñ–Ñ‡Ğ¸Ğ»ÑŒĞ½Ğ¸Ğº, Ğ²Ñ–Ğ´ĞºÑ€Ğ¸Ñ‚Ñ‚Ñ)
const { 
  cartCount, 
  fetchCart // Ğ©Ğ¾Ğ± Ğ¾Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğ¸ Ğ»Ñ–Ñ‡Ğ¸Ğ»ÑŒĞ½Ğ¸Ğº Ğ¿Ñ€Ğ¸ ÑÑ‚Ğ°Ñ€Ñ‚Ñ–
} = useCart()

// Ğ¡Ñ‚Ğ°Ğ½ Ğ´Ğ»Ñ UI ĞºĞ°ÑĞ¸
const isCartOpen = ref(false)
const isModalOpen = ref(false)
const selectedProduct = ref(null)

// ĞĞ±Ñ€Ğ¾Ğ±ĞºĞ° ĞºĞ»Ñ–ĞºÑƒ Ğ¿Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ
const handleProductClick = (product) => {
  // Ğ¯ĞºÑ‰Ğ¾ Ñ” Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸ Ğ°Ğ±Ğ¾ Ğ¼Ğ¾Ğ´Ğ¸Ñ„Ñ–ĞºĞ°Ñ‚Ğ¾Ñ€Ğ¸ -> Ğ²Ñ–Ğ´ĞºÑ€Ğ¸Ğ²Ğ°Ñ”Ğ¼Ğ¾ Ğ¼Ğ¾Ğ´Ğ°Ğ»ĞºÑƒ
  if (product.has_variants || (product.modifier_groups && product.modifier_groups.length > 0) || (product.process_groups && product.process_groups.length > 0)) {
    selectedProduct.value = product
    isModalOpen.value = true
  } else {
    // Ğ¯ĞºÑ‰Ğ¾ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¸Ğ¹ Ñ‚Ğ¾Ğ²Ğ°Ñ€ -> Ğ´Ğ¾Ğ´Ğ°Ñ”Ğ¼Ğ¾ Ğ² ĞºĞ¾ÑˆĞ¸Ğº (Ñ‡ĞµÑ€ĞµĞ· ProductModal Ğ»Ğ¾Ğ³Ñ–ĞºÑƒ Ğ°Ğ±Ğ¾ Ğ½Ğ°Ğ¿Ñ€ÑĞ¼Ñƒ, 
    // Ğ°Ğ»Ğµ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾Ñ‚Ğ¸ Ğ²Ñ–Ğ´ĞºÑ€Ğ¸Ñ”Ğ¼Ğ¾ Ğ¼Ğ¾Ğ´Ğ°Ğ»ĞºÑƒ Ğ°Ğ±Ğ¾ Ğ¼Ğ¾Ğ¶Ğ½Ğ° Ğ²Ğ¸ĞºĞ»Ğ¸ĞºĞ°Ñ‚Ğ¸ addToCart Ğ½Ğ°Ğ¿Ñ€ÑĞ¼Ñƒ.
    // Ğ¢ÑƒÑ‚ ĞºÑ€Ğ°Ñ‰Ğµ Ğ²Ñ–Ğ´ĞºÑ€Ğ¸Ñ‚Ğ¸ Ğ¼Ğ¾Ğ´Ğ°Ğ»ĞºÑƒ Ğ´Ğ»Ñ Ğ¿Ñ–Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¶ĞµĞ½Ğ½Ñ Ğ°Ğ±Ğ¾ ÑˆĞ²Ğ¸Ğ´ĞºĞ¾Ğ³Ğ¾ Ğ´Ğ¾Ğ´Ğ°Ğ²Ğ°Ğ½Ğ½Ñ)
    selectedProduct.value = product
    isModalOpen.value = true
  }
}

// Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ´Ğ°Ğ½Ğ¸Ñ… Ğ¿Ñ€Ğ¸ ÑÑ‚Ğ°Ñ€Ñ‚Ñ–
onMounted(() => {
  fetchProducts()
  fetchCart()
})
</script>

<template>
  <div class="flex h-screen bg-gray-50 text-gray-800 font-sans overflow-hidden">
    <Sidebar :current-page="currentPage" @change-page="(page) => currentPage = page" />

    <main v-if="currentPage === 'pos'" class="flex-1 ml-64 flex flex-col h-screen relative">
      <header class="bg-white/80 backdrop-blur-md sticky top-0 z-10 border-b border-gray-200 px-8 py-4 flex justify-between items-center">
        <div>
          <h2 class="text-2xl font-bold text-gray-800">ĞœĞµĞ½Ñ</h2>
          <div class="flex items-center gap-2 mt-1">
             <i class="fas fa-search text-gray-400"></i>
             <input v-model="productSearch" type="text" placeholder="ĞŸĞ¾ÑˆÑƒĞº ĞºĞ°Ğ²Ğ¸..." class="bg-transparent outline-none text-sm w-64">
          </div>
        </div>
        
        <button @click="isCartOpen = true" class="bg-gray-900 text-white px-6 py-3 rounded-xl font-bold hover:bg-gray-800 transition shadow-lg flex items-center gap-3 active:scale-95">
          <i class="fas fa-shopping-cart"></i> <span>ĞšĞ¾ÑˆĞ¸Ğº: {{ cartCount }}</span>
        </button>
      </header>

      <div class="p-8 overflow-y-auto flex-1 custom-scrollbar">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-6">
          <ProductCard 
            v-for="item in filteredProducts" 
            :key="item.id" 
            :product="item" 
            @click="handleProductClick" 
          />
        </div>
        
        <div v-if="filteredProducts.length === 0" class="text-center text-gray-400 mt-20">
            <i class="fas fa-mug-hot text-6xl mb-4 opacity-20"></i>
            <p>Ğ¢Ğ¾Ğ²Ğ°Ñ€Ñ–Ğ² Ğ½Ğµ Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾</p>
        </div>
      </div>

      <CartDrawer 
        :is-open="isCartOpen"
        @close="isCartOpen = false"
      />
      
      <ProductModal 
        :is-open="isModalOpen"
        :product="selectedProduct"
        @close="isModalOpen = false"
      />
    </main>

    <Warehouse v-if="currentPage === 'warehouse'" />

    <Statistics v-if="currentPage === 'statistics'" />

    <Customers v-if="currentPage === 'customers'" />
    
  </div>
</template>

--------------------------------------------------
PATH: ./.history/frontend/src/components/warehouse/Warehouse_20260120225340.vue
--------------------------------------------------
<script setup>
import { ref, onMounted, defineAsyncComponent } from 'vue'
import { useWarehouse } from '@/composables/useWarehouse'

// --- ĞĞĞ’Ğ˜Ğ™ Ğ†ĞœĞŸĞĞ Ğ¢ ---
const StockTab = defineAsyncComponent(() => import('./tabs/StockTab.vue'))

const ProductsTab = defineAsyncComponent(() => import('./tabs/ProductsTab.vue'))
const IngredientsTab = defineAsyncComponent(() => import('./tabs/IngredientsTab.vue'))
const RecipesTab = defineAsyncComponent(() => import('./tabs/RecipesTab.vue'))
const ProcessesTab = defineAsyncComponent(() => import('./tabs/ProcessesTab.vue'))
const ConsumablesTab = defineAsyncComponent(() => import('./tabs/ConsumablesTab.vue'))
const UnitsTab = defineAsyncComponent(() => import('./tabs/UnitsTab.vue'))
const CategoriesTab = defineAsyncComponent(() => import('./tabs/CategoriesTab.vue'))

// Ğ—Ğ¼Ñ–Ğ½Ğ¸Ğ¼Ğ¾ Ğ´ĞµÑ„Ğ¾Ğ»Ñ‚Ğ½Ñƒ Ğ²ĞºĞ»Ğ°Ğ´ĞºÑƒ Ğ½Ğ° 'stock'
const activeTab = ref('stock')
const { fetchData, loading } = useWarehouse()

// --- Ğ”ĞĞ”ĞĞ„ĞœĞ Ğ’ ĞĞ‘'Ğ„ĞšĞ¢ ---
const tabs = {
    stock: StockTab, // <-- ĞĞ¾Ğ²Ğ° Ğ²ĞºĞ»Ğ°Ğ´ĞºĞ°
    products: ProductsTab,
    recipes: RecipesTab,
    ingredients: IngredientsTab,
    processes: ProcessesTab,
    consumables: ConsumablesTab,
    units: UnitsTab,
    categories: CategoriesTab
}

onMounted(() => {
    fetchData()
})
</script>

<template>
  <div class="p-8 h-screen overflow-y-auto bg-gray-50 ml-64 custom-scrollbar">
    <div class="flex justify-between items-center mb-8">
      <h2 class="text-3xl font-bold text-gray-800">ğŸ“¦ Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»Ñ–Ğ½Ğ½Ñ ÑĞºĞ»Ğ°Ğ´Ğ¾Ğ¼</h2>
      <button @click="fetchData" class="text-blue-600 hover:bg-blue-50 p-2 rounded-full">
        <i class="fas fa-sync-alt" :class="{'fa-spin': loading}"></i>
      </button>
    </div>

    <div class="flex space-x-1 bg-gray-200 p-1 rounded-xl w-fit mb-8 overflow-x-auto">
      <button @click="activeTab='stock'" :class="activeTab==='stock'?'bg-white text-green-600 shadow-sm':''" class="px-6 py-2 rounded-lg font-bold transition-all"><i class="fas fa-clipboard-check mr-2"></i>Ğ—Ğ°Ğ»Ğ¸ÑˆĞºĞ¸</button>
      
      <button @click="activeTab='recipes'" :class="activeTab==='recipes'?'bg-white text-orange-600 shadow-sm':''" class="px-6 py-2 rounded-lg font-bold transition-all"><i class="fas fa-book-open mr-2"></i>Ğ ĞµÑ†ĞµĞ¿Ñ‚Ğ¸</button>
      <button @click="activeTab='products'" :class="activeTab==='products'?'bg-white text-purple-600 shadow-sm':''" class="px-6 py-2 rounded-lg font-bold transition-all">Ğ¢Ğ¾Ğ²Ğ°Ñ€Ğ¸</button>
      <button @click="activeTab='processes'" :class="activeTab==='processes'?'bg-white text-indigo-600 shadow-sm':''" class="px-6 py-2 rounded-lg font-bold transition-all"><i class="fas fa-tasks mr-2"></i>ĞŸÑ€Ğ¾Ñ†ĞµÑĞ¸</button>
      
      <button @click="activeTab='ingredients'" :class="activeTab==='ingredients'?'bg-white text-blue-600 shadow-sm':''" class="px-6 py-2 rounded-lg font-bold transition-all">Ğ†Ğ½Ğ³Ñ€Ñ–Ğ´Ñ–Ñ”Ğ½Ñ‚Ğ¸</button>
      <button @click="activeTab='consumables'" :class="activeTab==='consumables'?'bg-white text-teal-600 shadow-sm':''" class="px-6 py-2 rounded-lg font-bold transition-all"><i class="fas fa-box-open mr-2"></i>Ğ’Ğ¸Ñ‚Ñ€Ğ°Ñ‚Ğ½Ñ– Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸</button>
      
      <button @click="activeTab='units'" :class="activeTab==='units'?'bg-white text-blue-600 shadow-sm':''" class="px-6 py-2 rounded-lg font-bold transition-all">ĞĞ´Ğ¸Ğ½Ğ¸Ñ†Ñ–</button>
      <button @click="activeTab='categories'" :class="activeTab==='categories'?'bg-white text-blue-600 shadow-sm':''" class="px-6 py-2 rounded-lg font-bold transition-all">ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ—</button>
    </div>

    <component :is="tabs[activeTab]" />
    
  </div>
</template>

--------------------------------------------------
PATH: ./.history/frontend/src/components/warehouse/Warehouse_20260123213738.vue
--------------------------------------------------
<script setup>
import { ref, onMounted, defineAsyncComponent } from 'vue'
import { useWarehouse } from '@/composables/useWarehouse'

// --- ĞĞĞ’Ğ˜Ğ™ Ğ†ĞœĞŸĞĞ Ğ¢ ---
const StockTab = defineAsyncComponent(() => import('./tabs/StockTab.vue'))

const ProductsTab = defineAsyncComponent(() => import('./tabs/ProductsTab.vue'))
const IngredientsTab = defineAsyncComponent(() => import('./tabs/IngredientsTab.vue'))
const RecipesTab = defineAsyncComponent(() => import('./tabs/RecipesTab.vue'))
const ProcessesTab = defineAsyncComponent(() => import('./tabs/ProcessesTab.vue'))
const ConsumablesTab = defineAsyncComponent(() => import('./tabs/ConsumablesTab.vue'))
const UnitsTab = defineAsyncComponent(() => import('./tabs/UnitsTab.vue'))
const CategoriesTab = defineAsyncComponent(() => import('./tabs/CategoriesTab.vue'))

// Ğ—Ğ¼Ñ–Ğ½Ğ¸Ğ¼Ğ¾ Ğ´ĞµÑ„Ğ¾Ğ»Ñ‚Ğ½Ñƒ Ğ²ĞºĞ»Ğ°Ğ´ĞºÑƒ Ğ½Ğ° 'stock'
const activeTab = ref('stock')
const { fetchData, loading } = useWarehouse()

// --- Ğ”ĞĞ”ĞĞ„ĞœĞ Ğ’ ĞĞ‘'Ğ„ĞšĞ¢ ---
const tabs = {
    stock: StockTab, // <-- ĞĞ¾Ğ²Ğ° Ğ²ĞºĞ»Ğ°Ğ´ĞºĞ°
    products: ProductsTab,
    recipes: RecipesTab,
    ingredients: IngredientsTab,
    processes: ProcessesTab,
    consumables: ConsumablesTab,
    units: UnitsTab,
    categories: CategoriesTab
}

onMounted(() => {
    fetchData()
})
</script>

<template>
  <div class="p-8 h-screen overflow-y-auto bg-gray-50 ml-64 custom-scrollbar">
    <div class="flex justify-between items-center mb-8">
      <h2 class="text-3xl font-bold text-gray-800">ğŸ“¦ Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»Ñ–Ğ½Ğ½Ñ ÑĞºĞ»Ğ°Ğ´Ğ¾Ğ¼</h2>
      <button @click="fetchData" class="text-blue-600 hover:bg-blue-50 p-2 rounded-full">
        <i class="fas fa-sync-alt" :class="{'fa-spin': loading}"></i>
      </button>
    </div>

    <div class="flex space-x-1 bg-gray-200 p-1 rounded-xl w-fit mb-8 overflow-x-auto">
      <button @click="activeTab='stock'" :class="activeTab==='stock'?'bg-white text-green-600 shadow-sm':''" class="px-6 py-2 rounded-lg font-bold transition-all"><i class="fas fa-clipboard-check mr-2"></i>Ğ—Ğ°Ğ»Ğ¸ÑˆĞºĞ¸</button>
      
      <button @click="activeTab='recipes'" :class="activeTab==='recipes'?'bg-white text-orange-600 shadow-sm':''" class="px-6 py-2 rounded-lg font-bold transition-all"><i class="fas fa-book-open mr-2"></i>Ğ ĞµÑ†ĞµĞ¿Ñ‚Ğ¸</button>
      <button @click="activeTab='products'" :class="activeTab==='products'?'bg-white text-purple-600 shadow-sm':''" class="px-6 py-2 rounded-lg font-bold transition-all">Ğ¢Ğ¾Ğ²Ğ°Ñ€Ğ¸</button>
      <button @click="activeTab='processes'" :class="activeTab==='processes'?'bg-white text-indigo-600 shadow-sm':''" class="px-6 py-2 rounded-lg font-bold transition-all"><i class="fas fa-tasks mr-2"></i>ĞŸÑ€Ğ¾Ñ†ĞµÑĞ¸</button>
      
      <button @click="activeTab='ingredients'" :class="activeTab==='ingredients'?'bg-white text-blue-600 shadow-sm':''" class="px-6 py-2 rounded-lg font-bold transition-all">Ğ†Ğ½Ğ³Ñ€Ñ–Ğ´Ñ–Ñ”Ğ½Ñ‚Ğ¸</button>
      <button @click="activeTab='consumables'" :class="activeTab==='consumables'?'bg-white text-teal-600 shadow-sm':''" class="px-6 py-2 rounded-lg font-bold transition-all"><i class="fas fa-box-open mr-2"></i>Ğ’Ğ¸Ñ‚Ñ€Ğ°Ñ‚Ğ½Ñ– Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸</button>
      
      <button @click="activeTab='units'" :class="activeTab==='units'?'bg-white text-blue-600 shadow-sm':''" class="px-6 py-2 rounded-lg font-bold transition-all">ĞĞ´Ğ¸Ğ½Ğ¸Ñ†Ñ–</button>
      <button @click="activeTab='categories'" :class="activeTab==='categories'?'bg-white text-blue-600 shadow-sm':''" class="px-6 py-2 rounded-lg font-bold transition-all">ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ—</button>
    </div>

    <component :is="tabs[activeTab]" />
    
  </div>
</template>

--------------------------------------------------
PATH: ./.history/frontend/src/components/warehouse/tabs/CategoriesTab_20260123213624.vue
--------------------------------------------------
<script setup>
import { ref } from 'vue'
import { useWarehouse } from '@/composables/useWarehouse'

// Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ Ğ¼ĞµÑ‚Ğ¾Ğ´Ğ¸ Ğ· Ğ½Ğ°ÑˆĞ¾Ğ³Ğ¾ composable
const { categories, createItem, updateItem, deleteItem } = useWarehouse()

// Ğ¡Ñ‚Ğ°Ğ½ Ñ„Ğ¾Ñ€Ğ¼Ğ¸
const newCategory = ref({ name: '', slug: '', color: '#3b82f6', parent_id: '' }) 
const isEditing = ref(false)
const editingId = ref(null)

// Ğ”Ğ¾Ğ¿Ğ¾Ğ¼Ñ–Ğ¶Ğ½Ğ° Ñ„ÑƒĞ½ĞºÑ†Ñ–Ñ Ğ´Ğ»Ñ Ğ²Ñ–Ğ´Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ±Ğ°Ñ‚ÑŒĞºĞ°
const getParentName = (parentId) => {
    if (!parentId) return '';
    const parent = categories.value.find(c => c.id === parentId);
    return parent ? parent.name : '???';
}

// Ğ—Ğ°Ğ¿Ğ¾Ğ²Ğ½ĞµĞ½Ğ½Ñ Ñ„Ğ¾Ñ€Ğ¼Ğ¸ Ğ´Ğ»Ñ Ñ€ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ
const prepareEdit = (category) => {
    isEditing.value = true
    editingId.value = category.id
    newCategory.value = {
        name: category.name,
        slug: category.slug,
        color: category.color || '#3b82f6',
        parent_id: category.parent_id || ''
    }
}

// Ğ¡ĞºĞ¸Ğ´Ğ°Ğ½Ğ½Ñ Ñ„Ğ¾Ñ€Ğ¼Ğ¸
const resetForm = () => {
    isEditing.value = false
    editingId.value = null
    newCategory.value = { name: '', slug: '', color: '#3b82f6', parent_id: '' }
}

// ĞĞ±Ñ€Ğ¾Ğ±ĞºĞ° Ğ·Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ½Ñ (Ğ¡Ñ‚Ğ²Ğ¾Ñ€Ğ¸Ñ‚Ğ¸ ĞĞ‘Ğ ĞĞ½Ğ¾Ğ²Ğ¸Ñ‚Ğ¸)
const handleSave = async () => {
    if (!newCategory.value.name) return alert("Ğ’ĞºĞ°Ğ¶Ñ–Ñ‚ÑŒ Ğ½Ğ°Ğ·Ğ²Ñƒ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ—!")
    
    const payload = { ...newCategory.value }
    
    // ĞĞ²Ñ‚Ğ¾Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ñ–Ñ slug, ÑĞºÑ‰Ğ¾ Ğ¿ÑƒÑÑ‚Ğ¾
    if (!payload.slug) {
        payload.slug = payload.name.toLowerCase().replace(/\s+/g, '-') + '-' + Date.now().toString().slice(-4)
    }
    // ĞÑ‡Ğ¸Ñ‰ĞµĞ½Ğ½Ñ parent_id
    if (payload.parent_id === "") payload.parent_id = null
    
    let success = false

    if (isEditing.value) {
        // ĞĞĞĞ’Ğ›Ğ•ĞĞĞ¯ (PUT)
        success = await updateItem(`/api/categories/${editingId.value}`, payload)
    } else {
        // Ğ¡Ğ¢Ğ’ĞĞ Ğ•ĞĞĞ¯ (POST)
        success = await createItem('/api/categories/', payload)
    }

    if(success) {
        resetForm()
    }
}

// ĞĞ±Ñ€Ğ¾Ğ±ĞºĞ° Ğ²Ğ¸Ğ´Ğ°Ğ»ĞµĞ½Ğ½Ñ
const handleDelete = async (id) => {
    await deleteItem(`/api/categories/${id}`)
    // Ğ¯ĞºÑ‰Ğ¾ Ğ¼Ğ¸ Ñ€ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ»Ğ¸ ÑĞ°Ğ¼Ğµ Ñ†Ñ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ - ÑĞºĞ¸Ğ´Ğ°Ñ”Ğ¼Ğ¾ Ñ„Ğ¾Ñ€Ğ¼Ñƒ
    if (editingId.value === id) {
        resetForm()
    }
}
</script>

<template>
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 h-fit">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-gray-700">
                    {{ isEditing ? 'âœï¸ Ğ ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ—' : 'ğŸ“‚ ĞĞ¾Ğ²Ğ° ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ' }}
                </h3>
                <button v-if="isEditing" @click="resetForm" class="text-xs text-red-500 hover:underline">Ğ¡ĞºĞ°ÑÑƒĞ²Ğ°Ñ‚Ğ¸</button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞĞ°Ğ·Ğ²Ğ°</label>
                    <input v-model="newCategory.name" class="border p-2 rounded w-full focus:ring-2 ring-blue-100 outline-none" placeholder="ĞĞ°Ğ¿Ñ€. ĞšĞ°Ğ²Ğ°">
                </div>
                
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞšĞ¾Ğ´ (Slug)</label>
                    <input v-model="newCategory.slug" class="border p-2 rounded w-full font-mono text-sm text-gray-600" placeholder="auto-generated">
                </div>
                
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞšĞ¾Ğ»Ñ–Ñ€</label>
                    <div class="flex items-center gap-2">
                        <input v-model="newCategory.color" type="color" class="h-10 w-16 border rounded cursor-pointer p-1 bg-white">
                        <span class="text-sm text-gray-600 font-mono">{{ newCategory.color }}</span>
                    </div>
                </div>
                
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ğ‘Ğ°Ñ‚ÑŒĞºÑ–Ğ²ÑÑŒĞºĞ° ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ</label>
                    <select v-model="newCategory.parent_id" class="border p-2 rounded w-full bg-white">
                        <option value="">(ĞĞµĞ¼Ğ°Ñ” - ĞšĞ¾Ñ€ĞµĞ½ĞµĞ²Ğ°)</option>
                        <option v-for="c in categories" :key="c.id" :value="c.id" :disabled="c.id === editingId">
                            {{ c.name }}
                        </option>
                    </select>
                </div>
                
                <button @click="handleSave" 
                    class="w-full py-3 rounded-xl font-bold text-white shadow-lg transition transform active:scale-95"
                    :class="isEditing ? 'bg-orange-500 hover:bg-orange-600 shadow-orange-200' : 'bg-blue-600 hover:bg-blue-700 shadow-blue-200'">
                    {{ isEditing ? 'Ğ—Ğ±ĞµÑ€ĞµĞ³Ñ‚Ğ¸ Ğ·Ğ¼Ñ–Ğ½Ğ¸' : 'Ğ¡Ñ‚Ğ²Ğ¾Ñ€Ğ¸Ñ‚Ğ¸ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ' }}
                </button>
            </div>
        </div>

        <div class="lg:col-span-2 bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="bg-gray-50 text-gray-500 uppercase text-xs">
                        <tr>
                            <th class="p-4">ĞšĞ¾Ğ»Ñ–Ñ€</th>
                            <th class="p-4">ĞĞ°Ğ·Ğ²Ğ°</th>
                            <th class="p-4">ĞšĞ¾Ğ´</th>
                            <th class="p-4">Ğ‘Ğ°Ñ‚ÑŒĞºĞ¾</th>
                            <th class="p-4 text-center">Ğ”Ñ–Ñ—</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        <tr v-if="categories.length === 0">
                            <td colspan="5" class="p-8 text-center text-gray-400">ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ğ¹ Ñ‰Ğµ Ğ½ĞµĞ¼Ğ°Ñ”</td>
                        </tr>
                        <tr v-for="c in categories" :key="c.id" class="hover:bg-gray-50 group">
                            <td class="p-4">
                                <div class="w-8 h-8 rounded-lg shadow-sm border border-gray-200" :style="{ backgroundColor: c.color || '#fff' }"></div>
                            </td>
                            <td class="p-4 font-bold text-gray-800 text-lg">{{ c.name }}</td>
                            <td class="p-4 font-mono text-gray-500">{{ c.slug }}</td>
                            <td class="p-4">
                                <span v-if="c.parent_id" class="bg-blue-50 text-blue-600 px-2 py-1 rounded text-xs font-bold">
                                    {{ getParentName(c.parent_id) }}
                                </span>
                                <span v-else class="text-gray-300 text-xs">-</span>
                            </td>
                            <td class="p-4 text-center">
                                <div class="flex justify-center gap-2">
                                    <button @click="prepareEdit(c)" class="p-2 text-blue-400 hover:text-blue-600 hover:bg-blue-50 rounded transition" title="Ğ ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ñ‚Ğ¸">
                                        <i class="fas fa-pen"></i>
                                    </button>
                                    <button @click="handleDelete(c.id)" class="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded transition" title="Ğ’Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğ¸">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</template>

--------------------------------------------------
PATH: ./.history/frontend/src/components/warehouse/tabs/ProductsTab_20260123144603.vue
--------------------------------------------------
<script setup>
import { ref, onMounted } from 'vue'
import { useWarehouse } from '@/composables/useWarehouse'
import { useProducts } from '@/composables/useProducts'

// ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ğ´Ğ°Ğ½Ñ– Ğ·Ñ– ÑĞºĞ»Ğ°Ğ´Ñƒ (ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ—, Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ğ¸, Ñ–Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ğ¸ Ğ´Ğ»Ñ ÑĞ¿Ğ¸ÑĞºÑ–Ğ²)
const { categories, recipes, ingredients, consumables } = useWarehouse()

// ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ğ»Ğ¾Ğ³Ñ–ĞºÑƒ Ñ€Ğ¾Ğ±Ğ¾Ñ‚Ğ¸ Ğ· Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°Ğ¼Ğ¸
const { 
    newProduct, isEditing, editingId, 
    variantBuilder, tempProductConsumable, tempVariantConsumable, tempVariantIngredient,
    resetForm, prepareEdit, saveProduct, deleteProduct,
    addVariant, removeVariant, 
    addProductConsumable, removeProductConsumable,
    addVariantConsumable, removeVariantConsumable,
    addIngredientToVariant, removeIngredientFromVariant,
    fetchProducts // Ğ¤ÑƒĞ½ĞºÑ†Ñ–Ñ Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ ÑĞ¿Ğ¸ÑĞºÑƒ
} = useProducts()

const showForm = ref(false)

// Ğ¥ĞµĞ»Ğ¿ĞµÑ€ Ğ´Ğ»Ñ ĞºÑ€Ğ°ÑĞ¸Ğ²Ğ¾Ñ— Ğ½Ğ°Ğ·Ğ²Ğ¸ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ—
const getCategoryName = (id) => {
    const c = categories.value.find(x => x.id === id)
    return c ? c.name : '-'
}

// ĞĞ±Ñ€Ğ¾Ğ±ĞºĞ° Ğ·Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ½Ñ
const handleSave = async () => {
    const success = await saveProduct()
    if(success) showForm.value = false
}

// ĞĞ±Ñ€Ğ¾Ğ±ĞºĞ° Ñ€ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ
const handleEdit = (product) => {
    prepareEdit(product)
    showForm.value = true
}

// Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ¿Ñ€Ğ¸ ÑÑ‚Ğ°Ñ€Ñ‚Ñ–
onMounted(async () => {
    await fetchProducts()
})
</script>

<template>
    <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
        
        <div v-if="showForm" class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 h-fit xl:col-span-1">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-gray-700">
                    {{ isEditing ? 'âœï¸ Ğ ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ' : 'ğŸ“¦ ĞĞ¾Ğ²Ğ¸Ğ¹ Ñ‚Ğ¾Ğ²Ğ°Ñ€' }}
                </h3>
                <button @click="showForm = false; resetForm()" class="text-xs text-red-500 hover:underline">Ğ—Ğ°ĞºÑ€Ğ¸Ñ‚Ğ¸</button>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞĞ°Ğ·Ğ²Ğ°</label>
                    <input v-model="newProduct.name" class="border p-2 rounded w-full focus:ring-2 ring-blue-100 outline-none">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ</label>
                        <select v-model="newProduct.category_id" class="border p-2 rounded w-full bg-white">
                            <option :value="null">-- Ğ‘ĞµĞ· ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ— --</option>
                            <option v-for="c in categories" :key="c.id" :value="c.id">{{ c.name }}</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ğ¦Ñ–Ğ½Ğ° (Ğ±Ğ°Ğ·Ğ¾Ğ²Ğ°)</label>
                        <input v-model.number="newProduct.price" type="number" class="border p-2 rounded w-full">
                    </div>
                </div>

                <div class="flex items-center gap-2 py-2">
                    <input type="checkbox" v-model="newProduct.has_variants" id="hasVar" class="w-4 h-4 text-blue-600">
                    <label for="hasVar" class="text-sm font-bold text-gray-700 select-none">Ğ¦ĞµĞ¹ Ñ‚Ğ¾Ğ²Ğ°Ñ€ Ğ¼Ğ°Ñ” Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸ (Ñ€Ğ¾Ğ·Ğ¼Ñ–Ñ€Ğ¸)</label>
                </div>

                <div v-if="!newProduct.has_variants" class="bg-gray-50 p-3 rounded border border-gray-200 space-y-3">
                     <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞœĞ°Ğ¹ÑÑ‚ĞµÑ€-Ñ€ĞµÑ†ĞµĞ¿Ñ‚</label>
                        <select v-model="newProduct.master_recipe_id" class="border p-2 rounded w-full bg-white text-sm">
                            <option :value="null">-- Ğ‘ĞµĞ· Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ñƒ --</option>
                            <option v-for="r in recipes" :key="r.id" :value="r.id">{{ r.name }}</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ğ’Ğ¸Ñ…Ñ–Ğ´Ğ½Ğ° Ğ²Ğ°Ğ³Ğ° (Ğ³/Ğ¼Ğ»)</label>
                        <input v-model.number="newProduct.output_weight" type="number" class="border p-2 rounded w-full text-sm">
                    </div>
                </div>

                <div class="bg-teal-50/50 p-3 rounded border border-teal-100">
                    <label class="text-[10px] uppercase font-bold text-teal-600 mb-2 block">Ğ—Ğ°Ğ³Ğ°Ğ»ÑŒĞ½Ñ– Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸</label>
                    <div class="flex gap-2 mb-2">
                        <select v-model="tempProductConsumable.consumable_id" class="flex-1 border p-1 rounded text-sm bg-white">
                            <option value="">ĞĞ±ĞµÑ€Ñ–Ñ‚ÑŒ Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»...</option>
                            <option v-for="c in consumables" :key="c.id" :value="c.id">{{ c.name }}</option>
                        </select>
                        <input v-model.number="tempProductConsumable.quantity" type="number" class="w-16 border p-1 rounded text-sm" placeholder="Ğš-ÑÑ‚ÑŒ">
                        <button @click="addProductConsumable" class="bg-teal-500 text-white w-8 rounded hover:bg-teal-600">+</button>
                    </div>
                    <div class="flex flex-wrap gap-1">
                        <span v-for="(pc, idx) in newProduct.consumables" :key="idx" class="bg-white border border-teal-200 text-teal-700 text-xs px-2 py-1 rounded flex items-center gap-1">
                            {{ pc.name }}: {{ pc.quantity }}
                            <button @click="removeProductConsumable(idx)" class="text-red-400 font-bold ml-1 hover:text-red-600">&times;</button>
                        </span>
                    </div>
                </div>

                <div v-if="newProduct.has_variants" class="space-y-3">
                    <div class="border-t pt-2 mt-2">
                        <h4 class="font-bold text-sm text-purple-700 mb-2">Ğ”Ğ¾Ğ´Ğ°Ñ‚Ğ¸ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚</h4>
                        
                        <div class="bg-purple-50 p-3 rounded-lg border border-purple-100 space-y-3">
                            <div class="grid grid-cols-2 gap-2">
                                <input v-model="variantBuilder.name" placeholder="ĞĞ°Ğ·Ğ²Ğ° (Ğ½Ğ°Ğ¿Ñ€. Ğ’ĞµĞ»Ğ¸ĞºĞ¸Ğ¹)" class="border p-1.5 rounded text-sm">
                                <input v-model.number="variantBuilder.price" type="number" placeholder="Ğ¦Ñ–Ğ½Ğ°" class="border p-1.5 rounded text-sm">
                            </div>
                            
                            <div class="grid grid-cols-2 gap-2">
                                <select v-model="variantBuilder.master_recipe_id" class="border p-1.5 rounded text-sm bg-white">
                                    <option :value="null">Ğ ĞµÑ†ĞµĞ¿Ñ‚...</option>
                                    <option v-for="r in recipes" :key="r.id" :value="r.id">{{ r.name }}</option>
                                </select>
                                <input v-model.number="variantBuilder.output_weight" type="number" placeholder="Ğ’Ğ°Ğ³Ğ° Ğ¿Ğ¾Ñ€Ñ†Ñ–Ñ—" class="border p-1.5 rounded text-sm">
                            </div>

                            <div class="bg-white/50 p-2 rounded border border-dashed border-purple-200">
                                <label class="text-[10px] uppercase font-bold text-purple-400">ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ</label>
                                <div class="flex gap-1 mb-1">
                                    <select v-model="tempVariantConsumable.consumable_id" class="flex-1 border p-1 rounded text-[10px] bg-white h-7">
                                        <option value="">ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»...</option>
                                        <option v-for="c in consumables" :key="c.id" :value="c.id">{{ c.name }}</option>
                                    </select>
                                    <input v-model.number="tempVariantConsumable.quantity" type="number" class="w-10 border p-1 rounded text-[10px] h-7" placeholder="Ğš-ÑÑ‚ÑŒ">
                                    <button @click="addVariantConsumable" class="bg-purple-500 text-white w-7 h-7 rounded hover:bg-purple-600 text-xs">+</button>
                                </div>
                                <div class="flex flex-wrap gap-1">
                                    <span v-for="(vc, idx) in variantBuilder.consumables" :key="idx" class="bg-white border text-[10px] px-1 rounded flex items-center gap-1">
                                        {{ vc.name }}: {{ vc.quantity }} <button @click="removeVariantConsumable(idx)" class="text-red-500 font-bold">&times;</button>
                                    </span>
                                </div>
                            </div>

                            <div class="bg-blue-50/50 p-2 rounded border border-dashed border-blue-200">
                                <label class="text-[10px] uppercase font-bold text-blue-500">Ğ”Ğ¾Ğ´Ğ°Ñ‚ĞºĞ¾Ğ²Ñ– Ñ–Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ğ¸</label>
                                <div class="flex gap-1 mb-1">
                                    <select v-model="tempVariantIngredient.ingredient_id" class="flex-1 border p-1 rounded text-[10px] bg-white h-7">
                                        <option value="">Ğ†Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚...</option>
                                        <option v-for="i in ingredients" :key="i.id" :value="i.id">{{ i.name }}</option>
                                    </select>
                                    <input v-model.number="tempVariantIngredient.quantity" type="number" class="w-10 border p-1 rounded text-[10px] h-7" placeholder="Ğ“Ñ€Ğ°Ğ¼">
                                    <button @click="addIngredientToVariant" class="bg-blue-500 text-white w-7 h-7 rounded hover:bg-blue-600 text-xs">+</button>
                                </div>
                                <div class="flex flex-wrap gap-1">
                                    <span v-for="(vi, idx) in variantBuilder.ingredients" :key="idx" class="bg-white border text-[10px] px-1 rounded flex items-center gap-1 text-blue-700">
                                        {{ vi.name }}: {{ vi.quantity }} <button @click="removeIngredientFromVariant(idx)" class="text-red-500 font-bold">&times;</button>
                                    </span>
                                </div>
                            </div>

                            <button @click="addVariant" class="w-full bg-purple-200 text-purple-800 text-xs font-bold py-2 rounded hover:bg-purple-300">
                                Ğ”Ğ¾Ğ´Ğ°Ñ‚Ğ¸ Ñ†ĞµĞ¹ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚ Ñƒ ÑĞ¿Ğ¸ÑĞ¾Ğº
                            </button>
                        </div>
                    </div>

                    <div v-if="newProduct.variants.length > 0" class="space-y-2">
                        <div v-for="(v, idx) in newProduct.variants" :key="idx" class="bg-white border p-2 rounded flex justify-between items-center text-sm">
                            <div>
                                <span class="font-bold">{{ v.name }}</span> - {{ v.price }} Ğ³Ñ€Ğ½
                                <div class="text-xs text-gray-400">
                                    <span v-if="v.consumables.length">ĞœĞ°Ñ‚: {{ v.consumables.length }}</span>
                                    <span v-if="v.ingredients.length" class="ml-2 text-blue-600">Ğ†Ğ½Ğ³: {{ v.ingredients.length }}</span>
                                </div>
                            </div>
                            <button @click="removeVariant(idx)" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                </div>

                <button @click="handleSave" class="w-full bg-green-600 text-white font-bold py-3 rounded-xl hover:bg-green-700 shadow-lg shadow-green-100 mt-4">
                    {{ isEditing ? 'Ğ—Ğ±ĞµÑ€ĞµĞ³Ñ‚Ğ¸ Ğ·Ğ¼Ñ–Ğ½Ğ¸' : 'Ğ¡Ñ‚Ğ²Ğ¾Ñ€Ğ¸Ñ‚Ğ¸ Ñ‚Ğ¾Ğ²Ğ°Ñ€' }}
                </button>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden flex flex-col h-full" :class="showForm ? 'xl:col-span-2' : 'xl:col-span-3'">
            
            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
                <h2 class="font-bold text-gray-700">Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ–Ğ²</h2>
                <button v-if="!showForm" @click="showForm = true; resetForm()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-bold text-sm shadow-lg shadow-blue-100">
                    + ĞĞ¾Ğ²Ğ¸Ğ¹ Ñ‚Ğ¾Ğ²Ğ°Ñ€
                </button>
            </div>

            <div class="overflow-auto flex-1">
                <table class="w-full text-left text-sm">
                    <thead class="bg-gray-50 text-gray-500 uppercase text-xs sticky top-0">
                        <tr>
                            <th class="p-4">ĞĞ°Ğ·Ğ²Ğ°</th>
                            <th class="p-4">ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ</th>
                            <th class="p-4">Ğ¦Ñ–Ğ½Ğ° / Ğ’Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸</th>
                            <th class="p-4">Ğ ĞµÑ†ĞµĞ¿Ñ‚ / Ğ¡ĞºĞ»Ğ°Ğ´</th>
                            <th class="p-4 text-center">Ğ”Ñ–Ñ—</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        <tr v-if="!useWarehouse().products.value.length">
                            <td colspan="5" class="p-8 text-center text-gray-400">Ğ¢Ğ¾Ğ²Ğ°Ñ€Ñ–Ğ² Ñ‰Ğµ Ğ½ĞµĞ¼Ğ°Ñ” (Ğ°Ğ±Ğ¾ Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ...)</td>
                        </tr>
                        <tr v-for="p in useWarehouse().products.value" :key="p.id" class="hover:bg-gray-50 group align-top">
                            <td class="p-4 font-bold text-gray-800">{{ p.name }}</td>
                            <td class="p-4 text-gray-600">
                                <span class="bg-gray-100 px-2 py-1 rounded text-xs">{{ getCategoryName(p.category_id) }}</span>
                            </td>
                            
                            <td class="p-4">
                                <div v-if="!p.has_variants" class="font-mono font-bold text-lg text-green-600">
                                    {{ p.price }} â‚´
                                </div>
                                <div v-else class="space-y-1">
                                    <div v-for="v in p.variants" :key="v.id" class="text-xs bg-gray-50 p-1.5 rounded border border-gray-200">
                                        <div class="flex justify-between font-bold text-gray-700 mb-1">
                                            <span>{{ v.name }}</span>
                                            <span>{{ v.price }} â‚´</span>
                                        </div>
                                        
                                        <div v-if="v.consumables && v.consumables.length > 0" class="flex flex-wrap gap-1 mb-1">
                                            <span v-for="c in v.consumables" :key="c.consumable_id" class="bg-teal-50 text-teal-700 px-1 rounded border border-teal-100 text-[10px]">
                                                ğŸ“¦ {{ c.consumable_name || 'ĞœĞ°Ñ‚' }}: {{ c.quantity }}
                                            </span>
                                        </div>

                                        <div v-if="v.ingredients && v.ingredients.length > 0" class="flex flex-wrap gap-1">
                                            <span v-for="i in v.ingredients" :key="i.ingredient_id" class="bg-blue-50 text-blue-700 px-1 rounded border border-blue-100 text-[10px]">
                                                ğŸ’§ {{ i.ingredient_name || 'Ğ†Ğ½Ğ³Ñ€' }}: {{ i.quantity }}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </td>

                            <td class="p-4 text-xs">
                                <div v-if="p.master_recipe" class="text-purple-600 font-bold mb-1">
                                    ğŸ“œ {{ p.master_recipe.name }}
                                </div>
                                <div v-if="p.consumables && p.consumables.length > 0" class="flex flex-wrap gap-1">
                                    <span v-for="c in p.consumables" :key="c.consumable_id" class="bg-orange-50 text-orange-700 px-1 rounded border border-orange-100 text-[10px]">
                                        + {{ c.consumable_name }}: {{ c.quantity }}
                                    </span>
                                </div>
                            </td>

                            <td class="p-4 text-center">
                                <div class="flex justify-center gap-2">
                                    <button @click="handleEdit(p)" class="text-blue-400 hover:text-blue-600 p-2 rounded hover:bg-blue-50"><i class="fas fa-pen"></i></button>
                                    <button @click="deleteProduct(p.id)" class="text-gray-300 hover:text-red-500 p-2 rounded hover:bg-red-50"><i class="fas fa-trash"></i></button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</template>

--------------------------------------------------
PATH: ./.history/frontend/src/components/warehouse/tabs/ProductsTab_20260125144754.vue
--------------------------------------------------
<script setup>
import { ref, onMounted, computed } from 'vue' // <--- Ğ”Ğ¾Ğ´Ğ°Ğ² computed
import { useWarehouse } from '@/composables/useWarehouse'
import { useProducts } from '@/composables/useProducts'

// ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ğ´Ğ¾Ğ²Ñ–Ğ´Ğ½Ğ¸ĞºĞ¸ (ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ—, Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ğ¸ Ñ‚Ğ¾Ñ‰Ğ¾)
const { categories, recipes, ingredients, consumables } = useWarehouse()

// ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ñ„ÑƒĞ½ĞºÑ†Ñ–Ğ¾Ğ½Ğ°Ğ» Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ–Ğ²
const { 
    newProduct, isEditing, 
    variantBuilder, tempProductConsumable, tempVariantConsumable, tempVariantIngredient,
    resetForm, prepareEdit, saveProduct, deleteProduct, fetchProducts, filteredProducts, productSearch,
    
    saveVariant, editVariant, cancelVariantEdit, editingVariantIndex, removeVariant, 
    
    addProductConsumable, removeProductConsumable,
    addVariantConsumable, removeVariantConsumable,
    addIngredientToVariant, removeIngredientFromVariant
} = useProducts()

const showForm = ref(false)

const getCategoryName = (id) => {
    if (!categories.value) return '-'
    const c = categories.value.find(x => x.id === id)
    return c ? c.name : '-'
}

// --- ĞĞĞ’Ğ Ğ›ĞĞ“Ğ†ĞšĞ Ğ”Ğ›Ğ¯ ĞĞ”Ğ˜ĞĞ˜Ğ¦Ğ¬ Ğ’Ğ˜ĞœĞ†Ğ Ğ£ ---
const getIngredientUnit = (id) => {
    if (!id || !ingredients.value) return ''
    const ing = ingredients.value.find(i => i.id === id)
    return ing?.unit?.symbol || ''
}

const currentIngredientPlaceholder = computed(() => {
    const unit = getIngredientUnit(tempVariantIngredient.value.ingredient_id)
    return unit ? `Ğš-ÑÑ‚ÑŒ (${unit})` : 'Ğš-ÑÑ‚ÑŒ'
})
// --------------------------------------

const handleSave = async () => {
    const success = await saveProduct()
    if(success) {
        showForm.value = false
        await fetchProducts()
    }
}

const handleEdit = (product) => {
    prepareEdit(product)
    showForm.value = true
}

onMounted(async () => {
    console.log("ProductsTab mounted: fetching data...")
    await fetchProducts()
})
</script>

<template>
    <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
        
        <div v-if="showForm" class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 h-fit xl:col-span-1">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-gray-700">
                    {{ isEditing ? 'âœï¸ Ğ ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ' : 'ğŸ“¦ ĞĞ¾Ğ²Ğ¸Ğ¹ Ñ‚Ğ¾Ğ²Ğ°Ñ€' }}
                </h3>
                <button @click="showForm = false; resetForm()" class="text-xs text-red-500 hover:underline">Ğ—Ğ°ĞºÑ€Ğ¸Ñ‚Ğ¸</button>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞĞ°Ğ·Ğ²Ğ°</label>
                    <input v-model="newProduct.name" class="border p-2 rounded w-full focus:ring-2 ring-blue-100 outline-none">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ</label>
                        <select v-model="newProduct.category_id" class="border p-2 rounded w-full bg-white">
                            <option :value="null">-- Ğ‘ĞµĞ· ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ— --</option>
                            <option v-for="c in categories" :key="c.id" :value="c.id">{{ c.name }}</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ğ¦Ñ–Ğ½Ğ° (Ğ±Ğ°Ğ·Ğ¾Ğ²Ğ°)</label>
                        <input v-model.number="newProduct.price" type="number" class="border p-2 rounded w-full">
                    </div>
                </div>

                <div class="flex items-center gap-2 py-2">
                    <input type="checkbox" v-model="newProduct.has_variants" id="hasVar" class="w-4 h-4 text-blue-600">
                    <label for="hasVar" class="text-sm font-bold text-gray-700 select-none">Ğ¦ĞµĞ¹ Ñ‚Ğ¾Ğ²Ğ°Ñ€ Ğ¼Ğ°Ñ” Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸</label>
                </div>

                <div v-if="!newProduct.has_variants" class="bg-gray-50 p-3 rounded border border-gray-200 space-y-3">
                     <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞœĞ°Ğ¹ÑÑ‚ĞµÑ€-Ñ€ĞµÑ†ĞµĞ¿Ñ‚</label>
                        <select v-model="newProduct.master_recipe_id" class="border p-2 rounded w-full bg-white text-sm">
                            <option :value="null">-- Ğ‘ĞµĞ· Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ñƒ --</option>
                            <option v-for="r in recipes" :key="r.id" :value="r.id">{{ r.name }}</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ğ’Ğ¸Ñ…Ñ–Ğ´Ğ½Ğ° Ğ²Ğ°Ğ³Ğ° (Ğ³/Ğ¼Ğ»)</label>
                        <input v-model.number="newProduct.output_weight" type="number" class="border p-2 rounded w-full text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞŸĞ¾Ñ‡Ğ°Ñ‚ĞºĞ¾Ğ²Ğ¸Ğ¹ Ğ·Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº</label>
                        <input v-model.number="newProduct.stock_quantity" type="number" class="border p-2 rounded w-full text-sm" placeholder="0">
                    </div>
                </div>

                <div class="bg-teal-50/50 p-3 rounded border border-teal-100">
                    <label class="text-[10px] uppercase font-bold text-teal-600 mb-2 block">Ğ—Ğ°Ğ³Ğ°Ğ»ÑŒĞ½Ñ– Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸</label>
                    <div class="flex gap-2 mb-2">
                        <select v-model="tempProductConsumable.consumable_id" class="flex-1 border p-1 rounded text-sm bg-white">
                            <option value="">ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»...</option>
                            <option v-for="c in consumables" :key="c.id" :value="c.id">{{ c.name }}</option>
                        </select>
                        <button @click="addProductConsumable" class="bg-teal-500 text-white w-8 rounded hover:bg-teal-600">+</button>
                    </div>
                    <div class="flex flex-wrap gap-1">
                        <span v-for="(pc, idx) in newProduct.consumables" :key="idx" class="bg-white border border-teal-200 text-teal-700 text-xs px-2 py-1 rounded flex items-center gap-1">
                            {{ pc.name }} <button @click="removeProductConsumable(idx)" class="text-red-500 font-bold ml-1">&times;</button>
                        </span>
                    </div>
                </div>

                <div v-if="newProduct.has_variants" class="space-y-3">
                    <div class="border-t pt-2 mt-2">
                        <div class="flex justify-between items-center mb-2">
                             <h4 class="font-bold text-sm text-purple-700">
                                 {{ editingVariantIndex !== null ? 'âœï¸ Ğ ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ' : 'ĞšĞ¾Ğ½ÑÑ‚Ñ€ÑƒĞºÑ‚Ğ¾Ñ€ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñ–Ğ²' }}
                             </h4>
                             <button v-if="editingVariantIndex !== null" @click="cancelVariantEdit" class="text-xs text-gray-500 underline">Ğ¡ĞºĞ°ÑÑƒĞ²Ğ°Ñ‚Ğ¸</button>
                        </div>
                        
                        <div class="bg-purple-50 p-3 rounded-lg border border-purple-100 space-y-3" :class="{'ring-2 ring-purple-300': editingVariantIndex !== null}">
                            
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="text-[10px] uppercase font-bold text-gray-500">ĞĞ°Ğ·Ğ²Ğ°</label>
                                    <input v-model="variantBuilder.name" placeholder="Ğ½Ğ°Ğ¿Ñ€. XL" class="w-full border p-1.5 rounded text-sm">
                                </div>
                                <div>
                                    <label class="text-[10px] uppercase font-bold text-gray-500">Ğ¦Ñ–Ğ½Ğ°</label>
                                    <input v-model.number="variantBuilder.price" type="number" class="w-full border p-1.5 rounded text-sm">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="text-[10px] uppercase font-bold text-gray-500">Ğ¢ĞµÑ…. ĞºĞ°Ñ€Ñ‚Ğ°</label>
                                    <select v-model="variantBuilder.master_recipe_id" class="w-full border p-1.5 rounded text-sm bg-white">
                                        <option :value="null">-- Ğ‘ĞµĞ· Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ñƒ --</option>
                                        <option v-for="r in recipes" :key="r.id" :value="r.id">{{ r.name }}</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-[10px] uppercase font-bold text-gray-500">Ğ’Ğ°Ğ³Ğ° Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¾Ğ³Ğ¾ (Ğ³/Ğ¼Ğ»)</label>
                                    <input v-model.number="variantBuilder.output_weight" type="number" class="w-full border p-1.5 rounded text-sm">
                                </div>
                            </div>
                            
                            <div>
                                <label class="text-[10px] uppercase font-bold text-gray-500">ĞŸĞ¾Ñ‡Ğ°Ñ‚ĞºĞ¾Ğ²Ğ¸Ğ¹ Ğ·Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº (ÑˆÑ‚)</label>
                                <input v-model.number="variantBuilder.stock_quantity" type="number" class="w-full border p-1.5 rounded text-sm bg-white" placeholder="0">
                            </div>

                            <div class="bg-white/50 p-2 rounded border border-dashed border-purple-200">
                                <label class="text-[10px] uppercase font-bold text-purple-400">ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ</label>
                                <div class="flex gap-1 mb-1">
                                    <select v-model="tempVariantConsumable.consumable_id" class="flex-1 border p-1 rounded text-[10px] bg-white h-7">
                                        <option value="">ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»...</option>
                                        <option v-for="c in consumables" :key="c.id" :value="c.id">{{ c.name }}</option>
                                    </select>
                                    <input v-model.number="tempVariantConsumable.quantity" type="number" class="w-10 border p-1 rounded text-[10px] h-7" placeholder="Ğš-ÑÑ‚ÑŒ">
                                    <button @click="addVariantConsumable" class="bg-purple-500 text-white w-7 h-7 rounded hover:bg-purple-600 text-xs">+</button>
                                </div>
                                <div class="flex flex-wrap gap-1">
                                    <span v-for="(vc, idx) in variantBuilder.consumables" :key="idx" class="bg-white border text-[10px] px-1 rounded flex items-center gap-1">
                                        {{ vc.name }}: {{ vc.quantity }} <button @click="removeVariantConsumable(idx)" class="text-red-500 font-bold">&times;</button>
                                    </span>
                                </div>
                            </div>

                            <div class="bg-blue-50/50 p-2 rounded border border-dashed border-blue-200">
                                <label class="text-[10px] uppercase font-bold text-blue-500">Ğ”Ğ¾Ğ´Ğ°Ñ‚ĞºĞ¾Ğ²Ñ– Ñ–Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ğ¸</label>
                                <div class="flex gap-1 mb-1">
                                    <select v-model="tempVariantIngredient.ingredient_id" class="flex-1 border p-1 rounded text-[10px] bg-white h-7">
                                        <option value="">Ğ†Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚...</option>
                                        <option v-for="i in ingredients" :key="i.id" :value="i.id">
                                            {{ i.name }} ({{ i.unit?.symbol }})
                                        </option>
                                    </select>
                                    <input 
                                        v-model.number="tempVariantIngredient.quantity" 
                                        type="number" 
                                        class="w-16 border p-1 rounded text-[10px] h-7" 
                                        :placeholder="currentIngredientPlaceholder"
                                    >
                                    <button @click="addIngredientToVariant" class="bg-blue-500 text-white w-7 h-7 rounded hover:bg-blue-600 text-xs">+</button>
                                </div>
                                <div class="flex flex-wrap gap-1">
                                    <span v-for="(vi, idx) in variantBuilder.ingredients" :key="idx" class="bg-white border text-[10px] px-1 rounded flex items-center gap-1 text-blue-700">
                                        {{ vi.name }}: {{ vi.quantity }} {{ getIngredientUnit(vi.ingredient_id) }}
                                        <button @click="removeIngredientFromVariant(idx)" class="text-red-500 font-bold">&times;</button>
                                    </span>
                                </div>
                            </div>

                            <button @click="saveVariant" class="w-full text-xs font-bold py-2 rounded transition-colors"
                                :class="editingVariantIndex !== null ? 'bg-orange-400 text-white hover:bg-orange-500' : 'bg-purple-200 text-purple-800 hover:bg-purple-300'">
                                {{ editingVariantIndex !== null ? 'Ğ—Ğ±ĞµÑ€ĞµĞ³Ñ‚Ğ¸ Ğ·Ğ¼Ñ–Ğ½Ğ¸ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ' : 'Ğ”Ğ¾Ğ´Ğ°Ñ‚Ğ¸ Ñ†ĞµĞ¹ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚ Ñƒ ÑĞ¿Ğ¸ÑĞ¾Ğº' }}
                            </button>
                        </div>
                    </div>
                    
                    <div v-if="newProduct.variants.length > 0" class="space-y-2">
                        <div v-for="(v, idx) in newProduct.variants" :key="idx" 
                             class="bg-white border p-2 rounded flex justify-between items-center text-sm"
                             :class="{'border-purple-400 bg-purple-50': editingVariantIndex === idx}"
                        >
                            <div>
                                <span class="font-bold">{{ v.name }}</span> - {{ v.price }} Ğ³Ñ€Ğ½
                                <div class="text-xs text-gray-400">
                                    <span v-if="v.master_recipe_id" class="text-purple-600 mr-2">ğŸ“œ Ğ ĞµÑ†ĞµĞ¿Ñ‚ ID: {{ v.master_recipe_id }}</span>
                                    <span v-if="v.stock_quantity > 0" class="text-green-600 font-bold">Ğ—Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº: {{ v.stock_quantity }}</span>
                                    <span v-if="v.ingredients?.length" class="text-blue-500 ml-2">Ğ†Ğ½Ğ³Ñ€: {{ v.ingredients.length }}</span>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button @click="editVariant(idx)" class="text-blue-500 hover:text-blue-700"><i class="fas fa-pen"></i></button>
                                <button @click="removeVariant(idx)" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    </div>
                </div>

                <button @click="handleSave" class="w-full bg-green-600 text-white font-bold py-3 rounded-xl hover:bg-green-700 mt-4 shadow-lg shadow-green-100">
                    {{ isEditing ? 'Ğ—Ğ±ĞµÑ€ĞµĞ³Ñ‚Ğ¸ Ğ·Ğ¼Ñ–Ğ½Ğ¸' : 'Ğ¡Ñ‚Ğ²Ğ¾Ñ€Ğ¸Ñ‚Ğ¸ Ñ‚Ğ¾Ğ²Ğ°Ñ€' }}
                </button>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden flex flex-col h-full" :class="showForm ? 'xl:col-span-2' : 'xl:col-span-3'">
            
            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
                <div class="flex items-center gap-4">
                    <h2 class="font-bold text-gray-700">Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ–Ğ²</h2>
                    <input v-model="productSearch" placeholder="ĞŸĞ¾ÑˆÑƒĞº..." class="border rounded px-2 py-1 text-sm bg-white">
                </div>
                <button v-if="!showForm" @click="showForm = true; resetForm()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-bold text-sm shadow-md shadow-blue-100">
                    + ĞĞ¾Ğ²Ğ¸Ğ¹ Ñ‚Ğ¾Ğ²Ğ°Ñ€
                </button>
            </div>

            <div class="overflow-auto flex-1">
                <table class="w-full text-left text-sm">
                    <thead class="bg-gray-50 text-gray-500 uppercase text-xs sticky top-0">
                        <tr>
                            <th class="p-4">ĞĞ°Ğ·Ğ²Ğ°</th>
                            <th class="p-4">ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ</th>
                            <th class="p-4">Ğ¦Ñ–Ğ½Ğ° / Ğ’Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸</th>
                            <th class="p-4 text-center">Ğ”Ñ–Ñ—</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        <tr v-if="filteredProducts.length === 0">
                            <td colspan="4" class="p-8 text-center text-gray-400">
                                Ğ¢Ğ¾Ğ²Ğ°Ñ€Ñ–Ğ² Ğ½ĞµĞ¼Ğ°Ñ” Ğ°Ğ±Ğ¾ Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ...
                            </td>
                        </tr>
                        <tr v-for="p in filteredProducts" :key="p.id" class="hover:bg-gray-50 align-top group">
                            <td class="p-4 font-bold text-gray-800">{{ p.name }}</td>
                            <td class="p-4 text-gray-600">
                                <span class="bg-gray-100 px-2 py-1 rounded text-xs">{{ getCategoryName(p.category_id) }}</span>
                            </td>
                            <td class="p-4">
                                <div v-if="!p.has_variants" class="font-mono font-bold text-green-600">{{ p.price }} â‚´</div>
                                <div v-else class="space-y-2">
                                    <div v-for="v in p.variants" :key="v.id" class="text-xs bg-gray-50 p-2 rounded border border-gray-200">
                                        <div class="flex justify-between font-bold mb-1">
                                            <span>{{ v.name }}</span>
                                            <span>{{ v.price }} â‚´</span>
                                        </div>
                                        <div class="text-gray-500 flex flex-col gap-1">
                                            <span v-if="v.ingredients?.length" class="text-blue-600 flex items-center gap-1">
                                                <i class="fas fa-flask"></i> Ğ†Ğ½Ğ³Ñ€: {{ v.ingredients.length }}
                                            </span>
                                            <div v-if="v.consumables?.length" class="text-teal-600">
                                                <div class="flex items-start gap-1">
                                                    <i class="fas fa-box-open mt-0.5"></i> 
                                                    <div class="flex flex-wrap gap-1">
                                                        <span v-for="vc in v.consumables" :key="vc.id" class="bg-teal-50 border border-teal-100 px-1 rounded">
                                                            {{ vc.consumable_name || '?' }}: {{ vc.quantity }}
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td class="p-4 text-center">
                                <div class="flex justify-center gap-2">
                                    <button @click="handleEdit(p)" class="text-blue-500 hover:text-blue-700 p-1.5 hover:bg-blue-50 rounded"><i class="fas fa-pen"></i></button>
                                    <button @click="deleteProduct(p.id)" class="text-red-400 hover:text-red-600 p-1.5 hover:bg-red-50 rounded"><i class="fas fa-trash"></i></button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</template>

--------------------------------------------------
PATH: ./.history/frontend/src/components/warehouse/tabs/ProductsTab_20260125111040.vue
--------------------------------------------------
<script setup>
import { ref, onMounted } from 'vue'
import { useWarehouse } from '@/composables/useWarehouse'
import { useProducts } from '@/composables/useProducts'

// ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ğ´Ğ¾Ğ²Ñ–Ğ´Ğ½Ğ¸ĞºĞ¸ (ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ—, Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ğ¸ Ñ‚Ğ¾Ñ‰Ğ¾)
const { categories, recipes, ingredients, consumables } = useWarehouse()

// ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ñ„ÑƒĞ½ĞºÑ†Ñ–Ğ¾Ğ½Ğ°Ğ» Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ–Ğ²
const { 
    newProduct, isEditing, 
    variantBuilder, tempProductConsumable, tempVariantConsumable, tempVariantIngredient,
    resetForm, prepareEdit, saveProduct, deleteProduct, fetchProducts, filteredProducts, productSearch,
    addVariant, removeVariant, 
    addProductConsumable, removeProductConsumable,
    addVariantConsumable, removeVariantConsumable,
    addIngredientToVariant, removeIngredientFromVariant
} = useProducts()

const showForm = ref(false)

const getCategoryName = (id) => {
    if (!categories.value) return '-'
    const c = categories.value.find(x => x.id === id)
    return c ? c.name : '-'
}

const handleSave = async () => {
    const success = await saveProduct()
    if(success) {
        showForm.value = false
        // Ğ”Ğ¾Ğ´Ğ°Ñ”Ğ¼Ğ¾ Ğ¿Ñ€Ğ¸Ğ¼ÑƒÑĞ¾Ğ²Ğµ Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ
        await fetchProducts()}
}

const handleEdit = (product) => {
    prepareEdit(product)
    showForm.value = true
}

// !!! Ğ’ĞĞ–Ğ›Ğ˜Ğ’Ğ: Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ÑƒÑ”Ğ¼Ğ¾ Ğ´Ğ°Ğ½Ñ– Ğ¿Ñ€Ğ¸ ÑÑ‚Ğ°Ñ€Ñ‚Ñ– ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ° !!!
onMounted(async () => {
    console.log("ProductsTab mounted: fetching data...")
    await fetchProducts()
})
</script>

<template>
    <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
        
        <div v-if="showForm" class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 h-fit xl:col-span-1">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-gray-700">
                    {{ isEditing ? 'âœï¸ Ğ ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ' : 'ğŸ“¦ ĞĞ¾Ğ²Ğ¸Ğ¹ Ñ‚Ğ¾Ğ²Ğ°Ñ€' }}
                </h3>
                <button @click="showForm = false; resetForm()" class="text-xs text-red-500 hover:underline">Ğ—Ğ°ĞºÑ€Ğ¸Ñ‚Ğ¸</button>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞĞ°Ğ·Ğ²Ğ°</label>
                    <input v-model="newProduct.name" class="border p-2 rounded w-full focus:ring-2 ring-blue-100 outline-none">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ</label>
                        <select v-model="newProduct.category_id" class="border p-2 rounded w-full bg-white">
                            <option :value="null">-- Ğ‘ĞµĞ· ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ— --</option>
                            <option v-for="c in categories" :key="c.id" :value="c.id">{{ c.name }}</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ğ¦Ñ–Ğ½Ğ°</label>
                        <input v-model.number="newProduct.price" type="number" class="border p-2 rounded w-full">
                    </div>
                </div>

                <div class="flex items-center gap-2 py-2">
                    <input type="checkbox" v-model="newProduct.has_variants" id="hasVar" class="w-4 h-4 text-blue-600">
                    <label for="hasVar" class="text-sm font-bold text-gray-700 select-none">Ğ¦ĞµĞ¹ Ñ‚Ğ¾Ğ²Ğ°Ñ€ Ğ¼Ğ°Ñ” Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸</label>
                </div>

                <div v-if="!newProduct.has_variants" class="bg-gray-50 p-3 rounded border border-gray-200 space-y-3">
                     <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞœĞ°Ğ¹ÑÑ‚ĞµÑ€-Ñ€ĞµÑ†ĞµĞ¿Ñ‚</label>
                        <select v-model="newProduct.master_recipe_id" class="border p-2 rounded w-full bg-white text-sm">
                            <option :value="null">-- Ğ‘ĞµĞ· Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ñƒ --</option>
                            <option v-for="r in recipes" :key="r.id" :value="r.id">{{ r.name }}</option>
                        </select>
                    </div>
                </div>

                <div class="bg-teal-50/50 p-3 rounded border border-teal-100">
                    <label class="text-[10px] uppercase font-bold text-teal-600 mb-2 block">Ğ—Ğ°Ğ³Ğ°Ğ»ÑŒĞ½Ñ– Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸</label>
                    <div class="flex gap-2 mb-2">
                        <select v-model="tempProductConsumable.consumable_id" class="flex-1 border p-1 rounded text-sm bg-white">
                            <option value="">ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»...</option>
                            <option v-for="c in consumables" :key="c.id" :value="c.id">{{ c.name }}</option>
                        </select>
                        <button @click="addProductConsumable" class="bg-teal-500 text-white w-8 rounded">+</button>
                    </div>
                    <div class="flex flex-wrap gap-1">
                        <span v-for="(pc, idx) in newProduct.consumables" :key="idx" class="bg-white border border-teal-200 text-teal-700 text-xs px-2 py-1 rounded">
                            {{ pc.name }} <button @click="removeProductConsumable(idx)" class="text-red-500 font-bold ml-1">&times;</button>
                        </span>
                    </div>
                </div>

                <div v-if="newProduct.has_variants" class="space-y-3">
                    <div class="border-t pt-2 mt-2">
                        <h4 class="font-bold text-sm text-purple-700 mb-2">ĞšĞ¾Ğ½ÑÑ‚Ñ€ÑƒĞºÑ‚Ğ¾Ñ€ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñ–Ğ²</h4>
                        
                        <div class="bg-purple-50 p-3 rounded-lg border border-purple-100 space-y-3">
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="text-[10px] uppercase font-bold text-gray-500">ĞĞ°Ğ·Ğ²Ğ°</label>
                                    <input v-model="variantBuilder.name" placeholder="Ğ½Ğ°Ğ¿Ñ€. XL" class="w-full border p-1.5 rounded text-sm">
                                </div>
                                <div>
                                    <label class="text-[10px] uppercase font-bold text-gray-500">Ğ¦Ñ–Ğ½Ğ°</label>
                                    <input v-model.number="variantBuilder.price" type="number" class="w-full border p-1.5 rounded text-sm">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="text-[10px] uppercase font-bold text-gray-500">Ğ¢ĞµÑ…. ĞºĞ°Ñ€Ñ‚Ğ° (Ğ ĞµÑ†ĞµĞ¿Ñ‚)</label>
                                    <select v-model="variantBuilder.master_recipe_id" class="w-full border p-1.5 rounded text-sm bg-white">
                                        <option :value="null">-- Ğ‘ĞµĞ· Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ñƒ --</option>
                                        <option v-for="r in recipes" :key="r.id" :value="r.id">{{ r.name }}</option>
                                    </select>
                                    <p v-if="!recipes || recipes.length === 0" class="text-[10px] text-red-500 mt-1">Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ñ–Ğ² Ğ¿ÑƒÑÑ‚Ğ¸Ğ¹!</p>
                                </div>
                                <div>
                                    <label class="text-[10px] uppercase font-bold text-gray-500">Ğ’Ğ°Ğ³Ğ° Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¾Ğ³Ğ¾ (Ğ³/Ğ¼Ğ»)</label>
                                    <input v-model.number="variantBuilder.output_weight" type="number" class="w-full border p-1.5 rounded text-sm">
                                </div>
                            </div>
                            
                            <div>
                                <label class="text-[10px] uppercase font-bold text-gray-500">ĞŸĞ¾Ñ‡Ğ°Ñ‚ĞºĞ¾Ğ²Ğ¸Ğ¹ Ğ·Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº (ÑˆÑ‚)</label>
                                <input v-model.number="variantBuilder.stock_quantity" type="number" class="w-full border p-1.5 rounded text-sm bg-white" placeholder="0">
                            </div>

                            <div class="bg-white/50 p-2 rounded border border-dashed border-purple-200">
                                <label class="text-[10px] uppercase font-bold text-purple-400">ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ</label>
                                <div class="flex gap-1 mb-1">
                                    <select v-model="tempVariantConsumable.consumable_id" class="flex-1 border p-1 rounded text-[10px] bg-white h-7">
                                        <option value="">ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»...</option>
                                        <option v-for="c in consumables" :key="c.id" :value="c.id">{{ c.name }}</option>
                                    </select>
                                    <input v-model.number="tempVariantConsumable.quantity" type="number" class="w-10 border p-1 rounded text-[10px] h-7" placeholder="Ğš-ÑÑ‚ÑŒ">
                                    <button @click="addVariantConsumable" class="bg-purple-500 text-white w-7 h-7 rounded hover:bg-purple-600 text-xs">+</button>
                                </div>
                                <div class="flex flex-wrap gap-1">
                                    <span v-for="(vc, idx) in variantBuilder.consumables" :key="idx" class="bg-white border text-[10px] px-1 rounded flex items-center gap-1">
                                        {{ vc.name }}: {{ vc.quantity }} <button @click="removeVariantConsumable(idx)" class="text-red-500 font-bold">&times;</button>
                                    </span>
                                </div>
                            </div>

                            <div class="bg-blue-50/50 p-2 rounded border border-dashed border-blue-200">
                                <label class="text-[10px] uppercase font-bold text-blue-500">Ğ”Ğ¾Ğ´Ğ°Ñ‚ĞºĞ¾Ğ²Ñ– Ñ–Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ğ¸</label>
                                <div class="flex gap-1 mb-1">
                                    <select v-model="tempVariantIngredient.ingredient_id" class="flex-1 border p-1 rounded text-[10px] bg-white h-7">
                                        <option value="">Ğ†Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚...</option>
                                        <option v-for="i in ingredients" :key="i.id" :value="i.id">{{ i.name }}</option>
                                    </select>
                                    <input v-model.number="tempVariantIngredient.quantity" type="number" class="w-10 border p-1 rounded text-[10px] h-7" placeholder="Ğ“Ñ€Ğ°Ğ¼">
                                    <button @click="addIngredientToVariant" class="bg-blue-500 text-white w-7 h-7 rounded hover:bg-blue-600 text-xs">+</button>
                                </div>
                                <div class="flex flex-wrap gap-1">
                                    <span v-for="(vi, idx) in variantBuilder.ingredients" :key="idx" class="bg-white border text-[10px] px-1 rounded flex items-center gap-1 text-blue-700">
                                        {{ vi.name }}: {{ vi.quantity }} <button @click="removeIngredientFromVariant(idx)" class="text-red-500 font-bold">&times;</button>
                                    </span>
                                </div>
                            </div>

                            <button @click="addVariant" class="w-full bg-purple-200 text-purple-800 text-xs font-bold py-2 rounded hover:bg-purple-300">
                                Ğ”Ğ¾Ğ´Ğ°Ñ‚Ğ¸ Ñ†ĞµĞ¹ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚ Ñƒ ÑĞ¿Ğ¸ÑĞ¾Ğº
                            </button>
                        </div>
                    </div>
                    
                    <div v-if="newProduct.variants.length > 0" class="space-y-2">
                        <div v-for="(v, idx) in newProduct.variants" :key="idx" class="bg-white border p-2 rounded flex justify-between items-center text-sm">
                            <div>
                                <span class="font-bold">{{ v.name }}</span> - {{ v.price }} Ğ³Ñ€Ğ½
                                <div class="text-xs text-gray-400">
                                    <span v-if="v.master_recipe_id" class="text-purple-600 mr-2">ğŸ“œ Ğ ĞµÑ†ĞµĞ¿Ñ‚ ID: {{ v.master_recipe_id }}</span>
                                    <span v-if="v.stock_quantity > 0" class="text-green-600 font-bold">Ğ—Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº: {{ v.stock_quantity }}</span>
                                </div>
                            </div>
                            <button @click="removeVariant(idx)" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                </div>

                <button @click="handleSave" class="w-full bg-green-600 text-white font-bold py-3 rounded-xl hover:bg-green-700 mt-4">
                    {{ isEditing ? 'Ğ—Ğ±ĞµÑ€ĞµĞ³Ñ‚Ğ¸' : 'Ğ¡Ñ‚Ğ²Ğ¾Ñ€Ğ¸Ñ‚Ğ¸' }}
                </button>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden flex flex-col h-full" :class="showForm ? 'xl:col-span-2' : 'xl:col-span-3'">
            
            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
                <div class="flex items-center gap-4">
                    <h2 class="font-bold text-gray-700">Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ–Ğ²</h2>
                    <input v-model="productSearch" placeholder="ĞŸĞ¾ÑˆÑƒĞº..." class="border rounded px-2 py-1 text-sm">
                </div>
                <button v-if="!showForm" @click="showForm = true; resetForm()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-bold text-sm">
                    + ĞĞ¾Ğ²Ğ¸Ğ¹ Ñ‚Ğ¾Ğ²Ğ°Ñ€
                </button>
            </div>

            <div class="overflow-auto flex-1">
                <table class="w-full text-left text-sm">
                    <thead class="bg-gray-50 text-gray-500 uppercase text-xs sticky top-0">
                        <tr>
                            <th class="p-4">ĞĞ°Ğ·Ğ²Ğ°</th>
                            <th class="p-4">ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ</th>
                            <th class="p-4">Ğ¦Ñ–Ğ½Ğ° / Ğ’Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸</th>
                            <th class="p-4 text-center">Ğ”Ñ–Ñ—</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        <tr v-if="filteredProducts.length === 0">
                            <td colspan="4" class="p-8 text-center text-gray-400">
                                Ğ¢Ğ¾Ğ²Ğ°Ñ€Ñ–Ğ² Ğ½ĞµĞ¼Ğ°Ñ” Ğ°Ğ±Ğ¾ Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ...
                            </td>
                        </tr>
                        <tr v-for="p in filteredProducts" :key="p.id" class="hover:bg-gray-50 align-top">
                            <td class="p-4 font-bold text-gray-800">{{ p.name }}</td>
                            <td class="p-4 text-gray-600">
                                <span class="bg-gray-100 px-2 py-1 rounded text-xs">{{ getCategoryName(p.category_id) }}</span>
                            </td>
                            <td class="p-4">
                                <div v-if="!p.has_variants" class="font-mono font-bold text-green-600">{{ p.price }} â‚´</div>
                                <div v-else class="space-y-1">
                                    <div v-for="v in p.variants" :key="v.id" class="text-xs bg-gray-50 p-1 rounded border">
                                        <b>{{ v.name }}</b>: {{ v.price }} â‚´
                                        <span v-if="v.ingredients?.length" class="text-blue-600 ml-1">
                                            (Ğ†Ğ½Ğ³Ñ€: {{ v.ingredients.length }})
                                        </span>
                                    </div>
                                </div>
                            </td>
                            <td class="p-4 text-center">
                                <button @click="handleEdit(p)" class="text-blue-500 hover:text-blue-700 mx-1"><i class="fas fa-pen"></i></button>
                                <button @click="deleteProduct(p.id)" class="text-red-400 hover:text-red-600 mx-1"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</template>

--------------------------------------------------
PATH: ./.history/frontend/src/components/warehouse/tabs/CategoriesTab_20260120224534.vue
--------------------------------------------------
<script setup>
import { ref } from 'vue'
import { useWarehouse } from '@/composables/useWarehouse'

// Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ Ğ¼ĞµÑ‚Ğ¾Ğ´Ğ¸ Ğ· Ğ½Ğ°ÑˆĞ¾Ğ³Ğ¾ composable
const { categories, createItem, updateItem, deleteItem } = useWarehouse()

// Ğ¡Ñ‚Ğ°Ğ½ Ñ„Ğ¾Ñ€Ğ¼Ğ¸
const newCategory = ref({ name: '', slug: '', color: '#3b82f6', parent_id: '' }) 
const isEditing = ref(false)
const editingId = ref(null)

// Ğ”Ğ¾Ğ¿Ğ¾Ğ¼Ñ–Ğ¶Ğ½Ğ° Ñ„ÑƒĞ½ĞºÑ†Ñ–Ñ Ğ´Ğ»Ñ Ğ²Ñ–Ğ´Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ±Ğ°Ñ‚ÑŒĞºĞ°
const getParentName = (parentId) => {
    if (!parentId) return '';
    const parent = categories.value.find(c => c.id === parentId);
    return parent ? parent.name : '???';
}

// Ğ—Ğ°Ğ¿Ğ¾Ğ²Ğ½ĞµĞ½Ğ½Ñ Ñ„Ğ¾Ñ€Ğ¼Ğ¸ Ğ´Ğ»Ñ Ñ€ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ
const prepareEdit = (category) => {
    isEditing.value = true
    editingId.value = category.id
    newCategory.value = {
        name: category.name,
        slug: category.slug,
        color: category.color || '#3b82f6',
        parent_id: category.parent_id || ''
    }
}

// Ğ¡ĞºĞ¸Ğ´Ğ°Ğ½Ğ½Ñ Ñ„Ğ¾Ñ€Ğ¼Ğ¸
const resetForm = () => {
    isEditing.value = false
    editingId.value = null
    newCategory.value = { name: '', slug: '', color: '#3b82f6', parent_id: '' }
}

// ĞĞ±Ñ€Ğ¾Ğ±ĞºĞ° Ğ·Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ½Ñ (Ğ¡Ñ‚Ğ²Ğ¾Ñ€Ğ¸Ñ‚Ğ¸ ĞĞ‘Ğ ĞĞ½Ğ¾Ğ²Ğ¸Ñ‚Ğ¸)
const handleSave = async () => {
    if (!newCategory.value.name) return alert("Ğ’ĞºĞ°Ğ¶Ñ–Ñ‚ÑŒ Ğ½Ğ°Ğ·Ğ²Ñƒ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ—!")
    
    const payload = { ...newCategory.value }
    
    // ĞĞ²Ñ‚Ğ¾Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ñ–Ñ slug, ÑĞºÑ‰Ğ¾ Ğ¿ÑƒÑÑ‚Ğ¾
    if (!payload.slug) {
        payload.slug = payload.name.toLowerCase().replace(/\s+/g, '-') + '-' + Date.now().toString().slice(-4)
    }
    // ĞÑ‡Ğ¸Ñ‰ĞµĞ½Ğ½Ñ parent_id
    if (payload.parent_id === "") payload.parent_id = null
    
    let success = false

    if (isEditing.value) {
        // ĞĞĞĞ’Ğ›Ğ•ĞĞĞ¯ (PUT)
        success = await updateItem(`/api/categories/${editingId.value}`, payload)
    } else {
        // Ğ¡Ğ¢Ğ’ĞĞ Ğ•ĞĞĞ¯ (POST)
        success = await createItem('/api/categories/', payload)
    }

    if(success) {
        resetForm()
    }
}

// ĞĞ±Ñ€Ğ¾Ğ±ĞºĞ° Ğ²Ğ¸Ğ´Ğ°Ğ»ĞµĞ½Ğ½Ñ
const handleDelete = async (id) => {
    await deleteItem(`/api/categories/${id}`)
    // Ğ¯ĞºÑ‰Ğ¾ Ğ¼Ğ¸ Ñ€ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ»Ğ¸ ÑĞ°Ğ¼Ğµ Ñ†Ñ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ - ÑĞºĞ¸Ğ´Ğ°Ñ”Ğ¼Ğ¾ Ñ„Ğ¾Ñ€Ğ¼Ñƒ
    if (editingId.value === id) {
        resetForm()
    }
}
</script>

<template>
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 h-fit">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-gray-700">
                    {{ isEditing ? 'âœï¸ Ğ ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ—' : 'ğŸ“‚ ĞĞ¾Ğ²Ğ° ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ' }}
                </h3>
                <button v-if="isEditing" @click="resetForm" class="text-xs text-red-500 hover:underline">Ğ¡ĞºĞ°ÑÑƒĞ²Ğ°Ñ‚Ğ¸</button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞĞ°Ğ·Ğ²Ğ°</label>
                    <input v-model="newCategory.name" class="border p-2 rounded w-full focus:ring-2 ring-blue-100 outline-none" placeholder="ĞĞ°Ğ¿Ñ€. ĞšĞ°Ğ²Ğ°">
                </div>
                
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞšĞ¾Ğ´ (Slug)</label>
                    <input v-model="newCategory.slug" class="border p-2 rounded w-full font-mono text-sm text-gray-600" placeholder="auto-generated">
                </div>
                
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞšĞ¾Ğ»Ñ–Ñ€</label>
                    <div class="flex items-center gap-2">
                        <input v-model="newCategory.color" type="color" class="h-10 w-16 border rounded cursor-pointer p-1 bg-white">
                        <span class="text-sm text-gray-600 font-mono">{{ newCategory.color }}</span>
                    </div>
                </div>
                
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ğ‘Ğ°Ñ‚ÑŒĞºÑ–Ğ²ÑÑŒĞºĞ° ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ</label>
                    <select v-model="newCategory.parent_id" class="border p-2 rounded w-full bg-white">
                        <option value="">(ĞĞµĞ¼Ğ°Ñ” - ĞšĞ¾Ñ€ĞµĞ½ĞµĞ²Ğ°)</option>
                        <option v-for="c in categories" :key="c.id" :value="c.id" :disabled="c.id === editingId">
                            {{ c.name }}
                        </option>
                    </select>
                </div>
                
                <button @click="handleSave" 
                    class="w-full py-3 rounded-xl font-bold text-white shadow-lg transition transform active:scale-95"
                    :class="isEditing ? 'bg-orange-500 hover:bg-orange-600 shadow-orange-200' : 'bg-blue-600 hover:bg-blue-700 shadow-blue-200'">
                    {{ isEditing ? 'Ğ—Ğ±ĞµÑ€ĞµĞ³Ñ‚Ğ¸ Ğ·Ğ¼Ñ–Ğ½Ğ¸' : 'Ğ¡Ñ‚Ğ²Ğ¾Ñ€Ğ¸Ñ‚Ğ¸ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ' }}
                </button>
            </div>
        </div>

        <div class="lg:col-span-2 bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="bg-gray-50 text-gray-500 uppercase text-xs">
                        <tr>
                            <th class="p-4">ĞšĞ¾Ğ»Ñ–Ñ€</th>
                            <th class="p-4">ĞĞ°Ğ·Ğ²Ğ°</th>
                            <th class="p-4">ĞšĞ¾Ğ´</th>
                            <th class="p-4">Ğ‘Ğ°Ñ‚ÑŒĞºĞ¾</th>
                            <th class="p-4 text-center">Ğ”Ñ–Ñ—</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        <tr v-if="categories.length === 0">
                            <td colspan="5" class="p-8 text-center text-gray-400">ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ğ¹ Ñ‰Ğµ Ğ½ĞµĞ¼Ğ°Ñ”</td>
                        </tr>
                        <tr v-for="c in categories" :key="c.id" class="hover:bg-gray-50 group">
                            <td class="p-4">
                                <div class="w-8 h-8 rounded-lg shadow-sm border border-gray-200" :style="{ backgroundColor: c.color || '#fff' }"></div>
                            </td>
                            <td class="p-4 font-bold text-gray-800 text-lg">{{ c.name }}</td>
                            <td class="p-4 font-mono text-gray-500">{{ c.slug }}</td>
                            <td class="p-4">
                                <span v-if="c.parent_id" class="bg-blue-50 text-blue-600 px-2 py-1 rounded text-xs font-bold">
                                    {{ getParentName(c.parent_id) }}
                                </span>
                                <span v-else class="text-gray-300 text-xs">-</span>
                            </td>
                            <td class="p-4 text-center">
                                <div class="flex justify-center gap-2">
                                    <button @click="prepareEdit(c)" class="p-2 text-blue-400 hover:text-blue-600 hover:bg-blue-50 rounded transition" title="Ğ ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ñ‚Ğ¸">
                                        <i class="fas fa-pen"></i>
                                    </button>
                                    <button @click="handleDelete(c.id)" class="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded transition" title="Ğ’Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğ¸">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</template>

--------------------------------------------------
PATH: ./.history/frontend/src/components/warehouse/tabs/StockTab_20260126154010.vue
--------------------------------------------------
<script setup>
import { ref, computed, onMounted } from 'vue'
import { useWarehouse } from '@/composables/useWarehouse'
import axios from 'axios'

// !!! Ğ’ĞĞ–Ğ›Ğ˜Ğ’Ğ: Ğ¡Ñ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ğ¸Ğ¹ Ñ–Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ Ğ·Ğ°Ğ¼Ñ–ÑÑ‚ÑŒ defineAsyncComponent !!!
// ĞŸĞµÑ€ĞµĞºĞ¾Ğ½Ğ°Ğ¹Ñ‚ĞµÑÑŒ, Ñ‰Ğ¾ ÑˆĞ»ÑÑ… Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¸Ğ¹ Ğ²Ñ–Ğ´Ğ½Ğ¾ÑĞ½Ğ¾ Ñ†ÑŒĞ¾Ğ³Ğ¾ Ñ„Ğ°Ğ¹Ğ»Ñƒ
import HistoryModal from '../modals/HistoryModal.vue'

const { ingredients, consumables, products, fetchWarehouseData } = useWarehouse()

const activeTab = ref('ingredients')
const search = ref('')
const loading = ref(false)

// Ğ ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ
const editingItem = ref(null)
const editValue = ref(0)

// Ğ†ÑÑ‚Ğ¾Ñ€Ñ–Ñ
const isHistoryOpen = ref(false)
const historyItem = ref(null)

// --- Ğ¤Ğ£ĞĞšĞ¦Ğ†Ğ¯ Ğ’Ğ†Ğ”ĞšĞ Ğ˜Ğ¢Ğ¢Ğ¯ Ğ†Ğ¡Ğ¢ĞĞ Ğ†Ğ‡ (Ğ— Ğ›ĞĞ“ĞĞœĞ˜) ---
const openHistory = (item) => {
    console.log("StockTab: ĞšĞ»Ñ–ĞºĞ½ÑƒĞ»Ğ¸ Ñ–ÑÑ‚Ğ¾Ñ€Ñ–Ñ Ğ´Ğ»Ñ:", item)
    
    // ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ° ID
    const realId = item.original_id || item.id
    if (!realId) {
        alert("ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ°: ĞĞµĞ¼Ğ°Ñ” ID Ñƒ ĞµĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ°")
        return
    }

    historyItem.value = {
        id: realId,
        type: item.type,
        name: item.display_name
    }
    isHistoryOpen.value = true
    console.log("StockTab: ĞœĞ¾Ğ´Ğ°Ğ»ĞºÑƒ Ğ²Ñ–Ğ´ĞºÑ€Ğ¸Ñ‚Ğ¾, Ğ´Ğ°Ğ½Ñ– Ğ¿ĞµÑ€ĞµĞ´Ğ°Ğ½Ğ¾:", historyItem.value)
}

// --- Ğ¡ĞŸĞ˜Ğ¡ĞĞš (Ğ›Ğ¾Ğ³Ñ–ĞºĞ° Ñ‚Ğ° ÑĞ°Ğ¼Ğ°, Ñ‰Ğ¾ Ñ– Ğ±ÑƒĞ»Ğ°) ---
const filteredItems = computed(() => {
    let list = []
    if (activeTab.value === 'ingredients') {
        list = ingredients.value.map(i => ({ ...i, type: 'ingredient', display_name: i.name, unit_symbol: i.unit?.symbol || '' }))
    } 
    else if (activeTab.value === 'consumables') {
        list = consumables.value.map(c => ({ ...c, type: 'consumable', display_name: c.name, unit_symbol: c.unit?.symbol || '' }))
    } 
    else if (activeTab.value === 'products') {
        products.value.forEach(p => {
            if (p.has_variants && p.variants) {
                p.variants.forEach(v => {
                    list.push({
                        id: v.id, original_id: v.id, type: 'product_variant', 
                        display_name: `${p.name} (${v.name})`, stock_quantity: v.stock_quantity, unit_symbol: 'ÑˆÑ‚'
                    })
                })
            } else {
                list.push({
                    id: p.id, original_id: p.id, type: 'product', 
                    display_name: p.name, stock_quantity: p.stock_quantity, unit_symbol: 'ÑˆÑ‚'
                })
            }
        })
    }
    if (search.value) {
        const s = search.value.toLowerCase()
        return list.filter(i => i.display_name.toLowerCase().includes(s))
    }
    return list
})

const startEdit = (item) => {
    editingItem.value = item.id
    editValue.value = item.stock_quantity
}

const saveEdit = async (item) => {
    loading.value = true
    try {
        let url = ''
        let payload = {}
        let method = 'put'
        
        const realId = item.original_id || item.id

        if (item.type === 'ingredient') {
            url = `/api/ingredients/${realId}`
            payload = { ...item, stock_quantity: editValue.value }
        } 
        else if (item.type === 'consumable') {
            url = `/api/consumables/${realId}`
            payload = { ...item, stock_quantity: editValue.value }
        }
        else if (item.type === 'product') {
            url = `/api/products/${realId}/stock?qty=${editValue.value}`
            method = 'patch'
        }
        else if (item.type === 'product_variant') {
            url = `/api/products/variants/${realId}/stock?qty=${editValue.value}`
            method = 'patch'
        }

        if (method === 'put') await axios.put(url, payload)
        else await axios.patch(url)

        item.stock_quantity = editValue.value
        editingItem.value = null
    } catch (e) {
        console.error(e)
        alert("ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ·Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ½Ñ")
    } finally {
        loading.value = false
    }
}

onMounted(() => {
    fetchWarehouseData()
})
</script>

<template>
    <div class="h-full flex flex-col bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
        
        <div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center gap-4">
            <div class="flex p-1 bg-white rounded-xl border border-gray-200 shadow-sm">
                <button 
                    v-for="tab in ['ingredients', 'consumables', 'products']" 
                    :key="tab" @click="activeTab = tab"
                    class="px-4 py-2 text-xs font-bold rounded-lg transition-all"
                    :class="activeTab === tab ? 'bg-blue-600 text-white shadow-md' : 'text-gray-500 hover:bg-gray-50'"
                >
                    {{ tab === 'ingredients' ? 'ğŸ¥¦ Ğ¡Ğ¸Ñ€Ğ¾Ğ²Ğ¸Ğ½Ğ°' : (tab === 'consumables' ? 'ğŸ“¦ ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸' : 'ğŸ¹ Ğ¢Ğ¾Ğ²Ğ°Ñ€Ğ¸') }}
                </button>
            </div>
            <input v-model="search" placeholder="ĞŸĞ¾ÑˆÑƒĞº..." class="border border-gray-200 rounded-xl px-3 py-2 text-sm outline-none w-64">
        </div>

        <div class="flex-1 overflow-auto">
            <table class="w-full text-left text-sm">
                <thead class="bg-gray-50 text-gray-500 uppercase text-xs sticky top-0 z-10">
                    <tr>
                        <th class="p-4">ĞĞ°Ğ·Ğ²Ğ°</th>
                        <th class="p-4 text-center">Ğ¢Ğ¸Ğ¿</th>
                        <th class="p-4 text-right">Ğ—Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº</th>
                        <th class="p-4 text-center">Ğ”Ñ–Ñ—</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    <tr v-for="item in filteredItems" :key="item.id + item.type" class="hover:bg-gray-50 group">
                        <td class="p-4 font-bold text-gray-700">{{ item.display_name }}</td>
                        <td class="p-4 text-center">
                            <span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-[10px] font-bold">{{ item.type }}</span>
                        </td>
                        <td class="p-4 text-right font-mono font-bold">
                            <div v-if="editingItem === item.id" class="flex items-center justify-end gap-2">
                                <input v-model.number="editValue" type="number" class="w-20 border rounded p-1 text-right">
                            </div>
                            <span v-else :class="{'text-red-500': item.stock_quantity <= 0}">
                                {{ item.stock_quantity }} {{ item.unit_symbol }}
                            </span>
                        </td>
                        <td class="p-4 text-center">
                            <div v-if="editingItem === item.id" class="flex justify-center gap-1">
                                <button @click="saveEdit(item)" class="text-green-500"><i class="fas fa-check"></i></button>
                                <button @click="editingItem = null" class="text-gray-400"><i class="fas fa-times"></i></button>
                            </div>
                            <div v-else class="flex justify-center gap-2">
                                <button @click="openHistory(item)" class="text-purple-400 hover:text-purple-600 p-2 rounded hover:bg-purple-50">
                                    <i class="fas fa-history"></i>
                                </button>
                                <button @click="startEdit(item)" class="text-blue-400 hover:text-blue-600 p-2">
                                    <i class="fas fa-pen"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <HistoryModal 
            v-if="isHistoryOpen" 
            :is-open="isHistoryOpen" 
            :item="historyItem" 
            @close="isHistoryOpen = false" 
        />
    </div>
</template>

--------------------------------------------------
PATH: ./.history/frontend/src/components/warehouse/tabs/UnitsTab_20260123212632.vue
--------------------------------------------------
<script setup>
import { ref } from 'vue'
import { useWarehouse } from '@/composables/useWarehouse'

// Ğ†Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ÑƒÑ”Ğ¼Ğ¾ Ğ¼ĞµÑ‚Ğ¾Ğ´Ğ¸ Ğ· Ğ½Ğ°ÑˆĞ¾Ğ³Ğ¾ composable
const { units, createItem, updateItem, deleteItem } = useWarehouse()

// Ğ¡Ñ‚Ğ°Ğ½ Ñ„Ğ¾Ñ€Ğ¼Ğ¸
const newUnit = ref({ name: '', symbol: '' })
const isEditing = ref(false)
const editingId = ref(null)

// ĞŸÑ–Ğ´Ğ³Ğ¾Ñ‚ÑƒĞ²Ğ°Ñ‚Ğ¸ Ñ„Ğ¾Ñ€Ğ¼Ñƒ Ğ´Ğ¾ Ñ€ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ
const prepareEdit = (unit) => {
    isEditing.value = true
    editingId.value = unit.id
    newUnit.value = {
        name: unit.name,
        symbol: unit.symbol
    }
}

// Ğ¡ĞºĞ¸Ğ½ÑƒÑ‚Ğ¸ Ñ„Ğ¾Ñ€Ğ¼Ñƒ
const resetForm = () => {
    isEditing.value = false
    editingId.value = null
    newUnit.value = { name: '', symbol: '' }
}

// ĞĞ±Ñ€Ğ¾Ğ±ĞºĞ° Ğ·Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ½Ñ
const handleSave = async () => {
    if (!newUnit.value.name || !newUnit.value.symbol) return alert("Ğ—Ğ°Ğ¿Ğ¾Ğ²Ğ½Ñ–Ñ‚ÑŒ Ğ²ÑÑ– Ğ¿Ğ¾Ğ»Ñ!")

    let success = false
    if (isEditing.value) {
        // ĞĞ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ (PUT)
        success = await updateItem(`/api/inventory/units/${editingId.value}`, newUnit.value)
    } else {
        // Ğ¡Ñ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ½Ñ (POST)
        success = await createItem('/api/inventory/units/', newUnit.value)
    }

    if (success) {
        resetForm()
    }
}

// ĞĞ±Ñ€Ğ¾Ğ±ĞºĞ° Ğ²Ğ¸Ğ´Ğ°Ğ»ĞµĞ½Ğ½Ñ
const handleDelete = async (id) => {
    if(!confirm("Ğ’Ğ¸ Ğ²Ğ¿ĞµĞ²Ğ½ĞµĞ½Ñ–? Ğ¯ĞºÑ‰Ğ¾ Ñ†Ñ Ğ¾Ğ´Ğ¸Ğ½Ğ¸Ñ†Ñ Ğ²Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ñ‚ÑŒÑÑ Ğ² Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°Ñ…, Ğ²Ğ¸Ğ´Ğ°Ğ»ĞµĞ½Ğ½Ñ Ğ±ÑƒĞ´Ğµ Ğ·Ğ°Ğ±Ğ»Ğ¾ĞºĞ¾Ğ²Ğ°Ğ½Ğ¾.")) return
    
    const success = await deleteItem(`/api/inventory/units/${id}`)
    
    // Ğ¯ĞºÑ‰Ğ¾ Ğ²Ğ¸Ğ´Ğ°Ğ»Ğ¸Ğ»Ğ¸ Ñ‚Ğµ, Ñ‰Ğ¾ Ğ·Ğ°Ñ€Ğ°Ğ· Ñ€ĞµĞ´Ğ°Ğ³ÑƒÑ”Ğ¼Ğ¾ - ÑĞºĞ¸Ğ´Ğ°Ñ”Ğ¼Ğ¾ Ñ„Ğ¾Ñ€Ğ¼Ñƒ
    if (success && editingId.value === id) {
        resetForm()
    }
}
</script>

<template>
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 h-fit">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-gray-700">
                    {{ isEditing ? 'âœï¸ Ğ ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ¾Ğ´Ğ¸Ğ½Ğ¸Ñ†Ñ–' : 'ğŸ“ ĞĞ¾Ğ²Ğ° Ğ¾Ğ´Ğ¸Ğ½Ğ¸Ñ†Ñ Ğ²Ğ¸Ğ¼Ñ–Ñ€Ñƒ' }}
                </h3>
                <button v-if="isEditing" @click="resetForm" class="text-xs text-red-500 hover:underline">Ğ¡ĞºĞ°ÑÑƒĞ²Ğ°Ñ‚Ğ¸</button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞĞ°Ğ·Ğ²Ğ°</label>
                    <input v-model="newUnit.name" class="border p-2 rounded w-full focus:ring-2 ring-blue-100 outline-none" placeholder="ĞĞ°Ğ¿Ñ€. ĞšÑ–Ğ»Ğ¾Ğ³Ñ€Ğ°Ğ¼">
                </div>
                
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ğ¡Ğ¸Ğ¼Ğ²Ğ¾Ğ»</label>
                    <input v-model="newUnit.symbol" class="border p-2 rounded w-full focus:ring-2 ring-blue-100 outline-none" placeholder="ĞĞ°Ğ¿Ñ€. ĞºĞ³">
                </div>
                
                <button @click="handleSave" 
                    class="w-full py-3 rounded-xl font-bold text-white shadow-lg transition transform active:scale-95"
                    :class="isEditing ? 'bg-orange-500 hover:bg-orange-600 shadow-orange-200' : 'bg-blue-600 hover:bg-blue-700 shadow-blue-200'">
                    {{ isEditing ? 'Ğ—Ğ±ĞµÑ€ĞµĞ³Ñ‚Ğ¸ Ğ·Ğ¼Ñ–Ğ½Ğ¸' : 'Ğ”Ğ¾Ğ´Ğ°Ñ‚Ğ¸ Ğ¾Ğ´Ğ¸Ğ½Ğ¸Ñ†Ñ' }}
                </button>
            </div>
        </div>

        <div class="lg:col-span-2 bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
            <table class="w-full text-sm text-left">
                <thead class="bg-gray-50 text-gray-500 uppercase text-xs">
                    <tr>
                        <th class="p-4">ĞĞ°Ğ·Ğ²Ğ°</th>
                        <th class="p-4">Ğ¡Ğ¸Ğ¼Ğ²Ğ¾Ğ»</th>
                        <th class="p-4 text-center">Ğ”Ñ–Ñ—</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    <tr v-if="units.length === 0">
                        <td colspan="3" class="p-8 text-center text-gray-400">Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¿Ğ¾Ñ€Ğ¾Ğ¶Ğ½Ñ–Ğ¹</td>
                    </tr>
                    <tr v-for="u in units" :key="u.id" class="hover:bg-gray-50 group">
                        <td class="p-4 font-bold text-gray-800">{{ u.name }}</td>
                        <td class="p-4 font-mono text-blue-600 bg-blue-50 w-fit rounded px-2 py-1 text-xs">{{ u.symbol }}</td>
                        <td class="p-4 text-center">
                            <div class="flex justify-center gap-2">
                                <button @click="prepareEdit(u)" class="p-2 text-blue-400 hover:text-blue-600 hover:bg-blue-50 rounded transition" title="Ğ ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ñ‚Ğ¸">
                                    <i class="fas fa-pen"></i>
                                </button>
                                <button @click="handleDelete(u.id)" class="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded transition" title="Ğ’Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğ¸">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</template>

--------------------------------------------------
PATH: ./.history/frontend/src/components/warehouse/tabs/ProductsTab_20260124215646.vue
--------------------------------------------------
<script setup>
import { ref, onMounted } from 'vue'
import { useWarehouse } from '@/composables/useWarehouse'
import { useProducts } from '@/composables/useProducts'

// ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ğ´Ğ¾Ğ²Ñ–Ğ´Ğ½Ğ¸ĞºĞ¸ (ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ—, Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ğ¸ Ñ‚Ğ¾Ñ‰Ğ¾)
const { categories, recipes, ingredients, consumables } = useWarehouse()

// ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ñ„ÑƒĞ½ĞºÑ†Ñ–Ğ¾Ğ½Ğ°Ğ» Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ–Ğ²
const { 
    newProduct, isEditing, 
    variantBuilder, tempProductConsumable, tempVariantConsumable, tempVariantIngredient,
    resetForm, prepareEdit, saveProduct, deleteProduct, fetchProducts, filteredProducts, productSearch,
    addVariant, removeVariant, 
    addProductConsumable, removeProductConsumable,
    addVariantConsumable, removeVariantConsumable,
    addIngredientToVariant, removeIngredientFromVariant
} = useProducts()

const showForm = ref(false)

const getCategoryName = (id) => {
    if (!categories.value) return '-'
    const c = categories.value.find(x => x.id === id)
    return c ? c.name : '-'
}

const handleSave = async () => {
    const success = await saveProduct()
    if(success) {
        showForm.value = false
        // Ğ”Ğ¾Ğ´Ğ°Ñ”Ğ¼Ğ¾ Ğ¿Ñ€Ğ¸Ğ¼ÑƒÑĞ¾Ğ²Ğµ Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ
        await fetchProducts()}
}

const handleEdit = (product) => {
    prepareEdit(product)
    showForm.value = true
}

// !!! Ğ’ĞĞ–Ğ›Ğ˜Ğ’Ğ: Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ÑƒÑ”Ğ¼Ğ¾ Ğ´Ğ°Ğ½Ñ– Ğ¿Ñ€Ğ¸ ÑÑ‚Ğ°Ñ€Ñ‚Ñ– ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ° !!!
onMounted(async () => {
    console.log("ProductsTab mounted: fetching data...")
    await fetchProducts()
})
</script>

<template>
    <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
        
        <div v-if="showForm" class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 h-fit xl:col-span-1">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-gray-700">
                    {{ isEditing ? 'âœï¸ Ğ ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ' : 'ğŸ“¦ ĞĞ¾Ğ²Ğ¸Ğ¹ Ñ‚Ğ¾Ğ²Ğ°Ñ€' }}
                </h3>
                <button @click="showForm = false; resetForm()" class="text-xs text-red-500 hover:underline">Ğ—Ğ°ĞºÑ€Ğ¸Ñ‚Ğ¸</button>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞĞ°Ğ·Ğ²Ğ°</label>
                    <input v-model="newProduct.name" class="border p-2 rounded w-full focus:ring-2 ring-blue-100 outline-none">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ</label>
                        <select v-model="newProduct.category_id" class="border p-2 rounded w-full bg-white">
                            <option :value="null">-- Ğ‘ĞµĞ· ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ— --</option>
                            <option v-for="c in categories" :key="c.id" :value="c.id">{{ c.name }}</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ğ¦Ñ–Ğ½Ğ°</label>
                        <input v-model.number="newProduct.price" type="number" class="border p-2 rounded w-full">
                    </div>
                </div>

                <div class="flex items-center gap-2 py-2">
                    <input type="checkbox" v-model="newProduct.has_variants" id="hasVar" class="w-4 h-4 text-blue-600">
                    <label for="hasVar" class="text-sm font-bold text-gray-700 select-none">Ğ¦ĞµĞ¹ Ñ‚Ğ¾Ğ²Ğ°Ñ€ Ğ¼Ğ°Ñ” Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸</label>
                </div>

                <div v-if="!newProduct.has_variants" class="bg-gray-50 p-3 rounded border border-gray-200 space-y-3">
                     <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞœĞ°Ğ¹ÑÑ‚ĞµÑ€-Ñ€ĞµÑ†ĞµĞ¿Ñ‚</label>
                        <select v-model="newProduct.master_recipe_id" class="border p-2 rounded w-full bg-white text-sm">
                            <option :value="null">-- Ğ‘ĞµĞ· Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ñƒ --</option>
                            <option v-for="r in recipes" :key="r.id" :value="r.id">{{ r.name }}</option>
                        </select>
                    </div>
                </div>

                <div class="bg-teal-50/50 p-3 rounded border border-teal-100">
                    <label class="text-[10px] uppercase font-bold text-teal-600 mb-2 block">Ğ—Ğ°Ğ³Ğ°Ğ»ÑŒĞ½Ñ– Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸</label>
                    <div class="flex gap-2 mb-2">
                        <select v-model="tempProductConsumable.consumable_id" class="flex-1 border p-1 rounded text-sm bg-white">
                            <option value="">ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»...</option>
                            <option v-for="c in consumables" :key="c.id" :value="c.id">{{ c.name }}</option>
                        </select>
                        <button @click="addProductConsumable" class="bg-teal-500 text-white w-8 rounded">+</button>
                    </div>
                    <div class="flex flex-wrap gap-1">
                        <span v-for="(pc, idx) in newProduct.consumables" :key="idx" class="bg-white border border-teal-200 text-teal-700 text-xs px-2 py-1 rounded">
                            {{ pc.name }} <button @click="removeProductConsumable(idx)" class="text-red-500 font-bold ml-1">&times;</button>
                        </span>
                    </div>
                </div>

                <div v-if="newProduct.has_variants" class="space-y-3">
                    <div class="border-t pt-2 mt-2">
                        <h4 class="font-bold text-sm text-purple-700 mb-2">ĞšĞ¾Ğ½ÑÑ‚Ñ€ÑƒĞºÑ‚Ğ¾Ñ€ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñ–Ğ²</h4>
                        
                        <div class="bg-purple-50 p-3 rounded-lg border border-purple-100 space-y-3">
                            <div class="grid grid-cols-2 gap-2">
                                <input v-model="variantBuilder.name" placeholder="ĞĞ°Ğ·Ğ²Ğ°" class="border p-1.5 rounded text-sm">
                                <input v-model.number="variantBuilder.price" type="number" placeholder="Ğ¦Ñ–Ğ½Ğ°" class="border p-1.5 rounded text-sm">
                            </div>
                            
                            <div class="bg-blue-50/50 p-2 rounded border border-dashed border-blue-200">
                                <label class="text-[10px] uppercase font-bold text-blue-500">Ğ”Ğ¾Ğ´Ğ°Ñ‚ĞºĞ¾Ğ²Ñ– Ñ–Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ğ¸</label>
                                <div class="flex gap-1 mb-1">
                                    <select v-model="tempVariantIngredient.ingredient_id" class="flex-1 border p-1 rounded text-[10px] bg-white h-7">
                                        <option value="">Ğ†Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚...</option>
                                        <option v-for="i in ingredients" :key="i.id" :value="i.id">{{ i.name }}</option>
                                    </select>
                                    <input v-model.number="tempVariantIngredient.quantity" type="number" class="w-10 border p-1 rounded text-[10px] h-7" placeholder="Ğ³">
                                    <button @click="addIngredientToVariant" class="bg-blue-500 text-white w-7 h-7 rounded text-xs">+</button>
                                </div>
                                <div class="flex flex-wrap gap-1">
                                    <span v-for="(vi, idx) in variantBuilder.ingredients" :key="idx" class="bg-white border text-[10px] px-1 rounded text-blue-700">
                                        {{ vi.name }}: {{ vi.quantity }} <button @click="removeIngredientFromVariant(idx)" class="text-red-500 font-bold">&times;</button>
                                    </span>
                                </div>
                            </div>

                            <button @click="addVariant" class="w-full bg-purple-200 text-purple-800 text-xs font-bold py-2 rounded">Ğ”Ğ¾Ğ´Ğ°Ñ‚Ğ¸ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚</button>
                        </div>
                    </div>

                    <div v-if="newProduct.variants.length > 0" class="space-y-2">
                        <div v-for="(v, idx) in newProduct.variants" :key="idx" class="bg-white border p-2 rounded flex justify-between text-sm">
                            <span><b>{{ v.name }}</b> - {{ v.price }} Ğ³Ñ€Ğ½</span>
                            <button @click="removeVariant(idx)" class="text-red-500"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                </div>

                <button @click="handleSave" class="w-full bg-green-600 text-white font-bold py-3 rounded-xl hover:bg-green-700 mt-4">
                    {{ isEditing ? 'Ğ—Ğ±ĞµÑ€ĞµĞ³Ñ‚Ğ¸' : 'Ğ¡Ñ‚Ğ²Ğ¾Ñ€Ğ¸Ñ‚Ğ¸' }}
                </button>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden flex flex-col h-full" :class="showForm ? 'xl:col-span-2' : 'xl:col-span-3'">
            
            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
                <div class="flex items-center gap-4">
                    <h2 class="font-bold text-gray-700">Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ–Ğ²</h2>
                    <input v-model="productSearch" placeholder="ĞŸĞ¾ÑˆÑƒĞº..." class="border rounded px-2 py-1 text-sm">
                </div>
                <button v-if="!showForm" @click="showForm = true; resetForm()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-bold text-sm">
                    + ĞĞ¾Ğ²Ğ¸Ğ¹ Ñ‚Ğ¾Ğ²Ğ°Ñ€
                </button>
            </div>

            <div class="overflow-auto flex-1">
                <table class="w-full text-left text-sm">
                    <thead class="bg-gray-50 text-gray-500 uppercase text-xs sticky top-0">
                        <tr>
                            <th class="p-4">ĞĞ°Ğ·Ğ²Ğ°</th>
                            <th class="p-4">ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ</th>
                            <th class="p-4">Ğ¦Ñ–Ğ½Ğ° / Ğ’Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸</th>
                            <th class="p-4 text-center">Ğ”Ñ–Ñ—</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        <tr v-if="filteredProducts.length === 0">
                            <td colspan="4" class="p-8 text-center text-gray-400">
                                Ğ¢Ğ¾Ğ²Ğ°Ñ€Ñ–Ğ² Ğ½ĞµĞ¼Ğ°Ñ” Ğ°Ğ±Ğ¾ Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ...
                            </td>
                        </tr>
                        <tr v-for="p in filteredProducts" :key="p.id" class="hover:bg-gray-50 align-top">
                            <td class="p-4 font-bold text-gray-800">{{ p.name }}</td>
                            <td class="p-4 text-gray-600">
                                <span class="bg-gray-100 px-2 py-1 rounded text-xs">{{ getCategoryName(p.category_id) }}</span>
                            </td>
                            <td class="p-4">
                                <div v-if="!p.has_variants" class="font-mono font-bold text-green-600">{{ p.price }} â‚´</div>
                                <div v-else class="space-y-1">
                                    <div v-for="v in p.variants" :key="v.id" class="text-xs bg-gray-50 p-1 rounded border">
                                        <b>{{ v.name }}</b>: {{ v.price }} â‚´
                                        <span v-if="v.ingredients?.length" class="text-blue-600 ml-1">
                                            (Ğ†Ğ½Ğ³Ñ€: {{ v.ingredients.length }})
                                        </span>
                                    </div>
                                </div>
                            </td>
                            <td class="p-4 text-center">
                                <button @click="handleEdit(p)" class="text-blue-500 hover:text-blue-700 mx-1"><i class="fas fa-pen"></i></button>
                                <button @click="deleteProduct(p.id)" class="text-red-400 hover:text-red-600 mx-1"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</template>

--------------------------------------------------
PATH: ./.history/frontend/src/components/warehouse/tabs/ProductsTab_20260123212706.vue
--------------------------------------------------
<script setup>
import { ref, onMounted } from 'vue'
import { useWarehouse } from '@/composables/useWarehouse'
import { useProducts } from '@/composables/useProducts'

// ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ğ´Ğ°Ğ½Ñ– Ğ·Ñ– ÑĞºĞ»Ğ°Ğ´Ñƒ (ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ—, Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ğ¸, Ñ–Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ğ¸ Ğ´Ğ»Ñ ÑĞ¿Ğ¸ÑĞºÑ–Ğ²)
const { categories, recipes, ingredients, consumables } = useWarehouse()

// ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ğ»Ğ¾Ğ³Ñ–ĞºÑƒ Ñ€Ğ¾Ğ±Ğ¾Ñ‚Ğ¸ Ğ· Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°Ğ¼Ğ¸
const { 
    newProduct, isEditing, editingId, 
    variantBuilder, tempProductConsumable, tempVariantConsumable, tempVariantIngredient,
    resetForm, prepareEdit, saveProduct, deleteProduct,
    addVariant, removeVariant, 
    addProductConsumable, removeProductConsumable,
    addVariantConsumable, removeVariantConsumable,
    addIngredientToVariant, removeIngredientFromVariant,
    fetchProducts // Ğ¤ÑƒĞ½ĞºÑ†Ñ–Ñ Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ ÑĞ¿Ğ¸ÑĞºÑƒ
} = useProducts()

const showForm = ref(false)

// Ğ¥ĞµĞ»Ğ¿ĞµÑ€ Ğ´Ğ»Ñ ĞºÑ€Ğ°ÑĞ¸Ğ²Ğ¾Ñ— Ğ½Ğ°Ğ·Ğ²Ğ¸ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ—
const getCategoryName = (id) => {
    const c = categories.value.find(x => x.id === id)
    return c ? c.name : '-'
}

// ĞĞ±Ñ€Ğ¾Ğ±ĞºĞ° Ğ·Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ½Ñ
const handleSave = async () => {
    const success = await saveProduct()
    if(success) showForm.value = false
}

// ĞĞ±Ñ€Ğ¾Ğ±ĞºĞ° Ñ€ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ
const handleEdit = (product) => {
    prepareEdit(product)
    showForm.value = true
}

// Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ¿Ñ€Ğ¸ ÑÑ‚Ğ°Ñ€Ñ‚Ñ–
onMounted(async () => {
    await fetchProducts()
})
</script>

<template>
    <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
        
        <div v-if="showForm" class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 h-fit xl:col-span-1">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-gray-700">
                    {{ isEditing ? 'âœï¸ Ğ ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ' : 'ğŸ“¦ ĞĞ¾Ğ²Ğ¸Ğ¹ Ñ‚Ğ¾Ğ²Ğ°Ñ€' }}
                </h3>
                <button @click="showForm = false; resetForm()" class="text-xs text-red-500 hover:underline">Ğ—Ğ°ĞºÑ€Ğ¸Ñ‚Ğ¸</button>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞĞ°Ğ·Ğ²Ğ°</label>
                    <input v-model="newProduct.name" class="border p-2 rounded w-full focus:ring-2 ring-blue-100 outline-none">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ</label>
                        <select v-model="newProduct.category_id" class="border p-2 rounded w-full bg-white">
                            <option :value="null">-- Ğ‘ĞµĞ· ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ— --</option>
                            <option v-for="c in categories" :key="c.id" :value="c.id">{{ c.name }}</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ğ¦Ñ–Ğ½Ğ° (Ğ±Ğ°Ğ·Ğ¾Ğ²Ğ°)</label>
                        <input v-model.number="newProduct.price" type="number" class="border p-2 rounded w-full">
                    </div>
                </div>

                <div class="flex items-center gap-2 py-2">
                    <input type="checkbox" v-model="newProduct.has_variants" id="hasVar" class="w-4 h-4 text-blue-600">
                    <label for="hasVar" class="text-sm font-bold text-gray-700 select-none">Ğ¦ĞµĞ¹ Ñ‚Ğ¾Ğ²Ğ°Ñ€ Ğ¼Ğ°Ñ” Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸ (Ñ€Ğ¾Ğ·Ğ¼Ñ–Ñ€Ğ¸)</label>
                </div>

                <div v-if="!newProduct.has_variants" class="bg-gray-50 p-3 rounded border border-gray-200 space-y-3">
                     <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞœĞ°Ğ¹ÑÑ‚ĞµÑ€-Ñ€ĞµÑ†ĞµĞ¿Ñ‚</label>
                        <select v-model="newProduct.master_recipe_id" class="border p-2 rounded w-full bg-white text-sm">
                            <option :value="null">-- Ğ‘ĞµĞ· Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ñƒ --</option>
                            <option v-for="r in recipes" :key="r.id" :value="r.id">{{ r.name }}</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ğ’Ğ¸Ñ…Ñ–Ğ´Ğ½Ğ° Ğ²Ğ°Ğ³Ğ° (Ğ³/Ğ¼Ğ»)</label>
                        <input v-model.number="newProduct.output_weight" type="number" class="border p-2 rounded w-full text-sm">
                    </div>
                </div>

                <div class="bg-teal-50/50 p-3 rounded border border-teal-100">
                    <label class="text-[10px] uppercase font-bold text-teal-600 mb-2 block">Ğ—Ğ°Ğ³Ğ°Ğ»ÑŒĞ½Ñ– Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸</label>
                    <div class="flex gap-2 mb-2">
                        <select v-model="tempProductConsumable.consumable_id" class="flex-1 border p-1 rounded text-sm bg-white">
                            <option value="">ĞĞ±ĞµÑ€Ñ–Ñ‚ÑŒ Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»...</option>
                            <option v-for="c in consumables" :key="c.id" :value="c.id">{{ c.name }}</option>
                        </select>
                        <input v-model.number="tempProductConsumable.quantity" type="number" class="w-16 border p-1 rounded text-sm" placeholder="Ğš-ÑÑ‚ÑŒ">
                        <button @click="addProductConsumable" class="bg-teal-500 text-white w-8 rounded hover:bg-teal-600">+</button>
                    </div>
                    <div class="flex flex-wrap gap-1">
                        <span v-for="(pc, idx) in newProduct.consumables" :key="idx" class="bg-white border border-teal-200 text-teal-700 text-xs px-2 py-1 rounded flex items-center gap-1">
                            {{ pc.name }}: {{ pc.quantity }}
                            <button @click="removeProductConsumable(idx)" class="text-red-400 font-bold ml-1 hover:text-red-600">&times;</button>
                        </span>
                    </div>
                </div>

                <div v-if="newProduct.has_variants" class="space-y-3">
                    <div class="border-t pt-2 mt-2">
                        <h4 class="font-bold text-sm text-purple-700 mb-2">Ğ”Ğ¾Ğ´Ğ°Ñ‚Ğ¸ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚</h4>
                        
                        <div class="bg-purple-50 p-3 rounded-lg border border-purple-100 space-y-3">
                            <div class="grid grid-cols-2 gap-2">
                                <input v-model="variantBuilder.name" placeholder="ĞĞ°Ğ·Ğ²Ğ° (Ğ½Ğ°Ğ¿Ñ€. Ğ’ĞµĞ»Ğ¸ĞºĞ¸Ğ¹)" class="border p-1.5 rounded text-sm">
                                <input v-model.number="variantBuilder.price" type="number" placeholder="Ğ¦Ñ–Ğ½Ğ°" class="border p-1.5 rounded text-sm">
                            </div>
                            
                            <div class="grid grid-cols-2 gap-2">
                                <select v-model="variantBuilder.master_recipe_id" class="border p-1.5 rounded text-sm bg-white">
                                    <option :value="null">Ğ ĞµÑ†ĞµĞ¿Ñ‚...</option>
                                    <option v-for="r in recipes" :key="r.id" :value="r.id">{{ r.name }}</option>
                                </select>
                                <input v-model.number="variantBuilder.output_weight" type="number" placeholder="Ğ’Ğ°Ğ³Ğ° Ğ¿Ğ¾Ñ€Ñ†Ñ–Ñ—" class="border p-1.5 rounded text-sm">
                            </div>

                            <div class="bg-white/50 p-2 rounded border border-dashed border-purple-200">
                                <label class="text-[10px] uppercase font-bold text-purple-400">ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ</label>
                                <div class="flex gap-1 mb-1">
                                    <select v-model="tempVariantConsumable.consumable_id" class="flex-1 border p-1 rounded text-[10px] bg-white h-7">
                                        <option value="">ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»...</option>
                                        <option v-for="c in consumables" :key="c.id" :value="c.id">{{ c.name }}</option>
                                    </select>
                                    <input v-model.number="tempVariantConsumable.quantity" type="number" class="w-10 border p-1 rounded text-[10px] h-7" placeholder="Ğš-ÑÑ‚ÑŒ">
                                    <button @click="addVariantConsumable" class="bg-purple-500 text-white w-7 h-7 rounded hover:bg-purple-600 text-xs">+</button>
                                </div>
                                <div class="flex flex-wrap gap-1">
                                    <span v-for="(vc, idx) in variantBuilder.consumables" :key="idx" class="bg-white border text-[10px] px-1 rounded flex items-center gap-1">
                                        {{ vc.name }}: {{ vc.quantity }} <button @click="removeVariantConsumable(idx)" class="text-red-500 font-bold">&times;</button>
                                    </span>
                                </div>
                            </div>

                            <div class="bg-blue-50/50 p-2 rounded border border-dashed border-blue-200">
                                <label class="text-[10px] uppercase font-bold text-blue-500">Ğ”Ğ¾Ğ´Ğ°Ñ‚ĞºĞ¾Ğ²Ñ– Ñ–Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ğ¸</label>
                                <div class="flex gap-1 mb-1">
                                    <select v-model="tempVariantIngredient.ingredient_id" class="flex-1 border p-1 rounded text-[10px] bg-white h-7">
                                        <option value="">Ğ†Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚...</option>
                                        <option v-for="i in ingredients" :key="i.id" :value="i.id">{{ i.name }}</option>
                                    </select>
                                    <input v-model.number="tempVariantIngredient.quantity" type="number" class="w-10 border p-1 rounded text-[10px] h-7" placeholder="Ğ“Ñ€Ğ°Ğ¼">
                                    <button @click="addIngredientToVariant" class="bg-blue-500 text-white w-7 h-7 rounded hover:bg-blue-600 text-xs">+</button>
                                </div>
                                <div class="flex flex-wrap gap-1">
                                    <span v-for="(vi, idx) in variantBuilder.ingredients" :key="idx" class="bg-white border text-[10px] px-1 rounded flex items-center gap-1 text-blue-700">
                                        {{ vi.name }}: {{ vi.quantity }} <button @click="removeIngredientFromVariant(idx)" class="text-red-500 font-bold">&times;</button>
                                    </span>
                                </div>
                            </div>

                            <button @click="addVariant" class="w-full bg-purple-200 text-purple-800 text-xs font-bold py-2 rounded hover:bg-purple-300">
                                Ğ”Ğ¾Ğ´Ğ°Ñ‚Ğ¸ Ñ†ĞµĞ¹ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚ Ñƒ ÑĞ¿Ğ¸ÑĞ¾Ğº
                            </button>
                        </div>
                    </div>

                    <div v-if="newProduct.variants.length > 0" class="space-y-2">
                        <div v-for="(v, idx) in newProduct.variants" :key="idx" class="bg-white border p-2 rounded flex justify-between items-center text-sm">
                            <div>
                                <span class="font-bold">{{ v.name }}</span> - {{ v.price }} Ğ³Ñ€Ğ½
                                <div class="text-xs text-gray-400">
                                    <span v-if="v.consumables.length">ĞœĞ°Ñ‚: {{ v.consumables.length }}</span>
                                    <span v-if="v.ingredients.length" class="ml-2 text-blue-600">Ğ†Ğ½Ğ³: {{ v.ingredients.length }}</span>
                                </div>
                            </div>
                            <button @click="removeVariant(idx)" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                </div>

                <button @click="handleSave" class="w-full bg-green-600 text-white font-bold py-3 rounded-xl hover:bg-green-700 shadow-lg shadow-green-100 mt-4">
                    {{ isEditing ? 'Ğ—Ğ±ĞµÑ€ĞµĞ³Ñ‚Ğ¸ Ğ·Ğ¼Ñ–Ğ½Ğ¸' : 'Ğ¡Ñ‚Ğ²Ğ¾Ñ€Ğ¸Ñ‚Ğ¸ Ñ‚Ğ¾Ğ²Ğ°Ñ€' }}
                </button>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden flex flex-col h-full" :class="showForm ? 'xl:col-span-2' : 'xl:col-span-3'">
            
            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
                <h2 class="font-bold text-gray-700">Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ–Ğ²</h2>
                <button v-if="!showForm" @click="showForm = true; resetForm()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-bold text-sm shadow-lg shadow-blue-100">
                    + ĞĞ¾Ğ²Ğ¸Ğ¹ Ñ‚Ğ¾Ğ²Ğ°Ñ€
                </button>
            </div>

            <div class="overflow-auto flex-1">
                <table class="w-full text-left text-sm">
                    <thead class="bg-gray-50 text-gray-500 uppercase text-xs sticky top-0">
                        <tr>
                            <th class="p-4">ĞĞ°Ğ·Ğ²Ğ°</th>
                            <th class="p-4">ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ</th>
                            <th class="p-4">Ğ¦Ñ–Ğ½Ğ° / Ğ’Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸</th>
                            <th class="p-4">Ğ ĞµÑ†ĞµĞ¿Ñ‚ / Ğ¡ĞºĞ»Ğ°Ğ´</th>
                            <th class="p-4 text-center">Ğ”Ñ–Ñ—</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        <tr v-if="!useWarehouse().products.value.length">
                            <td colspan="5" class="p-8 text-center text-gray-400">Ğ¢Ğ¾Ğ²Ğ°Ñ€Ñ–Ğ² Ñ‰Ğµ Ğ½ĞµĞ¼Ğ°Ñ” (Ğ°Ğ±Ğ¾ Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ...)</td>
                        </tr>
                        <tr v-for="p in useWarehouse().products.value" :key="p.id" class="hover:bg-gray-50 group align-top">
                            <td class="p-4 font-bold text-gray-800">{{ p.name }}</td>
                            <td class="p-4 text-gray-600">
                                <span class="bg-gray-100 px-2 py-1 rounded text-xs">{{ getCategoryName(p.category_id) }}</span>
                            </td>
                            
                            <td class="p-4">
                                <div v-if="!p.has_variants" class="font-mono font-bold text-lg text-green-600">
                                    {{ p.price }} â‚´
                                </div>
                                <div v-else class="space-y-1">
                                    <div v-for="v in p.variants" :key="v.id" class="text-xs bg-gray-50 p-1.5 rounded border border-gray-200">
                                        <div class="flex justify-between font-bold text-gray-700 mb-1">
                                            <span>{{ v.name }}</span>
                                            <span>{{ v.price }} â‚´</span>
                                        </div>
                                        
                                        <div v-if="v.consumables && v.consumables.length > 0" class="flex flex-wrap gap-1 mb-1">
                                            <span v-for="c in v.consumables" :key="c.consumable_id" class="bg-teal-50 text-teal-700 px-1 rounded border border-teal-100 text-[10px]">
                                                ğŸ“¦ {{ c.consumable_name || 'ĞœĞ°Ñ‚' }}: {{ c.quantity }}
                                            </span>
                                        </div>

                                        <div v-if="v.ingredients && v.ingredients.length > 0" class="flex flex-wrap gap-1">
                                            <span v-for="i in v.ingredients" :key="i.ingredient_id" class="bg-blue-50 text-blue-700 px-1 rounded border border-blue-100 text-[10px]">
                                                ğŸ’§ {{ i.ingredient_name || 'Ğ†Ğ½Ğ³Ñ€' }}: {{ i.quantity }}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </td>

                            <td class="p-4 text-xs">
                                <div v-if="p.master_recipe" class="text-purple-600 font-bold mb-1">
                                    ğŸ“œ {{ p.master_recipe.name }}
                                </div>
                                <div v-if="p.consumables && p.consumables.length > 0" class="flex flex-wrap gap-1">
                                    <span v-for="c in p.consumables" :key="c.consumable_id" class="bg-orange-50 text-orange-700 px-1 rounded border border-orange-100 text-[10px]">
                                        + {{ c.consumable_name }}: {{ c.quantity }}
                                    </span>
                                </div>
                            </td>

                            <td class="p-4 text-center">
                                <div class="flex justify-center gap-2">
                                    <button @click="handleEdit(p)" class="text-blue-400 hover:text-blue-600 p-2 rounded hover:bg-blue-50"><i class="fas fa-pen"></i></button>
                                    <button @click="deleteProduct(p.id)" class="text-gray-300 hover:text-red-500 p-2 rounded hover:bg-red-50"><i class="fas fa-trash"></i></button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</template>

--------------------------------------------------
PATH: ./.history/frontend/src/components/warehouse/tabs/ProductsTab_20260125113604.vue
--------------------------------------------------
<script setup>
import { ref, onMounted } from 'vue'
import { useWarehouse } from '@/composables/useWarehouse'
import { useProducts } from '@/composables/useProducts'

// ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ğ´Ğ¾Ğ²Ñ–Ğ´Ğ½Ğ¸ĞºĞ¸ (ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ—, Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ğ¸ Ñ‚Ğ¾Ñ‰Ğ¾)
const { categories, recipes, ingredients, consumables } = useWarehouse()

// ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ñ„ÑƒĞ½ĞºÑ†Ñ–Ğ¾Ğ½Ğ°Ğ» Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ–Ğ²
const { 
    newProduct, isEditing, 
    variantBuilder, tempProductConsumable, tempVariantConsumable, tempVariantIngredient,
    resetForm, prepareEdit, saveProduct, deleteProduct, fetchProducts, filteredProducts, productSearch,
    addVariant, removeVariant, 
    addProductConsumable, removeProductConsumable,
    addVariantConsumable, removeVariantConsumable,
    addIngredientToVariant, removeIngredientFromVariant
} = useProducts()

const showForm = ref(false)

const getCategoryName = (id) => {
    if (!categories.value) return '-'
    const c = categories.value.find(x => x.id === id)
    return c ? c.name : '-'
}

const handleSave = async () => {
    const success = await saveProduct()
    if(success) {
        showForm.value = false
        // Ğ”Ğ¾Ğ´Ğ°Ñ”Ğ¼Ğ¾ Ğ¿Ñ€Ğ¸Ğ¼ÑƒÑĞ¾Ğ²Ğµ Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ ÑĞ¿Ğ¸ÑĞºÑƒ
        await fetchProducts()
    }
}

const handleEdit = (product) => {
    prepareEdit(product)
    showForm.value = true
}

// !!! Ğ’ĞĞ–Ğ›Ğ˜Ğ’Ğ: Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ÑƒÑ”Ğ¼Ğ¾ Ğ´Ğ°Ğ½Ñ– Ğ¿Ñ€Ğ¸ ÑÑ‚Ğ°Ñ€Ñ‚Ñ– ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ° !!!
onMounted(async () => {
    console.log("ProductsTab mounted: fetching data...")
    await fetchProducts()
})
</script>

<template>
    <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
        
        <div v-if="showForm" class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 h-fit xl:col-span-1">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-gray-700">
                    {{ isEditing ? 'âœï¸ Ğ ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ' : 'ğŸ“¦ ĞĞ¾Ğ²Ğ¸Ğ¹ Ñ‚Ğ¾Ğ²Ğ°Ñ€' }}
                </h3>
                <button @click="showForm = false; resetForm()" class="text-xs text-red-500 hover:underline">Ğ—Ğ°ĞºÑ€Ğ¸Ñ‚Ğ¸</button>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞĞ°Ğ·Ğ²Ğ°</label>
                    <input v-model="newProduct.name" class="border p-2 rounded w-full focus:ring-2 ring-blue-100 outline-none">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ</label>
                        <select v-model="newProduct.category_id" class="border p-2 rounded w-full bg-white">
                            <option :value="null">-- Ğ‘ĞµĞ· ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ— --</option>
                            <option v-for="c in categories" :key="c.id" :value="c.id">{{ c.name }}</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ğ¦Ñ–Ğ½Ğ° (Ğ±Ğ°Ğ·Ğ¾Ğ²Ğ°)</label>
                        <input v-model.number="newProduct.price" type="number" class="border p-2 rounded w-full">
                    </div>
                </div>

                <div class="flex items-center gap-2 py-2">
                    <input type="checkbox" v-model="newProduct.has_variants" id="hasVar" class="w-4 h-4 text-blue-600">
                    <label for="hasVar" class="text-sm font-bold text-gray-700 select-none">Ğ¦ĞµĞ¹ Ñ‚Ğ¾Ğ²Ğ°Ñ€ Ğ¼Ğ°Ñ” Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸</label>
                </div>

                <div v-if="!newProduct.has_variants" class="bg-gray-50 p-3 rounded border border-gray-200 space-y-3">
                     <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞœĞ°Ğ¹ÑÑ‚ĞµÑ€-Ñ€ĞµÑ†ĞµĞ¿Ñ‚</label>
                        <select v-model="newProduct.master_recipe_id" class="border p-2 rounded w-full bg-white text-sm">
                            <option :value="null">-- Ğ‘ĞµĞ· Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ñƒ --</option>
                            <option v-for="r in recipes" :key="r.id" :value="r.id">{{ r.name }}</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ğ’Ğ¸Ñ…Ñ–Ğ´Ğ½Ğ° Ğ²Ğ°Ğ³Ğ° (Ğ³/Ğ¼Ğ»)</label>
                        <input v-model.number="newProduct.output_weight" type="number" class="border p-2 rounded w-full text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞŸĞ¾Ñ‡Ğ°Ñ‚ĞºĞ¾Ğ²Ğ¸Ğ¹ Ğ·Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº</label>
                        <input v-model.number="newProduct.stock_quantity" type="number" class="border p-2 rounded w-full text-sm" placeholder="0">
                    </div>
                </div>

                <div class="bg-teal-50/50 p-3 rounded border border-teal-100">
                    <label class="text-[10px] uppercase font-bold text-teal-600 mb-2 block">Ğ—Ğ°Ğ³Ğ°Ğ»ÑŒĞ½Ñ– Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸</label>
                    <div class="flex gap-2 mb-2">
                        <select v-model="tempProductConsumable.consumable_id" class="flex-1 border p-1 rounded text-sm bg-white">
                            <option value="">ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»...</option>
                            <option v-for="c in consumables" :key="c.id" :value="c.id">{{ c.name }}</option>
                        </select>
                        <button @click="addProductConsumable" class="bg-teal-500 text-white w-8 rounded hover:bg-teal-600">+</button>
                    </div>
                    <div class="flex flex-wrap gap-1">
                        <span v-for="(pc, idx) in newProduct.consumables" :key="idx" class="bg-white border border-teal-200 text-teal-700 text-xs px-2 py-1 rounded flex items-center gap-1">
                            {{ pc.name }} <button @click="removeProductConsumable(idx)" class="text-red-500 font-bold ml-1">&times;</button>
                        </span>
                    </div>
                </div>

                <div v-if="newProduct.has_variants" class="space-y-3">
                    <div class="border-t pt-2 mt-2">
                        <h4 class="font-bold text-sm text-purple-700 mb-2">ĞšĞ¾Ğ½ÑÑ‚Ñ€ÑƒĞºÑ‚Ğ¾Ñ€ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñ–Ğ²</h4>
                        
                        <div class="bg-purple-50 p-3 rounded-lg border border-purple-100 space-y-3">
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="text-[10px] uppercase font-bold text-gray-500">ĞĞ°Ğ·Ğ²Ğ°</label>
                                    <input v-model="variantBuilder.name" placeholder="Ğ½Ğ°Ğ¿Ñ€. XL" class="w-full border p-1.5 rounded text-sm">
                                </div>
                                <div>
                                    <label class="text-[10px] uppercase font-bold text-gray-500">Ğ¦Ñ–Ğ½Ğ°</label>
                                    <input v-model.number="variantBuilder.price" type="number" class="w-full border p-1.5 rounded text-sm">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="text-[10px] uppercase font-bold text-gray-500">Ğ¢ĞµÑ…. ĞºĞ°Ñ€Ñ‚Ğ° (Ğ ĞµÑ†ĞµĞ¿Ñ‚)</label>
                                    <select v-model="variantBuilder.master_recipe_id" class="w-full border p-1.5 rounded text-sm bg-white">
                                        <option :value="null">-- Ğ‘ĞµĞ· Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ñƒ --</option>
                                        <option v-for="r in recipes" :key="r.id" :value="r.id">{{ r.name }}</option>
                                    </select>
                                    <p v-if="!recipes || recipes.length === 0" class="text-[10px] text-red-500 mt-1">Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ñ–Ğ² Ğ¿ÑƒÑÑ‚Ğ¸Ğ¹!</p>
                                </div>
                                <div>
                                    <label class="text-[10px] uppercase font-bold text-gray-500">Ğ’Ğ°Ğ³Ğ° Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¾Ğ³Ğ¾ (Ğ³/Ğ¼Ğ»)</label>
                                    <input v-model.number="variantBuilder.output_weight" type="number" class="w-full border p-1.5 rounded text-sm">
                                </div>
                            </div>
                            
                            <div>
                                <label class="text-[10px] uppercase font-bold text-gray-500">ĞŸĞ¾Ñ‡Ğ°Ñ‚ĞºĞ¾Ğ²Ğ¸Ğ¹ Ğ·Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº (ÑˆÑ‚)</label>
                                <input v-model.number="variantBuilder.stock_quantity" type="number" class="w-full border p-1.5 rounded text-sm bg-white" placeholder="0">
                            </div>

                            <div class="bg-white/50 p-2 rounded border border-dashed border-purple-200">
                                <label class="text-[10px] uppercase font-bold text-purple-400">ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ</label>
                                <div class="flex gap-1 mb-1">
                                    <select v-model="tempVariantConsumable.consumable_id" class="flex-1 border p-1 rounded text-[10px] bg-white h-7">
                                        <option value="">ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»...</option>
                                        <option v-for="c in consumables" :key="c.id" :value="c.id">{{ c.name }}</option>
                                    </select>
                                    <input v-model.number="tempVariantConsumable.quantity" type="number" class="w-10 border p-1 rounded text-[10px] h-7" placeholder="Ğš-ÑÑ‚ÑŒ">
                                    <button @click="addVariantConsumable" class="bg-purple-500 text-white w-7 h-7 rounded hover:bg-purple-600 text-xs">+</button>
                                </div>
                                <div class="flex flex-wrap gap-1">
                                    <span v-for="(vc, idx) in variantBuilder.consumables" :key="idx" class="bg-white border text-[10px] px-1 rounded flex items-center gap-1">
                                        {{ vc.name }}: {{ vc.quantity }} <button @click="removeVariantConsumable(idx)" class="text-red-500 font-bold">&times;</button>
                                    </span>
                                </div>
                            </div>

                            <div class="bg-blue-50/50 p-2 rounded border border-dashed border-blue-200">
                                <label class="text-[10px] uppercase font-bold text-blue-500">Ğ”Ğ¾Ğ´Ğ°Ñ‚ĞºĞ¾Ğ²Ñ– Ñ–Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ğ¸</label>
                                <div class="flex gap-1 mb-1">
                                    <select v-model="tempVariantIngredient.ingredient_id" class="flex-1 border p-1 rounded text-[10px] bg-white h-7">
                                        <option value="">Ğ†Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚...</option>
                                        <option v-for="i in ingredients" :key="i.id" :value="i.id">{{ i.name }}</option>
                                    </select>
                                    <input v-model.number="tempVariantIngredient.quantity" type="number" class="w-10 border p-1 rounded text-[10px] h-7" placeholder="Ğ“Ñ€Ğ°Ğ¼">
                                    <button @click="addIngredientToVariant" class="bg-blue-500 text-white w-7 h-7 rounded hover:bg-blue-600 text-xs">+</button>
                                </div>
                                <div class="flex flex-wrap gap-1">
                                    <span v-for="(vi, idx) in variantBuilder.ingredients" :key="idx" class="bg-white border text-[10px] px-1 rounded flex items-center gap-1 text-blue-700">
                                        {{ vi.name }}: {{ vi.quantity }} <button @click="removeIngredientFromVariant(idx)" class="text-red-500 font-bold">&times;</button>
                                    </span>
                                </div>
                            </div>

                            <button @click="addVariant" class="w-full bg-purple-200 text-purple-800 text-xs font-bold py-2 rounded hover:bg-purple-300">
                                Ğ”Ğ¾Ğ´Ğ°Ñ‚Ğ¸ Ñ†ĞµĞ¹ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚ Ñƒ ÑĞ¿Ğ¸ÑĞ¾Ğº
                            </button>
                        </div>
                    </div>
                    
                    <div v-if="newProduct.variants.length > 0" class="space-y-2">
                        <div v-for="(v, idx) in newProduct.variants" :key="idx" class="bg-white border p-2 rounded flex justify-between items-center text-sm">
                            <div>
                                <span class="font-bold">{{ v.name }}</span> - {{ v.price }} Ğ³Ñ€Ğ½
                                <div class="text-xs text-gray-400">
                                    <span v-if="v.master_recipe_id" class="text-purple-600 mr-2">ğŸ“œ Ğ ĞµÑ†ĞµĞ¿Ñ‚ ID: {{ v.master_recipe_id }}</span>
                                    <span v-if="v.stock_quantity > 0" class="text-green-600 font-bold">Ğ—Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº: {{ v.stock_quantity }}</span>
                                    <span v-if="v.ingredients?.length" class="text-blue-500 ml-2">Ğ†Ğ½Ğ³Ñ€: {{ v.ingredients.length }}</span>
                                </div>
                            </div>
                            <button @click="removeVariant(idx)" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                </div>

                <button @click="handleSave" class="w-full bg-green-600 text-white font-bold py-3 rounded-xl hover:bg-green-700 mt-4 shadow-lg shadow-green-100">
                    {{ isEditing ? 'Ğ—Ğ±ĞµÑ€ĞµĞ³Ñ‚Ğ¸ Ğ·Ğ¼Ñ–Ğ½Ğ¸' : 'Ğ¡Ñ‚Ğ²Ğ¾Ñ€Ğ¸Ñ‚Ğ¸ Ñ‚Ğ¾Ğ²Ğ°Ñ€' }}
                </button>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden flex flex-col h-full" :class="showForm ? 'xl:col-span-2' : 'xl:col-span-3'">
            
            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
                <div class="flex items-center gap-4">
                    <h2 class="font-bold text-gray-700">Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ–Ğ²</h2>
                    <input v-model="productSearch" placeholder="ĞŸĞ¾ÑˆÑƒĞº..." class="border rounded px-2 py-1 text-sm bg-white">
                </div>
                <button v-if="!showForm" @click="showForm = true; resetForm()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-bold text-sm shadow-md shadow-blue-100">
                    + ĞĞ¾Ğ²Ğ¸Ğ¹ Ñ‚Ğ¾Ğ²Ğ°Ñ€
                </button>
            </div>

            <div class="overflow-auto flex-1">
                <table class="w-full text-left text-sm">
                    <thead class="bg-gray-50 text-gray-500 uppercase text-xs sticky top-0">
                        <tr>
                            <th class="p-4">ĞĞ°Ğ·Ğ²Ğ°</th>
                            <th class="p-4">ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ</th>
                            <th class="p-4">Ğ¦Ñ–Ğ½Ğ° / Ğ’Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸</th>
                            <th class="p-4 text-center">Ğ”Ñ–Ñ—</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        <tr v-if="filteredProducts.length === 0">
                            <td colspan="4" class="p-8 text-center text-gray-400">
                                Ğ¢Ğ¾Ğ²Ğ°Ñ€Ñ–Ğ² Ğ½ĞµĞ¼Ğ°Ñ” Ğ°Ğ±Ğ¾ Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ...
                            </td>
                        </tr>
                        <tr v-for="p in filteredProducts" :key="p.id" class="hover:bg-gray-50 align-top group">
                            <td class="p-4 font-bold text-gray-800">{{ p.name }}</td>
                            <td class="p-4 text-gray-600">
                                <span class="bg-gray-100 px-2 py-1 rounded text-xs">{{ getCategoryName(p.category_id) }}</span>
                            </td>
                            <td class="p-4">
                                <div v-if="!p.has_variants" class="font-mono font-bold text-green-600">{{ p.price }} â‚´</div>
                                <div v-else class="space-y-1">
                                    <div v-for="v in p.variants" :key="v.id" class="text-xs bg-gray-50 p-1 rounded border border-gray-200">
                                        <b>{{ v.name }}</b>: {{ v.price }} â‚´
                                        <span v-if="v.ingredients?.length" class="text-blue-600 ml-1">
                                            (Ğ†Ğ½Ğ³Ñ€: {{ v.ingredients.length }})
                                        </span>
                                    </div>
                                </div>
                            </td>
                            <td class="p-4 text-center">
                                <div class="flex justify-center gap-2">
                                    <button @click="handleEdit(p)" class="text-blue-500 hover:text-blue-700 p-1.5 hover:bg-blue-50 rounded"><i class="fas fa-pen"></i></button>
                                    <button @click="deleteProduct(p.id)" class="text-red-400 hover:text-red-600 p-1.5 hover:bg-red-50 rounded"><i class="fas fa-trash"></i></button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</template>

--------------------------------------------------
PATH: ./.history/frontend/src/components/warehouse/tabs/StockTab_20260125195932.vue
--------------------------------------------------
<script setup>
import { ref, computed, onMounted } from 'vue'
import { useWarehouse } from '@/composables/useWarehouse'
import axios from 'axios' // ĞŸĞ¾Ñ‚Ñ€Ñ–Ğ±ĞµĞ½ Ğ´Ğ»Ñ PATCH Ğ·Ğ°Ğ¿Ğ¸Ñ‚Ñ–Ğ²

// ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ğ´Ğ°Ğ½Ñ– Ğ·Ñ– ÑÑ…Ğ¾Ğ²Ğ¸Ñ‰Ğ°
const { ingredients, consumables, products, fetchWarehouseData } = useWarehouse()

const activeTab = ref('ingredients') // 'ingredients', 'consumables', 'products'
const search = ref('')
const loading = ref(false)

// Ğ—Ğ¼Ñ–Ğ½Ğ½Ñ– Ğ´Ğ»Ñ Ñ€ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ
const editingItem = ref(null)
const editValue = ref(0)

// --- Ğ“ĞĞ›ĞĞ’ĞĞ ĞœĞĞ“Ğ†Ğ¯: ĞŸĞ»Ğ¾ÑĞºĞ¸Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ´Ğ»Ñ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ– ---
const filteredItems = computed(() => {
    let list = []

    // 1. Ğ¡Ğ˜Ğ ĞĞ’Ğ˜ĞĞ
    if (activeTab.value === 'ingredients') {
        list = ingredients.value.map(i => ({ 
            ...i, 
            type: 'ingredient', 
            display_name: i.name,
            unit_symbol: i.unit?.symbol || '' 
        }))
    } 
    // 2. ĞœĞĞ¢Ğ•Ğ Ğ†ĞĞ›Ğ˜
    else if (activeTab.value === 'consumables') {
        list = consumables.value.map(c => ({ 
            ...c, 
            type: 'consumable', 
            display_name: c.name,
            unit_symbol: c.unit?.symbol || ''
        }))
    } 
    // 3. Ğ¢ĞĞ’ĞĞ Ğ˜ (Ğ Ğ¾Ğ·Ğ³Ğ¾Ñ€Ñ‚Ğ°Ñ”Ğ¼Ğ¾ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸!)
    else if (activeTab.value === 'products') {
        products.value.forEach(p => {
            if (p.has_variants && p.variants) {
                // Ğ¯ĞºÑ‰Ğ¾ Ñ” Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸ -> Ğ´Ğ¾Ğ´Ğ°Ñ”Ğ¼Ğ¾ ĞºĞ¾Ğ¶ĞµĞ½ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚ ÑĞº Ğ¾ĞºÑ€ĞµĞ¼Ğ¸Ğ¹ Ñ€ÑĞ´Ğ¾Ğº
                p.variants.forEach(v => {
                    list.push({
                        id: v.id, // ID Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ
                        original_id: v.id,
                        type: 'product_variant', // Ğ¢Ğ¸Ğ¿ Ğ´Ğ»Ñ Ñ€Ğ¾Ğ·Ñ€Ñ–Ğ·Ğ½ĞµĞ½Ğ½Ñ
                        display_name: `${p.name} (${v.name})`, // ĞĞ°Ğ·Ğ²Ğ°: ĞšĞ°Ğ²Ğ° (XL)
                        stock_quantity: v.stock_quantity,
                        unit_symbol: 'ÑˆÑ‚',
                        product_id: p.id // ĞŸĞ¾ÑĞ¸Ğ»Ğ°Ğ½Ğ½Ñ Ğ½Ğ° Ğ±Ğ°Ñ‚ÑŒĞºĞ° (Ğ¿Ñ€Ğ¾ Ğ²ÑÑĞº Ğ²Ğ¸Ğ¿Ğ°Ğ´Ğ¾Ğº)
                    })
                })
            } else {
                // Ğ¯ĞºÑ‰Ğ¾ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¸Ğ¹ Ñ‚Ğ¾Ğ²Ğ°Ñ€ -> Ğ´Ğ¾Ğ´Ğ°Ñ”Ğ¼Ğ¾ ÑĞº Ñ”
                list.push({
                    id: p.id,
                    original_id: p.id,
                    type: 'product',
                    display_name: p.name,
                    stock_quantity: p.stock_quantity,
                    unit_symbol: 'ÑˆÑ‚'
                })
            }
        })
    }

    // Ğ¤Ñ–Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ñ–Ñ Ğ¿Ğ¾ÑˆÑƒĞºÑƒ
    if (search.value) {
        const s = search.value.toLowerCase()
        return list.filter(i => i.display_name.toLowerCase().includes(s))
    }
    return list
})

// --- Ğ›ĞĞ“Ğ†ĞšĞ Ğ Ğ•Ğ”ĞĞ“Ğ£Ğ’ĞĞĞĞ¯ ---
const startEdit = (item) => {
    editingItem.value = item.id // Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ ID Ğ´Ğ»Ñ Ñ–Ğ´ĞµĞ½Ñ‚Ğ¸Ñ„Ñ–ĞºĞ°Ñ†Ñ–Ñ—
    editValue.value = item.stock_quantity
}

const saveEdit = async (item) => {
    if (editValue.value < 0) return alert("ĞĞµ Ğ¼Ğ¾Ğ¶Ğµ Ğ±ÑƒÑ‚Ğ¸ Ğ¼Ñ–Ğ½ÑƒÑĞ¾Ğ²Ğ¸Ğ¼")
    
    loading.value = true
    try {
        let url = ''
        let payload = {}
        let method = 'put' // Ğ—Ğ° Ğ·Ğ°Ğ¼Ğ¾Ğ²Ñ‡ÑƒĞ²Ğ°Ğ½Ğ½ÑĞ¼

        // Ğ’Ğ¸Ğ·Ğ½Ğ°Ñ‡Ğ°Ñ”Ğ¼Ğ¾ URL Ñ– ĞœĞµÑ‚Ğ¾Ğ´ Ğ·Ğ°Ğ»ĞµĞ¶Ğ½Ğ¾ Ğ²Ñ–Ğ´ Ñ‚Ğ¸Ğ¿Ñƒ
        if (item.type === 'ingredient') {
            url = `/api/ingredients/${item.original_id || item.id}`
            payload = { ...item, stock_quantity: editValue.value }
        } 
        else if (item.type === 'consumable') {
            url = `/api/consumables/${item.original_id || item.id}`
            payload = { ...item, stock_quantity: editValue.value }
        }
        else if (item.type === 'product') {
            // Ğ”Ğ»Ñ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ–Ğ² Ñƒ Ğ½Ğ°Ñ Ğ¾ĞºÑ€ĞµĞ¼Ğ¸Ğ¹ endpoint (PATCH)
            url = `/api/products/${item.original_id || item.id}/stock?qty=${editValue.value}`
            method = 'patch'
            payload = {} // ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ğ¸ Ğ² URL
        }
        else if (item.type === 'product_variant') {
            // Ğ”Ğ»Ñ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñ–Ğ² Ñ‚ĞµĞ¶ Ğ¾ĞºÑ€ĞµĞ¼Ğ¸Ğ¹ endpoint (PATCH)
            url = `/api/products/variants/${item.original_id || item.id}/stock?qty=${editValue.value}`
            method = 'patch'
            payload = {}
        }

        // Ğ’Ñ–Ğ´Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ğ·Ğ°Ğ¿Ğ¸Ñ‚Ñƒ
        if (method === 'put') {
            await axios.put(url, payload)
        } else {
            await axios.patch(url)
        }

        // ĞĞ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ– Ğ´Ğ°Ğ½Ñ–, Ñ‰Ğ¾Ğ± Ğ½Ğµ ÑĞ¼Ğ¸ĞºĞ°Ñ‚Ğ¸ ÑĞµÑ€Ğ²ĞµÑ€ Ğ·Ğ°Ğ¹Ğ²Ğ¸Ğ¹ Ñ€Ğ°Ğ·
        item.stock_quantity = editValue.value
        
        // ĞĞ»Ğµ Ğ¿Ñ€Ğ¾ Ğ²ÑÑĞº Ğ²Ğ¸Ğ¿Ğ°Ğ´Ğ¾Ğº Ğ¾Ğ½Ğ¾Ğ²Ğ¸Ğ¼Ğ¾ Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ¸Ğ¹ ÑÑ‚Ğ°Ğ½
        await fetchWarehouseData()
        
        editingItem.value = null
    } catch (e) {
        console.error(e)
        alert("ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ Ğ·Ğ°Ğ»Ğ¸ÑˆĞºÑƒ")
    } finally {
        loading.value = false
    }
}

// Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ¿Ñ€Ğ¸ ÑÑ‚Ğ°Ñ€Ñ‚Ñ–
onMounted(() => {
    fetchWarehouseData()
})
</script>

<template>
    <div class="h-full flex flex-col bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
        
        <div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center gap-4">
            
            <div class="flex p-1 bg-white rounded-xl border border-gray-200 shadow-sm">
                <button 
                    v-for="tab in ['ingredients', 'consumables', 'products']" 
                    :key="tab"
                    @click="activeTab = tab"
                    class="px-4 py-2 text-xs font-bold rounded-lg transition-all"
                    :class="activeTab === tab ? 'bg-blue-600 text-white shadow-md' : 'text-gray-500 hover:bg-gray-50'"
                >
                    {{ tab === 'ingredients' ? 'ğŸ¥¦ Ğ¡Ğ¸Ñ€Ğ¾Ğ²Ğ¸Ğ½Ğ°' : (tab === 'consumables' ? 'ğŸ“¦ ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸' : 'ğŸ¹ Ğ¢Ğ¾Ğ²Ğ°Ñ€Ğ¸') }}
                </button>
            </div>

            <input 
                v-model="search" 
                placeholder="ĞŸĞ¾ÑˆÑƒĞº..." 
                class="border border-gray-200 rounded-xl px-3 py-2 text-sm outline-none focus:border-blue-500 w-64"
            >
        </div>

        <div class="flex-1 overflow-auto">
            <table class="w-full text-left text-sm">
                <thead class="bg-gray-50 text-gray-500 uppercase text-xs sticky top-0 z-10">
                    <tr>
                        <th class="p-4">ĞĞ°Ğ·Ğ²Ğ°</th>
                        <th class="p-4 text-center">Ğ¢Ğ¸Ğ¿</th>
                        <th class="p-4 text-right">Ğ—Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº</th>
                        <th class="p-4 text-center">Ğ”Ñ–Ñ—</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    <tr v-if="filteredItems.length === 0">
                        <td colspan="4" class="p-8 text-center text-gray-400">
                            ĞÑ–Ñ‡Ğ¾Ğ³Ğ¾ Ğ½Ğµ Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾...
                        </td>
                    </tr>
                    
                    <tr v-for="item in filteredItems" :key="item.id + item.type" class="hover:bg-gray-50 group">
                        
                        <td class="p-4 font-bold text-gray-700">
                            {{ item.display_name }}
                        </td>

                        <td class="p-4 text-center">
                            <span v-if="item.type === 'ingredient'" class="bg-green-100 text-green-700 px-2 py-1 rounded text-[10px] font-bold">Ğ¡Ğ¸Ñ€Ğ¾Ğ²Ğ¸Ğ½Ğ°</span>
                            <span v-else-if="item.type === 'consumable'" class="bg-teal-100 text-teal-700 px-2 py-1 rounded text-[10px] font-bold">ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»</span>
                            <span v-else-if="item.type === 'product'" class="bg-purple-100 text-purple-700 px-2 py-1 rounded text-[10px] font-bold">Ğ¢Ğ¾Ğ²Ğ°Ñ€</span>
                            <span v-else-if="item.type === 'product_variant'" class="bg-indigo-100 text-indigo-700 px-2 py-1 rounded text-[10px] font-bold">Ğ’Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚</span>
                        </td>

                        <td class="p-4 text-right font-mono font-bold">
                            <div v-if="editingItem === item.id" class="flex items-center justify-end gap-2">
                                <input 
                                    v-model.number="editValue" 
                                    type="number" 
                                    class="w-20 border rounded p-1 text-right focus:ring-2 ring-blue-500 outline-none"
                                >
                                <span class="text-xs text-gray-400">{{ item.unit_symbol }}</span>
                            </div>
                            <span v-else :class="{'text-red-500 bg-red-50 px-2 py-1 rounded': item.stock_quantity <= 0, 'text-gray-700': item.stock_quantity > 0}">
                                {{ item.stock_quantity }} {{ item.unit_symbol }}
                            </span>
                        </td>

                        <td class="p-4 text-center">
                            <div v-if="editingItem === item.id" class="flex justify-center gap-1">
                                <button @click="saveEdit(item)" class="bg-green-500 text-white w-7 h-7 rounded hover:bg-green-600 flex items-center justify-center">
                                    <i class="fas fa-check text-xs"></i>
                                </button>
                                <button @click="editingItem = null" class="bg-gray-300 text-gray-700 w-7 h-7 rounded hover:bg-gray-400 flex items-center justify-center">
                                    <i class="fas fa-times text-xs"></i>
                                </button>
                            </div>
                            <button v-else @click="startEdit(item)" class="text-blue-400 hover:text-blue-600 p-2 rounded hover:bg-blue-50 transition-colors">
                                <i class="fas fa-pen"></i>
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</template>

--------------------------------------------------
PATH: ./.history/frontend/src/components/warehouse/tabs/StockTab_20260124215144.vue
--------------------------------------------------
<script setup>
import { ref, computed, defineAsyncComponent, onMounted } from 'vue'
import { useWarehouse } from '@/composables/useWarehouse'
import { useProducts } from '@/composables/useProducts'

// ĞÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğµ Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ¼Ğ¾Ğ´Ğ°Ğ»ĞºĞ¸ Ñ–ÑÑ‚Ğ¾Ñ€Ñ–Ñ—
const HistoryModal = defineAsyncComponent(() => import('../modals/HistoryModal.vue'))

// --- Ğ‘Ğ•Ğ—ĞŸĞ•Ğ§ĞĞ Ğ†ĞĞ†Ğ¦Ğ†ĞĞ›Ğ†Ğ—ĞĞ¦Ğ†Ğ¯ Ğ”ĞĞĞ˜Ğ¥ (FIX) ---
// ĞœĞ¸ Ğ½Ğµ Ñ€Ğ¾Ğ±Ğ¸Ğ¼Ğ¾ Ğ´ĞµÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ¸Ğ·Ğ°Ñ†Ñ–Ñ Ğ¾Ğ´Ñ€Ğ°Ğ·Ñƒ, Ğ±Ğ¾ useWarehouse Ğ¼Ğ¾Ğ¶Ğµ Ğ±ÑƒÑ‚Ğ¸ undefined Ğ½Ğ° Ğ¼Ñ–Ğ»Ñ–ÑĞµĞºÑƒĞ½Ğ´Ñƒ
const warehouseData = useWarehouse()
const ingredients = warehouseData?.ingredients || ref([])
const consumables = warehouseData?.consumables || ref([])
const updateItem = warehouseData?.updateItem || (async () => false)

const productsData = useProducts()
const products = productsData?.products || ref([])
const fetchProducts = productsData?.fetchProducts || (async () => {})

const searchQuery = ref('')
const filterType = ref('all') 
const isEditModalOpen = ref(false)
const editItemData = ref({ id: null, type: '', name: '', stock_quantity: 0, rawItem: null })
const isSaving = ref(false)
const isHistoryOpen = ref(false)
const historyItem = ref(null)

// Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ÑƒÑ”Ğ¼Ğ¾ Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ‚Ğ¸ Ğ¿Ñ€Ğ¸ ÑÑ‚Ğ°Ñ€Ñ‚Ñ–
onMounted(() => {
    fetchProducts()
})

const allStock = computed(() => {
  const list = []
  
  // --- Ğ—ĞĞ¥Ğ˜Ğ¡Ğ¢ Ğ’Ğ†Ğ” ĞŸĞĞœĞ˜Ğ›ĞĞš (FIX) ---
  // Ğ¯ĞºÑ‰Ğ¾ Ğ´Ğ°Ğ½Ñ– Ñ‰Ğµ Ğ½Ğµ Ğ¿Ñ€Ğ¸Ğ¹ÑˆĞ»Ğ¸, Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ¿Ğ¾Ğ²ĞµÑ€Ñ‚Ğ°Ñ”Ğ¼Ğ¾ Ğ¿ÑƒÑÑ‚Ğ¸Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº, Ğ° Ğ½Ğµ ĞºÑ€Ğ°ÑˆĞ¸Ğ¼Ğ¾ ÑÑ‚Ğ¾Ñ€Ñ–Ğ½ĞºÑƒ
  if (!ingredients.value || !consumables.value || !products.value) {
      return []
  }

  // 1. Ğ†Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ğ¸
  ingredients.value.forEach(i => {
    list.push({
      id: i.id,
      type: 'ingredient',
      typeName: 'Ğ¡Ğ¸Ñ€Ğ¾Ğ²Ğ¸Ğ½Ğ°',
      name: i.name,
      quantity: i.stock_quantity,
      unit: i.unit?.symbol || '?',
      cost: i.cost_per_unit,
      raw: i
    })
  })

  // 2. ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸
  consumables.value.forEach(c => {
    list.push({
      id: c.id,
      type: 'consumable',
      typeName: 'ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»',
      name: c.name,
      quantity: c.stock_quantity,
      unit: c.unit?.symbol || '?',
      cost: c.cost_per_unit,
      raw: c
    })
  })

  // 3. Ğ¢ĞĞ’ĞĞ Ğ˜
  products.value.forEach(p => {
      // Ğ¯ĞºÑ‰Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€ Ğ¼Ğ°Ñ” Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸, Ğ´Ğ¾Ğ´Ğ°Ñ”Ğ¼Ğ¾ ĞºĞ¾Ğ¶ĞµĞ½ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚ ÑĞº Ğ¾ĞºÑ€ĞµĞ¼Ğ¸Ğ¹ Ñ€ÑĞ´Ğ¾Ğº
      if (p.has_variants && p.variants) {
          p.variants.forEach(v => {
              list.push({
                  id: v.id,
                  type: 'product_variant', // Ğ¡Ğ¿ĞµÑ†Ñ–Ğ°Ğ»ÑŒĞ½Ğ¸Ğ¹ Ñ‚Ğ¸Ğ¿
                  typeName: 'Ğ’Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚',
                  name: `${p.name} (${v.name})`,
                  quantity: v.stock_quantity,
                  unit: 'ÑˆÑ‚',
                  cost: v.price, 
                  raw: v
              })
          })
      } 
      // Ğ¯ĞºÑ‰Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¸Ğ¹ Ñ– Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ğ¾ track_stock
      else{
          list.push({
              id: p.id,
              type: 'product', // Ğ¡Ğ¿ĞµÑ†Ñ–Ğ°Ğ»ÑŒĞ½Ğ¸Ğ¹ Ñ‚Ğ¸Ğ¿
              typeName: 'Ğ¢Ğ¾Ğ²Ğ°Ñ€',
              name: p.name,
              quantity: p.stock_quantity,
              unit: 'ÑˆÑ‚',
              cost: p.price,
              raw: p
          })
      }
  })

  return list.sort((a, b) => a.name.localeCompare(b.name))
})

const filteredStock = computed(() => {
  // Ğ”Ğ¾Ğ´Ğ°Ñ”Ğ¼Ğ¾ Ğ¿ĞµÑ€ĞµĞ²Ñ–Ñ€ĞºÑƒ, Ñ‰Ğ¾Ğ± computed Ğ½Ğµ Ğ¿Ğ°Ğ´Ğ°Ğ²
  let items = allStock.value || []
  
  // ĞĞ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ° Ğ»Ğ¾Ğ³Ñ–ĞºĞ° Ñ„Ñ–Ğ»ÑŒÑ‚Ñ€Ñƒ
  if (filterType.value === 'ingredient') items = items.filter(i => i.type === 'ingredient')
  else if (filterType.value === 'consumable') items = items.filter(i => i.type === 'consumable')
  else if (filterType.value === 'product') items = items.filter(i => i.type === 'product' || i.type === 'product_variant')

  if (searchQuery.value) {
    const q = searchQuery.value.toLowerCase()
    items = items.filter(item => item.name.toLowerCase().includes(q))
  }
  return items
})

const openHistory = (item) => {
  historyItem.value = { id: item.id, type: item.type, name: item.name }
  isHistoryOpen.value = true
}

const openEdit = (item) => {
  editItemData.value = {
    id: item.id,
    type: item.type,
    name: item.name,
    stock_quantity: item.quantity,
    rawItem: item.raw
  }
  isEditModalOpen.value = true
}

const saveStock = async () => {
  isSaving.value = true
  const { id, type, rawItem, stock_quantity } = editItemData.value
  
  let success = false

  try {
      // Ğ›Ğ¾Ğ³Ñ–ĞºĞ° Ğ´Ğ»Ñ Ğ·Ğ²Ğ¸Ñ‡Ğ°Ğ¹Ğ½Ğ¸Ñ… Ñ€ĞµÑÑƒÑ€ÑÑ–Ğ² (PUT Ğ¿Ğ¾Ğ²Ğ½Ğ¾Ğ³Ğ¾ Ğ¾Ğ±'Ñ”ĞºÑ‚Ğ°)
      if (type === 'ingredient' || type === 'consumable') {
          const payload = { ...rawItem, stock_quantity: Number(stock_quantity) }
          const url = type === 'ingredient' ? `/api/ingredients/${id}` : `/api/consumables/${id}`
          // Ğ’Ğ¸ĞºĞ»Ğ¸ĞºĞ°Ñ”Ğ¼Ğ¾ updateItem Ğ±ĞµĞ·Ğ¿ĞµÑ‡Ğ½Ğ¾
          success = await updateItem(url, payload)
      } 
      // Ğ›Ğ¾Ğ³Ñ–ĞºĞ° Ğ´Ğ»Ñ Ğ¢ĞĞ’ĞĞ Ğ†Ğ’ (PATCH Ñ‚Ñ–Ğ»ÑŒĞºĞ¸ quantity)
      // Ğ’ĞĞ–Ğ›Ğ˜Ğ’Ğ: Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ Ğ¿Ğ¾Ğ²Ğ½Ğ¸Ğ¹ URL, Ğ±Ğ¾ vite proxy Ğ½Ğ°Ğ»Ğ°ÑˆÑ‚Ğ¾Ğ²Ğ°Ğ½Ğ¾
      else if (type === 'product') {
          // Ğ¢ÑƒÑ‚ ĞºÑ€Ğ°Ñ‰Ğµ Ğ²Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ°Ñ‚Ğ¸ axios, Ğ°Ğ»Ğµ ÑĞºÑ‰Ğ¾ Ñƒ Ğ²Ğ°Ñ fetch Ğ½Ğ°Ğ»Ğ°ÑˆÑ‚Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹ Ñ‡ĞµÑ€ĞµĞ· proxy - Ğ¾Ğº
          const res = await fetch(`http://localhost:8001/products/${id}/stock?qty=${stock_quantity}`, { method: 'PATCH' })
          if(res.ok) { success = true; await fetchProducts(); }
      }
      else if (type === 'product_variant') {
          const res = await fetch(`http://localhost:8001/products/variants/${id}/stock?qty=${stock_quantity}`, { method: 'PATCH' })
          if(res.ok) { success = true; await fetchProducts(); }
      }
  } catch (e) {
      console.error("Stock save error:", e)
      alert("ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ·Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ½Ñ")
  }
  
  isSaving.value = false
  if (success) isEditModalOpen.value = false
}
</script>

<template>
  <div class="space-y-6">
    
    <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col md:flex-row gap-4 items-center justify-between">
       <div class="relative w-full md:w-96">
         <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
         <input v-model="searchQuery" type="text" placeholder="ĞŸĞ¾ÑˆÑƒĞº..." class="w-full pl-10 pr-4 py-2 bg-gray-50 border border-gray-200 rounded-xl outline-none">
       </div>

       <div class="flex bg-gray-100 p-1 rounded-xl">
         <button @click="filterType = 'all'" :class="filterType === 'all' ? 'bg-white shadow text-gray-800' : 'text-gray-500'" class="px-4 py-1.5 rounded-lg text-sm font-bold transition-all">Ğ’ÑÑ–</button>
         <button @click="filterType = 'ingredient'" :class="filterType === 'ingredient' ? 'bg-white shadow text-green-600' : 'text-gray-500'" class="px-4 py-1.5 rounded-lg text-sm font-bold transition-all">Ğ¡Ğ¸Ñ€Ğ¾Ğ²Ğ¸Ğ½Ğ°</button>
         <button @click="filterType = 'consumable'" :class="filterType === 'consumable' ? 'bg-white shadow text-teal-600' : 'text-gray-500'" class="px-4 py-1.5 rounded-lg text-sm font-bold transition-all">ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸</button>
         <button @click="filterType = 'product'" :class="filterType === 'product' ? 'bg-white shadow text-orange-600' : 'text-gray-500'" class="px-4 py-1.5 rounded-lg text-sm font-bold transition-all">Ğ¢Ğ¾Ğ²Ğ°Ñ€Ğ¸</button>
       </div>
    </div>

    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
      <div class="overflow-x-auto">
        <table class="w-full text-left text-sm">
          <thead class="bg-gray-50 text-gray-500 uppercase text-xs">
            <tr>
              <th class="p-4">ĞĞ°Ğ·Ğ²Ğ°</th>
              <th class="p-4">Ğ¢Ğ¸Ğ¿</th>
              <th class="p-4 text-right">Ğ—Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº</th>
              <th class="p-4 text-center">Ğ”Ñ–Ñ—</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-100">
            <tr v-if="filteredStock.length === 0">
                <td colspan="4" class="p-8 text-center text-gray-400">ĞŸÑƒÑÑ‚Ğ¾...</td>
            </tr>
            <tr v-for="item in filteredStock" :key="item.type + item.id" class="hover:bg-blue-50 transition group">
              
              <td class="p-4 font-bold text-gray-800">{{ item.name }}</td>
              
              <td class="p-4">
                <span class="text-[10px] uppercase font-bold px-2 py-1 rounded-md border"
                  :class="{
                      'bg-green-50 text-green-700 border-green-100': item.type === 'ingredient',
                      'bg-teal-50 text-teal-700 border-teal-100': item.type === 'consumable',
                      'bg-orange-50 text-orange-700 border-orange-100': item.type.includes('product')
                  }">
                  {{ item.typeName }}
                </span>
              </td>
              
              <td class="p-4 text-right font-mono text-lg" :class="item.quantity <= 0 ? 'text-red-500 font-bold' : 'text-gray-700'">
                {{ item.quantity }} <span class="text-xs text-gray-400 font-sans">{{ item.unit }}</span>
              </td>
              
              <td class="p-4 text-center flex justify-center gap-2">
                 <button @click="openHistory(item)" class="w-8 h-8 rounded-lg bg-purple-50 text-purple-600 hover:bg-purple-100 hover:scale-110 transition flex items-center justify-center">
                   <i class="fas fa-history"></i>
                 </button>
                 <button @click="openEdit(item)" class="px-3 py-1 rounded-lg bg-blue-50 text-blue-600 hover:bg-blue-100 font-bold text-xs transition flex items-center gap-2">
                   <i class="fas fa-pen"></i> <span class="hidden sm:inline">ĞšĞ¾Ñ€ĞµĞ³ÑƒĞ²Ğ°Ñ‚Ğ¸</span>
                 </button>
              </td>

            </tr>
          </tbody>
        </table>
      </div>
    </div>
    
    <div v-if="isEditModalOpen" class="fixed inset-0 z-50 flex items-center justify-center p-4">
       <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" @click="isEditModalOpen = false"></div>
       <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 relative z-10">
          <h3 class="text-xl font-bold mb-1 text-gray-800">Ğ†Ğ½Ğ²ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ·Ğ°Ñ†Ñ–Ñ</h3>
          <p class="text-sm text-gray-500 mb-6">ĞšĞ¾Ñ€ĞµĞºÑ†Ñ–Ñ: <b class="text-gray-900">{{ editItemData.name }}</b></p>
          <div class="mb-6">
             <input v-model="editItemData.stock_quantity" type="number" step="1" class="w-full border-2 border-blue-100 p-4 rounded-xl text-2xl font-mono text-center font-bold">
          </div>
          <div class="flex gap-3">
             <button @click="isEditModalOpen=false" class="flex-1 py-3 text-gray-500 font-bold">Ğ¡ĞºĞ°ÑÑƒĞ²Ğ°Ñ‚Ğ¸</button>
             <button @click="saveStock" :disabled="isSaving" class="flex-1 py-3 bg-blue-600 text-white font-bold rounded-xl">Ğ—Ğ±ĞµÑ€ĞµĞ³Ñ‚Ğ¸</button>
          </div>
       </div>
    </div>

    <HistoryModal v-if="isHistoryOpen" :is-open="isHistoryOpen" :item="historyItem" @close="isHistoryOpen = false" />
  </div>
</template>

--------------------------------------------------
PATH: ./.history/frontend/src/components/warehouse/tabs/UnitsTab_20260123123656.vue
--------------------------------------------------
<script setup>
import { ref } from 'vue'
import { useWarehouse } from '@/composables/useWarehouse'

// Ğ†Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ÑƒÑ”Ğ¼Ğ¾ Ğ¼ĞµÑ‚Ğ¾Ğ´Ğ¸ Ğ· Ğ½Ğ°ÑˆĞ¾Ğ³Ğ¾ composable
const { units, createItem, updateItem, deleteItem } = useWarehouse()

// Ğ¡Ñ‚Ğ°Ğ½ Ñ„Ğ¾Ñ€Ğ¼Ğ¸
const newUnit = ref({ name: '', symbol: '' })
const isEditing = ref(false)
const editingId = ref(null)

// ĞŸÑ–Ğ´Ğ³Ğ¾Ñ‚ÑƒĞ²Ğ°Ñ‚Ğ¸ Ñ„Ğ¾Ñ€Ğ¼Ñƒ Ğ´Ğ¾ Ñ€ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ
const prepareEdit = (unit) => {
    isEditing.value = true
    editingId.value = unit.id
    newUnit.value = {
        name: unit.name,
        symbol: unit.symbol
    }
}

// Ğ¡ĞºĞ¸Ğ½ÑƒÑ‚Ğ¸ Ñ„Ğ¾Ñ€Ğ¼Ñƒ
const resetForm = () => {
    isEditing.value = false
    editingId.value = null
    newUnit.value = { name: '', symbol: '' }
}

// ĞĞ±Ñ€Ğ¾Ğ±ĞºĞ° Ğ·Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ½Ñ
const handleSave = async () => {
    if (!newUnit.value.name || !newUnit.value.symbol) return alert("Ğ—Ğ°Ğ¿Ğ¾Ğ²Ğ½Ñ–Ñ‚ÑŒ Ğ²ÑÑ– Ğ¿Ğ¾Ğ»Ñ!")

    let success = false
    if (isEditing.value) {
        // ĞĞ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ (PUT)
        success = await updateItem(`/api/inventory/units/${editingId.value}`, newUnit.value)
    } else {
        // Ğ¡Ñ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ½Ñ (POST)
        success = await createItem('/api/inventory/units/', newUnit.value)
    }

    if (success) {
        resetForm()
    }
}

// ĞĞ±Ñ€Ğ¾Ğ±ĞºĞ° Ğ²Ğ¸Ğ´Ğ°Ğ»ĞµĞ½Ğ½Ñ
const handleDelete = async (id) => {
    if(!confirm("Ğ’Ğ¸ Ğ²Ğ¿ĞµĞ²Ğ½ĞµĞ½Ñ–? Ğ¯ĞºÑ‰Ğ¾ Ñ†Ñ Ğ¾Ğ´Ğ¸Ğ½Ğ¸Ñ†Ñ Ğ²Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ñ‚ÑŒÑÑ Ğ² Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°Ñ…, Ğ²Ğ¸Ğ´Ğ°Ğ»ĞµĞ½Ğ½Ñ Ğ±ÑƒĞ´Ğµ Ğ·Ğ°Ğ±Ğ»Ğ¾ĞºĞ¾Ğ²Ğ°Ğ½Ğ¾.")) return
    
    const success = await deleteItem(`/api/inventory/units/${id}`)
    
    // Ğ¯ĞºÑ‰Ğ¾ Ğ²Ğ¸Ğ´Ğ°Ğ»Ğ¸Ğ»Ğ¸ Ñ‚Ğµ, Ñ‰Ğ¾ Ğ·Ğ°Ñ€Ğ°Ğ· Ñ€ĞµĞ´Ğ°Ğ³ÑƒÑ”Ğ¼Ğ¾ - ÑĞºĞ¸Ğ´Ğ°Ñ”Ğ¼Ğ¾ Ñ„Ğ¾Ñ€Ğ¼Ñƒ
    if (success && editingId.value === id) {
        resetForm()
    }
}
</script>

<template>
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 h-fit">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-gray-700">
                    {{ isEditing ? 'âœï¸ Ğ ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ¾Ğ´Ğ¸Ğ½Ğ¸Ñ†Ñ–' : 'ğŸ“ ĞĞ¾Ğ²Ğ° Ğ¾Ğ´Ğ¸Ğ½Ğ¸Ñ†Ñ Ğ²Ğ¸Ğ¼Ñ–Ñ€Ñƒ' }}
                </h3>
                <button v-if="isEditing" @click="resetForm" class="text-xs text-red-500 hover:underline">Ğ¡ĞºĞ°ÑÑƒĞ²Ğ°Ñ‚Ğ¸</button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞĞ°Ğ·Ğ²Ğ°</label>
                    <input v-model="newUnit.name" class="border p-2 rounded w-full focus:ring-2 ring-blue-100 outline-none" placeholder="ĞĞ°Ğ¿Ñ€. ĞšÑ–Ğ»Ğ¾Ğ³Ñ€Ğ°Ğ¼">
                </div>
                
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ğ¡Ğ¸Ğ¼Ğ²Ğ¾Ğ»</label>
                    <input v-model="newUnit.symbol" class="border p-2 rounded w-full focus:ring-2 ring-blue-100 outline-none" placeholder="ĞĞ°Ğ¿Ñ€. ĞºĞ³">
                </div>
                
                <button @click="handleSave" 
                    class="w-full py-3 rounded-xl font-bold text-white shadow-lg transition transform active:scale-95"
                    :class="isEditing ? 'bg-orange-500 hover:bg-orange-600 shadow-orange-200' : 'bg-blue-600 hover:bg-blue-700 shadow-blue-200'">
                    {{ isEditing ? 'Ğ—Ğ±ĞµÑ€ĞµĞ³Ñ‚Ğ¸ Ğ·Ğ¼Ñ–Ğ½Ğ¸' : 'Ğ”Ğ¾Ğ´Ğ°Ñ‚Ğ¸ Ğ¾Ğ´Ğ¸Ğ½Ğ¸Ñ†Ñ' }}
                </button>
            </div>
        </div>

        <div class="lg:col-span-2 bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
            <table class="w-full text-sm text-left">
                <thead class="bg-gray-50 text-gray-500 uppercase text-xs">
                    <tr>
                        <th class="p-4">ĞĞ°Ğ·Ğ²Ğ°</th>
                        <th class="p-4">Ğ¡Ğ¸Ğ¼Ğ²Ğ¾Ğ»</th>
                        <th class="p-4 text-center">Ğ”Ñ–Ñ—</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    <tr v-if="units.length === 0">
                        <td colspan="3" class="p-8 text-center text-gray-400">Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¿Ğ¾Ñ€Ğ¾Ğ¶Ğ½Ñ–Ğ¹</td>
                    </tr>
                    <tr v-for="u in units" :key="u.id" class="hover:bg-gray-50 group">
                        <td class="p-4 font-bold text-gray-800">{{ u.name }}</td>
                        <td class="p-4 font-mono text-blue-600 bg-blue-50 w-fit rounded px-2 py-1 text-xs">{{ u.symbol }}</td>
                        <td class="p-4 text-center">
                            <div class="flex justify-center gap-2">
                                <button @click="prepareEdit(u)" class="p-2 text-blue-400 hover:text-blue-600 hover:bg-blue-50 rounded transition" title="Ğ ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ñ‚Ğ¸">
                                    <i class="fas fa-pen"></i>
                                </button>
                                <button @click="handleDelete(u.id)" class="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded transition" title="Ğ’Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğ¸">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</template>

--------------------------------------------------
PATH: ./.history/frontend/src/components/warehouse/tabs/ProductsTab_20260125111944.vue
--------------------------------------------------
<script setup>
import { ref, onMounted } from 'vue'
import { useWarehouse } from '@/composables/useWarehouse'
import { useProducts } from '@/composables/useProducts'

// ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ğ´Ğ¾Ğ²Ñ–Ğ´Ğ½Ğ¸ĞºĞ¸ (ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ—, Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ğ¸ Ñ‚Ğ¾Ñ‰Ğ¾)
const { categories, recipes, ingredients, consumables } = useWarehouse()

// ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ñ„ÑƒĞ½ĞºÑ†Ñ–Ğ¾Ğ½Ğ°Ğ» Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ–Ğ²
const { 
    newProduct, isEditing, 
    variantBuilder, tempProductConsumable, tempVariantConsumable, tempVariantIngredient,
    resetForm, prepareEdit, saveProduct, deleteProduct, fetchProducts, filteredProducts, productSearch,
    addVariant, removeVariant, 
    addProductConsumable, removeProductConsumable,
    addVariantConsumable, removeVariantConsumable,
    addIngredientToVariant, removeIngredientFromVariant
} = useProducts()

const showForm = ref(false)

const getCategoryName = (id) => {
    if (!categories.value) return '-'
    const c = categories.value.find(x => x.id === id)
    return c ? c.name : '-'
}

const handleSave = async () => {
    const success = await saveProduct()
    if(success) {
        showForm.value = false
        // Ğ”Ğ¾Ğ´Ğ°Ñ”Ğ¼Ğ¾ Ğ¿Ñ€Ğ¸Ğ¼ÑƒÑĞ¾Ğ²Ğµ Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ
        await fetchProducts()}
}

const handleEdit = (product) => {
    prepareEdit(product)
    showForm.value = true
}

// !!! Ğ’ĞĞ–Ğ›Ğ˜Ğ’Ğ: Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ÑƒÑ”Ğ¼Ğ¾ Ğ´Ğ°Ğ½Ñ– Ğ¿Ñ€Ğ¸ ÑÑ‚Ğ°Ñ€Ñ‚Ñ– ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ° !!!
onMounted(async () => {
    console.log("ProductsTab mounted: fetching data...")
    await fetchProducts()
})
</script>

<template>
    <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
        
        <div v-if="showForm" class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 h-fit xl:col-span-1">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-gray-700">
                    {{ isEditing ? 'âœï¸ Ğ ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ' : 'ğŸ“¦ ĞĞ¾Ğ²Ğ¸Ğ¹ Ñ‚Ğ¾Ğ²Ğ°Ñ€' }}
                </h3>
                <button @click="showForm = false; resetForm()" class="text-xs text-red-500 hover:underline">Ğ—Ğ°ĞºÑ€Ğ¸Ñ‚Ğ¸</button>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞĞ°Ğ·Ğ²Ğ°</label>
                    <input v-model="newProduct.name" class="border p-2 rounded w-full focus:ring-2 ring-blue-100 outline-none">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ</label>
                        <select v-model="newProduct.category_id" class="border p-2 rounded w-full bg-white">
                            <option :value="null">-- Ğ‘ĞµĞ· ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ— --</option>
                            <option v-for="c in categories" :key="c.id" :value="c.id">{{ c.name }}</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ğ¦Ñ–Ğ½Ğ°</label>
                        <input v-model.number="newProduct.price" type="number" class="border p-2 rounded w-full">
                    </div>
                </div>

                <div class="flex items-center gap-2 py-2">
                    <input type="checkbox" v-model="newProduct.has_variants" id="hasVar" class="w-4 h-4 text-blue-600">
                    <label for="hasVar" class="text-sm font-bold text-gray-700 select-none">Ğ¦ĞµĞ¹ Ñ‚Ğ¾Ğ²Ğ°Ñ€ Ğ¼Ğ°Ñ” Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸</label>
                </div>

                <div v-if="!newProduct.has_variants" class="bg-gray-50 p-3 rounded border border-gray-200 space-y-3">
                     <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞœĞ°Ğ¹ÑÑ‚ĞµÑ€-Ñ€ĞµÑ†ĞµĞ¿Ñ‚</label>
                        <select v-model="newProduct.master_recipe_id" class="border p-2 rounded w-full bg-white text-sm">
                            <option :value="null">-- Ğ‘ĞµĞ· Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ñƒ --</option>
                            <option v-for="r in recipes" :key="r.id" :value="r.id">{{ r.name }}</option>
                        </select>
                    </div>
                </div>

                <div class="bg-teal-50/50 p-3 rounded border border-teal-100">
                    <label class="text-[10px] uppercase font-bold text-teal-600 mb-2 block">Ğ—Ğ°Ğ³Ğ°Ğ»ÑŒĞ½Ñ– Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸</label>
                    <div class="flex gap-2 mb-2">
                        <select v-model="tempProductConsumable.consumable_id" class="flex-1 border p-1 rounded text-sm bg-white">
                            <option value="">ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»...</option>
                            <option v-for="c in consumables" :key="c.id" :value="c.id">{{ c.name }}</option>
                        </select>
                        <button @click="addProductConsumable" class="bg-teal-500 text-white w-8 rounded">+</button>
                    </div>
                    <div class="flex flex-wrap gap-1">
                        <span v-for="(pc, idx) in newProduct.consumables" :key="idx" class="bg-white border border-teal-200 text-teal-700 text-xs px-2 py-1 rounded">
                            {{ pc.name }} <button @click="removeProductConsumable(idx)" class="text-red-500 font-bold ml-1">&times;</button>
                        </span>
                    </div>
                </div>

                <div v-if="newProduct.has_variants" class="space-y-3">
                    <div class="border-t pt-2 mt-2">
                        <h4 class="font-bold text-sm text-purple-700 mb-2">ĞšĞ¾Ğ½ÑÑ‚Ñ€ÑƒĞºÑ‚Ğ¾Ñ€ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñ–Ğ²</h4>
                        
                        <div class="bg-purple-50 p-3 rounded-lg border border-purple-100 space-y-3">
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="text-[10px] uppercase font-bold text-gray-500">ĞĞ°Ğ·Ğ²Ğ°</label>
                                    <input v-model="variantBuilder.name" placeholder="Ğ½Ğ°Ğ¿Ñ€. XL" class="w-full border p-1.5 rounded text-sm">
                                </div>
                                <div>
                                    <label class="text-[10px] uppercase font-bold text-gray-500">Ğ¦Ñ–Ğ½Ğ°</label>
                                    <input v-model.number="variantBuilder.price" type="number" class="w-full border p-1.5 rounded text-sm">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="text-[10px] uppercase font-bold text-gray-500">Ğ¢ĞµÑ…. ĞºĞ°Ñ€Ñ‚Ğ° (Ğ ĞµÑ†ĞµĞ¿Ñ‚)</label>
                                    <select v-model="variantBuilder.master_recipe_id" class="w-full border p-1.5 rounded text-sm bg-white">
                                        <option :value="null">-- Ğ‘ĞµĞ· Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ñƒ --</option>
                                        <option v-for="r in recipes" :key="r.id" :value="r.id">{{ r.name }}</option>
                                    </select>
                                    <p v-if="!recipes || recipes.length === 0" class="text-[10px] text-red-500 mt-1">Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ñ–Ğ² Ğ¿ÑƒÑÑ‚Ğ¸Ğ¹!</p>
                                </div>
                                <div>
                                    <label class="text-[10px] uppercase font-bold text-gray-500">Ğ’Ğ°Ğ³Ğ° Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¾Ğ³Ğ¾ (Ğ³/Ğ¼Ğ»)</label>
                                    <input v-model.number="variantBuilder.output_weight" type="number" class="w-full border p-1.5 rounded text-sm">
                                </div>
                            </div>
                            
                            <div>
                                <label class="text-[10px] uppercase font-bold text-gray-500">ĞŸĞ¾Ñ‡Ğ°Ñ‚ĞºĞ¾Ğ²Ğ¸Ğ¹ Ğ·Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº (ÑˆÑ‚)</label>
                                <input v-model.number="variantBuilder.stock_quantity" type="number" class="w-full border p-1.5 rounded text-sm bg-white" placeholder="0">
                            </div>

                            <div class="bg-white/50 p-2 rounded border border-dashed border-purple-200">
                                <label class="text-[10px] uppercase font-bold text-purple-400">ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ</label>
                                <div class="flex gap-1 mb-1">
                                    <select v-model="tempVariantConsumable.consumable_id" class="flex-1 border p-1 rounded text-[10px] bg-white h-7">
                                        <option value="">ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»...</option>
                                        <option v-for="c in consumables" :key="c.id" :value="c.id">{{ c.name }}</option>
                                    </select>
                                    <input v-model.number="tempVariantConsumable.quantity" type="number" class="w-10 border p-1 rounded text-[10px] h-7" placeholder="Ğš-ÑÑ‚ÑŒ">
                                    <button @click="addVariantConsumable" class="bg-purple-500 text-white w-7 h-7 rounded hover:bg-purple-600 text-xs">+</button>
                                </div>
                                <div class="flex flex-wrap gap-1">
                                    <span v-for="(vc, idx) in variantBuilder.consumables" :key="idx" class="bg-white border text-[10px] px-1 rounded flex items-center gap-1">
                                        {{ vc.name }}: {{ vc.quantity }} <button @click="removeVariantConsumable(idx)" class="text-red-500 font-bold">&times;</button>
                                    </span>
                                </div>
                            </div>

                            <div class="bg-blue-50/50 p-2 rounded border border-dashed border-blue-200">
                                <label class="text-[10px] uppercase font-bold text-blue-500">Ğ”Ğ¾Ğ´Ğ°Ñ‚ĞºĞ¾Ğ²Ñ– Ñ–Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ğ¸</label>
                                <div class="flex gap-1 mb-1">
                                    <select v-model="tempVariantIngredient.ingredient_id" class="flex-1 border p-1 rounded text-[10px] bg-white h-7">
                                        <option value="">Ğ†Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚...</option>
                                        <option v-for="i in ingredients" :key="i.id" :value="i.id">{{ i.name }}</option>
                                    </select>
                                    <input v-model.number="tempVariantIngredient.quantity" type="number" class="w-10 border p-1 rounded text-[10px] h-7" placeholder="Ğ“Ñ€Ğ°Ğ¼">
                                    <button @click="addIngredientToVariant" class="bg-blue-500 text-white w-7 h-7 rounded hover:bg-blue-600 text-xs">+</button>
                                </div>
                                <div class="flex flex-wrap gap-1">
                                    <span v-for="(vi, idx) in variantBuilder.ingredients" :key="idx" class="bg-white border text-[10px] px-1 rounded flex items-center gap-1 text-blue-700">
                                        {{ vi.name }}: {{ vi.quantity }} <button @click="removeIngredientFromVariant(idx)" class="text-red-500 font-bold">&times;</button>
                                    </span>
                                </div>
                            </div>

                            <button @click="addVariant" class="w-full bg-purple-200 text-purple-800 text-xs font-bold py-2 rounded hover:bg-purple-300">
                                Ğ”Ğ¾Ğ´Ğ°Ñ‚Ğ¸ Ñ†ĞµĞ¹ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚ Ñƒ ÑĞ¿Ğ¸ÑĞ¾Ğº
                            </button>
                        </div>
                    </div>
                    
                    <div v-if="newProduct.variants.length > 0" class="space-y-2">
                        <div v-for="(v, idx) in newProduct.variants" :key="idx" class="bg-white border p-2 rounded flex justify-between items-center text-sm">
                            <div>
                                <span class="font-bold">{{ v.name }}</span> - {{ v.price }} Ğ³Ñ€Ğ½
                                <div class="text-xs text-gray-400">
                                    <span v-if="v.master_recipe_id" class="text-purple-600 mr-2">ğŸ“œ Ğ ĞµÑ†ĞµĞ¿Ñ‚ ID: {{ v.master_recipe_id }}</span>
                                    <span v-if="v.stock_quantity > 0" class="text-green-600 font-bold">Ğ—Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº: {{ v.stock_quantity }}</span>
                                </div>
                            </div>
                            <button @click="removeVariant(idx)" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                </div>

                <button @click="handleSave" class="w-full bg-green-600 text-white font-bold py-3 rounded-xl hover:bg-green-700 mt-4">
                    {{ isEditing ? 'Ğ—Ğ±ĞµÑ€ĞµĞ³Ñ‚Ğ¸' : 'Ğ¡Ñ‚Ğ²Ğ¾Ñ€Ğ¸Ñ‚Ğ¸' }}
                </button>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden flex flex-col h-full" :class="showForm ? 'xl:col-span-2' : 'xl:col-span-3'">
            
            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
                <div class="flex items-center gap-4">
                    <h2 class="font-bold text-gray-700">Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ–Ğ²</h2>
                    <input v-model="productSearch" placeholder="ĞŸĞ¾ÑˆÑƒĞº..." class="border rounded px-2 py-1 text-sm">
                </div>
                <button v-if="!showForm" @click="showForm = true; resetForm()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-bold text-sm">
                    + ĞĞ¾Ğ²Ğ¸Ğ¹ Ñ‚Ğ¾Ğ²Ğ°Ñ€
                </button>
            </div>

            <div class="overflow-auto flex-1">
                <table class="w-full text-left text-sm">
                    <thead class="bg-gray-50 text-gray-500 uppercase text-xs sticky top-0">
                        <tr>
                            <th class="p-4">ĞĞ°Ğ·Ğ²Ğ°</th>
                            <th class="p-4">ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ</th>
                            <th class="p-4">Ğ¦Ñ–Ğ½Ğ° / Ğ’Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸</th>
                            <th class="p-4 text-center">Ğ”Ñ–Ñ—</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        <tr v-if="filteredProducts.length === 0">
                            <td colspan="4" class="p-8 text-center text-gray-400">
                                Ğ¢Ğ¾Ğ²Ğ°Ñ€Ñ–Ğ² Ğ½ĞµĞ¼Ğ°Ñ” Ğ°Ğ±Ğ¾ Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ...
                            </td>
                        </tr>
                        <tr v-for="p in filteredProducts" :key="p.id" class="hover:bg-gray-50 align-top">
                            <td class="p-4 font-bold text-gray-800">{{ p.name }}</td>
                            <td class="p-4 text-gray-600">
                                <span class="bg-gray-100 px-2 py-1 rounded text-xs">{{ getCategoryName(p.category_id) }}</span>
                            </td>
                            <td class="p-4">
                                <div v-if="!p.has_variants" class="font-mono font-bold text-green-600">{{ p.price }} â‚´</div>
                                <div v-else class="space-y-1">
                                    <div v-for="v in p.variants" :key="v.id" class="text-xs bg-gray-50 p-1 rounded border">
                                        <b>{{ v.name }}</b>: {{ v.price }} â‚´
                                        <span v-if="v.ingredients?.length" class="text-blue-600 ml-1">
                                            (Ğ†Ğ½Ğ³Ñ€: {{ v.ingredients.length }})
                                        </span>
                                    </div>
                                </div>
                            </td>
                            <td class="p-4 text-center">
                                <button @click="handleEdit(p)" class="text-blue-500 hover:text-blue-700 mx-1"><i class="fas fa-pen"></i></button>
                                <button @click="deleteProduct(p.id)" class="text-red-400 hover:text-red-600 mx-1"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</template>

--------------------------------------------------
PATH: ./.history/frontend/src/components/warehouse/tabs/StockTab_20260123212645.vue
--------------------------------------------------
<script setup>
import { ref, computed, onMounted } from 'vue'
import { useWarehouse } from '@/composables/useWarehouse'
import axios from 'axios'

// ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ğ´Ğ°Ğ½Ñ–. Ğ”Ğ¾Ğ´Ğ°Ñ”Ğ¼Ğ¾ Ğ·Ğ°Ñ…Ğ¸ÑÑ‚, ÑĞºÑ‰Ğ¾ useWarehouse Ğ¿Ğ¾Ğ²ĞµÑ€Ğ½Ğµ undefined
const warehouseData = useWarehouse()
const consumables = warehouseData?.consumables || ref([])
const ingredients = warehouseData?.ingredients || ref([])
const fetchWarehouseData = warehouseData?.fetchWarehouseData || (async () => {})

const activeCategory = ref('ingredients') // 'ingredients' or 'consumables'
const searchQuery = ref('')
const showAdjustmentModal = ref(false)

// Ğ¤Ğ¾Ñ€Ğ¼Ğ° ĞºĞ¾Ñ€Ğ¸Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ
const adjustmentForm = ref({
    type: 'ingredient', // ingredient/consumable
    id: null,
    delta: 0,
    reason: ''
})

// --- COMPUTED: Ğ¤Ñ–Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ñ–Ñ (Ğ— Ğ—ĞĞ¥Ğ˜Ğ¡Ğ¢ĞĞœ Ğ’Ğ†Ğ” ĞŸĞĞœĞ˜Ğ›ĞĞš) ---
const filteredItems = computed(() => {
    // 1. Ğ’Ğ¸Ğ·Ğ½Ğ°Ñ‡Ğ°Ñ”Ğ¼Ğ¾ Ğ´Ğ¶ĞµÑ€ĞµĞ»Ğ¾ Ğ´Ğ°Ğ½Ğ¸Ñ…
    let source = null
    if (activeCategory.value === 'ingredients') {
        source = ingredients
    } else {
        source = consumables
    }

    // 2. Ğ—ĞĞ¥Ğ˜Ğ¡Ğ¢: Ğ¯ĞºÑ‰Ğ¾ Ğ´Ğ¶ĞµÑ€ĞµĞ»Ğ¾ Ñ‰Ğµ Ğ½Ğµ Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶Ğ¸Ğ»Ğ¾ÑÑŒ (undefined Ğ°Ğ±Ğ¾ Ğ½ĞµĞ¼Ğ°Ñ” .value)
    if (!source || !source.value) {
        return []
    }

    // 3. Ğ¤Ñ–Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ñ–Ñ
    if (!searchQuery.value) return source.value
    
    const q = searchQuery.value.toLowerCase()
    return source.value.filter(item => item.name.toLowerCase().includes(q))
})

// --- Ğ”Ñ–Ñ— ---

const openAdjustment = (item, type) => {
    adjustmentForm.value = {
        type: type,
        id: item.id,
        delta: 0,
        reason: '',
        currentName: item.name,
        currentStock: item.stock_quantity
    }
    showAdjustmentModal.value = true
}

const saveAdjustment = async () => {
    if (adjustmentForm.value.delta === 0) return alert("Ğ’ĞºĞ°Ğ¶Ñ–Ñ‚ÑŒ ĞºÑ–Ğ»ÑŒĞºÑ–ÑÑ‚ÑŒ")
    
    // Ğ’Ğ¸Ğ·Ğ½Ğ°Ñ‡Ğ°Ñ”Ğ¼Ğ¾ URL Ğ·Ğ°Ğ»ĞµĞ¶Ğ½Ğ¾ Ğ²Ñ–Ğ´ Ñ‚Ğ¸Ğ¿Ñƒ
    const endpoint = adjustmentForm.value.type === 'ingredient' 
        ? 'ingredients' 
        : 'consumables'
    
    try {
        // Ğ’Ñ–Ğ´Ğ¿Ñ€Ğ°Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ½Ğ° Ğ±ĞµĞºĞµĞ½Ğ´ (POST /api/inventory/{type}/{id}/adjust)
        // ĞŸÑ€Ğ¸Ğ¿ÑƒÑÑ‚Ğ¸Ğ¼Ğ¾, Ñ‰Ğ¾ Ğ±ĞµĞºĞµĞ½Ğ´ Ğ¼Ğ°Ñ” Ñ‚Ğ°ĞºĞ¸Ğ¹ Ñ€Ğ¾ÑƒÑ‚, Ğ°Ğ±Ğ¾ Ğ¼Ğ¸ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ¾Ğ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ñ‡ĞµÑ€ĞµĞ· PUT
        // Ğ”Ğ»Ñ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾Ñ‚Ğ¸, ÑĞºÑ‰Ğ¾ Ğ½ĞµĞ¼Ğ°Ñ” ÑĞ¿ĞµÑ†. Ñ€Ğ¾ÑƒÑ‚Ñƒ adjustment, Ğ¼Ğ¾Ğ¶Ğ½Ğ° Ğ²Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ°Ñ‚Ğ¸ PUT Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ
        // ĞĞ»Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¸Ğ¹ REST Ğ¿Ñ–Ğ´Ñ…Ñ–Ğ´ Ğ´Ğ»Ñ ÑĞºĞ»Ğ°Ğ´Ñƒ - Ñ†Ğµ Ğ¾ĞºÑ€ĞµĞ¼Ğ¸Ğ¹ Ñ€Ğ¾ÑƒÑ‚ Ñ€ÑƒÑ…Ñƒ.
        
        // ĞŸĞ¾ĞºĞ¸ Ñ‰Ğ¾ Ñ€ĞµĞ°Ğ»Ñ–Ğ·ÑƒÑ”Ğ¼Ğ¾ Ñ‡ĞµÑ€ĞµĞ· "Ğ¼Ğ¸Ğ»Ğ¸Ñ†Ñ" - Ğ¿Ñ€ÑĞ¼Ğµ Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ (ÑĞºÑ‰Ğ¾ Ñƒ Ğ²Ğ°Ñ Ğ½ĞµĞ¼Ğ°Ñ” Ñ€Ğ¾ÑƒÑ‚Ñƒ /adjust)
        // ĞĞ‘Ğ (ĞºÑ€Ğ°Ñ‰Ğµ) - ÑĞºÑ‰Ğ¾ Ğ²Ğ¸ Ğ½Ğµ Ñ€Ğ¾Ğ±Ğ¸Ğ»Ğ¸ Ñ€Ğ¾ÑƒÑ‚ adjust, Ñ‚Ğ¾ Ñ‚Ñ€ĞµĞ±Ğ° Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ¾Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğ¸ Ğ¿Ğ¾Ğ»Ğµ stock_quantity
        
        // Ğ’Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚ Ğ (ÑĞºÑ‰Ğ¾ Ñ” Ñ€Ğ¾ÑƒÑ‚ update):
        const item = filteredItems.value.find(i => i.id === adjustmentForm.value.id)
        const newQuantity = parseFloat(item.stock_quantity) + parseFloat(adjustmentForm.value.delta)
        
        await axios.put(`http://localhost:8001/inventory/${endpoint}/${adjustmentForm.value.id}`, {
            ...item,
            stock_quantity: newQuantity
        })

        await fetchWarehouseData()
        showAdjustmentModal.value = false
    } catch (e) {
        console.error(e)
        alert("ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ Ğ·Ğ°Ğ»Ğ¸ÑˆĞºÑƒ")
    }
}

// Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ¿Ñ€Ğ¸ Ğ²Ñ–Ğ´ĞºÑ€Ğ¸Ñ‚Ñ‚Ñ– Ğ²ĞºĞ»Ğ°Ğ´ĞºĞ¸
onMounted(() => {
    fetchWarehouseData()
})
</script>

<template>
    <div class="space-y-6">
        <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col md:flex-row justify-between items-center gap-4">
            
            <div class="flex bg-gray-100 p-1 rounded-xl">
                <button 
                    @click="activeCategory = 'ingredients'"
                    class="px-4 py-2 rounded-lg text-sm font-bold transition"
                    :class="activeCategory === 'ingredients' ? 'bg-white shadow text-blue-600' : 'text-gray-500 hover:text-gray-700'"
                >
                    ğŸ‹ Ğ†Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ğ¸
                </button>
                <button 
                    @click="activeCategory = 'consumables'"
                    class="px-4 py-2 rounded-lg text-sm font-bold transition"
                    :class="activeCategory === 'consumables' ? 'bg-white shadow text-purple-600' : 'text-gray-500 hover:text-gray-700'"
                >
                    ğŸ“¦ ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸
                </button>
            </div>

            <div class="relative w-full md:w-64">
                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                <input 
                    v-model="searchQuery" 
                    type="text" 
                    placeholder="ĞŸĞ¾ÑˆÑƒĞº Ğ¿Ğ¾ ÑĞºĞ»Ğ°Ğ´Ñƒ..." 
                    class="w-full pl-10 pr-4 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-100 outline-none text-sm"
                >
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
            <table class="w-full text-left text-sm">
                <thead class="bg-gray-50 text-xs uppercase font-bold text-gray-500">
                    <tr>
                        <th class="p-4">ĞĞ°Ğ·Ğ²Ğ°</th>
                        <th class="p-4 text-center">Ğ—Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº</th>
                        <th class="p-4">ĞĞ´. Ğ²Ğ¸Ğ¼.</th>
                        <th class="p-4">Ğ’Ğ°Ñ€Ñ‚Ñ–ÑÑ‚ÑŒ Ğ¾Ğ´.</th>
                        <th class="p-4 text-center">Ğ”Ñ–Ñ—</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    <tr v-if="filteredItems.length === 0">
                        <td colspan="5" class="p-8 text-center text-gray-400">ĞÑ–Ñ‡Ğ¾Ğ³Ğ¾ Ğ½Ğµ Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾</td>
                    </tr>
                    <tr v-for="item in filteredItems" :key="item.id" class="hover:bg-gray-50 transition">
                        <td class="p-4 font-bold text-gray-700">{{ item.name }}</td>
                        
                        <td class="p-4 text-center">
                            <span 
                                class="px-3 py-1 rounded-full font-mono font-bold text-xs"
                                :class="{
                                    'bg-green-100 text-green-700': item.stock_quantity > 10,
                                    'bg-yellow-100 text-yellow-700': item.stock_quantity <= 10 && item.stock_quantity > 0,
                                    'bg-red-100 text-red-700': item.stock_quantity <= 0
                                }"
                            >
                                {{ item.stock_quantity }}
                            </span>
                        </td>
                        
                        <td class="p-4 text-gray-500">{{ item.unit ? item.unit.symbol : '-' }}</td>
                        <td class="p-4 font-mono">{{ item.cost_per_unit }} â‚´</td>
                        
                        <td class="p-4 text-center">
                            <button 
                                @click="openAdjustment(item, activeCategory === 'ingredients' ? 'ingredient' : 'consumable')"
                                class="text-blue-600 hover:bg-blue-50 px-3 py-1 rounded text-xs font-bold transition border border-blue-200"
                            >
                                ĞšĞ¾Ñ€Ğ¸Ğ³ÑƒĞ²Ğ°Ñ‚Ğ¸
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div v-if="showAdjustmentModal" class="fixed inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl p-6">
                <h3 class="text-lg font-bold mb-1">ĞšĞ¾Ñ€Ğ¸Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ·Ğ°Ğ»Ğ¸ÑˆĞºÑƒ</h3>
                <p class="text-sm text-gray-500 mb-4">
                    {{ adjustmentForm.currentName }} (ĞŸĞ¾Ñ‚Ğ¾Ñ‡Ğ½Ğ¾: {{ adjustmentForm.currentStock }})
                </p>

                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ğ—Ğ¼Ñ–Ğ½Ğ° (+/-)</label>
                        <input 
                            v-model.number="adjustmentForm.delta" 
                            type="number" 
                            class="w-full border p-3 rounded-xl font-mono text-lg font-bold outline-none focus:ring-2 focus:ring-blue-100"
                            placeholder="ĞĞ°Ğ¿Ñ€. -5 Ğ°Ğ±Ğ¾ 10"
                        >
                        <p class="text-[10px] text-gray-400 mt-1">Ğ’Ğ²ĞµĞ´Ñ–Ñ‚ÑŒ Ğ²Ñ–Ğ´'Ñ”Ğ¼Ğ½Ğµ Ñ‡Ğ¸ÑĞ»Ğ¾ Ğ´Ğ»Ñ ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ½Ñ</p>
                    </div>
                    
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°</label>
                        <input 
                            v-model="adjustmentForm.reason" 
                            class="w-full border p-2 rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-100"
                            placeholder="Ğ†Ğ½Ğ²ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ·Ğ°Ñ†Ñ–Ñ, Ñ€Ğ¾Ğ·Ğ±Ğ¸Ñ‚Ğ¾..."
                        >
                    </div>

                    <div class="flex gap-2 pt-2">
                        <button @click="showAdjustmentModal = false" class="flex-1 py-2 text-gray-500 font-bold hover:bg-gray-50 rounded-xl">Ğ¡ĞºĞ°ÑÑƒĞ²Ğ°Ñ‚Ğ¸</button>
                        <button @click="saveAdjustment" class="flex-1 py-2 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 shadow-lg shadow-blue-200">Ğ—Ğ±ĞµÑ€ĞµĞ³Ñ‚Ğ¸</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>

--------------------------------------------------
PATH: ./.history/frontend/src/components/warehouse/tabs/StockTab_20260126154519.vue
--------------------------------------------------
<script setup>
import { ref, computed, onMounted, defineAsyncComponent } from 'vue' // Ğ”Ğ¾Ğ´Ğ°Ğ»Ğ¸ defineAsyncComponent
import { useWarehouse } from '@/composables/useWarehouse'
import axios from 'axios'

// Ğ†Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ÑƒÑ”Ğ¼Ğ¾ Ğ¼Ğ¾Ğ´Ğ°Ğ»ĞºÑƒ Ñ–ÑÑ‚Ğ¾Ñ€Ñ–Ñ— (Ñ‚Ğ°Ğº ÑĞ°Ğ¼Ğ¾, ÑĞº Ğ±ÑƒĞ»Ğ¾ Ğ² ÑÑ‚Ğ°Ñ€Ñ–Ğ¹ Ğ²ĞµÑ€ÑÑ–Ñ—)
const HistoryModal = defineAsyncComponent(() => import('../modals/HistoryModal.vue'))

// ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ğ´Ğ°Ğ½Ñ– Ğ·Ñ– ÑÑ…Ğ¾Ğ²Ğ¸Ñ‰Ğ°
const { ingredients, consumables, products, fetchWarehouseData } = useWarehouse()

const activeTab = ref('ingredients') 
const search = ref('')
const loading = ref(false)

// Ğ—Ğ¼Ñ–Ğ½Ğ½Ñ– Ğ´Ğ»Ñ Ñ€ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ
const editingItem = ref(null)
const editValue = ref(0)

// --- Ğ—ĞœĞ†ĞĞĞ† Ğ”Ğ›Ğ¯ Ğ†Ğ¡Ğ¢ĞĞ Ğ†Ğ‡ ---
const isHistoryOpen = ref(false)
const historyItem = ref(null)

// --- Ğ¤Ğ£ĞĞšĞ¦Ğ†Ğ¯ Ğ’Ğ†Ğ”ĞšĞ Ğ˜Ğ¢Ğ¢Ğ¯ Ğ†Ğ¡Ğ¢ĞĞ Ğ†Ğ‡ ---
const openHistory = (item) => {
    // Ğ¤Ğ¾Ñ€Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ğ¾Ğ±'Ñ”ĞºÑ‚, ÑĞºĞ¸Ğ¹ Ğ¾Ñ‡Ñ–ĞºÑƒÑ” HistoryModal
    historyItem.value = {
        id: item.original_id || item.id, // ID ÑÑƒÑ‚Ğ½Ğ¾ÑÑ‚Ñ– Ğ² Ğ±Ğ°Ğ·Ñ–
        type: item.type,                 // 'ingredient', 'consumable', 'product', 'product_variant'
        name: item.display_name          // ĞĞ°Ğ·Ğ²Ğ° Ğ´Ğ»Ñ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ°
    }
    isHistoryOpen.value = true
}

// --- ĞŸĞ»Ğ¾ÑĞºĞ¸Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ´Ğ»Ñ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ– ---
const filteredItems = computed(() => {
    let list = []

    // 1. Ğ¡Ğ˜Ğ ĞĞ’Ğ˜ĞĞ
    if (activeTab.value === 'ingredients') {
        list = ingredients.value.map(i => ({ 
            ...i, 
            type: 'ingredient', 
            display_name: i.name,
            unit_symbol: i.unit?.symbol || '' 
        }))
    } 
    // 2. ĞœĞĞ¢Ğ•Ğ Ğ†ĞĞ›Ğ˜
    else if (activeTab.value === 'consumables') {
        list = consumables.value.map(c => ({ 
            ...c, 
            type: 'consumable', 
            display_name: c.name,
            unit_symbol: c.unit?.symbol || ''
        }))
    } 
    // 3. Ğ¢ĞĞ’ĞĞ Ğ˜ (Ğ Ğ¾Ğ·Ğ³Ğ¾Ñ€Ñ‚Ğ°Ñ”Ğ¼Ğ¾ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸!)
    else if (activeTab.value === 'products') {
        products.value.forEach(p => {
            if (p.has_variants && p.variants) {
                // Ğ’Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸
                p.variants.forEach(v => {
                    list.push({
                        id: v.id, 
                        original_id: v.id,
                        type: 'product_variant', 
                        display_name: `${p.name} (${v.name})`, 
                        stock_quantity: v.stock_quantity,
                        unit_symbol: 'ÑˆÑ‚',
                        product_id: p.id 
                    })
                })
            } else {
                // ĞŸÑ€Ğ¾ÑÑ‚Ñ– Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¸
                list.push({
                    id: p.id,
                    original_id: p.id,
                    type: 'product',
                    display_name: p.name,
                    stock_quantity: p.stock_quantity,
                    unit_symbol: 'ÑˆÑ‚'
                })
            }
        })
    }

    if (search.value) {
        const s = search.value.toLowerCase()
        return list.filter(i => i.display_name.toLowerCase().includes(s))
    }
    return list
})

// --- Ğ›ĞĞ“Ğ†ĞšĞ Ğ Ğ•Ğ”ĞĞ“Ğ£Ğ’ĞĞĞĞ¯ Ğ—ĞĞ›Ğ˜Ğ¨ĞšĞ†Ğ’ ---
const startEdit = (item) => {
    editingItem.value = item.id 
    editValue.value = item.stock_quantity
}

const saveEdit = async (item) => {
    if (editValue.value < 0) return alert("ĞĞµ Ğ¼Ğ¾Ğ¶Ğµ Ğ±ÑƒÑ‚Ğ¸ Ğ¼Ñ–Ğ½ÑƒÑĞ¾Ğ²Ğ¸Ğ¼")
    
    loading.value = true
    try {
        let url = ''
        let payload = {}
        let method = 'put'

        if (item.type === 'ingredient') {
            url = `/api/ingredients/${item.original_id || item.id}`
            payload = { ...item, stock_quantity: editValue.value }
        } 
        else if (item.type === 'consumable') {
            url = `/api/consumables/${item.original_id || item.id}`
            payload = { ...item, stock_quantity: editValue.value }
        }
        else if (item.type === 'product') {
            url = `/api/products/${item.original_id || item.id}/stock?qty=${editValue.value}`
            method = 'patch'
            payload = {} 
        }
        else if (item.type === 'product_variant') {
            url = `/api/products/variants/${item.original_id || item.id}/stock?qty=${editValue.value}`
            method = 'patch'
            payload = {}
        }

        if (method === 'put') {
            await axios.put(url, payload)
        } else {
            await axios.patch(url)
        }

        item.stock_quantity = editValue.value
        await fetchWarehouseData()
        editingItem.value = null
    } catch (e) {
        console.error(e)
        alert("ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ Ğ·Ğ°Ğ»Ğ¸ÑˆĞºÑƒ")
    } finally {
        loading.value = false
    }
}

onMounted(() => {
    fetchWarehouseData()
})
</script>

<template>
    <div class="h-full flex flex-col bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
        
        <div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center gap-4">
            <div class="flex p-1 bg-white rounded-xl border border-gray-200 shadow-sm">
                <button 
                    v-for="tab in ['ingredients', 'consumables', 'products']" 
                    :key="tab"
                    @click="activeTab = tab"
                    class="px-4 py-2 text-xs font-bold rounded-lg transition-all"
                    :class="activeTab === tab ? 'bg-blue-600 text-white shadow-md' : 'text-gray-500 hover:bg-gray-50'"
                >
                    {{ tab === 'ingredients' ? 'ğŸ¥¦ Ğ¡Ğ¸Ñ€Ğ¾Ğ²Ğ¸Ğ½Ğ°' : (tab === 'consumables' ? 'ğŸ“¦ ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸' : 'ğŸ¹ Ğ¢Ğ¾Ğ²Ğ°Ñ€Ğ¸') }}
                </button>
            </div>

            <input 
                v-model="search" 
                placeholder="ĞŸĞ¾ÑˆÑƒĞº..." 
                class="border border-gray-200 rounded-xl px-3 py-2 text-sm outline-none focus:border-blue-500 w-64"
            >
        </div>

        <div class="flex-1 overflow-auto">
            <table class="w-full text-left text-sm">
                <thead class="bg-gray-50 text-gray-500 uppercase text-xs sticky top-0 z-10">
                    <tr>
                        <th class="p-4">ĞĞ°Ğ·Ğ²Ğ°</th>
                        <th class="p-4 text-center">Ğ¢Ğ¸Ğ¿</th>
                        <th class="p-4 text-right">Ğ—Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº</th>
                        <th class="p-4 text-center">Ğ”Ñ–Ñ—</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    <tr v-if="filteredItems.length === 0">
                        <td colspan="4" class="p-8 text-center text-gray-400">
                            ĞÑ–Ñ‡Ğ¾Ğ³Ğ¾ Ğ½Ğµ Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾...
                        </td>
                    </tr>
                    
                    <tr v-for="item in filteredItems" :key="item.id + item.type" class="hover:bg-gray-50 group">
                        
                        <td class="p-4 font-bold text-gray-700">
                            {{ item.display_name }}
                        </td>

                        <td class="p-4 text-center">
                            <span v-if="item.type === 'ingredient'" class="bg-green-100 text-green-700 px-2 py-1 rounded text-[10px] font-bold">Ğ¡Ğ¸Ñ€Ğ¾Ğ²Ğ¸Ğ½Ğ°</span>
                            <span v-else-if="item.type === 'consumable'" class="bg-teal-100 text-teal-700 px-2 py-1 rounded text-[10px] font-bold">ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»</span>
                            <span v-else-if="item.type === 'product'" class="bg-purple-100 text-purple-700 px-2 py-1 rounded text-[10px] font-bold">Ğ¢Ğ¾Ğ²Ğ°Ñ€</span>
                            <span v-else-if="item.type === 'product_variant'" class="bg-indigo-100 text-indigo-700 px-2 py-1 rounded text-[10px] font-bold">Ğ’Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚</span>
                        </td>

                        <td class="p-4 text-right font-mono font-bold">
                            <div v-if="editingItem === item.id" class="flex items-center justify-end gap-2">
                                <input 
                                    v-model.number="editValue" 
                                    type="number" 
                                    class="w-20 border rounded p-1 text-right focus:ring-2 ring-blue-500 outline-none"
                                >
                                <span class="text-xs text-gray-400">{{ item.unit_symbol }}</span>
                            </div>
                            <span v-else :class="{'text-red-500 bg-red-50 px-2 py-1 rounded': item.stock_quantity <= 0, 'text-gray-700': item.stock_quantity > 0}">
                                {{ item.stock_quantity }} {{ item.unit_symbol }}
                            </span>
                        </td>

                        <td class="p-4 text-center">
                            <div v-if="editingItem === item.id" class="flex justify-center gap-1">
                                <button @click="saveEdit(item)" class="bg-green-500 text-white w-7 h-7 rounded hover:bg-green-600 flex items-center justify-center">
                                    <i class="fas fa-check text-xs"></i>
                                </button>
                                <button @click="editingItem = null" class="bg-gray-300 text-gray-700 w-7 h-7 rounded hover:bg-gray-400 flex items-center justify-center">
                                    <i class="fas fa-times text-xs"></i>
                                </button>
                            </div>
                            
                            <div v-else class="flex justify-center gap-2">
                                <button @click="openHistory(item)" class="text-purple-400 hover:text-purple-600 p-2 rounded hover:bg-purple-50 transition-colors" title="Ğ†ÑÑ‚Ğ¾Ñ€Ñ–Ñ Ñ€ÑƒÑ…Ñƒ">
                                    <i class="fas fa-history"></i>
                                </button>
                                <button @click="startEdit(item)" class="text-blue-400 hover:text-blue-600 p-2 rounded hover:bg-blue-50 transition-colors" title="ĞšĞ¾Ñ€ĞµĞ³ÑƒĞ²Ğ°Ñ‚Ğ¸ Ğ·Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº">
                                    <i class="fas fa-pen"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <HistoryModal 
            v-if="isHistoryOpen" 
            :is-open="isHistoryOpen" 
            :item="historyItem" 
            @close="isHistoryOpen = false" 
        />
    </div>
</template>

--------------------------------------------------
PATH: ./.history/frontend/src/components/warehouse/tabs/ProductsTab_20260125124734.vue
--------------------------------------------------
<script setup>
import { ref, onMounted } from 'vue'
import { useWarehouse } from '@/composables/useWarehouse'
import { useProducts } from '@/composables/useProducts'

const { categories, recipes, ingredients, consumables } = useWarehouse()

const { 
    newProduct, isEditing, 
    variantBuilder, tempProductConsumable, tempVariantConsumable, tempVariantIngredient,
    resetForm, prepareEdit, saveProduct, deleteProduct, fetchProducts, filteredProducts, productSearch,
    
    // ĞĞ¾Ğ²Ñ– Ñ„ÑƒĞ½ĞºÑ†Ñ–Ñ— Ğ´Ğ»Ñ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñ–Ğ²
    saveVariant, editVariant, cancelVariantEdit, editingVariantIndex, removeVariant, 
    
    addProductConsumable, removeProductConsumable,
    addVariantConsumable, removeVariantConsumable,
    addIngredientToVariant, removeIngredientFromVariant
} = useProducts()

const showForm = ref(false)

const getCategoryName = (id) => {
    if (!categories.value) return '-'
    const c = categories.value.find(x => x.id === id)
    return c ? c.name : '-'
}

const handleSave = async () => {
    const success = await saveProduct()
    if(success) {
        showForm.value = false
        await fetchProducts()
    }
}

const handleEdit = (product) => {
    prepareEdit(product)
    showForm.value = true
}

onMounted(async () => {
    await fetchProducts()
})
</script>

<template>
    <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
        
        <div v-if="showForm" class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 h-fit xl:col-span-1">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-gray-700">
                    {{ isEditing ? 'âœï¸ Ğ ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ' : 'ğŸ“¦ ĞĞ¾Ğ²Ğ¸Ğ¹ Ñ‚Ğ¾Ğ²Ğ°Ñ€' }}
                </h3>
                <button @click="showForm = false; resetForm()" class="text-xs text-red-500 hover:underline">Ğ—Ğ°ĞºÑ€Ğ¸Ñ‚Ğ¸</button>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞĞ°Ğ·Ğ²Ğ°</label>
                    <input v-model="newProduct.name" class="border p-2 rounded w-full focus:ring-2 ring-blue-100 outline-none">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ</label>
                        <select v-model="newProduct.category_id" class="border p-2 rounded w-full bg-white">
                            <option :value="null">-- Ğ‘ĞµĞ· ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ— --</option>
                            <option v-for="c in categories" :key="c.id" :value="c.id">{{ c.name }}</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ğ¦Ñ–Ğ½Ğ° (Ğ±Ğ°Ğ·Ğ¾Ğ²Ğ°)</label>
                        <input v-model.number="newProduct.price" type="number" class="border p-2 rounded w-full">
                    </div>
                </div>

                <div class="flex items-center gap-2 py-2">
                    <input type="checkbox" v-model="newProduct.has_variants" id="hasVar" class="w-4 h-4 text-blue-600">
                    <label for="hasVar" class="text-sm font-bold text-gray-700 select-none">Ğ¦ĞµĞ¹ Ñ‚Ğ¾Ğ²Ğ°Ñ€ Ğ¼Ğ°Ñ” Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸</label>
                </div>

                <div v-if="!newProduct.has_variants" class="bg-gray-50 p-3 rounded border border-gray-200 space-y-3">
                     <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞœĞ°Ğ¹ÑÑ‚ĞµÑ€-Ñ€ĞµÑ†ĞµĞ¿Ñ‚</label>
                        <select v-model="newProduct.master_recipe_id" class="border p-2 rounded w-full bg-white text-sm">
                            <option :value="null">-- Ğ‘ĞµĞ· Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ñƒ --</option>
                            <option v-for="r in recipes" :key="r.id" :value="r.id">{{ r.name }}</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ğ’Ğ¸Ñ…Ñ–Ğ´Ğ½Ğ° Ğ²Ğ°Ğ³Ğ° (Ğ³/Ğ¼Ğ»)</label>
                        <input v-model.number="newProduct.output_weight" type="number" class="border p-2 rounded w-full text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞŸĞ¾Ñ‡Ğ°Ñ‚ĞºĞ¾Ğ²Ğ¸Ğ¹ Ğ·Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº</label>
                        <input v-model.number="newProduct.stock_quantity" type="number" class="border p-2 rounded w-full text-sm" placeholder="0">
                    </div>
                </div>

                <div class="bg-teal-50/50 p-3 rounded border border-teal-100">
                    <label class="text-[10px] uppercase font-bold text-teal-600 mb-2 block">Ğ—Ğ°Ğ³Ğ°Ğ»ÑŒĞ½Ñ– Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸</label>
                    <div class="flex gap-2 mb-2">
                        <select v-model="tempProductConsumable.consumable_id" class="flex-1 border p-1 rounded text-sm bg-white">
                            <option value="">ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»...</option>
                            <option v-for="c in consumables" :key="c.id" :value="c.id">{{ c.name }}</option>
                        </select>
                        <button @click="addProductConsumable" class="bg-teal-500 text-white w-8 rounded">+</button>
                    </div>
                    <div class="flex flex-wrap gap-1">
                        <span v-for="(pc, idx) in newProduct.consumables" :key="idx" class="bg-white border border-teal-200 text-teal-700 text-xs px-2 py-1 rounded flex items-center gap-1">
                            {{ pc.name }} <button @click="removeProductConsumable(idx)" class="text-red-500 font-bold ml-1">&times;</button>
                        </span>
                    </div>
                </div>

                <div v-if="newProduct.has_variants" class="space-y-3">
                    <div class="border-t pt-2 mt-2">
                        <div class="flex justify-between items-center mb-2">
                             <h4 class="font-bold text-sm text-purple-700">
                                 {{ editingVariantIndex !== null ? 'âœï¸ Ğ ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ' : 'ĞšĞ¾Ğ½ÑÑ‚Ñ€ÑƒĞºÑ‚Ğ¾Ñ€ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñ–Ğ²' }}
                             </h4>
                             <button v-if="editingVariantIndex !== null" @click="cancelVariantEdit" class="text-xs text-gray-500 underline">Ğ¡ĞºĞ°ÑÑƒĞ²Ğ°Ñ‚Ğ¸</button>
                        </div>
                        
                        <div class="bg-purple-50 p-3 rounded-lg border border-purple-100 space-y-3" :class="{'ring-2 ring-purple-300': editingVariantIndex !== null}">
                            
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="text-[10px] uppercase font-bold text-gray-500">ĞĞ°Ğ·Ğ²Ğ°</label>
                                    <input v-model="variantBuilder.name" placeholder="Ğ½Ğ°Ğ¿Ñ€. XL" class="w-full border p-1.5 rounded text-sm">
                                </div>
                                <div>
                                    <label class="text-[10px] uppercase font-bold text-gray-500">Ğ¦Ñ–Ğ½Ğ°</label>
                                    <input v-model.number="variantBuilder.price" type="number" class="w-full border p-1.5 rounded text-sm">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="text-[10px] uppercase font-bold text-gray-500">Ğ¢ĞµÑ…. ĞºĞ°Ñ€Ñ‚Ğ°</label>
                                    <select v-model="variantBuilder.master_recipe_id" class="w-full border p-1.5 rounded text-sm bg-white">
                                        <option :value="null">-- Ğ‘ĞµĞ· Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ñƒ --</option>
                                        <option v-for="r in recipes" :key="r.id" :value="r.id">{{ r.name }}</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-[10px] uppercase font-bold text-gray-500">Ğ’Ğ°Ğ³Ğ° Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¾Ğ³Ğ¾ (Ğ³/Ğ¼Ğ»)</label>
                                    <input v-model.number="variantBuilder.output_weight" type="number" class="w-full border p-1.5 rounded text-sm">
                                </div>
                            </div>
                            
                            <div>
                                <label class="text-[10px] uppercase font-bold text-gray-500">ĞŸĞ¾Ñ‡Ğ°Ñ‚ĞºĞ¾Ğ²Ğ¸Ğ¹ Ğ·Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº (ÑˆÑ‚)</label>
                                <input v-model.number="variantBuilder.stock_quantity" type="number" class="w-full border p-1.5 rounded text-sm bg-white" placeholder="0">
                            </div>

                            <div class="bg-white/50 p-2 rounded border border-dashed border-purple-200">
                                <label class="text-[10px] uppercase font-bold text-purple-400">ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ</label>
                                <div class="flex gap-1 mb-1">
                                    <select v-model="tempVariantConsumable.consumable_id" class="flex-1 border p-1 rounded text-[10px] bg-white h-7">
                                        <option value="">ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»...</option>
                                        <option v-for="c in consumables" :key="c.id" :value="c.id">{{ c.name }}</option>
                                    </select>
                                    <input v-model.number="tempVariantConsumable.quantity" type="number" class="w-10 border p-1 rounded text-[10px] h-7" placeholder="Ğš-ÑÑ‚ÑŒ">
                                    <button @click="addVariantConsumable" class="bg-purple-500 text-white w-7 h-7 rounded hover:bg-purple-600 text-xs">+</button>
                                </div>
                                <div class="flex flex-wrap gap-1">
                                    <span v-for="(vc, idx) in variantBuilder.consumables" :key="idx" class="bg-white border text-[10px] px-1 rounded flex items-center gap-1">
                                        {{ vc.name }}: {{ vc.quantity }} <button @click="removeVariantConsumable(idx)" class="text-red-500 font-bold">&times;</button>
                                    </span>
                                </div>
                            </div>

                            <div class="bg-blue-50/50 p-2 rounded border border-dashed border-blue-200">
                                <label class="text-[10px] uppercase font-bold text-blue-500">Ğ”Ğ¾Ğ´Ğ°Ñ‚ĞºĞ¾Ğ²Ñ– Ñ–Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ğ¸</label>
                                <div class="flex gap-1 mb-1">
                                    <select v-model="tempVariantIngredient.ingredient_id" class="flex-1 border p-1 rounded text-[10px] bg-white h-7">
                                        <option value="">Ğ†Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚...</option>
                                        <option v-for="i in ingredients" :key="i.id" :value="i.id">{{ i.name }}</option>
                                    </select>
                                    <input v-model.number="tempVariantIngredient.quantity" type="number" class="w-10 border p-1 rounded text-[10px] h-7" placeholder="Ğ“Ñ€Ğ°Ğ¼">
                                    <button @click="addIngredientToVariant" class="bg-blue-500 text-white w-7 h-7 rounded hover:bg-blue-600 text-xs">+</button>
                                </div>
                                <div class="flex flex-wrap gap-1">
                                    <span v-for="(vi, idx) in variantBuilder.ingredients" :key="idx" class="bg-white border text-[10px] px-1 rounded flex items-center gap-1 text-blue-700">
                                        {{ vi.name }}: {{ vi.quantity }} <button @click="removeIngredientFromVariant(idx)" class="text-red-500 font-bold">&times;</button>
                                    </span>
                                </div>
                            </div>

                            <button @click="saveVariant" class="w-full text-xs font-bold py-2 rounded transition-colors"
                                :class="editingVariantIndex !== null ? 'bg-orange-400 text-white hover:bg-orange-500' : 'bg-purple-200 text-purple-800 hover:bg-purple-300'">
                                {{ editingVariantIndex !== null ? 'Ğ—Ğ±ĞµÑ€ĞµĞ³Ñ‚Ğ¸ Ğ·Ğ¼Ñ–Ğ½Ğ¸ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ' : 'Ğ”Ğ¾Ğ´Ğ°Ñ‚Ğ¸ Ñ†ĞµĞ¹ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚ Ñƒ ÑĞ¿Ğ¸ÑĞ¾Ğº' }}
                            </button>
                        </div>
                    </div>
                    
                    <div v-if="newProduct.variants.length > 0" class="space-y-2">
                        <div v-for="(v, idx) in newProduct.variants" :key="idx" 
                             class="bg-white border p-2 rounded flex justify-between items-center text-sm"
                             :class="{'border-purple-400 bg-purple-50': editingVariantIndex === idx}"
                        >
                            <div>
                                <span class="font-bold">{{ v.name }}</span> - {{ v.price }} Ğ³Ñ€Ğ½
                                <div class="text-xs text-gray-400">
                                    <span v-if="v.master_recipe_id" class="text-purple-600 mr-2">ğŸ“œ Ğ ĞµÑ†ĞµĞ¿Ñ‚ ID: {{ v.master_recipe_id }}</span>
                                    <span v-if="v.stock_quantity > 0" class="text-green-600 font-bold">Ğ—Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº: {{ v.stock_quantity }}</span>
                                    <span v-if="v.ingredients?.length" class="text-blue-500 ml-2">Ğ†Ğ½Ğ³Ñ€: {{ v.ingredients.length }}</span>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button @click="editVariant(idx)" class="text-blue-500 hover:text-blue-700" title="Ğ ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ñ‚Ğ¸"><i class="fas fa-pen"></i></button>
                                <button @click="removeVariant(idx)" class="text-red-500 hover:text-red-700" title="Ğ’Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğ¸"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    </div>
                </div>

                <button @click="handleSave" class="w-full bg-green-600 text-white font-bold py-3 rounded-xl hover:bg-green-700 mt-4 shadow-lg shadow-green-100">
                    {{ isEditing ? 'Ğ—Ğ±ĞµÑ€ĞµĞ³Ñ‚Ğ¸ Ğ·Ğ¼Ñ–Ğ½Ğ¸' : 'Ğ¡Ñ‚Ğ²Ğ¾Ñ€Ğ¸Ñ‚Ğ¸ Ñ‚Ğ¾Ğ²Ğ°Ñ€' }}
                </button>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden flex flex-col h-full" :class="showForm ? 'xl:col-span-2' : 'xl:col-span-3'">
            
            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
                <div class="flex items-center gap-4">
                    <h2 class="font-bold text-gray-700">Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ–Ğ²</h2>
                    <input v-model="productSearch" placeholder="ĞŸĞ¾ÑˆÑƒĞº..." class="border rounded px-2 py-1 text-sm bg-white">
                </div>
                <button v-if="!showForm" @click="showForm = true; resetForm()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-bold text-sm shadow-md shadow-blue-100">
                    + ĞĞ¾Ğ²Ğ¸Ğ¹ Ñ‚Ğ¾Ğ²Ğ°Ñ€
                </button>
            </div>

            <div class="overflow-auto flex-1">
                <table class="w-full text-left text-sm">
                    <thead class="bg-gray-50 text-gray-500 uppercase text-xs sticky top-0">
                        <tr>
                            <th class="p-4">ĞĞ°Ğ·Ğ²Ğ°</th>
                            <th class="p-4">ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ</th>
                            <th class="p-4">Ğ¦Ñ–Ğ½Ğ° / Ğ’Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸</th>
                            <th class="p-4 text-center">Ğ”Ñ–Ñ—</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        <tr v-if="filteredProducts.length === 0">
                            <td colspan="4" class="p-8 text-center text-gray-400">
                                Ğ¢Ğ¾Ğ²Ğ°Ñ€Ñ–Ğ² Ğ½ĞµĞ¼Ğ°Ñ” Ğ°Ğ±Ğ¾ Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ...
                            </td>
                        </tr>
                        <tr v-for="p in filteredProducts" :key="p.id" class="hover:bg-gray-50 align-top group">
                            <td class="p-4 font-bold text-gray-800">{{ p.name }}</td>
                            <td class="p-4 text-gray-600">
                                <span class="bg-gray-100 px-2 py-1 rounded text-xs">{{ getCategoryName(p.category_id) }}</span>
                            </td>
                            <td class="p-4">
                                <div v-if="!p.has_variants" class="font-mono font-bold text-green-600">
                                    {{ p.price }} â‚´
                                </div>
                                
                                <div v-else class="space-y-2">
                                    <div v-for="v in p.variants" :key="v.id" class="text-xs bg-gray-50 p-2 rounded border border-gray-200">
                                        <div class="flex justify-between font-bold mb-1">
                                            <span>{{ v.name }}</span>
                                            <span>{{ v.price }} â‚´</span>
                                        </div>

                                        <div class="text-gray-500 flex flex-col gap-1">
                                            
                                            <span v-if="v.ingredients?.length" class="text-blue-600 flex items-center gap-1">
                                                <i class="fas fa-flask"></i> Ğ†Ğ½Ğ³Ñ€: {{ v.ingredients.length }}
                                            </span>

                                            <div v-if="v.consumables?.length" class="text-teal-600">
                                                <div class="flex items-start gap-1">
                                                    <i class="fas fa-box-open mt-0.5"></i> 
                                                    <div class="flex flex-wrap gap-1">
                                                        <span v-for="vc in v.consumables" :key="vc.id" class="bg-teal-50 border border-teal-100 px-1 rounded">
                                                            {{ vc.consumable_name || '?' }}: {{ vc.quantity }}
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>

                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td class="p-4 text-center">
                                <div class="flex justify-center gap-2">
                                    <button @click="handleEdit(p)" class="text-blue-500 hover:text-blue-700 p-1.5 hover:bg-blue-50 rounded"><i class="fas fa-pen"></i></button>
                                    <button @click="deleteProduct(p.id)" class="text-red-400 hover:text-red-600 p-1.5 hover:bg-red-50 rounded"><i class="fas fa-trash"></i></button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</template>

--------------------------------------------------
PATH: ./.history/frontend/src/components/warehouse/tabs/ProductsTab_20260125111222.vue
--------------------------------------------------
<script setup>
import { ref, onMounted } from 'vue'
import { useWarehouse } from '@/composables/useWarehouse'
import { useProducts } from '@/composables/useProducts'

// ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ğ´Ğ¾Ğ²Ñ–Ğ´Ğ½Ğ¸ĞºĞ¸ (ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ—, Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ğ¸ Ñ‚Ğ¾Ñ‰Ğ¾)
const { categories, recipes, ingredients, consumables } = useWarehouse()

// ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ñ„ÑƒĞ½ĞºÑ†Ñ–Ğ¾Ğ½Ğ°Ğ» Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ–Ğ²
const { 
    newProduct, isEditing, 
    variantBuilder, tempProductConsumable, tempVariantConsumable, tempVariantIngredient,
    resetForm, prepareEdit, saveProduct, deleteProduct, fetchProducts, filteredProducts, productSearch,
    addVariant, removeVariant, 
    addProductConsumable, removeProductConsumable,
    addVariantConsumable, removeVariantConsumable,
    addIngredientToVariant, removeIngredientFromVariant
} = useProducts()

const showForm = ref(false)

const getCategoryName = (id) => {
    if (!categories.value) return '-'
    const c = categories.value.find(x => x.id === id)
    return c ? c.name : '-'
}

const handleSave = async () => {
    const success = await saveProduct()
    if(success) {
        showForm.value = false
        // Ğ”Ğ¾Ğ´Ğ°Ñ”Ğ¼Ğ¾ Ğ¿Ñ€Ğ¸Ğ¼ÑƒÑĞ¾Ğ²Ğµ Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ
        await fetchProducts()}
}

const handleEdit = (product) => {
    prepareEdit(product)
    showForm.value = true
}

// !!! Ğ’ĞĞ–Ğ›Ğ˜Ğ’Ğ: Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ÑƒÑ”Ğ¼Ğ¾ Ğ´Ğ°Ğ½Ñ– Ğ¿Ñ€Ğ¸ ÑÑ‚Ğ°Ñ€Ñ‚Ñ– ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ° !!!
onMounted(async () => {
    console.log("ProductsTab mounted: fetching data...")
    await fetchProducts()
})
</script>

<template>
    <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
        
        <div v-if="showForm" class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 h-fit xl:col-span-1">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-gray-700">
                    {{ isEditing ? 'âœï¸ Ğ ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ' : 'ğŸ“¦ ĞĞ¾Ğ²Ğ¸Ğ¹ Ñ‚Ğ¾Ğ²Ğ°Ñ€' }}
                </h3>
                <button @click="showForm = false; resetForm()" class="text-xs text-red-500 hover:underline">Ğ—Ğ°ĞºÑ€Ğ¸Ñ‚Ğ¸</button>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞĞ°Ğ·Ğ²Ğ°</label>
                    <input v-model="newProduct.name" class="border p-2 rounded w-full focus:ring-2 ring-blue-100 outline-none">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ</label>
                        <select v-model="newProduct.category_id" class="border p-2 rounded w-full bg-white">
                            <option :value="null">-- Ğ‘ĞµĞ· ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ— --</option>
                            <option v-for="c in categories" :key="c.id" :value="c.id">{{ c.name }}</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ğ¦Ñ–Ğ½Ğ°</label>
                        <input v-model.number="newProduct.price" type="number" class="border p-2 rounded w-full">
                    </div>
                </div>

                <div class="flex items-center gap-2 py-2">
                    <input type="checkbox" v-model="newProduct.has_variants" id="hasVar" class="w-4 h-4 text-blue-600">
                    <label for="hasVar" class="text-sm font-bold text-gray-700 select-none">Ğ¦ĞµĞ¹ Ñ‚Ğ¾Ğ²Ğ°Ñ€ Ğ¼Ğ°Ñ” Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸</label>
                </div>

                <div v-if="!newProduct.has_variants" class="bg-gray-50 p-3 rounded border border-gray-200 space-y-3">
                     <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞœĞ°Ğ¹ÑÑ‚ĞµÑ€-Ñ€ĞµÑ†ĞµĞ¿Ñ‚</label>
                        <select v-model="newProduct.master_recipe_id" class="border p-2 rounded w-full bg-white text-sm">
                            <option :value="null">-- Ğ‘ĞµĞ· Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ñƒ --</option>
                            <option v-for="r in recipes" :key="r.id" :value="r.id">{{ r.name }}</option>
                        </select>
                    </div>
                </div>

                <div class="bg-teal-50/50 p-3 rounded border border-teal-100">
                    <label class="text-[10px] uppercase font-bold text-teal-600 mb-2 block">Ğ—Ğ°Ğ³Ğ°Ğ»ÑŒĞ½Ñ– Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸</label>
                    <div class="flex gap-2 mb-2">
                        <select v-model="tempProductConsumable.consumable_id" class="flex-1 border p-1 rounded text-sm bg-white">
                            <option value="">ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»...</option>
                            <option v-for="c in consumables" :key="c.id" :value="c.id">{{ c.name }}</option>
                        </select>
                        <button @click="addProductConsumable" class="bg-teal-500 text-white w-8 rounded">+</button>
                    </div>
                    <div class="flex flex-wrap gap-1">
                        <span v-for="(pc, idx) in newProduct.consumables" :key="idx" class="bg-white border border-teal-200 text-teal-700 text-xs px-2 py-1 rounded">
                            {{ pc.name }} <button @click="removeProductConsumable(idx)" class="text-red-500 font-bold ml-1">&times;</button>
                        </span>
                    </div>
                </div>

                <div v-if="newProduct.has_variants" class="space-y-3">
                    <div class="border-t pt-2 mt-2">
                        <h4 class="font-bold text-sm text-purple-700 mb-2">ĞšĞ¾Ğ½ÑÑ‚Ñ€ÑƒĞºÑ‚Ğ¾Ñ€ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñ–Ğ²</h4>
                        
                        <div class="bg-purple-50 p-3 rounded-lg border border-purple-100 space-y-3">
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="text-[10px] uppercase font-bold text-gray-500">ĞĞ°Ğ·Ğ²Ğ°</label>
                                    <input v-model="variantBuilder.name" placeholder="Ğ½Ğ°Ğ¿Ñ€. XL" class="w-full border p-1.5 rounded text-sm">
                                </div>
                                <div>
                                    <label class="text-[10px] uppercase font-bold text-gray-500">Ğ¦Ñ–Ğ½Ğ°</label>
                                    <input v-model.number="variantBuilder.price" type="number" class="w-full border p-1.5 rounded text-sm">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="text-[10px] uppercase font-bold text-gray-500">Ğ¢ĞµÑ…. ĞºĞ°Ñ€Ñ‚Ğ° (Ğ ĞµÑ†ĞµĞ¿Ñ‚)</label>
                                    <select v-model="variantBuilder.master_recipe_id" class="w-full border p-1.5 rounded text-sm bg-white">
                                        <option :value="null">-- Ğ‘ĞµĞ· Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ñƒ --</option>
                                        <option v-for="r in recipes" :key="r.id" :value="r.id">{{ r.name }}</option>
                                    </select>
                                    <p v-if="!recipes || recipes.length === 0" class="text-[10px] text-red-500 mt-1">Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ñ–Ğ² Ğ¿ÑƒÑÑ‚Ğ¸Ğ¹!</p>
                                </div>
                                <div>
                                    <label class="text-[10px] uppercase font-bold text-gray-500">Ğ’Ğ°Ğ³Ğ° Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¾Ğ³Ğ¾ (Ğ³/Ğ¼Ğ»)</label>
                                    <input v-model.number="variantBuilder.output_weight" type="number" class="w-full border p-1.5 rounded text-sm">
                                </div>
                            </div>
                            
                            <div>
                                <label class="text-[10px] uppercase font-bold text-gray-500">ĞŸĞ¾Ñ‡Ğ°Ñ‚ĞºĞ¾Ğ²Ğ¸Ğ¹ Ğ·Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº (ÑˆÑ‚)</label>
                                <input v-model.number="variantBuilder.stock_quantity" type="number" class="w-full border p-1.5 rounded text-sm bg-white" placeholder="0">
                            </div>

                            <div class="bg-white/50 p-2 rounded border border-dashed border-purple-200">
                                <label class="text-[10px] uppercase font-bold text-purple-400">ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ</label>
                                <div class="flex gap-1 mb-1">
                                    <select v-model="tempVariantConsumable.consumable_id" class="flex-1 border p-1 rounded text-[10px] bg-white h-7">
                                        <option value="">ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»...</option>
                                        <option v-for="c in consumables" :key="c.id" :value="c.id">{{ c.name }}</option>
                                    </select>
                                    <input v-model.number="tempVariantConsumable.quantity" type="number" class="w-10 border p-1 rounded text-[10px] h-7" placeholder="Ğš-ÑÑ‚ÑŒ">
                                    <button @click="addVariantConsumable" class="bg-purple-500 text-white w-7 h-7 rounded hover:bg-purple-600 text-xs">+</button>
                                </div>
                                <div class="flex flex-wrap gap-1">
                                    <span v-for="(vc, idx) in variantBuilder.consumables" :key="idx" class="bg-white border text-[10px] px-1 rounded flex items-center gap-1">
                                        {{ vc.name }}: {{ vc.quantity }} <button @click="removeVariantConsumable(idx)" class="text-red-500 font-bold">&times;</button>
                                    </span>
                                </div>
                            </div>

                            <div class="bg-blue-50/50 p-2 rounded border border-dashed border-blue-200">
                                <label class="text-[10px] uppercase font-bold text-blue-500">Ğ”Ğ¾Ğ´Ğ°Ñ‚ĞºĞ¾Ğ²Ñ– Ñ–Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ğ¸</label>
                                <div class="flex gap-1 mb-1">
                                    <select v-model="tempVariantIngredient.ingredient_id" class="flex-1 border p-1 rounded text-[10px] bg-white h-7">
                                        <option value="">Ğ†Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚...</option>
                                        <option v-for="i in ingredients" :key="i.id" :value="i.id">{{ i.name }}</option>
                                    </select>
                                    <input v-model.number="tempVariantIngredient.quantity" type="number" class="w-10 border p-1 rounded text-[10px] h-7" placeholder="Ğ“Ñ€Ğ°Ğ¼">
                                    <button @click="addIngredientToVariant" class="bg-blue-500 text-white w-7 h-7 rounded hover:bg-blue-600 text-xs">+</button>
                                </div>
                                <div class="flex flex-wrap gap-1">
                                    <span v-for="(vi, idx) in variantBuilder.ingredients" :key="idx" class="bg-white border text-[10px] px-1 rounded flex items-center gap-1 text-blue-700">
                                        {{ vi.name }}: {{ vi.quantity }} <button @click="removeIngredientFromVariant(idx)" class="text-red-500 font-bold">&times;</button>
                                    </span>
                                </div>
                            </div>

                            <button @click="addVariant" class="w-full bg-purple-200 text-purple-800 text-xs font-bold py-2 rounded hover:bg-purple-300">
                                Ğ”Ğ¾Ğ´Ğ°Ñ‚Ğ¸ Ñ†ĞµĞ¹ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚ Ñƒ ÑĞ¿Ğ¸ÑĞ¾Ğº
                            </button>
                        </div>
                    </div>
                    
                    <div v-if="newProduct.variants.length > 0" class="space-y-2">
                        <div v-for="(v, idx) in newProduct.variants" :key="idx" class="bg-white border p-2 rounded flex justify-between items-center text-sm">
                            <div>
                                <span class="font-bold">{{ v.name }}</span> - {{ v.price }} Ğ³Ñ€Ğ½
                                <div class="text-xs text-gray-400">
                                    <span v-if="v.master_recipe_id" class="text-purple-600 mr-2">ğŸ“œ Ğ ĞµÑ†ĞµĞ¿Ñ‚ ID: {{ v.master_recipe_id }}</span>
                                    <span v-if="v.stock_quantity > 0" class="text-green-600 font-bold">Ğ—Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº: {{ v.stock_quantity }}</span>
                                </div>
                            </div>
                            <button @click="removeVariant(idx)" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                </div>

                <button @click="handleSave" class="w-full bg-green-600 text-white font-bold py-3 rounded-xl hover:bg-green-700 mt-4">
                    {{ isEditing ? 'Ğ—Ğ±ĞµÑ€ĞµĞ³Ñ‚Ğ¸' : 'Ğ¡Ñ‚Ğ²Ğ¾Ñ€Ğ¸Ñ‚Ğ¸' }}
                </button>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden flex flex-col h-full" :class="showForm ? 'xl:col-span-2' : 'xl:col-span-3'">
            
            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
                <div class="flex items-center gap-4">
                    <h2 class="font-bold text-gray-700">Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ–Ğ²</h2>
                    <input v-model="productSearch" placeholder="ĞŸĞ¾ÑˆÑƒĞº..." class="border rounded px-2 py-1 text-sm">
                </div>
                <button v-if="!showForm" @click="showForm = true; resetForm()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-bold text-sm">
                    + ĞĞ¾Ğ²Ğ¸Ğ¹ Ñ‚Ğ¾Ğ²Ğ°Ñ€
                </button>
            </div>

            <div class="overflow-auto flex-1">
                <table class="w-full text-left text-sm">
                    <thead class="bg-gray-50 text-gray-500 uppercase text-xs sticky top-0">
                        <tr>
                            <th class="p-4">ĞĞ°Ğ·Ğ²Ğ°</th>
                            <th class="p-4">ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ</th>
                            <th class="p-4">Ğ¦Ñ–Ğ½Ğ° / Ğ’Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸</th>
                            <th class="p-4 text-center">Ğ”Ñ–Ñ—</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        <tr v-if="filteredProducts.length === 0">
                            <td colspan="4" class="p-8 text-center text-gray-400">
                                Ğ¢Ğ¾Ğ²Ğ°Ñ€Ñ–Ğ² Ğ½ĞµĞ¼Ğ°Ñ” Ğ°Ğ±Ğ¾ Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ...
                            </td>
                        </tr>
                        <tr v-for="p in filteredProducts" :key="p.id" class="hover:bg-gray-50 align-top">
                            <td class="p-4 font-bold text-gray-800">{{ p.name }}</td>
                            <td class="p-4 text-gray-600">
                                <span class="bg-gray-100 px-2 py-1 rounded text-xs">{{ getCategoryName(p.category_id) }}</span>
                            </td>
                            <td class="p-4">
                                <div v-if="!p.has_variants" class="font-mono font-bold text-green-600">{{ p.price }} â‚´</div>
                                <div v-else class="space-y-1">
                                    <div v-for="v in p.variants" :key="v.id" class="text-xs bg-gray-50 p-1 rounded border">
                                        <b>{{ v.name }}</b>: {{ v.price }} â‚´
                                        <span v-if="v.ingredients?.length" class="text-blue-600 ml-1">
                                            (Ğ†Ğ½Ğ³Ñ€: {{ v.ingredients.length }})
                                        </span>
                                    </div>
                                </div>
                            </td>
                            <td class="p-4 text-center">
                                <button @click="handleEdit(p)" class="text-blue-500 hover:text-blue-700 mx-1"><i class="fas fa-pen"></i></button>
                                <button @click="deleteProduct(p.id)" class="text-red-400 hover:text-red-600 mx-1"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</template>

--------------------------------------------------
PATH: ./.history/frontend/src/components/warehouse/tabs/ProductsTab_20260124195231.vue
--------------------------------------------------
<script setup>
import { ref, onMounted } from 'vue'
import { useWarehouse } from '@/composables/useWarehouse'
import { useProducts } from '@/composables/useProducts'

// ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ğ´Ğ¾Ğ²Ñ–Ğ´Ğ½Ğ¸ĞºĞ¸ (ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ—, Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ğ¸ Ñ‚Ğ¾Ñ‰Ğ¾)
const { categories, recipes, ingredients, consumables } = useWarehouse()

// ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ñ„ÑƒĞ½ĞºÑ†Ñ–Ğ¾Ğ½Ğ°Ğ» Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ–Ğ²
const { 
    newProduct, isEditing, 
    variantBuilder, tempProductConsumable, tempVariantConsumable, tempVariantIngredient,
    resetForm, prepareEdit, saveProduct, deleteProduct, fetchProducts, filteredProducts, productSearch,
    addVariant, removeVariant, 
    addProductConsumable, removeProductConsumable,
    addVariantConsumable, removeVariantConsumable,
    addIngredientToVariant, removeIngredientFromVariant
} = useProducts()

const showForm = ref(false)

const getCategoryName = (id) => {
    if (!categories.value) return '-'
    const c = categories.value.find(x => x.id === id)
    return c ? c.name : '-'
}

const handleSave = async () => {
    const success = await saveProduct()
    if(success) showForm.value = false
}

const handleEdit = (product) => {
    prepareEdit(product)
    showForm.value = true
}

// !!! Ğ’ĞĞ–Ğ›Ğ˜Ğ’Ğ: Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ÑƒÑ”Ğ¼Ğ¾ Ğ´Ğ°Ğ½Ñ– Ğ¿Ñ€Ğ¸ ÑÑ‚Ğ°Ñ€Ñ‚Ñ– ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ° !!!
onMounted(async () => {
    console.log("ProductsTab mounted: fetching data...")
    await fetchProducts()
})
</script>

<template>
    <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
        
        <div v-if="showForm" class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 h-fit xl:col-span-1">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-gray-700">
                    {{ isEditing ? 'âœï¸ Ğ ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ' : 'ğŸ“¦ ĞĞ¾Ğ²Ğ¸Ğ¹ Ñ‚Ğ¾Ğ²Ğ°Ñ€' }}
                </h3>
                <button @click="showForm = false; resetForm()" class="text-xs text-red-500 hover:underline">Ğ—Ğ°ĞºÑ€Ğ¸Ñ‚Ğ¸</button>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞĞ°Ğ·Ğ²Ğ°</label>
                    <input v-model="newProduct.name" class="border p-2 rounded w-full focus:ring-2 ring-blue-100 outline-none">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ</label>
                        <select v-model="newProduct.category_id" class="border p-2 rounded w-full bg-white">
                            <option :value="null">-- Ğ‘ĞµĞ· ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ— --</option>
                            <option v-for="c in categories" :key="c.id" :value="c.id">{{ c.name }}</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ğ¦Ñ–Ğ½Ğ°</label>
                        <input v-model.number="newProduct.price" type="number" class="border p-2 rounded w-full">
                    </div>
                </div>

                <div class="flex items-center gap-2 py-2">
                    <input type="checkbox" v-model="newProduct.has_variants" id="hasVar" class="w-4 h-4 text-blue-600">
                    <label for="hasVar" class="text-sm font-bold text-gray-700 select-none">Ğ¦ĞµĞ¹ Ñ‚Ğ¾Ğ²Ğ°Ñ€ Ğ¼Ğ°Ñ” Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸</label>
                </div>

                <div v-if="!newProduct.has_variants" class="bg-gray-50 p-3 rounded border border-gray-200 space-y-3">
                     <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞœĞ°Ğ¹ÑÑ‚ĞµÑ€-Ñ€ĞµÑ†ĞµĞ¿Ñ‚</label>
                        <select v-model="newProduct.master_recipe_id" class="border p-2 rounded w-full bg-white text-sm">
                            <option :value="null">-- Ğ‘ĞµĞ· Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ñƒ --</option>
                            <option v-for="r in recipes" :key="r.id" :value="r.id">{{ r.name }}</option>
                        </select>
                    </div>
                </div>

                <div class="bg-teal-50/50 p-3 rounded border border-teal-100">
                    <label class="text-[10px] uppercase font-bold text-teal-600 mb-2 block">Ğ—Ğ°Ğ³Ğ°Ğ»ÑŒĞ½Ñ– Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸</label>
                    <div class="flex gap-2 mb-2">
                        <select v-model="tempProductConsumable.consumable_id" class="flex-1 border p-1 rounded text-sm bg-white">
                            <option value="">ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»...</option>
                            <option v-for="c in consumables" :key="c.id" :value="c.id">{{ c.name }}</option>
                        </select>
                        <button @click="addProductConsumable" class="bg-teal-500 text-white w-8 rounded">+</button>
                    </div>
                    <div class="flex flex-wrap gap-1">
                        <span v-for="(pc, idx) in newProduct.consumables" :key="idx" class="bg-white border border-teal-200 text-teal-700 text-xs px-2 py-1 rounded">
                            {{ pc.name }} <button @click="removeProductConsumable(idx)" class="text-red-500 font-bold ml-1">&times;</button>
                        </span>
                    </div>
                </div>

                <div v-if="newProduct.has_variants" class="space-y-3">
                    <div class="border-t pt-2 mt-2">
                        <h4 class="font-bold text-sm text-purple-700 mb-2">ĞšĞ¾Ğ½ÑÑ‚Ñ€ÑƒĞºÑ‚Ğ¾Ñ€ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñ–Ğ²</h4>
                        
                        <div class="bg-purple-50 p-3 rounded-lg border border-purple-100 space-y-3">
                            <div class="grid grid-cols-2 gap-2">
                                <input v-model="variantBuilder.name" placeholder="ĞĞ°Ğ·Ğ²Ğ°" class="border p-1.5 rounded text-sm">
                                <input v-model.number="variantBuilder.price" type="number" placeholder="Ğ¦Ñ–Ğ½Ğ°" class="border p-1.5 rounded text-sm">
                            </div>
                            
                            <div class="bg-blue-50/50 p-2 rounded border border-dashed border-blue-200">
                                <label class="text-[10px] uppercase font-bold text-blue-500">Ğ”Ğ¾Ğ´Ğ°Ñ‚ĞºĞ¾Ğ²Ñ– Ñ–Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ğ¸</label>
                                <div class="flex gap-1 mb-1">
                                    <select v-model="tempVariantIngredient.ingredient_id" class="flex-1 border p-1 rounded text-[10px] bg-white h-7">
                                        <option value="">Ğ†Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚...</option>
                                        <option v-for="i in ingredients" :key="i.id" :value="i.id">{{ i.name }}</option>
                                    </select>
                                    <input v-model.number="tempVariantIngredient.quantity" type="number" class="w-10 border p-1 rounded text-[10px] h-7" placeholder="Ğ³">
                                    <button @click="addIngredientToVariant" class="bg-blue-500 text-white w-7 h-7 rounded text-xs">+</button>
                                </div>
                                <div class="flex flex-wrap gap-1">
                                    <span v-for="(vi, idx) in variantBuilder.ingredients" :key="idx" class="bg-white border text-[10px] px-1 rounded text-blue-700">
                                        {{ vi.name }}: {{ vi.quantity }} <button @click="removeIngredientFromVariant(idx)" class="text-red-500 font-bold">&times;</button>
                                    </span>
                                </div>
                            </div>

                            <button @click="addVariant" class="w-full bg-purple-200 text-purple-800 text-xs font-bold py-2 rounded">Ğ”Ğ¾Ğ´Ğ°Ñ‚Ğ¸ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚</button>
                        </div>
                    </div>

                    <div v-if="newProduct.variants.length > 0" class="space-y-2">
                        <div v-for="(v, idx) in newProduct.variants" :key="idx" class="bg-white border p-2 rounded flex justify-between text-sm">
                            <span><b>{{ v.name }}</b> - {{ v.price }} Ğ³Ñ€Ğ½</span>
                            <button @click="removeVariant(idx)" class="text-red-500"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                </div>

                <button @click="handleSave" class="w-full bg-green-600 text-white font-bold py-3 rounded-xl hover:bg-green-700 mt-4">
                    {{ isEditing ? 'Ğ—Ğ±ĞµÑ€ĞµĞ³Ñ‚Ğ¸' : 'Ğ¡Ñ‚Ğ²Ğ¾Ñ€Ğ¸Ñ‚Ğ¸' }}
                </button>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden flex flex-col h-full" :class="showForm ? 'xl:col-span-2' : 'xl:col-span-3'">
            
            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
                <div class="flex items-center gap-4">
                    <h2 class="font-bold text-gray-700">Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ–Ğ²</h2>
                    <input v-model="productSearch" placeholder="ĞŸĞ¾ÑˆÑƒĞº..." class="border rounded px-2 py-1 text-sm">
                </div>
                <button v-if="!showForm" @click="showForm = true; resetForm()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-bold text-sm">
                    + ĞĞ¾Ğ²Ğ¸Ğ¹ Ñ‚Ğ¾Ğ²Ğ°Ñ€
                </button>
            </div>

            <div class="overflow-auto flex-1">
                <table class="w-full text-left text-sm">
                    <thead class="bg-gray-50 text-gray-500 uppercase text-xs sticky top-0">
                        <tr>
                            <th class="p-4">ĞĞ°Ğ·Ğ²Ğ°</th>
                            <th class="p-4">ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ</th>
                            <th class="p-4">Ğ¦Ñ–Ğ½Ğ° / Ğ’Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸</th>
                            <th class="p-4 text-center">Ğ”Ñ–Ñ—</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        <tr v-if="filteredProducts.length === 0">
                            <td colspan="4" class="p-8 text-center text-gray-400">
                                Ğ¢Ğ¾Ğ²Ğ°Ñ€Ñ–Ğ² Ğ½ĞµĞ¼Ğ°Ñ” Ğ°Ğ±Ğ¾ Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ...
                            </td>
                        </tr>
                        <tr v-for="p in filteredProducts" :key="p.id" class="hover:bg-gray-50 align-top">
                            <td class="p-4 font-bold text-gray-800">{{ p.name }}</td>
                            <td class="p-4 text-gray-600">
                                <span class="bg-gray-100 px-2 py-1 rounded text-xs">{{ getCategoryName(p.category_id) }}</span>
                            </td>
                            <td class="p-4">
                                <div v-if="!p.has_variants" class="font-mono font-bold text-green-600">{{ p.price }} â‚´</div>
                                <div v-else class="space-y-1">
                                    <div v-for="v in p.variants" :key="v.id" class="text-xs bg-gray-50 p-1 rounded border">
                                        <b>{{ v.name }}</b>: {{ v.price }} â‚´
                                        <span v-if="v.ingredients?.length" class="text-blue-600 ml-1">
                                            (Ğ†Ğ½Ğ³Ñ€: {{ v.ingredients.length }})
                                        </span>
                                    </div>
                                </div>
                            </td>
                            <td class="p-4 text-center">
                                <button @click="handleEdit(p)" class="text-blue-500 hover:text-blue-700 mx-1"><i class="fas fa-pen"></i></button>
                                <button @click="deleteProduct(p.id)" class="text-red-400 hover:text-red-600 mx-1"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</template>

--------------------------------------------------
PATH: ./.history/frontend/src/components/warehouse/tabs/StockTab_20260124215257.vue
--------------------------------------------------
<script setup>
import { ref, computed, defineAsyncComponent, onMounted } from 'vue'
import { useWarehouse } from '@/composables/useWarehouse'
import { useProducts } from '@/composables/useProducts'

// ĞÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğµ Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ¼Ğ¾Ğ´Ğ°Ğ»ĞºĞ¸ Ñ–ÑÑ‚Ğ¾Ñ€Ñ–Ñ—
const HistoryModal = defineAsyncComponent(() => import('../modals/HistoryModal.vue'))

// --- Ğ‘Ğ•Ğ—ĞŸĞ•Ğ§ĞĞ Ğ†ĞĞ†Ğ¦Ğ†ĞĞ›Ğ†Ğ—ĞĞ¦Ğ†Ğ¯ Ğ”ĞĞĞ˜Ğ¥ (FIX) ---
// ĞœĞ¸ Ğ½Ğµ Ñ€Ğ¾Ğ±Ğ¸Ğ¼Ğ¾ Ğ´ĞµÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ¸Ğ·Ğ°Ñ†Ñ–Ñ Ğ¾Ğ´Ñ€Ğ°Ğ·Ñƒ, Ğ±Ğ¾ useWarehouse Ğ¼Ğ¾Ğ¶Ğµ Ğ±ÑƒÑ‚Ğ¸ undefined Ğ½Ğ° Ğ¼Ñ–Ğ»Ñ–ÑĞµĞºÑƒĞ½Ğ´Ñƒ
const warehouseData = useWarehouse()
const ingredients = warehouseData?.ingredients || ref([])
const consumables = warehouseData?.consumables || ref([])
const updateItem = warehouseData?.updateItem || (async () => false)

const productsData = useProducts()
const products = productsData?.products || ref([])
const fetchProducts = productsData?.fetchProducts || (async () => {})

const searchQuery = ref('')
const filterType = ref('all') 
const isEditModalOpen = ref(false)
const editItemData = ref({ id: null, type: '', name: '', stock_quantity: 0, rawItem: null })
const isSaving = ref(false)
const isHistoryOpen = ref(false)
const historyItem = ref(null)

// Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ÑƒÑ”Ğ¼Ğ¾ Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ‚Ğ¸ Ğ¿Ñ€Ğ¸ ÑÑ‚Ğ°Ñ€Ñ‚Ñ–
onMounted(() => {
    fetchProducts()
})

const allStock = computed(() => {
  const list = []
  
  // --- Ğ—ĞĞ¥Ğ˜Ğ¡Ğ¢ Ğ’Ğ†Ğ” ĞŸĞĞœĞ˜Ğ›ĞĞš (FIX) ---
  // Ğ¯ĞºÑ‰Ğ¾ Ğ´Ğ°Ğ½Ñ– Ñ‰Ğµ Ğ½Ğµ Ğ¿Ñ€Ğ¸Ğ¹ÑˆĞ»Ğ¸, Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ¿Ğ¾Ğ²ĞµÑ€Ñ‚Ğ°Ñ”Ğ¼Ğ¾ Ğ¿ÑƒÑÑ‚Ğ¸Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº, Ğ° Ğ½Ğµ ĞºÑ€Ğ°ÑˆĞ¸Ğ¼Ğ¾ ÑÑ‚Ğ¾Ñ€Ñ–Ğ½ĞºÑƒ
  if (!ingredients.value || !consumables.value || !products.value) {
      return []
  }

  // 1. Ğ†Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ğ¸
  ingredients.value.forEach(i => {
    list.push({
      id: i.id,
      type: 'ingredient',
      typeName: 'Ğ¡Ğ¸Ñ€Ğ¾Ğ²Ğ¸Ğ½Ğ°',
      name: i.name,
      quantity: i.stock_quantity,
      unit: i.unit?.symbol || '?',
      cost: i.cost_per_unit,
      raw: i
    })
  })

  // 2. ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸
  consumables.value.forEach(c => {
    list.push({
      id: c.id,
      type: 'consumable',
      typeName: 'ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»',
      name: c.name,
      quantity: c.stock_quantity,
      unit: c.unit?.symbol || '?',
      cost: c.cost_per_unit,
      raw: c
    })
  })

  // 3. Ğ¢ĞĞ’ĞĞ Ğ˜
  products.value.forEach(p => {
      // Ğ¯ĞºÑ‰Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€ Ğ¼Ğ°Ñ” Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸, Ğ´Ğ¾Ğ´Ğ°Ñ”Ğ¼Ğ¾ ĞºĞ¾Ğ¶ĞµĞ½ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚ ÑĞº Ğ¾ĞºÑ€ĞµĞ¼Ğ¸Ğ¹ Ñ€ÑĞ´Ğ¾Ğº
      if (p.has_variants && p.variants) {
          p.variants.forEach(v => {
              list.push({
                  id: v.id,
                  type: 'product_variant', // Ğ¡Ğ¿ĞµÑ†Ñ–Ğ°Ğ»ÑŒĞ½Ğ¸Ğ¹ Ñ‚Ğ¸Ğ¿
                  typeName: 'Ğ’Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚',
                  name: `${p.name} (${v.name})`,
                  quantity: v.stock_quantity,
                  unit: 'ÑˆÑ‚',
                  cost: v.price, 
                  raw: v
              })
          })
      } 
      // Ğ¯ĞºÑ‰Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¸Ğ¹ Ñ– Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ğ¾ track_stock
      else {
          list.push({
              id: p.id,
              type: 'product', // Ğ¡Ğ¿ĞµÑ†Ñ–Ğ°Ğ»ÑŒĞ½Ğ¸Ğ¹ Ñ‚Ğ¸Ğ¿
              typeName: 'Ğ¢Ğ¾Ğ²Ğ°Ñ€',
              name: p.name,
              quantity: p.stock_quantity,
              unit: 'ÑˆÑ‚',
              cost: p.price,
              raw: p
          })
      }
  })

  return list.sort((a, b) => a.name.localeCompare(b.name))
})

const filteredStock = computed(() => {
  // Ğ”Ğ¾Ğ´Ğ°Ñ”Ğ¼Ğ¾ Ğ¿ĞµÑ€ĞµĞ²Ñ–Ñ€ĞºÑƒ, Ñ‰Ğ¾Ğ± computed Ğ½Ğµ Ğ¿Ğ°Ğ´Ğ°Ğ²
  let items = allStock.value || []
  
  // ĞĞ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ° Ğ»Ğ¾Ğ³Ñ–ĞºĞ° Ñ„Ñ–Ğ»ÑŒÑ‚Ñ€Ñƒ
  if (filterType.value === 'ingredient') items = items.filter(i => i.type === 'ingredient')
  else if (filterType.value === 'consumable') items = items.filter(i => i.type === 'consumable')
  else if (filterType.value === 'product') items = items.filter(i => i.type === 'product' || i.type === 'product_variant')

  if (searchQuery.value) {
    const q = searchQuery.value.toLowerCase()
    items = items.filter(item => item.name.toLowerCase().includes(q))
  }
  return items
})

const openHistory = (item) => {
  historyItem.value = { id: item.id, type: item.type, name: item.name }
  isHistoryOpen.value = true
}

const openEdit = (item) => {
  editItemData.value = {
    id: item.id,
    type: item.type,
    name: item.name,
    stock_quantity: item.quantity,
    rawItem: item.raw
  }
  isEditModalOpen.value = true
}

const saveStock = async () => {
  isSaving.value = true
  const { id, type, rawItem, stock_quantity } = editItemData.value
  
  let success = false

  try {
      // Ğ›Ğ¾Ğ³Ñ–ĞºĞ° Ğ´Ğ»Ñ Ğ·Ğ²Ğ¸Ñ‡Ğ°Ğ¹Ğ½Ğ¸Ñ… Ñ€ĞµÑÑƒÑ€ÑÑ–Ğ² (PUT Ğ¿Ğ¾Ğ²Ğ½Ğ¾Ğ³Ğ¾ Ğ¾Ğ±'Ñ”ĞºÑ‚Ğ°)
      if (type === 'ingredient' || type === 'consumable') {
          const payload = { ...rawItem, stock_quantity: Number(stock_quantity) }
          const url = type === 'ingredient' ? `/api/ingredients/${id}` : `/api/consumables/${id}`
          // Ğ’Ğ¸ĞºĞ»Ğ¸ĞºĞ°Ñ”Ğ¼Ğ¾ updateItem Ğ±ĞµĞ·Ğ¿ĞµÑ‡Ğ½Ğ¾
          success = await updateItem(url, payload)
      } 
      // Ğ›Ğ¾Ğ³Ñ–ĞºĞ° Ğ´Ğ»Ñ Ğ¢ĞĞ’ĞĞ Ğ†Ğ’ (PATCH Ñ‚Ñ–Ğ»ÑŒĞºĞ¸ quantity)
      // Ğ’ĞĞ–Ğ›Ğ˜Ğ’Ğ: Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ Ğ¿Ğ¾Ğ²Ğ½Ğ¸Ğ¹ URL, Ğ±Ğ¾ vite proxy Ğ½Ğ°Ğ»Ğ°ÑˆÑ‚Ğ¾Ğ²Ğ°Ğ½Ğ¾
      else if (type === 'product') {
          // Ğ¢ÑƒÑ‚ ĞºÑ€Ğ°Ñ‰Ğµ Ğ²Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ°Ñ‚Ğ¸ axios, Ğ°Ğ»Ğµ ÑĞºÑ‰Ğ¾ Ñƒ Ğ²Ğ°Ñ fetch Ğ½Ğ°Ğ»Ğ°ÑˆÑ‚Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹ Ñ‡ĞµÑ€ĞµĞ· proxy - Ğ¾Ğº
          const res = await fetch(`http://localhost:8001/products/${id}/stock?qty=${stock_quantity}`, { method: 'PATCH' })
          if(res.ok) { success = true; await fetchProducts(); }
      }
      else if (type === 'product_variant') {
          const res = await fetch(`http://localhost:8001/products/variants/${id}/stock?qty=${stock_quantity}`, { method: 'PATCH' })
          if(res.ok) { success = true; await fetchProducts(); }
      }
  } catch (e) {
      console.error("Stock save error:", e)
      alert("ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ·Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ½Ñ")
  }
  
  isSaving.value = false
  if (success) isEditModalOpen.value = false
}
</script>

<template>
  <div class="space-y-6">
    
    <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col md:flex-row gap-4 items-center justify-between">
       <div class="relative w-full md:w-96">
         <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
         <input v-model="searchQuery" type="text" placeholder="ĞŸĞ¾ÑˆÑƒĞº..." class="w-full pl-10 pr-4 py-2 bg-gray-50 border border-gray-200 rounded-xl outline-none">
       </div>

       <div class="flex bg-gray-100 p-1 rounded-xl">
         <button @click="filterType = 'all'" :class="filterType === 'all' ? 'bg-white shadow text-gray-800' : 'text-gray-500'" class="px-4 py-1.5 rounded-lg text-sm font-bold transition-all">Ğ’ÑÑ–</button>
         <button @click="filterType = 'ingredient'" :class="filterType === 'ingredient' ? 'bg-white shadow text-green-600' : 'text-gray-500'" class="px-4 py-1.5 rounded-lg text-sm font-bold transition-all">Ğ¡Ğ¸Ñ€Ğ¾Ğ²Ğ¸Ğ½Ğ°</button>
         <button @click="filterType = 'consumable'" :class="filterType === 'consumable' ? 'bg-white shadow text-teal-600' : 'text-gray-500'" class="px-4 py-1.5 rounded-lg text-sm font-bold transition-all">ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸</button>
         <button @click="filterType = 'product'" :class="filterType === 'product' ? 'bg-white shadow text-orange-600' : 'text-gray-500'" class="px-4 py-1.5 rounded-lg text-sm font-bold transition-all">Ğ¢Ğ¾Ğ²Ğ°Ñ€Ğ¸</button>
       </div>
    </div>

    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
      <div class="overflow-x-auto">
        <table class="w-full text-left text-sm">
          <thead class="bg-gray-50 text-gray-500 uppercase text-xs">
            <tr>
              <th class="p-4">ĞĞ°Ğ·Ğ²Ğ°</th>
              <th class="p-4">Ğ¢Ğ¸Ğ¿</th>
              <th class="p-4 text-right">Ğ—Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº</th>
              <th class="p-4 text-center">Ğ”Ñ–Ñ—</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-100">
            <tr v-if="filteredStock.length === 0">
                <td colspan="4" class="p-8 text-center text-gray-400">ĞŸÑƒÑÑ‚Ğ¾...</td>
            </tr>
            <tr v-for="item in filteredStock" :key="item.type + item.id" class="hover:bg-blue-50 transition group">
              
              <td class="p-4 font-bold text-gray-800">{{ item.name }}</td>
              
              <td class="p-4">
                <span class="text-[10px] uppercase font-bold px-2 py-1 rounded-md border"
                  :class="{
                      'bg-green-50 text-green-700 border-green-100': item.type === 'ingredient',
                      'bg-teal-50 text-teal-700 border-teal-100': item.type === 'consumable',
                      'bg-orange-50 text-orange-700 border-orange-100': item.type.includes('product')
                  }">
                  {{ item.typeName }}
                </span>
              </td>
              
              <td class="p-4 text-right font-mono text-lg" :class="item.quantity <= 0 ? 'text-red-500 font-bold' : 'text-gray-700'">
                {{ item.quantity }} <span class="text-xs text-gray-400 font-sans">{{ item.unit }}</span>
              </td>
              
              <td class="p-4 text-center flex justify-center gap-2">
                 <button @click="openHistory(item)" class="w-8 h-8 rounded-lg bg-purple-50 text-purple-600 hover:bg-purple-100 hover:scale-110 transition flex items-center justify-center">
                   <i class="fas fa-history"></i>
                 </button>
                 <button @click="openEdit(item)" class="px-3 py-1 rounded-lg bg-blue-50 text-blue-600 hover:bg-blue-100 font-bold text-xs transition flex items-center gap-2">
                   <i class="fas fa-pen"></i> <span class="hidden sm:inline">ĞšĞ¾Ñ€ĞµĞ³ÑƒĞ²Ğ°Ñ‚Ğ¸</span>
                 </button>
              </td>

            </tr>
          </tbody>
        </table>
      </div>
    </div>
    
    <div v-if="isEditModalOpen" class="fixed inset-0 z-50 flex items-center justify-center p-4">
       <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" @click="isEditModalOpen = false"></div>
       <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 relative z-10">
          <h3 class="text-xl font-bold mb-1 text-gray-800">Ğ†Ğ½Ğ²ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ·Ğ°Ñ†Ñ–Ñ</h3>
          <p class="text-sm text-gray-500 mb-6">ĞšĞ¾Ñ€ĞµĞºÑ†Ñ–Ñ: <b class="text-gray-900">{{ editItemData.name }}</b></p>
          <div class="mb-6">
             <input v-model="editItemData.stock_quantity" type="number" step="1" class="w-full border-2 border-blue-100 p-4 rounded-xl text-2xl font-mono text-center font-bold">
          </div>
          <div class="flex gap-3">
             <button @click="isEditModalOpen=false" class="flex-1 py-3 text-gray-500 font-bold">Ğ¡ĞºĞ°ÑÑƒĞ²Ğ°Ñ‚Ğ¸</button>
             <button @click="saveStock" :disabled="isSaving" class="flex-1 py-3 bg-blue-600 text-white font-bold rounded-xl">Ğ—Ğ±ĞµÑ€ĞµĞ³Ñ‚Ğ¸</button>
          </div>
       </div>
    </div>

    <HistoryModal v-if="isHistoryOpen" :is-open="isHistoryOpen" :item="historyItem" @close="isHistoryOpen = false" />
  </div>
</template>

--------------------------------------------------
PATH: ./.history/frontend/src/components/warehouse/tabs/StockTab_20260123213718.vue
--------------------------------------------------
<script setup>
import { ref, computed, onMounted } from 'vue'
import { useWarehouse } from '@/composables/useWarehouse'
import axios from 'axios'

// ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ğ´Ğ°Ğ½Ñ–. Ğ”Ğ¾Ğ´Ğ°Ñ”Ğ¼Ğ¾ Ğ·Ğ°Ñ…Ğ¸ÑÑ‚, ÑĞºÑ‰Ğ¾ useWarehouse Ğ¿Ğ¾Ğ²ĞµÑ€Ğ½Ğµ undefined
const warehouseData = useWarehouse()
const consumables = warehouseData?.consumables || ref([])
const ingredients = warehouseData?.ingredients || ref([])
const fetchWarehouseData = warehouseData?.fetchWarehouseData || (async () => {})

const activeCategory = ref('ingredients') // 'ingredients' or 'consumables'
const searchQuery = ref('')
const showAdjustmentModal = ref(false)

// Ğ¤Ğ¾Ñ€Ğ¼Ğ° ĞºĞ¾Ñ€Ğ¸Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ
const adjustmentForm = ref({
    type: 'ingredient', // ingredient/consumable
    id: null,
    delta: 0,
    reason: ''
})

// --- COMPUTED: Ğ¤Ñ–Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ñ–Ñ (Ğ— Ğ—ĞĞ¥Ğ˜Ğ¡Ğ¢ĞĞœ Ğ’Ğ†Ğ” ĞŸĞĞœĞ˜Ğ›ĞĞš) ---
const filteredItems = computed(() => {
    // 1. Ğ’Ğ¸Ğ·Ğ½Ğ°Ñ‡Ğ°Ñ”Ğ¼Ğ¾ Ğ´Ğ¶ĞµÑ€ĞµĞ»Ğ¾ Ğ´Ğ°Ğ½Ğ¸Ñ…
    let source = null
    if (activeCategory.value === 'ingredients') {
        source = ingredients
    } else {
        source = consumables
    }

    // 2. Ğ—ĞĞ¥Ğ˜Ğ¡Ğ¢: Ğ¯ĞºÑ‰Ğ¾ Ğ´Ğ¶ĞµÑ€ĞµĞ»Ğ¾ Ñ‰Ğµ Ğ½Ğµ Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶Ğ¸Ğ»Ğ¾ÑÑŒ (undefined Ğ°Ğ±Ğ¾ Ğ½ĞµĞ¼Ğ°Ñ” .value)
    if (!source || !source.value) {
        return []
    }

    // 3. Ğ¤Ñ–Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ñ–Ñ
    if (!searchQuery.value) return source.value
    
    const q = searchQuery.value.toLowerCase()
    return source.value.filter(item => item.name.toLowerCase().includes(q))
})

// --- Ğ”Ñ–Ñ— ---

const openAdjustment = (item, type) => {
    adjustmentForm.value = {
        type: type,
        id: item.id,
        delta: 0,
        reason: '',
        currentName: item.name,
        currentStock: item.stock_quantity
    }
    showAdjustmentModal.value = true
}

const saveAdjustment = async () => {
    if (adjustmentForm.value.delta === 0) return alert("Ğ’ĞºĞ°Ğ¶Ñ–Ñ‚ÑŒ ĞºÑ–Ğ»ÑŒĞºÑ–ÑÑ‚ÑŒ")
    
    // Ğ’Ğ¸Ğ·Ğ½Ğ°Ñ‡Ğ°Ñ”Ğ¼Ğ¾ URL Ğ·Ğ°Ğ»ĞµĞ¶Ğ½Ğ¾ Ğ²Ñ–Ğ´ Ñ‚Ğ¸Ğ¿Ñƒ
    const endpoint = adjustmentForm.value.type === 'ingredient' 
        ? 'ingredients' 
        : 'consumables'
    
    try {
        // Ğ’Ñ–Ğ´Ğ¿Ñ€Ğ°Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ½Ğ° Ğ±ĞµĞºĞµĞ½Ğ´ (POST /api/inventory/{type}/{id}/adjust)
        // ĞŸÑ€Ğ¸Ğ¿ÑƒÑÑ‚Ğ¸Ğ¼Ğ¾, Ñ‰Ğ¾ Ğ±ĞµĞºĞµĞ½Ğ´ Ğ¼Ğ°Ñ” Ñ‚Ğ°ĞºĞ¸Ğ¹ Ñ€Ğ¾ÑƒÑ‚, Ğ°Ğ±Ğ¾ Ğ¼Ğ¸ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ¾Ğ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ñ‡ĞµÑ€ĞµĞ· PUT
        // Ğ”Ğ»Ñ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾Ñ‚Ğ¸, ÑĞºÑ‰Ğ¾ Ğ½ĞµĞ¼Ğ°Ñ” ÑĞ¿ĞµÑ†. Ñ€Ğ¾ÑƒÑ‚Ñƒ adjustment, Ğ¼Ğ¾Ğ¶Ğ½Ğ° Ğ²Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ°Ñ‚Ğ¸ PUT Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ
        // ĞĞ»Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¸Ğ¹ REST Ğ¿Ñ–Ğ´Ñ…Ñ–Ğ´ Ğ´Ğ»Ñ ÑĞºĞ»Ğ°Ğ´Ñƒ - Ñ†Ğµ Ğ¾ĞºÑ€ĞµĞ¼Ğ¸Ğ¹ Ñ€Ğ¾ÑƒÑ‚ Ñ€ÑƒÑ…Ñƒ.
        
        // ĞŸĞ¾ĞºĞ¸ Ñ‰Ğ¾ Ñ€ĞµĞ°Ğ»Ñ–Ğ·ÑƒÑ”Ğ¼Ğ¾ Ñ‡ĞµÑ€ĞµĞ· "Ğ¼Ğ¸Ğ»Ğ¸Ñ†Ñ" - Ğ¿Ñ€ÑĞ¼Ğµ Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ (ÑĞºÑ‰Ğ¾ Ñƒ Ğ²Ğ°Ñ Ğ½ĞµĞ¼Ğ°Ñ” Ñ€Ğ¾ÑƒÑ‚Ñƒ /adjust)
        // ĞĞ‘Ğ (ĞºÑ€Ğ°Ñ‰Ğµ) - ÑĞºÑ‰Ğ¾ Ğ²Ğ¸ Ğ½Ğµ Ñ€Ğ¾Ğ±Ğ¸Ğ»Ğ¸ Ñ€Ğ¾ÑƒÑ‚ adjust, Ñ‚Ğ¾ Ñ‚Ñ€ĞµĞ±Ğ° Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ¾Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğ¸ Ğ¿Ğ¾Ğ»Ğµ stock_quantity
        
        // Ğ’Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚ Ğ (ÑĞºÑ‰Ğ¾ Ñ” Ñ€Ğ¾ÑƒÑ‚ update):
        const item = filteredItems.value.find(i => i.id === adjustmentForm.value.id)
        const newQuantity = parseFloat(item.stock_quantity) + parseFloat(adjustmentForm.value.delta)
        
        await axios.put(`http://localhost:8001/inventory/${endpoint}/${adjustmentForm.value.id}`, {
            ...item,
            stock_quantity: newQuantity
        })

        await fetchWarehouseData()
        showAdjustmentModal.value = false
    } catch (e) {
        console.error(e)
        alert("ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ Ğ·Ğ°Ğ»Ğ¸ÑˆĞºÑƒ")
    }
}

// Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ¿Ñ€Ğ¸ Ğ²Ñ–Ğ´ĞºÑ€Ğ¸Ñ‚Ñ‚Ñ– Ğ²ĞºĞ»Ğ°Ğ´ĞºĞ¸
onMounted(() => {
    fetchWarehouseData()
})
</script>

<template>
    <div class="space-y-6">
        <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col md:flex-row justify-between items-center gap-4">
            
            <div class="flex bg-gray-100 p-1 rounded-xl">
                <button 
                    @click="activeCategory = 'ingredients'"
                    class="px-4 py-2 rounded-lg text-sm font-bold transition"
                    :class="activeCategory === 'ingredients' ? 'bg-white shadow text-blue-600' : 'text-gray-500 hover:text-gray-700'"
                >
                    ğŸ‹ Ğ†Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ğ¸
                </button>
                <button 
                    @click="activeCategory = 'consumables'"
                    class="px-4 py-2 rounded-lg text-sm font-bold transition"
                    :class="activeCategory === 'consumables' ? 'bg-white shadow text-purple-600' : 'text-gray-500 hover:text-gray-700'"
                >
                    ğŸ“¦ ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸
                </button>
            </div>

            <div class="relative w-full md:w-64">
                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                <input 
                    v-model="searchQuery" 
                    type="text" 
                    placeholder="ĞŸĞ¾ÑˆÑƒĞº Ğ¿Ğ¾ ÑĞºĞ»Ğ°Ğ´Ñƒ..." 
                    class="w-full pl-10 pr-4 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-100 outline-none text-sm"
                >
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
            <table class="w-full text-left text-sm">
                <thead class="bg-gray-50 text-xs uppercase font-bold text-gray-500">
                    <tr>
                        <th class="p-4">ĞĞ°Ğ·Ğ²Ğ°</th>
                        <th class="p-4 text-center">Ğ—Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº</th>
                        <th class="p-4">ĞĞ´. Ğ²Ğ¸Ğ¼.</th>
                        <th class="p-4">Ğ’Ğ°Ñ€Ñ‚Ñ–ÑÑ‚ÑŒ Ğ¾Ğ´.</th>
                        <th class="p-4 text-center">Ğ”Ñ–Ñ—</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    <tr v-if="filteredItems.length === 0">
                        <td colspan="5" class="p-8 text-center text-gray-400">ĞÑ–Ñ‡Ğ¾Ğ³Ğ¾ Ğ½Ğµ Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾</td>
                    </tr>
                    <tr v-for="item in filteredItems" :key="item.id" class="hover:bg-gray-50 transition">
                        <td class="p-4 font-bold text-gray-700">{{ item.name }}</td>
                        
                        <td class="p-4 text-center">
                            <span 
                                class="px-3 py-1 rounded-full font-mono font-bold text-xs"
                                :class="{
                                    'bg-green-100 text-green-700': item.stock_quantity > 10,
                                    'bg-yellow-100 text-yellow-700': item.stock_quantity <= 10 && item.stock_quantity > 0,
                                    'bg-red-100 text-red-700': item.stock_quantity <= 0
                                }"
                            >
                                {{ item.stock_quantity }}
                            </span>
                        </td>
                        
                        <td class="p-4 text-gray-500">{{ item.unit ? item.unit.symbol : '-' }}</td>
                        <td class="p-4 font-mono">{{ item.cost_per_unit }} â‚´</td>
                        
                        <td class="p-4 text-center">
                            <button 
                                @click="openAdjustment(item, activeCategory === 'ingredients' ? 'ingredient' : 'consumable')"
                                class="text-blue-600 hover:bg-blue-50 px-3 py-1 rounded text-xs font-bold transition border border-blue-200"
                            >
                                ĞšĞ¾Ñ€Ğ¸Ğ³ÑƒĞ²Ğ°Ñ‚Ğ¸
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div v-if="showAdjustmentModal" class="fixed inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl p-6">
                <h3 class="text-lg font-bold mb-1">ĞšĞ¾Ñ€Ğ¸Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ·Ğ°Ğ»Ğ¸ÑˆĞºÑƒ</h3>
                <p class="text-sm text-gray-500 mb-4">
                    {{ adjustmentForm.currentName }} (ĞŸĞ¾Ñ‚Ğ¾Ñ‡Ğ½Ğ¾: {{ adjustmentForm.currentStock }})
                </p>

                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ğ—Ğ¼Ñ–Ğ½Ğ° (+/-)</label>
                        <input 
                            v-model.number="adjustmentForm.delta" 
                            type="number" 
                            class="w-full border p-3 rounded-xl font-mono text-lg font-bold outline-none focus:ring-2 focus:ring-blue-100"
                            placeholder="ĞĞ°Ğ¿Ñ€. -5 Ğ°Ğ±Ğ¾ 10"
                        >
                        <p class="text-[10px] text-gray-400 mt-1">Ğ’Ğ²ĞµĞ´Ñ–Ñ‚ÑŒ Ğ²Ñ–Ğ´'Ñ”Ğ¼Ğ½Ğµ Ñ‡Ğ¸ÑĞ»Ğ¾ Ğ´Ğ»Ñ ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ½Ñ</p>
                    </div>
                    
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°</label>
                        <input 
                            v-model="adjustmentForm.reason" 
                            class="w-full border p-2 rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-100"
                            placeholder="Ğ†Ğ½Ğ²ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ·Ğ°Ñ†Ñ–Ñ, Ñ€Ğ¾Ğ·Ğ±Ğ¸Ñ‚Ğ¾..."
                        >
                    </div>

                    <div class="flex gap-2 pt-2">
                        <button @click="showAdjustmentModal = false" class="flex-1 py-2 text-gray-500 font-bold hover:bg-gray-50 rounded-xl">Ğ¡ĞºĞ°ÑÑƒĞ²Ğ°Ñ‚Ğ¸</button>
                        <button @click="saveAdjustment" class="flex-1 py-2 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 shadow-lg shadow-blue-200">Ğ—Ğ±ĞµÑ€ĞµĞ³Ñ‚Ğ¸</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>

--------------------------------------------------
PATH: ./.history/frontend/src/components/warehouse/tabs/StockTab_20260124203436.vue
--------------------------------------------------
<script setup>
import { ref, computed, defineAsyncComponent, onMounted } from 'vue'
import { useWarehouse } from '@/composables/useWarehouse'
import { useProducts } from '@/composables/useProducts'

// ĞÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğµ Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ¼Ğ¾Ğ´Ğ°Ğ»ĞºĞ¸ Ñ–ÑÑ‚Ğ¾Ñ€Ñ–Ñ—
const HistoryModal = defineAsyncComponent(() => import('../modals/HistoryModal.vue'))

// --- Ğ‘Ğ•Ğ—ĞŸĞ•Ğ§ĞĞ Ğ†ĞĞ†Ğ¦Ğ†ĞĞ›Ğ†Ğ—ĞĞ¦Ğ†Ğ¯ Ğ”ĞĞĞ˜Ğ¥ (FIX) ---
// ĞœĞ¸ Ğ½Ğµ Ñ€Ğ¾Ğ±Ğ¸Ğ¼Ğ¾ Ğ´ĞµÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ¸Ğ·Ğ°Ñ†Ñ–Ñ Ğ¾Ğ´Ñ€Ğ°Ğ·Ñƒ, Ğ±Ğ¾ useWarehouse Ğ¼Ğ¾Ğ¶Ğµ Ğ±ÑƒÑ‚Ğ¸ undefined Ğ½Ğ° Ğ¼Ñ–Ğ»Ñ–ÑĞµĞºÑƒĞ½Ğ´Ñƒ
const warehouseData = useWarehouse()
const ingredients = warehouseData?.ingredients || ref([])
const consumables = warehouseData?.consumables || ref([])
const updateItem = warehouseData?.updateItem || (async () => false)

const productsData = useProducts()
const products = productsData?.products || ref([])
const fetchProducts = productsData?.fetchProducts || (async () => {})

const searchQuery = ref('')
const filterType = ref('all') 
const isEditModalOpen = ref(false)
const editItemData = ref({ id: null, type: '', name: '', stock_quantity: 0, rawItem: null })
const isSaving = ref(false)
const isHistoryOpen = ref(false)
const historyItem = ref(null)

// Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ÑƒÑ”Ğ¼Ğ¾ Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ‚Ğ¸ Ğ¿Ñ€Ğ¸ ÑÑ‚Ğ°Ñ€Ñ‚Ñ–
onMounted(() => {
    fetchProducts()
})

const allStock = computed(() => {
  const list = []
  
  // --- Ğ—ĞĞ¥Ğ˜Ğ¡Ğ¢ Ğ’Ğ†Ğ” ĞŸĞĞœĞ˜Ğ›ĞĞš (FIX) ---
  // Ğ¯ĞºÑ‰Ğ¾ Ğ´Ğ°Ğ½Ñ– Ñ‰Ğµ Ğ½Ğµ Ğ¿Ñ€Ğ¸Ğ¹ÑˆĞ»Ğ¸, Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ¿Ğ¾Ğ²ĞµÑ€Ñ‚Ğ°Ñ”Ğ¼Ğ¾ Ğ¿ÑƒÑÑ‚Ğ¸Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº, Ğ° Ğ½Ğµ ĞºÑ€Ğ°ÑˆĞ¸Ğ¼Ğ¾ ÑÑ‚Ğ¾Ñ€Ñ–Ğ½ĞºÑƒ
  if (!ingredients.value || !consumables.value || !products.value) {
      return []
  }

  // 1. Ğ†Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ğ¸
  ingredients.value.forEach(i => {
    list.push({
      id: i.id,
      type: 'ingredient',
      typeName: 'Ğ¡Ğ¸Ñ€Ğ¾Ğ²Ğ¸Ğ½Ğ°',
      name: i.name,
      quantity: i.stock_quantity,
      unit: i.unit?.symbol || '?',
      cost: i.cost_per_unit,
      raw: i
    })
  })

  // 2. ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸
  consumables.value.forEach(c => {
    list.push({
      id: c.id,
      type: 'consumable',
      typeName: 'ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»',
      name: c.name,
      quantity: c.stock_quantity,
      unit: c.unit?.symbol || '?',
      cost: c.cost_per_unit,
      raw: c
    })
  })

  // 3. Ğ¢ĞĞ’ĞĞ Ğ˜
  products.value.forEach(p => {
      // Ğ¯ĞºÑ‰Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€ Ğ¼Ğ°Ñ” Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸, Ğ´Ğ¾Ğ´Ğ°Ñ”Ğ¼Ğ¾ ĞºĞ¾Ğ¶ĞµĞ½ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚ ÑĞº Ğ¾ĞºÑ€ĞµĞ¼Ğ¸Ğ¹ Ñ€ÑĞ´Ğ¾Ğº
      if (p.has_variants && p.variants) {
          p.variants.forEach(v => {
              list.push({
                  id: v.id,
                  type: 'product_variant', // Ğ¡Ğ¿ĞµÑ†Ñ–Ğ°Ğ»ÑŒĞ½Ğ¸Ğ¹ Ñ‚Ğ¸Ğ¿
                  typeName: 'Ğ’Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚',
                  name: `${p.name} (${v.name})`,
                  quantity: v.stock_quantity,
                  unit: 'ÑˆÑ‚',
                  cost: v.price, 
                  raw: v
              })
          })
      } 
      // Ğ¯ĞºÑ‰Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¸Ğ¹ Ñ– Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ğ¾ track_stock
      else if (p.track_stock) {
          list.push({
              id: p.id,
              type: 'product', // Ğ¡Ğ¿ĞµÑ†Ñ–Ğ°Ğ»ÑŒĞ½Ğ¸Ğ¹ Ñ‚Ğ¸Ğ¿
              typeName: 'Ğ¢Ğ¾Ğ²Ğ°Ñ€',
              name: p.name,
              quantity: p.stock_quantity,
              unit: 'ÑˆÑ‚',
              cost: p.price,
              raw: p
          })
      }
  })

  return list.sort((a, b) => a.name.localeCompare(b.name))
})

const filteredStock = computed(() => {
  // Ğ”Ğ¾Ğ´Ğ°Ñ”Ğ¼Ğ¾ Ğ¿ĞµÑ€ĞµĞ²Ñ–Ñ€ĞºÑƒ, Ñ‰Ğ¾Ğ± computed Ğ½Ğµ Ğ¿Ğ°Ğ´Ğ°Ğ²
  let items = allStock.value || []
  
  // ĞĞ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ° Ğ»Ğ¾Ğ³Ñ–ĞºĞ° Ñ„Ñ–Ğ»ÑŒÑ‚Ñ€Ñƒ
  if (filterType.value === 'ingredient') items = items.filter(i => i.type === 'ingredient')
  else if (filterType.value === 'consumable') items = items.filter(i => i.type === 'consumable')
  else if (filterType.value === 'product') items = items.filter(i => i.type === 'product' || i.type === 'product_variant')

  if (searchQuery.value) {
    const q = searchQuery.value.toLowerCase()
    items = items.filter(item => item.name.toLowerCase().includes(q))
  }
  return items
})

const openHistory = (item) => {
  historyItem.value = { id: item.id, type: item.type, name: item.name }
  isHistoryOpen.value = true
}

const openEdit = (item) => {
  editItemData.value = {
    id: item.id,
    type: item.type,
    name: item.name,
    stock_quantity: item.quantity,
    rawItem: item.raw
  }
  isEditModalOpen.value = true
}

const saveStock = async () => {
  isSaving.value = true
  const { id, type, rawItem, stock_quantity } = editItemData.value
  
  let success = false

  try {
      // Ğ›Ğ¾Ğ³Ñ–ĞºĞ° Ğ´Ğ»Ñ Ğ·Ğ²Ğ¸Ñ‡Ğ°Ğ¹Ğ½Ğ¸Ñ… Ñ€ĞµÑÑƒÑ€ÑÑ–Ğ² (PUT Ğ¿Ğ¾Ğ²Ğ½Ğ¾Ğ³Ğ¾ Ğ¾Ğ±'Ñ”ĞºÑ‚Ğ°)
      if (type === 'ingredient' || type === 'consumable') {
          const payload = { ...rawItem, stock_quantity: Number(stock_quantity) }
          const url = type === 'ingredient' ? `/api/ingredients/${id}` : `/api/consumables/${id}`
          // Ğ’Ğ¸ĞºĞ»Ğ¸ĞºĞ°Ñ”Ğ¼Ğ¾ updateItem Ğ±ĞµĞ·Ğ¿ĞµÑ‡Ğ½Ğ¾
          success = await updateItem(url, payload)
      } 
      // Ğ›Ğ¾Ğ³Ñ–ĞºĞ° Ğ´Ğ»Ñ Ğ¢ĞĞ’ĞĞ Ğ†Ğ’ (PATCH Ñ‚Ñ–Ğ»ÑŒĞºĞ¸ quantity)
      // Ğ’ĞĞ–Ğ›Ğ˜Ğ’Ğ: Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ Ğ¿Ğ¾Ğ²Ğ½Ğ¸Ğ¹ URL, Ğ±Ğ¾ vite proxy Ğ½Ğ°Ğ»Ğ°ÑˆÑ‚Ğ¾Ğ²Ğ°Ğ½Ğ¾
      else if (type === 'product') {
          // Ğ¢ÑƒÑ‚ ĞºÑ€Ğ°Ñ‰Ğµ Ğ²Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ°Ñ‚Ğ¸ axios, Ğ°Ğ»Ğµ ÑĞºÑ‰Ğ¾ Ñƒ Ğ²Ğ°Ñ fetch Ğ½Ğ°Ğ»Ğ°ÑˆÑ‚Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹ Ñ‡ĞµÑ€ĞµĞ· proxy - Ğ¾Ğº
          const res = await fetch(`http://localhost:8001/products/${id}/stock?qty=${stock_quantity}`, { method: 'PATCH' })
          if(res.ok) { success = true; await fetchProducts(); }
      }
      else if (type === 'product_variant') {
          const res = await fetch(`http://localhost:8001/products/variants/${id}/stock?qty=${stock_quantity}`, { method: 'PATCH' })
          if(res.ok) { success = true; await fetchProducts(); }
      }
  } catch (e) {
      console.error("Stock save error:", e)
      alert("ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ·Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ½Ñ")
  }
  
  isSaving.value = false
  if (success) isEditModalOpen.value = false
}
</script>

<template>
  <div class="space-y-6">
    
    <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col md:flex-row gap-4 items-center justify-between">
       <div class="relative w-full md:w-96">
         <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
         <input v-model="searchQuery" type="text" placeholder="ĞŸĞ¾ÑˆÑƒĞº..." class="w-full pl-10 pr-4 py-2 bg-gray-50 border border-gray-200 rounded-xl outline-none">
       </div>

       <div class="flex bg-gray-100 p-1 rounded-xl">
         <button @click="filterType = 'all'" :class="filterType === 'all' ? 'bg-white shadow text-gray-800' : 'text-gray-500'" class="px-4 py-1.5 rounded-lg text-sm font-bold transition-all">Ğ’ÑÑ–</button>
         <button @click="filterType = 'ingredient'" :class="filterType === 'ingredient' ? 'bg-white shadow text-green-600' : 'text-gray-500'" class="px-4 py-1.5 rounded-lg text-sm font-bold transition-all">Ğ¡Ğ¸Ñ€Ğ¾Ğ²Ğ¸Ğ½Ğ°</button>
         <button @click="filterType = 'consumable'" :class="filterType === 'consumable' ? 'bg-white shadow text-teal-600' : 'text-gray-500'" class="px-4 py-1.5 rounded-lg text-sm font-bold transition-all">ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸</button>
         <button @click="filterType = 'product'" :class="filterType === 'product' ? 'bg-white shadow text-orange-600' : 'text-gray-500'" class="px-4 py-1.5 rounded-lg text-sm font-bold transition-all">Ğ¢Ğ¾Ğ²Ğ°Ñ€Ğ¸</button>
       </div>
    </div>

    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
      <div class="overflow-x-auto">
        <table class="w-full text-left text-sm">
          <thead class="bg-gray-50 text-gray-500 uppercase text-xs">
            <tr>
              <th class="p-4">ĞĞ°Ğ·Ğ²Ğ°</th>
              <th class="p-4">Ğ¢Ğ¸Ğ¿</th>
              <th class="p-4 text-right">Ğ—Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº</th>
              <th class="p-4 text-center">Ğ”Ñ–Ñ—</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-100">
            <tr v-if="filteredStock.length === 0">
                <td colspan="4" class="p-8 text-center text-gray-400">ĞŸÑƒÑÑ‚Ğ¾...</td>
            </tr>
            <tr v-for="item in filteredStock" :key="item.type + item.id" class="hover:bg-blue-50 transition group">
              
              <td class="p-4 font-bold text-gray-800">{{ item.name }}</td>
              
              <td class="p-4">
                <span class="text-[10px] uppercase font-bold px-2 py-1 rounded-md border"
                  :class="{
                      'bg-green-50 text-green-700 border-green-100': item.type === 'ingredient',
                      'bg-teal-50 text-teal-700 border-teal-100': item.type === 'consumable',
                      'bg-orange-50 text-orange-700 border-orange-100': item.type.includes('product')
                  }">
                  {{ item.typeName }}
                </span>
              </td>
              
              <td class="p-4 text-right font-mono text-lg" :class="item.quantity <= 0 ? 'text-red-500 font-bold' : 'text-gray-700'">
                {{ item.quantity }} <span class="text-xs text-gray-400 font-sans">{{ item.unit }}</span>
              </td>
              
              <td class="p-4 text-center flex justify-center gap-2">
                 <button @click="openHistory(item)" class="w-8 h-8 rounded-lg bg-purple-50 text-purple-600 hover:bg-purple-100 hover:scale-110 transition flex items-center justify-center">
                   <i class="fas fa-history"></i>
                 </button>
                 <button @click="openEdit(item)" class="px-3 py-1 rounded-lg bg-blue-50 text-blue-600 hover:bg-blue-100 font-bold text-xs transition flex items-center gap-2">
                   <i class="fas fa-pen"></i> <span class="hidden sm:inline">ĞšĞ¾Ñ€ĞµĞ³ÑƒĞ²Ğ°Ñ‚Ğ¸</span>
                 </button>
              </td>

            </tr>
          </tbody>
        </table>
      </div>
    </div>
    
    <div v-if="isEditModalOpen" class="fixed inset-0 z-50 flex items-center justify-center p-4">
       <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" @click="isEditModalOpen = false"></div>
       <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 relative z-10">
          <h3 class="text-xl font-bold mb-1 text-gray-800">Ğ†Ğ½Ğ²ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ·Ğ°Ñ†Ñ–Ñ</h3>
          <p class="text-sm text-gray-500 mb-6">ĞšĞ¾Ñ€ĞµĞºÑ†Ñ–Ñ: <b class="text-gray-900">{{ editItemData.name }}</b></p>
          <div class="mb-6">
             <input v-model="editItemData.stock_quantity" type="number" step="1" class="w-full border-2 border-blue-100 p-4 rounded-xl text-2xl font-mono text-center font-bold">
          </div>
          <div class="flex gap-3">
             <button @click="isEditModalOpen=false" class="flex-1 py-3 text-gray-500 font-bold">Ğ¡ĞºĞ°ÑÑƒĞ²Ğ°Ñ‚Ğ¸</button>
             <button @click="saveStock" :disabled="isSaving" class="flex-1 py-3 bg-blue-600 text-white font-bold rounded-xl">Ğ—Ğ±ĞµÑ€ĞµĞ³Ñ‚Ğ¸</button>
          </div>
       </div>
    </div>

    <HistoryModal v-if="isHistoryOpen" :is-open="isHistoryOpen" :item="historyItem" @close="isHistoryOpen = false" />
  </div>
</template>

--------------------------------------------------
PATH: ./.history/frontend/src/components/warehouse/tabs/ProductsTab_20260125191026.vue
--------------------------------------------------
<script setup>
import { ref, onMounted, computed } from 'vue' // <--- Ğ”Ğ¾Ğ´Ğ°Ğ² computed
import { useWarehouse } from '@/composables/useWarehouse'
import { useProducts } from '@/composables/useProducts'

// ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ğ´Ğ¾Ğ²Ñ–Ğ´Ğ½Ğ¸ĞºĞ¸ (ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ—, Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ğ¸ Ñ‚Ğ¾Ñ‰Ğ¾)
const { categories, recipes, ingredients, consumables } = useWarehouse()

// ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ñ„ÑƒĞ½ĞºÑ†Ñ–Ğ¾Ğ½Ğ°Ğ» Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ–Ğ²
const { 
    newProduct, isEditing, 
    variantBuilder, tempProductConsumable, tempVariantConsumable, tempVariantIngredient,
    resetForm, prepareEdit, saveProduct, deleteProduct, fetchProducts, filteredProducts, productSearch,
    
    saveVariant, editVariant, cancelVariantEdit, editingVariantIndex, removeVariant, 
    
    addProductConsumable, removeProductConsumable,
    addVariantConsumable, removeVariantConsumable,
    addIngredientToVariant, removeIngredientFromVariant
} = useProducts()

const showForm = ref(false)

const getCategoryName = (id) => {
    if (!categories.value) return '-'
    const c = categories.value.find(x => x.id === id)
    return c ? c.name : '-'
}

// --- ĞĞĞ’Ğ Ğ›ĞĞ“Ğ†ĞšĞ Ğ”Ğ›Ğ¯ ĞĞ”Ğ˜ĞĞ˜Ğ¦Ğ¬ Ğ’Ğ˜ĞœĞ†Ğ Ğ£ ---
const getIngredientUnit = (id) => {
    if (!id || !ingredients.value) return ''
    const ing = ingredients.value.find(i => i.id === id)
    return ing?.unit?.symbol || ''
}

const currentIngredientPlaceholder = computed(() => {
    const unit = getIngredientUnit(tempVariantIngredient.value.ingredient_id)
    return unit ? `Ğš-ÑÑ‚ÑŒ (${unit})` : 'Ğš-ÑÑ‚ÑŒ'
})
// --------------------------------------

const handleSave = async () => {
    const success = await saveProduct()
    if(success) {
        showForm.value = false
        await fetchProducts()
    }
}

const handleEdit = (product) => {
    prepareEdit(product)
    showForm.value = true
}

onMounted(async () => {
    console.log("ProductsTab mounted: fetching data...")
    await fetchProducts()
})
</script>

<template>
    <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
        
        <div v-if="showForm" class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 h-fit xl:col-span-1">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-gray-700">
                    {{ isEditing ? 'âœï¸ Ğ ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ' : 'ğŸ“¦ ĞĞ¾Ğ²Ğ¸Ğ¹ Ñ‚Ğ¾Ğ²Ğ°Ñ€' }}
                </h3>
                <button @click="showForm = false; resetForm()" class="text-xs text-red-500 hover:underline">Ğ—Ğ°ĞºÑ€Ğ¸Ñ‚Ğ¸</button>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞĞ°Ğ·Ğ²Ğ°</label>
                    <input v-model="newProduct.name" class="border p-2 rounded w-full focus:ring-2 ring-blue-100 outline-none">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ</label>
                        <select v-model="newProduct.category_id" class="border p-2 rounded w-full bg-white">
                            <option :value="null">-- Ğ‘ĞµĞ· ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ— --</option>
                            <option v-for="c in categories" :key="c.id" :value="c.id">{{ c.name }}</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ğ¦Ñ–Ğ½Ğ° (Ğ±Ğ°Ğ·Ğ¾Ğ²Ğ°)</label>
                        <input v-model.number="newProduct.price" type="number" class="border p-2 rounded w-full">
                    </div>
                </div>

                <div class="flex items-center gap-2 py-2">
                    <input type="checkbox" v-model="newProduct.has_variants" id="hasVar" class="w-4 h-4 text-blue-600">
                    <label for="hasVar" class="text-sm font-bold text-gray-700 select-none">Ğ¦ĞµĞ¹ Ñ‚Ğ¾Ğ²Ğ°Ñ€ Ğ¼Ğ°Ñ” Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸</label>
                </div>

                <div v-if="!newProduct.has_variants" class="bg-gray-50 p-3 rounded border border-gray-200 space-y-3">
                     <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞœĞ°Ğ¹ÑÑ‚ĞµÑ€-Ñ€ĞµÑ†ĞµĞ¿Ñ‚</label>
                        <select v-model="newProduct.master_recipe_id" class="border p-2 rounded w-full bg-white text-sm">
                            <option :value="null">-- Ğ‘ĞµĞ· Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ñƒ --</option>
                            <option v-for="r in recipes" :key="r.id" :value="r.id">{{ r.name }}</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ğ’Ğ¸Ñ…Ñ–Ğ´Ğ½Ğ° Ğ²Ğ°Ğ³Ğ° (Ğ³/Ğ¼Ğ»)</label>
                        <input v-model.number="newProduct.output_weight" type="number" class="border p-2 rounded w-full text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞŸĞ¾Ñ‡Ğ°Ñ‚ĞºĞ¾Ğ²Ğ¸Ğ¹ Ğ·Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº</label>
                        <input v-model.number="newProduct.stock_quantity" type="number" class="border p-2 rounded w-full text-sm" placeholder="0">
                    </div>
                </div>

                <div class="bg-teal-50/50 p-3 rounded border border-teal-100">
                    <label class="text-[10px] uppercase font-bold text-teal-600 mb-2 block">Ğ—Ğ°Ğ³Ğ°Ğ»ÑŒĞ½Ñ– Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸</label>
                    <div class="flex gap-2 mb-2">
                        <select v-model="tempProductConsumable.consumable_id" class="flex-1 border p-1 rounded text-sm bg-white">
                            <option value="">ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»...</option>
                            <option v-for="c in consumables" :key="c.id" :value="c.id">{{ c.name }}</option>
                        </select>
                        <button @click="addProductConsumable" class="bg-teal-500 text-white w-8 rounded hover:bg-teal-600">+</button>
                    </div>
                    <div class="flex flex-wrap gap-1">
                        <span v-for="(pc, idx) in newProduct.consumables" :key="idx" class="bg-white border border-teal-200 text-teal-700 text-xs px-2 py-1 rounded flex items-center gap-1">
                            {{ pc.name }} <button @click="removeProductConsumable(idx)" class="text-red-500 font-bold ml-1">&times;</button>
                        </span>
                    </div>
                </div>

                <div v-if="newProduct.has_variants" class="space-y-3">
                    <div class="border-t pt-2 mt-2">
                        <div class="flex justify-between items-center mb-2">
                             <h4 class="font-bold text-sm text-purple-700">
                                 {{ editingVariantIndex !== null ? 'âœï¸ Ğ ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ' : 'ĞšĞ¾Ğ½ÑÑ‚Ñ€ÑƒĞºÑ‚Ğ¾Ñ€ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñ–Ğ²' }}
                             </h4>
                             <button v-if="editingVariantIndex !== null" @click="cancelVariantEdit" class="text-xs text-gray-500 underline">Ğ¡ĞºĞ°ÑÑƒĞ²Ğ°Ñ‚Ğ¸</button>
                        </div>
                        
                        <div class="bg-purple-50 p-3 rounded-lg border border-purple-100 space-y-3" :class="{'ring-2 ring-purple-300': editingVariantIndex !== null}">
                            
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="text-[10px] uppercase font-bold text-gray-500">ĞĞ°Ğ·Ğ²Ğ°</label>
                                    <input v-model="variantBuilder.name" placeholder="Ğ½Ğ°Ğ¿Ñ€. XL" class="w-full border p-1.5 rounded text-sm">
                                </div>
                                <div>
                                    <label class="text-[10px] uppercase font-bold text-gray-500">Ğ¦Ñ–Ğ½Ğ°</label>
                                    <input v-model.number="variantBuilder.price" type="number" class="w-full border p-1.5 rounded text-sm">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="text-[10px] uppercase font-bold text-gray-500">Ğ¢ĞµÑ…. ĞºĞ°Ñ€Ñ‚Ğ°</label>
                                    <select v-model="variantBuilder.master_recipe_id" class="w-full border p-1.5 rounded text-sm bg-white">
                                        <option :value="null">-- Ğ‘ĞµĞ· Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ñƒ --</option>
                                        <option v-for="r in recipes" :key="r.id" :value="r.id">{{ r.name }}</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-[10px] uppercase font-bold text-gray-500">Ğ’Ğ°Ğ³Ğ° Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¾Ğ³Ğ¾ (Ğ³/Ğ¼Ğ»)</label>
                                    <input v-model.number="variantBuilder.output_weight" type="number" class="w-full border p-1.5 rounded text-sm">
                                </div>
                            </div>
                            
                            <div>
                                <label class="text-[10px] uppercase font-bold text-gray-500">ĞŸĞ¾Ñ‡Ğ°Ñ‚ĞºĞ¾Ğ²Ğ¸Ğ¹ Ğ·Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº (ÑˆÑ‚)</label>
                                <input v-model.number="variantBuilder.stock_quantity" type="number" class="w-full border p-1.5 rounded text-sm bg-white" placeholder="0">
                            </div>

                            <div class="bg-white/50 p-2 rounded border border-dashed border-purple-200">
                                <label class="text-[10px] uppercase font-bold text-purple-400">ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ</label>
                                <div class="flex gap-1 mb-1">
                                    <select v-model="tempVariantConsumable.consumable_id" class="flex-1 border p-1 rounded text-[10px] bg-white h-7">
                                        <option value="">ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»...</option>
                                        <option v-for="c in consumables" :key="c.id" :value="c.id">{{ c.name }}</option>
                                    </select>
                                    <input v-model.number="tempVariantConsumable.quantity" type="number" class="w-10 border p-1 rounded text-[10px] h-7" placeholder="Ğš-ÑÑ‚ÑŒ">
                                    <button @click="addVariantConsumable" class="bg-purple-500 text-white w-7 h-7 rounded hover:bg-purple-600 text-xs">+</button>
                                </div>
                                <div class="flex flex-wrap gap-1">
                                    <span v-for="(vc, idx) in variantBuilder.consumables" :key="idx" class="bg-white border text-[10px] px-1 rounded flex items-center gap-1">
                                        {{ vc.name }}: {{ vc.quantity }} <button @click="removeVariantConsumable(idx)" class="text-red-500 font-bold">&times;</button>
                                    </span>
                                </div>
                            </div>

                            <div class="bg-blue-50/50 p-2 rounded border border-dashed border-blue-200">
                                <label class="text-[10px] uppercase font-bold text-blue-500">Ğ”Ğ¾Ğ´Ğ°Ñ‚ĞºĞ¾Ğ²Ñ– Ñ–Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ğ¸</label>
                                <div class="flex gap-1 mb-1">
                                    <select v-model="tempVariantIngredient.ingredient_id" class="flex-1 border p-1 rounded text-[10px] bg-white h-7">
                                        <option value="">Ğ†Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚...</option>
                                        <option v-for="i in ingredients" :key="i.id" :value="i.id">
                                            {{ i.name }} ({{ i.unit?.symbol }})
                                        </option>
                                    </select>
                                    <input 
                                        v-model.number="tempVariantIngredient.quantity" 
                                        type="number" 
                                        class="w-16 border p-1 rounded text-[10px] h-7" 
                                        :placeholder="currentIngredientPlaceholder"
                                    >
                                    <button @click="addIngredientToVariant" class="bg-blue-500 text-white w-7 h-7 rounded hover:bg-blue-600 text-xs">+</button>
                                </div>
                                <div class="flex flex-wrap gap-1">
                                    <span v-for="(vi, idx) in variantBuilder.ingredients" :key="idx" class="bg-white border text-[10px] px-1 rounded flex items-center gap-1 text-blue-700">
                                        {{ vi.name }}: {{ vi.quantity }} {{ getIngredientUnit(vi.ingredient_id) }}
                                        <button @click="removeIngredientFromVariant(idx)" class="text-red-500 font-bold">&times;</button>
                                    </span>
                                </div>
                            </div>

                            <button @click="saveVariant" class="w-full text-xs font-bold py-2 rounded transition-colors"
                                :class="editingVariantIndex !== null ? 'bg-orange-400 text-white hover:bg-orange-500' : 'bg-purple-200 text-purple-800 hover:bg-purple-300'">
                                {{ editingVariantIndex !== null ? 'Ğ—Ğ±ĞµÑ€ĞµĞ³Ñ‚Ğ¸ Ğ·Ğ¼Ñ–Ğ½Ğ¸ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ' : 'Ğ”Ğ¾Ğ´Ğ°Ñ‚Ğ¸ Ñ†ĞµĞ¹ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚ Ñƒ ÑĞ¿Ğ¸ÑĞ¾Ğº' }}
                            </button>
                        </div>
                    </div>
                    
                    <div v-if="newProduct.variants.length > 0" class="space-y-2">
                        <div v-for="(v, idx) in newProduct.variants" :key="idx" 
                             class="bg-white border p-2 rounded flex justify-between items-center text-sm"
                             :class="{'border-purple-400 bg-purple-50': editingVariantIndex === idx}"
                        >
                            <div>
                                <span class="font-bold">{{ v.name }}</span> - {{ v.price }} Ğ³Ñ€Ğ½
                                <div class="text-xs text-gray-400">
                                    <span v-if="v.master_recipe_id" class="text-purple-600 mr-2">ğŸ“œ Ğ ĞµÑ†ĞµĞ¿Ñ‚ ID: {{ v.master_recipe_id }}</span>
                                    <span v-if="v.stock_quantity > 0" class="text-green-600 font-bold">Ğ—Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº: {{ v.stock_quantity }}</span>
                                    <span v-if="v.ingredients?.length" class="text-blue-500 ml-2">Ğ†Ğ½Ğ³Ñ€: {{ v.ingredients.length }}</span>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button @click="editVariant(idx)" class="text-blue-500 hover:text-blue-700"><i class="fas fa-pen"></i></button>
                                <button @click="removeVariant(idx)" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    </div>
                </div>

                <button @click="handleSave" class="w-full bg-green-600 text-white font-bold py-3 rounded-xl hover:bg-green-700 mt-4 shadow-lg shadow-green-100">
                    {{ isEditing ? 'Ğ—Ğ±ĞµÑ€ĞµĞ³Ñ‚Ğ¸ Ğ·Ğ¼Ñ–Ğ½Ğ¸' : 'Ğ¡Ñ‚Ğ²Ğ¾Ñ€Ğ¸Ñ‚Ğ¸ Ñ‚Ğ¾Ğ²Ğ°Ñ€' }}
                </button>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden flex flex-col h-full" :class="showForm ? 'xl:col-span-2' : 'xl:col-span-3'">
            
            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
                <div class="flex items-center gap-4">
                    <h2 class="font-bold text-gray-700">Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ–Ğ²</h2>
                    <input v-model="productSearch" placeholder="ĞŸĞ¾ÑˆÑƒĞº..." class="border rounded px-2 py-1 text-sm bg-white">
                </div>
                <button v-if="!showForm" @click="showForm = true; resetForm()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-bold text-sm shadow-md shadow-blue-100">
                    + ĞĞ¾Ğ²Ğ¸Ğ¹ Ñ‚Ğ¾Ğ²Ğ°Ñ€
                </button>
            </div>

            <div class="overflow-auto flex-1">
                <table class="w-full text-left text-sm">
                    <thead class="bg-gray-50 text-gray-500 uppercase text-xs sticky top-0">
                        <tr>
                            <th class="p-4">ĞĞ°Ğ·Ğ²Ğ°</th>
                            <th class="p-4">ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ</th>
                            <th class="p-4">Ğ¦Ñ–Ğ½Ğ° / Ğ’Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸</th>
                            <th class="p-4 text-center">Ğ”Ñ–Ñ—</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        <tr v-if="filteredProducts.length === 0">
                            <td colspan="4" class="p-8 text-center text-gray-400">
                                Ğ¢Ğ¾Ğ²Ğ°Ñ€Ñ–Ğ² Ğ½ĞµĞ¼Ğ°Ñ” Ğ°Ğ±Ğ¾ Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ...
                            </td>
                        </tr>
                        <tr v-for="p in filteredProducts" :key="p.id" class="hover:bg-gray-50 align-top group">
                            <td class="p-4 font-bold text-gray-800">{{ p.name }}</td>
                            <td class="p-4 text-gray-600">
                                <span class="bg-gray-100 px-2 py-1 rounded text-xs">{{ getCategoryName(p.category_id) }}</span>
                            </td>
                            <td class="p-4">
                                <div v-if="!p.has_variants" class="font-mono font-bold text-green-600">
                                    {{ p.price }} â‚´
                                </div>
                                
                                <div v-else class="space-y-2">
                                    <div v-for="v in p.variants" :key="v.id" class="text-xs bg-gray-50 p-2 rounded border border-gray-200">
                                        <div class="flex justify-between font-bold mb-1">
                                            <span>{{ v.name }}</span>
                                            <span>{{ v.price }} â‚´</span>
                                        </div>

                                        <div class="text-gray-500 flex flex-col gap-1">
                                            
                                            <div v-if="v.ingredients?.length" class="text-blue-600">
                                                <div class="flex items-start gap-1">
                                                    <i class="fas fa-flask mt-0.5"></i> 
                                                    <div class="flex flex-wrap gap-1">
                                                        <span v-for="vi in v.ingredients" :key="vi.id" class="bg-blue-50 border border-blue-100 px-1 rounded flex items-center gap-1">
                                                            {{ vi.ingredient_name || '?' }}: {{ vi.quantity }} {{ getIngredientUnit(vi.ingredient_id) }}
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>

                                            <div v-if="v.consumables?.length" class="text-teal-600">
                                                <div class="flex items-start gap-1">
                                                    <i class="fas fa-box-open mt-0.5"></i> 
                                                    <div class="flex flex-wrap gap-1">
                                                        <span v-for="vc in v.consumables" :key="vc.id" class="bg-teal-50 border border-teal-100 px-1 rounded">
                                                            {{ vc.consumable_name || '?' }}: {{ vc.quantity }}
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>

                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td class="p-4 text-center">
                                <div class="flex justify-center gap-2">
                                    <button @click="handleEdit(p)" class="text-blue-500 hover:text-blue-700 p-1.5 hover:bg-blue-50 rounded"><i class="fas fa-pen"></i></button>
                                    <button @click="deleteProduct(p.id)" class="text-red-400 hover:text-red-600 p-1.5 hover:bg-red-50 rounded"><i class="fas fa-trash"></i></button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</template>

--------------------------------------------------
PATH: ./.history/frontend/src/components/warehouse/tabs/StockTab_20260125201428.vue
--------------------------------------------------
<script setup>
import { ref, computed, onMounted, defineAsyncComponent } from 'vue' // Ğ”Ğ¾Ğ´Ğ°Ğ»Ğ¸ defineAsyncComponent
import { useWarehouse } from '@/composables/useWarehouse'
import axios from 'axios'

// Ğ†Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ÑƒÑ”Ğ¼Ğ¾ Ğ¼Ğ¾Ğ´Ğ°Ğ»ĞºÑƒ Ñ–ÑÑ‚Ğ¾Ñ€Ñ–Ñ— (Ñ‚Ğ°Ğº ÑĞ°Ğ¼Ğ¾, ÑĞº Ğ±ÑƒĞ»Ğ¾ Ğ² ÑÑ‚Ğ°Ñ€Ñ–Ğ¹ Ğ²ĞµÑ€ÑÑ–Ñ—)
const HistoryModal = defineAsyncComponent(() => import('../modals/HistoryModal.vue'))

// ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ğ´Ğ°Ğ½Ñ– Ğ·Ñ– ÑÑ…Ğ¾Ğ²Ğ¸Ñ‰Ğ°
const { ingredients, consumables, products, fetchWarehouseData } = useWarehouse()

const activeTab = ref('ingredients') 
const search = ref('')
const loading = ref(false)

// Ğ—Ğ¼Ñ–Ğ½Ğ½Ñ– Ğ´Ğ»Ñ Ñ€ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ
const editingItem = ref(null)
const editValue = ref(0)

// --- Ğ—ĞœĞ†ĞĞĞ† Ğ”Ğ›Ğ¯ Ğ†Ğ¡Ğ¢ĞĞ Ğ†Ğ‡ ---
const isHistoryOpen = ref(false)
const historyItem = ref(null)

// --- Ğ¤Ğ£ĞĞšĞ¦Ğ†Ğ¯ Ğ’Ğ†Ğ”ĞšĞ Ğ˜Ğ¢Ğ¢Ğ¯ Ğ†Ğ¡Ğ¢ĞĞ Ğ†Ğ‡ ---
const openHistory = (item) => {
    // Ğ¤Ğ¾Ñ€Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ğ¾Ğ±'Ñ”ĞºÑ‚, ÑĞºĞ¸Ğ¹ Ğ¾Ñ‡Ñ–ĞºÑƒÑ” HistoryModal
    historyItem.value = {
        id: item.original_id || item.id, // ID ÑÑƒÑ‚Ğ½Ğ¾ÑÑ‚Ñ– Ğ² Ğ±Ğ°Ğ·Ñ–
        type: item.type,                 // 'ingredient', 'consumable', 'product', 'product_variant'
        name: item.display_name          // ĞĞ°Ğ·Ğ²Ğ° Ğ´Ğ»Ñ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ°
    }
    isHistoryOpen.value = true
}

// --- ĞŸĞ»Ğ¾ÑĞºĞ¸Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ´Ğ»Ñ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ– ---
const filteredItems = computed(() => {
    let list = []

    // 1. Ğ¡Ğ˜Ğ ĞĞ’Ğ˜ĞĞ
    if (activeTab.value === 'ingredients') {
        list = ingredients.value.map(i => ({ 
            ...i, 
            type: 'ingredient', 
            display_name: i.name,
            unit_symbol: i.unit?.symbol || '' 
        }))
    } 
    // 2. ĞœĞĞ¢Ğ•Ğ Ğ†ĞĞ›Ğ˜
    else if (activeTab.value === 'consumables') {
        list = consumables.value.map(c => ({ 
            ...c, 
            type: 'consumable', 
            display_name: c.name,
            unit_symbol: c.unit?.symbol || ''
        }))
    } 
    // 3. Ğ¢ĞĞ’ĞĞ Ğ˜ (Ğ Ğ¾Ğ·Ğ³Ğ¾Ñ€Ñ‚Ğ°Ñ”Ğ¼Ğ¾ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸!)
    else if (activeTab.value === 'products') {
        products.value.forEach(p => {
            if (p.has_variants && p.variants) {
                // Ğ’Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸
                p.variants.forEach(v => {
                    list.push({
                        id: v.id, 
                        original_id: v.id,
                        type: 'product_variant', 
                        display_name: `${p.name} (${v.name})`, 
                        stock_quantity: v.stock_quantity,
                        unit_symbol: 'ÑˆÑ‚',
                        product_id: p.id 
                    })
                })
            } else {
                // ĞŸÑ€Ğ¾ÑÑ‚Ñ– Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¸
                list.push({
                    id: p.id,
                    original_id: p.id,
                    type: 'product',
                    display_name: p.name,
                    stock_quantity: p.stock_quantity,
                    unit_symbol: 'ÑˆÑ‚'
                })
            }
        })
    }

    if (search.value) {
        const s = search.value.toLowerCase()
        return list.filter(i => i.display_name.toLowerCase().includes(s))
    }
    return list
})

// --- Ğ›ĞĞ“Ğ†ĞšĞ Ğ Ğ•Ğ”ĞĞ“Ğ£Ğ’ĞĞĞĞ¯ Ğ—ĞĞ›Ğ˜Ğ¨ĞšĞ†Ğ’ ---
const startEdit = (item) => {
    editingItem.value = item.id 
    editValue.value = item.stock_quantity
}

const saveEdit = async (item) => {
    if (editValue.value < 0) return alert("ĞĞµ Ğ¼Ğ¾Ğ¶Ğµ Ğ±ÑƒÑ‚Ğ¸ Ğ¼Ñ–Ğ½ÑƒÑĞ¾Ğ²Ğ¸Ğ¼")
    
    loading.value = true
    try {
        let url = ''
        let payload = {}
        let method = 'put'

        if (item.type === 'ingredient') {
            url = `/api/ingredients/${item.original_id || item.id}`
            payload = { ...item, stock_quantity: editValue.value }
        } 
        else if (item.type === 'consumable') {
            url = `/api/consumables/${item.original_id || item.id}`
            payload = { ...item, stock_quantity: editValue.value }
        }
        else if (item.type === 'product') {
            url = `/api/products/${item.original_id || item.id}/stock?qty=${editValue.value}`
            method = 'patch'
            payload = {} 
        }
        else if (item.type === 'product_variant') {
            url = `/api/products/variants/${item.original_id || item.id}/stock?qty=${editValue.value}`
            method = 'patch'
            payload = {}
        }

        if (method === 'put') {
            await axios.put(url, payload)
        } else {
            await axios.patch(url)
        }

        item.stock_quantity = editValue.value
        await fetchWarehouseData()
        editingItem.value = null
    } catch (e) {
        console.error(e)
        alert("ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ Ğ·Ğ°Ğ»Ğ¸ÑˆĞºÑƒ")
    } finally {
        loading.value = false
    }
}

onMounted(() => {
    fetchWarehouseData()
})
</script>

<template>
    <div class="h-full flex flex-col bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
        
        <div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center gap-4">
            <div class="flex p-1 bg-white rounded-xl border border-gray-200 shadow-sm">
                <button 
                    v-for="tab in ['ingredients', 'consumables', 'products']" 
                    :key="tab"
                    @click="activeTab = tab"
                    class="px-4 py-2 text-xs font-bold rounded-lg transition-all"
                    :class="activeTab === tab ? 'bg-blue-600 text-white shadow-md' : 'text-gray-500 hover:bg-gray-50'"
                >
                    {{ tab === 'ingredients' ? 'ğŸ¥¦ Ğ¡Ğ¸Ñ€Ğ¾Ğ²Ğ¸Ğ½Ğ°' : (tab === 'consumables' ? 'ğŸ“¦ ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸' : 'ğŸ¹ Ğ¢Ğ¾Ğ²Ğ°Ñ€Ğ¸') }}
                </button>
            </div>

            <input 
                v-model="search" 
                placeholder="ĞŸĞ¾ÑˆÑƒĞº..." 
                class="border border-gray-200 rounded-xl px-3 py-2 text-sm outline-none focus:border-blue-500 w-64"
            >
        </div>

        <div class="flex-1 overflow-auto">
            <table class="w-full text-left text-sm">
                <thead class="bg-gray-50 text-gray-500 uppercase text-xs sticky top-0 z-10">
                    <tr>
                        <th class="p-4">ĞĞ°Ğ·Ğ²Ğ°</th>
                        <th class="p-4 text-center">Ğ¢Ğ¸Ğ¿</th>
                        <th class="p-4 text-right">Ğ—Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº</th>
                        <th class="p-4 text-center">Ğ”Ñ–Ñ—</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    <tr v-if="filteredItems.length === 0">
                        <td colspan="4" class="p-8 text-center text-gray-400">
                            ĞÑ–Ñ‡Ğ¾Ğ³Ğ¾ Ğ½Ğµ Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾...
                        </td>
                    </tr>
                    
                    <tr v-for="item in filteredItems" :key="item.id + item.type" class="hover:bg-gray-50 group">
                        
                        <td class="p-4 font-bold text-gray-700">
                            {{ item.display_name }}
                        </td>

                        <td class="p-4 text-center">
                            <span v-if="item.type === 'ingredient'" class="bg-green-100 text-green-700 px-2 py-1 rounded text-[10px] font-bold">Ğ¡Ğ¸Ñ€Ğ¾Ğ²Ğ¸Ğ½Ğ°</span>
                            <span v-else-if="item.type === 'consumable'" class="bg-teal-100 text-teal-700 px-2 py-1 rounded text-[10px] font-bold">ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»</span>
                            <span v-else-if="item.type === 'product'" class="bg-purple-100 text-purple-700 px-2 py-1 rounded text-[10px] font-bold">Ğ¢Ğ¾Ğ²Ğ°Ñ€</span>
                            <span v-else-if="item.type === 'product_variant'" class="bg-indigo-100 text-indigo-700 px-2 py-1 rounded text-[10px] font-bold">Ğ’Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚</span>
                        </td>

                        <td class="p-4 text-right font-mono font-bold">
                            <div v-if="editingItem === item.id" class="flex items-center justify-end gap-2">
                                <input 
                                    v-model.number="editValue" 
                                    type="number" 
                                    class="w-20 border rounded p-1 text-right focus:ring-2 ring-blue-500 outline-none"
                                >
                                <span class="text-xs text-gray-400">{{ item.unit_symbol }}</span>
                            </div>
                            <span v-else :class="{'text-red-500 bg-red-50 px-2 py-1 rounded': item.stock_quantity <= 0, 'text-gray-700': item.stock_quantity > 0}">
                                {{ item.stock_quantity }} {{ item.unit_symbol }}
                            </span>
                        </td>

                        <td class="p-4 text-center">
                            <div v-if="editingItem === item.id" class="flex justify-center gap-1">
                                <button @click="saveEdit(item)" class="bg-green-500 text-white w-7 h-7 rounded hover:bg-green-600 flex items-center justify-center">
                                    <i class="fas fa-check text-xs"></i>
                                </button>
                                <button @click="editingItem = null" class="bg-gray-300 text-gray-700 w-7 h-7 rounded hover:bg-gray-400 flex items-center justify-center">
                                    <i class="fas fa-times text-xs"></i>
                                </button>
                            </div>
                            
                            <div v-else class="flex justify-center gap-2">
                                <button @click="openHistory(item)" class="text-purple-400 hover:text-purple-600 p-2 rounded hover:bg-purple-50 transition-colors" title="Ğ†ÑÑ‚Ğ¾Ñ€Ñ–Ñ Ñ€ÑƒÑ…Ñƒ">
                                    <i class="fas fa-history"></i>
                                </button>
                                <button @click="startEdit(item)" class="text-blue-400 hover:text-blue-600 p-2 rounded hover:bg-blue-50 transition-colors" title="ĞšĞ¾Ñ€ĞµĞ³ÑƒĞ²Ğ°Ñ‚Ğ¸ Ğ·Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº">
                                    <i class="fas fa-pen"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <HistoryModal 
            v-if="isHistoryOpen" 
            :is-open="isHistoryOpen" 
            :item="historyItem" 
            @close="isHistoryOpen = false" 
        />
    </div>
</template>

--------------------------------------------------
PATH: ./.history/frontend/src/components/warehouse/tabs/ProductsTab_20260123213650.vue
--------------------------------------------------
<script setup>
import { ref, onMounted } from 'vue'
import { useWarehouse } from '@/composables/useWarehouse'
import { useProducts } from '@/composables/useProducts'

// ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ğ´Ğ°Ğ½Ñ– Ğ·Ñ– ÑĞºĞ»Ğ°Ğ´Ñƒ (ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ—, Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ğ¸, Ñ–Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ğ¸ Ğ´Ğ»Ñ ÑĞ¿Ğ¸ÑĞºÑ–Ğ²)
const { categories, recipes, ingredients, consumables } = useWarehouse()

// ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ğ»Ğ¾Ğ³Ñ–ĞºÑƒ Ñ€Ğ¾Ğ±Ğ¾Ñ‚Ğ¸ Ğ· Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°Ğ¼Ğ¸
const { 
    newProduct, isEditing, editingId, 
    variantBuilder, tempProductConsumable, tempVariantConsumable, tempVariantIngredient,
    resetForm, prepareEdit, saveProduct, deleteProduct,
    addVariant, removeVariant, 
    addProductConsumable, removeProductConsumable,
    addVariantConsumable, removeVariantConsumable,
    addIngredientToVariant, removeIngredientFromVariant,
    fetchProducts // Ğ¤ÑƒĞ½ĞºÑ†Ñ–Ñ Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ ÑĞ¿Ğ¸ÑĞºÑƒ
} = useProducts()

const showForm = ref(false)

// Ğ¥ĞµĞ»Ğ¿ĞµÑ€ Ğ´Ğ»Ñ ĞºÑ€Ğ°ÑĞ¸Ğ²Ğ¾Ñ— Ğ½Ğ°Ğ·Ğ²Ğ¸ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ—
const getCategoryName = (id) => {
    const c = categories.value.find(x => x.id === id)
    return c ? c.name : '-'
}

// ĞĞ±Ñ€Ğ¾Ğ±ĞºĞ° Ğ·Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ½Ñ
const handleSave = async () => {
    const success = await saveProduct()
    if(success) showForm.value = false
}

// ĞĞ±Ñ€Ğ¾Ğ±ĞºĞ° Ñ€ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ
const handleEdit = (product) => {
    prepareEdit(product)
    showForm.value = true
}

// Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ¿Ñ€Ğ¸ ÑÑ‚Ğ°Ñ€Ñ‚Ñ–
onMounted(async () => {
    await fetchProducts()
})
</script>

<template>
    <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
        
        <div v-if="showForm" class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 h-fit xl:col-span-1">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-gray-700">
                    {{ isEditing ? 'âœï¸ Ğ ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ' : 'ğŸ“¦ ĞĞ¾Ğ²Ğ¸Ğ¹ Ñ‚Ğ¾Ğ²Ğ°Ñ€' }}
                </h3>
                <button @click="showForm = false; resetForm()" class="text-xs text-red-500 hover:underline">Ğ—Ğ°ĞºÑ€Ğ¸Ñ‚Ğ¸</button>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞĞ°Ğ·Ğ²Ğ°</label>
                    <input v-model="newProduct.name" class="border p-2 rounded w-full focus:ring-2 ring-blue-100 outline-none">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ</label>
                        <select v-model="newProduct.category_id" class="border p-2 rounded w-full bg-white">
                            <option :value="null">-- Ğ‘ĞµĞ· ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ— --</option>
                            <option v-for="c in categories" :key="c.id" :value="c.id">{{ c.name }}</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ğ¦Ñ–Ğ½Ğ° (Ğ±Ğ°Ğ·Ğ¾Ğ²Ğ°)</label>
                        <input v-model.number="newProduct.price" type="number" class="border p-2 rounded w-full">
                    </div>
                </div>

                <div class="flex items-center gap-2 py-2">
                    <input type="checkbox" v-model="newProduct.has_variants" id="hasVar" class="w-4 h-4 text-blue-600">
                    <label for="hasVar" class="text-sm font-bold text-gray-700 select-none">Ğ¦ĞµĞ¹ Ñ‚Ğ¾Ğ²Ğ°Ñ€ Ğ¼Ğ°Ñ” Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸ (Ñ€Ğ¾Ğ·Ğ¼Ñ–Ñ€Ğ¸)</label>
                </div>

                <div v-if="!newProduct.has_variants" class="bg-gray-50 p-3 rounded border border-gray-200 space-y-3">
                     <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞœĞ°Ğ¹ÑÑ‚ĞµÑ€-Ñ€ĞµÑ†ĞµĞ¿Ñ‚</label>
                        <select v-model="newProduct.master_recipe_id" class="border p-2 rounded w-full bg-white text-sm">
                            <option :value="null">-- Ğ‘ĞµĞ· Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ñƒ --</option>
                            <option v-for="r in recipes" :key="r.id" :value="r.id">{{ r.name }}</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ğ’Ğ¸Ñ…Ñ–Ğ´Ğ½Ğ° Ğ²Ğ°Ğ³Ğ° (Ğ³/Ğ¼Ğ»)</label>
                        <input v-model.number="newProduct.output_weight" type="number" class="border p-2 rounded w-full text-sm">
                    </div>
                </div>

                <div class="bg-teal-50/50 p-3 rounded border border-teal-100">
                    <label class="text-[10px] uppercase font-bold text-teal-600 mb-2 block">Ğ—Ğ°Ğ³Ğ°Ğ»ÑŒĞ½Ñ– Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸</label>
                    <div class="flex gap-2 mb-2">
                        <select v-model="tempProductConsumable.consumable_id" class="flex-1 border p-1 rounded text-sm bg-white">
                            <option value="">ĞĞ±ĞµÑ€Ñ–Ñ‚ÑŒ Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»...</option>
                            <option v-for="c in consumables" :key="c.id" :value="c.id">{{ c.name }}</option>
                        </select>
                        <input v-model.number="tempProductConsumable.quantity" type="number" class="w-16 border p-1 rounded text-sm" placeholder="Ğš-ÑÑ‚ÑŒ">
                        <button @click="addProductConsumable" class="bg-teal-500 text-white w-8 rounded hover:bg-teal-600">+</button>
                    </div>
                    <div class="flex flex-wrap gap-1">
                        <span v-for="(pc, idx) in newProduct.consumables" :key="idx" class="bg-white border border-teal-200 text-teal-700 text-xs px-2 py-1 rounded flex items-center gap-1">
                            {{ pc.name }}: {{ pc.quantity }}
                            <button @click="removeProductConsumable(idx)" class="text-red-400 font-bold ml-1 hover:text-red-600">&times;</button>
                        </span>
                    </div>
                </div>

                <div v-if="newProduct.has_variants" class="space-y-3">
                    <div class="border-t pt-2 mt-2">
                        <h4 class="font-bold text-sm text-purple-700 mb-2">Ğ”Ğ¾Ğ´Ğ°Ñ‚Ğ¸ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚</h4>
                        
                        <div class="bg-purple-50 p-3 rounded-lg border border-purple-100 space-y-3">
                            <div class="grid grid-cols-2 gap-2">
                                <input v-model="variantBuilder.name" placeholder="ĞĞ°Ğ·Ğ²Ğ° (Ğ½Ğ°Ğ¿Ñ€. Ğ’ĞµĞ»Ğ¸ĞºĞ¸Ğ¹)" class="border p-1.5 rounded text-sm">
                                <input v-model.number="variantBuilder.price" type="number" placeholder="Ğ¦Ñ–Ğ½Ğ°" class="border p-1.5 rounded text-sm">
                            </div>
                            
                            <div class="grid grid-cols-2 gap-2">
                                <select v-model="variantBuilder.master_recipe_id" class="border p-1.5 rounded text-sm bg-white">
                                    <option :value="null">Ğ ĞµÑ†ĞµĞ¿Ñ‚...</option>
                                    <option v-for="r in recipes" :key="r.id" :value="r.id">{{ r.name }}</option>
                                </select>
                                <input v-model.number="variantBuilder.output_weight" type="number" placeholder="Ğ’Ğ°Ğ³Ğ° Ğ¿Ğ¾Ñ€Ñ†Ñ–Ñ—" class="border p-1.5 rounded text-sm">
                            </div>

                            <div class="bg-white/50 p-2 rounded border border-dashed border-purple-200">
                                <label class="text-[10px] uppercase font-bold text-purple-400">ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ</label>
                                <div class="flex gap-1 mb-1">
                                    <select v-model="tempVariantConsumable.consumable_id" class="flex-1 border p-1 rounded text-[10px] bg-white h-7">
                                        <option value="">ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»...</option>
                                        <option v-for="c in consumables" :key="c.id" :value="c.id">{{ c.name }}</option>
                                    </select>
                                    <input v-model.number="tempVariantConsumable.quantity" type="number" class="w-10 border p-1 rounded text-[10px] h-7" placeholder="Ğš-ÑÑ‚ÑŒ">
                                    <button @click="addVariantConsumable" class="bg-purple-500 text-white w-7 h-7 rounded hover:bg-purple-600 text-xs">+</button>
                                </div>
                                <div class="flex flex-wrap gap-1">
                                    <span v-for="(vc, idx) in variantBuilder.consumables" :key="idx" class="bg-white border text-[10px] px-1 rounded flex items-center gap-1">
                                        {{ vc.name }}: {{ vc.quantity }} <button @click="removeVariantConsumable(idx)" class="text-red-500 font-bold">&times;</button>
                                    </span>
                                </div>
                            </div>

                            <div class="bg-blue-50/50 p-2 rounded border border-dashed border-blue-200">
                                <label class="text-[10px] uppercase font-bold text-blue-500">Ğ”Ğ¾Ğ´Ğ°Ñ‚ĞºĞ¾Ğ²Ñ– Ñ–Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ğ¸</label>
                                <div class="flex gap-1 mb-1">
                                    <select v-model="tempVariantIngredient.ingredient_id" class="flex-1 border p-1 rounded text-[10px] bg-white h-7">
                                        <option value="">Ğ†Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚...</option>
                                        <option v-for="i in ingredients" :key="i.id" :value="i.id">{{ i.name }}</option>
                                    </select>
                                    <input v-model.number="tempVariantIngredient.quantity" type="number" class="w-10 border p-1 rounded text-[10px] h-7" placeholder="Ğ“Ñ€Ğ°Ğ¼">
                                    <button @click="addIngredientToVariant" class="bg-blue-500 text-white w-7 h-7 rounded hover:bg-blue-600 text-xs">+</button>
                                </div>
                                <div class="flex flex-wrap gap-1">
                                    <span v-for="(vi, idx) in variantBuilder.ingredients" :key="idx" class="bg-white border text-[10px] px-1 rounded flex items-center gap-1 text-blue-700">
                                        {{ vi.name }}: {{ vi.quantity }} <button @click="removeIngredientFromVariant(idx)" class="text-red-500 font-bold">&times;</button>
                                    </span>
                                </div>
                            </div>

                            <button @click="addVariant" class="w-full bg-purple-200 text-purple-800 text-xs font-bold py-2 rounded hover:bg-purple-300">
                                Ğ”Ğ¾Ğ´Ğ°Ñ‚Ğ¸ Ñ†ĞµĞ¹ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚ Ñƒ ÑĞ¿Ğ¸ÑĞ¾Ğº
                            </button>
                        </div>
                    </div>

                    <div v-if="newProduct.variants.length > 0" class="space-y-2">
                        <div v-for="(v, idx) in newProduct.variants" :key="idx" class="bg-white border p-2 rounded flex justify-between items-center text-sm">
                            <div>
                                <span class="font-bold">{{ v.name }}</span> - {{ v.price }} Ğ³Ñ€Ğ½
                                <div class="text-xs text-gray-400">
                                    <span v-if="v.consumables.length">ĞœĞ°Ñ‚: {{ v.consumables.length }}</span>
                                    <span v-if="v.ingredients.length" class="ml-2 text-blue-600">Ğ†Ğ½Ğ³: {{ v.ingredients.length }}</span>
                                </div>
                            </div>
                            <button @click="removeVariant(idx)" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                </div>

                <button @click="handleSave" class="w-full bg-green-600 text-white font-bold py-3 rounded-xl hover:bg-green-700 shadow-lg shadow-green-100 mt-4">
                    {{ isEditing ? 'Ğ—Ğ±ĞµÑ€ĞµĞ³Ñ‚Ğ¸ Ğ·Ğ¼Ñ–Ğ½Ğ¸' : 'Ğ¡Ñ‚Ğ²Ğ¾Ñ€Ğ¸Ñ‚Ğ¸ Ñ‚Ğ¾Ğ²Ğ°Ñ€' }}
                </button>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden flex flex-col h-full" :class="showForm ? 'xl:col-span-2' : 'xl:col-span-3'">
            
            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
                <h2 class="font-bold text-gray-700">Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ–Ğ²</h2>
                <button v-if="!showForm" @click="showForm = true; resetForm()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-bold text-sm shadow-lg shadow-blue-100">
                    + ĞĞ¾Ğ²Ğ¸Ğ¹ Ñ‚Ğ¾Ğ²Ğ°Ñ€
                </button>
            </div>

            <div class="overflow-auto flex-1">
                <table class="w-full text-left text-sm">
                    <thead class="bg-gray-50 text-gray-500 uppercase text-xs sticky top-0">
                        <tr>
                            <th class="p-4">ĞĞ°Ğ·Ğ²Ğ°</th>
                            <th class="p-4">ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ</th>
                            <th class="p-4">Ğ¦Ñ–Ğ½Ğ° / Ğ’Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸</th>
                            <th class="p-4">Ğ ĞµÑ†ĞµĞ¿Ñ‚ / Ğ¡ĞºĞ»Ğ°Ğ´</th>
                            <th class="p-4 text-center">Ğ”Ñ–Ñ—</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        <tr v-if="!useWarehouse().products.value.length">
                            <td colspan="5" class="p-8 text-center text-gray-400">Ğ¢Ğ¾Ğ²Ğ°Ñ€Ñ–Ğ² Ñ‰Ğµ Ğ½ĞµĞ¼Ğ°Ñ” (Ğ°Ğ±Ğ¾ Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ...)</td>
                        </tr>
                        <tr v-for="p in useWarehouse().products.value" :key="p.id" class="hover:bg-gray-50 group align-top">
                            <td class="p-4 font-bold text-gray-800">{{ p.name }}</td>
                            <td class="p-4 text-gray-600">
                                <span class="bg-gray-100 px-2 py-1 rounded text-xs">{{ getCategoryName(p.category_id) }}</span>
                            </td>
                            
                            <td class="p-4">
                                <div v-if="!p.has_variants" class="font-mono font-bold text-lg text-green-600">
                                    {{ p.price }} â‚´
                                </div>
                                <div v-else class="space-y-1">
                                    <div v-for="v in p.variants" :key="v.id" class="text-xs bg-gray-50 p-1.5 rounded border border-gray-200">
                                        <div class="flex justify-between font-bold text-gray-700 mb-1">
                                            <span>{{ v.name }}</span>
                                            <span>{{ v.price }} â‚´</span>
                                        </div>
                                        
                                        <div v-if="v.consumables && v.consumables.length > 0" class="flex flex-wrap gap-1 mb-1">
                                            <span v-for="c in v.consumables" :key="c.consumable_id" class="bg-teal-50 text-teal-700 px-1 rounded border border-teal-100 text-[10px]">
                                                ğŸ“¦ {{ c.consumable_name || 'ĞœĞ°Ñ‚' }}: {{ c.quantity }}
                                            </span>
                                        </div>

                                        <div v-if="v.ingredients && v.ingredients.length > 0" class="flex flex-wrap gap-1">
                                            <span v-for="i in v.ingredients" :key="i.ingredient_id" class="bg-blue-50 text-blue-700 px-1 rounded border border-blue-100 text-[10px]">
                                                ğŸ’§ {{ i.ingredient_name || 'Ğ†Ğ½Ğ³Ñ€' }}: {{ i.quantity }}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </td>

                            <td class="p-4 text-xs">
                                <div v-if="p.master_recipe" class="text-purple-600 font-bold mb-1">
                                    ğŸ“œ {{ p.master_recipe.name }}
                                </div>
                                <div v-if="p.consumables && p.consumables.length > 0" class="flex flex-wrap gap-1">
                                    <span v-for="c in p.consumables" :key="c.consumable_id" class="bg-orange-50 text-orange-700 px-1 rounded border border-orange-100 text-[10px]">
                                        + {{ c.consumable_name }}: {{ c.quantity }}
                                    </span>
                                </div>
                            </td>

                            <td class="p-4 text-center">
                                <div class="flex justify-center gap-2">
                                    <button @click="handleEdit(p)" class="text-blue-400 hover:text-blue-600 p-2 rounded hover:bg-blue-50"><i class="fas fa-pen"></i></button>
                                    <button @click="deleteProduct(p.id)" class="text-gray-300 hover:text-red-500 p-2 rounded hover:bg-red-50"><i class="fas fa-trash"></i></button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</template>

--------------------------------------------------
PATH: ./.history/frontend/src/components/warehouse/tabs/StockTab_20260123205151.vue
--------------------------------------------------
<script setup>
import { ref, computed, onMounted } from 'vue'
import { useWarehouse } from '@/composables/useWarehouse'
import axios from 'axios'

// ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ğ´Ğ°Ğ½Ñ–. Ğ”Ğ¾Ğ´Ğ°Ñ”Ğ¼Ğ¾ Ğ·Ğ°Ñ…Ğ¸ÑÑ‚, ÑĞºÑ‰Ğ¾ useWarehouse Ğ¿Ğ¾Ğ²ĞµÑ€Ğ½Ğµ undefined
const warehouseData = useWarehouse()
const consumables = warehouseData?.consumables || ref([])
const ingredients = warehouseData?.ingredients || ref([])
const fetchWarehouseData = warehouseData?.fetchWarehouseData || (async () => {})

const activeCategory = ref('ingredients') // 'ingredients' or 'consumables'
const searchQuery = ref('')
const showAdjustmentModal = ref(false)

// Ğ¤Ğ¾Ñ€Ğ¼Ğ° ĞºĞ¾Ñ€Ğ¸Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ
const adjustmentForm = ref({
    type: 'ingredient', // ingredient/consumable
    id: null,
    delta: 0,
    reason: ''
})

// --- COMPUTED: Ğ¤Ñ–Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ñ–Ñ (Ğ— Ğ—ĞĞ¥Ğ˜Ğ¡Ğ¢ĞĞœ Ğ’Ğ†Ğ” ĞŸĞĞœĞ˜Ğ›ĞĞš) ---
const filteredItems = computed(() => {
    // 1. Ğ’Ğ¸Ğ·Ğ½Ğ°Ñ‡Ğ°Ñ”Ğ¼Ğ¾ Ğ´Ğ¶ĞµÑ€ĞµĞ»Ğ¾ Ğ´Ğ°Ğ½Ğ¸Ñ…
    let source = null
    if (activeCategory.value === 'ingredients') {
        source = ingredients
    } else {
        source = consumables
    }

    // 2. Ğ—ĞĞ¥Ğ˜Ğ¡Ğ¢: Ğ¯ĞºÑ‰Ğ¾ Ğ´Ğ¶ĞµÑ€ĞµĞ»Ğ¾ Ñ‰Ğµ Ğ½Ğµ Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶Ğ¸Ğ»Ğ¾ÑÑŒ (undefined Ğ°Ğ±Ğ¾ Ğ½ĞµĞ¼Ğ°Ñ” .value)
    if (!source || !source.value) {
        return []
    }

    // 3. Ğ¤Ñ–Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ñ–Ñ
    if (!searchQuery.value) return source.value
    
    const q = searchQuery.value.toLowerCase()
    return source.value.filter(item => item.name.toLowerCase().includes(q))
})

// --- Ğ”Ñ–Ñ— ---

const openAdjustment = (item, type) => {
    adjustmentForm.value = {
        type: type,
        id: item.id,
        delta: 0,
        reason: '',
        currentName: item.name,
        currentStock: item.stock_quantity
    }
    showAdjustmentModal.value = true
}

const saveAdjustment = async () => {
    if (adjustmentForm.value.delta === 0) return alert("Ğ’ĞºĞ°Ğ¶Ñ–Ñ‚ÑŒ ĞºÑ–Ğ»ÑŒĞºÑ–ÑÑ‚ÑŒ")
    
    // Ğ’Ğ¸Ğ·Ğ½Ğ°Ñ‡Ğ°Ñ”Ğ¼Ğ¾ URL Ğ·Ğ°Ğ»ĞµĞ¶Ğ½Ğ¾ Ğ²Ñ–Ğ´ Ñ‚Ğ¸Ğ¿Ñƒ
    const endpoint = adjustmentForm.value.type === 'ingredient' 
        ? 'ingredients' 
        : 'consumables'
    
    try {
        // Ğ’Ñ–Ğ´Ğ¿Ñ€Ğ°Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ½Ğ° Ğ±ĞµĞºĞµĞ½Ğ´ (POST /api/inventory/{type}/{id}/adjust)
        // ĞŸÑ€Ğ¸Ğ¿ÑƒÑÑ‚Ğ¸Ğ¼Ğ¾, Ñ‰Ğ¾ Ğ±ĞµĞºĞµĞ½Ğ´ Ğ¼Ğ°Ñ” Ñ‚Ğ°ĞºĞ¸Ğ¹ Ñ€Ğ¾ÑƒÑ‚, Ğ°Ğ±Ğ¾ Ğ¼Ğ¸ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ¾Ğ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ñ‡ĞµÑ€ĞµĞ· PUT
        // Ğ”Ğ»Ñ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾Ñ‚Ğ¸, ÑĞºÑ‰Ğ¾ Ğ½ĞµĞ¼Ğ°Ñ” ÑĞ¿ĞµÑ†. Ñ€Ğ¾ÑƒÑ‚Ñƒ adjustment, Ğ¼Ğ¾Ğ¶Ğ½Ğ° Ğ²Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ°Ñ‚Ğ¸ PUT Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ
        // ĞĞ»Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¸Ğ¹ REST Ğ¿Ñ–Ğ´Ñ…Ñ–Ğ´ Ğ´Ğ»Ñ ÑĞºĞ»Ğ°Ğ´Ñƒ - Ñ†Ğµ Ğ¾ĞºÑ€ĞµĞ¼Ğ¸Ğ¹ Ñ€Ğ¾ÑƒÑ‚ Ñ€ÑƒÑ…Ñƒ.
        
        // ĞŸĞ¾ĞºĞ¸ Ñ‰Ğ¾ Ñ€ĞµĞ°Ğ»Ñ–Ğ·ÑƒÑ”Ğ¼Ğ¾ Ñ‡ĞµÑ€ĞµĞ· "Ğ¼Ğ¸Ğ»Ğ¸Ñ†Ñ" - Ğ¿Ñ€ÑĞ¼Ğµ Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ (ÑĞºÑ‰Ğ¾ Ñƒ Ğ²Ğ°Ñ Ğ½ĞµĞ¼Ğ°Ñ” Ñ€Ğ¾ÑƒÑ‚Ñƒ /adjust)
        // ĞĞ‘Ğ (ĞºÑ€Ğ°Ñ‰Ğµ) - ÑĞºÑ‰Ğ¾ Ğ²Ğ¸ Ğ½Ğµ Ñ€Ğ¾Ğ±Ğ¸Ğ»Ğ¸ Ñ€Ğ¾ÑƒÑ‚ adjust, Ñ‚Ğ¾ Ñ‚Ñ€ĞµĞ±Ğ° Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ¾Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğ¸ Ğ¿Ğ¾Ğ»Ğµ stock_quantity
        
        // Ğ’Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚ Ğ (ÑĞºÑ‰Ğ¾ Ñ” Ñ€Ğ¾ÑƒÑ‚ update):
        const item = filteredItems.value.find(i => i.id === adjustmentForm.value.id)
        const newQuantity = parseFloat(item.stock_quantity) + parseFloat(adjustmentForm.value.delta)
        
        await axios.put(`http://localhost:8001/inventory/${endpoint}/${adjustmentForm.value.id}`, {
            ...item,
            stock_quantity: newQuantity
        })

        await fetchWarehouseData()
        showAdjustmentModal.value = false
    } catch (e) {
        console.error(e)
        alert("ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ Ğ·Ğ°Ğ»Ğ¸ÑˆĞºÑƒ")
    }
}

// Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ¿Ñ€Ğ¸ Ğ²Ñ–Ğ´ĞºÑ€Ğ¸Ñ‚Ñ‚Ñ– Ğ²ĞºĞ»Ğ°Ğ´ĞºĞ¸
onMounted(() => {
    fetchWarehouseData()
})
</script>

<template>
    <div class="space-y-6">
        <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col md:flex-row justify-between items-center gap-4">
            
            <div class="flex bg-gray-100 p-1 rounded-xl">
                <button 
                    @click="activeCategory = 'ingredients'"
                    class="px-4 py-2 rounded-lg text-sm font-bold transition"
                    :class="activeCategory === 'ingredients' ? 'bg-white shadow text-blue-600' : 'text-gray-500 hover:text-gray-700'"
                >
                    ğŸ‹ Ğ†Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ğ¸
                </button>
                <button 
                    @click="activeCategory = 'consumables'"
                    class="px-4 py-2 rounded-lg text-sm font-bold transition"
                    :class="activeCategory === 'consumables' ? 'bg-white shadow text-purple-600' : 'text-gray-500 hover:text-gray-700'"
                >
                    ğŸ“¦ ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸
                </button>
            </div>

            <div class="relative w-full md:w-64">
                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                <input 
                    v-model="searchQuery" 
                    type="text" 
                    placeholder="ĞŸĞ¾ÑˆÑƒĞº Ğ¿Ğ¾ ÑĞºĞ»Ğ°Ğ´Ñƒ..." 
                    class="w-full pl-10 pr-4 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-100 outline-none text-sm"
                >
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
            <table class="w-full text-left text-sm">
                <thead class="bg-gray-50 text-xs uppercase font-bold text-gray-500">
                    <tr>
                        <th class="p-4">ĞĞ°Ğ·Ğ²Ğ°</th>
                        <th class="p-4 text-center">Ğ—Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº</th>
                        <th class="p-4">ĞĞ´. Ğ²Ğ¸Ğ¼.</th>
                        <th class="p-4">Ğ’Ğ°Ñ€Ñ‚Ñ–ÑÑ‚ÑŒ Ğ¾Ğ´.</th>
                        <th class="p-4 text-center">Ğ”Ñ–Ñ—</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    <tr v-if="filteredItems.length === 0">
                        <td colspan="5" class="p-8 text-center text-gray-400">ĞÑ–Ñ‡Ğ¾Ğ³Ğ¾ Ğ½Ğµ Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾</td>
                    </tr>
                    <tr v-for="item in filteredItems" :key="item.id" class="hover:bg-gray-50 transition">
                        <td class="p-4 font-bold text-gray-700">{{ item.name }}</td>
                        
                        <td class="p-4 text-center">
                            <span 
                                class="px-3 py-1 rounded-full font-mono font-bold text-xs"
                                :class="{
                                    'bg-green-100 text-green-700': item.stock_quantity > 10,
                                    'bg-yellow-100 text-yellow-700': item.stock_quantity <= 10 && item.stock_quantity > 0,
                                    'bg-red-100 text-red-700': item.stock_quantity <= 0
                                }"
                            >
                                {{ item.stock_quantity }}
                            </span>
                        </td>
                        
                        <td class="p-4 text-gray-500">{{ item.unit ? item.unit.symbol : '-' }}</td>
                        <td class="p-4 font-mono">{{ item.cost_per_unit }} â‚´</td>
                        
                        <td class="p-4 text-center">
                            <button 
                                @click="openAdjustment(item, activeCategory === 'ingredients' ? 'ingredient' : 'consumable')"
                                class="text-blue-600 hover:bg-blue-50 px-3 py-1 rounded text-xs font-bold transition border border-blue-200"
                            >
                                ĞšĞ¾Ñ€Ğ¸Ğ³ÑƒĞ²Ğ°Ñ‚Ğ¸
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div v-if="showAdjustmentModal" class="fixed inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl p-6">
                <h3 class="text-lg font-bold mb-1">ĞšĞ¾Ñ€Ğ¸Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ·Ğ°Ğ»Ğ¸ÑˆĞºÑƒ</h3>
                <p class="text-sm text-gray-500 mb-4">
                    {{ adjustmentForm.currentName }} (ĞŸĞ¾Ñ‚Ğ¾Ñ‡Ğ½Ğ¾: {{ adjustmentForm.currentStock }})
                </p>

                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ğ—Ğ¼Ñ–Ğ½Ğ° (+/-)</label>
                        <input 
                            v-model.number="adjustmentForm.delta" 
                            type="number" 
                            class="w-full border p-3 rounded-xl font-mono text-lg font-bold outline-none focus:ring-2 focus:ring-blue-100"
                            placeholder="ĞĞ°Ğ¿Ñ€. -5 Ğ°Ğ±Ğ¾ 10"
                        >
                        <p class="text-[10px] text-gray-400 mt-1">Ğ’Ğ²ĞµĞ´Ñ–Ñ‚ÑŒ Ğ²Ñ–Ğ´'Ñ”Ğ¼Ğ½Ğµ Ñ‡Ğ¸ÑĞ»Ğ¾ Ğ´Ğ»Ñ ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ½Ñ</p>
                    </div>
                    
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°</label>
                        <input 
                            v-model="adjustmentForm.reason" 
                            class="w-full border p-2 rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-100"
                            placeholder="Ğ†Ğ½Ğ²ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ·Ğ°Ñ†Ñ–Ñ, Ñ€Ğ¾Ğ·Ğ±Ğ¸Ñ‚Ğ¾..."
                        >
                    </div>

                    <div class="flex gap-2 pt-2">
                        <button @click="showAdjustmentModal = false" class="flex-1 py-2 text-gray-500 font-bold hover:bg-gray-50 rounded-xl">Ğ¡ĞºĞ°ÑÑƒĞ²Ğ°Ñ‚Ğ¸</button>
                        <button @click="saveAdjustment" class="flex-1 py-2 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 shadow-lg shadow-blue-200">Ğ—Ğ±ĞµÑ€ĞµĞ³Ñ‚Ğ¸</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>

--------------------------------------------------
PATH: ./.history/frontend/src/components/warehouse/tabs/ProductsTab_20260125121120.vue
--------------------------------------------------
<script setup>
import { ref, onMounted } from 'vue'
import { useWarehouse } from '@/composables/useWarehouse'
import { useProducts } from '@/composables/useProducts'

const { categories, recipes, ingredients, consumables } = useWarehouse()

const { 
    newProduct, isEditing, 
    variantBuilder, tempProductConsumable, tempVariantConsumable, tempVariantIngredient,
    resetForm, prepareEdit, saveProduct, deleteProduct, fetchProducts, filteredProducts, productSearch,
    
    // ĞĞ¾Ğ²Ñ– Ñ„ÑƒĞ½ĞºÑ†Ñ–Ñ— Ğ´Ğ»Ñ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñ–Ğ²
    saveVariant, editVariant, cancelVariantEdit, editingVariantIndex, removeVariant, 
    
    addProductConsumable, removeProductConsumable,
    addVariantConsumable, removeVariantConsumable,
    addIngredientToVariant, removeIngredientFromVariant
} = useProducts()

const showForm = ref(false)

const getCategoryName = (id) => {
    if (!categories.value) return '-'
    const c = categories.value.find(x => x.id === id)
    return c ? c.name : '-'
}

const handleSave = async () => {
    const success = await saveProduct()
    if(success) {
        showForm.value = false
        await fetchProducts()
    }
}

const handleEdit = (product) => {
    prepareEdit(product)
    showForm.value = true
}

onMounted(async () => {
    await fetchProducts()
})
</script>

<template>
    <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
        
        <div v-if="showForm" class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 h-fit xl:col-span-1">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-gray-700">
                    {{ isEditing ? 'âœï¸ Ğ ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ' : 'ğŸ“¦ ĞĞ¾Ğ²Ğ¸Ğ¹ Ñ‚Ğ¾Ğ²Ğ°Ñ€' }}
                </h3>
                <button @click="showForm = false; resetForm()" class="text-xs text-red-500 hover:underline">Ğ—Ğ°ĞºÑ€Ğ¸Ñ‚Ğ¸</button>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞĞ°Ğ·Ğ²Ğ°</label>
                    <input v-model="newProduct.name" class="border p-2 rounded w-full focus:ring-2 ring-blue-100 outline-none">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ</label>
                        <select v-model="newProduct.category_id" class="border p-2 rounded w-full bg-white">
                            <option :value="null">-- Ğ‘ĞµĞ· ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ— --</option>
                            <option v-for="c in categories" :key="c.id" :value="c.id">{{ c.name }}</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ğ¦Ñ–Ğ½Ğ° (Ğ±Ğ°Ğ·Ğ¾Ğ²Ğ°)</label>
                        <input v-model.number="newProduct.price" type="number" class="border p-2 rounded w-full">
                    </div>
                </div>

                <div class="flex items-center gap-2 py-2">
                    <input type="checkbox" v-model="newProduct.has_variants" id="hasVar" class="w-4 h-4 text-blue-600">
                    <label for="hasVar" class="text-sm font-bold text-gray-700 select-none">Ğ¦ĞµĞ¹ Ñ‚Ğ¾Ğ²Ğ°Ñ€ Ğ¼Ğ°Ñ” Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸</label>
                </div>

                <div v-if="!newProduct.has_variants" class="bg-gray-50 p-3 rounded border border-gray-200 space-y-3">
                     <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞœĞ°Ğ¹ÑÑ‚ĞµÑ€-Ñ€ĞµÑ†ĞµĞ¿Ñ‚</label>
                        <select v-model="newProduct.master_recipe_id" class="border p-2 rounded w-full bg-white text-sm">
                            <option :value="null">-- Ğ‘ĞµĞ· Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ñƒ --</option>
                            <option v-for="r in recipes" :key="r.id" :value="r.id">{{ r.name }}</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ğ’Ğ¸Ñ…Ñ–Ğ´Ğ½Ğ° Ğ²Ğ°Ğ³Ğ° (Ğ³/Ğ¼Ğ»)</label>
                        <input v-model.number="newProduct.output_weight" type="number" class="border p-2 rounded w-full text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞŸĞ¾Ñ‡Ğ°Ñ‚ĞºĞ¾Ğ²Ğ¸Ğ¹ Ğ·Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº</label>
                        <input v-model.number="newProduct.stock_quantity" type="number" class="border p-2 rounded w-full text-sm" placeholder="0">
                    </div>
                </div>

                <div class="bg-teal-50/50 p-3 rounded border border-teal-100">
                    <label class="text-[10px] uppercase font-bold text-teal-600 mb-2 block">Ğ—Ğ°Ğ³Ğ°Ğ»ÑŒĞ½Ñ– Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸</label>
                    <div class="flex gap-2 mb-2">
                        <select v-model="tempProductConsumable.consumable_id" class="flex-1 border p-1 rounded text-sm bg-white">
                            <option value="">ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»...</option>
                            <option v-for="c in consumables" :key="c.id" :value="c.id">{{ c.name }}</option>
                        </select>
                        <button @click="addProductConsumable" class="bg-teal-500 text-white w-8 rounded">+</button>
                    </div>
                    <div class="flex flex-wrap gap-1">
                        <span v-for="(pc, idx) in newProduct.consumables" :key="idx" class="bg-white border border-teal-200 text-teal-700 text-xs px-2 py-1 rounded flex items-center gap-1">
                            {{ pc.name }} <button @click="removeProductConsumable(idx)" class="text-red-500 font-bold ml-1">&times;</button>
                        </span>
                    </div>
                </div>

                <div v-if="newProduct.has_variants" class="space-y-3">
                    <div class="border-t pt-2 mt-2">
                        <div class="flex justify-between items-center mb-2">
                             <h4 class="font-bold text-sm text-purple-700">
                                 {{ editingVariantIndex !== null ? 'âœï¸ Ğ ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ' : 'ĞšĞ¾Ğ½ÑÑ‚Ñ€ÑƒĞºÑ‚Ğ¾Ñ€ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñ–Ğ²' }}
                             </h4>
                             <button v-if="editingVariantIndex !== null" @click="cancelVariantEdit" class="text-xs text-gray-500 underline">Ğ¡ĞºĞ°ÑÑƒĞ²Ğ°Ñ‚Ğ¸</button>
                        </div>
                        
                        <div class="bg-purple-50 p-3 rounded-lg border border-purple-100 space-y-3" :class="{'ring-2 ring-purple-300': editingVariantIndex !== null}">
                            
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="text-[10px] uppercase font-bold text-gray-500">ĞĞ°Ğ·Ğ²Ğ°</label>
                                    <input v-model="variantBuilder.name" placeholder="Ğ½Ğ°Ğ¿Ñ€. XL" class="w-full border p-1.5 rounded text-sm">
                                </div>
                                <div>
                                    <label class="text-[10px] uppercase font-bold text-gray-500">Ğ¦Ñ–Ğ½Ğ°</label>
                                    <input v-model.number="variantBuilder.price" type="number" class="w-full border p-1.5 rounded text-sm">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="text-[10px] uppercase font-bold text-gray-500">Ğ¢ĞµÑ…. ĞºĞ°Ñ€Ñ‚Ğ°</label>
                                    <select v-model="variantBuilder.master_recipe_id" class="w-full border p-1.5 rounded text-sm bg-white">
                                        <option :value="null">-- Ğ‘ĞµĞ· Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ñƒ --</option>
                                        <option v-for="r in recipes" :key="r.id" :value="r.id">{{ r.name }}</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-[10px] uppercase font-bold text-gray-500">Ğ’Ğ°Ğ³Ğ° Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¾Ğ³Ğ¾ (Ğ³/Ğ¼Ğ»)</label>
                                    <input v-model.number="variantBuilder.output_weight" type="number" class="w-full border p-1.5 rounded text-sm">
                                </div>
                            </div>
                            
                            <div>
                                <label class="text-[10px] uppercase font-bold text-gray-500">ĞŸĞ¾Ñ‡Ğ°Ñ‚ĞºĞ¾Ğ²Ğ¸Ğ¹ Ğ·Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº (ÑˆÑ‚)</label>
                                <input v-model.number="variantBuilder.stock_quantity" type="number" class="w-full border p-1.5 rounded text-sm bg-white" placeholder="0">
                            </div>

                            <div class="bg-white/50 p-2 rounded border border-dashed border-purple-200">
                                <label class="text-[10px] uppercase font-bold text-purple-400">ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ</label>
                                <div class="flex gap-1 mb-1">
                                    <select v-model="tempVariantConsumable.consumable_id" class="flex-1 border p-1 rounded text-[10px] bg-white h-7">
                                        <option value="">ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»...</option>
                                        <option v-for="c in consumables" :key="c.id" :value="c.id">{{ c.name }}</option>
                                    </select>
                                    <input v-model.number="tempVariantConsumable.quantity" type="number" class="w-10 border p-1 rounded text-[10px] h-7" placeholder="Ğš-ÑÑ‚ÑŒ">
                                    <button @click="addVariantConsumable" class="bg-purple-500 text-white w-7 h-7 rounded hover:bg-purple-600 text-xs">+</button>
                                </div>
                                <div class="flex flex-wrap gap-1">
                                    <span v-for="(vc, idx) in variantBuilder.consumables" :key="idx" class="bg-white border text-[10px] px-1 rounded flex items-center gap-1">
                                        {{ vc.name }}: {{ vc.quantity }} <button @click="removeVariantConsumable(idx)" class="text-red-500 font-bold">&times;</button>
                                    </span>
                                </div>
                            </div>

                            <div class="bg-blue-50/50 p-2 rounded border border-dashed border-blue-200">
                                <label class="text-[10px] uppercase font-bold text-blue-500">Ğ”Ğ¾Ğ´Ğ°Ñ‚ĞºĞ¾Ğ²Ñ– Ñ–Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ğ¸</label>
                                <div class="flex gap-1 mb-1">
                                    <select v-model="tempVariantIngredient.ingredient_id" class="flex-1 border p-1 rounded text-[10px] bg-white h-7">
                                        <option value="">Ğ†Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚...</option>
                                        <option v-for="i in ingredients" :key="i.id" :value="i.id">{{ i.name }}</option>
                                    </select>
                                    <input v-model.number="tempVariantIngredient.quantity" type="number" class="w-10 border p-1 rounded text-[10px] h-7" placeholder="Ğ“Ñ€Ğ°Ğ¼">
                                    <button @click="addIngredientToVariant" class="bg-blue-500 text-white w-7 h-7 rounded hover:bg-blue-600 text-xs">+</button>
                                </div>
                                <div class="flex flex-wrap gap-1">
                                    <span v-for="(vi, idx) in variantBuilder.ingredients" :key="idx" class="bg-white border text-[10px] px-1 rounded flex items-center gap-1 text-blue-700">
                                        {{ vi.name }}: {{ vi.quantity }} <button @click="removeIngredientFromVariant(idx)" class="text-red-500 font-bold">&times;</button>
                                    </span>
                                </div>
                            </div>

                            <button @click="saveVariant" class="w-full text-xs font-bold py-2 rounded transition-colors"
                                :class="editingVariantIndex !== null ? 'bg-orange-400 text-white hover:bg-orange-500' : 'bg-purple-200 text-purple-800 hover:bg-purple-300'">
                                {{ editingVariantIndex !== null ? 'Ğ—Ğ±ĞµÑ€ĞµĞ³Ñ‚Ğ¸ Ğ·Ğ¼Ñ–Ğ½Ğ¸ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ' : 'Ğ”Ğ¾Ğ´Ğ°Ñ‚Ğ¸ Ñ†ĞµĞ¹ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚ Ñƒ ÑĞ¿Ğ¸ÑĞ¾Ğº' }}
                            </button>
                        </div>
                    </div>
                    
                    <div v-if="newProduct.variants.length > 0" class="space-y-2">
                        <div v-for="(v, idx) in newProduct.variants" :key="idx" 
                             class="bg-white border p-2 rounded flex justify-between items-center text-sm"
                             :class="{'border-purple-400 bg-purple-50': editingVariantIndex === idx}"
                        >
                            <div>
                                <span class="font-bold">{{ v.name }}</span> - {{ v.price }} Ğ³Ñ€Ğ½
                                <div class="text-xs text-gray-400">
                                    <span v-if="v.master_recipe_id" class="text-purple-600 mr-2">ğŸ“œ Ğ ĞµÑ†ĞµĞ¿Ñ‚ ID: {{ v.master_recipe_id }}</span>
                                    <span v-if="v.stock_quantity > 0" class="text-green-600 font-bold">Ğ—Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº: {{ v.stock_quantity }}</span>
                                    <span v-if="v.ingredients?.length" class="text-blue-500 ml-2">Ğ†Ğ½Ğ³Ñ€: {{ v.ingredients.length }}</span>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button @click="editVariant(idx)" class="text-blue-500 hover:text-blue-700" title="Ğ ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ñ‚Ğ¸"><i class="fas fa-pen"></i></button>
                                <button @click="removeVariant(idx)" class="text-red-500 hover:text-red-700" title="Ğ’Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğ¸"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    </div>
                </div>

                <button @click="handleSave" class="w-full bg-green-600 text-white font-bold py-3 rounded-xl hover:bg-green-700 mt-4 shadow-lg shadow-green-100">
                    {{ isEditing ? 'Ğ—Ğ±ĞµÑ€ĞµĞ³Ñ‚Ğ¸ Ğ·Ğ¼Ñ–Ğ½Ğ¸' : 'Ğ¡Ñ‚Ğ²Ğ¾Ñ€Ğ¸Ñ‚Ğ¸ Ñ‚Ğ¾Ğ²Ğ°Ñ€' }}
                </button>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden flex flex-col h-full" :class="showForm ? 'xl:col-span-2' : 'xl:col-span-3'">
            
            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
                <div class="flex items-center gap-4">
                    <h2 class="font-bold text-gray-700">Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ–Ğ²</h2>
                    <input v-model="productSearch" placeholder="ĞŸĞ¾ÑˆÑƒĞº..." class="border rounded px-2 py-1 text-sm bg-white">
                </div>
                <button v-if="!showForm" @click="showForm = true; resetForm()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-bold text-sm shadow-md shadow-blue-100">
                    + ĞĞ¾Ğ²Ğ¸Ğ¹ Ñ‚Ğ¾Ğ²Ğ°Ñ€
                </button>
            </div>

            <div class="overflow-auto flex-1">
                <table class="w-full text-left text-sm">
                    <thead class="bg-gray-50 text-gray-500 uppercase text-xs sticky top-0">
                        <tr>
                            <th class="p-4">ĞĞ°Ğ·Ğ²Ğ°</th>
                            <th class="p-4">ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ</th>
                            <th class="p-4">Ğ¦Ñ–Ğ½Ğ° / Ğ’Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸</th>
                            <th class="p-4 text-center">Ğ”Ñ–Ñ—</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        <tr v-if="filteredProducts.length === 0">
                            <td colspan="4" class="p-8 text-center text-gray-400">
                                Ğ¢Ğ¾Ğ²Ğ°Ñ€Ñ–Ğ² Ğ½ĞµĞ¼Ğ°Ñ” Ğ°Ğ±Ğ¾ Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ...
                            </td>
                        </tr>
                        <tr v-for="p in filteredProducts" :key="p.id" class="hover:bg-gray-50 align-top group">
                            <td class="p-4 font-bold text-gray-800">{{ p.name }}</td>
                            <td class="p-4 text-gray-600">
                                <span class="bg-gray-100 px-2 py-1 rounded text-xs">{{ getCategoryName(p.category_id) }}</span>
                            </td>
                            <td class="p-4">
                                <div v-if="!p.has_variants" class="font-mono font-bold text-green-600">{{ p.price }} â‚´</div>
                                <div v-else class="space-y-1">
                                    <div v-for="v in p.variants" :key="v.id" class="text-xs bg-gray-50 p-1 rounded border border-gray-200">
                                        <b>{{ v.name }}</b>: {{ v.price }} â‚´
                                        <span v-if="v.ingredients?.length" class="text-blue-600 ml-1">
                                            (Ğ†Ğ½Ğ³Ñ€: {{ v.ingredients.length }})
                                        </span>
                                    </div>
                                </div>
                            </td>
                            <td class="p-4 text-center">
                                <div class="flex justify-center gap-2">
                                    <button @click="handleEdit(p)" class="text-blue-500 hover:text-blue-700 p-1.5 hover:bg-blue-50 rounded"><i class="fas fa-pen"></i></button>
                                    <button @click="deleteProduct(p.id)" class="text-red-400 hover:text-red-600 p-1.5 hover:bg-red-50 rounded"><i class="fas fa-trash"></i></button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</template>

--------------------------------------------------
PATH: ./.history/frontend/src/components/warehouse/modals/HistoryModal_20260125094534.vue
--------------------------------------------------
<script setup>
import { ref, watch } from 'vue'

const props = defineProps({
  isOpen: Boolean,
  item: Object // { id, type, name }
})

const emit = defineEmits(['close'])
const history = ref([])
const loading = ref(false)

const formatDate = (dateStr) => {
  return new Date(dateStr).toLocaleString('uk-UA', { 
    day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' 
  })
}

const fetchHistory = async () => {
  if (!props.item) return
  loading.value = true
  try {
    // Ğ’Ğ˜ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞĞ¯:
    // 1. Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ Ğ¿Ğ¾Ğ²Ğ½Ğ¸Ğ¹ URL (localhost:8001)
    // 2. Ğ”Ğ¾Ğ´Ğ°Ñ”Ğ¼Ğ¾ Ğ¿Ñ€ĞµÑ„Ñ–ĞºÑ /inventory/, Ğ±Ğ¾ inventory.py Ğ·Ğ°Ğ·Ğ²Ğ¸Ñ‡Ğ°Ğ¹ Ğ¿Ñ–Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğ¹ Ñ‚Ğ°Ğ¼
    const url = `http://localhost:8001/inventory/history/?entity_type=${props.item.type}&entity_id=${props.item.id}`
    
    
    console.log("Fetching history from:", url) // Ğ›Ğ¾Ğ³ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ¸

    const res = await fetch(url)
    if (res.ok) {
        history.value = await res.json()
    } else {
        console.error("History fetch failed:", res.status)
    }
  } catch (e) { console.error(e) } 
  finally { loading.value = false }
}

watch(() => props.isOpen, (val) => {
  if (val) {
    history.value = []
    fetchHistory()
  }
})
</script>

<template>
  <div v-if="isOpen" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[80vh] animate-fade-in-up">
      
      <div class="p-4 border-b flex justify-between items-center bg-gray-50">
        <div>
           <div class="text-xs uppercase font-bold text-gray-400">Ğ†ÑÑ‚Ğ¾Ñ€Ñ–Ñ Ñ€ÑƒÑ…Ñƒ</div>
           <h3 class="font-bold text-lg text-gray-800">{{ item?.name }}</h3>
        </div>
        <button @click="emit('close')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
      </div>

      <div class="flex-1 overflow-y-auto p-0 custom-scrollbar">
         <div v-if="loading" class="p-8 text-center text-gray-400"><i class="fas fa-spinner fa-spin"></i> Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ...</div>
         <div v-else-if="history.length === 0" class="p-8 text-center text-gray-400">Ğ†ÑÑ‚Ğ¾Ñ€Ñ–Ñ Ğ¿Ğ¾Ñ€Ğ¾Ğ¶Ğ½Ñ</div>
         
         <table v-else class="w-full text-sm text-left">
           <thead class="bg-gray-100 text-gray-500 text-xs uppercase sticky top-0">
             <tr>
               <th class="p-3">Ğ”Ğ°Ñ‚Ğ°</th>
               <th class="p-3">ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°</th>
               <th class="p-3 text-right">Ğ—Ğ¼Ñ–Ğ½Ğ°</th>
               <th class="p-3 text-right">Ğ—Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº</th>
             </tr>
           </thead>
           <tbody class="divide-y divide-gray-100">
             <tr v-for="h in history" :key="h.id" class="hover:bg-gray-50">
               <td class="p-3 text-gray-500 whitespace-nowrap">{{ formatDate(h.created_at) }}</td>
               <td class="p-3">
                 <span v-if="h.reason === 'manual_correction'" class="bg-gray-200 text-gray-600 px-2 py-1 rounded text-[10px] font-bold">ĞšĞ¾Ñ€ĞµĞºÑ†Ñ–Ñ</span>
                 <span v-else-if="h.reason.includes('sale')" class="bg-green-100 text-green-700 px-2 py-1 rounded text-[10px] font-bold">ĞŸÑ€Ğ¾Ğ´Ğ°Ğ¶</span>
                 <span v-else class="text-gray-700 font-bold text-xs">{{ h.reason }}</span>
               </td>
               <td class="p-3 text-right font-mono font-bold" :class="h.change_amount > 0 ? 'text-green-600' : 'text-red-500'">
                 {{ h.change_amount > 0 ? '+' : '' }}{{ h.change_amount }}
               </td>
               <td class="p-3 text-right font-mono text-gray-600">
                 {{ h.balance_after }}
               </td>
             </tr>
           </tbody>
         </table>
      </div>

    </div>
  </div>
</template>

<style scoped>
.animate-fade-in-up { animation: fadeInUp 0.3s ease-out; }
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>

--------------------------------------------------
PATH: ./.history/frontend/src/components/warehouse/modals/HistoryModal_20260125094125.vue
--------------------------------------------------
<script setup>
import { ref, watch } from 'vue'

const props = defineProps({
  isOpen: Boolean,
  item: Object // { id, type, name }
})

const emit = defineEmits(['close'])
const history = ref([])
const loading = ref(false)

const formatDate = (dateStr) => {
  return new Date(dateStr).toLocaleString('uk-UA', { 
    day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' 
  })
}

const fetchHistory = async () => {
  if (!props.item) return
  loading.value = true
  try {
    // Ğ’Ğ˜ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞĞ¯:
    // 1. Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ Ğ¿Ğ¾Ğ²Ğ½Ğ¸Ğ¹ URL (localhost:8001)
    // 2. Ğ”Ğ¾Ğ´Ğ°Ñ”Ğ¼Ğ¾ Ğ¿Ñ€ĞµÑ„Ñ–ĞºÑ /inventory/, Ğ±Ğ¾ inventory.py Ğ·Ğ°Ğ·Ğ²Ğ¸Ñ‡Ğ°Ğ¹ Ğ¿Ñ–Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğ¹ Ñ‚Ğ°Ğ¼
    const url = `http://localhost:8001/inventory/history/?entity_type=${props.item.type}&entity_id=${props.item.id}`
    
    
    console.log("Fetching history from:", url) // Ğ›Ğ¾Ğ³ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ¸

    const res = await fetch(url)
    if (res.ok) {
        history.value = await res.json()
    } else {
        console.error("History fetch failed:", res.status)
    }
  } catch (e) { console.error(e) } 
  finally { loading.value = false }
}

watch(() => props.isOpen, (val) => {
  if (val) {
    history.value = []
    fetchHistory()
  }
})
</script>

<template>
  <div v-if="isOpen" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[80vh] animate-fade-in-up">
      
      <div class="p-4 border-b flex justify-between items-center bg-gray-50">
        <div>
           <div class="text-xs uppercase font-bold text-gray-400">Ğ†ÑÑ‚Ğ¾Ñ€Ñ–Ñ Ñ€ÑƒÑ…Ñƒ</div>
           <h3 class="font-bold text-lg text-gray-800">{{ item?.name }}</h3>
        </div>
        <button @click="emit('close')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
      </div>

      <div class="flex-1 overflow-y-auto p-0 custom-scrollbar">
         <div v-if="loading" class="p-8 text-center text-gray-400"><i class="fas fa-spinner fa-spin"></i> Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ...</div>
         <div v-else-if="history.length === 0" class="p-8 text-center text-gray-400">Ğ†ÑÑ‚Ğ¾Ñ€Ñ–Ñ Ğ¿Ğ¾Ñ€Ğ¾Ğ¶Ğ½Ñ</div>
         
         <table v-else class="w-full text-sm text-left">
           <thead class="bg-gray-100 text-gray-500 text-xs uppercase sticky top-0">
             <tr>
               <th class="p-3">Ğ”Ğ°Ñ‚Ğ°</th>
               <th class="p-3">ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°</th>
               <th class="p-3 text-right">Ğ—Ğ¼Ñ–Ğ½Ğ°</th>
               <th class="p-3 text-right">Ğ—Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº</th>
             </tr>
           </thead>
           <tbody class="divide-y divide-gray-100">
             <tr v-for="h in history" :key="h.id" class="hover:bg-gray-50">
               <td class="p-3 text-gray-500 whitespace-nowrap">{{ formatDate(h.created_at) }}</td>
               <td class="p-3">
                 <span v-if="h.reason === 'manual_correction'" class="bg-gray-200 text-gray-600 px-2 py-1 rounded text-[10px] font-bold">ĞšĞ¾Ñ€ĞµĞºÑ†Ñ–Ñ</span>
                 <span v-else-if="h.reason.includes('sale')" class="bg-green-100 text-green-700 px-2 py-1 rounded text-[10px] font-bold">ĞŸÑ€Ğ¾Ğ´Ğ°Ğ¶</span>
                 <span v-else class="text-gray-700 font-bold text-xs">{{ h.reason }}</span>
               </td>
               <td class="p-3 text-right font-mono font-bold" :class="h.change_amount > 0 ? 'text-green-600' : 'text-red-500'">
                 {{ h.change_amount > 0 ? '+' : '' }}{{ h.change_amount }}
               </td>
               <td class="p-3 text-right font-mono text-gray-600">
                 {{ h.balance_after }}
               </td>
             </tr>
           </tbody>
         </table>
      </div>

    </div>
  </div>
</template>

<style scoped>
.animate-fade-in-up { animation: fadeInUp 0.3s ease-out; }
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>

--------------------------------------------------
PATH: ./.history/frontend/src/components/warehouse/modals/HistoryModal_20260126175653.vue
--------------------------------------------------
<script setup>
import { ref, watch } from 'vue'

const props = defineProps({
  isOpen: Boolean,
  item: Object // { id, type, name }
})

const emit = defineEmits(['close'])
const history = ref([])
const loading = ref(false)

const formatDate = (dateStr) => {
  return new Date(dateStr).toLocaleString('uk-UA', { 
    day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' 
  })
}

const fetchHistory = async () => {
  if (!props.item) return
  
  loading.value = true
  history.value = [] 

  try {
    // Ğ’ĞĞ–Ğ›Ğ˜Ğ’Ğ: Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ Ğ²Ñ–Ğ´Ğ½Ğ¾ÑĞ½Ğ¸Ğ¹ ÑˆĞ»ÑÑ… /api/
    // Ğ‘Ñ€Ğ°ÑƒĞ·ĞµÑ€ ÑĞ°Ğ¼ Ğ¿Ñ–Ğ´ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¸Ğ¹ IP (100.100.84.4)
    const id = props.item.original_id || props.item.id
    const url = `/api/history/?entity_type=${props.item.type}&entity_id=${id}`
    
    console.log("HistoryModal requesting:", url) // Ğ”Ğ»Ñ Ğ½Ğ°Ğ»Ğ°Ğ³Ğ¾Ğ´Ğ¶ĞµĞ½Ğ½Ñ
    
    const res = await fetch(url)
    
    if (res.ok) {
        history.value = await res.json()
    } else {
        console.error("Server error:", res.status)
    }
  } catch (e) {
    console.error("Network error:", e)
  } finally {
    loading.value = false
  }
}

watch(() => props.isOpen, (val) => {
  if (val) {
    history.value = []
    fetchHistory()
  }
})
</script>

<template>
  <div v-if="isOpen" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[80vh] animate-fade-in-up">
      
      <div class="p-4 border-b flex justify-between items-center bg-gray-50">
        <div>
           <div class="text-xs uppercase font-bold text-gray-400">Ğ†ÑÑ‚Ğ¾Ñ€Ñ–Ñ Ñ€ÑƒÑ…Ñƒ</div>
           <h3 class="font-bold text-lg text-gray-800">{{ item?.name }}</h3>
        </div>
        <button @click="emit('close')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
      </div>

      <div class="flex-1 overflow-y-auto p-0 custom-scrollbar">
         <div v-if="loading" class="p-8 text-center text-gray-400"><i class="fas fa-spinner fa-spin"></i> Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ...</div>
         <div v-else-if="history.length === 0" class="p-8 text-center text-gray-400">Ğ†ÑÑ‚Ğ¾Ñ€Ñ–Ñ Ğ¿Ğ¾Ñ€Ğ¾Ğ¶Ğ½Ñ</div>
         
         <table v-else class="w-full text-sm text-left">
           <thead class="bg-gray-100 text-gray-500 text-xs uppercase sticky top-0">
             <tr>
               <th class="p-3">Ğ”Ğ°Ñ‚Ğ°</th>
               <th class="p-3">ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°</th>
               <th class="p-3 text-right">Ğ—Ğ¼Ñ–Ğ½Ğ°</th>
               <th class="p-3 text-right">Ğ—Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº</th>
             </tr>
           </thead>
           <tbody class="divide-y divide-gray-100">
             <tr v-for="h in history" :key="h.id" class="hover:bg-gray-50">
               <td class="p-3 text-gray-500 whitespace-nowrap">{{ formatDate(h.created_at) }}</td>
               <td class="p-3">
                 <span v-if="h.reason === 'manual_correction'" class="bg-gray-200 text-gray-600 px-2 py-1 rounded text-[10px] font-bold">ĞšĞ¾Ñ€ĞµĞºÑ†Ñ–Ñ</span>
                 <span v-else-if="h.reason.includes('sale')" class="bg-green-100 text-green-700 px-2 py-1 rounded text-[10px] font-bold">ĞŸÑ€Ğ¾Ğ´Ğ°Ğ¶</span>
                 <span v-else class="text-gray-700 font-bold text-xs">{{ h.reason }}</span>
               </td>
               <td class="p-3 text-right font-mono font-bold" :class="h.change_amount > 0 ? 'text-green-600' : 'text-red-500'">
                 {{ h.change_amount > 0 ? '+' : '' }}{{ h.change_amount }}
               </td>
               <td class="p-3 text-right font-mono text-gray-600">
                 {{ h.balance_after }}
               </td>
             </tr>
           </tbody>
         </table>
      </div>

    </div>
  </div>
</template>

<style scoped>
.animate-fade-in-up { animation: fadeInUp 0.3s ease-out; }
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>

--------------------------------------------------
PATH: ./.history/frontend/src/components/warehouse/modals/HistoryModal_20260126154533.vue
--------------------------------------------------
<script setup>
import { ref, watch } from 'vue'

const props = defineProps({
  isOpen: Boolean,
  item: Object // { id, type, name }
})

const emit = defineEmits(['close'])
const history = ref([])
const loading = ref(false)

const formatDate = (dateStr) => {
  return new Date(dateStr).toLocaleString('uk-UA', { 
    day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' 
  })
}

const fetchHistory = async () => {
  if (!props.item) return
  loading.value = true
  try {
    // Ğ’Ğ˜ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞĞ¯:
    // 1. Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ Ğ¿Ğ¾Ğ²Ğ½Ğ¸Ğ¹ URL (localhost:8001)
    // 2. Ğ”Ğ¾Ğ´Ğ°Ñ”Ğ¼Ğ¾ Ğ¿Ñ€ĞµÑ„Ñ–ĞºÑ /inventory/, Ğ±Ğ¾ inventory.py Ğ·Ğ°Ğ·Ğ²Ğ¸Ñ‡Ğ°Ğ¹ Ğ¿Ñ–Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğ¹ Ñ‚Ğ°Ğ¼
    const url = `http://localhost:8001/inventory/history/?entity_type=${props.item.type}&entity_id=${props.item.id}`
    
    
    console.log("Fetching history from:", url) // Ğ›Ğ¾Ğ³ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ¸

    const res = await fetch(url)
    if (res.ok) {
        history.value = await res.json()
    } else {
        console.error("History fetch failed:", res.status)
    }
  } catch (e) { console.error(e) } 
  finally { loading.value = false }
}

watch(() => props.isOpen, (val) => {
  if (val) {
    history.value = []
    fetchHistory()
  }
})
</script>

<template>
  <div v-if="isOpen" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[80vh] animate-fade-in-up">
      
      <div class="p-4 border-b flex justify-between items-center bg-gray-50">
        <div>
           <div class="text-xs uppercase font-bold text-gray-400">Ğ†ÑÑ‚Ğ¾Ñ€Ñ–Ñ Ñ€ÑƒÑ…Ñƒ</div>
           <h3 class="font-bold text-lg text-gray-800">{{ item?.name }}</h3>
        </div>
        <button @click="emit('close')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
      </div>

      <div class="flex-1 overflow-y-auto p-0 custom-scrollbar">
         <div v-if="loading" class="p-8 text-center text-gray-400"><i class="fas fa-spinner fa-spin"></i> Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ...</div>
         <div v-else-if="history.length === 0" class="p-8 text-center text-gray-400">Ğ†ÑÑ‚Ğ¾Ñ€Ñ–Ñ Ğ¿Ğ¾Ñ€Ğ¾Ğ¶Ğ½Ñ</div>
         
         <table v-else class="w-full text-sm text-left">
           <thead class="bg-gray-100 text-gray-500 text-xs uppercase sticky top-0">
             <tr>
               <th class="p-3">Ğ”Ğ°Ñ‚Ğ°</th>
               <th class="p-3">ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°</th>
               <th class="p-3 text-right">Ğ—Ğ¼Ñ–Ğ½Ğ°</th>
               <th class="p-3 text-right">Ğ—Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº</th>
             </tr>
           </thead>
           <tbody class="divide-y divide-gray-100">
             <tr v-for="h in history" :key="h.id" class="hover:bg-gray-50">
               <td class="p-3 text-gray-500 whitespace-nowrap">{{ formatDate(h.created_at) }}</td>
               <td class="p-3">
                 <span v-if="h.reason === 'manual_correction'" class="bg-gray-200 text-gray-600 px-2 py-1 rounded text-[10px] font-bold">ĞšĞ¾Ñ€ĞµĞºÑ†Ñ–Ñ</span>
                 <span v-else-if="h.reason.includes('sale')" class="bg-green-100 text-green-700 px-2 py-1 rounded text-[10px] font-bold">ĞŸÑ€Ğ¾Ğ´Ğ°Ğ¶</span>
                 <span v-else class="text-gray-700 font-bold text-xs">{{ h.reason }}</span>
               </td>
               <td class="p-3 text-right font-mono font-bold" :class="h.change_amount > 0 ? 'text-green-600' : 'text-red-500'">
                 {{ h.change_amount > 0 ? '+' : '' }}{{ h.change_amount }}
               </td>
               <td class="p-3 text-right font-mono text-gray-600">
                 {{ h.balance_after }}
               </td>
             </tr>
           </tbody>
         </table>
      </div>

    </div>
  </div>
</template>

<style scoped>
.animate-fade-in-up { animation: fadeInUp 0.3s ease-out; }
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>

--------------------------------------------------
PATH: ./.history/frontend/src/components/warehouse/modals/HistoryModal_20260125093943.vue
--------------------------------------------------
<script setup>
import { ref, watch } from 'vue'

const props = defineProps({
  isOpen: Boolean,
  item: Object // { id, type, name }
})

const emit = defineEmits(['close'])
const history = ref([])
const loading = ref(false)

const formatDate = (dateStr) => {
  return new Date(dateStr).toLocaleString('uk-UA', { 
    day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' 
  })
}

const fetchHistory = async () => {
  if (!props.item) return
  loading.value = true
  try {
    // Ğ’Ğ˜ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞĞ¯:
    // 1. Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ Ğ¿Ğ¾Ğ²Ğ½Ğ¸Ğ¹ URL (localhost:8001)
    // 2. Ğ”Ğ¾Ğ´Ğ°Ñ”Ğ¼Ğ¾ Ğ¿Ñ€ĞµÑ„Ñ–ĞºÑ /inventory/, Ğ±Ğ¾ inventory.py Ğ·Ğ°Ğ·Ğ²Ğ¸Ñ‡Ğ°Ğ¹ Ğ¿Ñ–Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğ¹ Ñ‚Ğ°Ğ¼
    //const url = `http://localhost:8001/inventory/history/?entity_type=${props.item.type}&entity_id=${props.item.id}`
    // Ğ”ĞĞ”ĞĞĞ /inventory/ Ñƒ ÑˆĞ»ÑÑ…
    const url = `/api/inventory/history/?entity_type=${props.item.type}&entity_id=${props.item.id}`

    console.log("Fetching history from:", url) // Ğ›Ğ¾Ğ³ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ¸

    const res = await fetch(url)
    if (res.ok) {
        history.value = await res.json()
    } else {
        console.error("History fetch failed:", res.status)
    }
  } catch (e) { console.error(e) } 
  finally { loading.value = false }
}

watch(() => props.isOpen, (val) => {
  if (val) {
    history.value = []
    fetchHistory()
  }
})
</script>

<template>
  <div v-if="isOpen" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[80vh] animate-fade-in-up">
      
      <div class="p-4 border-b flex justify-between items-center bg-gray-50">
        <div>
           <div class="text-xs uppercase font-bold text-gray-400">Ğ†ÑÑ‚Ğ¾Ñ€Ñ–Ñ Ñ€ÑƒÑ…Ñƒ</div>
           <h3 class="font-bold text-lg text-gray-800">{{ item?.name }}</h3>
        </div>
        <button @click="emit('close')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
      </div>

      <div class="flex-1 overflow-y-auto p-0 custom-scrollbar">
         <div v-if="loading" class="p-8 text-center text-gray-400"><i class="fas fa-spinner fa-spin"></i> Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ...</div>
         <div v-else-if="history.length === 0" class="p-8 text-center text-gray-400">Ğ†ÑÑ‚Ğ¾Ñ€Ñ–Ñ Ğ¿Ğ¾Ñ€Ğ¾Ğ¶Ğ½Ñ</div>
         
         <table v-else class="w-full text-sm text-left">
           <thead class="bg-gray-100 text-gray-500 text-xs uppercase sticky top-0">
             <tr>
               <th class="p-3">Ğ”Ğ°Ñ‚Ğ°</th>
               <th class="p-3">ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°</th>
               <th class="p-3 text-right">Ğ—Ğ¼Ñ–Ğ½Ğ°</th>
               <th class="p-3 text-right">Ğ—Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº</th>
             </tr>
           </thead>
           <tbody class="divide-y divide-gray-100">
             <tr v-for="h in history" :key="h.id" class="hover:bg-gray-50">
               <td class="p-3 text-gray-500 whitespace-nowrap">{{ formatDate(h.created_at) }}</td>
               <td class="p-3">
                 <span v-if="h.reason === 'manual_correction'" class="bg-gray-200 text-gray-600 px-2 py-1 rounded text-[10px] font-bold">ĞšĞ¾Ñ€ĞµĞºÑ†Ñ–Ñ</span>
                 <span v-else-if="h.reason.includes('sale')" class="bg-green-100 text-green-700 px-2 py-1 rounded text-[10px] font-bold">ĞŸÑ€Ğ¾Ğ´Ğ°Ğ¶</span>
                 <span v-else class="text-gray-700 font-bold text-xs">{{ h.reason }}</span>
               </td>
               <td class="p-3 text-right font-mono font-bold" :class="h.change_amount > 0 ? 'text-green-600' : 'text-red-500'">
                 {{ h.change_amount > 0 ? '+' : '' }}{{ h.change_amount }}
               </td>
               <td class="p-3 text-right font-mono text-gray-600">
                 {{ h.balance_after }}
               </td>
             </tr>
           </tbody>
         </table>
      </div>

    </div>
  </div>
</template>

<style scoped>
.animate-fade-in-up { animation: fadeInUp 0.3s ease-out; }
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>

--------------------------------------------------
PATH: ./.history/frontend/src/components/warehouse/modals/HistoryModal_20260126175545.vue
--------------------------------------------------
<script setup>
import { ref, watch } from 'vue'

const props = defineProps({
  isOpen: Boolean,
  item: Object // { id, type, name }
})

const emit = defineEmits(['close'])
const history = ref([])
const loading = ref(false)

const formatDate = (dateStr) => {
  return new Date(dateStr).toLocaleString('uk-UA', { 
    day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' 
  })
}

const fetchHistory = async () => {
  if (!props.item) return
  
  loading.value = true
  history.value = [] 

  try {
    // Ğ’ĞĞ–Ğ›Ğ˜Ğ’Ğ: Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ Ğ²Ñ–Ğ´Ğ½Ğ¾ÑĞ½Ğ¸Ğ¹ ÑˆĞ»ÑÑ… /api/
    // Ğ‘Ñ€Ğ°ÑƒĞ·ĞµÑ€ ÑĞ°Ğ¼ Ğ¿Ñ–Ğ´ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¸Ğ¹ IP (100.100.84.4)
    const id = props.item.original_id || props.item.id
    const url = `/history/?entity_type=${props.item.type}&entity_id=${id}`
    
    console.log("HistoryModal requesting:", url) // Ğ”Ğ»Ñ Ğ½Ğ°Ğ»Ğ°Ğ³Ğ¾Ğ´Ğ¶ĞµĞ½Ğ½Ñ
    
    const res = await fetch(url)
    
    if (res.ok) {
        history.value = await res.json()
    } else {
        console.error("Server error:", res.status)
    }
  } catch (e) {
    console.error("Network error:", e)
  } finally {
    loading.value = false
  }
}

watch(() => props.isOpen, (val) => {
  if (val) {
    history.value = []
    fetchHistory()
  }
})
</script>

<template>
  <div v-if="isOpen" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[80vh] animate-fade-in-up">
      
      <div class="p-4 border-b flex justify-between items-center bg-gray-50">
        <div>
           <div class="text-xs uppercase font-bold text-gray-400">Ğ†ÑÑ‚Ğ¾Ñ€Ñ–Ñ Ñ€ÑƒÑ…Ñƒ</div>
           <h3 class="font-bold text-lg text-gray-800">{{ item?.name }}</h3>
        </div>
        <button @click="emit('close')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
      </div>

      <div class="flex-1 overflow-y-auto p-0 custom-scrollbar">
         <div v-if="loading" class="p-8 text-center text-gray-400"><i class="fas fa-spinner fa-spin"></i> Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ...</div>
         <div v-else-if="history.length === 0" class="p-8 text-center text-gray-400">Ğ†ÑÑ‚Ğ¾Ñ€Ñ–Ñ Ğ¿Ğ¾Ñ€Ğ¾Ğ¶Ğ½Ñ</div>
         
         <table v-else class="w-full text-sm text-left">
           <thead class="bg-gray-100 text-gray-500 text-xs uppercase sticky top-0">
             <tr>
               <th class="p-3">Ğ”Ğ°Ñ‚Ğ°</th>
               <th class="p-3">ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°</th>
               <th class="p-3 text-right">Ğ—Ğ¼Ñ–Ğ½Ğ°</th>
               <th class="p-3 text-right">Ğ—Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº</th>
             </tr>
           </thead>
           <tbody class="divide-y divide-gray-100">
             <tr v-for="h in history" :key="h.id" class="hover:bg-gray-50">
               <td class="p-3 text-gray-500 whitespace-nowrap">{{ formatDate(h.created_at) }}</td>
               <td class="p-3">
                 <span v-if="h.reason === 'manual_correction'" class="bg-gray-200 text-gray-600 px-2 py-1 rounded text-[10px] font-bold">ĞšĞ¾Ñ€ĞµĞºÑ†Ñ–Ñ</span>
                 <span v-else-if="h.reason.includes('sale')" class="bg-green-100 text-green-700 px-2 py-1 rounded text-[10px] font-bold">ĞŸÑ€Ğ¾Ğ´Ğ°Ğ¶</span>
                 <span v-else class="text-gray-700 font-bold text-xs">{{ h.reason }}</span>
               </td>
               <td class="p-3 text-right font-mono font-bold" :class="h.change_amount > 0 ? 'text-green-600' : 'text-red-500'">
                 {{ h.change_amount > 0 ? '+' : '' }}{{ h.change_amount }}
               </td>
               <td class="p-3 text-right font-mono text-gray-600">
                 {{ h.balance_after }}
               </td>
             </tr>
           </tbody>
         </table>
      </div>

    </div>
  </div>
</template>

<style scoped>
.animate-fade-in-up { animation: fadeInUp 0.3s ease-out; }
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>

--------------------------------------------------
PATH: ./.history/frontend/src/components/warehouse/modals/HistoryModal_20260124233306.vue
--------------------------------------------------
<script setup>
import { ref, watch } from 'vue'

const props = defineProps({
  isOpen: Boolean,
  item: Object // { id, type, name }
})

const emit = defineEmits(['close'])
const history = ref([])
const loading = ref(false)

const formatDate = (dateStr) => {
  return new Date(dateStr).toLocaleString('uk-UA', { 
    day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' 
  })
}

const fetchHistory = async () => {
  if (!props.item) return
  loading.value = true
  try {
    // Ğ’Ğ˜ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞĞ¯:
    // 1. Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ Ğ¿Ğ¾Ğ²Ğ½Ğ¸Ğ¹ URL (localhost:8001)
    // 2. Ğ”Ğ¾Ğ´Ğ°Ñ”Ğ¼Ğ¾ Ğ¿Ñ€ĞµÑ„Ñ–ĞºÑ /inventory/, Ğ±Ğ¾ inventory.py Ğ·Ğ°Ğ·Ğ²Ğ¸Ñ‡Ğ°Ğ¹ Ğ¿Ñ–Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğ¹ Ñ‚Ğ°Ğ¼
    const url = `http://localhost:8001/inventory/history/?entity_type=${props.item.type}&entity_id=${props.item.id}`
    
    console.log("Fetching history from:", url) // Ğ›Ğ¾Ğ³ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ¸

    const res = await fetch(url)
    if (res.ok) {
        history.value = await res.json()
    } else {
        console.error("History fetch failed:", res.status)
    }
  } catch (e) { console.error(e) } 
  finally { loading.value = false }
}

watch(() => props.isOpen, (val) => {
  if (val) {
    history.value = []
    fetchHistory()
  }
})
</script>

<template>
  <div v-if="isOpen" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[80vh] animate-fade-in-up">
      
      <div class="p-4 border-b flex justify-between items-center bg-gray-50">
        <div>
           <div class="text-xs uppercase font-bold text-gray-400">Ğ†ÑÑ‚Ğ¾Ñ€Ñ–Ñ Ñ€ÑƒÑ…Ñƒ</div>
           <h3 class="font-bold text-lg text-gray-800">{{ item?.name }}</h3>
        </div>
        <button @click="emit('close')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
      </div>

      <div class="flex-1 overflow-y-auto p-0 custom-scrollbar">
         <div v-if="loading" class="p-8 text-center text-gray-400"><i class="fas fa-spinner fa-spin"></i> Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ...</div>
         <div v-else-if="history.length === 0" class="p-8 text-center text-gray-400">Ğ†ÑÑ‚Ğ¾Ñ€Ñ–Ñ Ğ¿Ğ¾Ñ€Ğ¾Ğ¶Ğ½Ñ</div>
         
         <table v-else class="w-full text-sm text-left">
           <thead class="bg-gray-100 text-gray-500 text-xs uppercase sticky top-0">
             <tr>
               <th class="p-3">Ğ”Ğ°Ñ‚Ğ°</th>
               <th class="p-3">ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°</th>
               <th class="p-3 text-right">Ğ—Ğ¼Ñ–Ğ½Ğ°</th>
               <th class="p-3 text-right">Ğ—Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº</th>
             </tr>
           </thead>
           <tbody class="divide-y divide-gray-100">
             <tr v-for="h in history" :key="h.id" class="hover:bg-gray-50">
               <td class="p-3 text-gray-500 whitespace-nowrap">{{ formatDate(h.created_at) }}</td>
               <td class="p-3">
                 <span v-if="h.reason === 'manual_correction'" class="bg-gray-200 text-gray-600 px-2 py-1 rounded text-[10px] font-bold">ĞšĞ¾Ñ€ĞµĞºÑ†Ñ–Ñ</span>
                 <span v-else-if="h.reason.includes('sale')" class="bg-green-100 text-green-700 px-2 py-1 rounded text-[10px] font-bold">ĞŸÑ€Ğ¾Ğ´Ğ°Ğ¶</span>
                 <span v-else class="text-gray-700 font-bold text-xs">{{ h.reason }}</span>
               </td>
               <td class="p-3 text-right font-mono font-bold" :class="h.change_amount > 0 ? 'text-green-600' : 'text-red-500'">
                 {{ h.change_amount > 0 ? '+' : '' }}{{ h.change_amount }}
               </td>
               <td class="p-3 text-right font-mono text-gray-600">
                 {{ h.balance_after }}
               </td>
             </tr>
           </tbody>
         </table>
      </div>

    </div>
  </div>
</template>

<style scoped>
.animate-fade-in-up { animation: fadeInUp 0.3s ease-out; }
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>

--------------------------------------------------
PATH: ./.history/frontend/src/components/warehouse/modals/HistoryModal_20260123213613.vue
--------------------------------------------------
<script setup>
import { ref, watch } from 'vue'

const props = defineProps({
  isOpen: Boolean,
  item: Object // { id, type, name }
})

const emit = defineEmits(['close'])
const history = ref([])
const loading = ref(false)

const formatDate = (dateStr) => {
  return new Date(dateStr).toLocaleString('uk-UA', { 
    day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' 
  })
}

const fetchHistory = async () => {
  if (!props.item) return
  loading.value = true
  try {
    const url = `/api/history/?entity_type=${props.item.type}&entity_id=${props.item.id}`
    const res = await fetch(url)
    if (res.ok) history.value = await res.json()
  } catch (e) { console.error(e) } 
  finally { loading.value = false }
}

watch(() => props.isOpen, (val) => {
  if (val) {
    history.value = []
    fetchHistory()
  }
})
</script>

<template>
  <div v-if="isOpen" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[80vh] animate-fade-in-up">
      
      <div class="p-4 border-b flex justify-between items-center bg-gray-50">
        <div>
           <div class="text-xs uppercase font-bold text-gray-400">Ğ†ÑÑ‚Ğ¾Ñ€Ñ–Ñ Ñ€ÑƒÑ…Ñƒ</div>
           <h3 class="font-bold text-lg text-gray-800">{{ item?.name }}</h3>
        </div>
        <button @click="emit('close')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
      </div>

      <div class="flex-1 overflow-y-auto p-0 custom-scrollbar">
         <div v-if="loading" class="p-8 text-center text-gray-400"><i class="fas fa-spinner fa-spin"></i> Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ...</div>
         <div v-else-if="history.length === 0" class="p-8 text-center text-gray-400">Ğ†ÑÑ‚Ğ¾Ñ€Ñ–Ñ Ğ¿Ğ¾Ñ€Ğ¾Ğ¶Ğ½Ñ</div>
         
         <table v-else class="w-full text-sm text-left">
           <thead class="bg-gray-100 text-gray-500 text-xs uppercase sticky top-0">
             <tr>
               <th class="p-3">Ğ”Ğ°Ñ‚Ğ°</th>
               <th class="p-3">ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°</th>
               <th class="p-3 text-right">Ğ—Ğ¼Ñ–Ğ½Ğ°</th>
               <th class="p-3 text-right">Ğ—Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº</th>
             </tr>
           </thead>
           <tbody class="divide-y divide-gray-100">
             <tr v-for="h in history" :key="h.id" class="hover:bg-gray-50">
               <td class="p-3 text-gray-500 whitespace-nowrap">{{ formatDate(h.created_at) }}</td>
               <td class="p-3">
                 <span v-if="h.reason === 'manual_correction'" class="bg-gray-200 text-gray-600 px-2 py-1 rounded text-[10px] font-bold">ĞšĞ¾Ñ€ĞµĞºÑ†Ñ–Ñ</span>
                 <span v-else-if="h.reason.includes('sale')" class="bg-green-100 text-green-700 px-2 py-1 rounded text-[10px] font-bold">ĞŸÑ€Ğ¾Ğ´Ğ°Ğ¶</span>
                 <span v-else class="text-gray-700 font-bold text-xs">{{ h.reason }}</span>
               </td>
               <td class="p-3 text-right font-mono font-bold" :class="h.change_amount > 0 ? 'text-green-600' : 'text-red-500'">
                 {{ h.change_amount > 0 ? '+' : '' }}{{ h.change_amount }}
               </td>
               <td class="p-3 text-right font-mono text-gray-600">
                 {{ h.balance_after }}
               </td>
             </tr>
           </tbody>
         </table>
      </div>

    </div>
  </div>
</template>

<style scoped>
.animate-fade-in-up { animation: fadeInUp 0.3s ease-out; }
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>

--------------------------------------------------
PATH: ./.history/frontend/src/components/warehouse/modals/HistoryModal_20260126155353.vue
--------------------------------------------------
<script setup>
import { ref, watch } from 'vue'

const props = defineProps({
  isOpen: Boolean,
  item: Object // { id, type, name }
})

const emit = defineEmits(['close'])
const history = ref([])
const loading = ref(false)

const formatDate = (dateStr) => {
  return new Date(dateStr).toLocaleString('uk-UA', { 
    day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' 
  })
}

const fetchHistory = async () => {
  if (!props.item) return
  loading.value = true
  try {
    // Ğ’Ğ˜ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞĞ¯:
    // 1. Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ Ğ¿Ğ¾Ğ²Ğ½Ğ¸Ğ¹ URL (localhost:8001)
    // 2. Ğ”Ğ¾Ğ´Ğ°Ñ”Ğ¼Ğ¾ Ğ¿Ñ€ĞµÑ„Ñ–ĞºÑ /inventory/, Ğ±Ğ¾ inventory.py Ğ·Ğ°Ğ·Ğ²Ğ¸Ñ‡Ğ°Ğ¹ Ğ¿Ñ–Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğ¹ Ñ‚Ğ°Ğ¼
    const url = `http://localhost:8001/inventory/history/?entity_type=${props.item.type}&entity_id=${props.item.id}`
    
    
    console.log("Fetching history from:", url) // Ğ›Ğ¾Ğ³ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ¸

    const res = await fetch(url)
    if (res.ok) {
        history.value = await res.json()
    } else {
        console.error("History fetch failed:", res.status)
    }
  } catch (e) { console.error(e) } 
  finally { loading.value = false }
}

watch(() => props.isOpen, (val) => {
  if (val) {
    history.value = []
    fetchHistory()
  }
})
</script>

<template>
  <div v-if="isOpen" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[80vh] animate-fade-in-up">
      
      <div class="p-4 border-b flex justify-between items-center bg-gray-50">
        <div>
           <div class="text-xs uppercase font-bold text-gray-400">Ğ†ÑÑ‚Ğ¾Ñ€Ñ–Ñ Ñ€ÑƒÑ…Ñƒ</div>
           <h3 class="font-bold text-lg text-gray-800">{{ item?.name }}</h3>
        </div>
        <button @click="emit('close')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
      </div>

      <div class="flex-1 overflow-y-auto p-0 custom-scrollbar">
         <div v-if="loading" class="p-8 text-center text-gray-400"><i class="fas fa-spinner fa-spin"></i> Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ...</div>
         <div v-else-if="history.length === 0" class="p-8 text-center text-gray-400">Ğ†ÑÑ‚Ğ¾Ñ€Ñ–Ñ Ğ¿Ğ¾Ñ€Ğ¾Ğ¶Ğ½Ñ</div>
         
         <table v-else class="w-full text-sm text-left">
           <thead class="bg-gray-100 text-gray-500 text-xs uppercase sticky top-0">
             <tr>
               <th class="p-3">Ğ”Ğ°Ñ‚Ğ°</th>
               <th class="p-3">ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°</th>
               <th class="p-3 text-right">Ğ—Ğ¼Ñ–Ğ½Ğ°</th>
               <th class="p-3 text-right">Ğ—Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº</th>
             </tr>
           </thead>
           <tbody class="divide-y divide-gray-100">
             <tr v-for="h in history" :key="h.id" class="hover:bg-gray-50">
               <td class="p-3 text-gray-500 whitespace-nowrap">{{ formatDate(h.created_at) }}</td>
               <td class="p-3">
                 <span v-if="h.reason === 'manual_correction'" class="bg-gray-200 text-gray-600 px-2 py-1 rounded text-[10px] font-bold">ĞšĞ¾Ñ€ĞµĞºÑ†Ñ–Ñ</span>
                 <span v-else-if="h.reason.includes('sale')" class="bg-green-100 text-green-700 px-2 py-1 rounded text-[10px] font-bold">ĞŸÑ€Ğ¾Ğ´Ğ°Ğ¶</span>
                 <span v-else class="text-gray-700 font-bold text-xs">{{ h.reason }}</span>
               </td>
               <td class="p-3 text-right font-mono font-bold" :class="h.change_amount > 0 ? 'text-green-600' : 'text-red-500'">
                 {{ h.change_amount > 0 ? '+' : '' }}{{ h.change_amount }}
               </td>
               <td class="p-3 text-right font-mono text-gray-600">
                 {{ h.balance_after }}
               </td>
             </tr>
           </tbody>
         </table>
      </div>

    </div>
  </div>
</template>

<style scoped>
.animate-fade-in-up { animation: fadeInUp 0.3s ease-out; }
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>

--------------------------------------------------
PATH: ./.history/frontend/src/components/warehouse/modals/HistoryModal_20260126181946.vue
--------------------------------------------------
<script setup>
import { ref, watch } from 'vue'

const props = defineProps({
  isOpen: Boolean,
  item: Object // { id, type, name }
})

const emit = defineEmits(['close'])
const history = ref([])
const loading = ref(false)

const formatDate = (dateStr) => {
  return new Date(dateStr).toLocaleString('uk-UA', { 
    day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' 
  })
}

const fetchHistory = async () => {
  if (!props.item) return
  
  loading.value = true
  history.value = [] 

  try {
    // Ğ’ĞĞ–Ğ›Ğ˜Ğ’Ğ: Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ Ğ²Ñ–Ğ´Ğ½Ğ¾ÑĞ½Ğ¸Ğ¹ ÑˆĞ»ÑÑ… /api/
    // Ğ‘Ñ€Ğ°ÑƒĞ·ĞµÑ€ ÑĞ°Ğ¼ Ğ¿Ñ–Ğ´ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¸Ğ¹ IP (100.100.84.4)
    const id = props.item.original_id || props.item.id
    const url = `/api/history/?entity_type=${props.item.type}&entity_id=${props.item.id || props.item.original_id}`
    
    console.log("HistoryModal requesting:", url) // Ğ”Ğ»Ñ Ğ½Ğ°Ğ»Ğ°Ğ³Ğ¾Ğ´Ğ¶ĞµĞ½Ğ½Ñ
    
    const res = await fetch(url)
    
    if (res.ok) {
        history.value = await res.json()
    } else {
        console.error("Server error:", res.status)
    }
  } catch (e) {
    console.error("Network error:", e)
  } finally {
    loading.value = false
  }
}

watch(() => props.isOpen, (val) => {
  if (val) {
    history.value = []
    fetchHistory()
  }
})
</script>

<template>
  <div v-if="isOpen" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[80vh] animate-fade-in-up">
      
      <div class="p-4 border-b flex justify-between items-center bg-gray-50">
        <div>
           <div class="text-xs uppercase font-bold text-gray-400">Ğ†ÑÑ‚Ğ¾Ñ€Ñ–Ñ Ñ€ÑƒÑ…Ñƒ</div>
           <h3 class="font-bold text-lg text-gray-800">{{ item?.name }}</h3>
        </div>
        <button @click="emit('close')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
      </div>

      <div class="flex-1 overflow-y-auto p-0 custom-scrollbar">
         <div v-if="loading" class="p-8 text-center text-gray-400"><i class="fas fa-spinner fa-spin"></i> Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ...</div>
         <div v-else-if="history.length === 0" class="p-8 text-center text-gray-400">Ğ†ÑÑ‚Ğ¾Ñ€Ñ–Ñ Ğ¿Ğ¾Ñ€Ğ¾Ğ¶Ğ½Ñ</div>
         
         <table v-else class="w-full text-sm text-left">
           <thead class="bg-gray-100 text-gray-500 text-xs uppercase sticky top-0">
             <tr>
               <th class="p-3">Ğ”Ğ°Ñ‚Ğ°</th>
               <th class="p-3">ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°</th>
               <th class="p-3 text-right">Ğ—Ğ¼Ñ–Ğ½Ğ°</th>
               <th class="p-3 text-right">Ğ—Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº</th>
             </tr>
           </thead>
           <tbody class="divide-y divide-gray-100">
             <tr v-for="h in history" :key="h.id" class="hover:bg-gray-50">
               <td class="p-3 text-gray-500 whitespace-nowrap">{{ formatDate(h.created_at) }}</td>
               <td class="p-3">
                 <span v-if="h.reason === 'manual_correction'" class="bg-gray-200 text-gray-600 px-2 py-1 rounded text-[10px] font-bold">ĞšĞ¾Ñ€ĞµĞºÑ†Ñ–Ñ</span>
                 <span v-else-if="h.reason.includes('sale')" class="bg-green-100 text-green-700 px-2 py-1 rounded text-[10px] font-bold">ĞŸÑ€Ğ¾Ğ´Ğ°Ğ¶</span>
                 <span v-else class="text-gray-700 font-bold text-xs">{{ h.reason }}</span>
               </td>
               <td class="p-3 text-right font-mono font-bold" :class="h.change_amount > 0 ? 'text-green-600' : 'text-red-500'">
                 {{ h.change_amount > 0 ? '+' : '' }}{{ h.change_amount }}
               </td>
               <td class="p-3 text-right font-mono text-gray-600">
                 {{ h.balance_after }}
               </td>
             </tr>
           </tbody>
         </table>
      </div>

    </div>
  </div>
</template>

<style scoped>
.animate-fade-in-up { animation: fadeInUp 0.3s ease-out; }
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>

--------------------------------------------------
PATH: ./.history/frontend/src/components/warehouse/modals/HistoryModal_20260125102650.vue
--------------------------------------------------
<script setup>
import { ref, watch } from 'vue'

const props = defineProps({
  isOpen: Boolean,
  item: Object // { id, type, name }
})

const emit = defineEmits(['close'])
const history = ref([])
const loading = ref(false)

const formatDate = (dateStr) => {
  return new Date(dateStr).toLocaleString('uk-UA', { 
    day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' 
  })
}

const fetchHistory = async () => {
  if (!props.item) return
  loading.value = true
  try {
    // Ğ’Ğ˜ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞĞ¯:
    // 1. Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ Ğ¿Ğ¾Ğ²Ğ½Ğ¸Ğ¹ URL (localhost:8001)
    // 2. Ğ”Ğ¾Ğ´Ğ°Ñ”Ğ¼Ğ¾ Ğ¿Ñ€ĞµÑ„Ñ–ĞºÑ /inventory/, Ğ±Ğ¾ inventory.py Ğ·Ğ°Ğ·Ğ²Ğ¸Ñ‡Ğ°Ğ¹ Ğ¿Ñ–Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğ¹ Ñ‚Ğ°Ğ¼
    const url = `http://localhost:8001/inventory/history/?entity_type=${props.item.type}&entity_id=${props.item.id}`
    
    
    console.log("Fetching history from:", url) // Ğ›Ğ¾Ğ³ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ¸

    const res = await fetch(url)
    if (res.ok) {
        history.value = await res.json()
    } else {
        console.error("History fetch failed:", res.status)
    }
  } catch (e) { console.error(e) } 
  finally { loading.value = false }
}

watch(() => props.isOpen, (val) => {
  if (val) {
    history.value = []
    fetchHistory()
  }
})
</script>

<template>
  <div v-if="isOpen" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[80vh] animate-fade-in-up">
      
      <div class="p-4 border-b flex justify-between items-center bg-gray-50">
        <div>
           <div class="text-xs uppercase font-bold text-gray-400">Ğ†ÑÑ‚Ğ¾Ñ€Ñ–Ñ Ñ€ÑƒÑ…Ñƒ</div>
           <h3 class="font-bold text-lg text-gray-800">{{ item?.name }}</h3>
        </div>
        <button @click="emit('close')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
      </div>

      <div class="flex-1 overflow-y-auto p-0 custom-scrollbar">
         <div v-if="loading" class="p-8 text-center text-gray-400"><i class="fas fa-spinner fa-spin"></i> Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ...</div>
         <div v-else-if="history.length === 0" class="p-8 text-center text-gray-400">Ğ†ÑÑ‚Ğ¾Ñ€Ñ–Ñ Ğ¿Ğ¾Ñ€Ğ¾Ğ¶Ğ½Ñ</div>
         
         <table v-else class="w-full text-sm text-left">
           <thead class="bg-gray-100 text-gray-500 text-xs uppercase sticky top-0">
             <tr>
               <th class="p-3">Ğ”Ğ°Ñ‚Ğ°</th>
               <th class="p-3">ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°</th>
               <th class="p-3 text-right">Ğ—Ğ¼Ñ–Ğ½Ğ°</th>
               <th class="p-3 text-right">Ğ—Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº</th>
             </tr>
           </thead>
           <tbody class="divide-y divide-gray-100">
             <tr v-for="h in history" :key="h.id" class="hover:bg-gray-50">
               <td class="p-3 text-gray-500 whitespace-nowrap">{{ formatDate(h.created_at) }}</td>
               <td class="p-3">
                 <span v-if="h.reason === 'manual_correction'" class="bg-gray-200 text-gray-600 px-2 py-1 rounded text-[10px] font-bold">ĞšĞ¾Ñ€ĞµĞºÑ†Ñ–Ñ</span>
                 <span v-else-if="h.reason.includes('sale')" class="bg-green-100 text-green-700 px-2 py-1 rounded text-[10px] font-bold">ĞŸÑ€Ğ¾Ğ´Ğ°Ğ¶</span>
                 <span v-else class="text-gray-700 font-bold text-xs">{{ h.reason }}</span>
               </td>
               <td class="p-3 text-right font-mono font-bold" :class="h.change_amount > 0 ? 'text-green-600' : 'text-red-500'">
                 {{ h.change_amount > 0 ? '+' : '' }}{{ h.change_amount }}
               </td>
               <td class="p-3 text-right font-mono text-gray-600">
                 {{ h.balance_after }}
               </td>
             </tr>
           </tbody>
         </table>
      </div>

    </div>
  </div>
</template>

<style scoped>
.animate-fade-in-up { animation: fadeInUp 0.3s ease-out; }
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>

--------------------------------------------------
PATH: ./.history/frontend/src/components/warehouse/modals/HistoryModal_20260125102154.vue
--------------------------------------------------
<script setup>
import { ref, watch } from 'vue'

const props = defineProps({
  isOpen: Boolean,
  item: Object // { id, type, name }
})

const emit = defineEmits(['close'])
const history = ref([])
const loading = ref(false)

const formatDate = (dateStr) => {
  return new Date(dateStr).toLocaleString('uk-UA', { 
    day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' 
  })
}

const fetchHistory = async () => {
  if (!props.item) return
  loading.value = true
  try {
    // Ğ’Ğ˜ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞĞ¯:
    // 1. Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ Ğ¿Ğ¾Ğ²Ğ½Ğ¸Ğ¹ URL (localhost:8001)
    // 2. Ğ”Ğ¾Ğ´Ğ°Ñ”Ğ¼Ğ¾ Ğ¿Ñ€ĞµÑ„Ñ–ĞºÑ /inventory/, Ğ±Ğ¾ inventory.py Ğ·Ğ°Ğ·Ğ²Ğ¸Ñ‡Ğ°Ğ¹ Ğ¿Ñ–Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğ¹ Ñ‚Ğ°Ğ¼
    const url = `http://localhost:8001/history/?entity_type=${props.item.type}&entity_id=${props.item.id}`
    
    
    console.log("Fetching history from:", url) // Ğ›Ğ¾Ğ³ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ¸

    const res = await fetch(url)
    if (res.ok) {
        history.value = await res.json()
    } else {
        console.error("History fetch failed:", res.status)
    }
  } catch (e) { console.error(e) } 
  finally { loading.value = false }
}

watch(() => props.isOpen, (val) => {
  if (val) {
    history.value = []
    fetchHistory()
  }
})
</script>

<template>
  <div v-if="isOpen" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[80vh] animate-fade-in-up">
      
      <div class="p-4 border-b flex justify-between items-center bg-gray-50">
        <div>
           <div class="text-xs uppercase font-bold text-gray-400">Ğ†ÑÑ‚Ğ¾Ñ€Ñ–Ñ Ñ€ÑƒÑ…Ñƒ</div>
           <h3 class="font-bold text-lg text-gray-800">{{ item?.name }}</h3>
        </div>
        <button @click="emit('close')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
      </div>

      <div class="flex-1 overflow-y-auto p-0 custom-scrollbar">
         <div v-if="loading" class="p-8 text-center text-gray-400"><i class="fas fa-spinner fa-spin"></i> Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ...</div>
         <div v-else-if="history.length === 0" class="p-8 text-center text-gray-400">Ğ†ÑÑ‚Ğ¾Ñ€Ñ–Ñ Ğ¿Ğ¾Ñ€Ğ¾Ğ¶Ğ½Ñ</div>
         
         <table v-else class="w-full text-sm text-left">
           <thead class="bg-gray-100 text-gray-500 text-xs uppercase sticky top-0">
             <tr>
               <th class="p-3">Ğ”Ğ°Ñ‚Ğ°</th>
               <th class="p-3">ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°</th>
               <th class="p-3 text-right">Ğ—Ğ¼Ñ–Ğ½Ğ°</th>
               <th class="p-3 text-right">Ğ—Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº</th>
             </tr>
           </thead>
           <tbody class="divide-y divide-gray-100">
             <tr v-for="h in history" :key="h.id" class="hover:bg-gray-50">
               <td class="p-3 text-gray-500 whitespace-nowrap">{{ formatDate(h.created_at) }}</td>
               <td class="p-3">
                 <span v-if="h.reason === 'manual_correction'" class="bg-gray-200 text-gray-600 px-2 py-1 rounded text-[10px] font-bold">ĞšĞ¾Ñ€ĞµĞºÑ†Ñ–Ñ</span>
                 <span v-else-if="h.reason.includes('sale')" class="bg-green-100 text-green-700 px-2 py-1 rounded text-[10px] font-bold">ĞŸÑ€Ğ¾Ğ´Ğ°Ğ¶</span>
                 <span v-else class="text-gray-700 font-bold text-xs">{{ h.reason }}</span>
               </td>
               <td class="p-3 text-right font-mono font-bold" :class="h.change_amount > 0 ? 'text-green-600' : 'text-red-500'">
                 {{ h.change_amount > 0 ? '+' : '' }}{{ h.change_amount }}
               </td>
               <td class="p-3 text-right font-mono text-gray-600">
                 {{ h.balance_after }}
               </td>
             </tr>
           </tbody>
         </table>
      </div>

    </div>
  </div>
</template>

<style scoped>
.animate-fade-in-up { animation: fadeInUp 0.3s ease-out; }
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>

--------------------------------------------------
PATH: ./.history/frontend/src/components/warehouse/modals/HistoryModal_20260126160502.vue
--------------------------------------------------
<script setup>
import { ref, watch } from 'vue'

const props = defineProps({
  isOpen: Boolean,
  item: Object // { id, type, name }
})

const emit = defineEmits(['close'])
const history = ref([])
const loading = ref(false)

const formatDate = (dateStr) => {
  return new Date(dateStr).toLocaleString('uk-UA', { 
    day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' 
  })
}

const fetchHistory = async () => {
  if (!props.item) return
  
  loading.value = true
  history.value = [] 

  try {
    // Ğ’ĞĞ–Ğ›Ğ˜Ğ’Ğ: Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ Ğ²Ñ–Ğ´Ğ½Ğ¾ÑĞ½Ğ¸Ğ¹ ÑˆĞ»ÑÑ… /api/
    // Ğ‘Ñ€Ğ°ÑƒĞ·ĞµÑ€ ÑĞ°Ğ¼ Ğ¿Ñ–Ğ´ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¸Ğ¹ IP (100.100.84.4)
    const id = props.item.original_id || props.item.id
    const url = `/api/history/?entity_type=${props.item.type}&entity_id=${id}`
    
    console.log("HistoryModal requesting:", url) // Ğ”Ğ»Ñ Ğ½Ğ°Ğ»Ğ°Ğ³Ğ¾Ğ´Ğ¶ĞµĞ½Ğ½Ñ
    
    const res = await fetch(url)
    
    if (res.ok) {
        history.value = await res.json()
    } else {
        console.error("Server error:", res.status)
    }
  } catch (e) {
    console.error("Network error:", e)
  } finally {
    loading.value = false
  }
}

watch(() => props.isOpen, (val) => {
  if (val) {
    history.value = []
    fetchHistory()
  }
})
</script>

<template>
  <div v-if="isOpen" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[80vh] animate-fade-in-up">
      
      <div class="p-4 border-b flex justify-between items-center bg-gray-50">
        <div>
           <div class="text-xs uppercase font-bold text-gray-400">Ğ†ÑÑ‚Ğ¾Ñ€Ñ–Ñ Ñ€ÑƒÑ…Ñƒ</div>
           <h3 class="font-bold text-lg text-gray-800">{{ item?.name }}</h3>
        </div>
        <button @click="emit('close')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
      </div>

      <div class="flex-1 overflow-y-auto p-0 custom-scrollbar">
         <div v-if="loading" class="p-8 text-center text-gray-400"><i class="fas fa-spinner fa-spin"></i> Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ...</div>
         <div v-else-if="history.length === 0" class="p-8 text-center text-gray-400">Ğ†ÑÑ‚Ğ¾Ñ€Ñ–Ñ Ğ¿Ğ¾Ñ€Ğ¾Ğ¶Ğ½Ñ</div>
         
         <table v-else class="w-full text-sm text-left">
           <thead class="bg-gray-100 text-gray-500 text-xs uppercase sticky top-0">
             <tr>
               <th class="p-3">Ğ”Ğ°Ñ‚Ğ°</th>
               <th class="p-3">ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°</th>
               <th class="p-3 text-right">Ğ—Ğ¼Ñ–Ğ½Ğ°</th>
               <th class="p-3 text-right">Ğ—Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº</th>
             </tr>
           </thead>
           <tbody class="divide-y divide-gray-100">
             <tr v-for="h in history" :key="h.id" class="hover:bg-gray-50">
               <td class="p-3 text-gray-500 whitespace-nowrap">{{ formatDate(h.created_at) }}</td>
               <td class="p-3">
                 <span v-if="h.reason === 'manual_correction'" class="bg-gray-200 text-gray-600 px-2 py-1 rounded text-[10px] font-bold">ĞšĞ¾Ñ€ĞµĞºÑ†Ñ–Ñ</span>
                 <span v-else-if="h.reason.includes('sale')" class="bg-green-100 text-green-700 px-2 py-1 rounded text-[10px] font-bold">ĞŸÑ€Ğ¾Ğ´Ğ°Ğ¶</span>
                 <span v-else class="text-gray-700 font-bold text-xs">{{ h.reason }}</span>
               </td>
               <td class="p-3 text-right font-mono font-bold" :class="h.change_amount > 0 ? 'text-green-600' : 'text-red-500'">
                 {{ h.change_amount > 0 ? '+' : '' }}{{ h.change_amount }}
               </td>
               <td class="p-3 text-right font-mono text-gray-600">
                 {{ h.balance_after }}
               </td>
             </tr>
           </tbody>
         </table>
      </div>

    </div>
  </div>
</template>

<style scoped>
.animate-fade-in-up { animation: fadeInUp 0.3s ease-out; }
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>

--------------------------------------------------
PATH: ./.history/frontend/src/components/warehouse/modals/HistoryModal_20260126154913.vue
--------------------------------------------------
<script setup>
import { ref, watch } from 'vue'

const props = defineProps({
  isOpen: Boolean,
  item: Object // { id, type, name }
})

const emit = defineEmits(['close'])
const history = ref([])
const loading = ref(false)
const error = ref(null)

const formatDate = (dateStr) => {
  if (!dateStr) return '-'
  return new Date(dateStr).toLocaleString('uk-UA', { 
    day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' 
  })
}

const fetchHistory = async () => {
  if (!props.item) return
  
  loading.value = true
  error.value = null
  history.value = [] // ĞÑ‡Ğ¸Ñ‰ÑƒÑ”Ğ¼Ğ¾ Ğ¿ĞµÑ€ĞµĞ´ Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½ÑĞ¼

  try {
    console.log(`HistoryModal: Ğ—Ğ°Ğ¿Ğ¸Ñ‚ Ñ–ÑÑ‚Ğ¾Ñ€Ñ–Ñ— Ğ´Ğ»Ñ ${props.item.name} (ID: ${props.item.id})`)
    
    // Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¸Ğ¹ ID (ÑĞºÑ‰Ğ¾ Ñ” original_id, Ğ±ĞµÑ€ĞµĞ¼Ğ¾ Ğ¹Ğ¾Ğ³Ğ¾)
    const id = props.item.original_id || props.item.id
    const url = `/api/history/?entity_type=${props.item.type}&entity_id=${id}`
    
    const res = await fetch(url)
    
    if (!res.ok) {
        throw new Error(`ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° ÑĞµÑ€Ğ²ĞµÑ€Ğ°: ${res.status}`)
    }
    
    history.value = await res.json()
    console.log("HistoryModal: ĞÑ‚Ñ€Ğ¸Ğ¼Ğ°Ğ½Ğ¾ Ğ·Ğ°Ğ¿Ğ¸ÑÑ–Ğ²:", history.value.length)
  } catch (e) {
    console.error("HistoryModal Error:", e)
    error.value = "ĞĞµ Ğ²Ğ´Ğ°Ğ»Ğ¾ÑÑ Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶Ğ¸Ñ‚Ğ¸ Ñ–ÑÑ‚Ğ¾Ñ€Ñ–Ñ"
  } finally {
    loading.value = false
  }
}

// Ğ¡Ğ»Ñ–Ğ´ĞºÑƒÑ”Ğ¼Ğ¾ Ğ·Ğ° Ğ²Ñ–Ğ´ĞºÑ€Ğ¸Ñ‚Ñ‚ÑĞ¼ Ğ²Ñ–ĞºĞ½Ğ°
watch(() => props.isOpen, (newVal) => {
  if (newVal === true) {
    fetchHistory()
  }
})
</script>

<template>
  <div v-if="isOpen" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4" @click.self="$emit('close')">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[80vh] animate-fade-in-up">
      
      <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
        <div>
           <h3 class="font-bold text-lg text-gray-800">Ğ†ÑÑ‚Ğ¾Ñ€Ñ–Ñ Ñ€ÑƒÑ…Ñƒ</h3>
           <p class="text-sm text-gray-500">{{ item?.name }}</p>
        </div>
        <button @click="$emit('close')" class="w-8 h-8 rounded-full bg-white border flex items-center justify-center hover:bg-gray-100 transition">
          <i class="fas fa-times text-gray-500"></i>
        </button>
      </div>

      <div class="overflow-auto p-4 flex-1 min-h-[200px]">
        
        <div v-if="loading" class="flex flex-col items-center justify-center h-full text-gray-400 py-10">
            <i class="fas fa-circle-notch fa-spin text-3xl mb-3 text-blue-500"></i>
            <p>Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ´Ğ°Ğ½Ğ¸Ñ…...</p>
        </div>

        <div v-else-if="error" class="text-center py-10 text-red-500 bg-red-50 rounded-xl border border-red-100">
            <i class="fas fa-exclamation-circle text-3xl mb-2"></i>
            <p>{{ error }}</p>
        </div>

        <div v-else-if="history.length === 0" class="text-center py-10 text-gray-400 bg-gray-50 rounded-xl border border-dashed border-gray-200">
            <i class="fas fa-history text-3xl mb-2 opacity-50"></i>
            <p>Ğ ÑƒÑ…Ñƒ Ğ¿Ğ¾ ÑĞºĞ»Ğ°Ğ´Ñƒ Ñ‰Ğµ Ğ½Ğµ Ğ±ÑƒĞ»Ğ¾</p>
        </div>

        <table v-else class="w-full text-sm text-left">
           <thead class="text-xs text-gray-500 uppercase bg-gray-50 sticky top-0 z-10">
             <tr>
               <th class="p-3 bg-gray-50">Ğ”Ğ°Ñ‚Ğ°</th>
               <th class="p-3 bg-gray-50">ĞŸĞ¾Ğ´Ñ–Ñ</th>
               <th class="p-3 bg-gray-50 text-right">Ğ—Ğ¼Ñ–Ğ½Ğ°</th>
               <th class="p-3 bg-gray-50 text-right">Ğ—Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº</th>
             </tr>
           </thead>
           <tbody class="divide-y divide-gray-100">
             <tr v-for="h in history" :key="h.id" class="hover:bg-gray-50 transition">
               <td class="p-3 text-gray-500 whitespace-nowrap font-mono text-xs">{{ formatDate(h.created_at) }}</td>
               
               <td class="p-3">
                 <div v-if="h.reason === 'manual_correction'" class="inline-flex items-center gap-1 bg-gray-100 text-gray-600 px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wider">
                    <i class="fas fa-pen"></i> ĞšĞ¾Ñ€ĞµĞºÑ†Ñ–Ñ
                 </div>
                 <div v-else-if="h.reason && h.reason.includes('sale')" class="inline-flex items-center gap-1 bg-green-100 text-green-700 px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wider">
                    <i class="fas fa-shopping-cart"></i> ĞŸÑ€Ğ¾Ğ´Ğ°Ğ¶
                 </div>
                 <span v-else class="text-gray-700 font-bold text-xs">{{ h.reason }}</span>
               </td>

               <td class="p-3 text-right font-mono font-bold" :class="h.change_amount > 0 ? 'text-green-600' : 'text-red-500'">
                 {{ h.change_amount > 0 ? '+' : '' }}{{ h.change_amount }}
               </td>
               
               <td class="p-3 text-right font-mono text-gray-600">
                 {{ h.balance_after }}
               </td>
             </tr>
           </tbody>
        </table>
      </div>

    </div>
  </div>
</template>

--------------------------------------------------
PATH: ./.history/frontend/src/components/warehouse/modals/HistoryModal_20260118195805.vue
--------------------------------------------------
<script setup>
import { ref, watch } from 'vue'

const props = defineProps({
  isOpen: Boolean,
  item: Object // { id, type, name }
})

const emit = defineEmits(['close'])
const history = ref([])
const loading = ref(false)

const formatDate = (dateStr) => {
  return new Date(dateStr).toLocaleString('uk-UA', { 
    day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' 
  })
}

const fetchHistory = async () => {
  if (!props.item) return
  loading.value = true
  try {
    const url = `/api/history/?entity_type=${props.item.type}&entity_id=${props.item.id}`
    const res = await fetch(url)
    if (res.ok) history.value = await res.json()
  } catch (e) { console.error(e) } 
  finally { loading.value = false }
}

watch(() => props.isOpen, (val) => {
  if (val) {
    history.value = []
    fetchHistory()
  }
})
</script>

<template>
  <div v-if="isOpen" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[80vh] animate-fade-in-up">
      
      <div class="p-4 border-b flex justify-between items-center bg-gray-50">
        <div>
           <div class="text-xs uppercase font-bold text-gray-400">Ğ†ÑÑ‚Ğ¾Ñ€Ñ–Ñ Ñ€ÑƒÑ…Ñƒ</div>
           <h3 class="font-bold text-lg text-gray-800">{{ item?.name }}</h3>
        </div>
        <button @click="emit('close')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
      </div>

      <div class="flex-1 overflow-y-auto p-0 custom-scrollbar">
         <div v-if="loading" class="p-8 text-center text-gray-400"><i class="fas fa-spinner fa-spin"></i> Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ...</div>
         <div v-else-if="history.length === 0" class="p-8 text-center text-gray-400">Ğ†ÑÑ‚Ğ¾Ñ€Ñ–Ñ Ğ¿Ğ¾Ñ€Ğ¾Ğ¶Ğ½Ñ</div>
         
         <table v-else class="w-full text-sm text-left">
           <thead class="bg-gray-100 text-gray-500 text-xs uppercase sticky top-0">
             <tr>
               <th class="p-3">Ğ”Ğ°Ñ‚Ğ°</th>
               <th class="p-3">ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°</th>
               <th class="p-3 text-right">Ğ—Ğ¼Ñ–Ğ½Ğ°</th>
               <th class="p-3 text-right">Ğ—Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº</th>
             </tr>
           </thead>
           <tbody class="divide-y divide-gray-100">
             <tr v-for="h in history" :key="h.id" class="hover:bg-gray-50">
               <td class="p-3 text-gray-500 whitespace-nowrap">{{ formatDate(h.created_at) }}</td>
               <td class="p-3">
                 <span v-if="h.reason === 'manual_correction'" class="bg-gray-200 text-gray-600 px-2 py-1 rounded text-[10px] font-bold">ĞšĞ¾Ñ€ĞµĞºÑ†Ñ–Ñ</span>
                 <span v-else-if="h.reason.includes('sale')" class="bg-green-100 text-green-700 px-2 py-1 rounded text-[10px] font-bold">ĞŸÑ€Ğ¾Ğ´Ğ°Ğ¶</span>
                 <span v-else class="text-gray-700 font-bold text-xs">{{ h.reason }}</span>
               </td>
               <td class="p-3 text-right font-mono font-bold" :class="h.change_amount > 0 ? 'text-green-600' : 'text-red-500'">
                 {{ h.change_amount > 0 ? '+' : '' }}{{ h.change_amount }}
               </td>
               <td class="p-3 text-right font-mono text-gray-600">
                 {{ h.balance_after }}
               </td>
             </tr>
           </tbody>
         </table>
      </div>

    </div>
  </div>
</template>

<style scoped>
.animate-fade-in-up { animation: fadeInUp 0.3s ease-out; }
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>

--------------------------------------------------
PATH: ./.history/frontend/src/components/warehouse/modals/HistoryModal_20260126153922.vue
--------------------------------------------------
<script setup>
import { ref, watch, onMounted } from 'vue'

const props = defineProps({
  isOpen: Boolean,
  item: Object // { id, type, name }
})

const emit = defineEmits(['close'])
const history = ref([])
const loading = ref(false)

const formatDate = (dateStr) => {
  return new Date(dateStr).toLocaleString('uk-UA', { 
    day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' 
  })
}

// Ğ¤ÑƒĞ½ĞºÑ†Ñ–Ñ Ğ·Ğ°Ğ¿Ğ¸Ñ‚Ñƒ
const fetchHistory = async () => {
  if (!props.item) {
      console.error("HistoryModal: ĞĞµĞ¼Ğ°Ñ” Ğ´Ğ°Ğ½Ğ¸Ñ… item!")
      return
  }
  
  console.log("HistoryModal: ĞŸĞ¾Ñ‡Ğ¸Ğ½Ğ°Ñ Ğ·Ğ°Ğ¿Ğ¸Ñ‚ Ñ–ÑÑ‚Ğ¾Ñ€Ñ–Ñ—...", props.item)
  loading.value = true
  history.value = [] // ĞÑ‡Ğ¸Ñ‰ÑƒÑ”Ğ¼Ğ¾ ÑÑ‚Ğ°Ñ€Ğµ

  try {
    // Ğ¤Ğ¾Ñ€Ğ¼ÑƒÑ”Ğ¼Ğ¾ URL
    const url = `/api/history/?entity_type=${props.item.type}&entity_id=${props.item.id}`
    console.log("HistoryModal: URL =", url)

    const res = await fetch(url)
    
    if (res.ok) {
        history.value = await res.json()
        console.log("HistoryModal: Ğ”Ğ°Ğ½Ñ– Ğ¾Ñ‚Ñ€Ğ¸Ğ¼Ğ°Ğ½Ğ¾!", history.value)
    } else {
        console.error("HistoryModal: ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° ÑĞµÑ€Ğ²ĞµÑ€Ğ°", res.status)
    }
  } catch (e) { 
      console.error("HistoryModal: ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ¼ĞµÑ€ĞµĞ¶Ñ–", e) 
  } finally { 
      loading.value = false 
  }
}

// Ğ¡Ğ»Ñ–Ğ´ĞºÑƒÑ”Ğ¼Ğ¾ Ğ·Ğ° Ğ²Ñ–Ğ´ĞºÑ€Ğ¸Ñ‚Ñ‚ÑĞ¼ Ğ²Ñ–ĞºĞ½Ğ°
watch(() => props.isOpen, (newVal) => {
  console.log("HistoryModal: isOpen Ğ·Ğ¼Ñ–Ğ½Ğ¸Ğ»Ğ¾ÑÑŒ Ğ½Ğ°", newVal)
  if (newVal === true) {
    fetchHistory()
  }
})
</script>

<template>
  <div v-if="isOpen" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[80vh]">
      
      <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
        <div>
           <h3 class="font-bold text-lg text-gray-800">Ğ†ÑÑ‚Ğ¾Ñ€Ñ–Ñ Ñ€ÑƒÑ…Ñƒ</h3>
           <p class="text-sm text-gray-500">{{ item?.name }}</p>
        </div>
        <button @click="$emit('close')" class="w-8 h-8 rounded-full bg-white border flex items-center justify-center hover:bg-gray-100">
          <i class="fas fa-times text-gray-500"></i>
        </button>
      </div>

      <div class="overflow-auto p-4 flex-1">
        <div v-if="loading" class="text-center py-10 text-gray-400">
            <i class="fas fa-circle-notch fa-spin text-2xl mb-2"></i>
            <p>Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ...</p>
        </div>

        <div v-else-if="history.length === 0" class="text-center py-10 text-gray-400 bg-gray-50 rounded-xl border border-dashed border-gray-200">
            <i class="fas fa-history text-3xl mb-2 opacity-50"></i>
            <p>Ğ†ÑÑ‚Ğ¾Ñ€Ñ–Ñ Ğ¿Ğ¾Ñ€Ğ¾Ğ¶Ğ½Ñ</p>
        </div>

        <table v-else class="w-full text-sm text-left">
           <thead class="text-xs text-gray-500 uppercase bg-gray-50 sticky top-0">
             <tr>
               <th class="p-3">Ğ”Ğ°Ñ‚Ğ°</th>
               <th class="p-3">ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°</th>
               <th class="p-3 text-right">Ğ—Ğ¼Ñ–Ğ½Ğ°</th>
               <th class="p-3 text-right">Ğ—Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº</th>
             </tr>
           </thead>
           <tbody class="divide-y divide-gray-100">
             <tr v-for="h in history" :key="h.id" class="hover:bg-gray-50">
               <td class="p-3 text-gray-500 whitespace-nowrap">{{ formatDate(h.created_at) }}</td>
               
               <td class="p-3">
                 <span v-if="h.reason === 'manual_correction'" class="bg-gray-200 text-gray-600 px-2 py-1 rounded text-[10px] font-bold">ĞšĞ¾Ñ€ĞµĞºÑ†Ñ–Ñ</span>
                 <span v-else-if="h.reason && h.reason.includes('sale')" class="bg-green-100 text-green-700 px-2 py-1 rounded text-[10px] font-bold">ĞŸÑ€Ğ¾Ğ´Ğ°Ğ¶</span>
                 <span v-else class="text-gray-700 font-bold text-xs">{{ h.reason }}</span>
               </td>

               <td class="p-3 text-right font-mono font-bold" :class="h.change_amount > 0 ? 'text-green-600' : 'text-red-500'">
                 {{ h.change_amount > 0 ? '+' : '' }}{{ h.change_amount }}
               </td>
               
               <td class="p-3 text-right font-mono text-gray-600">
                 {{ h.balance_after }}
               </td>
             </tr>
           </tbody>
        </table>
      </div>

    </div>
  </div>
</template>

--------------------------------------------------
PATH: ./.history/frontend/src/composables/useProducts_20260125120953.js
--------------------------------------------------
import { ref, computed } from 'vue'
import axios from 'axios'
import { useWarehouse } from '@/composables/useWarehouse'

// Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ¸Ğ¹ ÑÑ‚Ğ°Ğ½
const newProduct = ref({
    name: '', category_id: null, price: 0, has_variants: false,
    master_recipe_id: null, output_weight: 0,
    track_stock: false, stock_quantity: 0,
    consumables: [], variants: [], process_group_ids: []
})

const editingId = ref(null)
const isEditing = ref(false)
const productSearch = ref('')

// --- ĞĞĞ’Ğ•: Ğ¡Ñ‚Ğ°Ğ½ Ñ€ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ ---
const editingVariantIndex = ref(null) // null = Ñ€ĞµĞ¶Ğ¸Ğ¼ ÑÑ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ½Ñ, Ñ‡Ğ¸ÑĞ»Ğ¾ = Ñ–Ğ½Ğ´ĞµĞºÑ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ

// Ğ¢Ğ¸Ğ¼Ñ‡Ğ°ÑĞ¾Ğ²Ñ– Ğ·Ğ¼Ñ–Ğ½Ğ½Ñ–
const tempProductConsumable = ref({ consumable_id: "", quantity: 1 })
const tempVariantConsumable = ref({ consumable_id: "", quantity: 1 })
const tempVariantIngredient = ref({ ingredient_id: "", quantity: 0 })

const variantBuilder = ref({
    name: '', price: 0, master_recipe_id: null, 
    output_weight: 0, stock_quantity: 0, 
    consumables: [], ingredients: []
})

export function useProducts() {
    const warehouse = useWarehouse()
    const products = warehouse?.products || ref([])
    const consumables = warehouse?.consumables || ref([])
    const ingredients = warehouse?.ingredients || ref([])
    const fetchWarehouseData = warehouse?.fetchWarehouseData || (async ()=>{})

    const filteredProducts = computed(() => {
        if (!products.value) return []
        if (!productSearch.value) return products.value
        return products.value.filter(p => p.name.toLowerCase().includes(productSearch.value.toLowerCase()))
    })

    const fetchProducts = async () => { await fetchWarehouseData() }

    const saveProduct = async () => {
        if (!newProduct.value.name) return alert("Ğ’ĞºĞ°Ğ¶Ñ–Ñ‚ÑŒ Ğ½Ğ°Ğ·Ğ²Ñƒ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ!")
        
        const cleanPrice = newProduct.value.has_variants ? 0 : (parseFloat(newProduct.value.price) || 0)
        const cleanWeight = parseFloat(newProduct.value.output_weight) || 0
        const cleanStock = parseFloat(newProduct.value.stock_quantity) || 0
        
        const payload = {
            ...newProduct.value,
            category_id: newProduct.value.category_id || null,
            master_recipe_id: newProduct.value.master_recipe_id || null,
            price: cleanPrice,
            output_weight: cleanWeight,
            stock_quantity: cleanStock,
            variants: newProduct.value.has_variants ? newProduct.value.variants : [] 
        }

        try {
            const url = isEditing.value 
                ? `http://localhost:8001/products/${editingId.value}`
                : 'http://localhost:8001/products/'
            const method = isEditing.value ? 'put' : 'post'

            await axios[method](url, payload)
            await fetchProducts()
            resetForm()
            return true
        } catch (err) {
            console.error("Save error:", err)
            alert("ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ·Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ½Ñ")
            return false
        }
    }

    const deleteProduct = async (id) => {
        if(!confirm("Ğ’Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğ¸?")) return
        try {
            await axios.delete(`http://localhost:8001/products/${id}`)
            await fetchProducts()
        } catch(e) { alert("ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ²Ğ¸Ğ´Ğ°Ğ»ĞµĞ½Ğ½Ñ") }
    }

    const resetForm = () => {
        isEditing.value = false
        editingId.value = null
        editingVariantIndex.value = null // Ğ¡ĞºĞ¸Ğ´Ğ°Ñ”Ğ¼Ğ¾ Ñ€ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ
        newProduct.value = {
            name: '', category_id: null, price: 0, has_variants: false,
            master_recipe_id: null, output_weight: 0,
            track_stock: false, stock_quantity: 0,
            consumables: [], variants: [], process_group_ids: []
        }
        resetVariantBuilder()
    }

    const resetVariantBuilder = () => {
        variantBuilder.value = { name: '', price: 0, master_recipe_id: null, output_weight: 0, stock_quantity: 0, consumables: [], ingredients: [] }
        editingVariantIndex.value = null
    }

    const prepareEdit = (p) => {
        isEditing.value = true
        editingId.value = p.id
        const copy = JSON.parse(JSON.stringify(p))
        if (copy.variants) {
            copy.variants.forEach(v => {
                if(v.consumables) v.consumables.forEach(c => c.name = c.consumable_name || c.name)
                if(v.ingredients) v.ingredients.forEach(i => i.name = i.ingredient_name || i.name)
            })
        }
        if (copy.consumables) copy.consumables.forEach(c => c.name = c.consumable_name || c.name)
        newProduct.value = copy
    }

    // --- Ğ›ĞĞ“Ğ†ĞšĞ Ğ’ĞĞ Ğ†ĞĞĞ¢Ğ†Ğ’ (ĞĞ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ°) ---
    
    // 1. Ğ¤ÑƒĞ½ĞºÑ†Ñ–Ñ Ğ·Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ½Ñ (Ğ”Ğ¾Ğ´Ğ°Ğ²Ğ°Ğ½Ğ½Ñ ĞĞ‘Ğ ĞĞ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ)
    const saveVariant = () => {
        if(!variantBuilder.value.name) return alert("Ğ’ĞºĞ°Ğ¶Ñ–Ñ‚ÑŒ Ğ½Ğ°Ğ·Ğ²Ñƒ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ")
        
        const variantData = JSON.parse(JSON.stringify(variantBuilder.value))

        if (editingVariantIndex.value !== null) {
            // ĞĞĞĞ’Ğ›Ğ•ĞĞĞ¯ Ñ–ÑĞ½ÑƒÑÑ‡Ğ¾Ğ³Ğ¾
            newProduct.value.variants[editingVariantIndex.value] = variantData
        } else {
            // Ğ”ĞĞ”ĞĞ’ĞĞĞĞ¯ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾
            newProduct.value.variants.push(variantData)
        }
        resetVariantBuilder()
    }

    // 2. Ğ¤ÑƒĞ½ĞºÑ†Ñ–Ñ Ğ¿Ñ–Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²ĞºĞ¸ Ğ´Ğ¾ Ñ€ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ
    const editVariant = (index) => {
        editingVariantIndex.value = index
        // ĞšĞ¾Ğ¿Ñ–ÑÑ”Ğ¼Ğ¾ Ğ´Ğ°Ğ½Ñ– Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ Ğ½Ğ°Ğ·Ğ°Ğ´ Ñƒ Ñ„Ğ¾Ñ€Ğ¼Ñƒ
        variantBuilder.value = JSON.parse(JSON.stringify(newProduct.value.variants[index]))
    }

    // 3. Ğ¡ĞºĞ°ÑÑƒĞ²Ğ°Ğ½Ğ½Ñ Ñ€ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ
    const cancelVariantEdit = () => {
        resetVariantBuilder()
    }

    const removeVariant = (i) => {
        newProduct.value.variants.splice(i, 1)
        if (editingVariantIndex.value === i) resetVariantBuilder()
    }

    // Ğ†Ğ½ÑˆÑ– Ğ¼ĞµÑ‚Ğ¾Ğ´Ğ¸ (Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸/Ñ–Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ğ¸)
    const addProductConsumable = () => {
        if(!tempProductConsumable.value.consumable_id) return
        const c = consumables.value.find(x => x.id === tempProductConsumable.value.consumable_id)
        newProduct.value.consumables.push({ ...tempProductConsumable.value, name: c?.name || '???' })
        tempProductConsumable.value.quantity = 1
    }
    const removeProductConsumable = (i) => newProduct.value.consumables.splice(i, 1)

    const addVariantConsumable = () => {
        if(!tempVariantConsumable.value.consumable_id) return
        const c = consumables.value.find(x => x.id === tempVariantConsumable.value.consumable_id)
        variantBuilder.value.consumables.push({ ...tempVariantConsumable.value, name: c?.name || '???' })
        tempVariantConsumable.value.quantity = 1
    }
    const removeVariantConsumable = (i) => variantBuilder.value.consumables.splice(i, 1)

    const addIngredientToVariant = () => {
        if(!tempVariantIngredient.value.ingredient_id) return
        const i = ingredients.value.find(x => x.id === tempVariantIngredient.value.ingredient_id)
        variantBuilder.value.ingredients.push({ ...tempVariantIngredient.value, name: i?.name || '???' })
        tempVariantIngredient.value.quantity = 0
    }
    const removeIngredientFromVariant = (i) => variantBuilder.value.ingredients.splice(i, 1)

    return {
        newProduct, isEditing, editingId, productSearch, filteredProducts,
        variantBuilder, tempProductConsumable, tempVariantConsumable, tempVariantIngredient,
        // Ğ•ĞºÑĞ¿Ğ¾Ñ€Ñ‚ÑƒÑ”Ğ¼Ğ¾ Ğ½Ğ¾Ğ²Ñ– Ğ·Ğ¼Ñ–Ğ½Ğ½Ñ– Ñ‚Ğ° Ğ¼ĞµÑ‚Ğ¾Ğ´Ğ¸
        editingVariantIndex, saveVariant, editVariant, cancelVariantEdit,
        
        fetchProducts, saveProduct, deleteProduct, resetForm, prepareEdit,
        removeVariant,
        addProductConsumable, removeProductConsumable,
        addVariantConsumable, removeVariantConsumable,
        addIngredientToVariant, removeIngredientFromVariant
    }
}

--------------------------------------------------
PATH: ./.history/frontend/src/composables/useProducts_20260124215454.js
--------------------------------------------------
import { ref, computed } from 'vue'
import axios from 'axios'
import { useWarehouse } from '@/composables/useWarehouse'

const newProduct = ref({
    name: '', category_id: null, price: 0, has_variants: false,
    master_recipe_id: null, output_weight: 0,
    track_stock: false, stock_quantity: 0,
    consumables: [], variants: [], process_group_ids: []
})

const editingId = ref(null)
const isEditing = ref(false)
const productSearch = ref('')

// Ğ¢Ğ¸Ğ¼Ñ‡Ğ°ÑĞ¾Ğ²Ñ– Ğ·Ğ¼Ñ–Ğ½Ğ½Ñ–
const tempProductConsumable = ref({ consumable_id: "", quantity: 1 })
const tempVariantConsumable = ref({ consumable_id: "", quantity: 1 })
const tempVariantIngredient = ref({ ingredient_id: "", quantity: 0 })

const variantBuilder = ref({
    name: '', price: 0, master_recipe_id: null, 
    output_weight: 0, stock_quantity: 0, 
    consumables: [], ingredients: []
})

export function useProducts() {
    const warehouse = useWarehouse()
    const products = warehouse?.products || ref([])
    const consumables = warehouse?.consumables || ref([])
    const ingredients = warehouse?.ingredients || ref([])
    const fetchWarehouseData = warehouse?.fetchWarehouseData || (async ()=>{})

    const filteredProducts = computed(() => {
        if (!products.value) return []
        if (!productSearch.value) return products.value
        return products.value.filter(p => p.name.toLowerCase().includes(productSearch.value.toLowerCase()))
    })

    const fetchProducts = async () => { await fetchWarehouseData() }

    // --- Ğ“ĞĞ›ĞĞ’ĞĞ• Ğ’Ğ˜ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞĞ¯ Ğ¢Ğ£Ğ¢ ---
    const saveProduct = async () => {
        if (!newProduct.value.name) return alert("Ğ’ĞºĞ°Ğ¶Ñ–Ñ‚ÑŒ Ğ½Ğ°Ğ·Ğ²Ñƒ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ!")
        
        // 1. Ğ¡Ğ°Ğ½Ñ–Ñ‚Ğ¸Ğ·Ğ°Ñ†Ñ–Ñ Ğ´Ğ°Ğ½Ğ¸Ñ… (Clean Data)
        // ĞœĞ¸ Ğ³Ğ°Ñ€Ğ°Ğ½Ñ‚ÑƒÑ”Ğ¼Ğ¾, Ñ‰Ğ¾ Ñ‡Ğ¸ÑĞ»Ğ° Ğ±ÑƒĞ´ÑƒÑ‚ÑŒ Ñ‡Ğ¸ÑĞ»Ğ°Ğ¼Ğ¸, Ğ° Ğ½Ğµ Ğ¿ÑƒÑÑ‚Ğ¸Ğ¼Ğ¸ Ñ€ÑĞ´ĞºĞ°Ğ¼Ğ¸
        const cleanPrice = newProduct.value.has_variants ? 0 : (parseFloat(newProduct.value.price) || 0)
        const cleanWeight = parseFloat(newProduct.value.output_weight) || 0
        const cleanStock = parseFloat(newProduct.value.stock_quantity) || 0
        
        // 2. Ğ¤Ğ¾Ñ€Ğ¼ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ¿Ğ°ĞºĞµÑ‚Ñƒ Ğ´Ğ°Ğ½Ğ¸Ñ…
        const payload = {
            ...newProduct.value,
            category_id: newProduct.value.category_id || null,
            master_recipe_id: newProduct.value.master_recipe_id || null,
            price: cleanPrice,
            output_weight: cleanWeight,
            stock_quantity: cleanStock,
            // Ğ¯ĞºÑ‰Ğ¾ Ñ†Ğµ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¸Ğ¹ Ñ‚Ğ¾Ğ²Ğ°Ñ€ - Ğ¾Ğ±Ñ€Ñ–Ğ·Ğ°Ñ”Ğ¼Ğ¾ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸, Ñ‰Ğ¾Ğ± Ğ½Ğµ Ğ¿Ğ»ÑƒÑ‚Ğ°Ñ‚Ğ¸ Ğ±ĞµĞºĞµĞ½Ğ´
            variants: newProduct.value.has_variants ? newProduct.value.variants : [] 
        }

        console.log("ğŸ“¤ Ğ’Ñ–Ğ´Ğ¿Ñ€Ğ°Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€:", payload) // Ğ”Ğ»Ñ Ğ´ĞµĞ±Ğ°Ğ³Ñƒ Ğ² ĞºĞ¾Ğ½ÑĞ¾Ğ»Ñ–

        try {
            const url = isEditing.value 
                ? `http://localhost:8001/products/${editingId.value}`
                : 'http://localhost:8001/products/'
            const method = isEditing.value ? 'put' : 'post'

            const res = await axios[method](url, payload)
            console.log("âœ… Ğ£ÑĞ¿Ñ–Ñ…:", res.data)
            await fetchProducts() // <--- Ğ¦Ğ•Ğ™ Ğ’Ğ˜ĞšĞ›Ğ˜Ğš ĞœĞĞ„ ĞĞĞĞ’Ğ˜Ğ¢Ğ˜ Ğ¡ĞŸĞ˜Ğ¡ĞĞš

            resetForm()
            return true
        } catch (err) {
            console.error("âŒ ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ·Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ½Ñ:", err)
            // Ğ’Ğ¸Ğ²Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ Ğ´ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ñƒ Ğ¿Ğ¾Ğ¼Ğ¸Ğ»ĞºÑƒ, ÑĞºÑ‰Ğ¾ Ğ²Ğ¾Ğ½Ğ° Ğ¿Ñ€Ğ¸Ğ¹ÑˆĞ»Ğ° Ğ· Ğ±ĞµĞºĞµĞ½Ğ´Ñƒ
            if (err.response && err.response.data) {
                console.error("Ğ”ĞµÑ‚Ğ°Ğ»Ñ– ÑĞµÑ€Ğ²ĞµÑ€Ğ°:", err.response.data)
                alert(`ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° ÑĞµÑ€Ğ²ĞµÑ€Ğ°: ${JSON.stringify(err.response.data.detail || 'ĞĞµĞ²Ñ–Ğ´Ğ¾Ğ¼Ğ° Ğ¿Ğ¾Ğ¼Ğ¸Ğ»ĞºĞ°')}`)
            } else {
                alert("ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ¼ĞµÑ€ĞµĞ¶Ñ– Ğ°Ğ±Ğ¾ ĞºĞ¾Ğ´Ñƒ. Ğ”Ğ¸Ğ². ĞºĞ¾Ğ½ÑĞ¾Ğ»ÑŒ.")
            }
            return false
        }
    }

    const deleteProduct = async (id) => {
        if(!confirm("Ğ’Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğ¸?")) return
        try {
            await axios.delete(`http://localhost:8001/products/${id}`)
            await fetchProducts()
        } catch(e) { alert("ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ²Ğ¸Ğ´Ğ°Ğ»ĞµĞ½Ğ½Ñ") }
    }

    const resetForm = () => {
        isEditing.value = false
        editingId.value = null
        newProduct.value = {
            name: '', category_id: null, price: 0, has_variants: false,
            master_recipe_id: null, output_weight: 0,
            track_stock: false, stock_quantity: 0,
            consumables: [], variants: [], process_group_ids: []
        }
        variantBuilder.value = { name: '', price: 0, master_recipe_id: null, output_weight: 0, stock_quantity: 0, consumables: [], ingredients: [] }
    }

    const prepareEdit = (p) => {
        isEditing.value = true
        editingId.value = p.id
        const copy = JSON.parse(JSON.stringify(p))
        if (copy.variants) {
            copy.variants.forEach(v => {
                if(v.consumables) v.consumables.forEach(c => c.name = c.consumable_name || c.name)
                if(v.ingredients) v.ingredients.forEach(i => i.name = i.ingredient_name || i.name)
            })
        }
        if (copy.consumables) copy.consumables.forEach(c => c.name = c.consumable_name || c.name)
        newProduct.value = copy
    }

    const addVariant = () => {
        if(!variantBuilder.value.name) return alert("Ğ’ĞºĞ°Ğ¶Ñ–Ñ‚ÑŒ Ğ½Ğ°Ğ·Ğ²Ñƒ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ")
        newProduct.value.variants.push(JSON.parse(JSON.stringify(variantBuilder.value)))
        variantBuilder.value = { name: '', price: 0, master_recipe_id: null, output_weight: 0, stock_quantity: 0, consumables: [], ingredients: [] }
    }
    const removeVariant = (i) => newProduct.value.variants.splice(i, 1)

    const addProductConsumable = () => {
        if(!tempProductConsumable.value.consumable_id) return
        const c = consumables.value.find(x => x.id === tempProductConsumable.value.consumable_id)
        newProduct.value.consumables.push({ ...tempProductConsumable.value, name: c?.name || '???' })
        tempProductConsumable.value.quantity = 1
    }
    const removeProductConsumable = (i) => newProduct.value.consumables.splice(i, 1)

    const addVariantConsumable = () => {
        if(!tempVariantConsumable.value.consumable_id) return
        const c = consumables.value.find(x => x.id === tempVariantConsumable.value.consumable_id)
        variantBuilder.value.consumables.push({ ...tempVariantConsumable.value, name: c?.name || '???' })
        tempVariantConsumable.value.quantity = 1
    }
    const removeVariantConsumable = (i) => variantBuilder.value.consumables.splice(i, 1)

    const addIngredientToVariant = () => {
        if(!tempVariantIngredient.value.ingredient_id) return
        const i = ingredients.value.find(x => x.id === tempVariantIngredient.value.ingredient_id)
        variantBuilder.value.ingredients.push({ ...tempVariantIngredient.value, name: i?.name || '???' })
        tempVariantIngredient.value.quantity = 0
    }
    const removeIngredientFromVariant = (i) => variantBuilder.value.ingredients.splice(i, 1)

    return {
        newProduct, isEditing, editingId, productSearch, filteredProducts,
        variantBuilder, tempProductConsumable, tempVariantConsumable, tempVariantIngredient,
        fetchProducts, saveProduct, deleteProduct, resetForm, prepareEdit,
        addVariant, removeVariant,
        addProductConsumable, removeProductConsumable,
        addVariantConsumable, removeVariantConsumable,
        addIngredientToVariant, removeIngredientFromVariant
    }
}

--------------------------------------------------
PATH: ./.history/frontend/src/composables/useProducts_20260123162643.js
--------------------------------------------------
import { ref, computed } from 'vue'
import axios from 'axios'
import { useWarehouse } from '@/composables/useWarehouse'

// --- Ğ“Ğ›ĞĞ‘ĞĞ›Ğ¬ĞĞ˜Ğ™ Ğ¡Ğ¢ĞĞ ---
const newProduct = ref({
    name: '', category_id: null, price: 0, has_variants: false,
    master_recipe_id: null, output_weight: 0,
    track_stock: false, stock_quantity: 0,
    consumables: [], variants: [], process_group_ids: []
})

const editingId = ref(null)
const isEditing = ref(false)
const productSearch = ref('')

// Ğ¢Ğ¸Ğ¼Ñ‡Ğ°ÑĞ¾Ğ²Ñ– Ğ·Ğ¼Ñ–Ğ½Ğ½Ñ–
const tempProductConsumable = ref({ consumable_id: "", quantity: 1 })
const tempVariantConsumable = ref({ consumable_id: "", quantity: 1 })
const tempVariantIngredient = ref({ ingredient_id: "", quantity: 0 })

const variantBuilder = ref({
    name: '', price: 0, master_recipe_id: null, 
    output_weight: 0, stock_quantity: 0, 
    consumables: [], ingredients: []
})

export function useProducts() {
    // ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ğ´Ğ°Ğ½Ñ–. Ğ¯ĞºÑ‰Ğ¾ useWarehouse Ğ¿Ğ¾Ğ²ĞµÑ€Ğ½Ğµ undefined, Ğ¼Ğ¸ Ñ†Ğµ Ğ¾Ğ±Ñ€Ğ¾Ğ±Ğ¸Ğ¼Ğ¾ Ğ½Ğ¸Ğ¶Ñ‡Ğµ.
    const warehouseData = useWarehouse()
    
    // Ğ‘ĞµĞ·Ğ¿ĞµÑ‡Ğ½Ğµ Ğ²Ğ¸Ñ‚ÑĞ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ·Ğ¼Ñ–Ğ½Ğ½Ğ¸Ñ… (Ğ· Ğ´ĞµÑ„Ğ¾Ğ»Ñ‚Ğ½Ğ¸Ğ¼Ğ¸ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ½ÑĞ¼Ğ¸)
    const products = warehouseData?.products || ref([])
    const consumables = warehouseData?.consumables || ref([])
    const ingredients = warehouseData?.ingredients || ref([])
    const fetchWarehouseData = warehouseData?.fetchWarehouseData || (async () => {})

    // --- Computed: Ğ‘ĞµĞ·Ğ¿ĞµÑ‡Ğ½Ğ° Ñ„Ñ–Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ñ–Ñ ---
    const filteredProducts = computed(() => {
        // !!! ĞĞ¡Ğ¬ Ğ¢Ğ£Ğ¢ Ğ‘Ğ£Ğ›Ğ ĞŸĞĞœĞ˜Ğ›ĞšĞ. Ğ¢Ğ•ĞŸĞ•Ğ  ĞœĞ˜ ĞŸĞ•Ğ Ğ•Ğ’Ğ†Ğ Ğ¯Ğ„ĞœĞ Ğ’Ğ¡Ğ• !!!
        if (!products || !products.value || !Array.isArray(products.value)) {
            return []
        }

        if (!productSearch.value) return products.value
        
        const q = productSearch.value.toLowerCase()
        return products.value.filter(p => 
            p.name && p.name.toLowerCase().includes(q)
        )
    })

    // --- API: Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ ---
    const fetchProducts = async () => {
        try {
            await fetchWarehouseData()
        } catch (e) {
            console.error("ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ– ÑĞºĞ»Ğ°Ğ´Ñƒ:", e)
        }
    }

    // --- API: Ğ—Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ½Ñ ---
    const saveProduct = async () => {
        if (!newProduct.value.name) return alert("Ğ’ĞºĞ°Ğ¶Ñ–Ñ‚ÑŒ Ğ½Ğ°Ğ·Ğ²Ñƒ!")
        
        const payload = {
            ...newProduct.value,
            category_id: newProduct.value.category_id || null,
            master_recipe_id: newProduct.value.master_recipe_id || null,
            price: newProduct.value.has_variants ? 0 : newProduct.value.price
        }

        try {
            const url = isEditing.value 
                ? `http://localhost:8001/products/${editingId.value}`
                : 'http://localhost:8001/products/'
            const method = isEditing.value ? 'put' : 'post'

            await axios[method](url, payload)
            await fetchProducts()
            resetForm()
            return true
        } catch (err) {
            console.error(err)
            alert("ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ·Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ½Ñ. Ğ”Ğ¸Ğ². ĞºĞ¾Ğ½ÑĞ¾Ğ»ÑŒ.")
            return false
        }
    }

    // --- API: Ğ’Ğ¸Ğ´Ğ°Ğ»ĞµĞ½Ğ½Ñ ---
    const deleteProduct = async (id) => {
        if(!confirm("Ğ’Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğ¸?")) return
        try {
            await axios.delete(`http://localhost:8001/products/${id}`)
            await fetchProducts()
        } catch(e) { alert("ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ²Ğ¸Ğ´Ğ°Ğ»ĞµĞ½Ğ½Ñ") }
    }

    // --- Ğ¥ĞµĞ»Ğ¿ĞµÑ€Ğ¸ ---
    const resetForm = () => {
        isEditing.value = false
        editingId.value = null
        newProduct.value = {
            name: '', category_id: null, price: 0, has_variants: false,
            master_recipe_id: null, output_weight: 0,
            track_stock: false, stock_quantity: 0,
            consumables: [], variants: [], process_group_ids: []
        }
        variantBuilder.value = { name: '', price: 0, master_recipe_id: null, output_weight: 0, stock_quantity: 0, consumables: [], ingredients: [] }
    }

    const prepareEdit = (p) => {
        isEditing.value = true
        editingId.value = p.id
        const copy = JSON.parse(JSON.stringify(p))
        
        // ĞœĞ°Ğ¿Ğ¸Ğ½Ğ³ Ğ¿Ğ¾Ğ»Ñ–Ğ² Ğ´Ğ»Ñ Ñ„Ğ¾Ñ€Ğ¼Ğ¸
        if (copy.variants) {
            copy.variants.forEach(v => {
                if(v.consumables) v.consumables.forEach(c => c.name = c.consumable_name || c.name)
                if(v.ingredients) v.ingredients.forEach(i => i.name = i.ingredient_name || i.name)
            })
        }
        if (copy.consumables) {
            copy.consumables.forEach(c => c.name = c.consumable_name || c.name)
        }
        
        newProduct.value = copy
    }

    // --- Ğ›Ğ¾Ğ³Ñ–ĞºĞ° Ğ´Ğ¾Ğ´Ğ°Ğ²Ğ°Ğ½Ğ½Ñ (Adders) ---
    const addVariant = () => {
        if(!variantBuilder.value.name) return alert("Ğ’ĞºĞ°Ğ¶Ñ–Ñ‚ÑŒ Ğ½Ğ°Ğ·Ğ²Ñƒ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ")
        newProduct.value.variants.push(JSON.parse(JSON.stringify(variantBuilder.value)))
        variantBuilder.value = { name: '', price: 0, master_recipe_id: null, output_weight: 0, stock_quantity: 0, consumables: [], ingredients: [] }
    }
    const removeVariant = (i) => newProduct.value.variants.splice(i, 1)

    const addProductConsumable = () => {
        if(!tempProductConsumable.value.consumable_id) return
        const c = consumables.value.find(x => x.id === tempProductConsumable.value.consumable_id)
        newProduct.value.consumables.push({ ...tempProductConsumable.value, name: c?.name || '???' })
        tempProductConsumable.value.quantity = 1
    }
    const removeProductConsumable = (i) => newProduct.value.consumables.splice(i, 1)

    const addVariantConsumable = () => {
        if(!tempVariantConsumable.value.consumable_id) return
        const c = consumables.value.find(x => x.id === tempVariantConsumable.value.consumable_id)
        variantBuilder.value.consumables.push({ ...tempVariantConsumable.value, name: c?.name || '???' })
        tempVariantConsumable.value.quantity = 1
    }
    const removeVariantConsumable = (i) => variantBuilder.value.consumables.splice(i, 1)

    const addIngredientToVariant = () => {
        if(!tempVariantIngredient.value.ingredient_id) return
        const i = ingredients.value.find(x => x.id === tempVariantIngredient.value.ingredient_id)
        variantBuilder.value.ingredients.push({ ...tempVariantIngredient.value, name: i?.name || '???' })
        tempVariantIngredient.value.quantity = 0
    }
    const removeIngredientFromVariant = (i) => variantBuilder.value.ingredients.splice(i, 1)

    return {
        newProduct, isEditing, editingId, productSearch, filteredProducts,
        variantBuilder, tempProductConsumable, tempVariantConsumable, tempVariantIngredient,
        fetchProducts, saveProduct, deleteProduct, resetForm, prepareEdit,
        addVariant, removeVariant,
        addProductConsumable, removeProductConsumable,
        addVariantConsumable, removeVariantConsumable,
        addIngredientToVariant, removeIngredientFromVariant
    }
}

--------------------------------------------------
PATH: ./.history/frontend/src/composables/useProducts_20260123213821.js
--------------------------------------------------
import { ref, computed } from 'vue'
import axios from 'axios'
import { useWarehouse } from '@/composables/useWarehouse'

// --- Ğ“Ğ›ĞĞ‘ĞĞ›Ğ¬ĞĞ˜Ğ™ Ğ¡Ğ¢ĞĞ ---
const newProduct = ref({
    name: '', category_id: null, price: 0, has_variants: false,
    master_recipe_id: null, output_weight: 0,
    track_stock: false, stock_quantity: 0,
    consumables: [], variants: [], process_group_ids: []
})

const editingId = ref(null)
const isEditing = ref(false)
const productSearch = ref('')

// Ğ¢Ğ¸Ğ¼Ñ‡Ğ°ÑĞ¾Ğ²Ñ– Ğ·Ğ¼Ñ–Ğ½Ğ½Ñ–
const tempProductConsumable = ref({ consumable_id: "", quantity: 1 })
const tempVariantConsumable = ref({ consumable_id: "", quantity: 1 })
const tempVariantIngredient = ref({ ingredient_id: "", quantity: 0 })

const variantBuilder = ref({
    name: '', price: 0, master_recipe_id: null, 
    output_weight: 0, stock_quantity: 0, 
    consumables: [], ingredients: []
})

export function useProducts() {
    // ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ğ´Ğ°Ğ½Ñ–. Ğ¯ĞºÑ‰Ğ¾ useWarehouse Ğ¿Ğ¾Ğ²ĞµÑ€Ğ½Ğµ undefined, Ğ¼Ğ¸ Ñ†Ğµ Ğ¾Ğ±Ñ€Ğ¾Ğ±Ğ¸Ğ¼Ğ¾ Ğ½Ğ¸Ğ¶Ñ‡Ğµ.
    const warehouseData = useWarehouse()
    
    // Ğ‘ĞµĞ·Ğ¿ĞµÑ‡Ğ½Ğµ Ğ²Ğ¸Ñ‚ÑĞ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ·Ğ¼Ñ–Ğ½Ğ½Ğ¸Ñ… (Ğ· Ğ´ĞµÑ„Ğ¾Ğ»Ñ‚Ğ½Ğ¸Ğ¼Ğ¸ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ½ÑĞ¼Ğ¸)
    const products = warehouseData?.products || ref([])
    const consumables = warehouseData?.consumables || ref([])
    const ingredients = warehouseData?.ingredients || ref([])
    const fetchWarehouseData = warehouseData?.fetchWarehouseData || (async () => {})

    // --- Computed: Ğ‘ĞµĞ·Ğ¿ĞµÑ‡Ğ½Ğ° Ñ„Ñ–Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ñ–Ñ ---
    const filteredProducts = computed(() => {
        // !!! ĞĞ¡Ğ¬ Ğ¢Ğ£Ğ¢ Ğ‘Ğ£Ğ›Ğ ĞŸĞĞœĞ˜Ğ›ĞšĞ. Ğ¢Ğ•ĞŸĞ•Ğ  ĞœĞ˜ ĞŸĞ•Ğ Ğ•Ğ’Ğ†Ğ Ğ¯Ğ„ĞœĞ Ğ’Ğ¡Ğ• !!!
        if (!products || !products.value || !Array.isArray(products.value)) {
            return []
        }

        if (!productSearch.value) return products.value
        
        const q = productSearch.value.toLowerCase()
        return products.value.filter(p => 
            p.name && p.name.toLowerCase().includes(q)
        )
    })

    // --- API: Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ ---
    const fetchProducts = async () => {
        try {
            await fetchWarehouseData()
        } catch (e) {
            console.error("ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ– ÑĞºĞ»Ğ°Ğ´Ñƒ:", e)
        }
    }

    // --- API: Ğ—Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ½Ñ ---
    const saveProduct = async () => {
        if (!newProduct.value.name) return alert("Ğ’ĞºĞ°Ğ¶Ñ–Ñ‚ÑŒ Ğ½Ğ°Ğ·Ğ²Ñƒ!")
        
        const payload = {
            ...newProduct.value,
            category_id: newProduct.value.category_id || null,
            master_recipe_id: newProduct.value.master_recipe_id || null,
            price: newProduct.value.has_variants ? 0 : newProduct.value.price
        }

        try {
            const url = isEditing.value 
                ? `http://localhost:8001/products/${editingId.value}`
                : 'http://localhost:8001/products/'
            const method = isEditing.value ? 'put' : 'post'

            await axios[method](url, payload)
            await fetchProducts()
            resetForm()
            return true
        } catch (err) {
            console.error(err)
            alert("ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ·Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ½Ñ. Ğ”Ğ¸Ğ². ĞºĞ¾Ğ½ÑĞ¾Ğ»ÑŒ.")
            return false
        }
    }

    // --- API: Ğ’Ğ¸Ğ´Ğ°Ğ»ĞµĞ½Ğ½Ñ ---
    const deleteProduct = async (id) => {
        if(!confirm("Ğ’Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğ¸?")) return
        try {
            await axios.delete(`http://localhost:8001/products/${id}`)
            await fetchProducts()
        } catch(e) { alert("ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ²Ğ¸Ğ´Ğ°Ğ»ĞµĞ½Ğ½Ñ") }
    }

    // --- Ğ¥ĞµĞ»Ğ¿ĞµÑ€Ğ¸ ---
    const resetForm = () => {
        isEditing.value = false
        editingId.value = null
        newProduct.value = {
            name: '', category_id: null, price: 0, has_variants: false,
            master_recipe_id: null, output_weight: 0,
            track_stock: false, stock_quantity: 0,
            consumables: [], variants: [], process_group_ids: []
        }
        variantBuilder.value = { name: '', price: 0, master_recipe_id: null, output_weight: 0, stock_quantity: 0, consumables: [], ingredients: [] }
    }

    const prepareEdit = (p) => {
        isEditing.value = true
        editingId.value = p.id
        const copy = JSON.parse(JSON.stringify(p))
        
        // ĞœĞ°Ğ¿Ğ¸Ğ½Ğ³ Ğ¿Ğ¾Ğ»Ñ–Ğ² Ğ´Ğ»Ñ Ñ„Ğ¾Ñ€Ğ¼Ğ¸
        if (copy.variants) {
            copy.variants.forEach(v => {
                if(v.consumables) v.consumables.forEach(c => c.name = c.consumable_name || c.name)
                if(v.ingredients) v.ingredients.forEach(i => i.name = i.ingredient_name || i.name)
            })
        }
        if (copy.consumables) {
            copy.consumables.forEach(c => c.name = c.consumable_name || c.name)
        }
        
        newProduct.value = copy
    }

    // --- Ğ›Ğ¾Ğ³Ñ–ĞºĞ° Ğ´Ğ¾Ğ´Ğ°Ğ²Ğ°Ğ½Ğ½Ñ (Adders) ---
    const addVariant = () => {
        if(!variantBuilder.value.name) return alert("Ğ’ĞºĞ°Ğ¶Ñ–Ñ‚ÑŒ Ğ½Ğ°Ğ·Ğ²Ñƒ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ")
        newProduct.value.variants.push(JSON.parse(JSON.stringify(variantBuilder.value)))
        variantBuilder.value = { name: '', price: 0, master_recipe_id: null, output_weight: 0, stock_quantity: 0, consumables: [], ingredients: [] }
    }
    const removeVariant = (i) => newProduct.value.variants.splice(i, 1)

    const addProductConsumable = () => {
        if(!tempProductConsumable.value.consumable_id) return
        const c = consumables.value.find(x => x.id === tempProductConsumable.value.consumable_id)
        newProduct.value.consumables.push({ ...tempProductConsumable.value, name: c?.name || '???' })
        tempProductConsumable.value.quantity = 1
    }
    const removeProductConsumable = (i) => newProduct.value.consumables.splice(i, 1)

    const addVariantConsumable = () => {
        if(!tempVariantConsumable.value.consumable_id) return
        const c = consumables.value.find(x => x.id === tempVariantConsumable.value.consumable_id)
        variantBuilder.value.consumables.push({ ...tempVariantConsumable.value, name: c?.name || '???' })
        tempVariantConsumable.value.quantity = 1
    }
    const removeVariantConsumable = (i) => variantBuilder.value.consumables.splice(i, 1)

    const addIngredientToVariant = () => {
        if(!tempVariantIngredient.value.ingredient_id) return
        const i = ingredients.value.find(x => x.id === tempVariantIngredient.value.ingredient_id)
        variantBuilder.value.ingredients.push({ ...tempVariantIngredient.value, name: i?.name || '???' })
        tempVariantIngredient.value.quantity = 0
    }
    const removeIngredientFromVariant = (i) => variantBuilder.value.ingredients.splice(i, 1)

    return {
        newProduct, isEditing, editingId, productSearch, filteredProducts,
        variantBuilder, tempProductConsumable, tempVariantConsumable, tempVariantIngredient,
        fetchProducts, saveProduct, deleteProduct, resetForm, prepareEdit,
        addVariant, removeVariant,
        addProductConsumable, removeProductConsumable,
        addVariantConsumable, removeVariantConsumable,
        addIngredientToVariant, removeIngredientFromVariant
    }
}

--------------------------------------------------
PATH: ./.history/frontend/src/composables/useProducts_20260124195040.js
--------------------------------------------------
import { ref, computed } from 'vue'
import axios from 'axios'
import { useWarehouse } from '@/composables/useWarehouse'

// Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ¸Ğ¹ ÑÑ‚Ğ°Ğ½ Ğ´Ğ»Ñ Ñ„Ğ¾Ñ€Ğ¼Ğ¸ (Ñ‰Ğ¾Ğ± Ğ½Ğµ Ğ·Ğ½Ğ¸ĞºĞ°Ğ² Ğ¿Ñ€Ğ¸ Ğ¿ĞµÑ€ĞµĞ¼Ğ¸ĞºĞ°Ğ½Ğ½Ñ– Ğ²ĞºĞ»Ğ°Ğ´Ğ¾Ğº)
const newProduct = ref({
    name: '', category_id: null, price: 0, has_variants: false,
    master_recipe_id: null, output_weight: 0,
    track_stock: false, stock_quantity: 0,
    consumables: [], variants: [], process_group_ids: []
})

const editingId = ref(null)
const isEditing = ref(false)
const productSearch = ref('')

// Ğ¢Ğ¸Ğ¼Ñ‡Ğ°ÑĞ¾Ğ²Ñ– Ğ·Ğ¼Ñ–Ğ½Ğ½Ñ– Ğ´Ğ»Ñ Ğ±Ñ–Ğ»Ğ´ĞµÑ€Ñ–Ğ²
const tempProductConsumable = ref({ consumable_id: "", quantity: 1 })
const tempVariantConsumable = ref({ consumable_id: "", quantity: 1 })
const tempVariantIngredient = ref({ ingredient_id: "", quantity: 0 })

const variantBuilder = ref({
    name: '', price: 0, master_recipe_id: null, 
    output_weight: 0, stock_quantity: 0, 
    consumables: [], ingredients: []
})

export function useProducts() {
    // 1. ĞŸÑ–Ğ´ĞºĞ»ÑÑ‡Ğ°Ñ”Ğ¼Ğ¾ÑÑŒ Ğ´Ğ¾ Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ ÑĞºĞ»Ğ°Ğ´Ñƒ
    const warehouse = useWarehouse()
    
    // 2. Ğ‘ĞµĞ·Ğ¿ĞµÑ‡Ğ½Ğ¾ Ğ²Ğ¸Ñ‚ÑĞ³ÑƒÑ”Ğ¼Ğ¾ Ğ´Ğ°Ğ½Ñ– (Ñ–Ğ· Ğ·Ğ°Ñ…Ğ¸ÑÑ‚Ğ¾Ğ¼ Ğ²Ñ–Ğ´ Ğ¿Ğ¾Ğ¼Ğ¸Ğ»Ğ¾Ğº)
    const products = warehouse?.products || ref([])
    const consumables = warehouse?.consumables || ref([])
    const ingredients = warehouse?.ingredients || ref([])
    const fetchWarehouseData = warehouse?.fetchWarehouseData || (async ()=>{})

    // 3. Computed Ğ´Ğ»Ñ Ğ¿Ğ¾ÑˆÑƒĞºÑƒ (Ğ“Ğ¾Ğ»Ğ¾Ğ²Ğ½Ğ° Ğ¿Ñ€Ğ¸Ñ‡Ğ¸Ğ½Ğ° Ğ¿ÑƒÑÑ‚Ğ¾Ñ— Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ– Ğ²Ğ¸Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ° Ñ‚ÑƒÑ‚)
    const filteredProducts = computed(() => {
        if (!products.value || !Array.isArray(products.value)) return []
        if (!productSearch.value) return products.value
        
        const q = productSearch.value.toLowerCase()
        return products.value.filter(p => p.name.toLowerCase().includes(q))
    })

    // --- Actions ---
    
    // Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ´Ğ°Ğ½Ğ¸Ñ… (Ğ²Ğ¸ĞºĞ»Ğ¸ĞºĞ°Ñ” warehouse)
    const fetchProducts = async () => {
        await fetchWarehouseData()
    }

    // Ğ—Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ½Ñ
    const saveProduct = async () => {
        if (!newProduct.value.name) return alert("Ğ’ĞºĞ°Ğ¶Ñ–Ñ‚ÑŒ Ğ½Ğ°Ğ·Ğ²Ñƒ!")
        
        const payload = {
            ...newProduct.value,
            category_id: newProduct.value.category_id || null,
            master_recipe_id: newProduct.value.master_recipe_id || null,
            price: newProduct.value.has_variants ? 0 : newProduct.value.price
        }

        try {
            const url = isEditing.value 
                ? `http://localhost:8001/products/${editingId.value}`
                : 'http://localhost:8001/products/'
            const method = isEditing.value ? 'put' : 'post'

            await axios[method](url, payload)
            await fetchProducts() // ĞĞ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ¾Ğ´Ñ€Ğ°Ğ·Ñƒ
            resetForm()
            return true
        } catch (err) {
            console.error(err)
            alert("ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ·Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ½Ñ. ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€Ñ‚Ğµ ĞºĞ¾Ğ½ÑĞ¾Ğ»ÑŒ.")
            return false
        }
    }

    const deleteProduct = async (id) => {
        if(!confirm("Ğ’Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğ¸?")) return
        try {
            await axios.delete(`http://localhost:8001/products/${id}`)
            await fetchProducts()
        } catch(e) { alert("ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ²Ğ¸Ğ´Ğ°Ğ»ĞµĞ½Ğ½Ñ") }
    }

    // --- Helpers ---
    const resetForm = () => {
        isEditing.value = false
        editingId.value = null
        newProduct.value = {
            name: '', category_id: null, price: 0, has_variants: false,
            master_recipe_id: null, output_weight: 0,
            track_stock: false, stock_quantity: 0,
            consumables: [], variants: [], process_group_ids: []
        }
        variantBuilder.value = { name: '', price: 0, master_recipe_id: null, output_weight: 0, stock_quantity: 0, consumables: [], ingredients: [] }
    }

    const prepareEdit = (p) => {
        isEditing.value = true
        editingId.value = p.id
        const copy = JSON.parse(JSON.stringify(p))
        
        // ĞœĞ°Ğ¿Ğ¸Ğ½Ğ³ Ğ½Ğ°Ğ·Ğ² Ğ´Ğ»Ñ ĞºÑ€Ğ°ÑĞ¸Ğ²Ğ¾Ğ³Ğ¾ Ğ²Ñ–Ğ´Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ² Ñ„Ğ¾Ñ€Ğ¼Ñ–
        if (copy.variants) {
            copy.variants.forEach(v => {
                if(v.consumables) v.consumables.forEach(c => c.name = c.consumable_name || c.name)
                if(v.ingredients) v.ingredients.forEach(i => i.name = i.ingredient_name || i.name)
            })
        }
        if (copy.consumables) copy.consumables.forEach(c => c.name = c.consumable_name || c.name)
        newProduct.value = copy
    }

    // --- Adders / Removers ---
    const addVariant = () => {
        if(!variantBuilder.value.name) return alert("Ğ’ĞºĞ°Ğ¶Ñ–Ñ‚ÑŒ Ğ½Ğ°Ğ·Ğ²Ñƒ")
        newProduct.value.variants.push(JSON.parse(JSON.stringify(variantBuilder.value)))
        variantBuilder.value = { name: '', price: 0, master_recipe_id: null, output_weight: 0, stock_quantity: 0, consumables: [], ingredients: [] }
    }
    const removeVariant = (i) => newProduct.value.variants.splice(i, 1)

    const addProductConsumable = () => {
        if(!tempProductConsumable.value.consumable_id) return
        const c = consumables.value.find(x => x.id === tempProductConsumable.value.consumable_id)
        newProduct.value.consumables.push({ ...tempProductConsumable.value, name: c?.name || '???' })
        tempProductConsumable.value.quantity = 1
    }
    const removeProductConsumable = (i) => newProduct.value.consumables.splice(i, 1)

    const addVariantConsumable = () => {
        if(!tempVariantConsumable.value.consumable_id) return
        const c = consumables.value.find(x => x.id === tempVariantConsumable.value.consumable_id)
        variantBuilder.value.consumables.push({ ...tempVariantConsumable.value, name: c?.name || '???' })
        tempVariantConsumable.value.quantity = 1
    }
    const removeVariantConsumable = (i) => variantBuilder.value.consumables.splice(i, 1)

    const addIngredientToVariant = () => {
        if(!tempVariantIngredient.value.ingredient_id) return
        const i = ingredients.value.find(x => x.id === tempVariantIngredient.value.ingredient_id)
        variantBuilder.value.ingredients.push({ ...tempVariantIngredient.value, name: i?.name || '???' })
        tempVariantIngredient.value.quantity = 0
    }
    const removeIngredientFromVariant = (i) => variantBuilder.value.ingredients.splice(i, 1)

    return {
        newProduct, isEditing, editingId, productSearch, filteredProducts,
        variantBuilder, tempProductConsumable, tempVariantConsumable, tempVariantIngredient,
        fetchProducts, saveProduct, deleteProduct, resetForm, prepareEdit,
        addVariant, removeVariant,
        addProductConsumable, removeProductConsumable,
        addVariantConsumable, removeVariantConsumable,
        addIngredientToVariant, removeIngredientFromVariant
    }
}

--------------------------------------------------
PATH: ./.history/frontend/src/composables/useProducts_20260124201408.js
--------------------------------------------------
import { ref, computed } from 'vue'
import axios from 'axios'
import { useWarehouse } from '@/composables/useWarehouse'

const newProduct = ref({
    name: '', category_id: null, price: 0, has_variants: false,
    master_recipe_id: null, output_weight: 0,
    track_stock: false, stock_quantity: 0,
    consumables: [], variants: [], process_group_ids: []
})

const editingId = ref(null)
const isEditing = ref(false)
const productSearch = ref('')

// Ğ¢Ğ¸Ğ¼Ñ‡Ğ°ÑĞ¾Ğ²Ñ– Ğ·Ğ¼Ñ–Ğ½Ğ½Ñ–
const tempProductConsumable = ref({ consumable_id: "", quantity: 1 })
const tempVariantConsumable = ref({ consumable_id: "", quantity: 1 })
const tempVariantIngredient = ref({ ingredient_id: "", quantity: 0 })

const variantBuilder = ref({
    name: '', price: 0, master_recipe_id: null, 
    output_weight: 0, stock_quantity: 0, 
    consumables: [], ingredients: []
})

export function useProducts() {
    const warehouse = useWarehouse()
    const products = warehouse?.products || ref([])
    const consumables = warehouse?.consumables || ref([])
    const ingredients = warehouse?.ingredients || ref([])
    const fetchWarehouseData = warehouse?.fetchWarehouseData || (async ()=>{})

    const filteredProducts = computed(() => {
        if (!products.value) return []
        if (!productSearch.value) return products.value
        return products.value.filter(p => p.name.toLowerCase().includes(productSearch.value.toLowerCase()))
    })

    const fetchProducts = async () => { await fetchWarehouseData() }

    // --- Ğ“ĞĞ›ĞĞ’ĞĞ• Ğ’Ğ˜ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞĞ¯ Ğ¢Ğ£Ğ¢ ---
    const saveProduct = async () => {
        if (!newProduct.value.name) return alert("Ğ’ĞºĞ°Ğ¶Ñ–Ñ‚ÑŒ Ğ½Ğ°Ğ·Ğ²Ñƒ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ!")
        
        // 1. Ğ¡Ğ°Ğ½Ñ–Ñ‚Ğ¸Ğ·Ğ°Ñ†Ñ–Ñ Ğ´Ğ°Ğ½Ğ¸Ñ… (Clean Data)
        // ĞœĞ¸ Ğ³Ğ°Ñ€Ğ°Ğ½Ñ‚ÑƒÑ”Ğ¼Ğ¾, Ñ‰Ğ¾ Ñ‡Ğ¸ÑĞ»Ğ° Ğ±ÑƒĞ´ÑƒÑ‚ÑŒ Ñ‡Ğ¸ÑĞ»Ğ°Ğ¼Ğ¸, Ğ° Ğ½Ğµ Ğ¿ÑƒÑÑ‚Ğ¸Ğ¼Ğ¸ Ñ€ÑĞ´ĞºĞ°Ğ¼Ğ¸
        const cleanPrice = newProduct.value.has_variants ? 0 : (parseFloat(newProduct.value.price) || 0)
        const cleanWeight = parseFloat(newProduct.value.output_weight) || 0
        const cleanStock = parseFloat(newProduct.value.stock_quantity) || 0
        
        // 2. Ğ¤Ğ¾Ñ€Ğ¼ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ¿Ğ°ĞºĞµÑ‚Ñƒ Ğ´Ğ°Ğ½Ğ¸Ñ…
        const payload = {
            ...newProduct.value,
            category_id: newProduct.value.category_id || null,
            master_recipe_id: newProduct.value.master_recipe_id || null,
            price: cleanPrice,
            output_weight: cleanWeight,
            stock_quantity: cleanStock,
            // Ğ¯ĞºÑ‰Ğ¾ Ñ†Ğµ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¸Ğ¹ Ñ‚Ğ¾Ğ²Ğ°Ñ€ - Ğ¾Ğ±Ñ€Ñ–Ğ·Ğ°Ñ”Ğ¼Ğ¾ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸, Ñ‰Ğ¾Ğ± Ğ½Ğµ Ğ¿Ğ»ÑƒÑ‚Ğ°Ñ‚Ğ¸ Ğ±ĞµĞºĞµĞ½Ğ´
            variants: newProduct.value.has_variants ? newProduct.value.variants : [] 
        }

        console.log("ğŸ“¤ Ğ’Ñ–Ğ´Ğ¿Ñ€Ğ°Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€:", payload) // Ğ”Ğ»Ñ Ğ´ĞµĞ±Ğ°Ğ³Ñƒ Ğ² ĞºĞ¾Ğ½ÑĞ¾Ğ»Ñ–

        try {
            const url = isEditing.value 
                ? `http://localhost:8001/products/${editingId.value}`
                : 'http://localhost:8001/products/'
            const method = isEditing.value ? 'put' : 'post'

            const res = await axios[method](url, payload)
            console.log("âœ… Ğ£ÑĞ¿Ñ–Ñ…:", res.data)
            
            await fetchProducts()
            resetForm()
            return true
        } catch (err) {
            console.error("âŒ ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ·Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ½Ñ:", err)
            // Ğ’Ğ¸Ğ²Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ Ğ´ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ñƒ Ğ¿Ğ¾Ğ¼Ğ¸Ğ»ĞºÑƒ, ÑĞºÑ‰Ğ¾ Ğ²Ğ¾Ğ½Ğ° Ğ¿Ñ€Ğ¸Ğ¹ÑˆĞ»Ğ° Ğ· Ğ±ĞµĞºĞµĞ½Ğ´Ñƒ
            if (err.response && err.response.data) {
                console.error("Ğ”ĞµÑ‚Ğ°Ğ»Ñ– ÑĞµÑ€Ğ²ĞµÑ€Ğ°:", err.response.data)
                alert(`ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° ÑĞµÑ€Ğ²ĞµÑ€Ğ°: ${JSON.stringify(err.response.data.detail || 'ĞĞµĞ²Ñ–Ğ´Ğ¾Ğ¼Ğ° Ğ¿Ğ¾Ğ¼Ğ¸Ğ»ĞºĞ°')}`)
            } else {
                alert("ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ¼ĞµÑ€ĞµĞ¶Ñ– Ğ°Ğ±Ğ¾ ĞºĞ¾Ğ´Ñƒ. Ğ”Ğ¸Ğ². ĞºĞ¾Ğ½ÑĞ¾Ğ»ÑŒ.")
            }
            return false
        }
    }

    const deleteProduct = async (id) => {
        if(!confirm("Ğ’Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğ¸?")) return
        try {
            await axios.delete(`http://localhost:8001/products/${id}`)
            await fetchProducts()
        } catch(e) { alert("ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ²Ğ¸Ğ´Ğ°Ğ»ĞµĞ½Ğ½Ñ") }
    }

    const resetForm = () => {
        isEditing.value = false
        editingId.value = null
        newProduct.value = {
            name: '', category_id: null, price: 0, has_variants: false,
            master_recipe_id: null, output_weight: 0,
            track_stock: false, stock_quantity: 0,
            consumables: [], variants: [], process_group_ids: []
        }
        variantBuilder.value = { name: '', price: 0, master_recipe_id: null, output_weight: 0, stock_quantity: 0, consumables: [], ingredients: [] }
    }

    const prepareEdit = (p) => {
        isEditing.value = true
        editingId.value = p.id
        const copy = JSON.parse(JSON.stringify(p))
        if (copy.variants) {
            copy.variants.forEach(v => {
                if(v.consumables) v.consumables.forEach(c => c.name = c.consumable_name || c.name)
                if(v.ingredients) v.ingredients.forEach(i => i.name = i.ingredient_name || i.name)
            })
        }
        if (copy.consumables) copy.consumables.forEach(c => c.name = c.consumable_name || c.name)
        newProduct.value = copy
    }

    const addVariant = () => {
        if(!variantBuilder.value.name) return alert("Ğ’ĞºĞ°Ğ¶Ñ–Ñ‚ÑŒ Ğ½Ğ°Ğ·Ğ²Ñƒ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ")
        newProduct.value.variants.push(JSON.parse(JSON.stringify(variantBuilder.value)))
        variantBuilder.value = { name: '', price: 0, master_recipe_id: null, output_weight: 0, stock_quantity: 0, consumables: [], ingredients: [] }
    }
    const removeVariant = (i) => newProduct.value.variants.splice(i, 1)

    const addProductConsumable = () => {
        if(!tempProductConsumable.value.consumable_id) return
        const c = consumables.value.find(x => x.id === tempProductConsumable.value.consumable_id)
        newProduct.value.consumables.push({ ...tempProductConsumable.value, name: c?.name || '???' })
        tempProductConsumable.value.quantity = 1
    }
    const removeProductConsumable = (i) => newProduct.value.consumables.splice(i, 1)

    const addVariantConsumable = () => {
        if(!tempVariantConsumable.value.consumable_id) return
        const c = consumables.value.find(x => x.id === tempVariantConsumable.value.consumable_id)
        variantBuilder.value.consumables.push({ ...tempVariantConsumable.value, name: c?.name || '???' })
        tempVariantConsumable.value.quantity = 1
    }
    const removeVariantConsumable = (i) => variantBuilder.value.consumables.splice(i, 1)

    const addIngredientToVariant = () => {
        if(!tempVariantIngredient.value.ingredient_id) return
        const i = ingredients.value.find(x => x.id === tempVariantIngredient.value.ingredient_id)
        variantBuilder.value.ingredients.push({ ...tempVariantIngredient.value, name: i?.name || '???' })
        tempVariantIngredient.value.quantity = 0
    }
    const removeIngredientFromVariant = (i) => variantBuilder.value.ingredients.splice(i, 1)

    return {
        newProduct, isEditing, editingId, productSearch, filteredProducts,
        variantBuilder, tempProductConsumable, tempVariantConsumable, tempVariantIngredient,
        fetchProducts, saveProduct, deleteProduct, resetForm, prepareEdit,
        addVariant, removeVariant,
        addProductConsumable, removeProductConsumable,
        addVariantConsumable, removeVariantConsumable,
        addIngredientToVariant, removeIngredientFromVariant
    }
}

--------------------------------------------------
PATH: ./.history/frontend/src/composables/useWarehouse_20260123212512.js
--------------------------------------------------
import { ref } from 'vue'
import axios from 'axios'

// Ğ’Ğ¸Ğ½Ğ¾ÑĞ¸Ğ¼Ğ¾ Ğ·Ğ¼Ñ–Ğ½Ğ½Ñ– Ğ·Ğ° Ğ¼ĞµĞ¶Ñ– Ñ„ÑƒĞ½ĞºÑ†Ñ–Ñ—, Ñ‰Ğ¾Ğ± Ğ²Ğ¾Ğ½Ğ¸ Ğ±ÑƒĞ»Ğ¸ singleton (ÑĞ¿Ñ–Ğ»ÑŒĞ½Ñ– Ğ´Ğ»Ñ Ğ²ÑÑŒĞ¾Ğ³Ğ¾ Ğ´Ğ¾Ğ´Ğ°Ñ‚ĞºÑƒ)
const products = ref([])
const categories = ref([])
const units = ref([])
const ingredients = ref([])
const consumables = ref([])
const recipes = ref([])
const processGroups = ref([])

export function useWarehouse() {
    const fetchWarehouseData = async () => {
        try {
            // Ğ’Ğ¸ĞºĞ¾Ğ½ÑƒÑ”Ğ¼Ğ¾ Ğ·Ğ°Ğ¿Ğ¸Ñ‚Ğ¸ Ğ¿Ğ°Ñ€Ğ°Ğ»ĞµĞ»ÑŒĞ½Ğ¾ Ğ´Ğ»Ñ ÑˆĞ²Ğ¸Ğ´ĞºĞ¾ÑÑ‚Ñ–
            const [
                productsRes, 
                categoriesRes, 
                unitsRes, 
                ingredientsRes, 
                consumablesRes, 
                recipesRes,
                processGroupsRes
            ] = await Promise.all([
                axios.get('http://localhost:8001/products/'),
                axios.get('http://localhost:8001/categories/'),
                axios.get('http://localhost:8001/inventory/units/'),
                axios.get('http://localhost:8001/inventory/ingredients/'),
                axios.get('http://localhost:8001/inventory/consumables/'),
                axios.get('http://localhost:8001/recipes/'),
                axios.get('http://localhost:8001/process-groups/')
            ])

            products.value = productsRes.data
            categories.value = categoriesRes.data
            units.value = unitsRes.data
            ingredients.value = ingredientsRes.data
            consumables.value = consumablesRes.data
            recipes.value = recipesRes.data
            processGroups.value = processGroupsRes.data

        } catch (err) {
            console.error("Global Warehouse Fetch Error:", err)
        }
    }

    return {
        products,
        categories,
        units,
        ingredients,
        consumables,
        recipes,
        processGroups,
        fetchWarehouseData
    }
}

--------------------------------------------------
PATH: ./.history/frontend/src/composables/useWarehouse_20260123213838.js
--------------------------------------------------
import { ref } from 'vue'
import axios from 'axios'

// Ğ’Ğ¸Ğ½Ğ¾ÑĞ¸Ğ¼Ğ¾ Ğ·Ğ¼Ñ–Ğ½Ğ½Ñ– Ğ·Ğ° Ğ¼ĞµĞ¶Ñ– Ñ„ÑƒĞ½ĞºÑ†Ñ–Ñ—, Ñ‰Ğ¾Ğ± Ğ²Ğ¾Ğ½Ğ¸ Ğ±ÑƒĞ»Ğ¸ singleton (ÑĞ¿Ñ–Ğ»ÑŒĞ½Ñ– Ğ´Ğ»Ñ Ğ²ÑÑŒĞ¾Ğ³Ğ¾ Ğ´Ğ¾Ğ´Ğ°Ñ‚ĞºÑƒ)
const products = ref([])
const categories = ref([])
const units = ref([])
const ingredients = ref([])
const consumables = ref([])
const recipes = ref([])
const processGroups = ref([])

export function useWarehouse() {
    const fetchWarehouseData = async () => {
        try {
            // Ğ’Ğ¸ĞºĞ¾Ğ½ÑƒÑ”Ğ¼Ğ¾ Ğ·Ğ°Ğ¿Ğ¸Ñ‚Ğ¸ Ğ¿Ğ°Ñ€Ğ°Ğ»ĞµĞ»ÑŒĞ½Ğ¾ Ğ´Ğ»Ñ ÑˆĞ²Ğ¸Ğ´ĞºĞ¾ÑÑ‚Ñ–
            const [
                productsRes, 
                categoriesRes, 
                unitsRes, 
                ingredientsRes, 
                consumablesRes, 
                recipesRes,
                processGroupsRes
            ] = await Promise.all([
                axios.get('http://localhost:8001/products/'),
                axios.get('http://localhost:8001/categories/'),
                axios.get('http://localhost:8001/inventory/units/'),
                axios.get('http://localhost:8001/inventory/ingredients/'),
                axios.get('http://localhost:8001/inventory/consumables/'),
                axios.get('http://localhost:8001/recipes/'),
                axios.get('http://localhost:8001/process-groups/')
            ])

            products.value = productsRes.data
            categories.value = categoriesRes.data
            units.value = unitsRes.data
            ingredients.value = ingredientsRes.data
            consumables.value = consumablesRes.data
            recipes.value = recipesRes.data
            processGroups.value = processGroupsRes.data

        } catch (err) {
            console.error("Global Warehouse Fetch Error:", err)
        }
    }

    return {
        products,
        categories,
        units,
        ingredients,
        consumables,
        recipes,
        processGroups,
        fetchWarehouseData
    }
}

--------------------------------------------------
PATH: ./.history/frontend/src/composables/useWarehouse_20260124222845.js
--------------------------------------------------
import { ref } from 'vue'

// Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ¸Ğ¹ ÑÑ‚Ğ°Ğ½
const products = ref([]) // <--- 1. Ğ”ĞĞ”ĞĞĞ: Ğ¡Ñ…Ğ¾Ğ²Ğ¸Ñ‰Ğµ Ğ´Ğ»Ñ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ–Ğ²
const categories = ref([])
const units = ref([])
const ingredients = ref([])
const consumables = ref([])
const processGroups = ref([])
const recipes = ref([])
const loading = ref(false)

export function useWarehouse() {

  // ĞŸĞµÑ€ĞµĞ¹Ğ¼ĞµĞ½ÑƒĞ²Ğ°Ğ»Ğ¸ Ğ½Ğ° fetchWarehouseData Ğ´Ğ»Ñ ÑÑƒĞ¼Ñ–ÑĞ½Ğ¾ÑÑ‚Ñ– Ğ· ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ°Ğ¼Ğ¸
  const fetchWarehouseData = async () => {
    loading.value = true
    
    // Ğ¤ÑƒĞ½ĞºÑ†Ñ–Ñ Ğ±ĞµĞ·Ğ¿ĞµÑ‡Ğ½Ğ¾Ğ³Ğ¾ Ğ·Ğ°Ğ¿Ğ¸Ñ‚Ñƒ
    const safeFetch = async (url) => {
      try {
        const res = await fetch(url)
        return res.ok ? await res.json() : []
      } catch (e) { 
        console.error(`Error fetching ${url}:`, e)
        return [] 
      }
    }

    console.log("ğŸ”„ Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ´Ğ°Ğ½Ğ¸Ñ… ÑĞºĞ»Ğ°Ğ´Ñƒ...")

    // ĞŸĞ°Ñ€Ğ°Ğ»ĞµĞ»ÑŒĞ½Ğµ Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ²ÑÑ–Ñ… Ğ´Ğ¾Ğ²Ñ–Ğ´Ğ½Ğ¸ĞºÑ–Ğ² + Ğ¢ĞĞ’ĞĞ Ğ†Ğ’
    const results = await Promise.all([
      safeFetch('/api/categories/'),
      safeFetch('/api/units/'),
      safeFetch('/api/ingredients/'),
      safeFetch('/api/consumables/'),
      safeFetch('/api/processes/groups/'),
      safeFetch('/api/recipes/'),
      safeFetch('/api/products/') // <--- 2. Ğ”ĞĞ”ĞĞĞ: Ğ—Ğ°Ğ¿Ğ¸Ñ‚ Ğ½Ğ° Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¸
    ])

    // Ğ Ğ¾Ğ·Ğ¿Ğ¾Ğ´Ñ–Ğ»ÑÑ”Ğ¼Ğ¾ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¸
    categories.value = results[0]
    units.value = results[1]
    ingredients.value = results[2]
    consumables.value = results[3]
    processGroups.value = results[4]
    recipes.value = results[5]
    products.value = results[6] // <--- 3. Ğ”ĞĞ”ĞĞĞ: Ğ—Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ½Ñ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ–Ğ²

    console.log(`âœ… Ğ”Ğ°Ğ½Ñ– Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾. Ğ¢Ğ¾Ğ²Ğ°Ñ€Ñ–Ğ²: ${products.value.length}`)
    
    loading.value = false
  }

  // Ğ£Ğ½Ñ–Ğ²ĞµÑ€ÑĞ°Ğ»ÑŒĞ½Ğ° Ñ„ÑƒĞ½ĞºÑ†Ñ–Ñ ÑÑ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ½Ñ
  const createItem = async (url, payload, refreshFn = fetchWarehouseData) => {
    try {
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
      if (res.ok) {
        await refreshFn() // ĞĞ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ ÑĞ¿Ğ¸ÑĞºĞ¸
        return true
      }
      const err = await res.json()
      alert("ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ°: " + (err.detail || "ĞĞµ Ğ²Ğ´Ğ°Ğ»Ğ¾ÑÑ ÑÑ‚Ğ²Ğ¾Ñ€Ğ¸Ñ‚Ğ¸"))
      return false
    } catch (e) { 
      console.error(e)
      return false 
    }
  }

  // Ğ£Ğ½Ñ–Ğ²ĞµÑ€ÑĞ°Ğ»ÑŒĞ½Ğ° Ñ„ÑƒĞ½ĞºÑ†Ñ–Ñ Ğ²Ğ¸Ğ´Ğ°Ğ»ĞµĞ½Ğ½Ñ
  const deleteItem = async (url, refreshFn = fetchWarehouseData) => {
    if(!confirm("Ğ’Ğ¸ Ğ²Ğ¿ĞµĞ²Ğ½ĞµĞ½Ñ–, Ñ‰Ğ¾ Ñ…Ğ¾Ñ‡ĞµÑ‚Ğµ Ğ²Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğ¸ Ñ†Ğµ?")) return
    try {
      await fetch(url, { method: 'DELETE' })
      await refreshFn()
    } catch (e) { console.error(e) }
  }

  // Ğ£Ğ½Ñ–Ğ²ĞµÑ€ÑĞ°Ğ»ÑŒĞ½Ğ° Ñ„ÑƒĞ½ĞºÑ†Ñ–Ñ Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ (PUT)
  const updateItem = async (url, payload, refreshFn = fetchWarehouseData) => {
    try {
      const res = await fetch(url, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
      
      if (res.ok) {
        await refreshFn()
        return true
      }
      
      const err = await res.json()
      alert("ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ: " + (err.detail || "Ğ©Ğ¾ÑÑŒ Ğ¿Ñ–ÑˆĞ»Ğ¾ Ğ½Ğµ Ñ‚Ğ°Ğº"))
      return false
    } catch (e) {
      console.error(e)
      alert("ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ¼ĞµÑ€ĞµĞ¶Ñ–")
      return false
    }
  }

  return {
    // Ğ•ĞºÑĞ¿Ğ¾Ñ€Ñ‚ÑƒÑ”Ğ¼Ğ¾ products
    products, categories, units, ingredients, consumables, processGroups, recipes, loading,
    // Ğ•ĞºÑĞ¿Ğ¾Ñ€Ñ‚ÑƒÑ”Ğ¼Ğ¾ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñƒ Ğ½Ğ°Ğ·Ğ²Ñƒ Ñ„ÑƒĞ½ĞºÑ†Ñ–Ñ—
    fetchWarehouseData, 
    // Ğ—Ğ°Ğ»Ğ¸ÑˆĞ°Ñ”Ğ¼Ğ¾ ÑÑ‚Ğ°Ñ€Ñƒ Ğ½Ğ°Ğ·Ğ²Ñƒ ÑĞº Ğ°Ğ»Ñ–Ğ°Ñ Ğ¿Ñ€Ğ¾ Ğ²ÑÑĞº Ğ²Ğ¸Ğ¿Ğ°Ğ´Ğ¾Ğº
    fetchData: fetchWarehouseData,
    createItem, deleteItem, updateItem
  }
}

--------------------------------------------------
PATH: ./.history/frontend/src/composables/useWarehouse_20260123205302.js
--------------------------------------------------
import { ref } from 'vue'
import axios from 'axios'

// Ğ’Ğ¸Ğ½Ğ¾ÑĞ¸Ğ¼Ğ¾ Ğ·Ğ¼Ñ–Ğ½Ğ½Ñ– Ğ·Ğ° Ğ¼ĞµĞ¶Ñ– Ñ„ÑƒĞ½ĞºÑ†Ñ–Ñ—, Ñ‰Ğ¾Ğ± Ğ²Ğ¾Ğ½Ğ¸ Ğ±ÑƒĞ»Ğ¸ singleton (ÑĞ¿Ñ–Ğ»ÑŒĞ½Ñ– Ğ´Ğ»Ñ Ğ²ÑÑŒĞ¾Ğ³Ğ¾ Ğ´Ğ¾Ğ´Ğ°Ñ‚ĞºÑƒ)
const products = ref([])
const categories = ref([])
const units = ref([])
const ingredients = ref([])
const consumables = ref([])
const recipes = ref([])
const processGroups = ref([])

export function useWarehouse() {
    const fetchWarehouseData = async () => {
        try {
            // Ğ’Ğ¸ĞºĞ¾Ğ½ÑƒÑ”Ğ¼Ğ¾ Ğ·Ğ°Ğ¿Ğ¸Ñ‚Ğ¸ Ğ¿Ğ°Ñ€Ğ°Ğ»ĞµĞ»ÑŒĞ½Ğ¾ Ğ´Ğ»Ñ ÑˆĞ²Ğ¸Ğ´ĞºĞ¾ÑÑ‚Ñ–
            const [
                productsRes, 
                categoriesRes, 
                unitsRes, 
                ingredientsRes, 
                consumablesRes, 
                recipesRes,
                processGroupsRes
            ] = await Promise.all([
                axios.get('http://localhost:8001/products/'),
                axios.get('http://localhost:8001/categories/'),
                axios.get('http://localhost:8001/inventory/units/'),
                axios.get('http://localhost:8001/inventory/ingredients/'),
                axios.get('http://localhost:8001/inventory/consumables/'),
                axios.get('http://localhost:8001/recipes/'),
                axios.get('http://localhost:8001/process-groups/')
            ])

            products.value = productsRes.data
            categories.value = categoriesRes.data
            units.value = unitsRes.data
            ingredients.value = ingredientsRes.data
            consumables.value = consumablesRes.data
            recipes.value = recipesRes.data
            processGroups.value = processGroupsRes.data

        } catch (err) {
            console.error("Global Warehouse Fetch Error:", err)
        }
    }

    return {
        products,
        categories,
        units,
        ingredients,
        consumables,
        recipes,
        processGroups,
        fetchWarehouseData
    }
}

--------------------------------------------------
PATH: ./.history/frontend/src/composables/useProducts_20260123212543.js
--------------------------------------------------
import { ref, computed } from 'vue'
import axios from 'axios'
import { useWarehouse } from '@/composables/useWarehouse'

// --- Ğ“Ğ›ĞĞ‘ĞĞ›Ğ¬ĞĞ˜Ğ™ Ğ¡Ğ¢ĞĞ ---
const newProduct = ref({
    name: '', category_id: null, price: 0, has_variants: false,
    master_recipe_id: null, output_weight: 0,
    track_stock: false, stock_quantity: 0,
    consumables: [], variants: [], process_group_ids: []
})

const editingId = ref(null)
const isEditing = ref(false)
const productSearch = ref('')

// Ğ¢Ğ¸Ğ¼Ñ‡Ğ°ÑĞ¾Ğ²Ñ– Ğ·Ğ¼Ñ–Ğ½Ğ½Ñ–
const tempProductConsumable = ref({ consumable_id: "", quantity: 1 })
const tempVariantConsumable = ref({ consumable_id: "", quantity: 1 })
const tempVariantIngredient = ref({ ingredient_id: "", quantity: 0 })

const variantBuilder = ref({
    name: '', price: 0, master_recipe_id: null, 
    output_weight: 0, stock_quantity: 0, 
    consumables: [], ingredients: []
})

export function useProducts() {
    // ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ğ´Ğ°Ğ½Ñ–. Ğ¯ĞºÑ‰Ğ¾ useWarehouse Ğ¿Ğ¾Ğ²ĞµÑ€Ğ½Ğµ undefined, Ğ¼Ğ¸ Ñ†Ğµ Ğ¾Ğ±Ñ€Ğ¾Ğ±Ğ¸Ğ¼Ğ¾ Ğ½Ğ¸Ğ¶Ñ‡Ğµ.
    const warehouseData = useWarehouse()
    
    // Ğ‘ĞµĞ·Ğ¿ĞµÑ‡Ğ½Ğµ Ğ²Ğ¸Ñ‚ÑĞ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ·Ğ¼Ñ–Ğ½Ğ½Ğ¸Ñ… (Ğ· Ğ´ĞµÑ„Ğ¾Ğ»Ñ‚Ğ½Ğ¸Ğ¼Ğ¸ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ½ÑĞ¼Ğ¸)
    const products = warehouseData?.products || ref([])
    const consumables = warehouseData?.consumables || ref([])
    const ingredients = warehouseData?.ingredients || ref([])
    const fetchWarehouseData = warehouseData?.fetchWarehouseData || (async () => {})

    // --- Computed: Ğ‘ĞµĞ·Ğ¿ĞµÑ‡Ğ½Ğ° Ñ„Ñ–Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ñ–Ñ ---
    const filteredProducts = computed(() => {
        // !!! ĞĞ¡Ğ¬ Ğ¢Ğ£Ğ¢ Ğ‘Ğ£Ğ›Ğ ĞŸĞĞœĞ˜Ğ›ĞšĞ. Ğ¢Ğ•ĞŸĞ•Ğ  ĞœĞ˜ ĞŸĞ•Ğ Ğ•Ğ’Ğ†Ğ Ğ¯Ğ„ĞœĞ Ğ’Ğ¡Ğ• !!!
        if (!products || !products.value || !Array.isArray(products.value)) {
            return []
        }

        if (!productSearch.value) return products.value
        
        const q = productSearch.value.toLowerCase()
        return products.value.filter(p => 
            p.name && p.name.toLowerCase().includes(q)
        )
    })

    // --- API: Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ ---
    const fetchProducts = async () => {
        try {
            await fetchWarehouseData()
        } catch (e) {
            console.error("ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ– ÑĞºĞ»Ğ°Ğ´Ñƒ:", e)
        }
    }

    // --- API: Ğ—Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ½Ñ ---
    const saveProduct = async () => {
        if (!newProduct.value.name) return alert("Ğ’ĞºĞ°Ğ¶Ñ–Ñ‚ÑŒ Ğ½Ğ°Ğ·Ğ²Ñƒ!")
        
        const payload = {
            ...newProduct.value,
            category_id: newProduct.value.category_id || null,
            master_recipe_id: newProduct.value.master_recipe_id || null,
            price: newProduct.value.has_variants ? 0 : newProduct.value.price
        }

        try {
            const url = isEditing.value 
                ? `http://localhost:8001/products/${editingId.value}`
                : 'http://localhost:8001/products/'
            const method = isEditing.value ? 'put' : 'post'

            await axios[method](url, payload)
            await fetchProducts()
            resetForm()
            return true
        } catch (err) {
            console.error(err)
            alert("ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ·Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ½Ñ. Ğ”Ğ¸Ğ². ĞºĞ¾Ğ½ÑĞ¾Ğ»ÑŒ.")
            return false
        }
    }

    // --- API: Ğ’Ğ¸Ğ´Ğ°Ğ»ĞµĞ½Ğ½Ñ ---
    const deleteProduct = async (id) => {
        if(!confirm("Ğ’Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğ¸?")) return
        try {
            await axios.delete(`http://localhost:8001/products/${id}`)
            await fetchProducts()
        } catch(e) { alert("ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ²Ğ¸Ğ´Ğ°Ğ»ĞµĞ½Ğ½Ñ") }
    }

    // --- Ğ¥ĞµĞ»Ğ¿ĞµÑ€Ğ¸ ---
    const resetForm = () => {
        isEditing.value = false
        editingId.value = null
        newProduct.value = {
            name: '', category_id: null, price: 0, has_variants: false,
            master_recipe_id: null, output_weight: 0,
            track_stock: false, stock_quantity: 0,
            consumables: [], variants: [], process_group_ids: []
        }
        variantBuilder.value = { name: '', price: 0, master_recipe_id: null, output_weight: 0, stock_quantity: 0, consumables: [], ingredients: [] }
    }

    const prepareEdit = (p) => {
        isEditing.value = true
        editingId.value = p.id
        const copy = JSON.parse(JSON.stringify(p))
        
        // ĞœĞ°Ğ¿Ğ¸Ğ½Ğ³ Ğ¿Ğ¾Ğ»Ñ–Ğ² Ğ´Ğ»Ñ Ñ„Ğ¾Ñ€Ğ¼Ğ¸
        if (copy.variants) {
            copy.variants.forEach(v => {
                if(v.consumables) v.consumables.forEach(c => c.name = c.consumable_name || c.name)
                if(v.ingredients) v.ingredients.forEach(i => i.name = i.ingredient_name || i.name)
            })
        }
        if (copy.consumables) {
            copy.consumables.forEach(c => c.name = c.consumable_name || c.name)
        }
        
        newProduct.value = copy
    }

    // --- Ğ›Ğ¾Ğ³Ñ–ĞºĞ° Ğ´Ğ¾Ğ´Ğ°Ğ²Ğ°Ğ½Ğ½Ñ (Adders) ---
    const addVariant = () => {
        if(!variantBuilder.value.name) return alert("Ğ’ĞºĞ°Ğ¶Ñ–Ñ‚ÑŒ Ğ½Ğ°Ğ·Ğ²Ñƒ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ")
        newProduct.value.variants.push(JSON.parse(JSON.stringify(variantBuilder.value)))
        variantBuilder.value = { name: '', price: 0, master_recipe_id: null, output_weight: 0, stock_quantity: 0, consumables: [], ingredients: [] }
    }
    const removeVariant = (i) => newProduct.value.variants.splice(i, 1)

    const addProductConsumable = () => {
        if(!tempProductConsumable.value.consumable_id) return
        const c = consumables.value.find(x => x.id === tempProductConsumable.value.consumable_id)
        newProduct.value.consumables.push({ ...tempProductConsumable.value, name: c?.name || '???' })
        tempProductConsumable.value.quantity = 1
    }
    const removeProductConsumable = (i) => newProduct.value.consumables.splice(i, 1)

    const addVariantConsumable = () => {
        if(!tempVariantConsumable.value.consumable_id) return
        const c = consumables.value.find(x => x.id === tempVariantConsumable.value.consumable_id)
        variantBuilder.value.consumables.push({ ...tempVariantConsumable.value, name: c?.name || '???' })
        tempVariantConsumable.value.quantity = 1
    }
    const removeVariantConsumable = (i) => variantBuilder.value.consumables.splice(i, 1)

    const addIngredientToVariant = () => {
        if(!tempVariantIngredient.value.ingredient_id) return
        const i = ingredients.value.find(x => x.id === tempVariantIngredient.value.ingredient_id)
        variantBuilder.value.ingredients.push({ ...tempVariantIngredient.value, name: i?.name || '???' })
        tempVariantIngredient.value.quantity = 0
    }
    const removeIngredientFromVariant = (i) => variantBuilder.value.ingredients.splice(i, 1)

    return {
        newProduct, isEditing, editingId, productSearch, filteredProducts,
        variantBuilder, tempProductConsumable, tempVariantConsumable, tempVariantIngredient,
        fetchProducts, saveProduct, deleteProduct, resetForm, prepareEdit,
        addVariant, removeVariant,
        addProductConsumable, removeProductConsumable,
        addVariantConsumable, removeVariantConsumable,
        addIngredientToVariant, removeIngredientFromVariant
    }
}

--------------------------------------------------
PATH: ./.history/product_service/models_20260126160805.py
--------------------------------------------------
from sqlalchemy import Column, Integer, String, Float, ForeignKey, DateTime, Boolean, Table
from sqlalchemy.orm import relationship, backref
from database import Base
from datetime import datetime

# --- ĞĞ¡ĞĞ¦Ğ†ĞĞ¢Ğ˜Ğ’ĞĞ Ğ¢ĞĞ‘Ğ›Ğ˜Ğ¦Ğ¯: Ğ¢ĞĞ’ĞĞ  <-> Ğ“Ğ Ğ£ĞŸĞ˜ ĞŸĞ ĞĞ¦Ğ•Ğ¡Ğ†Ğ’ ---
# Ğ¦Ğµ Ğ´Ğ¾Ğ·Ğ²Ğ¾Ğ»ÑÑ” Ğ¿Ñ€Ğ¸Ğ²'ÑĞ·Ğ°Ñ‚Ğ¸ "ĞŸĞ¾Ğ¼Ğ¾Ğ»" Ğ´Ğ¾ "Ğ•Ñ„Ñ–Ğ¾Ğ¿Ñ–Ñ—", "ĞšĞ¾Ğ»ÑƒĞ¼Ğ±Ñ–Ñ—" Ñ– "Ğ‘Ñ€Ğ°Ğ·Ğ¸Ğ»Ñ–Ñ—" Ğ¾Ğ´Ğ½Ğ¾Ñ‡Ğ°ÑĞ½Ğ¾
product_process_groups = Table(
    'product_process_groups_link', Base.metadata,
    Column('product_id', Integer, ForeignKey('products.id')),
    Column('process_group_id', Integer, ForeignKey('process_groups.id'))
)

# --- ĞšĞĞ¢Ğ•Ğ“ĞĞ Ğ†Ğ‡ ---
class Category(Base):
    __tablename__ = "categories"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, unique=True, index=True)
    slug = Column(String, unique=True)
    color = Column(String, default="#ffffff")
    parent_id = Column(Integer, ForeignKey("categories.id"), nullable=True)
    children = relationship("Category", backref=backref("parent", remote_side=[id]), cascade="all, delete-orphan")

# --- ĞĞ”Ğ˜ĞĞ˜Ğ¦Ğ† ---
class Unit(Base):
    __tablename__ = "units"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, unique=True)
    symbol = Column(String, unique=True)

# --- Ğ†ĞĞ“Ğ Ğ•Ğ”Ğ†Ğ„ĞĞ¢Ğ˜ ---
class Ingredient(Base):
    __tablename__ = "ingredients"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, index=True, unique=True)
    unit_id = Column(Integer, ForeignKey("units.id"))
    unit = relationship("Unit")
    cost_per_unit = Column(Float, default=0.0)
    stock_quantity = Column(Float, default=0.0)

# --- Ğ’Ğ˜Ğ¢Ğ ĞĞ¢ĞĞ† ĞœĞĞ¢Ğ•Ğ Ğ†ĞĞ›Ğ˜ ---
class Consumable(Base):
    __tablename__ = "consumables"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, index=True, unique=True)
    unit_id = Column(Integer, ForeignKey("units.id"), nullable=True)
    unit = relationship("Unit")
    cost_per_unit = Column(Float, default=0.0)
    stock_quantity = Column(Float, default=0.0)

# --- ĞœĞĞ™Ğ¡Ğ¢Ğ•Ğ -Ğ Ğ•Ğ¦Ğ•ĞŸĞ¢Ğ˜ ---
class MasterRecipe(Base):
    __tablename__ = "master_recipes"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, index=True)
    description = Column(String, nullable=True)
    items = relationship("MasterRecipeItem", back_populates="recipe", cascade="all, delete-orphan")

class MasterRecipeItem(Base):
    __tablename__ = "master_recipe_items"
    id = Column(Integer, primary_key=True, index=True)
    recipe_id = Column(Integer, ForeignKey("master_recipes.id"))
    ingredient_id = Column(Integer, ForeignKey("ingredients.id"))
    quantity = Column(Float)
    is_percentage = Column(Boolean, default=False) 
    recipe = relationship("MasterRecipe", back_populates="items")
    ingredient = relationship("Ingredient")

# --- ĞŸĞ ĞĞ¦Ğ•Ğ¡Ğ˜ (ĞĞĞ’Ğ•) ---
class ProcessGroup(Base):
    __tablename__ = "process_groups"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, index=True) # ĞĞ°Ğ¿Ñ€: "ĞŸĞ¾Ğ¼Ğ¾Ğ»", "ĞŸÑ€Ğ¾ÑĞ¼Ğ°Ğ¶ĞµĞ½Ğ½Ñ"
    
    # Ğ—Ğ²'ÑĞ·Ğ¾Ğº Ğ¾Ğ´Ğ¸Ğ½-Ğ´Ğ¾-Ğ±Ğ°Ğ³Ğ°Ñ‚ÑŒĞ¾Ñ… Ğ· Ğ¾Ğ¿Ñ†Ñ–ÑĞ¼Ğ¸
    options = relationship("ProcessOption", back_populates="group", cascade="all, delete-orphan")
    
    # Ğ—Ğ²'ÑĞ·Ğ¾Ğº Ğ±Ğ°Ğ³Ğ°Ñ‚Ğ¾-Ğ´Ğ¾-Ğ±Ğ°Ğ³Ğ°Ñ‚ÑŒĞ¾Ñ… Ğ· Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°Ğ¼Ğ¸ (Ğ·Ğ²Ğ¾Ñ€Ğ¾Ñ‚Ğ½Ñ–Ğ¹ Ğ±Ñ–Ğº)
    products = relationship("Product", secondary=product_process_groups, back_populates="process_groups")

class ProcessOption(Base):
    __tablename__ = "process_options"
    id = Column(Integer, primary_key=True, index=True)
    group_id = Column(Integer, ForeignKey("process_groups.id"))
    name = Column(String) # ĞĞ°Ğ¿Ñ€: "ĞŸÑ–Ğ´ Ñ‚ÑƒÑ€ĞºÑƒ", "ĞŸÑ–Ğ´ Ñ„Ñ–Ğ»ÑŒÑ‚Ñ€"
    
    group = relationship("ProcessGroup", back_populates="options")

# --- Ğ¢ĞĞ’ĞĞ Ğ˜ ---
class Product(Base):
    __tablename__ = "products"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, index=True)
    description = Column(String, nullable=True)
    category_id = Column(Integer, ForeignKey("categories.id"))
    category = relationship("Category")
    has_variants = Column(Boolean, default=False)
    price = Column(Float, default=0.0)
    output_weight = Column(Float, default=0.0) 
    master_recipe_id = Column(Integer, ForeignKey("master_recipes.id"), nullable=True)
    master_recipe = relationship("MasterRecipe")

    # --- ĞĞĞ’Ğ† ĞŸĞĞ›Ğ¯ ---
    track_stock = Column(Boolean, default=False) # Ğ§Ğ¸ Ğ²ĞµÑÑ‚Ğ¸ ÑĞºĞ»Ğ°Ğ´ÑÑŒĞºĞ¸Ğ¹ Ğ¾Ğ±Ğ»Ñ–Ğº Ñ†ÑŒĞ¾Ğ³Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ
    stock_quantity = Column(Float, default=0.0)  # Ğ—Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº (Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¸Ñ… Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ–Ğ²)

    variants = relationship("ProductVariant", back_populates="product", cascade="all, delete-orphan")
    modifier_groups = relationship("ProductModifierGroup", back_populates="product", cascade="all, delete-orphan")
    consumables = relationship("ProductConsumable", back_populates="product", cascade="all, delete-orphan")
    # ĞĞĞ’Ğ•: Ğ—Ğ²'ÑĞ·Ğ¾Ğº Ğ· Ğ³Ñ€ÑƒĞ¿Ğ°Ğ¼Ğ¸ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ–Ğ²
    process_groups = relationship("ProcessGroup", secondary=product_process_groups, back_populates="products")

# --- Ğ—Ğ²'ÑĞ·Ğ¾Ğº Ğ¢Ğ¾Ğ²Ğ°Ñ€ -> Ğ’Ğ¸Ñ‚Ñ€Ğ°Ñ‚Ğ½Ñ– Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸ ---
class ProductConsumable(Base):
    __tablename__ = "product_consumables"
    id = Column(Integer, primary_key=True, index=True)
    product_id = Column(Integer, ForeignKey("products.id"))
    consumable_id = Column(Integer, ForeignKey("consumables.id"))
    quantity = Column(Float, default=1.0)
    
    product = relationship("Product", back_populates="consumables")
    consumable = relationship("Consumable")

# --- Ğ’ĞĞ Ğ†ĞĞĞ¢Ğ˜ ---
class ProductVariant(Base):
    __tablename__ = "product_variants"
    id = Column(Integer, primary_key=True, index=True)
    product_id = Column(Integer, ForeignKey("products.id"))
    name = Column(String)
    price = Column(Float)
    sku = Column(String, nullable=True)
    output_weight = Column(Float, default=0.0) 
    master_recipe_id = Column(Integer, ForeignKey("master_recipes.id"), nullable=True)
    master_recipe = relationship("MasterRecipe")

    # --- ĞĞĞ’Ğ• ĞŸĞĞ›Ğ• ---
    stock_quantity = Column(Float, default=0.0) # Ğ—Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾Ğ³Ğ¾ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ

    product = relationship("Product", back_populates="variants")
    consumables = relationship("ProductVariantConsumable", back_populates="variant", cascade="all, delete-orphan")
    # !!! ĞĞĞ’Ğ•: Ğ—Ğ²'ÑĞ·Ğ¾Ğº Ğ· Ñ–Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ğ°Ğ¼Ğ¸ !!!
    ingredients = relationship("ProductVariantIngredient", back_populates="variant", cascade="all, delete-orphan")

class ProductVariantConsumable(Base):
    __tablename__ = "product_variant_consumables"
    id = Column(Integer, primary_key=True, index=True)
    variant_id = Column(Integer, ForeignKey("product_variants.id"))
    consumable_id = Column(Integer, ForeignKey("consumables.id"))
    quantity = Column(Float, default=1.0)
    
    variant = relationship("ProductVariant", back_populates="consumables")
    consumable = relationship("Consumable")

# !!! ĞĞĞ’Ğ˜Ğ™ ĞšĞ›ĞĞ¡: Ğ†Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ğ¸ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ !!!
class ProductVariantIngredient(Base):
    __tablename__ = "product_variant_ingredients"
    id = Column(Integer, primary_key=True, index=True)
    variant_id = Column(Integer, ForeignKey("product_variants.id"))
    ingredient_id = Column(Integer, ForeignKey("ingredients.id"))
    quantity = Column(Float, default=0.0) # Ğ¡ĞºÑ–Ğ»ÑŒĞºĞ¸ Ğ³Ñ€Ğ°Ğ¼/Ğ¼Ğ»
    
    variant = relationship("ProductVariant", back_populates="ingredients")
    ingredient = relationship("Ingredient")

# --- ĞœĞĞ”Ğ˜Ğ¤Ğ†ĞšĞĞ¢ĞĞ Ğ˜ ---
class ProductModifierGroup(Base):
    __tablename__ = "product_modifier_groups"
    id = Column(Integer, primary_key=True)
    product_id = Column(Integer, ForeignKey("products.id"))
    name = Column(String)
    is_required = Column(Boolean, default=False)
    product = relationship("Product", back_populates="modifier_groups")
    modifiers = relationship("Modifier", back_populates="group", cascade="all, delete-orphan")

class Modifier(Base):
    __tablename__ = "modifiers"
    id = Column(Integer, primary_key=True)
    group_id = Column(Integer, ForeignKey("product_modifier_groups.id"))
    name = Column(String) 
    price_change = Column(Float, default=0.0)
    ingredient_id = Column(Integer, ForeignKey("ingredients.id"), nullable=True)
    quantity = Column(Float, default=0.0)
    group = relationship("ProductModifierGroup", back_populates="modifiers")
    ingredient = relationship("Ingredient")

# --- CRM/ORDERS ---
class Customer(Base):
    __tablename__ = "customers"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String)
    phone = Column(String, unique=True)
    email = Column(String, nullable=True)
    notes = Column(String, nullable=True)
    created_at = Column(DateTime, default=datetime.now)

class Order(Base):
    __tablename__ = "orders"
    id = Column(Integer, primary_key=True, index=True)
    created_at = Column(DateTime, default=datetime.now)
    total_price = Column(Float)
    payment_method = Column(String)
    customer_id = Column(Integer, ForeignKey("customers.id"), nullable=True)
    customer = relationship("Customer")
    items = relationship("OrderItem", back_populates="order", cascade="all, delete-orphan")

class OrderItem(Base):
    __tablename__ = "order_items"
    id = Column(Integer, primary_key=True, index=True)
    order_id = Column(Integer, ForeignKey("orders.id"))
    product_name = Column(String)
    quantity = Column(Integer)
    price_at_moment = Column(Float)
    details = Column(String, nullable=True) 
    order = relationship("Order", back_populates="items")

# --- Ğ†Ğ¡Ğ¢ĞĞ Ğ†Ğ¯ Ğ Ğ£Ğ¥Ğ£ Ğ¢ĞĞ’ĞĞ Ğ†Ğ’ (TRANSACTIONS) ---
class InventoryTransaction(Base):
    __tablename__ = "inventory_transactions"

    id = Column(Integer, primary_key=True, index=True)
    
    # Ğ¢Ğ¸Ğ¿ ÑÑƒÑ‚Ğ½Ğ¾ÑÑ‚Ñ–: 'ingredient', 'consumable', 'product'
    entity_type = Column(String, index=True) 
    
    # ID ÑÑƒÑ‚Ğ½Ğ¾ÑÑ‚Ñ– (ingredient_id, consumable_id Ğ°Ğ±Ğ¾ product_id)
    entity_id = Column(Integer, index=True)
    
    # ĞĞ°Ğ·Ğ²Ğ° Ğ½Ğ° Ğ¼Ğ¾Ğ¼ĞµĞ½Ñ‚ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ñ–Ñ— (Ñ‰Ğ¾Ğ± ÑĞºÑ‰Ğ¾ Ğ²Ğ¸Ğ´Ğ°Ğ»Ğ¸Ğ»Ğ¸ Ñ‚Ğ¾Ğ²Ğ°Ñ€, Ñ–ÑÑ‚Ğ¾Ñ€Ñ–Ñ Ğ»Ğ¸ÑˆĞ¸Ğ»Ğ°ÑÑŒ)
    entity_name = Column(String)
    
    # Ğ—Ğ¼Ñ–Ğ½Ğ° ĞºÑ–Ğ»ÑŒĞºĞ¾ÑÑ‚Ñ–: +5.0 (Ğ¿Ñ€Ğ¸Ñ…Ñ–Ğ´), -0.5 (ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ½Ñ)
    change_amount = Column(Float)
    
    # Ğ—Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº ĞŸĞ†Ğ¡Ğ›Ğ¯ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ñ–Ñ— (Ğ´Ğ»Ñ ĞºĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»Ñ)
    balance_after = Column(Float)
    
    # ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°: 'manual_update', 'sale_order_#105', 'waste', 'restock'
    reason = Column(String)
    
    created_at = Column(DateTime, default=datetime.now)

--------------------------------------------------
PATH: ./.history/product_service/models_20260120112422.py
--------------------------------------------------
from sqlalchemy import Column, Integer, String, Float, ForeignKey, DateTime, Boolean, Table
from sqlalchemy.orm import relationship, backref
from database import Base
from datetime import datetime

# --- ĞĞ¡ĞĞ¦Ğ†ĞĞ¢Ğ˜Ğ’ĞĞ Ğ¢ĞĞ‘Ğ›Ğ˜Ğ¦Ğ¯: Ğ¢ĞĞ’ĞĞ  <-> Ğ“Ğ Ğ£ĞŸĞ˜ ĞŸĞ ĞĞ¦Ğ•Ğ¡Ğ†Ğ’ ---
# Ğ¦Ğµ Ğ´Ğ¾Ğ·Ğ²Ğ¾Ğ»ÑÑ” Ğ¿Ñ€Ğ¸Ğ²'ÑĞ·Ğ°Ñ‚Ğ¸ "ĞŸĞ¾Ğ¼Ğ¾Ğ»" Ğ´Ğ¾ "Ğ•Ñ„Ñ–Ğ¾Ğ¿Ñ–Ñ—", "ĞšĞ¾Ğ»ÑƒĞ¼Ğ±Ñ–Ñ—" Ñ– "Ğ‘Ñ€Ğ°Ğ·Ğ¸Ğ»Ñ–Ñ—" Ğ¾Ğ´Ğ½Ğ¾Ñ‡Ğ°ÑĞ½Ğ¾
product_process_groups = Table(
    'product_process_groups_link', Base.metadata,
    Column('product_id', Integer, ForeignKey('products.id')),
    Column('process_group_id', Integer, ForeignKey('process_groups.id'))
)

# --- ĞšĞĞ¢Ğ•Ğ“ĞĞ Ğ†Ğ‡ ---
class Category(Base):
    __tablename__ = "categories"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, unique=True, index=True)
    slug = Column(String, unique=True)
    color = Column(String, default="#ffffff")
    parent_id = Column(Integer, ForeignKey("categories.id"), nullable=True)
    children = relationship("Category", backref=backref("parent", remote_side=[id]), cascade="all, delete-orphan")

# --- ĞĞ”Ğ˜ĞĞ˜Ğ¦Ğ† ---
class Unit(Base):
    __tablename__ = "units"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, unique=True)
    symbol = Column(String, unique=True)

# --- Ğ†ĞĞ“Ğ Ğ•Ğ”Ğ†Ğ„ĞĞ¢Ğ˜ ---
class Ingredient(Base):
    __tablename__ = "ingredients"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, index=True, unique=True)
    unit_id = Column(Integer, ForeignKey("units.id"))
    unit = relationship("Unit")
    cost_per_unit = Column(Float, default=0.0)
    stock_quantity = Column(Float, default=0.0)

# --- Ğ’Ğ˜Ğ¢Ğ ĞĞ¢ĞĞ† ĞœĞĞ¢Ğ•Ğ Ğ†ĞĞ›Ğ˜ ---
class Consumable(Base):
    __tablename__ = "consumables"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, index=True, unique=True)
    unit_id = Column(Integer, ForeignKey("units.id"), nullable=True)
    unit = relationship("Unit")
    cost_per_unit = Column(Float, default=0.0)
    stock_quantity = Column(Float, default=0.0)

# --- ĞœĞĞ™Ğ¡Ğ¢Ğ•Ğ -Ğ Ğ•Ğ¦Ğ•ĞŸĞ¢Ğ˜ ---
class MasterRecipe(Base):
    __tablename__ = "master_recipes"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, index=True)
    description = Column(String, nullable=True)
    items = relationship("MasterRecipeItem", back_populates="recipe", cascade="all, delete-orphan")

class MasterRecipeItem(Base):
    __tablename__ = "master_recipe_items"
    id = Column(Integer, primary_key=True, index=True)
    recipe_id = Column(Integer, ForeignKey("master_recipes.id"))
    ingredient_id = Column(Integer, ForeignKey("ingredients.id"))
    quantity = Column(Float)
    is_percentage = Column(Boolean, default=False) 
    recipe = relationship("MasterRecipe", back_populates="items")
    ingredient = relationship("Ingredient")

# --- ĞŸĞ ĞĞ¦Ğ•Ğ¡Ğ˜ (ĞĞĞ’Ğ•) ---
class ProcessGroup(Base):
    __tablename__ = "process_groups"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, index=True) # ĞĞ°Ğ¿Ñ€: "ĞŸĞ¾Ğ¼Ğ¾Ğ»", "ĞŸÑ€Ğ¾ÑĞ¼Ğ°Ğ¶ĞµĞ½Ğ½Ñ"
    
    # Ğ—Ğ²'ÑĞ·Ğ¾Ğº Ğ¾Ğ´Ğ¸Ğ½-Ğ´Ğ¾-Ğ±Ğ°Ğ³Ğ°Ñ‚ÑŒĞ¾Ñ… Ğ· Ğ¾Ğ¿Ñ†Ñ–ÑĞ¼Ğ¸
    options = relationship("ProcessOption", back_populates="group", cascade="all, delete-orphan")
    
    # Ğ—Ğ²'ÑĞ·Ğ¾Ğº Ğ±Ğ°Ğ³Ğ°Ñ‚Ğ¾-Ğ´Ğ¾-Ğ±Ğ°Ğ³Ğ°Ñ‚ÑŒĞ¾Ñ… Ğ· Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°Ğ¼Ğ¸ (Ğ·Ğ²Ğ¾Ñ€Ğ¾Ñ‚Ğ½Ñ–Ğ¹ Ğ±Ñ–Ğº)
    products = relationship("Product", secondary=product_process_groups, back_populates="process_groups")

class ProcessOption(Base):
    __tablename__ = "process_options"
    id = Column(Integer, primary_key=True, index=True)
    group_id = Column(Integer, ForeignKey("process_groups.id"))
    name = Column(String) # ĞĞ°Ğ¿Ñ€: "ĞŸÑ–Ğ´ Ñ‚ÑƒÑ€ĞºÑƒ", "ĞŸÑ–Ğ´ Ñ„Ñ–Ğ»ÑŒÑ‚Ñ€"
    
    group = relationship("ProcessGroup", back_populates="options")

# --- Ğ¢ĞĞ’ĞĞ Ğ˜ ---
class Product(Base):
    __tablename__ = "products"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, index=True)
    description = Column(String, nullable=True)
    category_id = Column(Integer, ForeignKey("categories.id"))
    category = relationship("Category")
    has_variants = Column(Boolean, default=False)
    price = Column(Float, default=0.0)
    output_weight = Column(Float, default=0.0) 
    master_recipe_id = Column(Integer, ForeignKey("master_recipes.id"), nullable=True)
    master_recipe = relationship("MasterRecipe")

    # --- ĞĞĞ’Ğ† ĞŸĞĞ›Ğ¯ ---
    track_stock = Column(Boolean, default=False) # Ğ§Ğ¸ Ğ²ĞµÑÑ‚Ğ¸ ÑĞºĞ»Ğ°Ğ´ÑÑŒĞºĞ¸Ğ¹ Ğ¾Ğ±Ğ»Ñ–Ğº Ñ†ÑŒĞ¾Ğ³Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ
    stock_quantity = Column(Float, default=0.0)  # Ğ—Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº (Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¸Ñ… Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ–Ğ²)

    variants = relationship("ProductVariant", back_populates="product", cascade="all, delete-orphan")
    modifier_groups = relationship("ProductModifierGroup", back_populates="product", cascade="all, delete-orphan")
    consumables = relationship("ProductConsumable", back_populates="product", cascade="all, delete-orphan")
    # ĞĞĞ’Ğ•: Ğ—Ğ²'ÑĞ·Ğ¾Ğº Ğ· Ğ³Ñ€ÑƒĞ¿Ğ°Ğ¼Ğ¸ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ–Ğ²
    process_groups = relationship("ProcessGroup", secondary=product_process_groups, back_populates="products")

# --- Ğ—Ğ²'ÑĞ·Ğ¾Ğº Ğ¢Ğ¾Ğ²Ğ°Ñ€ -> Ğ’Ğ¸Ñ‚Ñ€Ğ°Ñ‚Ğ½Ñ– Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸ ---
class ProductConsumable(Base):
    __tablename__ = "product_consumables"
    id = Column(Integer, primary_key=True, index=True)
    product_id = Column(Integer, ForeignKey("products.id"))
    consumable_id = Column(Integer, ForeignKey("consumables.id"))
    quantity = Column(Float, default=1.0)
    
    product = relationship("Product", back_populates="consumables")
    consumable = relationship("Consumable")

# --- Ğ’ĞĞ Ğ†ĞĞĞ¢Ğ˜ ---
class ProductVariant(Base):
    __tablename__ = "product_variants"
    id = Column(Integer, primary_key=True, index=True)
    product_id = Column(Integer, ForeignKey("products.id"))
    name = Column(String)
    price = Column(Float)
    sku = Column(String, nullable=True)
    output_weight = Column(Float, default=0.0) 
    master_recipe_id = Column(Integer, ForeignKey("master_recipes.id"), nullable=True)
    master_recipe = relationship("MasterRecipe")

    # --- ĞĞĞ’Ğ• ĞŸĞĞ›Ğ• ---
    stock_quantity = Column(Float, default=0.0) # Ğ—Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾Ğ³Ğ¾ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ

    product = relationship("Product", back_populates="variants")
    consumables = relationship("ProductVariantConsumable", back_populates="variant", cascade="all, delete-orphan")
    # !!! ĞĞĞ’Ğ•: Ğ—Ğ²'ÑĞ·Ğ¾Ğº Ğ· Ñ–Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ğ°Ğ¼Ğ¸ !!!
    ingredients = relationship("ProductVariantIngredient", back_populates="variant", cascade="all, delete-orphan")

class ProductVariantConsumable(Base):
    __tablename__ = "product_variant_consumables"
    id = Column(Integer, primary_key=True, index=True)
    variant_id = Column(Integer, ForeignKey("product_variants.id"))
    consumable_id = Column(Integer, ForeignKey("consumables.id"))
    quantity = Column(Float, default=1.0)
    
    variant = relationship("ProductVariant", back_populates="consumables")
    consumable = relationship("Consumable")

# !!! ĞĞĞ’Ğ˜Ğ™ ĞšĞ›ĞĞ¡: Ğ†Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ğ¸ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ !!!
class ProductVariantIngredient(Base):
    __tablename__ = "product_variant_ingredients"
    id = Column(Integer, primary_key=True, index=True)
    variant_id = Column(Integer, ForeignKey("product_variants.id"))
    ingredient_id = Column(Integer, ForeignKey("ingredients.id"))
    quantity = Column(Float, default=0.0) # Ğ¡ĞºÑ–Ğ»ÑŒĞºĞ¸ Ğ³Ñ€Ğ°Ğ¼/Ğ¼Ğ»
    
    variant = relationship("ProductVariant", back_populates="ingredients")
    ingredient = relationship("Ingredient")

# --- ĞœĞĞ”Ğ˜Ğ¤Ğ†ĞšĞĞ¢ĞĞ Ğ˜ ---
class ProductModifierGroup(Base):
    __tablename__ = "product_modifier_groups"
    id = Column(Integer, primary_key=True)
    product_id = Column(Integer, ForeignKey("products.id"))
    name = Column(String)
    is_required = Column(Boolean, default=False)
    product = relationship("Product", back_populates="modifier_groups")
    modifiers = relationship("Modifier", back_populates="group", cascade="all, delete-orphan")

class Modifier(Base):
    __tablename__ = "modifiers"
    id = Column(Integer, primary_key=True)
    group_id = Column(Integer, ForeignKey("product_modifier_groups.id"))
    name = Column(String) 
    price_change = Column(Float, default=0.0)
    ingredient_id = Column(Integer, ForeignKey("ingredients.id"), nullable=True)
    quantity = Column(Float, default=0.0)
    group = relationship("ProductModifierGroup", back_populates="modifiers")
    ingredient = relationship("Ingredient")

# --- CRM/ORDERS ---
class Customer(Base):
    __tablename__ = "customers"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String)
    phone = Column(String, unique=True)
    email = Column(String, nullable=True)
    notes = Column(String, nullable=True)
    created_at = Column(DateTime, default=datetime.now)

class Order(Base):
    __tablename__ = "orders"
    id = Column(Integer, primary_key=True, index=True)
    created_at = Column(DateTime, default=datetime.now)
    total_price = Column(Float)
    payment_method = Column(String)
    customer_id = Column(Integer, ForeignKey("customers.id"), nullable=True)
    customer = relationship("Customer")
    items = relationship("OrderItem", back_populates="order", cascade="all, delete-orphan")

class OrderItem(Base):
    __tablename__ = "order_items"
    id = Column(Integer, primary_key=True, index=True)
    order_id = Column(Integer, ForeignKey("orders.id"))
    product_name = Column(String)
    quantity = Column(Integer)
    price_at_moment = Column(Float)
    details = Column(String, nullable=True) 
    order = relationship("Order", back_populates="items")

# --- Ğ†Ğ¡Ğ¢ĞĞ Ğ†Ğ¯ Ğ Ğ£Ğ¥Ğ£ Ğ¢ĞĞ’ĞĞ Ğ†Ğ’ (TRANSACTIONS) ---
class InventoryTransaction(Base):
    __tablename__ = "inventory_transactions"

    id = Column(Integer, primary_key=True, index=True)
    
    # Ğ¢Ğ¸Ğ¿ ÑÑƒÑ‚Ğ½Ğ¾ÑÑ‚Ñ–: 'ingredient', 'consumable', 'product'
    entity_type = Column(String, index=True) 
    
    # ID ÑÑƒÑ‚Ğ½Ğ¾ÑÑ‚Ñ– (ingredient_id, consumable_id Ğ°Ğ±Ğ¾ product_id)
    entity_id = Column(Integer, index=True)
    
    # ĞĞ°Ğ·Ğ²Ğ° Ğ½Ğ° Ğ¼Ğ¾Ğ¼ĞµĞ½Ñ‚ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ñ–Ñ— (Ñ‰Ğ¾Ğ± ÑĞºÑ‰Ğ¾ Ğ²Ğ¸Ğ´Ğ°Ğ»Ğ¸Ğ»Ğ¸ Ñ‚Ğ¾Ğ²Ğ°Ñ€, Ñ–ÑÑ‚Ğ¾Ñ€Ñ–Ñ Ğ»Ğ¸ÑˆĞ¸Ğ»Ğ°ÑÑŒ)
    entity_name = Column(String)
    
    # Ğ—Ğ¼Ñ–Ğ½Ğ° ĞºÑ–Ğ»ÑŒĞºĞ¾ÑÑ‚Ñ–: +5.0 (Ğ¿Ñ€Ğ¸Ñ…Ñ–Ğ´), -0.5 (ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ½Ñ)
    change_amount = Column(Float)
    
    # Ğ—Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº ĞŸĞ†Ğ¡Ğ›Ğ¯ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ñ–Ñ— (Ğ´Ğ»Ñ ĞºĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»Ñ)
    balance_after = Column(Float)
    
    # ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°: 'manual_update', 'sale_order_#105', 'waste', 'restock'
    reason = Column(String)
    
    created_at = Column(DateTime, default=datetime.now)

--------------------------------------------------
PATH: ./.history/product_service/schemas_20260123211329.py
--------------------------------------------------
from pydantic import BaseModel
from typing import List, Optional
from datetime import datetime

# --- BASIC ---
class Category(BaseModel):
    id: int
    name: str
    slug: str
    color: Optional[str] = "#ffffff"
    parent_id: Optional[int] = None
    class Config: from_attributes = True

class CategoryCreate(BaseModel):
    name: str
    slug: str
    color: Optional[str] = "#ffffff"
    parent_id: Optional[int] = None

class Unit(BaseModel):
    id: int
    name: str
    symbol: str
    class Config: from_attributes = True
class UnitCreate(BaseModel):
    name: str
    symbol: str

class Ingredient(BaseModel):
    id: int
    name: str
    cost_per_unit: float
    stock_quantity: float
    unit_id: Optional[int] = None
    unit: Optional[Unit] = None
    class Config: from_attributes = True
class IngredientCreate(BaseModel):
    name: str
    cost_per_unit: float
    stock_quantity: float
    unit_id: int

# --- ĞĞĞ’Ğ•: Consumables Schemas ---
class ConsumableBase(BaseModel):
    name: str
    cost_per_unit: float
    stock_quantity: float
    unit_id: Optional[int] = None

class ConsumableCreate(ConsumableBase):
    pass

class Consumable(ConsumableBase):
    id: int
    unit: Optional[Unit] = None
    class Config: from_attributes = True

# Ğ¡Ñ…ĞµĞ¼Ğ° Ğ´Ğ»Ñ Ğ·Ğ°Ğ¿Ğ¸ÑÑƒ (Link)
class ProductIngredientLink(BaseModel):
    ingredient_id: int
    quantity: float

# Ğ¡Ñ…ĞµĞ¼Ğ° Ğ´Ğ»Ñ Ñ‡Ğ¸Ñ‚Ğ°Ğ½Ğ½Ñ (Read)
class ProductIngredientRead(BaseModel):
    ingredient_id: int
    quantity: float
    ingredient_name: Optional[str] = None
    class Config: from_attributes = True

# Ğ¡Ñ…ĞµĞ¼Ğ° Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¸Ğ²'ÑĞ·ĞºĞ¸ Ğ²Ğ¸Ñ‚Ñ€Ğ°Ñ‚Ğ½Ğ¸Ñ… Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ñ–Ğ² Ğ´Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ (Ğ´Ğ»Ñ Ğ·Ğ°Ğ¿Ğ¸ÑÑƒ)
class ProductConsumableLink(BaseModel):
    consumable_id: int
    quantity: float = 1.0

# --- Ğ’ĞĞ–Ğ›Ğ˜Ğ’Ğ: ĞŸĞµÑ€ĞµĞ¼Ñ–Ñ‰ĞµĞ½Ğ¾ Ğ¡Ğ®Ğ”Ğ˜ (Ğ¿ĞµÑ€ĞµĞ´ Variants), Ñ‰Ğ¾Ğ± Pydantic Ğ¹Ğ¾Ğ³Ğ¾ Ğ±Ğ°Ñ‡Ğ¸Ğ² ---
class ProductConsumableRead(BaseModel):
    consumable_id: int
    quantity: float
    consumable_name: Optional[str] = None
    class Config: from_attributes = True

# --- PROCESSES (ĞĞĞ’Ğ•) ---
class ProcessOptionCreate(BaseModel):
    name: str # "Ğ”Ñ€Ñ–Ğ±Ğ½Ğ¸Ğ¹", "Ğ—ĞµÑ€Ğ½Ğ¾"
class ProcessOption(ProcessOptionCreate):
    id: int
    group_id: int
    class Config: from_attributes = True

class ProcessGroupCreate(BaseModel):
    name: str # "ĞŸĞ¾Ğ¼Ğ¾Ğ»"
    options: List[ProcessOptionCreate] = []

class ProcessGroup(BaseModel):
    id: int
    name: str
    options: List[ProcessOption] = []
    class Config: from_attributes = True

# --- MASTER RECIPES ---
class MasterRecipeItemCreate(BaseModel):
    ingredient_id: int
    quantity: float
    is_percentage: bool = False 

class MasterRecipeItem(MasterRecipeItemCreate):
    id: int
    ingredient_name: Optional[str] = None 
    class Config: from_attributes = True

class MasterRecipeCreate(BaseModel):
    name: str
    description: Optional[str] = None
    items: List[MasterRecipeItemCreate] = []

class MasterRecipe(MasterRecipeCreate):
    id: int
    items: List[MasterRecipeItem] = []
    class Config: from_attributes = True

# --- MODIFIERS ---
class ModifierCreate(BaseModel):
    name: str
    price_change: float = 0.0
    ingredient_id: Optional[int] = None
    quantity: float = 0.0
class Modifier(ModifierCreate):
    id: int
    class Config: from_attributes = True
class ModifierGroupCreate(BaseModel):
    name: str
    is_required: bool = False
    modifiers: List[ModifierCreate] = []
class ModifierGroup(ModifierGroupCreate):
    id: int
    modifiers: List[Modifier] = []
    class Config: from_attributes = True

# --- VARIANTS ---
class VariantCreate(BaseModel):
    name: str
    price: float
    sku: Optional[str] = None
    output_weight: float = 0.0
    master_recipe_id: Optional[int] = None
    stock_quantity: float = 0.0
    # ĞŸÑ€Ğ¸ ÑÑ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ½Ñ– Ğ²Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ Link (Ñ‚Ñ–Ğ»ÑŒĞºĞ¸ ID Ñ‚Ğ° ĞºÑ–Ğ»ÑŒĞºÑ–ÑÑ‚ÑŒ)
    consumables: List[ProductConsumableLink] = []

    ingredients: List[ProductIngredientLink] = []

class Variant(VariantCreate):
    id: int
    # ĞŸÑ€Ğ¸ Ñ‡Ğ¸Ñ‚Ğ°Ğ½Ğ½Ñ– Ğ²Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ Read (Ğ· Ğ½Ğ°Ğ·Ğ²Ğ¾Ñ), Ñ‚ĞµĞ¿ĞµÑ€ Ñ†Ğµ Ğ¿Ñ€Ğ°Ñ†ÑĞ²Ğ°Ñ‚Ğ¸Ğ¼Ğµ ĞºĞ¾Ñ€ĞµĞºÑ‚Ğ½Ğ¾
    consumables: List[ProductConsumableRead] = []
    ingredients: List[ProductIngredientRead] = [] 
    class Config: from_attributes = True

# --- PRODUCTS ---
class ProductBase(BaseModel):
    name: str
    description: Optional[str] = None
    category_id: Optional[int] = None
    has_variants: bool = False
    price: float = 0.0 
    output_weight: float = 0.0 
    master_recipe_id: Optional[int] = None

    track_stock: bool = False
    stock_quantity: float = 0.0

class ProductCreate(ProductBase):
    variants: List[VariantCreate] = []
    modifier_groups: List[ModifierGroupCreate] = []
    consumables: List[ProductConsumableLink] = []
    
    # ĞĞĞ’Ğ•: Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ID Ğ³Ñ€ÑƒĞ¿ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ–Ğ², ÑĞºÑ– Ñ‚Ñ€ĞµĞ±Ğ° Ğ¿Ñ€Ğ¸Ğ²'ÑĞ·Ğ°Ñ‚Ğ¸
    process_group_ids: List[int] = [] 

class Product(ProductBase):
    id: int
    category: Optional[Category] = None
    variants: List[Variant] = [] 
    modifier_groups: List[ModifierGroup] = []
    master_recipe: Optional[MasterRecipe] = None
    consumables: List[ProductConsumableRead] = [] 
    
    # ĞĞĞ’Ğ•: ĞŸĞ¾Ğ²ĞµÑ€Ñ‚Ğ°Ñ”Ğ¼Ğ¾ Ğ¿Ğ¾Ğ²Ğ½Ñ– Ğ¾Ğ±'Ñ”ĞºÑ‚Ğ¸ Ğ³Ñ€ÑƒĞ¿ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ–Ğ²
    process_groups: List[ProcessGroup] = []

    class Config: from_attributes = True

# --- INVENTORY TRANSACTIONS ---
class InventoryTransactionRead(BaseModel):
    id: int
    entity_type: str
    entity_id: int
    entity_name: str
    change_amount: float
    balance_after: float
    reason: str
    created_at: datetime

    class Config:
        from_attributes = True

# --- ORDERS ---
class SoldItemModifier(BaseModel):
    modifier_id: int
class SoldItem(BaseModel):
    product_id: int
    variant_id: Optional[int] = None
    modifiers: List[SoldItemModifier] = []
    quantity: int
    # Ğ¢ÑƒÑ‚ Ğ¼Ğ¸ Ğ½Ğµ Ğ´Ğ¾Ğ´Ğ°Ñ”Ğ¼Ğ¾ Ğ¾ĞºÑ€ĞµĞ¼Ğµ Ğ¿Ğ¾Ğ»Ğµ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ–Ğ², 
    # Ğ±Ğ¾ Ğ²Ğ¾Ğ½Ğ¸ Ğ¿Ñ€Ğ¸Ñ…Ğ¾Ğ´ÑÑ‚ÑŒ Ğ²Ğ¶Ğµ ÑĞº Ñ‡Ğ°ÑÑ‚Ğ¸Ğ½Ğ° Ğ½Ğ°Ğ·Ğ²Ğ¸ Ğ°Ğ±Ğ¾ details, ÑÑ„Ğ¾Ñ€Ğ¼Ğ¾Ğ²Ğ°Ğ½Ñ– Ğ½Ğ° Ñ„Ñ€Ğ¾Ğ½Ñ‚Ñ–
    # Ğ°Ğ±Ğ¾ Ğ¼Ğ¸ Ğ´Ğ¾Ğ´Ğ°Ğ¼Ğ¾ Ñ—Ñ… Ğ² Ğ¼Ğ°Ğ¹Ğ±ÑƒÑ‚Ğ½ÑŒĞ¾Ğ¼Ñƒ, ÑĞºÑ‰Ğ¾ Ñ‚Ñ€ĞµĞ±Ğ° Ğ±ÑƒĞ´Ğµ.
class OrderCreate(BaseModel):
    items: List[SoldItem]
    payment_method: str
    total_price: float
    customer_id: Optional[int] = None

class CustomerCreate(BaseModel):
    name: str
    phone: str
    email: Optional[str] = None
    notes: Optional[str] = None
class Customer(CustomerCreate):
    id: int
    class Config: from_attributes = True

class OrderItemRead(BaseModel):
    product_name: str
    quantity: int
    price_at_moment: float
    details: Optional[str] = None
    class Config: from_attributes = True
class OrderRead(BaseModel):
    id: int
    created_at: datetime
    total_price: float
    payment_method: str
    items: List[OrderItemRead]
    customer: Optional[Customer] = None
    class Config: from_attributes = True

--------------------------------------------------
PATH: ./.history/product_service/models_20260126085154.py
--------------------------------------------------
from sqlalchemy import Column, Integer, String, Float, ForeignKey, DateTime, Boolean, Table
from sqlalchemy.orm import relationship, backref
from database import Base
from datetime import datetime

# --- ĞĞ¡ĞĞ¦Ğ†ĞĞ¢Ğ˜Ğ’ĞĞ Ğ¢ĞĞ‘Ğ›Ğ˜Ğ¦Ğ¯: Ğ¢ĞĞ’ĞĞ  <-> Ğ“Ğ Ğ£ĞŸĞ˜ ĞŸĞ ĞĞ¦Ğ•Ğ¡Ğ†Ğ’ ---
# Ğ¦Ğµ Ğ´Ğ¾Ğ·Ğ²Ğ¾Ğ»ÑÑ” Ğ¿Ñ€Ğ¸Ğ²'ÑĞ·Ğ°Ñ‚Ğ¸ "ĞŸĞ¾Ğ¼Ğ¾Ğ»" Ğ´Ğ¾ "Ğ•Ñ„Ñ–Ğ¾Ğ¿Ñ–Ñ—", "ĞšĞ¾Ğ»ÑƒĞ¼Ğ±Ñ–Ñ—" Ñ– "Ğ‘Ñ€Ğ°Ğ·Ğ¸Ğ»Ñ–Ñ—" Ğ¾Ğ´Ğ½Ğ¾Ñ‡Ğ°ÑĞ½Ğ¾
product_process_groups = Table(
    'product_process_groups_link', Base.metadata,
    Column('product_id', Integer, ForeignKey('products.id')),
    Column('process_group_id', Integer, ForeignKey('process_groups.id'))
)

# --- ĞšĞĞ¢Ğ•Ğ“ĞĞ Ğ†Ğ‡ ---
class Category(Base):
    __tablename__ = "categories"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, unique=True, index=True)
    slug = Column(String, unique=True)
    color = Column(String, default="#ffffff")
    parent_id = Column(Integer, ForeignKey("categories.id"), nullable=True)
    children = relationship("Category", backref=backref("parent", remote_side=[id]), cascade="all, delete-orphan")

# --- ĞĞ”Ğ˜ĞĞ˜Ğ¦Ğ† ---
class Unit(Base):
    __tablename__ = "units"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, unique=True)
    symbol = Column(String, unique=True)

# --- Ğ†ĞĞ“Ğ Ğ•Ğ”Ğ†Ğ„ĞĞ¢Ğ˜ ---
class Ingredient(Base):
    __tablename__ = "ingredients"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, index=True, unique=True)
    unit_id = Column(Integer, ForeignKey("units.id"))
    unit = relationship("Unit")
    cost_per_unit = Column(Float, default=0.0)
    stock_quantity = Column(Float, default=0.0)

# --- Ğ’Ğ˜Ğ¢Ğ ĞĞ¢ĞĞ† ĞœĞĞ¢Ğ•Ğ Ğ†ĞĞ›Ğ˜ ---
class Consumable(Base):
    __tablename__ = "consumables"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, index=True, unique=True)
    unit_id = Column(Integer, ForeignKey("units.id"), nullable=True)
    unit = relationship("Unit")
    cost_per_unit = Column(Float, default=0.0)
    stock_quantity = Column(Float, default=0.0)

# --- ĞœĞĞ™Ğ¡Ğ¢Ğ•Ğ -Ğ Ğ•Ğ¦Ğ•ĞŸĞ¢Ğ˜ ---
class MasterRecipe(Base):
    __tablename__ = "master_recipes"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, index=True)
    description = Column(String, nullable=True)
    items = relationship("MasterRecipeItem", back_populates="recipe", cascade="all, delete-orphan")

class MasterRecipeItem(Base):
    __tablename__ = "master_recipe_items"
    id = Column(Integer, primary_key=True, index=True)
    recipe_id = Column(Integer, ForeignKey("master_recipes.id"))
    ingredient_id = Column(Integer, ForeignKey("ingredients.id"))
    quantity = Column(Float)
    is_percentage = Column(Boolean, default=False) 
    recipe = relationship("MasterRecipe", back_populates="items")
    ingredient = relationship("Ingredient")

# --- ĞŸĞ ĞĞ¦Ğ•Ğ¡Ğ˜ (ĞĞĞ’Ğ•) ---
class ProcessGroup(Base):
    __tablename__ = "process_groups"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, index=True) # ĞĞ°Ğ¿Ñ€: "ĞŸĞ¾Ğ¼Ğ¾Ğ»", "ĞŸÑ€Ğ¾ÑĞ¼Ğ°Ğ¶ĞµĞ½Ğ½Ñ"
    
    # Ğ—Ğ²'ÑĞ·Ğ¾Ğº Ğ¾Ğ´Ğ¸Ğ½-Ğ´Ğ¾-Ğ±Ğ°Ğ³Ğ°Ñ‚ÑŒĞ¾Ñ… Ğ· Ğ¾Ğ¿Ñ†Ñ–ÑĞ¼Ğ¸
    options = relationship("ProcessOption", back_populates="group", cascade="all, delete-orphan")
    
    # Ğ—Ğ²'ÑĞ·Ğ¾Ğº Ğ±Ğ°Ğ³Ğ°Ñ‚Ğ¾-Ğ´Ğ¾-Ğ±Ğ°Ğ³Ğ°Ñ‚ÑŒĞ¾Ñ… Ğ· Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°Ğ¼Ğ¸ (Ğ·Ğ²Ğ¾Ñ€Ğ¾Ñ‚Ğ½Ñ–Ğ¹ Ğ±Ñ–Ğº)
    products = relationship("Product", secondary=product_process_groups, back_populates="process_groups")

class ProcessOption(Base):
    __tablename__ = "process_options"
    id = Column(Integer, primary_key=True, index=True)
    group_id = Column(Integer, ForeignKey("process_groups.id"))
    name = Column(String) # ĞĞ°Ğ¿Ñ€: "ĞŸÑ–Ğ´ Ñ‚ÑƒÑ€ĞºÑƒ", "ĞŸÑ–Ğ´ Ñ„Ñ–Ğ»ÑŒÑ‚Ñ€"
    
    group = relationship("ProcessGroup", back_populates="options")

# --- Ğ¢ĞĞ’ĞĞ Ğ˜ ---
class Product(Base):
    __tablename__ = "products"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, index=True)
    description = Column(String, nullable=True)
    category_id = Column(Integer, ForeignKey("categories.id"))
    category = relationship("Category")
    has_variants = Column(Boolean, default=False)
    price = Column(Float, default=0.0)
    output_weight = Column(Float, default=0.0) 
    master_recipe_id = Column(Integer, ForeignKey("master_recipes.id"), nullable=True)
    master_recipe = relationship("MasterRecipe")

    # --- ĞĞĞ’Ğ† ĞŸĞĞ›Ğ¯ ---
    track_stock = Column(Boolean, default=False) # Ğ§Ğ¸ Ğ²ĞµÑÑ‚Ğ¸ ÑĞºĞ»Ğ°Ğ´ÑÑŒĞºĞ¸Ğ¹ Ğ¾Ğ±Ğ»Ñ–Ğº Ñ†ÑŒĞ¾Ğ³Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ
    stock_quantity = Column(Float, default=0.0)  # Ğ—Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº (Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¸Ñ… Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ–Ğ²)

    variants = relationship("ProductVariant", back_populates="product", cascade="all, delete-orphan")
    modifier_groups = relationship("ProductModifierGroup", back_populates="product", cascade="all, delete-orphan")
    consumables = relationship("ProductConsumable", back_populates="product", cascade="all, delete-orphan")
    # ĞĞĞ’Ğ•: Ğ—Ğ²'ÑĞ·Ğ¾Ğº Ğ· Ğ³Ñ€ÑƒĞ¿Ğ°Ğ¼Ğ¸ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ–Ğ²
    process_groups = relationship("ProcessGroup", secondary=product_process_groups, back_populates="products")

# --- Ğ—Ğ²'ÑĞ·Ğ¾Ğº Ğ¢Ğ¾Ğ²Ğ°Ñ€ -> Ğ’Ğ¸Ñ‚Ñ€Ğ°Ñ‚Ğ½Ñ– Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸ ---
class ProductConsumable(Base):
    __tablename__ = "product_consumables"
    id = Column(Integer, primary_key=True, index=True)
    product_id = Column(Integer, ForeignKey("products.id"))
    consumable_id = Column(Integer, ForeignKey("consumables.id"))
    quantity = Column(Float, default=1.0)
    
    product = relationship("Product", back_populates="consumables")
    consumable = relationship("Consumable")

# --- Ğ’ĞĞ Ğ†ĞĞĞ¢Ğ˜ ---
class ProductVariant(Base):
    __tablename__ = "product_variants"
    id = Column(Integer, primary_key=True, index=True)
    product_id = Column(Integer, ForeignKey("products.id"))
    name = Column(String)
    price = Column(Float)
    sku = Column(String, nullable=True)
    output_weight = Column(Float, default=0.0) 
    master_recipe_id = Column(Integer, ForeignKey("master_recipes.id"), nullable=True)
    master_recipe = relationship("MasterRecipe")

    # --- ĞĞĞ’Ğ• ĞŸĞĞ›Ğ• ---
    stock_quantity = Column(Float, default=0.0) # Ğ—Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾Ğ³Ğ¾ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ

    product = relationship("Product", back_populates="variants")
    consumables = relationship("ProductVariantConsumable", back_populates="variant", cascade="all, delete-orphan")
    # !!! ĞĞĞ’Ğ•: Ğ—Ğ²'ÑĞ·Ğ¾Ğº Ğ· Ñ–Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ğ°Ğ¼Ğ¸ !!!
    ingredients = relationship("ProductVariantIngredient", back_populates="variant", cascade="all, delete-orphan")

class ProductVariantConsumable(Base):
    __tablename__ = "product_variant_consumables"
    id = Column(Integer, primary_key=True, index=True)
    variant_id = Column(Integer, ForeignKey("product_variants.id"))
    consumable_id = Column(Integer, ForeignKey("consumables.id"))
    quantity = Column(Float, default=1.0)
    
    variant = relationship("ProductVariant", back_populates="consumables")
    consumable = relationship("Consumable")

# !!! ĞĞĞ’Ğ˜Ğ™ ĞšĞ›ĞĞ¡: Ğ†Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ğ¸ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ !!!
class ProductVariantIngredient(Base):
    __tablename__ = "product_variant_ingredients"
    id = Column(Integer, primary_key=True, index=True)
    variant_id = Column(Integer, ForeignKey("product_variants.id"))
    ingredient_id = Column(Integer, ForeignKey("ingredients.id"))
    quantity = Column(Float, default=0.0) # Ğ¡ĞºÑ–Ğ»ÑŒĞºĞ¸ Ğ³Ñ€Ğ°Ğ¼/Ğ¼Ğ»
    
    variant = relationship("ProductVariant", back_populates="ingredients")
    ingredient = relationship("Ingredient")

# --- ĞœĞĞ”Ğ˜Ğ¤Ğ†ĞšĞĞ¢ĞĞ Ğ˜ ---
class ProductModifierGroup(Base):
    __tablename__ = "product_modifier_groups"
    id = Column(Integer, primary_key=True)
    product_id = Column(Integer, ForeignKey("products.id"))
    name = Column(String)
    is_required = Column(Boolean, default=False)
    product = relationship("Product", back_populates="modifier_groups")
    modifiers = relationship("Modifier", back_populates="group", cascade="all, delete-orphan")

class Modifier(Base):
    __tablename__ = "modifiers"
    id = Column(Integer, primary_key=True)
    group_id = Column(Integer, ForeignKey("product_modifier_groups.id"))
    name = Column(String) 
    price_change = Column(Float, default=0.0)
    ingredient_id = Column(Integer, ForeignKey("ingredients.id"), nullable=True)
    quantity = Column(Float, default=0.0)
    group = relationship("ProductModifierGroup", back_populates="modifiers")
    ingredient = relationship("Ingredient")

# --- CRM/ORDERS ---
class Customer(Base):
    __tablename__ = "customers"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String)
    phone = Column(String, unique=True)
    email = Column(String, nullable=True)
    notes = Column(String, nullable=True)
    created_at = Column(DateTime, default=datetime.now)

class Order(Base):
    __tablename__ = "orders"
    id = Column(Integer, primary_key=True, index=True)
    created_at = Column(DateTime, default=datetime.now)
    total_price = Column(Float)
    payment_method = Column(String)
    customer_id = Column(Integer, ForeignKey("customers.id"), nullable=True)
    customer = relationship("Customer")
    items = relationship("OrderItem", back_populates="order", cascade="all, delete-orphan")

class OrderItem(Base):
    __tablename__ = "order_items"
    id = Column(Integer, primary_key=True, index=True)
    order_id = Column(Integer, ForeignKey("orders.id"))
    product_name = Column(String)
    quantity = Column(Integer)
    price_at_moment = Column(Float)
    details = Column(String, nullable=True) 
    order = relationship("Order", back_populates="items")

# --- Ğ†Ğ¡Ğ¢ĞĞ Ğ†Ğ¯ Ğ Ğ£Ğ¥Ğ£ Ğ¢ĞĞ’ĞĞ Ğ†Ğ’ (TRANSACTIONS) ---
class InventoryTransaction(Base):
    __tablename__ = "inventory_transactions"

    id = Column(Integer, primary_key=True, index=True)
    
    # Ğ¢Ğ¸Ğ¿ ÑÑƒÑ‚Ğ½Ğ¾ÑÑ‚Ñ–: 'ingredient', 'consumable', 'product'
    entity_type = Column(String, index=True) 
    
    # ID ÑÑƒÑ‚Ğ½Ğ¾ÑÑ‚Ñ– (ingredient_id, consumable_id Ğ°Ğ±Ğ¾ product_id)
    entity_id = Column(Integer, index=True)
    
    # ĞĞ°Ğ·Ğ²Ğ° Ğ½Ğ° Ğ¼Ğ¾Ğ¼ĞµĞ½Ñ‚ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ñ–Ñ— (Ñ‰Ğ¾Ğ± ÑĞºÑ‰Ğ¾ Ğ²Ğ¸Ğ´Ğ°Ğ»Ğ¸Ğ»Ğ¸ Ñ‚Ğ¾Ğ²Ğ°Ñ€, Ñ–ÑÑ‚Ğ¾Ñ€Ñ–Ñ Ğ»Ğ¸ÑˆĞ¸Ğ»Ğ°ÑÑŒ)
    entity_name = Column(String)
    
    # Ğ—Ğ¼Ñ–Ğ½Ğ° ĞºÑ–Ğ»ÑŒĞºĞ¾ÑÑ‚Ñ–: +5.0 (Ğ¿Ñ€Ğ¸Ñ…Ñ–Ğ´), -0.5 (ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ½Ñ)
    change_amount = Column(Float)
    
    # Ğ—Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº ĞŸĞ†Ğ¡Ğ›Ğ¯ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ñ–Ñ— (Ğ´Ğ»Ñ ĞºĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»Ñ)
    balance_after = Column(Float)
    
    # ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°: 'manual_update', 'sale_order_#105', 'waste', 'restock'
    reason = Column(String)
    
    created_at = Column(DateTime, default=datetime.now)

--------------------------------------------------
PATH: ./.history/product_service/models_20260123212114.py
--------------------------------------------------
from sqlalchemy import Column, Integer, String, Float, ForeignKey, DateTime, Boolean, Table
from sqlalchemy.orm import relationship, backref
from database import Base
from datetime import datetime

# --- ĞĞ¡ĞĞ¦Ğ†ĞĞ¢Ğ˜Ğ’ĞĞ Ğ¢ĞĞ‘Ğ›Ğ˜Ğ¦Ğ¯: Ğ¢ĞĞ’ĞĞ  <-> Ğ“Ğ Ğ£ĞŸĞ˜ ĞŸĞ ĞĞ¦Ğ•Ğ¡Ğ†Ğ’ ---
# Ğ¦Ğµ Ğ´Ğ¾Ğ·Ğ²Ğ¾Ğ»ÑÑ” Ğ¿Ñ€Ğ¸Ğ²'ÑĞ·Ğ°Ñ‚Ğ¸ "ĞŸĞ¾Ğ¼Ğ¾Ğ»" Ğ´Ğ¾ "Ğ•Ñ„Ñ–Ğ¾Ğ¿Ñ–Ñ—", "ĞšĞ¾Ğ»ÑƒĞ¼Ğ±Ñ–Ñ—" Ñ– "Ğ‘Ñ€Ğ°Ğ·Ğ¸Ğ»Ñ–Ñ—" Ğ¾Ğ´Ğ½Ğ¾Ñ‡Ğ°ÑĞ½Ğ¾
product_process_groups = Table(
    'product_process_groups_link', Base.metadata,
    Column('product_id', Integer, ForeignKey('products.id')),
    Column('process_group_id', Integer, ForeignKey('process_groups.id'))
)

# --- ĞšĞĞ¢Ğ•Ğ“ĞĞ Ğ†Ğ‡ ---
class Category(Base):
    __tablename__ = "categories"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, unique=True, index=True)
    slug = Column(String, unique=True)
    color = Column(String, default="#ffffff")
    parent_id = Column(Integer, ForeignKey("categories.id"), nullable=True)
    children = relationship("Category", backref=backref("parent", remote_side=[id]), cascade="all, delete-orphan")

# --- ĞĞ”Ğ˜ĞĞ˜Ğ¦Ğ† ---
class Unit(Base):
    __tablename__ = "units"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, unique=True)
    symbol = Column(String, unique=True)

# --- Ğ†ĞĞ“Ğ Ğ•Ğ”Ğ†Ğ„ĞĞ¢Ğ˜ ---
class Ingredient(Base):
    __tablename__ = "ingredients"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, index=True, unique=True)
    unit_id = Column(Integer, ForeignKey("units.id"))
    unit = relationship("Unit")
    cost_per_unit = Column(Float, default=0.0)
    stock_quantity = Column(Float, default=0.0)

# --- Ğ’Ğ˜Ğ¢Ğ ĞĞ¢ĞĞ† ĞœĞĞ¢Ğ•Ğ Ğ†ĞĞ›Ğ˜ ---
class Consumable(Base):
    __tablename__ = "consumables"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, index=True, unique=True)
    unit_id = Column(Integer, ForeignKey("units.id"), nullable=True)
    unit = relationship("Unit")
    cost_per_unit = Column(Float, default=0.0)
    stock_quantity = Column(Float, default=0.0)

# --- ĞœĞĞ™Ğ¡Ğ¢Ğ•Ğ -Ğ Ğ•Ğ¦Ğ•ĞŸĞ¢Ğ˜ ---
class MasterRecipe(Base):
    __tablename__ = "master_recipes"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, index=True)
    description = Column(String, nullable=True)
    items = relationship("MasterRecipeItem", back_populates="recipe", cascade="all, delete-orphan")

class MasterRecipeItem(Base):
    __tablename__ = "master_recipe_items"
    id = Column(Integer, primary_key=True, index=True)
    recipe_id = Column(Integer, ForeignKey("master_recipes.id"))
    ingredient_id = Column(Integer, ForeignKey("ingredients.id"))
    quantity = Column(Float)
    is_percentage = Column(Boolean, default=False) 
    recipe = relationship("MasterRecipe", back_populates="items")
    ingredient = relationship("Ingredient")

# --- ĞŸĞ ĞĞ¦Ğ•Ğ¡Ğ˜ (ĞĞĞ’Ğ•) ---
class ProcessGroup(Base):
    __tablename__ = "process_groups"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, index=True) # ĞĞ°Ğ¿Ñ€: "ĞŸĞ¾Ğ¼Ğ¾Ğ»", "ĞŸÑ€Ğ¾ÑĞ¼Ğ°Ğ¶ĞµĞ½Ğ½Ñ"
    
    # Ğ—Ğ²'ÑĞ·Ğ¾Ğº Ğ¾Ğ´Ğ¸Ğ½-Ğ´Ğ¾-Ğ±Ğ°Ğ³Ğ°Ñ‚ÑŒĞ¾Ñ… Ğ· Ğ¾Ğ¿Ñ†Ñ–ÑĞ¼Ğ¸
    options = relationship("ProcessOption", back_populates="group", cascade="all, delete-orphan")
    
    # Ğ—Ğ²'ÑĞ·Ğ¾Ğº Ğ±Ğ°Ğ³Ğ°Ñ‚Ğ¾-Ğ´Ğ¾-Ğ±Ğ°Ğ³Ğ°Ñ‚ÑŒĞ¾Ñ… Ğ· Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°Ğ¼Ğ¸ (Ğ·Ğ²Ğ¾Ñ€Ğ¾Ñ‚Ğ½Ñ–Ğ¹ Ğ±Ñ–Ğº)
    products = relationship("Product", secondary=product_process_groups, back_populates="process_groups")

class ProcessOption(Base):
    __tablename__ = "process_options"
    id = Column(Integer, primary_key=True, index=True)
    group_id = Column(Integer, ForeignKey("process_groups.id"))
    name = Column(String) # ĞĞ°Ğ¿Ñ€: "ĞŸÑ–Ğ´ Ñ‚ÑƒÑ€ĞºÑƒ", "ĞŸÑ–Ğ´ Ñ„Ñ–Ğ»ÑŒÑ‚Ñ€"
    
    group = relationship("ProcessGroup", back_populates="options")

# --- Ğ¢ĞĞ’ĞĞ Ğ˜ ---
class Product(Base):
    __tablename__ = "products"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, index=True)
    description = Column(String, nullable=True)
    category_id = Column(Integer, ForeignKey("categories.id"))
    category = relationship("Category")
    has_variants = Column(Boolean, default=False)
    price = Column(Float, default=0.0)
    output_weight = Column(Float, default=0.0) 
    master_recipe_id = Column(Integer, ForeignKey("master_recipes.id"), nullable=True)
    master_recipe = relationship("MasterRecipe")

    # --- ĞĞĞ’Ğ† ĞŸĞĞ›Ğ¯ ---
    track_stock = Column(Boolean, default=False) # Ğ§Ğ¸ Ğ²ĞµÑÑ‚Ğ¸ ÑĞºĞ»Ğ°Ğ´ÑÑŒĞºĞ¸Ğ¹ Ğ¾Ğ±Ğ»Ñ–Ğº Ñ†ÑŒĞ¾Ğ³Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ
    stock_quantity = Column(Float, default=0.0)  # Ğ—Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº (Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¸Ñ… Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ–Ğ²)

    variants = relationship("ProductVariant", back_populates="product", cascade="all, delete-orphan")
    modifier_groups = relationship("ProductModifierGroup", back_populates="product", cascade="all, delete-orphan")
    consumables = relationship("ProductConsumable", back_populates="product", cascade="all, delete-orphan")
    # ĞĞĞ’Ğ•: Ğ—Ğ²'ÑĞ·Ğ¾Ğº Ğ· Ğ³Ñ€ÑƒĞ¿Ğ°Ğ¼Ğ¸ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ–Ğ²
    process_groups = relationship("ProcessGroup", secondary=product_process_groups, back_populates="products")

# --- Ğ—Ğ²'ÑĞ·Ğ¾Ğº Ğ¢Ğ¾Ğ²Ğ°Ñ€ -> Ğ’Ğ¸Ñ‚Ñ€Ğ°Ñ‚Ğ½Ñ– Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸ ---
class ProductConsumable(Base):
    __tablename__ = "product_consumables"
    id = Column(Integer, primary_key=True, index=True)
    product_id = Column(Integer, ForeignKey("products.id"))
    consumable_id = Column(Integer, ForeignKey("consumables.id"))
    quantity = Column(Float, default=1.0)
    
    product = relationship("Product", back_populates="consumables")
    consumable = relationship("Consumable")

# --- Ğ’ĞĞ Ğ†ĞĞĞ¢Ğ˜ ---
class ProductVariant(Base):
    __tablename__ = "product_variants"
    id = Column(Integer, primary_key=True, index=True)
    product_id = Column(Integer, ForeignKey("products.id"))
    name = Column(String)
    price = Column(Float)
    sku = Column(String, nullable=True)
    output_weight = Column(Float, default=0.0) 
    master_recipe_id = Column(Integer, ForeignKey("master_recipes.id"), nullable=True)
    master_recipe = relationship("MasterRecipe")

    # --- ĞĞĞ’Ğ• ĞŸĞĞ›Ğ• ---
    stock_quantity = Column(Float, default=0.0) # Ğ—Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾Ğ³Ğ¾ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ

    product = relationship("Product", back_populates="variants")
    consumables = relationship("ProductVariantConsumable", back_populates="variant", cascade="all, delete-orphan")
    # !!! ĞĞĞ’Ğ•: Ğ—Ğ²'ÑĞ·Ğ¾Ğº Ğ· Ñ–Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ğ°Ğ¼Ğ¸ !!!
    ingredients = relationship("ProductVariantIngredient", back_populates="variant", cascade="all, delete-orphan")

class ProductVariantConsumable(Base):
    __tablename__ = "product_variant_consumables"
    id = Column(Integer, primary_key=True, index=True)
    variant_id = Column(Integer, ForeignKey("product_variants.id"))
    consumable_id = Column(Integer, ForeignKey("consumables.id"))
    quantity = Column(Float, default=1.0)
    
    variant = relationship("ProductVariant", back_populates="consumables")
    consumable = relationship("Consumable")

# !!! ĞĞĞ’Ğ˜Ğ™ ĞšĞ›ĞĞ¡: Ğ†Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ğ¸ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ !!!
class ProductVariantIngredient(Base):
    __tablename__ = "product_variant_ingredients"
    id = Column(Integer, primary_key=True, index=True)
    variant_id = Column(Integer, ForeignKey("product_variants.id"))
    ingredient_id = Column(Integer, ForeignKey("ingredients.id"))
    quantity = Column(Float, default=0.0) # Ğ¡ĞºÑ–Ğ»ÑŒĞºĞ¸ Ğ³Ñ€Ğ°Ğ¼/Ğ¼Ğ»
    
    variant = relationship("ProductVariant", back_populates="ingredients")
    ingredient = relationship("Ingredient")

# --- ĞœĞĞ”Ğ˜Ğ¤Ğ†ĞšĞĞ¢ĞĞ Ğ˜ ---
class ProductModifierGroup(Base):
    __tablename__ = "product_modifier_groups"
    id = Column(Integer, primary_key=True)
    product_id = Column(Integer, ForeignKey("products.id"))
    name = Column(String)
    is_required = Column(Boolean, default=False)
    product = relationship("Product", back_populates="modifier_groups")
    modifiers = relationship("Modifier", back_populates="group", cascade="all, delete-orphan")

class Modifier(Base):
    __tablename__ = "modifiers"
    id = Column(Integer, primary_key=True)
    group_id = Column(Integer, ForeignKey("product_modifier_groups.id"))
    name = Column(String) 
    price_change = Column(Float, default=0.0)
    ingredient_id = Column(Integer, ForeignKey("ingredients.id"), nullable=True)
    quantity = Column(Float, default=0.0)
    group = relationship("ProductModifierGroup", back_populates="modifiers")
    ingredient = relationship("Ingredient")

# --- CRM/ORDERS ---
class Customer(Base):
    __tablename__ = "customers"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String)
    phone = Column(String, unique=True)
    email = Column(String, nullable=True)
    notes = Column(String, nullable=True)
    created_at = Column(DateTime, default=datetime.now)

class Order(Base):
    __tablename__ = "orders"
    id = Column(Integer, primary_key=True, index=True)
    created_at = Column(DateTime, default=datetime.now)
    total_price = Column(Float)
    payment_method = Column(String)
    customer_id = Column(Integer, ForeignKey("customers.id"), nullable=True)
    customer = relationship("Customer")
    items = relationship("OrderItem", back_populates="order", cascade="all, delete-orphan")

class OrderItem(Base):
    __tablename__ = "order_items"
    id = Column(Integer, primary_key=True, index=True)
    order_id = Column(Integer, ForeignKey("orders.id"))
    product_name = Column(String)
    quantity = Column(Integer)
    price_at_moment = Column(Float)
    details = Column(String, nullable=True) 
    order = relationship("Order", back_populates="items")

# --- Ğ†Ğ¡Ğ¢ĞĞ Ğ†Ğ¯ Ğ Ğ£Ğ¥Ğ£ Ğ¢ĞĞ’ĞĞ Ğ†Ğ’ (TRANSACTIONS) ---
class InventoryTransaction(Base):
    __tablename__ = "inventory_transactions"

    id = Column(Integer, primary_key=True, index=True)
    
    # Ğ¢Ğ¸Ğ¿ ÑÑƒÑ‚Ğ½Ğ¾ÑÑ‚Ñ–: 'ingredient', 'consumable', 'product'
    entity_type = Column(String, index=True) 
    
    # ID ÑÑƒÑ‚Ğ½Ğ¾ÑÑ‚Ñ– (ingredient_id, consumable_id Ğ°Ğ±Ğ¾ product_id)
    entity_id = Column(Integer, index=True)
    
    # ĞĞ°Ğ·Ğ²Ğ° Ğ½Ğ° Ğ¼Ğ¾Ğ¼ĞµĞ½Ñ‚ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ñ–Ñ— (Ñ‰Ğ¾Ğ± ÑĞºÑ‰Ğ¾ Ğ²Ğ¸Ğ´Ğ°Ğ»Ğ¸Ğ»Ğ¸ Ñ‚Ğ¾Ğ²Ğ°Ñ€, Ñ–ÑÑ‚Ğ¾Ñ€Ñ–Ñ Ğ»Ğ¸ÑˆĞ¸Ğ»Ğ°ÑÑŒ)
    entity_name = Column(String)
    
    # Ğ—Ğ¼Ñ–Ğ½Ğ° ĞºÑ–Ğ»ÑŒĞºĞ¾ÑÑ‚Ñ–: +5.0 (Ğ¿Ñ€Ğ¸Ñ…Ñ–Ğ´), -0.5 (ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ½Ñ)
    change_amount = Column(Float)
    
    # Ğ—Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº ĞŸĞ†Ğ¡Ğ›Ğ¯ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ñ–Ñ— (Ğ´Ğ»Ñ ĞºĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»Ñ)
    balance_after = Column(Float)
    
    # ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°: 'manual_update', 'sale_order_#105', 'waste', 'restock'
    reason = Column(String)
    
    created_at = Column(DateTime, default=datetime.now)

--------------------------------------------------
PATH: ./.history/product_service/schemas_20260120113306.py
--------------------------------------------------
from pydantic import BaseModel
from typing import List, Optional
from datetime import datetime

# --- BASIC ---
class Category(BaseModel):
    id: int
    name: str
    slug: str
    color: Optional[str] = "#ffffff"
    parent_id: Optional[int] = None
    class Config: from_attributes = True

class CategoryCreate(BaseModel):
    name: str
    slug: str
    color: Optional[str] = "#ffffff"
    parent_id: Optional[int] = None

class Unit(BaseModel):
    id: int
    name: str
    symbol: str
    class Config: from_attributes = True
class UnitCreate(BaseModel):
    name: str
    symbol: str

class Ingredient(BaseModel):
    id: int
    name: str
    cost_per_unit: float
    stock_quantity: float
    unit_id: Optional[int] = None
    unit: Optional[Unit] = None
    class Config: from_attributes = True
class IngredientCreate(BaseModel):
    name: str
    cost_per_unit: float
    stock_quantity: float
    unit_id: int

# --- ĞĞĞ’Ğ•: Consumables Schemas ---
class ConsumableBase(BaseModel):
    name: str
    cost_per_unit: float
    stock_quantity: float
    unit_id: Optional[int] = None

class ConsumableCreate(ConsumableBase):
    pass

class Consumable(ConsumableBase):
    id: int
    unit: Optional[Unit] = None
    class Config: from_attributes = True

# Ğ¡Ñ…ĞµĞ¼Ğ° Ğ´Ğ»Ñ Ğ·Ğ°Ğ¿Ğ¸ÑÑƒ (Link)
class ProductIngredientLink(BaseModel):
    ingredient_id: int
    quantity: float

# Ğ¡Ñ…ĞµĞ¼Ğ° Ğ´Ğ»Ñ Ñ‡Ğ¸Ñ‚Ğ°Ğ½Ğ½Ñ (Read)
class ProductIngredientRead(BaseModel):
    ingredient_id: int
    quantity: float
    ingredient_name: Optional[str] = None
    class Config: from_attributes = True

# Ğ¡Ñ…ĞµĞ¼Ğ° Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¸Ğ²'ÑĞ·ĞºĞ¸ Ğ²Ğ¸Ñ‚Ñ€Ğ°Ñ‚Ğ½Ğ¸Ñ… Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ñ–Ğ² Ğ´Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ (Ğ´Ğ»Ñ Ğ·Ğ°Ğ¿Ğ¸ÑÑƒ)
class ProductConsumableLink(BaseModel):
    consumable_id: int
    quantity: float = 1.0

# --- Ğ’ĞĞ–Ğ›Ğ˜Ğ’Ğ: ĞŸĞµÑ€ĞµĞ¼Ñ–Ñ‰ĞµĞ½Ğ¾ Ğ¡Ğ®Ğ”Ğ˜ (Ğ¿ĞµÑ€ĞµĞ´ Variants), Ñ‰Ğ¾Ğ± Pydantic Ğ¹Ğ¾Ğ³Ğ¾ Ğ±Ğ°Ñ‡Ğ¸Ğ² ---
class ProductConsumableRead(BaseModel):
    consumable_id: int
    quantity: float
    consumable_name: Optional[str] = None
    class Config: from_attributes = True

# --- PROCESSES (ĞĞĞ’Ğ•) ---
class ProcessOptionCreate(BaseModel):
    name: str # "Ğ”Ñ€Ñ–Ğ±Ğ½Ğ¸Ğ¹", "Ğ—ĞµÑ€Ğ½Ğ¾"
class ProcessOption(ProcessOptionCreate):
    id: int
    group_id: int
    class Config: from_attributes = True

class ProcessGroupCreate(BaseModel):
    name: str # "ĞŸĞ¾Ğ¼Ğ¾Ğ»"
    options: List[ProcessOptionCreate] = []

class ProcessGroup(BaseModel):
    id: int
    name: str
    options: List[ProcessOption] = []
    class Config: from_attributes = True

# --- MASTER RECIPES ---
class MasterRecipeItemCreate(BaseModel):
    ingredient_id: int
    quantity: float
    is_percentage: bool = False 

class MasterRecipeItem(MasterRecipeItemCreate):
    id: int
    ingredient_name: Optional[str] = None 
    class Config: from_attributes = True

class MasterRecipeCreate(BaseModel):
    name: str
    description: Optional[str] = None
    items: List[MasterRecipeItemCreate] = []

class MasterRecipe(MasterRecipeCreate):
    id: int
    items: List[MasterRecipeItem] = []
    class Config: from_attributes = True

# --- MODIFIERS ---
class ModifierCreate(BaseModel):
    name: str
    price_change: float = 0.0
    ingredient_id: Optional[int] = None
    quantity: float = 0.0
class Modifier(ModifierCreate):
    id: int
    class Config: from_attributes = True
class ModifierGroupCreate(BaseModel):
    name: str
    is_required: bool = False
    modifiers: List[ModifierCreate] = []
class ModifierGroup(ModifierGroupCreate):
    id: int
    modifiers: List[Modifier] = []
    class Config: from_attributes = True

# --- VARIANTS ---
class VariantCreate(BaseModel):
    name: str
    price: float
    sku: Optional[str] = None
    output_weight: float = 0.0
    master_recipe_id: Optional[int] = None
    stock_quantity: float = 0.0
    # ĞŸÑ€Ğ¸ ÑÑ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ½Ñ– Ğ²Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ Link (Ñ‚Ñ–Ğ»ÑŒĞºĞ¸ ID Ñ‚Ğ° ĞºÑ–Ğ»ÑŒĞºÑ–ÑÑ‚ÑŒ)
    consumables: List[ProductConsumableLink] = []

    ingredients: List[ProductIngredientLink] = []

class Variant(VariantCreate):
    id: int
    # ĞŸÑ€Ğ¸ Ñ‡Ğ¸Ñ‚Ğ°Ğ½Ğ½Ñ– Ğ²Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ Read (Ğ· Ğ½Ğ°Ğ·Ğ²Ğ¾Ñ), Ñ‚ĞµĞ¿ĞµÑ€ Ñ†Ğµ Ğ¿Ñ€Ğ°Ñ†ÑĞ²Ğ°Ñ‚Ğ¸Ğ¼Ğµ ĞºĞ¾Ñ€ĞµĞºÑ‚Ğ½Ğ¾
    consumables: List[ProductConsumableRead] = []
    ingredients: List[ProductIngredientRead] = [] 
    class Config: from_attributes = True

# --- PRODUCTS ---
class ProductBase(BaseModel):
    name: str
    description: Optional[str] = None
    category_id: Optional[int] = None
    has_variants: bool = False
    price: float = 0.0 
    output_weight: float = 0.0 
    master_recipe_id: Optional[int] = None

    track_stock: bool = False
    stock_quantity: float = 0.0

class ProductCreate(ProductBase):
    variants: List[VariantCreate] = []
    modifier_groups: List[ModifierGroupCreate] = []
    consumables: List[ProductConsumableLink] = []
    
    # ĞĞĞ’Ğ•: Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ID Ğ³Ñ€ÑƒĞ¿ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ–Ğ², ÑĞºÑ– Ñ‚Ñ€ĞµĞ±Ğ° Ğ¿Ñ€Ğ¸Ğ²'ÑĞ·Ğ°Ñ‚Ğ¸
    process_group_ids: List[int] = [] 

class Product(ProductBase):
    id: int
    category: Optional[Category] = None
    variants: List[Variant] = [] 
    modifier_groups: List[ModifierGroup] = []
    master_recipe: Optional[MasterRecipe] = None
    consumables: List[ProductConsumableRead] = [] 
    
    # ĞĞĞ’Ğ•: ĞŸĞ¾Ğ²ĞµÑ€Ñ‚Ğ°Ñ”Ğ¼Ğ¾ Ğ¿Ğ¾Ğ²Ğ½Ñ– Ğ¾Ğ±'Ñ”ĞºÑ‚Ğ¸ Ğ³Ñ€ÑƒĞ¿ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ–Ğ²
    process_groups: List[ProcessGroup] = []

    class Config: from_attributes = True

# --- INVENTORY TRANSACTIONS ---
class InventoryTransactionRead(BaseModel):
    id: int
    entity_type: str
    entity_id: int
    entity_name: str
    change_amount: float
    balance_after: float
    reason: str
    created_at: datetime

    class Config:
        from_attributes = True

# --- ORDERS ---
class SoldItemModifier(BaseModel):
    modifier_id: int
class SoldItem(BaseModel):
    product_id: int
    variant_id: Optional[int] = None
    modifiers: List[SoldItemModifier] = []
    quantity: int
    # Ğ¢ÑƒÑ‚ Ğ¼Ğ¸ Ğ½Ğµ Ğ´Ğ¾Ğ´Ğ°Ñ”Ğ¼Ğ¾ Ğ¾ĞºÑ€ĞµĞ¼Ğµ Ğ¿Ğ¾Ğ»Ğµ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ–Ğ², 
    # Ğ±Ğ¾ Ğ²Ğ¾Ğ½Ğ¸ Ğ¿Ñ€Ğ¸Ñ…Ğ¾Ğ´ÑÑ‚ÑŒ Ğ²Ğ¶Ğµ ÑĞº Ñ‡Ğ°ÑÑ‚Ğ¸Ğ½Ğ° Ğ½Ğ°Ğ·Ğ²Ğ¸ Ğ°Ğ±Ğ¾ details, ÑÑ„Ğ¾Ñ€Ğ¼Ğ¾Ğ²Ğ°Ğ½Ñ– Ğ½Ğ° Ñ„Ñ€Ğ¾Ğ½Ñ‚Ñ–
    # Ğ°Ğ±Ğ¾ Ğ¼Ğ¸ Ğ´Ğ¾Ğ´Ğ°Ğ¼Ğ¾ Ñ—Ñ… Ğ² Ğ¼Ğ°Ğ¹Ğ±ÑƒÑ‚Ğ½ÑŒĞ¾Ğ¼Ñƒ, ÑĞºÑ‰Ğ¾ Ñ‚Ñ€ĞµĞ±Ğ° Ğ±ÑƒĞ´Ğµ.
class OrderCreate(BaseModel):
    items: List[SoldItem]
    payment_method: str
    total_price: float
    customer_id: Optional[int] = None

class CustomerCreate(BaseModel):
    name: str
    phone: str
    email: Optional[str] = None
    notes: Optional[str] = None
class Customer(CustomerCreate):
    id: int
    class Config: from_attributes = True

class OrderItemRead(BaseModel):
    product_name: str
    quantity: int
    price_at_moment: float
    details: Optional[str] = None
    class Config: from_attributes = True
class OrderRead(BaseModel):
    id: int
    created_at: datetime
    total_price: float
    payment_method: str
    items: List[OrderItemRead]
    customer: Optional[Customer] = None
    class Config: from_attributes = True

--------------------------------------------------
PATH: ./.history/product_service/models_20260123212354.py
--------------------------------------------------
from sqlalchemy import Column, Integer, String, Float, ForeignKey, DateTime, Boolean, Table
from sqlalchemy.orm import relationship, backref
from database import Base
from datetime import datetime

# --- ĞĞ¡ĞĞ¦Ğ†ĞĞ¢Ğ˜Ğ’ĞĞ Ğ¢ĞĞ‘Ğ›Ğ˜Ğ¦Ğ¯: Ğ¢ĞĞ’ĞĞ  <-> Ğ“Ğ Ğ£ĞŸĞ˜ ĞŸĞ ĞĞ¦Ğ•Ğ¡Ğ†Ğ’ ---
# Ğ¦Ğµ Ğ´Ğ¾Ğ·Ğ²Ğ¾Ğ»ÑÑ” Ğ¿Ñ€Ğ¸Ğ²'ÑĞ·Ğ°Ñ‚Ğ¸ "ĞŸĞ¾Ğ¼Ğ¾Ğ»" Ğ´Ğ¾ "Ğ•Ñ„Ñ–Ğ¾Ğ¿Ñ–Ñ—", "ĞšĞ¾Ğ»ÑƒĞ¼Ğ±Ñ–Ñ—" Ñ– "Ğ‘Ñ€Ğ°Ğ·Ğ¸Ğ»Ñ–Ñ—" Ğ¾Ğ´Ğ½Ğ¾Ñ‡Ğ°ÑĞ½Ğ¾
product_process_groups = Table(
    'product_process_groups_link', Base.metadata,
    Column('product_id', Integer, ForeignKey('products.id')),
    Column('process_group_id', Integer, ForeignKey('process_groups.id'))
)

# --- ĞšĞĞ¢Ğ•Ğ“ĞĞ Ğ†Ğ‡ ---
class Category(Base):
    __tablename__ = "categories"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, unique=True, index=True)
    slug = Column(String, unique=True)
    color = Column(String, default="#ffffff")
    parent_id = Column(Integer, ForeignKey("categories.id"), nullable=True)
    children = relationship("Category", backref=backref("parent", remote_side=[id]), cascade="all, delete-orphan")

# --- ĞĞ”Ğ˜ĞĞ˜Ğ¦Ğ† ---
class Unit(Base):
    __tablename__ = "units"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, unique=True)
    symbol = Column(String, unique=True)

# --- Ğ†ĞĞ“Ğ Ğ•Ğ”Ğ†Ğ„ĞĞ¢Ğ˜ ---
class Ingredient(Base):
    __tablename__ = "ingredients"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, index=True, unique=True)
    unit_id = Column(Integer, ForeignKey("units.id"))
    unit = relationship("Unit")
    cost_per_unit = Column(Float, default=0.0)
    stock_quantity = Column(Float, default=0.0)

# --- Ğ’Ğ˜Ğ¢Ğ ĞĞ¢ĞĞ† ĞœĞĞ¢Ğ•Ğ Ğ†ĞĞ›Ğ˜ ---
class Consumable(Base):
    __tablename__ = "consumables"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, index=True, unique=True)
    unit_id = Column(Integer, ForeignKey("units.id"), nullable=True)
    unit = relationship("Unit")
    cost_per_unit = Column(Float, default=0.0)
    stock_quantity = Column(Float, default=0.0)

# --- ĞœĞĞ™Ğ¡Ğ¢Ğ•Ğ -Ğ Ğ•Ğ¦Ğ•ĞŸĞ¢Ğ˜ ---
class MasterRecipe(Base):
    __tablename__ = "master_recipes"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, index=True)
    description = Column(String, nullable=True)
    items = relationship("MasterRecipeItem", back_populates="recipe", cascade="all, delete-orphan")

class MasterRecipeItem(Base):
    __tablename__ = "master_recipe_items"
    id = Column(Integer, primary_key=True, index=True)
    recipe_id = Column(Integer, ForeignKey("master_recipes.id"))
    ingredient_id = Column(Integer, ForeignKey("ingredients.id"))
    quantity = Column(Float)
    is_percentage = Column(Boolean, default=False) 
    recipe = relationship("MasterRecipe", back_populates="items")
    ingredient = relationship("Ingredient")

# --- ĞŸĞ ĞĞ¦Ğ•Ğ¡Ğ˜ (ĞĞĞ’Ğ•) ---
class ProcessGroup(Base):
    __tablename__ = "process_groups"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, index=True) # ĞĞ°Ğ¿Ñ€: "ĞŸĞ¾Ğ¼Ğ¾Ğ»", "ĞŸÑ€Ğ¾ÑĞ¼Ğ°Ğ¶ĞµĞ½Ğ½Ñ"
    
    # Ğ—Ğ²'ÑĞ·Ğ¾Ğº Ğ¾Ğ´Ğ¸Ğ½-Ğ´Ğ¾-Ğ±Ğ°Ğ³Ğ°Ñ‚ÑŒĞ¾Ñ… Ğ· Ğ¾Ğ¿Ñ†Ñ–ÑĞ¼Ğ¸
    options = relationship("ProcessOption", back_populates="group", cascade="all, delete-orphan")
    
    # Ğ—Ğ²'ÑĞ·Ğ¾Ğº Ğ±Ğ°Ğ³Ğ°Ñ‚Ğ¾-Ğ´Ğ¾-Ğ±Ğ°Ğ³Ğ°Ñ‚ÑŒĞ¾Ñ… Ğ· Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°Ğ¼Ğ¸ (Ğ·Ğ²Ğ¾Ñ€Ğ¾Ñ‚Ğ½Ñ–Ğ¹ Ğ±Ñ–Ğº)
    products = relationship("Product", secondary=product_process_groups, back_populates="process_groups")

class ProcessOption(Base):
    __tablename__ = "process_options"
    id = Column(Integer, primary_key=True, index=True)
    group_id = Column(Integer, ForeignKey("process_groups.id"))
    name = Column(String) # ĞĞ°Ğ¿Ñ€: "ĞŸÑ–Ğ´ Ñ‚ÑƒÑ€ĞºÑƒ", "ĞŸÑ–Ğ´ Ñ„Ñ–Ğ»ÑŒÑ‚Ñ€"
    
    group = relationship("ProcessGroup", back_populates="options")

# --- Ğ¢ĞĞ’ĞĞ Ğ˜ ---
class Product(Base):
    __tablename__ = "products"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, index=True)
    description = Column(String, nullable=True)
    category_id = Column(Integer, ForeignKey("categories.id"))
    category = relationship("Category")
    has_variants = Column(Boolean, default=False)
    price = Column(Float, default=0.0)
    output_weight = Column(Float, default=0.0) 
    master_recipe_id = Column(Integer, ForeignKey("master_recipes.id"), nullable=True)
    master_recipe = relationship("MasterRecipe")

    # --- ĞĞĞ’Ğ† ĞŸĞĞ›Ğ¯ ---
    track_stock = Column(Boolean, default=False) # Ğ§Ğ¸ Ğ²ĞµÑÑ‚Ğ¸ ÑĞºĞ»Ğ°Ğ´ÑÑŒĞºĞ¸Ğ¹ Ğ¾Ğ±Ğ»Ñ–Ğº Ñ†ÑŒĞ¾Ğ³Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ
    stock_quantity = Column(Float, default=0.0)  # Ğ—Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº (Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¸Ñ… Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ–Ğ²)

    variants = relationship("ProductVariant", back_populates="product", cascade="all, delete-orphan")
    modifier_groups = relationship("ProductModifierGroup", back_populates="product", cascade="all, delete-orphan")
    consumables = relationship("ProductConsumable", back_populates="product", cascade="all, delete-orphan")
    # ĞĞĞ’Ğ•: Ğ—Ğ²'ÑĞ·Ğ¾Ğº Ğ· Ğ³Ñ€ÑƒĞ¿Ğ°Ğ¼Ğ¸ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ–Ğ²
    process_groups = relationship("ProcessGroup", secondary=product_process_groups, back_populates="products")

# --- Ğ—Ğ²'ÑĞ·Ğ¾Ğº Ğ¢Ğ¾Ğ²Ğ°Ñ€ -> Ğ’Ğ¸Ñ‚Ñ€Ğ°Ñ‚Ğ½Ñ– Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸ ---
class ProductConsumable(Base):
    __tablename__ = "product_consumables"
    id = Column(Integer, primary_key=True, index=True)
    product_id = Column(Integer, ForeignKey("products.id"))
    consumable_id = Column(Integer, ForeignKey("consumables.id"))
    quantity = Column(Float, default=1.0)
    
    product = relationship("Product", back_populates="consumables")
    consumable = relationship("Consumable")

# --- Ğ’ĞĞ Ğ†ĞĞĞ¢Ğ˜ ---
class ProductVariant(Base):
    __tablename__ = "product_variants"
    id = Column(Integer, primary_key=True, index=True)
    product_id = Column(Integer, ForeignKey("products.id"))
    name = Column(String)
    price = Column(Float)
    sku = Column(String, nullable=True)
    output_weight = Column(Float, default=0.0) 
    master_recipe_id = Column(Integer, ForeignKey("master_recipes.id"), nullable=True)
    master_recipe = relationship("MasterRecipe")

    # --- ĞĞĞ’Ğ• ĞŸĞĞ›Ğ• ---
    stock_quantity = Column(Float, default=0.0) # Ğ—Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾Ğ³Ğ¾ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ

    product = relationship("Product", back_populates="variants")
    consumables = relationship("ProductVariantConsumable", back_populates="variant", cascade="all, delete-orphan")
    # !!! ĞĞĞ’Ğ•: Ğ—Ğ²'ÑĞ·Ğ¾Ğº Ğ· Ñ–Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ğ°Ğ¼Ğ¸ !!!
    ingredients = relationship("ProductVariantIngredient", back_populates="variant", cascade="all, delete-orphan")

class ProductVariantConsumable(Base):
    __tablename__ = "product_variant_consumables"
    id = Column(Integer, primary_key=True, index=True)
    variant_id = Column(Integer, ForeignKey("product_variants.id"))
    consumable_id = Column(Integer, ForeignKey("consumables.id"))
    quantity = Column(Float, default=1.0)
    
    variant = relationship("ProductVariant", back_populates="consumables")
    consumable = relationship("Consumable")

# !!! ĞĞĞ’Ğ˜Ğ™ ĞšĞ›ĞĞ¡: Ğ†Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ğ¸ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ !!!
class ProductVariantIngredient(Base):
    __tablename__ = "product_variant_ingredients"
    id = Column(Integer, primary_key=True, index=True)
    variant_id = Column(Integer, ForeignKey("product_variants.id"))
    ingredient_id = Column(Integer, ForeignKey("ingredients.id"))
    quantity = Column(Float, default=0.0) # Ğ¡ĞºÑ–Ğ»ÑŒĞºĞ¸ Ğ³Ñ€Ğ°Ğ¼/Ğ¼Ğ»
    
    variant = relationship("ProductVariant", back_populates="ingredients")
    ingredient = relationship("Ingredient")

# --- ĞœĞĞ”Ğ˜Ğ¤Ğ†ĞšĞĞ¢ĞĞ Ğ˜ ---
class ProductModifierGroup(Base):
    __tablename__ = "product_modifier_groups"
    id = Column(Integer, primary_key=True)
    product_id = Column(Integer, ForeignKey("products.id"))
    name = Column(String)
    is_required = Column(Boolean, default=False)
    product = relationship("Product", back_populates="modifier_groups")
    modifiers = relationship("Modifier", back_populates="group", cascade="all, delete-orphan")

class Modifier(Base):
    __tablename__ = "modifiers"
    id = Column(Integer, primary_key=True)
    group_id = Column(Integer, ForeignKey("product_modifier_groups.id"))
    name = Column(String) 
    price_change = Column(Float, default=0.0)
    ingredient_id = Column(Integer, ForeignKey("ingredients.id"), nullable=True)
    quantity = Column(Float, default=0.0)
    group = relationship("ProductModifierGroup", back_populates="modifiers")
    ingredient = relationship("Ingredient")

# --- CRM/ORDERS ---
class Customer(Base):
    __tablename__ = "customers"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String)
    phone = Column(String, unique=True)
    email = Column(String, nullable=True)
    notes = Column(String, nullable=True)
    created_at = Column(DateTime, default=datetime.now)

class Order(Base):
    __tablename__ = "orders"
    id = Column(Integer, primary_key=True, index=True)
    created_at = Column(DateTime, default=datetime.now)
    total_price = Column(Float)
    payment_method = Column(String)
    customer_id = Column(Integer, ForeignKey("customers.id"), nullable=True)
    customer = relationship("Customer")
    items = relationship("OrderItem", back_populates="order", cascade="all, delete-orphan")

class OrderItem(Base):
    __tablename__ = "order_items"
    id = Column(Integer, primary_key=True, index=True)
    order_id = Column(Integer, ForeignKey("orders.id"))
    product_name = Column(String)
    quantity = Column(Integer)
    price_at_moment = Column(Float)
    details = Column(String, nullable=True) 
    order = relationship("Order", back_populates="items")

# --- Ğ†Ğ¡Ğ¢ĞĞ Ğ†Ğ¯ Ğ Ğ£Ğ¥Ğ£ Ğ¢ĞĞ’ĞĞ Ğ†Ğ’ (TRANSACTIONS) ---
class InventoryTransaction(Base):
    __tablename__ = "inventory_transactions"

    id = Column(Integer, primary_key=True, index=True)
    
    # Ğ¢Ğ¸Ğ¿ ÑÑƒÑ‚Ğ½Ğ¾ÑÑ‚Ñ–: 'ingredient', 'consumable', 'product'
    entity_type = Column(String, index=True) 
    
    # ID ÑÑƒÑ‚Ğ½Ğ¾ÑÑ‚Ñ– (ingredient_id, consumable_id Ğ°Ğ±Ğ¾ product_id)
    entity_id = Column(Integer, index=True)
    
    # ĞĞ°Ğ·Ğ²Ğ° Ğ½Ğ° Ğ¼Ğ¾Ğ¼ĞµĞ½Ñ‚ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ñ–Ñ— (Ñ‰Ğ¾Ğ± ÑĞºÑ‰Ğ¾ Ğ²Ğ¸Ğ´Ğ°Ğ»Ğ¸Ğ»Ğ¸ Ñ‚Ğ¾Ğ²Ğ°Ñ€, Ñ–ÑÑ‚Ğ¾Ñ€Ñ–Ñ Ğ»Ğ¸ÑˆĞ¸Ğ»Ğ°ÑÑŒ)
    entity_name = Column(String)
    
    # Ğ—Ğ¼Ñ–Ğ½Ğ° ĞºÑ–Ğ»ÑŒĞºĞ¾ÑÑ‚Ñ–: +5.0 (Ğ¿Ñ€Ğ¸Ñ…Ñ–Ğ´), -0.5 (ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ½Ñ)
    change_amount = Column(Float)
    
    # Ğ—Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº ĞŸĞ†Ğ¡Ğ›Ğ¯ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ñ–Ñ— (Ğ´Ğ»Ñ ĞºĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»Ñ)
    balance_after = Column(Float)
    
    # ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°: 'manual_update', 'sale_order_#105', 'waste', 'restock'
    reason = Column(String)
    
    created_at = Column(DateTime, default=datetime.now)

--------------------------------------------------
PATH: ./.history/product_service/models_20260126084638.py
--------------------------------------------------
from sqlalchemy import Column, Integer, String, Float, Boolean, ForeignKey, DateTime, Text
from sqlalchemy.orm import relationship
from database import Base
from datetime import datetime

# --- ĞšĞĞ¢Ğ•Ğ“ĞĞ Ğ†Ğ‡ ---
class Category(Base):
    __tablename__ = "categories"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, unique=True, index=True)
    slug = Column(String, unique=True)
    color = Column(String, default="#CCCCCC")
    parent_id = Column(Integer, ForeignKey("categories.id"), nullable=True)
    
    products = relationship("Product", back_populates="category")

# --- ĞĞ”Ğ˜ĞĞ˜Ğ¦Ğ† Ğ’Ğ˜ĞœĞ†Ğ Ğ£ ---
class Unit(Base):
    __tablename__ = "units"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, unique=True) # ĞšÑ–Ğ»Ğ¾Ğ³Ñ€Ğ°Ğ¼, Ğ›Ñ–Ñ‚Ñ€
    symbol = Column(String, unique=True) # ĞºĞ³, Ğ», ÑˆÑ‚

# --- Ğ¡Ğ˜Ğ ĞĞ’Ğ˜ĞĞ (Ingredients) ---
class Ingredient(Base):
    __tablename__ = "ingredients"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, unique=True, index=True)
    stock_quantity = Column(Float, default=0.0)
    cost_per_unit = Column(Float, default=0.0)
    
    unit_id = Column(Integer, ForeignKey("units.id"), nullable=True)
    unit = relationship("Unit")

# --- Ğ’Ğ˜Ğ¢Ğ ĞĞ¢ĞĞ† ĞœĞĞ¢Ğ•Ğ Ğ†ĞĞ›Ğ˜ (Consumables) ---
class Consumable(Base):
    __tablename__ = "consumables"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, unique=True)
    stock_quantity = Column(Integer, default=0)
    cost_per_unit = Column(Float, default=0.0)
    
    unit_id = Column(Integer, ForeignKey("units.id"), nullable=True)
    unit = relationship("Unit")

# --- ĞœĞĞ™Ğ¡Ğ¢Ğ•Ğ -Ğ Ğ•Ğ¦Ğ•ĞŸĞ¢Ğ˜ ---
class MasterRecipe(Base):
    __tablename__ = "master_recipes"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String)
    description = Column(String, nullable=True)
    
    items = relationship("MasterRecipeItem", back_populates="recipe", cascade="all, delete-orphan")

class MasterRecipeItem(Base):
    __tablename__ = "master_recipe_items"
    id = Column(Integer, primary_key=True, index=True)
    recipe_id = Column(Integer, ForeignKey("master_recipes.id"))
    ingredient_id = Column(Integer, ForeignKey("ingredients.id"))
    quantity = Column(Float) # Ğ¡ĞºÑ–Ğ»ÑŒĞºĞ¸ Ñ–Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ğ° Ğ¹Ğ´Ğµ
    is_percentage = Column(Boolean, default=False) # Ğ§Ğ¸ Ñ†Ğµ % Ğ²Ñ–Ğ´ Ğ²Ğ°Ğ³Ğ¸

    recipe = relationship("MasterRecipe", back_populates="items")
    ingredient = relationship("Ingredient")

# --- Ğ¢ĞĞ’ĞĞ Ğ˜ (PRODUCTS) ---
class Product(Base):
    __tablename__ = "products"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, index=True)
    description = Column(String, nullable=True)
    price = Column(Float)
    
    category_id = Column(Integer, ForeignKey("categories.id"), nullable=True)
    category = relationship("Category", back_populates="products")
    
    # ĞŸÑ€Ğ°Ğ¿Ğ¾Ñ€ĞµÑ†ÑŒ: Ñ‡Ğ¸ Ñ” Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸ (XL, M, S)
    has_variants = Column(Boolean, default=False)

    # Ğ¯ĞºÑ‰Ğ¾ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñ–Ğ² Ğ½ĞµĞ¼Ğ°Ñ” (Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¸Ğ¹ Ñ‚Ğ¾Ğ²Ğ°Ñ€):
    master_recipe_id = Column(Integer, ForeignKey("master_recipes.id"), nullable=True)
    output_weight = Column(Float, nullable=True) # Ğ’Ğ¸Ñ…Ñ–Ğ´Ğ½Ğ° Ğ²Ğ°Ğ³Ğ°
    track_stock = Column(Boolean, default=False) # Ğ§Ğ¸ Ğ²ĞµÑÑ‚Ğ¸ Ğ¾Ğ±Ğ»Ñ–Ğº Ğ¿Ğ¾ÑˆÑ‚ÑƒÑ‡Ğ½Ğ¾
    stock_quantity = Column(Integer, default=0)  # Ğ—Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº (Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¸Ñ… Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ–Ğ²)

    # Ğ—Ğ²'ÑĞ·ĞºĞ¸
    variants = relationship("ProductVariant", back_populates="product", cascade="all, delete-orphan")
    modifier_groups = relationship("ProductModifierGroup", back_populates="product", cascade="all, delete-orphan")
    
    # Ğ’Ğ¸Ñ‚Ñ€Ğ°Ñ‚Ğ½Ñ– Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸ Ğ½Ğ° Ñ€Ñ–Ğ²Ğ½Ñ– Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ (Ğ½Ğ°Ğ¿Ñ€. ÑĞµÑ€Ğ²ĞµÑ‚ĞºĞ° Ğ´Ğ¾ ĞºĞ¾Ğ¶Ğ½Ğ¾Ğ³Ğ¾ Ğ±ÑƒÑ€Ğ³ĞµÑ€Ğ°)
    consumables = relationship("ProductConsumable", back_populates="product", cascade="all, delete-orphan")

    # ĞŸÑ€Ğ¾Ñ†ĞµÑĞ¸ (Many-to-Many)
    process_groups = relationship("ProcessGroup", secondary="product_process_groups", back_populates="products")

# --- Ğ’ĞĞ Ğ†ĞĞĞ¢Ğ˜ Ğ¢ĞĞ’ĞĞ Ğ£ ---
class ProductVariant(Base):
    __tablename__ = "product_variants"
    id = Column(Integer, primary_key=True, index=True)
    product_id = Column(Integer, ForeignKey("products.id"))
    
    name = Column(String) # "XL", "Ğ’ĞµĞ»Ğ¸ĞºĞ°", "Ğ— ÑĞ¸Ñ€Ğ¾Ğ¼"
    price = Column(Float)
    sku = Column(String, unique=True, nullable=True)
    
    master_recipe_id = Column(Integer, ForeignKey("master_recipes.id"), nullable=True)
    output_weight = Column(Float, nullable=True)
    
    # Ğ”Ğ¾Ğ´Ğ°Ğ½Ğ¾ Ğ´Ğ»Ñ Ğ¾Ğ±Ğ»Ñ–ĞºÑƒ Ğ·Ğ°Ğ»Ğ¸ÑˆĞºÑ–Ğ² Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñ–Ğ²
    stock_quantity = Column(Integer, default=0)

    product = relationship("Product", back_populates="variants")
    
    # Ğ’Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚ Ğ¼Ğ¾Ğ¶Ğµ Ğ¼Ğ°Ñ‚Ğ¸ ÑĞ²Ğ¾Ñ— ÑƒĞ½Ñ–ĞºĞ°Ğ»ÑŒĞ½Ñ– Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸ Ñ‚Ğ° Ñ–Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ğ¸
    consumables = relationship("ProductVariantConsumable", back_populates="variant", cascade="all, delete-orphan")
    ingredients = relationship("ProductVariantIngredient", back_populates="variant", cascade="all, delete-orphan")

# --- Ğ—Ğ’'Ğ¯Ğ—ĞšĞ˜ ĞœĞĞ¢Ğ•Ğ Ğ†ĞĞ›Ğ†Ğ’ Ğ¢Ğ Ğ†ĞĞ“Ğ Ğ•Ğ”Ğ†Ğ„ĞĞ¢Ğ†Ğ’ ---
class ProductConsumable(Base):
    __tablename__ = "product_consumables"
    id = Column(Integer, primary_key=True, index=True)
    product_id = Column(Integer, ForeignKey("products.id"))
    consumable_id = Column(Integer, ForeignKey("consumables.id"))
    quantity = Column(Integer, default=1)
    
    product = relationship("Product", back_populates="consumables")
    consumable = relationship("Consumable")

class ProductVariantConsumable(Base):
    __tablename__ = "product_variant_consumables"
    id = Column(Integer, primary_key=True, index=True)
    variant_id = Column(Integer, ForeignKey("product_variants.id"))
    consumable_id = Column(Integer, ForeignKey("consumables.id"))
    quantity = Column(Integer, default=1)
    
    variant = relationship("ProductVariant", back_populates="consumables")
    consumable = relationship("Consumable")

class ProductVariantIngredient(Base):
    __tablename__ = "product_variant_ingredients"
    id = Column(Integer, primary_key=True, index=True)
    variant_id = Column(Integer, ForeignKey("product_variants.id"))
    ingredient_id = Column(Integer, ForeignKey("ingredients.id"))
    quantity = Column(Float) # Ğ¡ĞºÑ–Ğ»ÑŒĞºĞ¸ Ğ³Ñ€Ğ°Ğ¼/Ğ¼Ğ» Ğ¹Ğ´Ğµ Ğ½Ğ° Ñ†ĞµĞ¹ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚
    
    variant = relationship("ProductVariant", back_populates="ingredients")
    ingredient = relationship("Ingredient")

# --- ĞœĞĞ”Ğ˜Ğ¤Ğ†ĞšĞĞ¢ĞĞ Ğ˜ ---
class ProductModifierGroup(Base):
    __tablename__ = "product_modifier_groups"
    id = Column(Integer, primary_key=True, index=True)
    product_id = Column(Integer, ForeignKey("products.id"))
    name = Column(String) # "Ğ¡Ğ¸Ñ€Ğ¾Ğ¿Ğ¸", "Ğ¢Ğ¾Ğ¿Ñ–Ğ½Ğ³Ğ¸"
    is_required = Column(Boolean, default=False)
    
    product = relationship("Product", back_populates="modifier_groups")
    modifiers = relationship("Modifier", back_populates="group", cascade="all, delete-orphan")

class Modifier(Base):
    __tablename__ = "modifiers"
    id = Column(Integer, primary_key=True, index=True)
    group_id = Column(Integer, ForeignKey("product_modifier_groups.id"))
    name = Column(String) # "ĞšĞ°Ñ€Ğ°Ğ¼ĞµĞ»ÑŒ", "Ğ¨Ğ¾ĞºĞ¾Ğ»Ğ°Ğ´"
    price_change = Column(Float, default=0.0)
    
    # ĞŸÑ€Ğ¸Ğ²'ÑĞ·ĞºĞ° Ğ´Ğ¾ ÑĞºĞ»Ğ°Ğ´Ñƒ (ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ½Ñ Ğ¿Ñ€Ğ¸ Ğ²Ğ¸Ğ±Ğ¾Ñ€Ñ– Ğ¼Ğ¾Ğ´Ğ¸Ñ„Ñ–ĞºĞ°Ñ‚Ğ¾Ñ€Ğ°)
    ingredient_id = Column(Integer, ForeignKey("ingredients.id"), nullable=True)
    quantity = Column(Float, default=0.0) # Ğ¡ĞºÑ–Ğ»ÑŒĞºĞ¸ ÑĞ¿Ğ¸ÑÑƒĞ²Ğ°Ñ‚Ğ¸

    group = relationship("ProductModifierGroup", back_populates="modifiers")

# --- ĞŸĞ ĞĞ¦Ğ•Ğ¡Ğ˜ (ĞšĞ£Ğ¥ĞĞ¯/Ğ‘ĞĞ ) ---
class ProcessGroup(Base):
    __tablename__ = "process_groups"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, unique=True) # "Ğ‘Ğ°Ñ€", "ĞšÑƒÑ…Ğ½Ñ", "Ğ“Ñ€Ğ¸Ğ»ÑŒ"
    
    options = relationship("ProcessOption", back_populates="group", cascade="all, delete-orphan")
    products = relationship("Product", secondary="product_process_groups", back_populates="process_groups")

class ProcessOption(Base):
    __tablename__ = "process_options"
    id = Column(Integer, primary_key=True, index=True)
    group_id = Column(Integer, ForeignKey("process_groups.id"))
    name = Column(String) # "ĞŸÑ–Ğ´ Ñ‚ÑƒÑ€ĞºÑƒ", "Ğ•ÑĞ¿Ñ€ĞµÑĞ¾", "V60"
    
    group = relationship("ProcessGroup", back_populates="options")

class ProductProcessGroup(Base):
    __tablename__ = "product_process_groups"
    product_id = Column(Integer, ForeignKey("products.id"), primary_key=True)
    process_group_id = Column(Integer, ForeignKey("process_groups.id"), primary_key=True)

# --- ĞšĞ›Ğ†Ğ„ĞĞ¢Ğ˜ ---
class Customer(Base):
    __tablename__ = "customers"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String)
    phone = Column(String, unique=True, index=True)
    email = Column(String, nullable=True)
    card_number = Column(String, nullable=True)
    discount_percent = Column(Float, default=0.0)
    bonus_balance = Column(Float, default=0.0)
    notes = Column(Text, nullable=True)
    created_at = Column(DateTime, default=datetime.utcnow)

# --- Ğ—ĞĞœĞĞ’Ğ›Ğ•ĞĞĞ¯ ---
class Order(Base):
    __tablename__ = "orders"
    id = Column(Integer, primary_key=True, index=True)
    
    # Ğ†Ğ½Ñ„Ğ¾
    status = Column(String, default="new") # new, cooking, ready, paid, cancelled
    payment_method = Column(String, nullable=True) # cash, card
    total_amount = Column(Float, default=0.0)
    
    # ĞšĞ»Ñ–Ñ”Ğ½Ñ‚
    customer_id = Column(Integer, ForeignKey("customers.id"), nullable=True)
    
    # Ğ”Ğ°Ñ‚Ğ¸
    created_at = Column(DateTime, default=datetime.utcnow)
    closed_at = Column(DateTime, nullable=True)

    items = relationship("OrderItem", back_populates="order", cascade="all, delete-orphan")

class OrderItem(Base):
    __tablename__ = "order_items"
    id = Column(Integer, primary_key=True, index=True)
    order_id = Column(Integer, ForeignKey("orders.id"))
    
    product_name = Column(String) # Ğ—Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ñ”Ğ¼Ğ¾ ÑĞº Ñ‚ĞµĞºÑÑ‚
    variant_name = Column(String, nullable=True)
    quantity = Column(Integer)
    price_at_moment = Column(Float) # Ğ¦Ñ–Ğ½Ğ° Ğ½Ğ° Ğ¼Ğ¾Ğ¼ĞµĞ½Ñ‚ Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶Ñƒ
    
    order = relationship("Order", back_populates="items")

# ==========================================
# !!! ĞĞĞ’Ğ•: Ğ¢ĞĞ‘Ğ›Ğ˜Ğ¦Ğ¯ Ğ†Ğ¡Ğ¢ĞĞ Ğ†Ğ‡ Ğ Ğ£Ğ¥Ğ£ !!!
# ==========================================
class InventoryTransaction(Base):
    __tablename__ = "inventory_transactions"
    
    id = Column(Integer, primary_key=True, index=True)
    
    # Ğ¢Ğ¸Ğ¿ ÑÑƒÑ‚Ğ½Ğ¾ÑÑ‚Ñ–: 'ingredient', 'consumable', 'product', 'product_variant'
    entity_type = Column(String, index=True)
    
    # ID ÑÑƒÑ‚Ğ½Ğ¾ÑÑ‚Ñ– (ID Ñ–Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ğ° Ğ°Ğ±Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ)
    entity_id = Column(Integer, index=True)
    
    # ĞĞ°Ğ·Ğ²Ğ° Ğ½Ğ° Ğ¼Ğ¾Ğ¼ĞµĞ½Ñ‚ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ñ–Ñ— (Ğ´Ğ»Ñ Ñ–ÑÑ‚Ğ¾Ñ€Ñ–Ñ—, ÑĞºÑ‰Ğ¾ Ğ²Ğ¸Ğ´Ğ°Ğ»ÑÑ‚ÑŒ Ñ‚Ğ¾Ğ²Ğ°Ñ€)
    entity_name = Column(String)
    
    # Ğ—Ğ¼Ñ–Ğ½Ğ° (+5, -2.5)
    change_amount = Column(Float)
    
    # Ğ—Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº ĞŸĞ†Ğ¡Ğ›Ğ¯ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ñ–Ñ—
    balance_after = Column(Float)
    
    # ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ° ('manual_correction', 'sale_order_105', 'write_off')
    reason = Column(String)
    
    created_at = Column(DateTime, default=datetime.utcnow)

--------------------------------------------------
PATH: ./.history/product_service/routers/inventory_20260123122832.py
--------------------------------------------------
# FILE: product_service/routers/inventory.py

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from sqlalchemy import or_
from typing import List
import database, schemas, models
from services.inventory_logger import InventoryLogger

router = APIRouter(tags=["Inventory"])

# --- UNITS (ĞĞ´Ğ¸Ğ½Ğ¸Ñ†Ñ– Ğ²Ğ¸Ğ¼Ñ–Ñ€Ñƒ) ---
@router.post("/units/", response_model=schemas.Unit)
def create_unit(unit: schemas.UnitCreate, db: Session = Depends(database.get_db)):
    exists = db.query(models.Unit).filter(or_(models.Unit.name == unit.name, models.Unit.symbol == unit.symbol)).first()
    if exists: raise HTTPException(status_code=400, detail="ĞĞ´Ğ¸Ğ½Ğ¸Ñ†Ñ Ñ–ÑĞ½ÑƒÑ”")
    db_unit = models.Unit(name=unit.name, symbol=unit.symbol)
    db.add(db_unit); db.commit(); db.refresh(db_unit)
    return db_unit

@router.get("/units/", response_model=List[schemas.Unit])
def read_units(db: Session = Depends(database.get_db)):
    return db.query(models.Unit).all()

# !!! ĞĞ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ Ğ¾Ğ´Ğ¸Ğ½Ğ¸Ñ†Ñ– !!!
@router.put("/units/{unit_id}", response_model=schemas.Unit)
def update_unit(unit_id: int, unit_data: schemas.UnitCreate, db: Session = Depends(database.get_db)):
    db_unit = db.query(models.Unit).filter(models.Unit.id == unit_id).first()
    if not db_unit:
        raise HTTPException(status_code=404, detail="Unit not found")
    
    # ĞĞ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ¿Ğ¾Ğ»Ñ
    db_unit.name = unit_data.name
    db_unit.symbol = unit_data.symbol
    
    db.commit()
    db.refresh(db_unit)
    return db_unit

# !!! ĞĞĞ’Ğ•: Ğ’Ğ¸Ğ´Ğ°Ğ»ĞµĞ½Ğ½Ñ Ğ¾Ğ´Ğ¸Ğ½Ğ¸Ñ†Ñ– !!!
@router.delete("/units/{unit_id}")
def delete_unit(unit_id: int, db: Session = Depends(database.get_db)):
    db_unit = db.query(models.Unit).filter(models.Unit.id == unit_id).first()
    if not db_unit:
        raise HTTPException(status_code=404, detail="Unit not found")
    
    # ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ°: Ñ‡Ğ¸ Ğ²Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ñ‚ÑŒÑÑ Ğ¾Ğ´Ğ¸Ğ½Ğ¸Ñ†Ñ Ğ² Ñ–Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ğ°Ñ… Ğ°Ğ±Ğ¾ Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ°Ñ…?
    # Ğ¯ĞºÑ‰Ğ¾ Ñ‚Ğ°Ğº - Ğ±Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ¸Ñ… Ğ²Ğ¸ĞºĞ¸Ğ½Ğµ Ğ¿Ğ¾Ğ¼Ğ¸Ğ»ĞºÑƒ IntegrityError, Ğ°Ğ»Ğµ ĞºÑ€Ğ°Ñ‰Ğµ Ğ¿ĞµÑ€ĞµĞ²Ñ–Ñ€Ğ¸Ñ‚Ğ¸ Ñ– Ñ‚ÑƒÑ‚,
    # Ğ°Ğ±Ğ¾ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ´Ğ¾Ğ·Ğ²Ğ¾Ğ»Ğ¸Ñ‚Ğ¸ SQLAclhemy Ğ¾Ğ±Ñ€Ğ¾Ğ±Ğ¸Ñ‚Ğ¸ Ñ†Ğµ (Ğ¼Ğ¸ Ğ·Ğ»Ğ¾Ğ²Ğ¸Ğ¼Ğ¾ Ğ¿Ğ¾Ğ¼Ğ¸Ğ»ĞºÑƒ Ğ½Ğ° Ñ„Ñ€Ğ¾Ğ½Ñ‚Ñ–).
    
    try:
        db.delete(db_unit)
        db.commit()
    except Exception as e:
        db.rollback()
        raise HTTPException(status_code=400, detail="Cannot delete unit because it is being used by ingredients or consumables.")
        
    return {"status": "deleted"}

# --- INGREDIENTS (Ğ¡Ğ¸Ñ€Ğ¾Ğ²Ğ¸Ğ½Ğ°) ---
@router.post("/ingredients/", response_model=schemas.Ingredient)
def create_ingredient(ingredient: schemas.IngredientCreate, db: Session = Depends(database.get_db)):
    exists = db.query(models.Ingredient).filter(models.Ingredient.name == ingredient.name).first()
    if exists: raise HTTPException(status_code=400, detail="Ingredient already exists")
    new_item = models.Ingredient(**ingredient.dict())
    db.add(new_item); db.commit(); db.refresh(new_item)
    return new_item

@router.get("/ingredients/", response_model=List[schemas.Ingredient])
def read_ingredients(db: Session = Depends(database.get_db)):
    return db.query(models.Ingredient).all()

@router.put("/ingredients/{ingredient_id}", response_model=schemas.Ingredient)
def update_ingredient(ingredient_id: int, ingredient_data: schemas.IngredientCreate, db: Session = Depends(database.get_db)):
    db_ingredient = db.query(models.Ingredient).filter(models.Ingredient.id == ingredient_id).first()
    if not db_ingredient: raise HTTPException(status_code=404, detail="Ingredient not found")
    
    # 1. Ğ—Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ñ”Ğ¼Ğ¾ ÑÑ‚Ğ°Ñ€Ğ¸Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ
    old_balance = db_ingredient.stock_quantity
    
    # 2. ĞĞ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ¿Ğ¾Ğ»Ñ
    db_ingredient.name = ingredient_data.name
    db_ingredient.unit_id = ingredient_data.unit_id
    db_ingredient.cost_per_unit = ingredient_data.cost_per_unit
    
    # 3. Ğ¯ĞºÑ‰Ğ¾ Ğ·Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº Ğ·Ğ¼Ñ–Ğ½Ğ¸Ğ²ÑÑ - Ğ¿Ğ¸ÑˆĞµĞ¼Ğ¾ Ñ†Ğµ
    if ingredient_data.stock_quantity != old_balance:
        db_ingredient.stock_quantity = ingredient_data.stock_quantity
        # Ğ›ĞĞ“Ğ£Ğ’ĞĞĞĞ¯
        InventoryLogger.log(
            db, 
            entity_type="ingredient", 
            entity_id=db_ingredient.id, 
            entity_name=db_ingredient.name, 
            old_balance=old_balance, 
            new_balance=db_ingredient.stock_quantity, 
            reason="manual_correction"
        )
    
    db.commit(); db.refresh(db_ingredient)
    return db_ingredient

@router.delete("/ingredients/{ingredient_id}")
def delete_ingredient(ingredient_id: int, db: Session = Depends(database.get_db)):
    db_ingredient = db.query(models.Ingredient).filter(models.Ingredient.id == ingredient_id).first()
    if not db_ingredient: raise HTTPException(status_code=404)
    try: 
        db.delete(db_ingredient); db.commit()
    except: 
        db.rollback(); raise HTTPException(status_code=400, detail="Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ñ‚ÑŒÑÑ Ğ² Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ğ°Ñ…")
    return {"status": "deleted"}

# --- CONSUMABLES (Ğ’Ğ¸Ñ‚Ñ€Ğ°Ñ‚Ğ½Ñ– Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸) ---
@router.post("/consumables/", response_model=schemas.Consumable)
def create_consumable(item: schemas.ConsumableCreate, db: Session = Depends(database.get_db)):
    exists = db.query(models.Consumable).filter(models.Consumable.name == item.name).first()
    if exists: raise HTTPException(status_code=400, detail="Ğ’Ğ¶Ğµ Ñ–ÑĞ½ÑƒÑ”")
    new_c = models.Consumable(**item.dict())
    db.add(new_c); db.commit(); db.refresh(new_c)
    return new_c

@router.get("/consumables/", response_model=List[schemas.Consumable])
def read_consumables(db: Session = Depends(database.get_db)):
    return db.query(models.Consumable).all()

@router.put("/consumables/{id}", response_model=schemas.Consumable)
def update_consumable(id: int, item: schemas.ConsumableCreate, db: Session = Depends(database.get_db)):
    db_c = db.query(models.Consumable).filter(models.Consumable.id == id).first()
    if not db_c: raise HTTPException(status_code=404)
    
    old_balance = db_c.stock_quantity # <-- Ğ—Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ñ”Ğ¼Ğ¾ ÑÑ‚Ğ°Ñ€Ğµ

    # ĞĞ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ²ÑĞµ
    for k, v in item.dict().items(): setattr(db_c, k, v)
    
    # Ğ›ĞĞ“Ğ£Ğ’ĞĞĞĞ¯
    InventoryLogger.log(
        db,
        entity_type="consumable",
        entity_id=db_c.id,
        entity_name=db_c.name,
        old_balance=old_balance,
        new_balance=db_c.stock_quantity,
        reason="manual_correction"
    )

    db.commit(); db.refresh(db_c)
    return db_c

@router.delete("/consumables/{id}")
def delete_consumable(id: int, db: Session = Depends(database.get_db)):
    db_c = db.query(models.Consumable).filter(models.Consumable.id == id).first()
    if not db_c: raise HTTPException(status_code=404)
    db.delete(db_c); db.commit()
    return {"status": "deleted"}

# --- HISTORY ---
@router.get("/history/", response_model=List[schemas.InventoryTransactionRead])
def get_inventory_history(entity_type: str = None, entity_id: int = None, limit: int = 50, db: Session = Depends(database.get_db)):
    query = db.query(models.InventoryTransaction)
    
    if entity_type:
        query = query.filter(models.InventoryTransaction.entity_type == entity_type)
    if entity_id:
        query = query.filter(models.InventoryTransaction.entity_id == entity_id)
        
    return query.order_by(models.InventoryTransaction.created_at.desc()).limit(limit).all()

--------------------------------------------------
PATH: ./.history/product_service/routers/products_20260125124228.py
--------------------------------------------------
# FILE: product_service/routers/products.py

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from typing import List
import database, schemas, models
from services.product_service import ProductService
from services.inventory_logger import InventoryLogger

router = APIRouter(prefix="/products", tags=["Products"])

@router.post("/", response_model=schemas.Product)
def create_product(product: schemas.ProductCreate, db: Session = Depends(database.get_db)):
    # Ğ’Ğ¸ĞºĞ»Ğ¸ĞºĞ°Ñ”Ğ¼Ğ¾ ÑĞµÑ€Ğ²Ñ–Ñ, ÑĞºĞ¸Ğ¹ Ğ·Ñ€Ğ¾Ğ±Ğ¸Ñ‚ÑŒ Ğ²ÑÑ Ğ±Ñ€ÑƒĞ´Ğ½Ñƒ Ñ€Ğ¾Ğ±Ğ¾Ñ‚Ñƒ
    return ProductService.create_product(db, product)

@router.put("/{product_id}", response_model=schemas.Product)
def update_product(product_id: int, product_data: schemas.ProductCreate, db: Session = Depends(database.get_db)):
    updated_product = ProductService.update_product(db, product_id, product_data)
    if not updated_product:
        raise HTTPException(status_code=404, detail="Product not found")
    return updated_product

@router.get("/", response_model=List[schemas.Product])
def read_products(db: Session = Depends(database.get_db)):
    products = db.query(models.Product).all()
    
    # --- UI Helper ---
    # Ğ”Ğ¾Ğ·Ğ°Ğ¿Ğ¾Ğ²Ğ½ÑÑ”Ğ¼Ğ¾ Ğ½Ğ°Ğ·Ğ²Ğ¸ Ğ´Ğ»Ñ ĞºÑ€Ğ°ÑĞ¸Ğ²Ğ¾Ğ³Ğ¾ Ğ²Ñ–Ğ´Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ½Ğ° Ñ„Ñ€Ğ¾Ğ½Ñ‚Ñ–
    for p in products:
        # 1. Ğ”Ğ»Ñ ÑĞ°Ğ¼Ğ¾Ğ³Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ
        for c in p.consumables:
            if c.consumable:
                c.consumable_name = c.consumable.name # ĞŸÑ–Ğ´ÑÑ‚Ğ°Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ½Ğ°Ğ·Ğ²Ñƒ

        # 2. Ğ”Ğ›Ğ¯ Ğ’ĞĞ Ğ†ĞĞĞ¢Ğ†Ğ’ (Ğ¦Ğµ Ñ‚Ğµ, Ñ‡Ğ¾Ğ³Ğ¾ Ğ½Ğµ Ğ²Ğ¸ÑÑ‚Ğ°Ñ‡Ğ°Ğ»Ğ¾)
        if p.variants:
            for v in p.variants:
                # ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ
                for vc in v.consumables:
                    if vc.consumable:
                         # Pydantic ÑÑ…ĞµĞ¼Ğ° Ğ¾Ñ‡Ñ–ĞºÑƒÑ” consumable_name, Ğ·Ğ°Ğ¿Ğ¾Ğ²Ğ½ÑÑ”Ğ¼Ğ¾ Ğ¹Ğ¾Ğ³Ğ¾
                        vc.consumable_name = vc.consumable.name 
                
                # Ğ†Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ğ¸ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ
                for vi in v.ingredients:
                    if vi.ingredient:
                        vi.ingredient_name = vi.ingredient.name

    return products

# 1. ĞĞ½Ğ¾Ğ²Ğ¸Ñ‚Ğ¸ Ğ·Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾Ğ³Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ
@router.patch("/{product_id}/stock")
def update_product_stock(product_id: int, qty: float, db: Session = Depends(database.get_db)):
    product = db.query(models.Product).filter(models.Product.id == product_id).first()
    if not product: raise HTTPException(status_code=404)
    
    old_qty = product.stock_quantity
    product.stock_quantity = qty
    
    InventoryLogger.log(db, "product", product.id, product.name, old_qty, qty, "manual_correction")
    
    db.commit()
    return {"status": "updated", "new_quantity": qty}

# 2. ĞĞ½Ğ¾Ğ²Ğ¸Ñ‚Ğ¸ Ğ·Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ
@router.patch("/variants/{variant_id}/stock")
def update_variant_stock(variant_id: int, qty: float, db: Session = Depends(database.get_db)):
    variant = db.query(models.ProductVariant).filter(models.ProductVariant.id == variant_id).first()
    if not variant: raise HTTPException(status_code=404)
    
    old_qty = variant.stock_quantity
    variant.stock_quantity = qty
    
    # ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ğ½Ğ°Ğ·Ğ²Ñƒ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ Ğ´Ğ»Ñ ĞºÑ€Ğ°ÑĞ¸Ğ²Ğ¾Ğ³Ğ¾ Ğ»Ğ¾Ğ³Ñƒ
    p_name = variant.product.name if variant.product else "Unknown"
    full_name = f"{p_name} ({variant.name})"

    InventoryLogger.log(db, "product_variant", variant.id, full_name, old_qty, qty, "manual_correction")
    
    db.commit()
    return {"status": "updated", "new_quantity": qty}

@router.delete("/{product_id}")
def delete_product(product_id: int, db: Session = Depends(database.get_db)):
    product = db.query(models.Product).filter(models.Product.id == product_id).first()
    if not product:
        raise HTTPException(status_code=404, detail="Product not found")
    
    # Ğ’Ğ¸Ğ´Ğ°Ğ»ĞµĞ½Ğ½Ñ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ ĞºĞ°ÑĞºĞ°Ğ´Ğ½Ğ¾ Ğ²Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸ Ñ‚Ğ° Ğ·Ğ²'ÑĞ·ĞºĞ¸ (Ğ·Ğ°Ğ²Ğ´ÑĞºĞ¸ Ğ½Ğ°Ğ»Ğ°ÑˆÑ‚ÑƒĞ²Ğ°Ğ½Ğ½ÑĞ¼ models.py)
    db.delete(product)
    db.commit()
    return {"status": "deleted"}

--------------------------------------------------
PATH: ./.history/product_service/routers/inventory_20260123212423.py
--------------------------------------------------
# FILE: product_service/routers/inventory.py

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from sqlalchemy import or_
from typing import List
import database, schemas, models
from services.inventory_logger import InventoryLogger

router = APIRouter(tags=["Inventory"])

# --- UNITS (ĞĞ´Ğ¸Ğ½Ğ¸Ñ†Ñ– Ğ²Ğ¸Ğ¼Ñ–Ñ€Ñƒ) ---
@router.post("/units/", response_model=schemas.Unit)
def create_unit(unit: schemas.UnitCreate, db: Session = Depends(database.get_db)):
    exists = db.query(models.Unit).filter(or_(models.Unit.name == unit.name, models.Unit.symbol == unit.symbol)).first()
    if exists: raise HTTPException(status_code=400, detail="ĞĞ´Ğ¸Ğ½Ğ¸Ñ†Ñ Ñ–ÑĞ½ÑƒÑ”")
    db_unit = models.Unit(name=unit.name, symbol=unit.symbol)
    db.add(db_unit); db.commit(); db.refresh(db_unit)
    return db_unit

@router.get("/units/", response_model=List[schemas.Unit])
def read_units(db: Session = Depends(database.get_db)):
    return db.query(models.Unit).all()

# !!! ĞĞ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ Ğ¾Ğ´Ğ¸Ğ½Ğ¸Ñ†Ñ– !!!
@router.put("/units/{unit_id}", response_model=schemas.Unit)
def update_unit(unit_id: int, unit_data: schemas.UnitCreate, db: Session = Depends(database.get_db)):
    db_unit = db.query(models.Unit).filter(models.Unit.id == unit_id).first()
    if not db_unit:
        raise HTTPException(status_code=404, detail="Unit not found")
    
    # ĞĞ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ¿Ğ¾Ğ»Ñ
    db_unit.name = unit_data.name
    db_unit.symbol = unit_data.symbol
    
    db.commit()
    db.refresh(db_unit)
    return db_unit

# !!! ĞĞĞ’Ğ•: Ğ’Ğ¸Ğ´Ğ°Ğ»ĞµĞ½Ğ½Ñ Ğ¾Ğ´Ğ¸Ğ½Ğ¸Ñ†Ñ– !!!
@router.delete("/units/{unit_id}")
def delete_unit(unit_id: int, db: Session = Depends(database.get_db)):
    db_unit = db.query(models.Unit).filter(models.Unit.id == unit_id).first()
    if not db_unit:
        raise HTTPException(status_code=404, detail="Unit not found")
    
    # ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ°: Ñ‡Ğ¸ Ğ²Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ñ‚ÑŒÑÑ Ğ¾Ğ´Ğ¸Ğ½Ğ¸Ñ†Ñ Ğ² Ñ–Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ğ°Ñ… Ğ°Ğ±Ğ¾ Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ°Ñ…?
    # Ğ¯ĞºÑ‰Ğ¾ Ñ‚Ğ°Ğº - Ğ±Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ¸Ñ… Ğ²Ğ¸ĞºĞ¸Ğ½Ğµ Ğ¿Ğ¾Ğ¼Ğ¸Ğ»ĞºÑƒ IntegrityError, Ğ°Ğ»Ğµ ĞºÑ€Ğ°Ñ‰Ğµ Ğ¿ĞµÑ€ĞµĞ²Ñ–Ñ€Ğ¸Ñ‚Ğ¸ Ñ– Ñ‚ÑƒÑ‚,
    # Ğ°Ğ±Ğ¾ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ´Ğ¾Ğ·Ğ²Ğ¾Ğ»Ğ¸Ñ‚Ğ¸ SQLAclhemy Ğ¾Ğ±Ñ€Ğ¾Ğ±Ğ¸Ñ‚Ğ¸ Ñ†Ğµ (Ğ¼Ğ¸ Ğ·Ğ»Ğ¾Ğ²Ğ¸Ğ¼Ğ¾ Ğ¿Ğ¾Ğ¼Ğ¸Ğ»ĞºÑƒ Ğ½Ğ° Ñ„Ñ€Ğ¾Ğ½Ñ‚Ñ–).
    
    try:
        db.delete(db_unit)
        db.commit()
    except Exception as e:
        db.rollback()
        raise HTTPException(status_code=400, detail="Cannot delete unit because it is being used by ingredients or consumables.")
        
    return {"status": "deleted"}

# --- INGREDIENTS (Ğ¡Ğ¸Ñ€Ğ¾Ğ²Ğ¸Ğ½Ğ°) ---
@router.post("/ingredients/", response_model=schemas.Ingredient)
def create_ingredient(ingredient: schemas.IngredientCreate, db: Session = Depends(database.get_db)):
    exists = db.query(models.Ingredient).filter(models.Ingredient.name == ingredient.name).first()
    if exists: raise HTTPException(status_code=400, detail="Ingredient already exists")
    new_item = models.Ingredient(**ingredient.dict())
    db.add(new_item); db.commit(); db.refresh(new_item)
    return new_item

@router.get("/ingredients/", response_model=List[schemas.Ingredient])
def read_ingredients(db: Session = Depends(database.get_db)):
    return db.query(models.Ingredient).all()

@router.put("/ingredients/{ingredient_id}", response_model=schemas.Ingredient)
def update_ingredient(ingredient_id: int, ingredient_data: schemas.IngredientCreate, db: Session = Depends(database.get_db)):
    db_ingredient = db.query(models.Ingredient).filter(models.Ingredient.id == ingredient_id).first()
    if not db_ingredient: raise HTTPException(status_code=404, detail="Ingredient not found")
    
    # 1. Ğ—Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ñ”Ğ¼Ğ¾ ÑÑ‚Ğ°Ñ€Ğ¸Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ
    old_balance = db_ingredient.stock_quantity
    
    # 2. ĞĞ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ¿Ğ¾Ğ»Ñ
    db_ingredient.name = ingredient_data.name
    db_ingredient.unit_id = ingredient_data.unit_id
    db_ingredient.cost_per_unit = ingredient_data.cost_per_unit
    
    # 3. Ğ¯ĞºÑ‰Ğ¾ Ğ·Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº Ğ·Ğ¼Ñ–Ğ½Ğ¸Ğ²ÑÑ - Ğ¿Ğ¸ÑˆĞµĞ¼Ğ¾ Ñ†Ğµ
    if ingredient_data.stock_quantity != old_balance:
        db_ingredient.stock_quantity = ingredient_data.stock_quantity
        # Ğ›ĞĞ“Ğ£Ğ’ĞĞĞĞ¯
        InventoryLogger.log(
            db, 
            entity_type="ingredient", 
            entity_id=db_ingredient.id, 
            entity_name=db_ingredient.name, 
            old_balance=old_balance, 
            new_balance=db_ingredient.stock_quantity, 
            reason="manual_correction"
        )
    
    db.commit(); db.refresh(db_ingredient)
    return db_ingredient

@router.delete("/ingredients/{ingredient_id}")
def delete_ingredient(ingredient_id: int, db: Session = Depends(database.get_db)):
    db_ingredient = db.query(models.Ingredient).filter(models.Ingredient.id == ingredient_id).first()
    if not db_ingredient: raise HTTPException(status_code=404)
    try: 
        db.delete(db_ingredient); db.commit()
    except: 
        db.rollback(); raise HTTPException(status_code=400, detail="Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ñ‚ÑŒÑÑ Ğ² Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ğ°Ñ…")
    return {"status": "deleted"}

# --- CONSUMABLES (Ğ’Ğ¸Ñ‚Ñ€Ğ°Ñ‚Ğ½Ñ– Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸) ---
@router.post("/consumables/", response_model=schemas.Consumable)
def create_consumable(item: schemas.ConsumableCreate, db: Session = Depends(database.get_db)):
    exists = db.query(models.Consumable).filter(models.Consumable.name == item.name).first()
    if exists: raise HTTPException(status_code=400, detail="Ğ’Ğ¶Ğµ Ñ–ÑĞ½ÑƒÑ”")
    new_c = models.Consumable(**item.dict())
    db.add(new_c); db.commit(); db.refresh(new_c)
    return new_c

@router.get("/consumables/", response_model=List[schemas.Consumable])
def read_consumables(db: Session = Depends(database.get_db)):
    return db.query(models.Consumable).all()

@router.put("/consumables/{id}", response_model=schemas.Consumable)
def update_consumable(id: int, item: schemas.ConsumableCreate, db: Session = Depends(database.get_db)):
    db_c = db.query(models.Consumable).filter(models.Consumable.id == id).first()
    if not db_c: raise HTTPException(status_code=404)
    
    old_balance = db_c.stock_quantity # <-- Ğ—Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ñ”Ğ¼Ğ¾ ÑÑ‚Ğ°Ñ€Ğµ

    # ĞĞ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ²ÑĞµ
    for k, v in item.dict().items(): setattr(db_c, k, v)
    
    # Ğ›ĞĞ“Ğ£Ğ’ĞĞĞĞ¯
    InventoryLogger.log(
        db,
        entity_type="consumable",
        entity_id=db_c.id,
        entity_name=db_c.name,
        old_balance=old_balance,
        new_balance=db_c.stock_quantity,
        reason="manual_correction"
    )

    db.commit(); db.refresh(db_c)
    return db_c

@router.delete("/consumables/{id}")
def delete_consumable(id: int, db: Session = Depends(database.get_db)):
    db_c = db.query(models.Consumable).filter(models.Consumable.id == id).first()
    if not db_c: raise HTTPException(status_code=404)
    db.delete(db_c); db.commit()
    return {"status": "deleted"}

# --- HISTORY ---
@router.get("/history/", response_model=List[schemas.InventoryTransactionRead])
def get_inventory_history(entity_type: str = None, entity_id: int = None, limit: int = 50, db: Session = Depends(database.get_db)):
    query = db.query(models.InventoryTransaction)
    
    if entity_type:
        query = query.filter(models.InventoryTransaction.entity_type == entity_type)
    if entity_id:
        query = query.filter(models.InventoryTransaction.entity_id == entity_id)
        
    return query.order_by(models.InventoryTransaction.created_at.desc()).limit(limit).all()

--------------------------------------------------
PATH: ./.history/product_service/routers/inventory_20260125204227.py
--------------------------------------------------
# FILE: product_service/routers/inventory.py

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from sqlalchemy import or_
from typing import List
import database, schemas, models
from services.inventory_logger import InventoryLogger

router = APIRouter(tags=["Inventory"])

# --- UNITS (ĞĞ´Ğ¸Ğ½Ğ¸Ñ†Ñ– Ğ²Ğ¸Ğ¼Ñ–Ñ€Ñƒ) ---
@router.post("/units/", response_model=schemas.Unit)
def create_unit(unit: schemas.UnitCreate, db: Session = Depends(database.get_db)):
    exists = db.query(models.Unit).filter(or_(models.Unit.name == unit.name, models.Unit.symbol == unit.symbol)).first()
    if exists: raise HTTPException(status_code=400, detail="ĞĞ´Ğ¸Ğ½Ğ¸Ñ†Ñ Ñ–ÑĞ½ÑƒÑ”")
    db_unit = models.Unit(name=unit.name, symbol=unit.symbol)
    db.add(db_unit); db.commit(); db.refresh(db_unit)
    return db_unit

@router.get("/units/", response_model=List[schemas.Unit])
def read_units(db: Session = Depends(database.get_db)):
    return db.query(models.Unit).all()

# --- INGREDIENTS (Ğ¡Ğ¸Ñ€Ğ¾Ğ²Ğ¸Ğ½Ğ°) ---
@router.post("/ingredients/", response_model=schemas.Ingredient)
def create_ingredient(ingredient: schemas.IngredientCreate, db: Session = Depends(database.get_db)):
    exists = db.query(models.Ingredient).filter(models.Ingredient.name == ingredient.name).first()
    if exists: raise HTTPException(status_code=400, detail="Ingredient already exists")
    new_item = models.Ingredient(**ingredient.dict())
    db.add(new_item); db.commit(); db.refresh(new_item)
    return new_item

@router.get("/ingredients/", response_model=List[schemas.Ingredient])
def read_ingredients(db: Session = Depends(database.get_db)):
    return db.query(models.Ingredient).all()

@router.put("/ingredients/{ingredient_id}", response_model=schemas.Ingredient)
def update_ingredient(ingredient_id: int, ingredient_data: schemas.IngredientCreate, db: Session = Depends(database.get_db)):
    db_ingredient = db.query(models.Ingredient).filter(models.Ingredient.id == ingredient_id).first()
    if not db_ingredient: raise HTTPException(status_code=404, detail="Ingredient not found")
    
    # 1. Ğ—Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ñ”Ğ¼Ğ¾ ÑÑ‚Ğ°Ñ€Ğ¸Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ
    old_balance = db_ingredient.stock_quantity
    
    # 2. ĞĞ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ¿Ğ¾Ğ»Ñ
    db_ingredient.name = ingredient_data.name
    db_ingredient.unit_id = ingredient_data.unit_id
    db_ingredient.cost_per_unit = ingredient_data.cost_per_unit
    
    # 3. Ğ¯ĞºÑ‰Ğ¾ Ğ·Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº Ğ·Ğ¼Ñ–Ğ½Ğ¸Ğ²ÑÑ - Ğ¿Ğ¸ÑˆĞµĞ¼Ğ¾ Ñ†Ğµ
    if ingredient_data.stock_quantity != old_balance:
        db_ingredient.stock_quantity = ingredient_data.stock_quantity
        # Ğ›ĞĞ“Ğ£Ğ’ĞĞĞĞ¯
        InventoryLogger.log(
            db, 
            entity_type="ingredient", 
            entity_id=db_ingredient.id, 
            entity_name=db_ingredient.name, 
            old_balance=old_balance, 
            new_balance=db_ingredient.stock_quantity, 
            reason="manual_correction"
        )
    
    db.commit(); db.refresh(db_ingredient)
    return db_ingredient

@router.delete("/ingredients/{ingredient_id}")
def delete_ingredient(ingredient_id: int, db: Session = Depends(database.get_db)):
    db_ingredient = db.query(models.Ingredient).filter(models.Ingredient.id == ingredient_id).first()
    if not db_ingredient: raise HTTPException(status_code=404)
    try: 
        db.delete(db_ingredient); db.commit()
    except: 
        db.rollback(); raise HTTPException(status_code=400, detail="Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ñ‚ÑŒÑÑ Ğ² Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ğ°Ñ…")
    return {"status": "deleted"}

# --- CONSUMABLES (Ğ’Ğ¸Ñ‚Ñ€Ğ°Ñ‚Ğ½Ñ– Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸) ---
@router.post("/consumables/", response_model=schemas.Consumable)
def create_consumable(item: schemas.ConsumableCreate, db: Session = Depends(database.get_db)):
    exists = db.query(models.Consumable).filter(models.Consumable.name == item.name).first()
    if exists: raise HTTPException(status_code=400, detail="Ğ’Ğ¶Ğµ Ñ–ÑĞ½ÑƒÑ”")
    new_c = models.Consumable(**item.dict())
    db.add(new_c); db.commit(); db.refresh(new_c)
    return new_c

@router.get("/consumables/", response_model=List[schemas.Consumable])
def read_consumables(db: Session = Depends(database.get_db)):
    return db.query(models.Consumable).all()

@router.put("/consumables/{id}", response_model=schemas.Consumable)
def update_consumable(id: int, item: schemas.ConsumableCreate, db: Session = Depends(database.get_db)):
    db_c = db.query(models.Consumable).filter(models.Consumable.id == id).first()
    if not db_c: raise HTTPException(status_code=404)
    
    old_balance = db_c.stock_quantity # <-- Ğ—Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ñ”Ğ¼Ğ¾ ÑÑ‚Ğ°Ñ€Ğµ

    # ĞĞ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ²ÑĞµ
    for k, v in item.dict().items(): setattr(db_c, k, v)
    
    # Ğ›ĞĞ“Ğ£Ğ’ĞĞĞĞ¯
    InventoryLogger.log(
        db,
        entity_type="consumable",
        entity_id=db_c.id,
        entity_name=db_c.name,
        old_balance=old_balance,
        new_balance=db_c.stock_quantity,
        reason="manual_correction"
    )

    db.commit(); db.refresh(db_c)
    return db_c

@router.delete("/consumables/{id}")
def delete_consumable(id: int, db: Session = Depends(database.get_db)):
    db_c = db.query(models.Consumable).filter(models.Consumable.id == id).first()
    if not db_c: raise HTTPException(status_code=404)
    db.delete(db_c); db.commit()
    return {"status": "deleted"}

# --- HISTORY ---
@router.get("/history/", response_model=List[schemas.InventoryTransactionRead])
def get_inventory_history(entity_type: str = None, entity_id: int = None, limit: int = 50, db: Session = Depends(database.get_db)):
    query = db.query(models.InventoryTransaction)
    
    if entity_type:
        query = query.filter(models.InventoryTransaction.entity_type == entity_type)
    if entity_id:
        query = query.filter(models.InventoryTransaction.entity_id == entity_id)
        
    return query.order_by(models.InventoryTransaction.created_at.desc()).limit(limit).all()



--------------------------------------------------
PATH: ./.history/product_service/routers/inventory_20260123212211.py
--------------------------------------------------
# FILE: product_service/routers/inventory.py

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from sqlalchemy import or_
from typing import List
import database, schemas, models
from services.inventory_logger import InventoryLogger

router = APIRouter(tags=["Inventory"])

# --- UNITS (ĞĞ´Ğ¸Ğ½Ğ¸Ñ†Ñ– Ğ²Ğ¸Ğ¼Ñ–Ñ€Ñƒ) ---
@router.post("/units/", response_model=schemas.Unit)
def create_unit(unit: schemas.UnitCreate, db: Session = Depends(database.get_db)):
    exists = db.query(models.Unit).filter(or_(models.Unit.name == unit.name, models.Unit.symbol == unit.symbol)).first()
    if exists: raise HTTPException(status_code=400, detail="ĞĞ´Ğ¸Ğ½Ğ¸Ñ†Ñ Ñ–ÑĞ½ÑƒÑ”")
    db_unit = models.Unit(name=unit.name, symbol=unit.symbol)
    db.add(db_unit); db.commit(); db.refresh(db_unit)
    return db_unit

@router.get("/units/", response_model=List[schemas.Unit])
def read_units(db: Session = Depends(database.get_db)):
    return db.query(models.Unit).all()

# !!! ĞĞ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ Ğ¾Ğ´Ğ¸Ğ½Ğ¸Ñ†Ñ– !!!
@router.put("/units/{unit_id}", response_model=schemas.Unit)
def update_unit(unit_id: int, unit_data: schemas.UnitCreate, db: Session = Depends(database.get_db)):
    db_unit = db.query(models.Unit).filter(models.Unit.id == unit_id).first()
    if not db_unit:
        raise HTTPException(status_code=404, detail="Unit not found")
    
    # ĞĞ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ¿Ğ¾Ğ»Ñ
    db_unit.name = unit_data.name
    db_unit.symbol = unit_data.symbol
    
    db.commit()
    db.refresh(db_unit)
    return db_unit

# !!! ĞĞĞ’Ğ•: Ğ’Ğ¸Ğ´Ğ°Ğ»ĞµĞ½Ğ½Ñ Ğ¾Ğ´Ğ¸Ğ½Ğ¸Ñ†Ñ– !!!
@router.delete("/units/{unit_id}")
def delete_unit(unit_id: int, db: Session = Depends(database.get_db)):
    db_unit = db.query(models.Unit).filter(models.Unit.id == unit_id).first()
    if not db_unit:
        raise HTTPException(status_code=404, detail="Unit not found")
    
    # ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ°: Ñ‡Ğ¸ Ğ²Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ñ‚ÑŒÑÑ Ğ¾Ğ´Ğ¸Ğ½Ğ¸Ñ†Ñ Ğ² Ñ–Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ğ°Ñ… Ğ°Ğ±Ğ¾ Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ°Ñ…?
    # Ğ¯ĞºÑ‰Ğ¾ Ñ‚Ğ°Ğº - Ğ±Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ¸Ñ… Ğ²Ğ¸ĞºĞ¸Ğ½Ğµ Ğ¿Ğ¾Ğ¼Ğ¸Ğ»ĞºÑƒ IntegrityError, Ğ°Ğ»Ğµ ĞºÑ€Ğ°Ñ‰Ğµ Ğ¿ĞµÑ€ĞµĞ²Ñ–Ñ€Ğ¸Ñ‚Ğ¸ Ñ– Ñ‚ÑƒÑ‚,
    # Ğ°Ğ±Ğ¾ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ´Ğ¾Ğ·Ğ²Ğ¾Ğ»Ğ¸Ñ‚Ğ¸ SQLAclhemy Ğ¾Ğ±Ñ€Ğ¾Ğ±Ğ¸Ñ‚Ğ¸ Ñ†Ğµ (Ğ¼Ğ¸ Ğ·Ğ»Ğ¾Ğ²Ğ¸Ğ¼Ğ¾ Ğ¿Ğ¾Ğ¼Ğ¸Ğ»ĞºÑƒ Ğ½Ğ° Ñ„Ñ€Ğ¾Ğ½Ñ‚Ñ–).
    
    try:
        db.delete(db_unit)
        db.commit()
    except Exception as e:
        db.rollback()
        raise HTTPException(status_code=400, detail="Cannot delete unit because it is being used by ingredients or consumables.")
        
    return {"status": "deleted"}

# --- INGREDIENTS (Ğ¡Ğ¸Ñ€Ğ¾Ğ²Ğ¸Ğ½Ğ°) ---
@router.post("/ingredients/", response_model=schemas.Ingredient)
def create_ingredient(ingredient: schemas.IngredientCreate, db: Session = Depends(database.get_db)):
    exists = db.query(models.Ingredient).filter(models.Ingredient.name == ingredient.name).first()
    if exists: raise HTTPException(status_code=400, detail="Ingredient already exists")
    new_item = models.Ingredient(**ingredient.dict())
    db.add(new_item); db.commit(); db.refresh(new_item)
    return new_item

@router.get("/ingredients/", response_model=List[schemas.Ingredient])
def read_ingredients(db: Session = Depends(database.get_db)):
    return db.query(models.Ingredient).all()

@router.put("/ingredients/{ingredient_id}", response_model=schemas.Ingredient)
def update_ingredient(ingredient_id: int, ingredient_data: schemas.IngredientCreate, db: Session = Depends(database.get_db)):
    db_ingredient = db.query(models.Ingredient).filter(models.Ingredient.id == ingredient_id).first()
    if not db_ingredient: raise HTTPException(status_code=404, detail="Ingredient not found")
    
    # 1. Ğ—Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ñ”Ğ¼Ğ¾ ÑÑ‚Ğ°Ñ€Ğ¸Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ
    old_balance = db_ingredient.stock_quantity
    
    # 2. ĞĞ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ¿Ğ¾Ğ»Ñ
    db_ingredient.name = ingredient_data.name
    db_ingredient.unit_id = ingredient_data.unit_id
    db_ingredient.cost_per_unit = ingredient_data.cost_per_unit
    
    # 3. Ğ¯ĞºÑ‰Ğ¾ Ğ·Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº Ğ·Ğ¼Ñ–Ğ½Ğ¸Ğ²ÑÑ - Ğ¿Ğ¸ÑˆĞµĞ¼Ğ¾ Ñ†Ğµ
    if ingredient_data.stock_quantity != old_balance:
        db_ingredient.stock_quantity = ingredient_data.stock_quantity
        # Ğ›ĞĞ“Ğ£Ğ’ĞĞĞĞ¯
        InventoryLogger.log(
            db, 
            entity_type="ingredient", 
            entity_id=db_ingredient.id, 
            entity_name=db_ingredient.name, 
            old_balance=old_balance, 
            new_balance=db_ingredient.stock_quantity, 
            reason="manual_correction"
        )
    
    db.commit(); db.refresh(db_ingredient)
    return db_ingredient

@router.delete("/ingredients/{ingredient_id}")
def delete_ingredient(ingredient_id: int, db: Session = Depends(database.get_db)):
    db_ingredient = db.query(models.Ingredient).filter(models.Ingredient.id == ingredient_id).first()
    if not db_ingredient: raise HTTPException(status_code=404)
    try: 
        db.delete(db_ingredient); db.commit()
    except: 
        db.rollback(); raise HTTPException(status_code=400, detail="Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ñ‚ÑŒÑÑ Ğ² Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ğ°Ñ…")
    return {"status": "deleted"}

# --- CONSUMABLES (Ğ’Ğ¸Ñ‚Ñ€Ğ°Ñ‚Ğ½Ñ– Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸) ---
@router.post("/consumables/", response_model=schemas.Consumable)
def create_consumable(item: schemas.ConsumableCreate, db: Session = Depends(database.get_db)):
    exists = db.query(models.Consumable).filter(models.Consumable.name == item.name).first()
    if exists: raise HTTPException(status_code=400, detail="Ğ’Ğ¶Ğµ Ñ–ÑĞ½ÑƒÑ”")
    new_c = models.Consumable(**item.dict())
    db.add(new_c); db.commit(); db.refresh(new_c)
    return new_c

@router.get("/consumables/", response_model=List[schemas.Consumable])
def read_consumables(db: Session = Depends(database.get_db)):
    return db.query(models.Consumable).all()

@router.put("/consumables/{id}", response_model=schemas.Consumable)
def update_consumable(id: int, item: schemas.ConsumableCreate, db: Session = Depends(database.get_db)):
    db_c = db.query(models.Consumable).filter(models.Consumable.id == id).first()
    if not db_c: raise HTTPException(status_code=404)
    
    old_balance = db_c.stock_quantity # <-- Ğ—Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ñ”Ğ¼Ğ¾ ÑÑ‚Ğ°Ñ€Ğµ

    # ĞĞ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ²ÑĞµ
    for k, v in item.dict().items(): setattr(db_c, k, v)
    
    # Ğ›ĞĞ“Ğ£Ğ’ĞĞĞĞ¯
    InventoryLogger.log(
        db,
        entity_type="consumable",
        entity_id=db_c.id,
        entity_name=db_c.name,
        old_balance=old_balance,
        new_balance=db_c.stock_quantity,
        reason="manual_correction"
    )

    db.commit(); db.refresh(db_c)
    return db_c

@router.delete("/consumables/{id}")
def delete_consumable(id: int, db: Session = Depends(database.get_db)):
    db_c = db.query(models.Consumable).filter(models.Consumable.id == id).first()
    if not db_c: raise HTTPException(status_code=404)
    db.delete(db_c); db.commit()
    return {"status": "deleted"}

# --- HISTORY ---
@router.get("/history/", response_model=List[schemas.InventoryTransactionRead])
def get_inventory_history(entity_type: str = None, entity_id: int = None, limit: int = 50, db: Session = Depends(database.get_db)):
    query = db.query(models.InventoryTransaction)
    
    if entity_type:
        query = query.filter(models.InventoryTransaction.entity_type == entity_type)
    if entity_id:
        query = query.filter(models.InventoryTransaction.entity_id == entity_id)
        
    return query.order_by(models.InventoryTransaction.created_at.desc()).limit(limit).all()

--------------------------------------------------
PATH: ./.history/product_service/routers/inventory_20260125095952.py
--------------------------------------------------
# FILE: product_service/routers/inventory.py

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from sqlalchemy import or_
from typing import List
import database, schemas, models
from services.inventory_logger import InventoryLogger

router = APIRouter(tags=["Inventory"])

# --- UNITS (ĞĞ´Ğ¸Ğ½Ğ¸Ñ†Ñ– Ğ²Ğ¸Ğ¼Ñ–Ñ€Ñƒ) ---
@router.post("/units/", response_model=schemas.Unit)
def create_unit(unit: schemas.UnitCreate, db: Session = Depends(database.get_db)):
    exists = db.query(models.Unit).filter(or_(models.Unit.name == unit.name, models.Unit.symbol == unit.symbol)).first()
    if exists: raise HTTPException(status_code=400, detail="ĞĞ´Ğ¸Ğ½Ğ¸Ñ†Ñ Ñ–ÑĞ½ÑƒÑ”")
    db_unit = models.Unit(name=unit.name, symbol=unit.symbol)
    db.add(db_unit); db.commit(); db.refresh(db_unit)
    return db_unit

@router.get("/units/", response_model=List[schemas.Unit])
def read_units(db: Session = Depends(database.get_db)):
    return db.query(models.Unit).all()

# --- INGREDIENTS (Ğ¡Ğ¸Ñ€Ğ¾Ğ²Ğ¸Ğ½Ğ°) ---
@router.post("/ingredients/", response_model=schemas.Ingredient)
def create_ingredient(ingredient: schemas.IngredientCreate, db: Session = Depends(database.get_db)):
    exists = db.query(models.Ingredient).filter(models.Ingredient.name == ingredient.name).first()
    if exists: raise HTTPException(status_code=400, detail="Ingredient already exists")
    new_item = models.Ingredient(**ingredient.dict())
    db.add(new_item); db.commit(); db.refresh(new_item)
    return new_item

@router.get("/ingredients/", response_model=List[schemas.Ingredient])
def read_ingredients(db: Session = Depends(database.get_db)):
    return db.query(models.Ingredient).all()

@router.put("/ingredients/{ingredient_id}", response_model=schemas.Ingredient)
def update_ingredient(ingredient_id: int, ingredient_data: schemas.IngredientCreate, db: Session = Depends(database.get_db)):
    db_ingredient = db.query(models.Ingredient).filter(models.Ingredient.id == ingredient_id).first()
    if not db_ingredient: raise HTTPException(status_code=404, detail="Ingredient not found")
    
    # 1. Ğ—Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ñ”Ğ¼Ğ¾ ÑÑ‚Ğ°Ñ€Ğ¸Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ
    old_balance = db_ingredient.stock_quantity
    
    # 2. ĞĞ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ¿Ğ¾Ğ»Ñ
    db_ingredient.name = ingredient_data.name
    db_ingredient.unit_id = ingredient_data.unit_id
    db_ingredient.cost_per_unit = ingredient_data.cost_per_unit
    
    # 3. Ğ¯ĞºÑ‰Ğ¾ Ğ·Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº Ğ·Ğ¼Ñ–Ğ½Ğ¸Ğ²ÑÑ - Ğ¿Ğ¸ÑˆĞµĞ¼Ğ¾ Ñ†Ğµ
    if ingredient_data.stock_quantity != old_balance:
        db_ingredient.stock_quantity = ingredient_data.stock_quantity
        # Ğ›ĞĞ“Ğ£Ğ’ĞĞĞĞ¯
        InventoryLogger.log(
            db, 
            entity_type="ingredient", 
            entity_id=db_ingredient.id, 
            entity_name=db_ingredient.name, 
            old_balance=old_balance, 
            new_balance=db_ingredient.stock_quantity, 
            reason="manual_correction"
        )
    
    db.commit(); db.refresh(db_ingredient)
    return db_ingredient

@router.delete("/ingredients/{ingredient_id}")
def delete_ingredient(ingredient_id: int, db: Session = Depends(database.get_db)):
    db_ingredient = db.query(models.Ingredient).filter(models.Ingredient.id == ingredient_id).first()
    if not db_ingredient: raise HTTPException(status_code=404)
    try: 
        db.delete(db_ingredient); db.commit()
    except: 
        db.rollback(); raise HTTPException(status_code=400, detail="Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ñ‚ÑŒÑÑ Ğ² Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ğ°Ñ…")
    return {"status": "deleted"}

# --- CONSUMABLES (Ğ’Ğ¸Ñ‚Ñ€Ğ°Ñ‚Ğ½Ñ– Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸) ---
@router.post("/consumables/", response_model=schemas.Consumable)
def create_consumable(item: schemas.ConsumableCreate, db: Session = Depends(database.get_db)):
    exists = db.query(models.Consumable).filter(models.Consumable.name == item.name).first()
    if exists: raise HTTPException(status_code=400, detail="Ğ’Ğ¶Ğµ Ñ–ÑĞ½ÑƒÑ”")
    new_c = models.Consumable(**item.dict())
    db.add(new_c); db.commit(); db.refresh(new_c)
    return new_c

@router.get("/consumables/", response_model=List[schemas.Consumable])
def read_consumables(db: Session = Depends(database.get_db)):
    return db.query(models.Consumable).all()

@router.put("/consumables/{id}", response_model=schemas.Consumable)
def update_consumable(id: int, item: schemas.ConsumableCreate, db: Session = Depends(database.get_db)):
    db_c = db.query(models.Consumable).filter(models.Consumable.id == id).first()
    if not db_c: raise HTTPException(status_code=404)
    
    old_balance = db_c.stock_quantity # <-- Ğ—Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ñ”Ğ¼Ğ¾ ÑÑ‚Ğ°Ñ€Ğµ

    # ĞĞ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ²ÑĞµ
    for k, v in item.dict().items(): setattr(db_c, k, v)
    
    # Ğ›ĞĞ“Ğ£Ğ’ĞĞĞĞ¯
    InventoryLogger.log(
        db,
        entity_type="consumable",
        entity_id=db_c.id,
        entity_name=db_c.name,
        old_balance=old_balance,
        new_balance=db_c.stock_quantity,
        reason="manual_correction"
    )

    db.commit(); db.refresh(db_c)
    return db_c

@router.delete("/consumables/{id}")
def delete_consumable(id: int, db: Session = Depends(database.get_db)):
    db_c = db.query(models.Consumable).filter(models.Consumable.id == id).first()
    if not db_c: raise HTTPException(status_code=404)
    db.delete(db_c); db.commit()
    return {"status": "deleted"}

# --- HISTORY ---
@router.get("/history/", response_model=List[schemas.InventoryTransactionRead])
def get_inventory_history(entity_type: str = None, entity_id: int = None, limit: int = 50, db: Session = Depends(database.get_db)):
    query = db.query(models.InventoryTransaction)
    
    if entity_type:
        query = query.filter(models.InventoryTransaction.entity_type == entity_type)
    if entity_id:
        query = query.filter(models.InventoryTransaction.entity_id == entity_id)
        
    return query.order_by(models.InventoryTransaction.created_at.desc()).limit(limit).all()



--------------------------------------------------
PATH: ./.history/product_service/routers/products_20260125204117.py
--------------------------------------------------
from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from typing import List
import database, schemas, models
from services.product_service import ProductService
from services.inventory_logger import InventoryLogger

router = APIRouter(prefix="/products", tags=["Products"])

@router.post("/", response_model=schemas.Product)
def create_product(product: schemas.ProductCreate, db: Session = Depends(database.get_db)):
    return ProductService.create_product(db, product)

@router.put("/{product_id}", response_model=schemas.Product)
def update_product(product_id: int, product_data: schemas.ProductCreate, db: Session = Depends(database.get_db)):
    updated_product = ProductService.update_product(db, product_id, product_data)
    if not updated_product:
        raise HTTPException(status_code=404, detail="Product not found")
    return updated_product

@router.get("/", response_model=List[schemas.Product])
def read_products(db: Session = Depends(database.get_db)):
    products = db.query(models.Product).all()
    
    # --- UI Helper (Ğ¿Ñ–Ğ´ÑÑ‚Ğ°Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ½Ğ°Ğ·Ğ²Ğ¸ Ğ´Ğ»Ñ Ñ„Ñ€Ğ¾Ğ½Ñ‚ĞµĞ½Ğ´Ñƒ) ---
    for p in products:
        for c in p.consumables:
            if c.consumable: c.consumable_name = c.consumable.name

        if p.variants:
            for v in p.variants:
                for vc in v.consumables:
                    if vc.consumable: vc.consumable_name = vc.consumable.name 
                for vi in v.ingredients:
                    if vi.ingredient: vi.ingredient_name = vi.ingredient.name

    return products

@router.delete("/{product_id}")
def delete_product(product_id: int, db: Session = Depends(database.get_db)):
    product = db.query(models.Product).filter(models.Product.id == product_id).first()
    if not product:
        raise HTTPException(status_code=404, detail="Product not found")
    
    # Ğ’Ğ¸Ğ´Ğ°Ğ»ĞµĞ½Ğ½Ñ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ (ĞºĞ°ÑĞºĞ°Ğ´Ğ½Ğµ Ğ²Ğ¸Ğ´Ğ°Ğ»ĞµĞ½Ğ½Ñ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñ–Ğ² Ğ½Ğ°Ğ»Ğ°ÑˆÑ‚Ğ¾Ğ²Ğ°Ğ½Ğ¾ Ğ² Ğ¼Ğ¾Ğ´ĞµĞ»ÑÑ…)
    db.delete(product)
    db.commit()
    return {"status": "deleted"}

# ==========================================
# Ğ£ĞŸĞ ĞĞ’Ğ›Ğ†ĞĞĞ¯ Ğ¡ĞšĞ›ĞĞ”ĞĞœ Ğ¢Ğ Ğ†Ğ¡Ğ¢ĞĞ Ğ†Ğ¯
# ==========================================

# 1. ĞĞ½Ğ¾Ğ²Ğ¸Ñ‚Ğ¸ Ğ·Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾Ğ³Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ (Ğ ÑƒÑ‡Ğ½Ğ° ĞºĞ¾Ñ€ĞµĞºÑ†Ñ–Ñ)
@router.patch("/{product_id}/stock")
def update_product_stock(product_id: int, qty: float, db: Session = Depends(database.get_db)):
    product = db.query(models.Product).filter(models.Product.id == product_id).first()
    if not product: raise HTTPException(status_code=404)
    
    old_qty = product.stock_quantity
    product.stock_quantity = qty
    
    # Ğ›Ğ¾Ğ³ÑƒÑ”Ğ¼Ğ¾ Ñ€ÑƒÑ‡Ğ½Ñƒ ĞºĞ¾Ñ€ĞµĞºÑ†Ñ–Ñ
    InventoryLogger.log(
        db, "product", product.id, product.name, 
        old_qty, qty, "manual_correction"
    )
    
    db.commit()
    return {"status": "updated", "new_quantity": qty}

# 2. ĞĞ½Ğ¾Ğ²Ğ¸Ñ‚Ğ¸ Ğ·Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ (Ğ ÑƒÑ‡Ğ½Ğ° ĞºĞ¾Ñ€ĞµĞºÑ†Ñ–Ñ)
@router.patch("/variants/{variant_id}/stock")
def update_variant_stock(variant_id: int, qty: float, db: Session = Depends(database.get_db)):
    variant = db.query(models.ProductVariant).filter(models.ProductVariant.id == variant_id).first()
    if not variant: raise HTTPException(status_code=404)
    
    old_qty = variant.stock_quantity
    variant.stock_quantity = qty
    
    # ĞšÑ€Ğ°ÑĞ¸Ğ²Ğ° Ğ½Ğ°Ğ·Ğ²Ğ°: "ĞšĞ°Ğ²Ğ° (XL)"
    p_name = variant.product.name if variant.product else "Unknown"
    full_name = f"{p_name} ({variant.name})"

    # Ğ›Ğ¾Ğ³ÑƒÑ”Ğ¼Ğ¾ Ñ€ÑƒÑ‡Ğ½Ñƒ ĞºĞ¾Ñ€ĞµĞºÑ†Ñ–Ñ
    InventoryLogger.log(
        db, "product_variant", variant.id, full_name, 
        old_qty, qty, "manual_correction"
    )
    
    db.commit()
    return {"status": "updated", "new_quantity": qty}

# 3. Ğ¡ĞŸĞ˜Ğ¡ĞĞĞĞ¯ ĞŸĞ Ğ˜ ĞŸĞ ĞĞ”ĞĞ–Ğ† (Ğ¦Ğµ Ñ‚Ğµ, Ñ‡Ğ¾Ğ³Ğ¾ Ğ½Ğµ Ğ²Ğ¸ÑÑ‚Ğ°Ñ‡Ğ°Ğ»Ğ¾ Ğ´Ğ»Ñ Ñ–ÑÑ‚Ğ¾Ñ€Ñ–Ñ— Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶Ñ–Ğ²)
@router.post("/deduct_stock_for_order")
def deduct_stock_for_order(items: List[schemas.StockDeductionItem], db: Session = Depends(database.get_db)):
    """
    Ğ¦ĞµĞ¹ Ğ¼ĞµÑ‚Ğ¾Ğ´ Ğ²Ğ¸ĞºĞ»Ğ¸ĞºĞ°Ñ”Ñ‚ÑŒÑÑ Order Service, ĞºĞ¾Ğ»Ğ¸ Ğ·Ğ°Ğ¼Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ Ğ¾Ğ¿Ğ»Ğ°Ñ‡ĞµĞ½Ğ¾.
    Ğ’Ñ–Ğ½ ÑĞ¿Ğ¸ÑÑƒÑ” Ğ·Ğ°Ğ»Ğ¸ÑˆĞºĞ¸ Ñ– Ğ·Ğ°Ğ¿Ğ¸ÑÑƒÑ” Ğ¿Ñ€Ğ¸Ñ‡Ğ¸Ğ½Ñƒ 'sale_order_ID'.
    """
    for item in items:
        # Ğ›Ğ¾Ğ³Ñ–ĞºĞ° Ğ´Ğ»Ñ Ğ’ĞĞ Ğ†ĞĞĞ¢Ğ†Ğ’
        if item.type == 'product_variant':
            variant = db.query(models.ProductVariant).filter(models.ProductVariant.id == item.id).first()
            if variant:
                old = variant.stock_quantity
                variant.stock_quantity -= item.quantity
                
                # Ğ›Ğ¾Ğ³ÑƒÑ”Ğ¼Ğ¾ Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶
                InventoryLogger.log(
                    db, "product_variant", variant.id, 
                    f"{variant.product.name} ({variant.name})", 
                    old, variant.stock_quantity, 
                    f"sale_order_{item.order_id}" # ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°: ĞŸÑ€Ğ¾Ğ´Ğ°Ğ¶ (ID Ğ·Ğ°Ğ¼Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ)
                )

        # Ğ›Ğ¾Ğ³Ñ–ĞºĞ° Ğ´Ğ»Ñ ĞŸĞ ĞĞ¡Ğ¢Ğ˜Ğ¥ Ğ¢ĞĞ’ĞĞ Ğ†Ğ’
        elif item.type == 'product':
            product = db.query(models.Product).filter(models.Product.id == item.id).first()
            if product:
                old = product.stock_quantity
                product.stock_quantity -= item.quantity
                
                InventoryLogger.log(
                    db, "product", product.id, 
                    product.name, 
                    old, product.stock_quantity, 
                    f"sale_order_{item.order_id}"
                )
                
    db.commit()
    return {"status": "deducted"}

--------------------------------------------------
PATH: ./.history/product_service/routers/categories_20260123212245.py
--------------------------------------------------
from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from typing import List
import database, schemas, models

router = APIRouter(prefix="/categories", tags=["Categories"])

@router.post("/", response_model=schemas.Category)
def create_category(category: schemas.CategoryCreate, db: Session = Depends(database.get_db)):
    # ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ÑÑ”Ğ¼Ğ¾ Ğ½Ğ° Ğ´ÑƒĞ±Ğ»Ñ–ĞºĞ°Ñ‚
    db_category = db.query(models.Category).filter(models.Category.name == category.name).first()
    if db_category: 
        raise HTTPException(status_code=400, detail="Category already exists")
    
    # Ğ¡Ñ‚Ğ²Ğ¾Ñ€ÑÑ”Ğ¼Ğ¾ Ğ½Ğ¾Ğ²Ñƒ
    new_category = models.Category(
        name=category.name, 
        slug=category.slug, 
        color=category.color, 
        parent_id=category.parent_id
    )
    db.add(new_category)
    db.commit()
    db.refresh(new_category)
    return new_category

@router.get("/", response_model=List[schemas.Category])
def read_categories(skip: int = 0, limit: int = 100, db: Session = Depends(database.get_db)):
    return db.query(models.Category).offset(skip).limit(limit).all()

# !!! ĞĞĞ’Ğ•: ĞĞ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ— !!!
@router.put("/{category_id}", response_model=schemas.Category)
def update_category(category_id: int, category_data: schemas.CategoryCreate, db: Session = Depends(database.get_db)):
    db_category = db.query(models.Category).filter(models.Category.id == category_id).first()
    if not db_category:
        raise HTTPException(status_code=404, detail="Category not found")
    
    # ĞĞ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ¿Ğ¾Ğ»Ñ
    db_category.name = category_data.name
    db_category.slug = category_data.slug
    db_category.color = category_data.color
    
    # Ğ—Ğ°Ñ…Ğ¸ÑÑ‚ Ğ²Ñ–Ğ´ Ñ†Ğ¸ĞºĞ»Ñ–Ñ‡Ğ½Ğ¾ÑÑ‚Ñ– (ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ Ğ½Ğµ Ğ¼Ğ¾Ğ¶Ğµ Ğ±ÑƒÑ‚Ğ¸ Ğ±Ğ°Ñ‚ÑŒĞºĞ¾Ğ¼ ÑĞ°Ğ¼Ğ° ÑĞ¾Ğ±Ñ–)
    if category_data.parent_id == category_id:
         raise HTTPException(status_code=400, detail="Category cannot be its own parent")
         
    db_category.parent_id = category_data.parent_id

    db.commit()
    db.refresh(db_category)
    return db_category

# !!! ĞĞĞ’Ğ•: Ğ’Ğ¸Ğ´Ğ°Ğ»ĞµĞ½Ğ½Ñ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ— !!!
@router.delete("/{category_id}")
def delete_category(category_id: int, db: Session = Depends(database.get_db)):
    db_category = db.query(models.Category).filter(models.Category.id == category_id).first()
    if not db_category:
        raise HTTPException(status_code=404, detail="Category not found")
    
    db.delete(db_category)
    db.commit()
    return {"status": "deleted"}

--------------------------------------------------
PATH: ./.history/product_service/routers/inventory_20260126181505.py
--------------------------------------------------
# FILE: product_service/routers/inventory.py

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from sqlalchemy import or_, desc
from typing import List
import database, schemas, models
from services.inventory_logger import InventoryLogger

router = APIRouter(tags=["Inventory"])

# --- UNITS (ĞĞ´Ğ¸Ğ½Ğ¸Ñ†Ñ– Ğ²Ğ¸Ğ¼Ñ–Ñ€Ñƒ) ---
@router.post("/units/", response_model=schemas.Unit)
def create_unit(unit: schemas.UnitCreate, db: Session = Depends(database.get_db)):
    exists = db.query(models.Unit).filter(or_(models.Unit.name == unit.name, models.Unit.symbol == unit.symbol)).first()
    if exists: raise HTTPException(status_code=400, detail="ĞĞ´Ğ¸Ğ½Ğ¸Ñ†Ñ Ñ–ÑĞ½ÑƒÑ”")
    db_unit = models.Unit(name=unit.name, symbol=unit.symbol)
    db.add(db_unit); db.commit(); db.refresh(db_unit)
    return db_unit

@router.get("/units/", response_model=List[schemas.Unit])
def read_units(db: Session = Depends(database.get_db)):
    return db.query(models.Unit).all()

# --- INGREDIENTS (Ğ¡Ğ¸Ñ€Ğ¾Ğ²Ğ¸Ğ½Ğ°) ---
@router.post("/ingredients/", response_model=schemas.Ingredient)
def create_ingredient(ingredient: schemas.IngredientCreate, db: Session = Depends(database.get_db)):
    exists = db.query(models.Ingredient).filter(models.Ingredient.name == ingredient.name).first()
    if exists: raise HTTPException(status_code=400, detail="Ingredient already exists")
    new_item = models.Ingredient(**ingredient.dict())
    db.add(new_item); db.commit(); db.refresh(new_item)
    return new_item

@router.get("/ingredients/", response_model=List[schemas.Ingredient])
def read_ingredients(db: Session = Depends(database.get_db)):
    return db.query(models.Ingredient).all()

@router.put("/ingredients/{ingredient_id}", response_model=schemas.Ingredient)
def update_ingredient(ingredient_id: int, ingredient_data: schemas.IngredientCreate, db: Session = Depends(database.get_db)):
    db_ingredient = db.query(models.Ingredient).filter(models.Ingredient.id == ingredient_id).first()
    if not db_ingredient: raise HTTPException(status_code=404, detail="Ingredient not found")
    
    # 1. Ğ—Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ñ”Ğ¼Ğ¾ ÑÑ‚Ğ°Ñ€Ğ¸Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ
    old_balance = db_ingredient.stock_quantity
    
    # 2. ĞĞ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ¿Ğ¾Ğ»Ñ
    db_ingredient.name = ingredient_data.name
    db_ingredient.unit_id = ingredient_data.unit_id
    db_ingredient.cost_per_unit = ingredient_data.cost_per_unit
    
    # 3. Ğ¯ĞºÑ‰Ğ¾ Ğ·Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº Ğ·Ğ¼Ñ–Ğ½Ğ¸Ğ²ÑÑ - Ğ¿Ğ¸ÑˆĞµĞ¼Ğ¾ Ñ†Ğµ
    if ingredient_data.stock_quantity != old_balance:
        db_ingredient.stock_quantity = ingredient_data.stock_quantity
        # Ğ›ĞĞ“Ğ£Ğ’ĞĞĞĞ¯
        InventoryLogger.log(
            db, 
            entity_type="ingredient", 
            entity_id=db_ingredient.id, 
            entity_name=db_ingredient.name, 
            old_balance=old_balance, 
            new_balance=db_ingredient.stock_quantity, 
            reason="manual_correction"
        )
    
    db.commit(); db.refresh(db_ingredient)
    return db_ingredient

@router.delete("/ingredients/{ingredient_id}")
def delete_ingredient(ingredient_id: int, db: Session = Depends(database.get_db)):
    db_ingredient = db.query(models.Ingredient).filter(models.Ingredient.id == ingredient_id).first()
    if not db_ingredient: raise HTTPException(status_code=404)
    try: 
        db.delete(db_ingredient); db.commit()
    except: 
        db.rollback(); raise HTTPException(status_code=400, detail="Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ñ‚ÑŒÑÑ Ğ² Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ğ°Ñ…")
    return {"status": "deleted"}

# --- CONSUMABLES (Ğ’Ğ¸Ñ‚Ñ€Ğ°Ñ‚Ğ½Ñ– Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸) ---
@router.post("/consumables/", response_model=schemas.Consumable)
def create_consumable(item: schemas.ConsumableCreate, db: Session = Depends(database.get_db)):
    exists = db.query(models.Consumable).filter(models.Consumable.name == item.name).first()
    if exists: raise HTTPException(status_code=400, detail="Ğ’Ğ¶Ğµ Ñ–ÑĞ½ÑƒÑ”")
    new_c = models.Consumable(**item.dict())
    db.add(new_c); db.commit(); db.refresh(new_c)
    return new_c

@router.get("/consumables/", response_model=List[schemas.Consumable])
def read_consumables(db: Session = Depends(database.get_db)):
    return db.query(models.Consumable).all()

@router.put("/consumables/{id}", response_model=schemas.Consumable)
def update_consumable(id: int, item: schemas.ConsumableCreate, db: Session = Depends(database.get_db)):
    db_c = db.query(models.Consumable).filter(models.Consumable.id == id).first()
    if not db_c: raise HTTPException(status_code=404)
    
    old_balance = db_c.stock_quantity # <-- Ğ—Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ñ”Ğ¼Ğ¾ ÑÑ‚Ğ°Ñ€Ğµ

    # ĞĞ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ²ÑĞµ
    for k, v in item.dict().items(): setattr(db_c, k, v)
    
    # Ğ›ĞĞ“Ğ£Ğ’ĞĞĞĞ¯
    InventoryLogger.log(
        db,
        entity_type="consumable",
        entity_id=db_c.id,
        entity_name=db_c.name,
        old_balance=old_balance,
        new_balance=db_c.stock_quantity,
        reason="manual_correction"
    )

    db.commit(); db.refresh(db_c)
    return db_c

@router.delete("/consumables/{id}")
def delete_consumable(id: int, db: Session = Depends(database.get_db)):
    db_c = db.query(models.Consumable).filter(models.Consumable.id == id).first()
    if not db_c: raise HTTPException(status_code=404)
    db.delete(db_c); db.commit()
    return {"status": "deleted"}

# === Ğ”ĞĞ”ĞĞ¢Ğ˜ Ğ’ ĞšĞ†ĞĞ•Ğ¦Ğ¬ Ğ¤ĞĞ™Ğ›Ğ£ inventory.py ===

@router.get("/history/")
def get_inventory_history(
    entity_type: str, 
    entity_id: int, 
    limit: int = 50, 
    db: Session = Depends(database.get_db)
):
    # Ğ¦ĞµĞ¹ endpoint Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¸Ğ¹ Ğ·Ğ° Ğ°Ğ´Ñ€ĞµÑĞ¾Ñ /history/ (Ñ‡ĞµÑ€ĞµĞ· Ğ¿Ñ€Ğ¾ĞºÑÑ– /api/history/)
    return db.query(models.InventoryTransaction)\
        .filter(models.InventoryTransaction.entity_type == entity_type)\
        .filter(models.InventoryTransaction.entity_id == entity_id)\
        .order_by(desc(models.InventoryTransaction.created_at))\
        .limit(limit).all()



--------------------------------------------------
PATH: ./.history/product_service/routers/products_20260125222457.py
--------------------------------------------------
from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from typing import List
import database, schemas, models
from services.product_service import ProductService
from services.inventory_logger import InventoryLogger

router = APIRouter(prefix="/products", tags=["Products"])

# --- CRUD Ğ¢ĞĞ’ĞĞ Ğ†Ğ’ ---

@router.post("/", response_model=schemas.Product)
def create_product(product: schemas.ProductCreate, db: Session = Depends(database.get_db)):
    return ProductService.create_product(db, product)

@router.put("/{product_id}", response_model=schemas.Product)
def update_product(product_id: int, product_data: schemas.ProductCreate, db: Session = Depends(database.get_db)):
    updated_product = ProductService.update_product(db, product_id, product_data)
    if not updated_product:
        raise HTTPException(status_code=404, detail="Product not found")
    return updated_product

@router.get("/", response_model=List[schemas.Product])
def read_products(db: Session = Depends(database.get_db)):
    products = db.query(models.Product).all()
    
    # ĞŸÑ–Ğ´ÑÑ‚Ğ°Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ½Ğ°Ğ·Ğ²Ğ¸ Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ñ–Ğ² Ñ‚Ğ° Ñ–Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ñ–Ğ² Ğ´Ğ»Ñ Ğ²Ñ–Ğ´Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ½Ñ
    for p in products:
        for c in p.consumables:
            if c.consumable: c.consumable_name = c.consumable.name

        if p.variants:
            for v in p.variants:
                for vc in v.consumables:
                    if vc.consumable: vc.consumable_name = vc.consumable.name 
                for vi in v.ingredients:
                    if vi.ingredient: vi.ingredient_name = vi.ingredient.name

    return products

@router.delete("/{product_id}")
def delete_product(product_id: int, db: Session = Depends(database.get_db)):
    product = db.query(models.Product).filter(models.Product.id == product_id).first()
    if not product:
        raise HTTPException(status_code=404, detail="Product not found")
    db.delete(product)
    db.commit()
    return {"status": "deleted"}

# ==========================================
# Ğ£ĞŸĞ ĞĞ’Ğ›Ğ†ĞĞĞ¯ Ğ¡ĞšĞ›ĞĞ”ĞĞœ Ğ¢Ğ Ğ†Ğ¡Ğ¢ĞĞ Ğ†Ğ¯
# ==========================================

# 1. ĞĞ½Ğ¾Ğ²Ğ¸Ñ‚Ğ¸ Ğ·Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾Ğ³Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ
@router.patch("/{product_id}/stock")
def update_product_stock(product_id: int, qty: float, db: Session = Depends(database.get_db)):
    product = db.query(models.Product).filter(models.Product.id == product_id).first()
    if not product: raise HTTPException(status_code=404)
    
    old_qty = product.stock_quantity
    product.stock_quantity = qty
    
    InventoryLogger.log(
        db, "product", product.id, product.name, 
        old_qty, qty, "manual_correction"
    )
    
    db.commit()
    return {"status": "updated", "new_quantity": qty}

# 2. ĞĞ½Ğ¾Ğ²Ğ¸Ñ‚Ğ¸ Ğ·Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ
@router.patch("/variants/{variant_id}/stock")
def update_variant_stock(variant_id: int, qty: float, db: Session = Depends(database.get_db)):
    variant = db.query(models.ProductVariant).filter(models.ProductVariant.id == variant_id).first()
    if not variant: raise HTTPException(status_code=404)
    
    old_qty = variant.stock_quantity
    variant.stock_quantity = qty
    
    p_name = variant.product.name if variant.product else "Unknown"
    full_name = f"{p_name} ({variant.name})"

    InventoryLogger.log(
        db, "product_variant", variant.id, full_name, 
        old_qty, qty, "manual_correction"
    )
    
    db.commit()
    return {"status": "updated", "new_quantity": qty}

# 3. Ğ¡ĞŸĞ˜Ğ¡ĞĞĞĞ¯ ĞŸĞ Ğ˜ ĞŸĞ ĞĞ”ĞĞ–Ğ†
@router.post("/deduct_stock_for_order")
def deduct_stock_for_order(items: List[schemas.StockDeductionItem], db: Session = Depends(database.get_db)):
    for item in items:
        # Ğ’ĞĞ Ğ†ĞĞĞ¢Ğ˜
        if item.type == 'product_variant':
            variant = db.query(models.ProductVariant).filter(models.ProductVariant.id == item.id).first()
            if variant:
                old = variant.stock_quantity
                variant.stock_quantity -= item.quantity
                InventoryLogger.log(
                    db, "product_variant", variant.id, 
                    f"{variant.product.name} ({variant.name})", 
                    old, variant.stock_quantity, 
                    f"sale_order_{item.order_id}"
                )
        # ĞŸĞ ĞĞ¡Ğ¢Ğ† Ğ¢ĞĞ’ĞĞ Ğ˜
        elif item.type == 'product':
            product = db.query(models.Product).filter(models.Product.id == item.id).first()
            if product:
                old = product.stock_quantity
                product.stock_quantity -= item.quantity
                InventoryLogger.log(
                    db, "product", product.id, product.name, 
                    old, product.stock_quantity, 
                    f"sale_order_{item.order_id}"
                )
                
    db.commit()
    return {"status": "deducted"}

--------------------------------------------------
PATH: ./.history/product_service/routers/inventory_20260125204046.py
--------------------------------------------------
from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from sqlalchemy import or_
from typing import List
import database, schemas, models
from services.inventory_logger import InventoryLogger

router = APIRouter(tags=["Inventory"])

# --- UNITS (ĞĞ´Ğ¸Ğ½Ğ¸Ñ†Ñ– Ğ²Ğ¸Ğ¼Ñ–Ñ€Ñƒ) ---
@router.post("/units/", response_model=schemas.Unit)
def create_unit(unit: schemas.UnitCreate, db: Session = Depends(database.get_db)):
    exists = db.query(models.Unit).filter(or_(models.Unit.name == unit.name, models.Unit.symbol == unit.symbol)).first()
    if exists: raise HTTPException(status_code=400, detail="ĞĞ´Ğ¸Ğ½Ğ¸Ñ†Ñ Ñ–ÑĞ½ÑƒÑ”")
    db_unit = models.Unit(name=unit.name, symbol=unit.symbol)
    db.add(db_unit); db.commit(); db.refresh(db_unit)
    return db_unit

@router.get("/units/", response_model=List[schemas.Unit])
def read_units(db: Session = Depends(database.get_db)):
    return db.query(models.Unit).all()

# --- INGREDIENTS (Ğ¡Ğ¸Ñ€Ğ¾Ğ²Ğ¸Ğ½Ğ°) ---
# Ğ›Ğ¾Ğ³Ñ–ĞºĞ° Ñ–Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ñ–Ğ² Ğ¶Ğ¸Ğ²Ğµ Ñ‚ÑƒÑ‚, Ğ¾ĞºÑ€ĞµĞ¼Ğ¸Ğ¹ Ñ„Ğ°Ğ¹Ğ» Ğ½Ğµ Ğ¿Ğ¾Ñ‚Ñ€Ñ–Ğ±ĞµĞ½
@router.post("/ingredients/", response_model=schemas.Ingredient)
def create_ingredient(ingredient: schemas.IngredientCreate, db: Session = Depends(database.get_db)):
    exists = db.query(models.Ingredient).filter(models.Ingredient.name == ingredient.name).first()
    if exists: raise HTTPException(status_code=400, detail="Ingredient already exists")
    new_item = models.Ingredient(**ingredient.dict())
    db.add(new_item); db.commit(); db.refresh(new_item)
    return new_item

@router.get("/ingredients/", response_model=List[schemas.Ingredient])
def read_ingredients(db: Session = Depends(database.get_db)):
    return db.query(models.Ingredient).all()

@router.put("/ingredients/{ingredient_id}", response_model=schemas.Ingredient)
def update_ingredient(ingredient_id: int, ingredient_data: schemas.IngredientCreate, db: Session = Depends(database.get_db)):
    db_ingredient = db.query(models.Ingredient).filter(models.Ingredient.id == ingredient_id).first()
    if not db_ingredient: raise HTTPException(status_code=404, detail="Ingredient not found")
    
    # 1. Ğ—Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ñ”Ğ¼Ğ¾ ÑÑ‚Ğ°Ñ€Ğ¸Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ
    old_balance = db_ingredient.stock_quantity
    
    # 2. ĞĞ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ¿Ğ¾Ğ»Ñ
    db_ingredient.name = ingredient_data.name
    db_ingredient.unit_id = ingredient_data.unit_id
    db_ingredient.cost_per_unit = ingredient_data.cost_per_unit
    
    # 3. Ğ¯ĞºÑ‰Ğ¾ Ğ·Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº Ğ·Ğ¼Ñ–Ğ½Ğ¸Ğ²ÑÑ - Ğ¿Ğ¸ÑˆĞµĞ¼Ğ¾ Ñ†Ğµ Ğ² Ñ–ÑÑ‚Ğ¾Ñ€Ñ–Ñ
    if ingredient_data.stock_quantity != old_balance:
        db_ingredient.stock_quantity = ingredient_data.stock_quantity
        # Ğ›ĞĞ“Ğ£Ğ’ĞĞĞĞ¯
        InventoryLogger.log(
            db, 
            entity_type="ingredient", 
            entity_id=db_ingredient.id, 
            entity_name=db_ingredient.name, 
            old_balance=old_balance, 
            new_balance=db_ingredient.stock_quantity, 
            reason="manual_correction"
        )
    
    db.commit(); db.refresh(db_ingredient)
    return db_ingredient

@router.delete("/ingredients/{ingredient_id}")
def delete_ingredient(ingredient_id: int, db: Session = Depends(database.get_db)):
    db_ingredient = db.query(models.Ingredient).filter(models.Ingredient.id == ingredient_id).first()
    if not db_ingredient: raise HTTPException(status_code=404)
    try: 
        db.delete(db_ingredient); db.commit()
    except: 
        db.rollback(); raise HTTPException(status_code=400, detail="Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ñ‚ÑŒÑÑ Ğ² Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ğ°Ñ…")
    return {"status": "deleted"}

# --- CONSUMABLES (Ğ’Ğ¸Ñ‚Ñ€Ğ°Ñ‚Ğ½Ñ– Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸) ---
@router.post("/consumables/", response_model=schemas.Consumable)
def create_consumable(item: schemas.ConsumableCreate, db: Session = Depends(database.get_db)):
    exists = db.query(models.Consumable).filter(models.Consumable.name == item.name).first()
    if exists: raise HTTPException(status_code=400, detail="Ğ’Ğ¶Ğµ Ñ–ÑĞ½ÑƒÑ”")
    new_c = models.Consumable(**item.dict())
    db.add(new_c); db.commit(); db.refresh(new_c)
    return new_c

@router.get("/consumables/", response_model=List[schemas.Consumable])
def read_consumables(db: Session = Depends(database.get_db)):
    return db.query(models.Consumable).all()

@router.put("/consumables/{id}", response_model=schemas.Consumable)
def update_consumable(id: int, item: schemas.ConsumableCreate, db: Session = Depends(database.get_db)):
    db_c = db.query(models.Consumable).filter(models.Consumable.id == id).first()
    if not db_c: raise HTTPException(status_code=404)
    
    old_balance = db_c.stock_quantity # <-- Ğ—Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ñ”Ğ¼Ğ¾ ÑÑ‚Ğ°Ñ€Ğµ

    # ĞĞ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ²ÑÑ– Ğ¿Ğ¾Ğ»Ñ
    for k, v in item.dict().items(): setattr(db_c, k, v)
    
    # Ğ›ĞĞ“Ğ£Ğ’ĞĞĞĞ¯
    if old_balance != db_c.stock_quantity:
        InventoryLogger.log(
            db,
            entity_type="consumable",
            entity_id=db_c.id,
            entity_name=db_c.name,
            old_balance=old_balance,
            new_balance=db_c.stock_quantity,
            reason="manual_correction"
        )

    db.commit(); db.refresh(db_c)
    return db_c

@router.delete("/consumables/{id}")
def delete_consumable(id: int, db: Session = Depends(database.get_db)):
    db_c = db.query(models.Consumable).filter(models.Consumable.id == id).first()
    if not db_c: raise HTTPException(status_code=404)
    db.delete(db_c); db.commit()
    return {"status": "deleted"}

# --- HISTORY (Ğ†ÑÑ‚Ğ¾Ñ€Ñ–Ñ Ñ€ÑƒÑ…Ñƒ) ---
@router.get("/history/", response_model=List[schemas.InventoryTransactionRead])
def get_inventory_history(
    entity_type: str = None, 
    entity_id: int = None, 
    limit: int = 50, 
    db: Session = Depends(database.get_db)
):
    query = db.query(models.InventoryTransaction)
    
    if entity_type:
        query = query.filter(models.InventoryTransaction.entity_type == entity_type)
    if entity_id:
        query = query.filter(models.InventoryTransaction.entity_id == entity_id)
        
    return query.order_by(models.InventoryTransaction.created_at.desc()).limit(limit).all()

--------------------------------------------------
PATH: ./.history/product_service/routers/products_20260125223503.py
--------------------------------------------------
# FILE: product_service/routers/products.py

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from typing import List
import database, schemas, models
from services.product_service import ProductService
from services.inventory_logger import InventoryLogger

router = APIRouter(prefix="/products", tags=["Products"])

@router.post("/", response_model=schemas.Product)
def create_product(product: schemas.ProductCreate, db: Session = Depends(database.get_db)):
    # Ğ’Ğ¸ĞºĞ»Ğ¸ĞºĞ°Ñ”Ğ¼Ğ¾ ÑĞµÑ€Ğ²Ñ–Ñ, ÑĞºĞ¸Ğ¹ Ğ·Ñ€Ğ¾Ğ±Ğ¸Ñ‚ÑŒ Ğ²ÑÑ Ğ±Ñ€ÑƒĞ´Ğ½Ñƒ Ñ€Ğ¾Ğ±Ğ¾Ñ‚Ñƒ
    return ProductService.create_product(db, product)

@router.put("/{product_id}", response_model=schemas.Product)
def update_product(product_id: int, product_data: schemas.ProductCreate, db: Session = Depends(database.get_db)):
    updated_product = ProductService.update_product(db, product_id, product_data)
    if not updated_product:
        raise HTTPException(status_code=404, detail="Product not found")
    return updated_product

@router.get("/", response_model=List[schemas.Product])
def read_products(db: Session = Depends(database.get_db)):
    products = db.query(models.Product).all()
    
    # --- UI Helper ---
    # Ğ”Ğ¾Ğ·Ğ°Ğ¿Ğ¾Ğ²Ğ½ÑÑ”Ğ¼Ğ¾ Ğ½Ğ°Ğ·Ğ²Ğ¸ Ğ´Ğ»Ñ ĞºÑ€Ğ°ÑĞ¸Ğ²Ğ¾Ğ³Ğ¾ Ğ²Ñ–Ğ´Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ½Ğ° Ñ„Ñ€Ğ¾Ğ½Ñ‚Ñ–
    for p in products:
        # 1. Ğ”Ğ»Ñ ÑĞ°Ğ¼Ğ¾Ğ³Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ
        for c in p.consumables:
            if c.consumable:
                c.consumable_name = c.consumable.name # ĞŸÑ–Ğ´ÑÑ‚Ğ°Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ½Ğ°Ğ·Ğ²Ñƒ

        # 2. Ğ”Ğ›Ğ¯ Ğ’ĞĞ Ğ†ĞĞĞ¢Ğ†Ğ’ (Ğ¦Ğµ Ñ‚Ğµ, Ñ‡Ğ¾Ğ³Ğ¾ Ğ½Ğµ Ğ²Ğ¸ÑÑ‚Ğ°Ñ‡Ğ°Ğ»Ğ¾)
        if p.variants:
            for v in p.variants:
                # ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ
                for vc in v.consumables:
                    if vc.consumable:
                         # Pydantic ÑÑ…ĞµĞ¼Ğ° Ğ¾Ñ‡Ñ–ĞºÑƒÑ” consumable_name, Ğ·Ğ°Ğ¿Ğ¾Ğ²Ğ½ÑÑ”Ğ¼Ğ¾ Ğ¹Ğ¾Ğ³Ğ¾
                        vc.consumable_name = vc.consumable.name 
                
                # Ğ†Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ğ¸ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ
                for vi in v.ingredients:
                    if vi.ingredient:
                        vi.ingredient_name = vi.ingredient.name

    return products

# 1. ĞĞ½Ğ¾Ğ²Ğ¸Ñ‚Ğ¸ Ğ·Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾Ğ³Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ
@router.patch("/{product_id}/stock")
def update_product_stock(product_id: int, qty: float, db: Session = Depends(database.get_db)):
    product = db.query(models.Product).filter(models.Product.id == product_id).first()
    if not product: raise HTTPException(status_code=404)
    
    old_qty = product.stock_quantity
    product.stock_quantity = qty
    
    InventoryLogger.log(db, "product", product.id, product.name, old_qty, qty, "manual_correction")
    
    db.commit()
    return {"status": "updated", "new_quantity": qty}

# 2. ĞĞ½Ğ¾Ğ²Ğ¸Ñ‚Ğ¸ Ğ·Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ
@router.patch("/variants/{variant_id}/stock")
def update_variant_stock(variant_id: int, qty: float, db: Session = Depends(database.get_db)):
    variant = db.query(models.ProductVariant).filter(models.ProductVariant.id == variant_id).first()
    if not variant: raise HTTPException(status_code=404)
    
    old_qty = variant.stock_quantity
    variant.stock_quantity = qty
    
    # ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ğ½Ğ°Ğ·Ğ²Ñƒ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ Ğ´Ğ»Ñ ĞºÑ€Ğ°ÑĞ¸Ğ²Ğ¾Ğ³Ğ¾ Ğ»Ğ¾Ğ³Ñƒ
    p_name = variant.product.name if variant.product else "Unknown"
    full_name = f"{p_name} ({variant.name})"

    InventoryLogger.log(db, "product_variant", variant.id, full_name, old_qty, qty, "manual_correction")
    
    db.commit()
    return {"status": "updated", "new_quantity": qty}

@router.delete("/{product_id}")
def delete_product(product_id: int, db: Session = Depends(database.get_db)):
    product = db.query(models.Product).filter(models.Product.id == product_id).first()
    if not product:
        raise HTTPException(status_code=404, detail="Product not found")
    
    # Ğ’Ğ¸Ğ´Ğ°Ğ»ĞµĞ½Ğ½Ñ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ ĞºĞ°ÑĞºĞ°Ğ´Ğ½Ğ¾ Ğ²Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸ Ñ‚Ğ° Ğ·Ğ²'ÑĞ·ĞºĞ¸ (Ğ·Ğ°Ğ²Ğ´ÑĞºĞ¸ Ğ½Ğ°Ğ»Ğ°ÑˆÑ‚ÑƒĞ²Ğ°Ğ½Ğ½ÑĞ¼ models.py)
    db.delete(product)
    db.commit()
    return {"status": "deleted"}

--------------------------------------------------
PATH: ./.history/product_service/routers/products_20260123212139.py
--------------------------------------------------
# FILE: product_service/routers/products.py

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from typing import List
import database, schemas, models
from services.product_service import ProductService
from services.inventory_logger import InventoryLogger

router = APIRouter(prefix="/products", tags=["Products"])

@router.post("/", response_model=schemas.Product)
def create_product(product: schemas.ProductCreate, db: Session = Depends(database.get_db)):
    # Ğ’Ğ¸ĞºĞ»Ğ¸ĞºĞ°Ñ”Ğ¼Ğ¾ ÑĞµÑ€Ğ²Ñ–Ñ, ÑĞºĞ¸Ğ¹ Ğ·Ñ€Ğ¾Ğ±Ğ¸Ñ‚ÑŒ Ğ²ÑÑ Ğ±Ñ€ÑƒĞ´Ğ½Ñƒ Ñ€Ğ¾Ğ±Ğ¾Ñ‚Ñƒ
    return ProductService.create_product(db, product)

@router.put("/{product_id}", response_model=schemas.Product)
def update_product(product_id: int, product_data: schemas.ProductCreate, db: Session = Depends(database.get_db)):
    updated_product = ProductService.update_product(db, product_id, product_data)
    if not updated_product:
        raise HTTPException(status_code=404, detail="Product not found")
    return updated_product

@router.get("/", response_model=List[schemas.Product])
def read_products(db: Session = Depends(database.get_db)):
    products = db.query(models.Product).all()
    
    # --- UI Helper ---
    # Ğ”Ğ¾Ğ·Ğ°Ğ¿Ğ¾Ğ²Ğ½ÑÑ”Ğ¼Ğ¾ Ğ½Ğ°Ğ·Ğ²Ğ¸ Ğ²Ğ¸Ñ‚Ñ€Ğ°Ñ‚Ğ½Ğ¸Ñ… Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ñ–Ğ², Ñ‰Ğ¾Ğ± Ğ½Ğ° Ñ„Ñ€Ğ¾Ğ½Ñ‚Ñ– Ğ±ÑƒĞ»Ğ¾ Ğ³Ğ°Ñ€Ğ½Ğ¾
    # (SQLAlchemy Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ÑƒÑ” ID, Ğ° Ğ¼Ğ¸ Ğ´Ñ–ÑÑ‚Ğ°Ñ”Ğ¼Ğ¾ Ñ–Ğ¼ĞµĞ½Ğ° Ğ·Ñ– Ğ·Ğ²'ÑĞ·ĞºÑ–Ğ²)
    for p in products:
        for c in p.consumables:
            if c.consumable: c.consumable_name = c.consumable.name
            else: c.consumable_name = "DELETED"
            
        if p.variants:
            for v in p.variants:
                for vc in v.consumables:
                    if vc.consumable: vc.consumable_name = vc.consumable.name
                    else: vc.consumable_name = "Unknown"
                # !!! ĞĞĞ’Ğ•: Ğ”Ğ»Ñ Ñ–Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ñ–Ğ² !!!
                for vi in v.ingredients:
                    if vi.ingredient: vi.ingredient_name = vi.ingredient.name
                    else: vi.ingredient_name = "Unknown"
    return products

# 1. ĞĞ½Ğ¾Ğ²Ğ¸Ñ‚Ğ¸ Ğ·Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾Ğ³Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ
@router.patch("/{product_id}/stock")
def update_product_stock(product_id: int, qty: float, db: Session = Depends(database.get_db)):
    product = db.query(models.Product).filter(models.Product.id == product_id).first()
    if not product: raise HTTPException(status_code=404)
    
    old_qty = product.stock_quantity
    product.stock_quantity = qty
    
    InventoryLogger.log(db, "product", product.id, product.name, old_qty, qty, "manual_correction")
    
    db.commit()
    return {"status": "updated", "new_quantity": qty}

# 2. ĞĞ½Ğ¾Ğ²Ğ¸Ñ‚Ğ¸ Ğ·Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ
@router.patch("/variants/{variant_id}/stock")
def update_variant_stock(variant_id: int, qty: float, db: Session = Depends(database.get_db)):
    variant = db.query(models.ProductVariant).filter(models.ProductVariant.id == variant_id).first()
    if not variant: raise HTTPException(status_code=404)
    
    old_qty = variant.stock_quantity
    variant.stock_quantity = qty
    
    # ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ğ½Ğ°Ğ·Ğ²Ñƒ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ Ğ´Ğ»Ñ ĞºÑ€Ğ°ÑĞ¸Ğ²Ğ¾Ğ³Ğ¾ Ğ»Ğ¾Ğ³Ñƒ
    p_name = variant.product.name if variant.product else "Unknown"
    full_name = f"{p_name} ({variant.name})"

    InventoryLogger.log(db, "product_variant", variant.id, full_name, old_qty, qty, "manual_correction")
    
    db.commit()
    return {"status": "updated", "new_quantity": qty}

@router.delete("/{product_id}")
def delete_product(product_id: int, db: Session = Depends(database.get_db)):
    product = db.query(models.Product).filter(models.Product.id == product_id).first()
    if not product:
        raise HTTPException(status_code=404, detail="Product not found")
    
    # Ğ’Ğ¸Ğ´Ğ°Ğ»ĞµĞ½Ğ½Ñ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ ĞºĞ°ÑĞºĞ°Ğ´Ğ½Ğ¾ Ğ²Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸ Ñ‚Ğ° Ğ·Ğ²'ÑĞ·ĞºĞ¸ (Ğ·Ğ°Ğ²Ğ´ÑĞºĞ¸ Ğ½Ğ°Ğ»Ğ°ÑˆÑ‚ÑƒĞ²Ğ°Ğ½Ğ½ÑĞ¼ models.py)
    db.delete(product)
    db.commit()
    return {"status": "deleted"}

--------------------------------------------------
PATH: ./.history/product_service/routers/inventory_20260124232207.py
--------------------------------------------------
# FILE: product_service/routers/inventory.py

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from sqlalchemy import or_
from typing import List
import database, schemas, models
from services.inventory_logger import InventoryLogger
from pydantic import BaseModel

router = APIRouter(tags=["Inventory"])

# --- UNITS (ĞĞ´Ğ¸Ğ½Ğ¸Ñ†Ñ– Ğ²Ğ¸Ğ¼Ñ–Ñ€Ñƒ) ---
@router.post("/units/", response_model=schemas.Unit)
def create_unit(unit: schemas.UnitCreate, db: Session = Depends(database.get_db)):
    exists = db.query(models.Unit).filter(or_(models.Unit.name == unit.name, models.Unit.symbol == unit.symbol)).first()
    if exists: raise HTTPException(status_code=400, detail="ĞĞ´Ğ¸Ğ½Ğ¸Ñ†Ñ Ñ–ÑĞ½ÑƒÑ”")
    db_unit = models.Unit(name=unit.name, symbol=unit.symbol)
    db.add(db_unit); db.commit(); db.refresh(db_unit)
    return db_unit

@router.get("/units/", response_model=List[schemas.Unit])
def read_units(db: Session = Depends(database.get_db)):
    return db.query(models.Unit).all()

# --- INGREDIENTS (Ğ¡Ğ¸Ñ€Ğ¾Ğ²Ğ¸Ğ½Ğ°) ---
@router.post("/ingredients/", response_model=schemas.Ingredient)
def create_ingredient(ingredient: schemas.IngredientCreate, db: Session = Depends(database.get_db)):
    exists = db.query(models.Ingredient).filter(models.Ingredient.name == ingredient.name).first()
    if exists: raise HTTPException(status_code=400, detail="Ingredient already exists")
    new_item = models.Ingredient(**ingredient.dict())
    db.add(new_item); db.commit(); db.refresh(new_item)
    return new_item

@router.get("/ingredients/", response_model=List[schemas.Ingredient])
def read_ingredients(db: Session = Depends(database.get_db)):
    return db.query(models.Ingredient).all()

@router.put("/ingredients/{ingredient_id}", response_model=schemas.Ingredient)
def update_ingredient(ingredient_id: int, ingredient_data: schemas.IngredientCreate, db: Session = Depends(database.get_db)):
    db_ingredient = db.query(models.Ingredient).filter(models.Ingredient.id == ingredient_id).first()
    if not db_ingredient: raise HTTPException(status_code=404, detail="Ingredient not found")
    
    # 1. Ğ—Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ñ”Ğ¼Ğ¾ ÑÑ‚Ğ°Ñ€Ğ¸Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ
    old_balance = db_ingredient.stock_quantity
    
    # 2. ĞĞ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ¿Ğ¾Ğ»Ñ
    db_ingredient.name = ingredient_data.name
    db_ingredient.unit_id = ingredient_data.unit_id
    db_ingredient.cost_per_unit = ingredient_data.cost_per_unit
    
    # 3. Ğ¯ĞºÑ‰Ğ¾ Ğ·Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº Ğ·Ğ¼Ñ–Ğ½Ğ¸Ğ²ÑÑ - Ğ¿Ğ¸ÑˆĞµĞ¼Ğ¾ Ñ†Ğµ
    if ingredient_data.stock_quantity != old_balance:
        db_ingredient.stock_quantity = ingredient_data.stock_quantity
        # Ğ›ĞĞ“Ğ£Ğ’ĞĞĞĞ¯
        InventoryLogger.log(
            db, 
            entity_type="ingredient", 
            entity_id=db_ingredient.id, 
            entity_name=db_ingredient.name, 
            old_balance=old_balance, 
            new_balance=db_ingredient.stock_quantity, 
            reason="manual_correction"
        )
    
    db.commit(); db.refresh(db_ingredient)
    return db_ingredient

@router.delete("/ingredients/{ingredient_id}")
def delete_ingredient(ingredient_id: int, db: Session = Depends(database.get_db)):
    db_ingredient = db.query(models.Ingredient).filter(models.Ingredient.id == ingredient_id).first()
    if not db_ingredient: raise HTTPException(status_code=404)
    try: 
        db.delete(db_ingredient); db.commit()
    except: 
        db.rollback(); raise HTTPException(status_code=400, detail="Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ñ‚ÑŒÑÑ Ğ² Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ğ°Ñ…")
    return {"status": "deleted"}

# --- CONSUMABLES (Ğ’Ğ¸Ñ‚Ñ€Ğ°Ñ‚Ğ½Ñ– Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸) ---
@router.post("/consumables/", response_model=schemas.Consumable)
def create_consumable(item: schemas.ConsumableCreate, db: Session = Depends(database.get_db)):
    exists = db.query(models.Consumable).filter(models.Consumable.name == item.name).first()
    if exists: raise HTTPException(status_code=400, detail="Ğ’Ğ¶Ğµ Ñ–ÑĞ½ÑƒÑ”")
    new_c = models.Consumable(**item.dict())
    db.add(new_c); db.commit(); db.refresh(new_c)
    return new_c

@router.get("/consumables/", response_model=List[schemas.Consumable])
def read_consumables(db: Session = Depends(database.get_db)):
    return db.query(models.Consumable).all()

@router.put("/consumables/{id}", response_model=schemas.Consumable)
def update_consumable(id: int, item: schemas.ConsumableCreate, db: Session = Depends(database.get_db)):
    db_c = db.query(models.Consumable).filter(models.Consumable.id == id).first()
    if not db_c: raise HTTPException(status_code=404)
    
    old_balance = db_c.stock_quantity # <-- Ğ—Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ñ”Ğ¼Ğ¾ ÑÑ‚Ğ°Ñ€Ğµ

    # ĞĞ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ²ÑĞµ
    for k, v in item.dict().items(): setattr(db_c, k, v)
    
    # Ğ›ĞĞ“Ğ£Ğ’ĞĞĞĞ¯
    InventoryLogger.log(
        db,
        entity_type="consumable",
        entity_id=db_c.id,
        entity_name=db_c.name,
        old_balance=old_balance,
        new_balance=db_c.stock_quantity,
        reason="manual_correction"
    )

    db.commit(); db.refresh(db_c)
    return db_c

@router.delete("/consumables/{id}")
def delete_consumable(id: int, db: Session = Depends(database.get_db)):
    db_c = db.query(models.Consumable).filter(models.Consumable.id == id).first()
    if not db_c: raise HTTPException(status_code=404)
    db.delete(db_c); db.commit()
    return {"status": "deleted"}

# --- HISTORY ---
@router.get("/history/", response_model=List[schemas.InventoryTransactionRead])
def get_inventory_history(entity_type: str = None, entity_id: int = None, limit: int = 50, db: Session = Depends(database.get_db)):
    query = db.query(models.InventoryTransaction)
    
    if entity_type:
        query = query.filter(models.InventoryTransaction.entity_type == entity_type)
    if entity_id:
        query = query.filter(models.InventoryTransaction.entity_id == entity_id)
        
    return query.order_by(models.InventoryTransaction.created_at.desc()).limit(limit).all()

--------------------------------------------------
PATH: ./.history/product_service/routers/inventory_20260125222418.py
--------------------------------------------------
from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from sqlalchemy import or_
from typing import List
import database, schemas, models
from services.inventory_logger import InventoryLogger

router = APIRouter(tags=["Inventory"])

# ==========================================
# UNITS (ĞĞ´Ğ¸Ğ½Ğ¸Ñ†Ñ– Ğ²Ğ¸Ğ¼Ñ–Ñ€Ñƒ)
# ==========================================
@router.post("/units/", response_model=schemas.Unit)
def create_unit(unit: schemas.UnitCreate, db: Session = Depends(database.get_db)):
    exists = db.query(models.Unit).filter(or_(models.Unit.name == unit.name, models.Unit.symbol == unit.symbol)).first()
    if exists: raise HTTPException(status_code=400, detail="ĞĞ´Ğ¸Ğ½Ğ¸Ñ†Ñ Ñ–ÑĞ½ÑƒÑ”")
    db_unit = models.Unit(name=unit.name, symbol=unit.symbol)
    db.add(db_unit); db.commit(); db.refresh(db_unit)
    return db_unit

@router.get("/units/", response_model=List[schemas.Unit])
def read_units(db: Session = Depends(database.get_db)):
    return db.query(models.Unit).all()

# ==========================================
# INGREDIENTS (Ğ¡Ğ¸Ñ€Ğ¾Ğ²Ğ¸Ğ½Ğ°)
# ==========================================
@router.post("/ingredients/", response_model=schemas.Ingredient)
def create_ingredient(ingredient: schemas.IngredientCreate, db: Session = Depends(database.get_db)):
    exists = db.query(models.Ingredient).filter(models.Ingredient.name == ingredient.name).first()
    if exists: raise HTTPException(status_code=400, detail="Ingredient already exists")
    new_item = models.Ingredient(**ingredient.dict())
    db.add(new_item); db.commit(); db.refresh(new_item)
    return new_item

@router.get("/ingredients/", response_model=List[schemas.Ingredient])
def read_ingredients(db: Session = Depends(database.get_db)):
    return db.query(models.Ingredient).all()

@router.put("/ingredients/{ingredient_id}", response_model=schemas.Ingredient)
def update_ingredient(ingredient_id: int, ingredient_data: schemas.IngredientCreate, db: Session = Depends(database.get_db)):
    db_ingredient = db.query(models.Ingredient).filter(models.Ingredient.id == ingredient_id).first()
    if not db_ingredient: raise HTTPException(status_code=404, detail="Ingredient not found")
    
    # 1. Ğ—Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ñ”Ğ¼Ğ¾ ÑÑ‚Ğ°Ñ€Ğ¸Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ´Ğ»Ñ Ñ–ÑÑ‚Ğ¾Ñ€Ñ–Ñ—
    old_balance = db_ingredient.stock_quantity
    
    # 2. ĞĞ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ¿Ğ¾Ğ»Ñ
    db_ingredient.name = ingredient_data.name
    db_ingredient.unit_id = ingredient_data.unit_id
    db_ingredient.cost_per_unit = ingredient_data.cost_per_unit
    
    # 3. Ğ¯ĞºÑ‰Ğ¾ Ğ·Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº Ğ·Ğ¼Ñ–Ğ½Ğ¸Ğ²ÑÑ - Ğ¿Ğ¸ÑˆĞµĞ¼Ğ¾ Ğ² Ğ»Ğ¾Ğ³
    if ingredient_data.stock_quantity != old_balance:
        db_ingredient.stock_quantity = ingredient_data.stock_quantity
        InventoryLogger.log(
            db, 
            entity_type="ingredient", 
            entity_id=db_ingredient.id, 
            entity_name=db_ingredient.name, 
            old_balance=old_balance, 
            new_balance=db_ingredient.stock_quantity, 
            reason="manual_correction"
        )
    
    db.commit(); db.refresh(db_ingredient)
    return db_ingredient

@router.delete("/ingredients/{ingredient_id}")
def delete_ingredient(ingredient_id: int, db: Session = Depends(database.get_db)):
    db_ingredient = db.query(models.Ingredient).filter(models.Ingredient.id == ingredient_id).first()
    if not db_ingredient: raise HTTPException(status_code=404)
    try: 
        db.delete(db_ingredient); db.commit()
    except: 
        db.rollback(); raise HTTPException(status_code=400, detail="Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ñ‚ÑŒÑÑ Ğ² Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ğ°Ñ…")
    return {"status": "deleted"}

# ==========================================
# CONSUMABLES (Ğ’Ğ¸Ñ‚Ñ€Ğ°Ñ‚Ğ½Ñ– Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸)
# ==========================================
@router.post("/consumables/", response_model=schemas.Consumable)
def create_consumable(item: schemas.ConsumableCreate, db: Session = Depends(database.get_db)):
    exists = db.query(models.Consumable).filter(models.Consumable.name == item.name).first()
    if exists: raise HTTPException(status_code=400, detail="Ğ’Ğ¶Ğµ Ñ–ÑĞ½ÑƒÑ”")
    new_c = models.Consumable(**item.dict())
    db.add(new_c); db.commit(); db.refresh(new_c)
    return new_c

@router.get("/consumables/", response_model=List[schemas.Consumable])
def read_consumables(db: Session = Depends(database.get_db)):
    return db.query(models.Consumable).all()

@router.put("/consumables/{id}", response_model=schemas.Consumable)
def update_consumable(id: int, item: schemas.ConsumableCreate, db: Session = Depends(database.get_db)):
    db_c = db.query(models.Consumable).filter(models.Consumable.id == id).first()
    if not db_c: raise HTTPException(status_code=404)
    
    old_balance = db_c.stock_quantity 

    for k, v in item.dict().items(): setattr(db_c, k, v)
    
    # Ğ›Ğ¾Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ·Ğ¼Ñ–Ğ½
    if old_balance != db_c.stock_quantity:
        InventoryLogger.log(
            db,
            entity_type="consumable",
            entity_id=db_c.id,
            entity_name=db_c.name,
            old_balance=old_balance,
            new_balance=db_c.stock_quantity,
            reason="manual_correction"
        )

    db.commit(); db.refresh(db_c)
    return db_c

@router.delete("/consumables/{id}")
def delete_consumable(id: int, db: Session = Depends(database.get_db)):
    db_c = db.query(models.Consumable).filter(models.Consumable.id == id).first()
    if not db_c: raise HTTPException(status_code=404)
    db.delete(db_c); db.commit()
    return {"status": "deleted"}

# ==========================================
# HISTORY (Ğ†ÑÑ‚Ğ¾Ñ€Ñ–Ñ Ñ€ÑƒÑ…Ñƒ)
# ==========================================
@router.get("/history/", response_model=List[schemas.InventoryTransactionRead])
def get_inventory_history(
    entity_type: str = None, 
    entity_id: int = None, 
    limit: int = 50, 
    db: Session = Depends(database.get_db)
):
    query = db.query(models.InventoryTransaction)
    
    if entity_type:
        query = query.filter(models.InventoryTransaction.entity_type == entity_type)
    if entity_id:
        query = query.filter(models.InventoryTransaction.entity_id == entity_id)
        
    return query.order_by(models.InventoryTransaction.created_at.desc()).limit(limit).all()

--------------------------------------------------
PATH: ./.history/product_service/routers/categories_20260123212412.py
--------------------------------------------------
from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from typing import List
import database, schemas, models

router = APIRouter(prefix="/categories", tags=["Categories"])

@router.post("/", response_model=schemas.Category)
def create_category(category: schemas.CategoryCreate, db: Session = Depends(database.get_db)):
    # ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ÑÑ”Ğ¼Ğ¾ Ğ½Ğ° Ğ´ÑƒĞ±Ğ»Ñ–ĞºĞ°Ñ‚
    db_category = db.query(models.Category).filter(models.Category.name == category.name).first()
    if db_category: 
        raise HTTPException(status_code=400, detail="Category already exists")
    
    # Ğ¡Ñ‚Ğ²Ğ¾Ñ€ÑÑ”Ğ¼Ğ¾ Ğ½Ğ¾Ğ²Ñƒ
    new_category = models.Category(
        name=category.name, 
        slug=category.slug, 
        color=category.color, 
        parent_id=category.parent_id
    )
    db.add(new_category)
    db.commit()
    db.refresh(new_category)
    return new_category

@router.get("/", response_model=List[schemas.Category])
def read_categories(skip: int = 0, limit: int = 100, db: Session = Depends(database.get_db)):
    return db.query(models.Category).offset(skip).limit(limit).all()

# !!! ĞĞĞ’Ğ•: ĞĞ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ— !!!
@router.put("/{category_id}", response_model=schemas.Category)
def update_category(category_id: int, category_data: schemas.CategoryCreate, db: Session = Depends(database.get_db)):
    db_category = db.query(models.Category).filter(models.Category.id == category_id).first()
    if not db_category:
        raise HTTPException(status_code=404, detail="Category not found")
    
    # ĞĞ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ¿Ğ¾Ğ»Ñ
    db_category.name = category_data.name
    db_category.slug = category_data.slug
    db_category.color = category_data.color
    
    # Ğ—Ğ°Ñ…Ğ¸ÑÑ‚ Ğ²Ñ–Ğ´ Ñ†Ğ¸ĞºĞ»Ñ–Ñ‡Ğ½Ğ¾ÑÑ‚Ñ– (ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ Ğ½Ğµ Ğ¼Ğ¾Ğ¶Ğµ Ğ±ÑƒÑ‚Ğ¸ Ğ±Ğ°Ñ‚ÑŒĞºĞ¾Ğ¼ ÑĞ°Ğ¼Ğ° ÑĞ¾Ğ±Ñ–)
    if category_data.parent_id == category_id:
         raise HTTPException(status_code=400, detail="Category cannot be its own parent")
         
    db_category.parent_id = category_data.parent_id

    db.commit()
    db.refresh(db_category)
    return db_category

# !!! ĞĞĞ’Ğ•: Ğ’Ğ¸Ğ´Ğ°Ğ»ĞµĞ½Ğ½Ñ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ— !!!
@router.delete("/{category_id}")
def delete_category(category_id: int, db: Session = Depends(database.get_db)):
    db_category = db.query(models.Category).filter(models.Category.id == category_id).first()
    if not db_category:
        raise HTTPException(status_code=404, detail="Category not found")
    
    db.delete(db_category)
    db.commit()
    return {"status": "deleted"}

--------------------------------------------------
PATH: ./.history/product_service/routers/inventory_20260125223438.py
--------------------------------------------------
# FILE: product_service/routers/inventory.py

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from sqlalchemy import or_
from typing import List
import database, schemas, models
from services.inventory_logger import InventoryLogger

router = APIRouter(tags=["Inventory"])

# --- UNITS (ĞĞ´Ğ¸Ğ½Ğ¸Ñ†Ñ– Ğ²Ğ¸Ğ¼Ñ–Ñ€Ñƒ) ---
@router.post("/units/", response_model=schemas.Unit)
def create_unit(unit: schemas.UnitCreate, db: Session = Depends(database.get_db)):
    exists = db.query(models.Unit).filter(or_(models.Unit.name == unit.name, models.Unit.symbol == unit.symbol)).first()
    if exists: raise HTTPException(status_code=400, detail="ĞĞ´Ğ¸Ğ½Ğ¸Ñ†Ñ Ñ–ÑĞ½ÑƒÑ”")
    db_unit = models.Unit(name=unit.name, symbol=unit.symbol)
    db.add(db_unit); db.commit(); db.refresh(db_unit)
    return db_unit

@router.get("/units/", response_model=List[schemas.Unit])
def read_units(db: Session = Depends(database.get_db)):
    return db.query(models.Unit).all()

# --- INGREDIENTS (Ğ¡Ğ¸Ñ€Ğ¾Ğ²Ğ¸Ğ½Ğ°) ---
@router.post("/ingredients/", response_model=schemas.Ingredient)
def create_ingredient(ingredient: schemas.IngredientCreate, db: Session = Depends(database.get_db)):
    exists = db.query(models.Ingredient).filter(models.Ingredient.name == ingredient.name).first()
    if exists: raise HTTPException(status_code=400, detail="Ingredient already exists")
    new_item = models.Ingredient(**ingredient.dict())
    db.add(new_item); db.commit(); db.refresh(new_item)
    return new_item

@router.get("/ingredients/", response_model=List[schemas.Ingredient])
def read_ingredients(db: Session = Depends(database.get_db)):
    return db.query(models.Ingredient).all()

@router.put("/ingredients/{ingredient_id}", response_model=schemas.Ingredient)
def update_ingredient(ingredient_id: int, ingredient_data: schemas.IngredientCreate, db: Session = Depends(database.get_db)):
    db_ingredient = db.query(models.Ingredient).filter(models.Ingredient.id == ingredient_id).first()
    if not db_ingredient: raise HTTPException(status_code=404, detail="Ingredient not found")
    
    # 1. Ğ—Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ñ”Ğ¼Ğ¾ ÑÑ‚Ğ°Ñ€Ğ¸Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ
    old_balance = db_ingredient.stock_quantity
    
    # 2. ĞĞ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ¿Ğ¾Ğ»Ñ
    db_ingredient.name = ingredient_data.name
    db_ingredient.unit_id = ingredient_data.unit_id
    db_ingredient.cost_per_unit = ingredient_data.cost_per_unit
    
    # 3. Ğ¯ĞºÑ‰Ğ¾ Ğ·Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº Ğ·Ğ¼Ñ–Ğ½Ğ¸Ğ²ÑÑ - Ğ¿Ğ¸ÑˆĞµĞ¼Ğ¾ Ñ†Ğµ
    if ingredient_data.stock_quantity != old_balance:
        db_ingredient.stock_quantity = ingredient_data.stock_quantity
        # Ğ›ĞĞ“Ğ£Ğ’ĞĞĞĞ¯
        InventoryLogger.log(
            db, 
            entity_type="ingredient", 
            entity_id=db_ingredient.id, 
            entity_name=db_ingredient.name, 
            old_balance=old_balance, 
            new_balance=db_ingredient.stock_quantity, 
            reason="manual_correction"
        )
    
    db.commit(); db.refresh(db_ingredient)
    return db_ingredient

@router.delete("/ingredients/{ingredient_id}")
def delete_ingredient(ingredient_id: int, db: Session = Depends(database.get_db)):
    db_ingredient = db.query(models.Ingredient).filter(models.Ingredient.id == ingredient_id).first()
    if not db_ingredient: raise HTTPException(status_code=404)
    try: 
        db.delete(db_ingredient); db.commit()
    except: 
        db.rollback(); raise HTTPException(status_code=400, detail="Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ñ‚ÑŒÑÑ Ğ² Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ğ°Ñ…")
    return {"status": "deleted"}

# --- CONSUMABLES (Ğ’Ğ¸Ñ‚Ñ€Ğ°Ñ‚Ğ½Ñ– Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸) ---
@router.post("/consumables/", response_model=schemas.Consumable)
def create_consumable(item: schemas.ConsumableCreate, db: Session = Depends(database.get_db)):
    exists = db.query(models.Consumable).filter(models.Consumable.name == item.name).first()
    if exists: raise HTTPException(status_code=400, detail="Ğ’Ğ¶Ğµ Ñ–ÑĞ½ÑƒÑ”")
    new_c = models.Consumable(**item.dict())
    db.add(new_c); db.commit(); db.refresh(new_c)
    return new_c

@router.get("/consumables/", response_model=List[schemas.Consumable])
def read_consumables(db: Session = Depends(database.get_db)):
    return db.query(models.Consumable).all()

@router.put("/consumables/{id}", response_model=schemas.Consumable)
def update_consumable(id: int, item: schemas.ConsumableCreate, db: Session = Depends(database.get_db)):
    db_c = db.query(models.Consumable).filter(models.Consumable.id == id).first()
    if not db_c: raise HTTPException(status_code=404)
    
    old_balance = db_c.stock_quantity # <-- Ğ—Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ñ”Ğ¼Ğ¾ ÑÑ‚Ğ°Ñ€Ğµ

    # ĞĞ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ²ÑĞµ
    for k, v in item.dict().items(): setattr(db_c, k, v)
    
    # Ğ›ĞĞ“Ğ£Ğ’ĞĞĞĞ¯
    InventoryLogger.log(
        db,
        entity_type="consumable",
        entity_id=db_c.id,
        entity_name=db_c.name,
        old_balance=old_balance,
        new_balance=db_c.stock_quantity,
        reason="manual_correction"
    )

    db.commit(); db.refresh(db_c)
    return db_c

@router.delete("/consumables/{id}")
def delete_consumable(id: int, db: Session = Depends(database.get_db)):
    db_c = db.query(models.Consumable).filter(models.Consumable.id == id).first()
    if not db_c: raise HTTPException(status_code=404)
    db.delete(db_c); db.commit()
    return {"status": "deleted"}

# --- HISTORY ---
@router.get("/history/", response_model=List[schemas.InventoryTransactionRead])
def get_inventory_history(entity_type: str = None, entity_id: int = None, limit: int = 50, db: Session = Depends(database.get_db)):
    query = db.query(models.InventoryTransaction)
    
    if entity_type:
        query = query.filter(models.InventoryTransaction.entity_type == entity_type)
    if entity_id:
        query = query.filter(models.InventoryTransaction.entity_id == entity_id)
        
    return query.order_by(models.InventoryTransaction.created_at.desc()).limit(limit).all()



--------------------------------------------------
PATH: ./.history/product_service/routers/inventory_20260124232611.py
--------------------------------------------------
# FILE: product_service/routers/inventory.py

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from sqlalchemy import or_
from typing import List
import database, schemas, models
from services.inventory_logger import InventoryLogger
from pydantic import BaseModel

router = APIRouter(tags=["Inventory"])

# --- UNITS (ĞĞ´Ğ¸Ğ½Ğ¸Ñ†Ñ– Ğ²Ğ¸Ğ¼Ñ–Ñ€Ñƒ) ---
@router.post("/units/", response_model=schemas.Unit)
def create_unit(unit: schemas.UnitCreate, db: Session = Depends(database.get_db)):
    exists = db.query(models.Unit).filter(or_(models.Unit.name == unit.name, models.Unit.symbol == unit.symbol)).first()
    if exists: raise HTTPException(status_code=400, detail="ĞĞ´Ğ¸Ğ½Ğ¸Ñ†Ñ Ñ–ÑĞ½ÑƒÑ”")
    db_unit = models.Unit(name=unit.name, symbol=unit.symbol)
    db.add(db_unit); db.commit(); db.refresh(db_unit)
    return db_unit

@router.get("/units/", response_model=List[schemas.Unit])
def read_units(db: Session = Depends(database.get_db)):
    return db.query(models.Unit).all()

# --- INGREDIENTS (Ğ¡Ğ¸Ñ€Ğ¾Ğ²Ğ¸Ğ½Ğ°) ---
@router.post("/ingredients/", response_model=schemas.Ingredient)
def create_ingredient(ingredient: schemas.IngredientCreate, db: Session = Depends(database.get_db)):
    exists = db.query(models.Ingredient).filter(models.Ingredient.name == ingredient.name).first()
    if exists: raise HTTPException(status_code=400, detail="Ingredient already exists")
    new_item = models.Ingredient(**ingredient.dict())
    db.add(new_item); db.commit(); db.refresh(new_item)
    return new_item

@router.get("/ingredients/", response_model=List[schemas.Ingredient])
def read_ingredients(db: Session = Depends(database.get_db)):
    return db.query(models.Ingredient).all()

@router.put("/ingredients/{ingredient_id}", response_model=schemas.Ingredient)
def update_ingredient(ingredient_id: int, ingredient_data: schemas.IngredientCreate, db: Session = Depends(database.get_db)):
    db_ingredient = db.query(models.Ingredient).filter(models.Ingredient.id == ingredient_id).first()
    if not db_ingredient: raise HTTPException(status_code=404, detail="Ingredient not found")
    
    # 1. Ğ—Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ñ”Ğ¼Ğ¾ ÑÑ‚Ğ°Ñ€Ğ¸Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ
    old_balance = db_ingredient.stock_quantity
    
    # 2. ĞĞ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ¿Ğ¾Ğ»Ñ
    db_ingredient.name = ingredient_data.name
    db_ingredient.unit_id = ingredient_data.unit_id
    db_ingredient.cost_per_unit = ingredient_data.cost_per_unit
    
    # 3. Ğ¯ĞºÑ‰Ğ¾ Ğ·Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº Ğ·Ğ¼Ñ–Ğ½Ğ¸Ğ²ÑÑ - Ğ¿Ğ¸ÑˆĞµĞ¼Ğ¾ Ñ†Ğµ
    if ingredient_data.stock_quantity != old_balance:
        db_ingredient.stock_quantity = ingredient_data.stock_quantity
        # Ğ›ĞĞ“Ğ£Ğ’ĞĞĞĞ¯
        InventoryLogger.log(
            db, 
            entity_type="ingredient", 
            entity_id=db_ingredient.id, 
            entity_name=db_ingredient.name, 
            old_balance=old_balance, 
            new_balance=db_ingredient.stock_quantity, 
            reason="manual_correction"
        )
    
    db.commit(); db.refresh(db_ingredient)
    return db_ingredient

@router.delete("/ingredients/{ingredient_id}")
def delete_ingredient(ingredient_id: int, db: Session = Depends(database.get_db)):
    db_ingredient = db.query(models.Ingredient).filter(models.Ingredient.id == ingredient_id).first()
    if not db_ingredient: raise HTTPException(status_code=404)
    try: 
        db.delete(db_ingredient); db.commit()
    except: 
        db.rollback(); raise HTTPException(status_code=400, detail="Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ñ‚ÑŒÑÑ Ğ² Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ğ°Ñ…")
    return {"status": "deleted"}

# --- CONSUMABLES (Ğ’Ğ¸Ñ‚Ñ€Ğ°Ñ‚Ğ½Ñ– Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸) ---
@router.post("/consumables/", response_model=schemas.Consumable)
def create_consumable(item: schemas.ConsumableCreate, db: Session = Depends(database.get_db)):
    exists = db.query(models.Consumable).filter(models.Consumable.name == item.name).first()
    if exists: raise HTTPException(status_code=400, detail="Ğ’Ğ¶Ğµ Ñ–ÑĞ½ÑƒÑ”")
    new_c = models.Consumable(**item.dict())
    db.add(new_c); db.commit(); db.refresh(new_c)
    return new_c

@router.get("/consumables/", response_model=List[schemas.Consumable])
def read_consumables(db: Session = Depends(database.get_db)):
    return db.query(models.Consumable).all()

@router.put("/consumables/{id}", response_model=schemas.Consumable)
def update_consumable(id: int, item: schemas.ConsumableCreate, db: Session = Depends(database.get_db)):
    db_c = db.query(models.Consumable).filter(models.Consumable.id == id).first()
    if not db_c: raise HTTPException(status_code=404)
    
    old_balance = db_c.stock_quantity # <-- Ğ—Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ñ”Ğ¼Ğ¾ ÑÑ‚Ğ°Ñ€Ğµ

    # ĞĞ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ²ÑĞµ
    for k, v in item.dict().items(): setattr(db_c, k, v)
    
    # Ğ›ĞĞ“Ğ£Ğ’ĞĞĞĞ¯
    InventoryLogger.log(
        db,
        entity_type="consumable",
        entity_id=db_c.id,
        entity_name=db_c.name,
        old_balance=old_balance,
        new_balance=db_c.stock_quantity,
        reason="manual_correction"
    )

    db.commit(); db.refresh(db_c)
    return db_c

@router.delete("/consumables/{id}")
def delete_consumable(id: int, db: Session = Depends(database.get_db)):
    db_c = db.query(models.Consumable).filter(models.Consumable.id == id).first()
    if not db_c: raise HTTPException(status_code=404)
    db.delete(db_c); db.commit()
    return {"status": "deleted"}

# --- HISTORY ---
@router.get("/history/", response_model=List[schemas.InventoryTransactionRead])
def get_inventory_history(entity_type: str = None, entity_id: int = None, limit: int = 50, db: Session = Depends(database.get_db)):
    query = db.query(models.InventoryTransaction)
    
    if entity_type:
        query = query.filter(models.InventoryTransaction.entity_type == entity_type)
    if entity_id:
        query = query.filter(models.InventoryTransaction.entity_id == entity_id)
        
    return query.order_by(models.InventoryTransaction.created_at.desc()).limit(limit).all()

    # Ğ¡Ñ…ĞµĞ¼Ğ° Ğ´Ğ»Ñ Ğ·Ğ°Ğ¿Ğ¸Ñ‚Ñƒ Ğ½Ğ° ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ½Ñ
class StockDeductionItem(BaseModel):
    entity_type: str  # 'product', 'product_variant', 'consumable'
    entity_id: int
    quantity: float

@router.post("/reduce-batch")
def reduce_stock_batch(items: List[StockDeductionItem], db: Session = Depends(database.get_db)):
    for item in items:
        # 1. Ğ—Ğ½Ğ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€/Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚/Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ» Ğ² Ğ±Ğ°Ğ·Ñ–
        db_obj = None
        model = None
        
        if item.entity_type == 'product':
            model = models.Product
            db_obj = db.query(models.Product).filter(models.Product.id == item.entity_id).first()
        elif item.entity_type == 'product_variant':
            model = models.ProductVariant
            db_obj = db.query(models.ProductVariant).filter(models.ProductVariant.id == item.entity_id).first()
        elif item.entity_type == 'consumable':
            model = models.Consumable
            db_obj = db.query(models.Consumable).filter(models.Consumable.id == item.entity_id).first()
            
        # 2. Ğ¯ĞºÑ‰Ğ¾ Ğ·Ğ½Ğ°Ğ¹ÑˆĞ»Ğ¸ - ÑĞ¿Ğ¸ÑÑƒÑ”Ğ¼Ğ¾
        if db_obj:
            old_qty = db_obj.stock_quantity
            # Ğ¡Ğ¿Ğ¸ÑĞ°Ğ½Ğ½Ñ - Ñ†Ğµ Ğ·Ğ¼ĞµĞ½ÑˆĞµĞ½Ğ½Ñ, Ñ‚Ğ¾Ğ¼Ñƒ Ğ²Ñ–Ğ´Ğ½Ñ–Ğ¼Ğ°Ñ”Ğ¼Ğ¾
            new_qty = old_qty - item.quantity
            db_obj.stock_quantity = new_qty
            
            # Ğ¤Ğ¾Ñ€Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ğ³Ğ°Ñ€Ğ½Ñƒ Ğ½Ğ°Ğ·Ğ²Ñƒ Ğ´Ğ»Ñ Ğ»Ğ¾Ğ³Ñ–Ğ²
            log_name = db_obj.name
            if item.entity_type == 'product_variant':
                # Ğ¡Ğ¿Ñ€Ğ¾Ğ±ÑƒÑ”Ğ¼Ğ¾ Ğ´Ñ–ÑÑ‚Ğ°Ñ‚Ğ¸ Ğ½Ğ°Ğ·Ğ²Ñƒ Ğ±Ğ°Ñ‚ÑŒĞºÑ–Ğ²ÑÑŒĞºĞ¾Ğ³Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ, ÑĞºÑ‰Ğ¾ Ñ” Ğ·Ğ²'ÑĞ·Ğ¾Ğº
                parent_name = db_obj.product.name if db_obj.product else "Ğ¢Ğ¾Ğ²Ğ°Ñ€"
                log_name = f"{parent_name} ({db_obj.name})"

            # 3. ĞŸĞ˜Ğ¨Ğ•ĞœĞ Ğ’ Ğ†Ğ¡Ğ¢ĞĞ Ğ†Ğ® (reason='sale')
            InventoryLogger.log(
                db,
                entity_type=item.entity_type,
                entity_id=db_obj.id,
                entity_name=log_name,
                old_balance=old_qty,
                new_balance=new_qty,
                reason="sale" # <--- Ğ¦Ğµ ĞºĞ»ÑÑ‡Ğ¾Ğ²Ğµ ÑĞ»Ğ¾Ğ²Ğ¾ Ğ´Ğ»Ñ Ñ–ÑÑ‚Ğ¾Ñ€Ñ–Ñ— Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶Ñ–Ğ²
            )
    
    db.commit()
    return {"status": "deducted"}

--------------------------------------------------
PATH: ./.history/product_service/routers/products_20260120130137.py
--------------------------------------------------
# FILE: product_service/routers/products.py

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from typing import List
import database, schemas, models
from services.product_service import ProductService
from services.inventory_logger import InventoryLogger

router = APIRouter(prefix="/products", tags=["Products"])

@router.post("/", response_model=schemas.Product)
def create_product(product: schemas.ProductCreate, db: Session = Depends(database.get_db)):
    # Ğ’Ğ¸ĞºĞ»Ğ¸ĞºĞ°Ñ”Ğ¼Ğ¾ ÑĞµÑ€Ğ²Ñ–Ñ, ÑĞºĞ¸Ğ¹ Ğ·Ñ€Ğ¾Ğ±Ğ¸Ñ‚ÑŒ Ğ²ÑÑ Ğ±Ñ€ÑƒĞ´Ğ½Ñƒ Ñ€Ğ¾Ğ±Ğ¾Ñ‚Ñƒ
    return ProductService.create_product(db, product)

@router.put("/{product_id}", response_model=schemas.Product)
def update_product(product_id: int, product_data: schemas.ProductCreate, db: Session = Depends(database.get_db)):
    updated_product = ProductService.update_product(db, product_id, product_data)
    if not updated_product:
        raise HTTPException(status_code=404, detail="Product not found")
    return updated_product

@router.get("/", response_model=List[schemas.Product])
def read_products(db: Session = Depends(database.get_db)):
    products = db.query(models.Product).all()
    
    # --- UI Helper ---
    # Ğ”Ğ¾Ğ·Ğ°Ğ¿Ğ¾Ğ²Ğ½ÑÑ”Ğ¼Ğ¾ Ğ½Ğ°Ğ·Ğ²Ğ¸ Ğ²Ğ¸Ñ‚Ñ€Ğ°Ñ‚Ğ½Ğ¸Ñ… Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ñ–Ğ², Ñ‰Ğ¾Ğ± Ğ½Ğ° Ñ„Ñ€Ğ¾Ğ½Ñ‚Ñ– Ğ±ÑƒĞ»Ğ¾ Ğ³Ğ°Ñ€Ğ½Ğ¾
    # (SQLAlchemy Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ÑƒÑ” ID, Ğ° Ğ¼Ğ¸ Ğ´Ñ–ÑÑ‚Ğ°Ñ”Ğ¼Ğ¾ Ñ–Ğ¼ĞµĞ½Ğ° Ğ·Ñ– Ğ·Ğ²'ÑĞ·ĞºÑ–Ğ²)
    for p in products:
        for c in p.consumables:
            if c.consumable: c.consumable_name = c.consumable.name
            else: c.consumable_name = "DELETED"
            
        if p.variants:
            for v in p.variants:
                for vc in v.consumables:
                    if vc.consumable: vc.consumable_name = vc.consumable.name
                    else: vc.consumable_name = "Unknown"
                # !!! ĞĞĞ’Ğ•: Ğ”Ğ»Ñ Ñ–Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ñ–Ğ² !!!
                for vi in v.ingredients:
                    if vi.ingredient: vi.ingredient_name = vi.ingredient.name
                    else: vi.ingredient_name = "Unknown"
    return products

# 1. ĞĞ½Ğ¾Ğ²Ğ¸Ñ‚Ğ¸ Ğ·Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾Ğ³Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ
@router.patch("/{product_id}/stock")
def update_product_stock(product_id: int, qty: float, db: Session = Depends(database.get_db)):
    product = db.query(models.Product).filter(models.Product.id == product_id).first()
    if not product: raise HTTPException(status_code=404)
    
    old_qty = product.stock_quantity
    product.stock_quantity = qty
    
    InventoryLogger.log(db, "product", product.id, product.name, old_qty, qty, "manual_correction")
    
    db.commit()
    return {"status": "updated", "new_quantity": qty}

# 2. ĞĞ½Ğ¾Ğ²Ğ¸Ñ‚Ğ¸ Ğ·Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ
@router.patch("/variants/{variant_id}/stock")
def update_variant_stock(variant_id: int, qty: float, db: Session = Depends(database.get_db)):
    variant = db.query(models.ProductVariant).filter(models.ProductVariant.id == variant_id).first()
    if not variant: raise HTTPException(status_code=404)
    
    old_qty = variant.stock_quantity
    variant.stock_quantity = qty
    
    # ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ğ½Ğ°Ğ·Ğ²Ñƒ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ Ğ´Ğ»Ñ ĞºÑ€Ğ°ÑĞ¸Ğ²Ğ¾Ğ³Ğ¾ Ğ»Ğ¾Ğ³Ñƒ
    p_name = variant.product.name if variant.product else "Unknown"
    full_name = f"{p_name} ({variant.name})"

    InventoryLogger.log(db, "product_variant", variant.id, full_name, old_qty, qty, "manual_correction")
    
    db.commit()
    return {"status": "updated", "new_quantity": qty}

@router.delete("/{product_id}")
def delete_product(product_id: int, db: Session = Depends(database.get_db)):
    product = db.query(models.Product).filter(models.Product.id == product_id).first()
    if not product:
        raise HTTPException(status_code=404, detail="Product not found")
    
    # Ğ’Ğ¸Ğ´Ğ°Ğ»ĞµĞ½Ğ½Ñ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ ĞºĞ°ÑĞºĞ°Ğ´Ğ½Ğ¾ Ğ²Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸ Ñ‚Ğ° Ğ·Ğ²'ÑĞ·ĞºĞ¸ (Ğ·Ğ°Ğ²Ğ´ÑĞºĞ¸ Ğ½Ğ°Ğ»Ğ°ÑˆÑ‚ÑƒĞ²Ğ°Ğ½Ğ½ÑĞ¼ models.py)
    db.delete(product)
    db.commit()
    return {"status": "deleted"}

--------------------------------------------------
PATH: ./.history/product_service/routers/products_20260125124231.py
--------------------------------------------------
# FILE: product_service/routers/products.py

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from typing import List
import database, schemas, models
from services.product_service import ProductService
from services.inventory_logger import InventoryLogger

router = APIRouter(prefix="/products", tags=["Products"])

@router.post("/", response_model=schemas.Product)
def create_product(product: schemas.ProductCreate, db: Session = Depends(database.get_db)):
    # Ğ’Ğ¸ĞºĞ»Ğ¸ĞºĞ°Ñ”Ğ¼Ğ¾ ÑĞµÑ€Ğ²Ñ–Ñ, ÑĞºĞ¸Ğ¹ Ğ·Ñ€Ğ¾Ğ±Ğ¸Ñ‚ÑŒ Ğ²ÑÑ Ğ±Ñ€ÑƒĞ´Ğ½Ñƒ Ñ€Ğ¾Ğ±Ğ¾Ñ‚Ñƒ
    return ProductService.create_product(db, product)

@router.put("/{product_id}", response_model=schemas.Product)
def update_product(product_id: int, product_data: schemas.ProductCreate, db: Session = Depends(database.get_db)):
    updated_product = ProductService.update_product(db, product_id, product_data)
    if not updated_product:
        raise HTTPException(status_code=404, detail="Product not found")
    return updated_product

@router.get("/", response_model=List[schemas.Product])
def read_products(db: Session = Depends(database.get_db)):
    products = db.query(models.Product).all()
    
    # --- UI Helper ---
    # Ğ”Ğ¾Ğ·Ğ°Ğ¿Ğ¾Ğ²Ğ½ÑÑ”Ğ¼Ğ¾ Ğ½Ğ°Ğ·Ğ²Ğ¸ Ğ´Ğ»Ñ ĞºÑ€Ğ°ÑĞ¸Ğ²Ğ¾Ğ³Ğ¾ Ğ²Ñ–Ğ´Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ½Ğ° Ñ„Ñ€Ğ¾Ğ½Ñ‚Ñ–
    for p in products:
        # 1. Ğ”Ğ»Ñ ÑĞ°Ğ¼Ğ¾Ğ³Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ
        for c in p.consumables:
            if c.consumable:
                c.consumable_name = c.consumable.name # ĞŸÑ–Ğ´ÑÑ‚Ğ°Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ½Ğ°Ğ·Ğ²Ñƒ

        # 2. Ğ”Ğ›Ğ¯ Ğ’ĞĞ Ğ†ĞĞĞ¢Ğ†Ğ’ (Ğ¦Ğµ Ñ‚Ğµ, Ñ‡Ğ¾Ğ³Ğ¾ Ğ½Ğµ Ğ²Ğ¸ÑÑ‚Ğ°Ñ‡Ğ°Ğ»Ğ¾)
        if p.variants:
            for v in p.variants:
                # ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ
                for vc in v.consumables:
                    if vc.consumable:
                         # Pydantic ÑÑ…ĞµĞ¼Ğ° Ğ¾Ñ‡Ñ–ĞºÑƒÑ” consumable_name, Ğ·Ğ°Ğ¿Ğ¾Ğ²Ğ½ÑÑ”Ğ¼Ğ¾ Ğ¹Ğ¾Ğ³Ğ¾
                        vc.consumable_name = vc.consumable.name 
                
                # Ğ†Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ğ¸ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ
                for vi in v.ingredients:
                    if vi.ingredient:
                        vi.ingredient_name = vi.ingredient.name

    return products

# 1. ĞĞ½Ğ¾Ğ²Ğ¸Ñ‚Ğ¸ Ğ·Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾Ğ³Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ
@router.patch("/{product_id}/stock")
def update_product_stock(product_id: int, qty: float, db: Session = Depends(database.get_db)):
    product = db.query(models.Product).filter(models.Product.id == product_id).first()
    if not product: raise HTTPException(status_code=404)
    
    old_qty = product.stock_quantity
    product.stock_quantity = qty
    
    InventoryLogger.log(db, "product", product.id, product.name, old_qty, qty, "manual_correction")
    
    db.commit()
    return {"status": "updated", "new_quantity": qty}

# 2. ĞĞ½Ğ¾Ğ²Ğ¸Ñ‚Ğ¸ Ğ·Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ
@router.patch("/variants/{variant_id}/stock")
def update_variant_stock(variant_id: int, qty: float, db: Session = Depends(database.get_db)):
    variant = db.query(models.ProductVariant).filter(models.ProductVariant.id == variant_id).first()
    if not variant: raise HTTPException(status_code=404)
    
    old_qty = variant.stock_quantity
    variant.stock_quantity = qty
    
    # ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ğ½Ğ°Ğ·Ğ²Ñƒ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ Ğ´Ğ»Ñ ĞºÑ€Ğ°ÑĞ¸Ğ²Ğ¾Ğ³Ğ¾ Ğ»Ğ¾Ğ³Ñƒ
    p_name = variant.product.name if variant.product else "Unknown"
    full_name = f"{p_name} ({variant.name})"

    InventoryLogger.log(db, "product_variant", variant.id, full_name, old_qty, qty, "manual_correction")
    
    db.commit()
    return {"status": "updated", "new_quantity": qty}

@router.delete("/{product_id}")
def delete_product(product_id: int, db: Session = Depends(database.get_db)):
    product = db.query(models.Product).filter(models.Product.id == product_id).first()
    if not product:
        raise HTTPException(status_code=404, detail="Product not found")
    
    # Ğ’Ğ¸Ğ´Ğ°Ğ»ĞµĞ½Ğ½Ñ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ ĞºĞ°ÑĞºĞ°Ğ´Ğ½Ğ¾ Ğ²Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸ Ñ‚Ğ° Ğ·Ğ²'ÑĞ·ĞºĞ¸ (Ğ·Ğ°Ğ²Ğ´ÑĞºĞ¸ Ğ½Ğ°Ğ»Ğ°ÑˆÑ‚ÑƒĞ²Ğ°Ğ½Ğ½ÑĞ¼ models.py)
    db.delete(product)
    db.commit()
    return {"status": "deleted"}

--------------------------------------------------
PATH: ./.history/product_service/routers/inventory_20260126160649.py
--------------------------------------------------
# FILE: product_service/routers/inventory.py

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from sqlalchemy import or_, desc
from typing import List
import database, schemas, models
from services.inventory_logger import InventoryLogger

router = APIRouter(tags=["Inventory"])

# --- UNITS (ĞĞ´Ğ¸Ğ½Ğ¸Ñ†Ñ– Ğ²Ğ¸Ğ¼Ñ–Ñ€Ñƒ) ---
@router.post("/units/", response_model=schemas.Unit)
def create_unit(unit: schemas.UnitCreate, db: Session = Depends(database.get_db)):
    exists = db.query(models.Unit).filter(or_(models.Unit.name == unit.name, models.Unit.symbol == unit.symbol)).first()
    if exists: raise HTTPException(status_code=400, detail="ĞĞ´Ğ¸Ğ½Ğ¸Ñ†Ñ Ñ–ÑĞ½ÑƒÑ”")
    db_unit = models.Unit(name=unit.name, symbol=unit.symbol)
    db.add(db_unit); db.commit(); db.refresh(db_unit)
    return db_unit

@router.get("/units/", response_model=List[schemas.Unit])
def read_units(db: Session = Depends(database.get_db)):
    return db.query(models.Unit).all()

# --- INGREDIENTS (Ğ¡Ğ¸Ñ€Ğ¾Ğ²Ğ¸Ğ½Ğ°) ---
@router.post("/ingredients/", response_model=schemas.Ingredient)
def create_ingredient(ingredient: schemas.IngredientCreate, db: Session = Depends(database.get_db)):
    exists = db.query(models.Ingredient).filter(models.Ingredient.name == ingredient.name).first()
    if exists: raise HTTPException(status_code=400, detail="Ingredient already exists")
    new_item = models.Ingredient(**ingredient.dict())
    db.add(new_item); db.commit(); db.refresh(new_item)
    return new_item

@router.get("/ingredients/", response_model=List[schemas.Ingredient])
def read_ingredients(db: Session = Depends(database.get_db)):
    return db.query(models.Ingredient).all()

@router.put("/ingredients/{ingredient_id}", response_model=schemas.Ingredient)
def update_ingredient(ingredient_id: int, ingredient_data: schemas.IngredientCreate, db: Session = Depends(database.get_db)):
    db_ingredient = db.query(models.Ingredient).filter(models.Ingredient.id == ingredient_id).first()
    if not db_ingredient: raise HTTPException(status_code=404, detail="Ingredient not found")
    
    # 1. Ğ—Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ñ”Ğ¼Ğ¾ ÑÑ‚Ğ°Ñ€Ğ¸Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ
    old_balance = db_ingredient.stock_quantity
    
    # 2. ĞĞ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ¿Ğ¾Ğ»Ñ
    db_ingredient.name = ingredient_data.name
    db_ingredient.unit_id = ingredient_data.unit_id
    db_ingredient.cost_per_unit = ingredient_data.cost_per_unit
    
    # 3. Ğ¯ĞºÑ‰Ğ¾ Ğ·Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº Ğ·Ğ¼Ñ–Ğ½Ğ¸Ğ²ÑÑ - Ğ¿Ğ¸ÑˆĞµĞ¼Ğ¾ Ñ†Ğµ
    if ingredient_data.stock_quantity != old_balance:
        db_ingredient.stock_quantity = ingredient_data.stock_quantity
        # Ğ›ĞĞ“Ğ£Ğ’ĞĞĞĞ¯
        InventoryLogger.log(
            db, 
            entity_type="ingredient", 
            entity_id=db_ingredient.id, 
            entity_name=db_ingredient.name, 
            old_balance=old_balance, 
            new_balance=db_ingredient.stock_quantity, 
            reason="manual_correction"
        )
    
    db.commit(); db.refresh(db_ingredient)
    return db_ingredient

@router.delete("/ingredients/{ingredient_id}")
def delete_ingredient(ingredient_id: int, db: Session = Depends(database.get_db)):
    db_ingredient = db.query(models.Ingredient).filter(models.Ingredient.id == ingredient_id).first()
    if not db_ingredient: raise HTTPException(status_code=404)
    try: 
        db.delete(db_ingredient); db.commit()
    except: 
        db.rollback(); raise HTTPException(status_code=400, detail="Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ñ‚ÑŒÑÑ Ğ² Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ğ°Ñ…")
    return {"status": "deleted"}

# --- CONSUMABLES (Ğ’Ğ¸Ñ‚Ñ€Ğ°Ñ‚Ğ½Ñ– Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸) ---
@router.post("/consumables/", response_model=schemas.Consumable)
def create_consumable(item: schemas.ConsumableCreate, db: Session = Depends(database.get_db)):
    exists = db.query(models.Consumable).filter(models.Consumable.name == item.name).first()
    if exists: raise HTTPException(status_code=400, detail="Ğ’Ğ¶Ğµ Ñ–ÑĞ½ÑƒÑ”")
    new_c = models.Consumable(**item.dict())
    db.add(new_c); db.commit(); db.refresh(new_c)
    return new_c

@router.get("/consumables/", response_model=List[schemas.Consumable])
def read_consumables(db: Session = Depends(database.get_db)):
    return db.query(models.Consumable).all()

@router.put("/consumables/{id}", response_model=schemas.Consumable)
def update_consumable(id: int, item: schemas.ConsumableCreate, db: Session = Depends(database.get_db)):
    db_c = db.query(models.Consumable).filter(models.Consumable.id == id).first()
    if not db_c: raise HTTPException(status_code=404)
    
    old_balance = db_c.stock_quantity # <-- Ğ—Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ñ”Ğ¼Ğ¾ ÑÑ‚Ğ°Ñ€Ğµ

    # ĞĞ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ²ÑĞµ
    for k, v in item.dict().items(): setattr(db_c, k, v)
    
    # Ğ›ĞĞ“Ğ£Ğ’ĞĞĞĞ¯
    InventoryLogger.log(
        db,
        entity_type="consumable",
        entity_id=db_c.id,
        entity_name=db_c.name,
        old_balance=old_balance,
        new_balance=db_c.stock_quantity,
        reason="manual_correction"
    )

    db.commit(); db.refresh(db_c)
    return db_c

@router.delete("/consumables/{id}")
def delete_consumable(id: int, db: Session = Depends(database.get_db)):
    db_c = db.query(models.Consumable).filter(models.Consumable.id == id).first()
    if not db_c: raise HTTPException(status_code=404)
    db.delete(db_c); db.commit()
    return {"status": "deleted"}

# --- HISTORY (Ğ†ÑÑ‚Ğ¾Ñ€Ñ–Ñ Ñ€ÑƒÑ…Ñƒ) ---
@router.get("/history/", response_model=List[schemas.InventoryTransactionRead])
def get_inventory_history(
    entity_type: str, 
    entity_id: int, 
    limit: int = 50, 
    db: Session = Depends(database.get_db)
):
    return db.query(models.InventoryTransaction)\
        .filter(models.InventoryTransaction.entity_type == entity_type)\
        .filter(models.InventoryTransaction.entity_id == entity_id)\
        .order_by(desc(models.InventoryTransaction.created_at))\
        .limit(limit).all()



--------------------------------------------------
PATH: ./.history/product_service/routers/products_20260125204218.py
--------------------------------------------------
# FILE: product_service/routers/products.py

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from typing import List
import database, schemas, models
from services.product_service import ProductService
from services.inventory_logger import InventoryLogger

router = APIRouter(prefix="/products", tags=["Products"])

@router.post("/", response_model=schemas.Product)
def create_product(product: schemas.ProductCreate, db: Session = Depends(database.get_db)):
    # Ğ’Ğ¸ĞºĞ»Ğ¸ĞºĞ°Ñ”Ğ¼Ğ¾ ÑĞµÑ€Ğ²Ñ–Ñ, ÑĞºĞ¸Ğ¹ Ğ·Ñ€Ğ¾Ğ±Ğ¸Ñ‚ÑŒ Ğ²ÑÑ Ğ±Ñ€ÑƒĞ´Ğ½Ñƒ Ñ€Ğ¾Ğ±Ğ¾Ñ‚Ñƒ
    return ProductService.create_product(db, product)

@router.put("/{product_id}", response_model=schemas.Product)
def update_product(product_id: int, product_data: schemas.ProductCreate, db: Session = Depends(database.get_db)):
    updated_product = ProductService.update_product(db, product_id, product_data)
    if not updated_product:
        raise HTTPException(status_code=404, detail="Product not found")
    return updated_product

@router.get("/", response_model=List[schemas.Product])
def read_products(db: Session = Depends(database.get_db)):
    products = db.query(models.Product).all()
    
    # --- UI Helper ---
    # Ğ”Ğ¾Ğ·Ğ°Ğ¿Ğ¾Ğ²Ğ½ÑÑ”Ğ¼Ğ¾ Ğ½Ğ°Ğ·Ğ²Ğ¸ Ğ´Ğ»Ñ ĞºÑ€Ğ°ÑĞ¸Ğ²Ğ¾Ğ³Ğ¾ Ğ²Ñ–Ğ´Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ½Ğ° Ñ„Ñ€Ğ¾Ğ½Ñ‚Ñ–
    for p in products:
        # 1. Ğ”Ğ»Ñ ÑĞ°Ğ¼Ğ¾Ğ³Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ
        for c in p.consumables:
            if c.consumable:
                c.consumable_name = c.consumable.name # ĞŸÑ–Ğ´ÑÑ‚Ğ°Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ½Ğ°Ğ·Ğ²Ñƒ

        # 2. Ğ”Ğ›Ğ¯ Ğ’ĞĞ Ğ†ĞĞĞ¢Ğ†Ğ’ (Ğ¦Ğµ Ñ‚Ğµ, Ñ‡Ğ¾Ğ³Ğ¾ Ğ½Ğµ Ğ²Ğ¸ÑÑ‚Ğ°Ñ‡Ğ°Ğ»Ğ¾)
        if p.variants:
            for v in p.variants:
                # ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ
                for vc in v.consumables:
                    if vc.consumable:
                         # Pydantic ÑÑ…ĞµĞ¼Ğ° Ğ¾Ñ‡Ñ–ĞºÑƒÑ” consumable_name, Ğ·Ğ°Ğ¿Ğ¾Ğ²Ğ½ÑÑ”Ğ¼Ğ¾ Ğ¹Ğ¾Ğ³Ğ¾
                        vc.consumable_name = vc.consumable.name 
                
                # Ğ†Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ğ¸ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ
                for vi in v.ingredients:
                    if vi.ingredient:
                        vi.ingredient_name = vi.ingredient.name

    return products

# 1. ĞĞ½Ğ¾Ğ²Ğ¸Ñ‚Ğ¸ Ğ·Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾Ğ³Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ
@router.patch("/{product_id}/stock")
def update_product_stock(product_id: int, qty: float, db: Session = Depends(database.get_db)):
    product = db.query(models.Product).filter(models.Product.id == product_id).first()
    if not product: raise HTTPException(status_code=404)
    
    old_qty = product.stock_quantity
    product.stock_quantity = qty
    
    InventoryLogger.log(db, "product", product.id, product.name, old_qty, qty, "manual_correction")
    
    db.commit()
    return {"status": "updated", "new_quantity": qty}

# 2. ĞĞ½Ğ¾Ğ²Ğ¸Ñ‚Ğ¸ Ğ·Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ
@router.patch("/variants/{variant_id}/stock")
def update_variant_stock(variant_id: int, qty: float, db: Session = Depends(database.get_db)):
    variant = db.query(models.ProductVariant).filter(models.ProductVariant.id == variant_id).first()
    if not variant: raise HTTPException(status_code=404)
    
    old_qty = variant.stock_quantity
    variant.stock_quantity = qty
    
    # ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ğ½Ğ°Ğ·Ğ²Ñƒ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ Ğ´Ğ»Ñ ĞºÑ€Ğ°ÑĞ¸Ğ²Ğ¾Ğ³Ğ¾ Ğ»Ğ¾Ğ³Ñƒ
    p_name = variant.product.name if variant.product else "Unknown"
    full_name = f"{p_name} ({variant.name})"

    InventoryLogger.log(db, "product_variant", variant.id, full_name, old_qty, qty, "manual_correction")
    
    db.commit()
    return {"status": "updated", "new_quantity": qty}

@router.delete("/{product_id}")
def delete_product(product_id: int, db: Session = Depends(database.get_db)):
    product = db.query(models.Product).filter(models.Product.id == product_id).first()
    if not product:
        raise HTTPException(status_code=404, detail="Product not found")
    
    # Ğ’Ğ¸Ğ´Ğ°Ğ»ĞµĞ½Ğ½Ñ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ ĞºĞ°ÑĞºĞ°Ğ´Ğ½Ğ¾ Ğ²Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸ Ñ‚Ğ° Ğ·Ğ²'ÑĞ·ĞºĞ¸ (Ğ·Ğ°Ğ²Ğ´ÑĞºĞ¸ Ğ½Ğ°Ğ»Ğ°ÑˆÑ‚ÑƒĞ²Ğ°Ğ½Ğ½ÑĞ¼ models.py)
    db.delete(product)
    db.commit()
    return {"status": "deleted"}

--------------------------------------------------
PATH: ./.history/product_service/routers/categories_20260120224434.py
--------------------------------------------------
from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from typing import List
import database, schemas, models

router = APIRouter(prefix="/categories", tags=["Categories"])

@router.post("/", response_model=schemas.Category)
def create_category(category: schemas.CategoryCreate, db: Session = Depends(database.get_db)):
    # ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ÑÑ”Ğ¼Ğ¾ Ğ½Ğ° Ğ´ÑƒĞ±Ğ»Ñ–ĞºĞ°Ñ‚
    db_category = db.query(models.Category).filter(models.Category.name == category.name).first()
    if db_category: 
        raise HTTPException(status_code=400, detail="Category already exists")
    
    # Ğ¡Ñ‚Ğ²Ğ¾Ñ€ÑÑ”Ğ¼Ğ¾ Ğ½Ğ¾Ğ²Ñƒ
    new_category = models.Category(
        name=category.name, 
        slug=category.slug, 
        color=category.color, 
        parent_id=category.parent_id
    )
    db.add(new_category)
    db.commit()
    db.refresh(new_category)
    return new_category

@router.get("/", response_model=List[schemas.Category])
def read_categories(skip: int = 0, limit: int = 100, db: Session = Depends(database.get_db)):
    return db.query(models.Category).offset(skip).limit(limit).all()

# !!! ĞĞĞ’Ğ•: ĞĞ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ— !!!
@router.put("/{category_id}", response_model=schemas.Category)
def update_category(category_id: int, category_data: schemas.CategoryCreate, db: Session = Depends(database.get_db)):
    db_category = db.query(models.Category).filter(models.Category.id == category_id).first()
    if not db_category:
        raise HTTPException(status_code=404, detail="Category not found")
    
    # ĞĞ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ¿Ğ¾Ğ»Ñ
    db_category.name = category_data.name
    db_category.slug = category_data.slug
    db_category.color = category_data.color
    
    # Ğ—Ğ°Ñ…Ğ¸ÑÑ‚ Ğ²Ñ–Ğ´ Ñ†Ğ¸ĞºĞ»Ñ–Ñ‡Ğ½Ğ¾ÑÑ‚Ñ– (ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ Ğ½Ğµ Ğ¼Ğ¾Ğ¶Ğµ Ğ±ÑƒÑ‚Ğ¸ Ğ±Ğ°Ñ‚ÑŒĞºĞ¾Ğ¼ ÑĞ°Ğ¼Ğ° ÑĞ¾Ğ±Ñ–)
    if category_data.parent_id == category_id:
         raise HTTPException(status_code=400, detail="Category cannot be its own parent")
         
    db_category.parent_id = category_data.parent_id

    db.commit()
    db.refresh(db_category)
    return db_category

# !!! ĞĞĞ’Ğ•: Ğ’Ğ¸Ğ´Ğ°Ğ»ĞµĞ½Ğ½Ñ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ— !!!
@router.delete("/{category_id}")
def delete_category(category_id: int, db: Session = Depends(database.get_db)):
    db_category = db.query(models.Category).filter(models.Category.id == category_id).first()
    if not db_category:
        raise HTTPException(status_code=404, detail="Category not found")
    
    db.delete(db_category)
    db.commit()
    return {"status": "deleted"}

--------------------------------------------------
PATH: ./.history/product_service/services/product_service_20260123212342.py
--------------------------------------------------
# FILE: product_service/services/product_service.py

from sqlalchemy.orm import Session
from fastapi import HTTPException
import models, schemas

class ProductService:
    """
    ĞšĞ»Ğ°Ñ Ğ´Ğ»Ñ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»Ñ–Ğ½Ğ½Ñ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°Ğ¼Ğ¸.
    Ğ”Ğ¾Ğ¿Ğ¾Ğ¼Ğ°Ğ³Ğ°Ñ” Ñ€Ğ¾Ğ·Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶Ğ¸Ñ‚Ğ¸ Ñ€Ğ¾ÑƒÑ‚ĞµÑ€ Ğ²Ñ–Ğ´ ÑĞºĞ»Ğ°Ğ´Ğ½Ğ¸Ñ… Ğ²ĞºĞ»Ğ°Ğ´ĞµĞ½Ğ¸Ñ… Ñ†Ğ¸ĞºĞ»Ñ–Ğ².
    """

    @staticmethod
    def create_product(db: Session, product: schemas.ProductCreate):
        # 1. Ğ¡Ñ‚Ğ²Ğ¾Ñ€ÑÑ”Ğ¼Ğ¾ Ğ±Ğ°Ğ·Ğ¾Ğ²Ğ¸Ğ¹ Ğ·Ğ°Ğ¿Ğ¸Ñ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ
        db_product = models.Product(
            name=product.name, 
            price=product.price, 
            description=product.description,
            category_id=product.category_id, 
            has_variants=product.has_variants,
            master_recipe_id=product.master_recipe_id, 
            output_weight=product.output_weight,
            # Ğ”Ğ¾Ğ´Ğ°Ñ”Ğ¼Ğ¾ Ğ¿Ñ–Ğ´Ñ‚Ñ€Ğ¸Ğ¼ĞºÑƒ Ğ·Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ½Ñ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ–Ğ² Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾Ğ³Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ
            track_stock=product.track_stock,
            stock_quantity=product.stock_quantity
        )
        db.add(db_product)
        db.commit()
        db.refresh(db_product) # Ğ©Ğ¾Ğ± Ğ¾Ñ‚Ñ€Ğ¸Ğ¼Ğ°Ñ‚Ğ¸ ID Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ

        # 2. ĞŸÑ€Ğ¸Ğ²'ÑĞ·ÑƒÑ”Ğ¼Ğ¾ Ğ²Ğ¸Ñ‚Ñ€Ğ°Ñ‚Ğ½Ñ– Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸ (Ñ€Ñ–Ğ²ĞµĞ½ÑŒ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ)
        for cons in product.consumables:
            db.add(models.ProductConsumable(
                product_id=db_product.id, 
                consumable_id=cons.consumable_id, 
                quantity=cons.quantity
            ))

        # 3. Ğ¯ĞºÑ‰Ğ¾ Ñ” Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸, ÑÑ‚Ğ²Ğ¾Ñ€ÑÑ”Ğ¼Ğ¾ Ñ—Ñ… Ñ– Ñ—Ñ…Ğ½Ñ– Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸
        if product.has_variants and product.variants:
            for v in product.variants:
                db_variant = models.ProductVariant(
                    product_id=db_product.id, 
                    name=v.name, 
                    price=v.price, 
                    sku=v.sku,
                    master_recipe_id=v.master_recipe_id, 
                    output_weight=v.output_weight,
                    # --- Ğ’Ğ˜ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ: Ğ”Ğ¾Ğ´Ğ°Ğ½Ğ¾ Ğ·Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ½Ñ Ğ·Ğ°Ğ»Ğ¸ÑˆĞºÑƒ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ ---
                    stock_quantity=v.stock_quantity 
                )
                db.add(db_variant)
                db.flush() # flush Ğ¿Ğ¾Ñ‚Ñ€Ñ–Ğ±ĞµĞ½, Ñ‰Ğ¾Ğ± Ğ¾Ñ‚Ñ€Ğ¸Ğ¼Ğ°Ñ‚Ğ¸ ID Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ Ğ´Ğ¾ commit
                
                # ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ
                for vc in v.consumables:
                    db.add(models.ProductVariantConsumable(
                        variant_id=db_variant.id, 
                        consumable_id=vc.consumable_id, 
                        quantity=vc.quantity
                    ))
                
                # !!! ĞĞĞ’Ğ•: Ğ†Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ğ¸ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ !!!
                for vi in v.ingredients:
                    db.add(models.ProductVariantIngredient(variant_id=db_variant.id, ingredient_id=vi.ingredient_id, quantity=vi.quantity))
                

        # 4. ĞœĞ¾Ğ´Ğ¸Ñ„Ñ–ĞºĞ°Ñ‚Ğ¾Ñ€Ğ¸ (Ğ³Ñ€ÑƒĞ¿Ğ¸ Ñ‚Ğ° ÑĞ°Ğ¼Ñ– Ğ¼Ğ¾Ğ´Ğ¸Ñ„Ñ–ĞºĞ°Ñ‚Ğ¾Ñ€Ğ¸)
        for group in product.modifier_groups:
            db_group = models.ProductModifierGroup(
                product_id=db_product.id, 
                name=group.name, 
                is_required=group.is_required
            )
            db.add(db_group)
            db.flush()
            for mod in group.modifiers:
                db.add(models.Modifier(
                    group_id=db_group.id, 
                    name=mod.name, 
                    price_change=mod.price_change, 
                    ingredient_id=mod.ingredient_id, 
                    quantity=mod.quantity
                ))

        # 5. ĞŸÑ€Ğ¸Ğ²'ÑĞ·ĞºĞ° Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ–Ğ² (Many-to-Many)
        if product.process_group_ids:
            for pg_id in product.process_group_ids:
                pg = db.query(models.ProcessGroup).filter(models.ProcessGroup.id == pg_id).first()
                if pg:
                    db_product.process_groups.append(pg)

        db.commit()
        db.refresh(db_product)
        return db_product
    
    @staticmethod
    def update_product(db: Session, product_id: int, product_data: schemas.ProductCreate):
        # ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ñ–ÑĞ½ÑƒÑÑ‡Ğ¸Ğ¹ Ñ‚Ğ¾Ğ²Ğ°Ñ€
        db_product = db.query(models.Product).filter(models.Product.id == product_id).first()
        if not db_product:
            return None # ĞĞ±Ğ¾ Ğ¼Ğ¾Ğ¶Ğ½Ğ° ĞºĞ¸Ğ´Ğ°Ñ‚Ğ¸ Ğ¿Ğ¾Ğ¼Ğ¸Ğ»ĞºÑƒ Ñ‚ÑƒÑ‚

        # ĞĞ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ¿Ñ€Ğ¾ÑÑ‚Ñ– Ğ¿Ğ¾Ğ»Ñ
        db_product.name = product_data.name
        db_product.description = product_data.description
        db_product.price = product_data.price
        db_product.category_id = product_data.category_id
        db_product.has_variants = product_data.has_variants
        db_product.master_recipe_id = product_data.master_recipe_id
        db_product.output_weight = product_data.output_weight
        
        # ĞĞ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ½Ğ°Ğ»Ğ°ÑˆÑ‚ÑƒĞ²Ğ°Ğ½Ğ½Ñ ÑĞºĞ»Ğ°Ğ´Ñƒ Ğ´Ğ»Ñ Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ½Ğ¾Ğ³Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ
        db_product.track_stock = product_data.track_stock
        db_product.stock_quantity = product_data.stock_quantity

        # ĞĞ§Ğ˜Ğ©Ğ•ĞĞĞ¯ ÑÑ‚Ğ°Ñ€Ğ¸Ñ… Ğ·Ğ²'ÑĞ·ĞºÑ–Ğ² (Ğ½Ğ°Ğ¹Ğ¿Ñ€Ğ¾ÑÑ‚Ñ–ÑˆĞ¸Ğ¹ ÑĞ¿Ğ¾ÑÑ–Ğ± Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ - Ğ²Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğ¸ ÑÑ‚Ğ°Ñ€Ğµ Ñ– ÑÑ‚Ğ²Ğ¾Ñ€Ğ¸Ñ‚Ğ¸ Ğ½Ğ¾Ğ²Ğµ)
        # SQLAlchemy Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡Ğ½Ğ¾ Ğ²Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ´Ğ¾Ñ‡Ñ–Ñ€Ğ½Ñ– Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ·Ğ°Ğ²Ğ´ÑĞºĞ¸ cascade="all, delete-orphan" Ğ² Ğ¼Ğ¾Ğ´ĞµĞ»ÑÑ…
        db_product.variants = []
        db_product.modifier_groups = []
        db_product.consumables = []
        
        # ĞĞ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ–Ğ²
        db_product.process_groups = [] 
        if product_data.process_group_ids:
            for pg_id in product_data.process_group_ids:
                pg = db.query(models.ProcessGroup).filter(models.ProcessGroup.id == pg_id).first()
                if pg:
                    db_product.process_groups.append(pg)

        db.flush() # Ğ—Ğ°ÑÑ‚Ğ¾ÑÑƒĞ²Ğ°Ñ‚Ğ¸ Ğ²Ğ¸Ğ´Ğ°Ğ»ĞµĞ½Ğ½Ñ

        # Ğ”ĞĞ›Ğ† ĞšĞĞ” Ğ†Ğ”Ğ•ĞĞ¢Ğ˜Ğ§ĞĞ˜Ğ™ Ğ¡Ğ¢Ğ’ĞĞ Ğ•ĞĞĞ® (Ğ¿ÑƒĞ½ĞºÑ‚Ğ¸ 2, 3, 4 Ğ·Ğ²ĞµÑ€Ñ…Ñƒ)
        # 2. Consumables
        for cons in product_data.consumables:
            db.add(models.ProductConsumable(product_id=db_product.id, consumable_id=cons.consumable_id, quantity=cons.quantity))

        # 3. Variants
        if product_data.has_variants and product_data.variants:
            for v in product_data.variants:
                db_variant = models.ProductVariant(
                    product_id=db_product.id, 
                    name=v.name, 
                    price=v.price, 
                    sku=v.sku,
                    master_recipe_id=v.master_recipe_id, 
                    output_weight=v.output_weight,
                    # --- Ğ’Ğ˜ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ: Ğ”Ğ¾Ğ´Ğ°Ğ½Ğ¾ Ğ·Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ½Ñ Ğ·Ğ°Ğ»Ğ¸ÑˆĞºÑƒ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ ---
                    stock_quantity=v.stock_quantity
                )
                db.add(db_variant); db.flush()
                for vc in v.consumables:
                    db.add(models.ProductVariantConsumable(variant_id=db_variant.id, consumable_id=vc.consumable_id, quantity=vc.quantity))
                # !!! ĞĞĞ’Ğ•: Ğ†Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ğ¸ !!!
                    for vi in v.ingredients:
                        db.add(models.ProductVariantIngredient(variant_id=db_variant.id, ingredient_id=vi.ingredient_id, quantity=vi.quantity))   
        # 4. Modifiers
        for group in product_data.modifier_groups:
            db_group = models.ProductModifierGroup(product_id=db_product.id, name=group.name, is_required=group.is_required)
            db.add(db_group); db.flush()
            for mod in group.modifiers:
                db.add(models.Modifier(group_id=db_group.id, name=mod.name, price_change=mod.price_change, ingredient_id=mod.ingredient_id, quantity=mod.quantity))

        db.commit()
        db.refresh(db_product)
        return db_product

--------------------------------------------------
PATH: ./.history/product_service/services/inventory_logger_20260123212315.py
--------------------------------------------------
from sqlalchemy.orm import Session
import models

class InventoryLogger:
    @staticmethod
    def log(db: Session, entity_type: str, entity_id: int, entity_name: str, old_balance: float, new_balance: float, reason: str = "manual_update"):
        """
        Ğ£Ğ½Ñ–Ğ²ĞµÑ€ÑĞ°Ğ»ÑŒĞ½Ğ° Ñ„ÑƒĞ½ĞºÑ†Ñ–Ñ Ğ·Ğ°Ğ¿Ğ¸ÑÑƒ Ñ–ÑÑ‚Ğ¾Ñ€Ñ–Ñ—.
        change Ğ¾Ğ±Ñ‡Ğ¸ÑĞ»ÑÑ”Ñ‚ÑŒÑÑ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡Ğ½Ğ¾.
        """
        change = new_balance - old_balance
        
        # Ğ¯ĞºÑ‰Ğ¾ Ğ·Ğ¼Ñ–Ğ½ Ğ½ĞµĞ¼Ğ°Ñ” (Ğ½Ğ°Ğ¿Ñ€Ğ¸ĞºĞ»Ğ°Ğ´, Ğ·Ğ±ĞµÑ€ĞµĞ³Ğ»Ğ¸ Ñ‚Ğµ ÑĞ°Ğ¼Ğµ Ñ‡Ğ¸ÑĞ»Ğ¾), Ğ½Ğµ Ğ¿Ğ¸ÑˆĞµĞ¼Ğ¾
        if change == 0:
            return

        transaction = models.InventoryTransaction(
            entity_type=entity_type,
            entity_id=entity_id,
            entity_name=entity_name,
            change_amount=change,
            balance_after=new_balance,
            reason=reason
        )
        db.add(transaction)
        # db.commit() Ğ¼Ğ¸ Ñ‚ÑƒÑ‚ Ğ½Ğµ Ñ€Ğ¾Ğ±Ğ¸Ğ¼Ğ¾, Ğ±Ğ¾ Ñ†ĞµĞ¹ Ğ¼ĞµÑ‚Ğ¾Ğ´ Ğ·Ğ°Ğ·Ğ²Ğ¸Ñ‡Ğ°Ğ¹ Ğ²Ğ¸ĞºĞ»Ğ¸ĞºĞ°Ñ”Ñ‚ÑŒÑÑ Ğ²ÑĞµÑ€ĞµĞ´Ğ¸Ğ½Ñ– Ñ–Ğ½ÑˆĞ¾Ñ— Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ñ–Ñ—

--------------------------------------------------
PATH: ./.history/product_service/services/product_service_20260120122235.py
--------------------------------------------------
# FILE: product_service/services/product_service.py

from sqlalchemy.orm import Session
from fastapi import HTTPException
import models, schemas

class ProductService:
    """
    ĞšĞ»Ğ°Ñ Ğ´Ğ»Ñ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»Ñ–Ğ½Ğ½Ñ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°Ğ¼Ğ¸.
    Ğ”Ğ¾Ğ¿Ğ¾Ğ¼Ğ°Ğ³Ğ°Ñ” Ñ€Ğ¾Ğ·Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶Ğ¸Ñ‚Ğ¸ Ñ€Ğ¾ÑƒÑ‚ĞµÑ€ Ğ²Ñ–Ğ´ ÑĞºĞ»Ğ°Ğ´Ğ½Ğ¸Ñ… Ğ²ĞºĞ»Ğ°Ğ´ĞµĞ½Ğ¸Ñ… Ñ†Ğ¸ĞºĞ»Ñ–Ğ².
    """

    @staticmethod
    def create_product(db: Session, product: schemas.ProductCreate):
        # 1. Ğ¡Ñ‚Ğ²Ğ¾Ñ€ÑÑ”Ğ¼Ğ¾ Ğ±Ğ°Ğ·Ğ¾Ğ²Ğ¸Ğ¹ Ğ·Ğ°Ğ¿Ğ¸Ñ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ
        db_product = models.Product(
            name=product.name, 
            price=product.price, 
            description=product.description,
            category_id=product.category_id, 
            has_variants=product.has_variants,
            master_recipe_id=product.master_recipe_id, 
            output_weight=product.output_weight,
            # Ğ”Ğ¾Ğ´Ğ°Ñ”Ğ¼Ğ¾ Ğ¿Ñ–Ğ´Ñ‚Ñ€Ğ¸Ğ¼ĞºÑƒ Ğ·Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ½Ñ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ–Ğ² Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾Ğ³Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ
            track_stock=product.track_stock,
            stock_quantity=product.stock_quantity
        )
        db.add(db_product)
        db.commit()
        db.refresh(db_product) # Ğ©Ğ¾Ğ± Ğ¾Ñ‚Ñ€Ğ¸Ğ¼Ğ°Ñ‚Ğ¸ ID Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ

        # 2. ĞŸÑ€Ğ¸Ğ²'ÑĞ·ÑƒÑ”Ğ¼Ğ¾ Ğ²Ğ¸Ñ‚Ñ€Ğ°Ñ‚Ğ½Ñ– Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸ (Ñ€Ñ–Ğ²ĞµĞ½ÑŒ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ)
        for cons in product.consumables:
            db.add(models.ProductConsumable(
                product_id=db_product.id, 
                consumable_id=cons.consumable_id, 
                quantity=cons.quantity
            ))

        # 3. Ğ¯ĞºÑ‰Ğ¾ Ñ” Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸, ÑÑ‚Ğ²Ğ¾Ñ€ÑÑ”Ğ¼Ğ¾ Ñ—Ñ… Ñ– Ñ—Ñ…Ğ½Ñ– Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸
        if product.has_variants and product.variants:
            for v in product.variants:
                db_variant = models.ProductVariant(
                    product_id=db_product.id, 
                    name=v.name, 
                    price=v.price, 
                    sku=v.sku,
                    master_recipe_id=v.master_recipe_id, 
                    output_weight=v.output_weight,
                    # --- Ğ’Ğ˜ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ: Ğ”Ğ¾Ğ´Ğ°Ğ½Ğ¾ Ğ·Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ½Ñ Ğ·Ğ°Ğ»Ğ¸ÑˆĞºÑƒ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ ---
                    stock_quantity=v.stock_quantity 
                )
                db.add(db_variant)
                db.flush() # flush Ğ¿Ğ¾Ñ‚Ñ€Ñ–Ğ±ĞµĞ½, Ñ‰Ğ¾Ğ± Ğ¾Ñ‚Ñ€Ğ¸Ğ¼Ğ°Ñ‚Ğ¸ ID Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ Ğ´Ğ¾ commit
                
                # ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ
                for vc in v.consumables:
                    db.add(models.ProductVariantConsumable(
                        variant_id=db_variant.id, 
                        consumable_id=vc.consumable_id, 
                        quantity=vc.quantity
                    ))
                
                # !!! ĞĞĞ’Ğ•: Ğ†Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ğ¸ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ !!!
                for vi in v.ingredients:
                    db.add(models.ProductVariantIngredient(variant_id=db_variant.id, ingredient_id=vi.ingredient_id, quantity=vi.quantity))
                

        # 4. ĞœĞ¾Ğ´Ğ¸Ñ„Ñ–ĞºĞ°Ñ‚Ğ¾Ñ€Ğ¸ (Ğ³Ñ€ÑƒĞ¿Ğ¸ Ñ‚Ğ° ÑĞ°Ğ¼Ñ– Ğ¼Ğ¾Ğ´Ğ¸Ñ„Ñ–ĞºĞ°Ñ‚Ğ¾Ñ€Ğ¸)
        for group in product.modifier_groups:
            db_group = models.ProductModifierGroup(
                product_id=db_product.id, 
                name=group.name, 
                is_required=group.is_required
            )
            db.add(db_group)
            db.flush()
            for mod in group.modifiers:
                db.add(models.Modifier(
                    group_id=db_group.id, 
                    name=mod.name, 
                    price_change=mod.price_change, 
                    ingredient_id=mod.ingredient_id, 
                    quantity=mod.quantity
                ))

        # 5. ĞŸÑ€Ğ¸Ğ²'ÑĞ·ĞºĞ° Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ–Ğ² (Many-to-Many)
        if product.process_group_ids:
            for pg_id in product.process_group_ids:
                pg = db.query(models.ProcessGroup).filter(models.ProcessGroup.id == pg_id).first()
                if pg:
                    db_product.process_groups.append(pg)

        db.commit()
        db.refresh(db_product)
        return db_product
    
    @staticmethod
    def update_product(db: Session, product_id: int, product_data: schemas.ProductCreate):
        # ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ñ–ÑĞ½ÑƒÑÑ‡Ğ¸Ğ¹ Ñ‚Ğ¾Ğ²Ğ°Ñ€
        db_product = db.query(models.Product).filter(models.Product.id == product_id).first()
        if not db_product:
            return None # ĞĞ±Ğ¾ Ğ¼Ğ¾Ğ¶Ğ½Ğ° ĞºĞ¸Ğ´Ğ°Ñ‚Ğ¸ Ğ¿Ğ¾Ğ¼Ğ¸Ğ»ĞºÑƒ Ñ‚ÑƒÑ‚

        # ĞĞ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ¿Ñ€Ğ¾ÑÑ‚Ñ– Ğ¿Ğ¾Ğ»Ñ
        db_product.name = product_data.name
        db_product.description = product_data.description
        db_product.price = product_data.price
        db_product.category_id = product_data.category_id
        db_product.has_variants = product_data.has_variants
        db_product.master_recipe_id = product_data.master_recipe_id
        db_product.output_weight = product_data.output_weight
        
        # ĞĞ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ½Ğ°Ğ»Ğ°ÑˆÑ‚ÑƒĞ²Ğ°Ğ½Ğ½Ñ ÑĞºĞ»Ğ°Ğ´Ñƒ Ğ´Ğ»Ñ Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ½Ğ¾Ğ³Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ
        db_product.track_stock = product_data.track_stock
        db_product.stock_quantity = product_data.stock_quantity

        # ĞĞ§Ğ˜Ğ©Ğ•ĞĞĞ¯ ÑÑ‚Ğ°Ñ€Ğ¸Ñ… Ğ·Ğ²'ÑĞ·ĞºÑ–Ğ² (Ğ½Ğ°Ğ¹Ğ¿Ñ€Ğ¾ÑÑ‚Ñ–ÑˆĞ¸Ğ¹ ÑĞ¿Ğ¾ÑÑ–Ğ± Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ - Ğ²Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğ¸ ÑÑ‚Ğ°Ñ€Ğµ Ñ– ÑÑ‚Ğ²Ğ¾Ñ€Ğ¸Ñ‚Ğ¸ Ğ½Ğ¾Ğ²Ğµ)
        # SQLAlchemy Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡Ğ½Ğ¾ Ğ²Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ´Ğ¾Ñ‡Ñ–Ñ€Ğ½Ñ– Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ·Ğ°Ğ²Ğ´ÑĞºĞ¸ cascade="all, delete-orphan" Ğ² Ğ¼Ğ¾Ğ´ĞµĞ»ÑÑ…
        db_product.variants = []
        db_product.modifier_groups = []
        db_product.consumables = []
        
        # ĞĞ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ–Ğ²
        db_product.process_groups = [] 
        if product_data.process_group_ids:
            for pg_id in product_data.process_group_ids:
                pg = db.query(models.ProcessGroup).filter(models.ProcessGroup.id == pg_id).first()
                if pg:
                    db_product.process_groups.append(pg)

        db.flush() # Ğ—Ğ°ÑÑ‚Ğ¾ÑÑƒĞ²Ğ°Ñ‚Ğ¸ Ğ²Ğ¸Ğ´Ğ°Ğ»ĞµĞ½Ğ½Ñ

        # Ğ”ĞĞ›Ğ† ĞšĞĞ” Ğ†Ğ”Ğ•ĞĞ¢Ğ˜Ğ§ĞĞ˜Ğ™ Ğ¡Ğ¢Ğ’ĞĞ Ğ•ĞĞĞ® (Ğ¿ÑƒĞ½ĞºÑ‚Ğ¸ 2, 3, 4 Ğ·Ğ²ĞµÑ€Ñ…Ñƒ)
        # 2. Consumables
        for cons in product_data.consumables:
            db.add(models.ProductConsumable(product_id=db_product.id, consumable_id=cons.consumable_id, quantity=cons.quantity))

        # 3. Variants
        if product_data.has_variants and product_data.variants:
            for v in product_data.variants:
                db_variant = models.ProductVariant(
                    product_id=db_product.id, 
                    name=v.name, 
                    price=v.price, 
                    sku=v.sku,
                    master_recipe_id=v.master_recipe_id, 
                    output_weight=v.output_weight,
                    # --- Ğ’Ğ˜ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ: Ğ”Ğ¾Ğ´Ğ°Ğ½Ğ¾ Ğ·Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ½Ñ Ğ·Ğ°Ğ»Ğ¸ÑˆĞºÑƒ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ ---
                    stock_quantity=v.stock_quantity
                )
                db.add(db_variant); db.flush()
                for vc in v.consumables:
                    db.add(models.ProductVariantConsumable(variant_id=db_variant.id, consumable_id=vc.consumable_id, quantity=vc.quantity))
                # !!! ĞĞĞ’Ğ•: Ğ†Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ğ¸ !!!
                    for vi in v.ingredients:
                        db.add(models.ProductVariantIngredient(variant_id=db_variant.id, ingredient_id=vi.ingredient_id, quantity=vi.quantity))   
        # 4. Modifiers
        for group in product_data.modifier_groups:
            db_group = models.ProductModifierGroup(product_id=db_product.id, name=group.name, is_required=group.is_required)
            db.add(db_group); db.flush()
            for mod in group.modifiers:
                db.add(models.Modifier(group_id=db_group.id, name=mod.name, price_change=mod.price_change, ingredient_id=mod.ingredient_id, quantity=mod.quantity))

        db.commit()
        db.refresh(db_product)
        return db_product

--------------------------------------------------
PATH: ./.history/product_service/services/product_service_20260125182057.py
--------------------------------------------------
from sqlalchemy.orm import Session
from fastapi import HTTPException
import models
import schemas
import uuid

class ProductService:
    """
    ĞšĞ»Ğ°Ñ Ğ´Ğ»Ñ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»Ñ–Ğ½Ğ½Ñ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°Ğ¼Ğ¸.
    Ğ¢ÑƒÑ‚ Ğ·Ğ½Ğ°Ñ…Ğ¾Ğ´Ğ¸Ñ‚ÑŒÑÑ Ğ²ÑÑ Ğ±Ñ–Ğ·Ğ½ĞµÑ-Ğ»Ğ¾Ğ³Ñ–ĞºĞ° ÑÑ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ½Ñ (Create) 
    Ñ‚Ğ° Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ (Update).
    """

    @staticmethod
    def create_product(db: Session, product: schemas.ProductCreate):
        # ---------------------------------------------------------
        # 1. Ğ¡Ğ¢Ğ’ĞĞ Ğ•ĞĞĞ¯ Ğ‘ĞĞ—ĞĞ’ĞĞ“Ğ Ğ¢ĞĞ’ĞĞ Ğ£
        # ---------------------------------------------------------
        db_product = models.Product(
            name=product.name, 
            price=product.price, 
            description=product.description,
            category_id=product.category_id, 
            has_variants=product.has_variants,
            master_recipe_id=product.master_recipe_id, 
            output_weight=product.output_weight,
            track_stock=product.track_stock,
            stock_quantity=product.stock_quantity
        )
        db.add(db_product)
        db.commit()
        db.refresh(db_product) # ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ ID Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ

        # ---------------------------------------------------------
        # 2. Ğ”ĞĞ”ĞĞ’ĞĞĞĞ¯ Ğ’Ğ˜Ğ¢Ğ ĞĞ¢ĞĞ˜Ğ¥ ĞœĞĞ¢Ğ•Ğ Ğ†ĞĞ›Ğ†Ğ’ (Ğ—ĞĞ“ĞĞ›Ğ¬ĞĞ†)
        # ---------------------------------------------------------
        for cons in product.consumables:
            db.add(models.ProductConsumable(
                product_id=db_product.id, 
                consumable_id=cons.consumable_id, 
                quantity=cons.quantity
            ))

        # ---------------------------------------------------------
        # 3. Ğ¡Ğ¢Ğ’ĞĞ Ğ•ĞĞĞ¯ Ğ’ĞĞ Ğ†ĞĞĞ¢Ğ†Ğ’ (Ğ¯ĞšĞ©Ğ Ğ„)
        # ---------------------------------------------------------
        if product.has_variants and product.variants:
            for v in product.variants:
                # Ğ“ĞµĞ½ĞµÑ€ÑƒÑ”Ğ¼Ğ¾ ÑƒĞ½Ñ–ĞºĞ°Ğ»ÑŒĞ½Ğ¸Ğ¹ ĞºĞ¾Ğ´ (SKU), ÑĞºÑ‰Ğ¾ Ğ¹Ğ¾Ğ³Ğ¾ Ğ½ĞµĞ¼Ğ°Ñ”
                sku = v.sku if v.sku else str(uuid.uuid4())
                
                db_variant = models.ProductVariant(
                    product_id=db_product.id, 
                    name=v.name, 
                    price=v.price, 
                    sku=sku,
                    master_recipe_id=v.master_recipe_id, 
                    output_weight=v.output_weight,
                    stock_quantity=v.stock_quantity 
                )
                db.add(db_variant)
                db.flush() # Ğ—Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ñ”Ğ¼Ğ¾, Ñ‰Ğ¾Ğ± Ğ¾Ñ‚Ñ€Ğ¸Ğ¼Ğ°Ñ‚Ğ¸ ID Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ
                
                # ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ
                for vc in v.consumables:
                    db.add(models.ProductVariantConsumable(
                        variant_id=db_variant.id, 
                        consumable_id=vc.consumable_id, 
                        quantity=vc.quantity
                    ))
                
                # Ğ†Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ğ¸ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ
                for vi in v.ingredients:
                    db.add(models.ProductVariantIngredient(
                        variant_id=db_variant.id, 
                        ingredient_id=vi.ingredient_id, 
                        quantity=vi.quantity
                    ))

        # ---------------------------------------------------------
        # 4. Ğ”ĞĞ”ĞĞ’ĞĞĞĞ¯ ĞœĞĞ”Ğ˜Ğ¤Ğ†ĞšĞĞ¢ĞĞ Ğ†Ğ’
        # ---------------------------------------------------------
        for group in product.modifier_groups:
            db_group = models.ProductModifierGroup(
                product_id=db_product.id, 
                name=group.name, 
                is_required=group.is_required
            )
            db.add(db_group)
            db.flush()
            
            for mod in group.modifiers:
                db.add(models.Modifier(
                    group_id=db_group.id, 
                    name=mod.name, 
                    price_change=mod.price_change, 
                    ingredient_id=mod.ingredient_id, 
                    quantity=mod.quantity
                ))

        # ---------------------------------------------------------
        # 5. ĞŸĞ Ğ˜Ğ’'Ğ¯Ğ—ĞšĞ Ğ”Ğ Ğ“Ğ Ğ£ĞŸ ĞŸĞ ĞĞ¦Ğ•Ğ¡Ğ†Ğ’ (Kyiv, Lviv Ñ‚Ğ¾Ñ‰Ğ¾)
        # ---------------------------------------------------------
        if product.process_group_ids:
            for pg_id in product.process_group_ids:
                pg = db.query(models.ProcessGroup).filter(
                    models.ProcessGroup.id == pg_id
                ).first()
                if pg:
                    db_product.process_groups.append(pg)

        db.commit()
        db.refresh(db_product)
        return db_product
    
    @staticmethod
    def update_product(
        db: Session, 
        product_id: int, 
        product_data: schemas.ProductCreate
    ):
        # Ğ—Ğ½Ğ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€ Ğ² Ğ±Ğ°Ğ·Ñ–
        db_product = db.query(models.Product).filter(
            models.Product.id == product_id
        ).first()
        
        if not db_product:
            return None

        # ---------------------------------------------------------
        # 1. ĞĞĞĞ’Ğ›Ğ•ĞĞĞ¯ ĞŸĞ ĞĞ¡Ğ¢Ğ˜Ğ¥ ĞŸĞĞ›Ğ†Ğ’
        # ---------------------------------------------------------
        db_product.name = product_data.name
        db_product.description = product_data.description
        db_product.price = product_data.price
        db_product.category_id = product_data.category_id
        db_product.has_variants = product_data.has_variants
        db_product.master_recipe_id = product_data.master_recipe_id
        db_product.output_weight = product_data.output_weight
        
        # Ğ›Ğ¾Ğ³Ñ–ĞºĞ° Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ ÑĞºĞ»Ğ°Ğ´Ñƒ (Ğ´Ğ¾Ğ·Ğ²Ğ¾Ğ»ÑÑ”Ğ¼Ğ¾ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚Ğ¸, ÑĞºÑ‰Ğ¾ Ñ‚Ñ€ĞµĞºÑ–Ğ½Ğ³ Ğ²Ğ¸Ğ¼ĞºĞ½ĞµĞ½Ğ¾)
        db_product.track_stock = product_data.track_stock
        if not product_data.track_stock:
             db_product.stock_quantity = product_data.stock_quantity

        # ---------------------------------------------------------
        # 2. ĞĞĞĞ’Ğ›Ğ•ĞĞĞ¯ ĞœĞĞ¢Ğ•Ğ Ğ†ĞĞ›Ğ†Ğ’ (CONSUMABLES)
        # Ğ¡Ñ‚Ñ€Ğ°Ñ‚ĞµĞ³Ñ–Ñ: Ğ’Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğ¸ Ğ²ÑÑ– ÑÑ‚Ğ°Ñ€Ñ– -> Ğ—Ğ°Ğ¿Ğ¸ÑĞ°Ñ‚Ğ¸ Ğ½Ğ¾Ğ²Ñ–
        # ---------------------------------------------------------
        db.query(models.ProductConsumable).filter(
            models.ProductConsumable.product_id == product_id
        ).delete()
        
        for cons in product_data.consumables:
            db.add(models.ProductConsumable(
                product_id=product_id, 
                consumable_id=cons.consumable_id, 
                quantity=cons.quantity
            ))

        # ---------------------------------------------------------
        # 3. ĞĞĞĞ’Ğ›Ğ•ĞĞĞ¯ Ğ’ĞĞ Ğ†ĞĞĞ¢Ğ†Ğ’ (Ğ¡ĞšĞ›ĞĞ”ĞĞ Ğ›ĞĞ“Ğ†ĞšĞ)
        # ---------------------------------------------------------
        if product_data.has_variants and product_data.variants:
            
            # [A] Ğ’Ğ˜Ğ”ĞĞ›Ğ•ĞĞĞ¯: Ğ—Ğ½Ğ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸, ÑĞºĞ¸Ñ… Ğ±Ñ–Ğ»ÑŒÑˆĞµ Ğ½ĞµĞ¼Ğ°Ñ” Ğ² ÑĞ¿Ğ¸ÑĞºÑƒ
            incoming_names = [v.name for v in product_data.variants]
            
            db.query(models.ProductVariant).filter(
               models.ProductVariant.product_id == product_id,
               # Ğ’Ğ¸Ğ´Ğ°Ğ»ÑÑ”Ğ¼Ğ¾ Ñ‚Ñ–, Ñ‡Ğ¸Ñ—Ñ… Ñ–Ğ¼ĞµĞ½ Ğ½ĞµĞ¼Ğ°Ñ” Ñƒ Ğ½Ğ¾Ğ²Ğ¾Ğ¼Ñƒ ÑĞ¿Ğ¸ÑĞºÑƒ
               models.ProductVariant.name.notin_(incoming_names)
            ).delete(synchronize_session=False)

            # [B] ĞĞĞĞ’Ğ›Ğ•ĞĞĞ¯ Ğ°Ğ±Ğ¾ Ğ¡Ğ¢Ğ’ĞĞ Ğ•ĞĞĞ¯: ĞŸÑ€Ğ¾Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ÑÑŒ Ğ¿Ğ¾ ÑĞ¿Ğ¸ÑĞºÑƒ
            for v in product_data.variants:
                # Ğ¨ÑƒĞºĞ°Ñ”Ğ¼Ğ¾, Ñ‡Ğ¸ Ñ–ÑĞ½ÑƒÑ” Ğ²Ğ¶Ğµ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚ Ğ· Ñ‚Ğ°ĞºĞ¸Ğ¼ Ñ–Ğ¼'ÑĞ¼
                db_variant = db.query(models.ProductVariant).filter(
                    models.ProductVariant.product_id == product_id,
                    models.ProductVariant.name == v.name
                ).first()

                if db_variant:
                    # Ğ¯ĞºÑ‰Ğ¾ Ñ” -> ĞĞ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ¿Ğ¾Ğ»Ñ
                    db_variant.price = v.price
                    db_variant.master_recipe_id = v.master_recipe_id
                    db_variant.output_weight = v.output_weight
                    db_variant.stock_quantity = v.stock_quantity
                else:
                    # Ğ¯ĞºÑ‰Ğ¾ Ğ½ĞµĞ¼Ğ°Ñ” -> Ğ¡Ñ‚Ğ²Ğ¾Ñ€ÑÑ”Ğ¼Ğ¾ Ğ½Ğ¾Ğ²Ğ¸Ğ¹
                    sku = v.sku if v.sku else str(uuid.uuid4())
                    db_variant = models.ProductVariant(
                        product_id=product_id,
                        name=v.name,
                        price=v.price,
                        sku=sku,
                        master_recipe_id=v.master_recipe_id,
                        output_weight=v.output_weight,
                        stock_quantity=v.stock_quantity
                    )
                    db.add(db_variant)
                
                db.flush() # ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ ID (Ğ´Ğ»Ñ Ğ½Ğ¾Ğ²Ğ¸Ñ… Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñ–Ğ²)

                # [C] Ğ—ĞĞŸĞĞ‘Ğ†Ğ“ĞĞĞĞ¯ Ğ”Ğ£Ğ‘Ğ›Ğ®Ğ’ĞĞĞĞ® (ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° Ğ´Ñ–Ñ‚ĞµĞ¹)
                # Ğ’Ğ¸Ğ´Ğ°Ğ»ÑÑ”Ğ¼Ğ¾ ÑÑ‚Ğ°Ñ€Ñ– Ñ–Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ğ¸ Ñ‚Ğ° Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸ Ñ†ÑŒĞ¾Ğ³Ğ¾ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ
                db.query(models.ProductVariantConsumable).filter(
                    models.ProductVariantConsumable.variant_id == db_variant.id
                ).delete()

                db.query(models.ProductVariantIngredient).filter(
                    models.ProductVariantIngredient.variant_id == db_variant.id
                ).delete()

                # [D] Ğ—ĞĞŸĞ˜Ğ¡ ĞĞĞ’Ğ˜Ğ¥ Ğ”Ğ†Ğ¢Ğ•Ğ™
                for vc in v.consumables:
                    db.add(models.ProductVariantConsumable(
                        variant_id=db_variant.id, 
                        consumable_id=vc.consumable_id, 
                        quantity=vc.quantity
                    ))
                
                for vi in v.ingredients:
                    db.add(models.ProductVariantIngredient(
                        variant_id=db_variant.id, 
                        ingredient_id=vi.ingredient_id, 
                        quantity=vi.quantity
                    ))
        else:
            # Ğ¯ĞºÑ‰Ğ¾ Ğ·Ğ½ÑĞ»Ğ¸ Ğ³Ğ°Ğ»Ğ¾Ñ‡ĞºÑƒ "ĞœĞ°Ñ” Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸" -> Ğ²Ğ¸Ğ´Ğ°Ğ»ÑÑ”Ğ¼Ğ¾ Ğ²ÑÑ– Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸
            db.query(models.ProductVariant).filter(
                models.ProductVariant.product_id == product_id
            ).delete()

        # ---------------------------------------------------------
        # 4. ĞĞĞĞ’Ğ›Ğ•ĞĞĞ¯ ĞœĞĞ”Ğ˜Ğ¤Ğ†ĞšĞĞ¢ĞĞ Ğ†Ğ’
        # Ğ¡Ñ‚Ñ€Ğ°Ñ‚ĞµĞ³Ñ–Ñ: Ğ’Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğ¸ Ğ²ÑÑ– Ğ³Ñ€ÑƒĞ¿Ğ¸ -> Ğ¡Ñ‚Ğ²Ğ¾Ñ€Ğ¸Ñ‚Ğ¸ Ğ·Ğ°Ğ½Ğ¾Ğ²Ğ¾
        # ---------------------------------------------------------
        db.query(models.ProductModifierGroup).filter(
            models.ProductModifierGroup.product_id == product_id
        ).delete()
        
        for group in product_data.modifier_groups:
            db_group = models.ProductModifierGroup(
                product_id=product_id, 
                name=group.name, 
                is_required=group.is_required
            )
            db.add(db_group)
            db.flush()
            
            for mod in group.modifiers:
                db.add(models.Modifier(
                    group_id=db_group.id, 
                    name=mod.name, 
                    price_change=mod.price_change, 
                    ingredient_id=mod.ingredient_id, 
                    quantity=mod.quantity
                ))

        # ---------------------------------------------------------
        # 5. ĞĞĞĞ’Ğ›Ğ•ĞĞĞ¯ Ğ“Ğ Ğ£ĞŸ ĞŸĞ ĞĞ¦Ğ•Ğ¡Ğ†Ğ’
        # ---------------------------------------------------------
        db_product.process_groups = [] # ĞÑ‡Ğ¸Ñ‰Ğ°Ñ”Ğ¼Ğ¾ ÑĞ¿Ğ¸ÑĞ¾Ğº
        if product_data.process_group_ids:
            for pg_id in product_data.process_group_ids:
                pg = db.query(models.ProcessGroup).filter(
                    models.ProcessGroup.id == pg_id
                ).first()
                if pg:
                    db_product.process_groups.append(pg)

        db.commit()
        db.refresh(db_product)
        return db_product

--------------------------------------------------
PATH: ./.history/product_service/services/product_service_20260125182053.py
--------------------------------------------------
from sqlalchemy.orm import Session
from fastapi import HTTPException
import models
import schemas
import uuid

class ProductService:
    """
    ĞšĞ»Ğ°Ñ Ğ´Ğ»Ñ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»Ñ–Ğ½Ğ½Ñ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°Ğ¼Ğ¸.
    Ğ¢ÑƒÑ‚ Ğ·Ğ½Ğ°Ñ…Ğ¾Ğ´Ğ¸Ñ‚ÑŒÑÑ Ğ²ÑÑ Ğ±Ñ–Ğ·Ğ½ĞµÑ-Ğ»Ğ¾Ğ³Ñ–ĞºĞ° ÑÑ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ½Ñ (Create) 
    Ñ‚Ğ° Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ (Update).
    """

    @staticmethod
    def create_product(db: Session, product: schemas.ProductCreate):
        # ---------------------------------------------------------
        # 1. Ğ¡Ğ¢Ğ’ĞĞ Ğ•ĞĞĞ¯ Ğ‘ĞĞ—ĞĞ’ĞĞ“Ğ Ğ¢ĞĞ’ĞĞ Ğ£
        # ---------------------------------------------------------
        db_product = models.Product(
            name=product.name, 
            price=product.price, 
            description=product.description,
            category_id=product.category_id, 
            has_variants=product.has_variants,
            master_recipe_id=product.master_recipe_id, 
            output_weight=product.output_weight,
            track_stock=product.track_stock,
            stock_quantity=product.stock_quantity
        )
        db.add(db_product)
        db.commit()
        db.refresh(db_product) # ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ ID Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ

        # ---------------------------------------------------------
        # 2. Ğ”ĞĞ”ĞĞ’ĞĞĞĞ¯ Ğ’Ğ˜Ğ¢Ğ ĞĞ¢ĞĞ˜Ğ¥ ĞœĞĞ¢Ğ•Ğ Ğ†ĞĞ›Ğ†Ğ’ (Ğ—ĞĞ“ĞĞ›Ğ¬ĞĞ†)
        # ---------------------------------------------------------
        for cons in product.consumables:
            db.add(models.ProductConsumable(
                product_id=db_product.id, 
                consumable_id=cons.consumable_id, 
                quantity=cons.quantity
            ))

        # ---------------------------------------------------------
        # 3. Ğ¡Ğ¢Ğ’ĞĞ Ğ•ĞĞĞ¯ Ğ’ĞĞ Ğ†ĞĞĞ¢Ğ†Ğ’ (Ğ¯ĞšĞ©Ğ Ğ„)
        # ---------------------------------------------------------
        if product.has_variants and product.variants:
            for v in product.variants:
                # Ğ“ĞµĞ½ĞµÑ€ÑƒÑ”Ğ¼Ğ¾ ÑƒĞ½Ñ–ĞºĞ°Ğ»ÑŒĞ½Ğ¸Ğ¹ ĞºĞ¾Ğ´ (SKU), ÑĞºÑ‰Ğ¾ Ğ¹Ğ¾Ğ³Ğ¾ Ğ½ĞµĞ¼Ğ°Ñ”
                sku = v.sku if v.sku else str(uuid.uuid4())
                
                db_variant = models.ProductVariant(
                    product_id=db_product.id, 
                    name=v.name, 
                    price=v.price, 
                    sku=sku,
                    master_recipe_id=v.master_recipe_id, 
                    output_weight=v.output_weight,
                    stock_quantity=v.stock_quantity 
                )
                db.add(db_variant)
                db.flush() # Ğ—Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ñ”Ğ¼Ğ¾, Ñ‰Ğ¾Ğ± Ğ¾Ñ‚Ñ€Ğ¸Ğ¼Ğ°Ñ‚Ğ¸ ID Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ
                
                # ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ
                for vc in v.consumables:
                    db.add(models.ProductVariantConsumable(
                        variant_id=db_variant.id, 
                        consumable_id=vc.consumable_id, 
                        quantity=vc.quantity
                    ))
                
                # Ğ†Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ğ¸ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ
                for vi in v.ingredients:
                    db.add(models.ProductVariantIngredient(
                        variant_id=db_variant.id, 
                        ingredient_id=vi.ingredient_id, 
                        quantity=vi.quantity
                    ))

        # ---------------------------------------------------------
        # 4. Ğ”ĞĞ”ĞĞ’ĞĞĞĞ¯ ĞœĞĞ”Ğ˜Ğ¤Ğ†ĞšĞĞ¢ĞĞ Ğ†Ğ’
        # ---------------------------------------------------------
        for group in product.modifier_groups:
            db_group = models.ProductModifierGroup(
                product_id=db_product.id, 
                name=group.name, 
                is_required=group.is_required
            )
            db.add(db_group)
            db.flush()
            
            for mod in group.modifiers:
                db.add(models.Modifier(
                    group_id=db_group.id, 
                    name=mod.name, 
                    price_change=mod.price_change, 
                    ingredient_id=mod.ingredient_id, 
                    quantity=mod.quantity
                ))

        # ---------------------------------------------------------
        # 5. ĞŸĞ Ğ˜Ğ’'Ğ¯Ğ—ĞšĞ Ğ”Ğ Ğ“Ğ Ğ£ĞŸ ĞŸĞ ĞĞ¦Ğ•Ğ¡Ğ†Ğ’ (Kyiv, Lviv Ñ‚Ğ¾Ñ‰Ğ¾)
        # ---------------------------------------------------------
        if product.process_group_ids:
            for pg_id in product.process_group_ids:
                pg = db.query(models.ProcessGroup).filter(
                    models.ProcessGroup.id == pg_id
                ).first()
                if pg:
                    db_product.process_groups.append(pg)

        db.commit()
        db.refresh(db_product)
        return db_product
    
    @staticmethod
    def update_product(
        db: Session, 
        product_id: int, 
        product_data: schemas.ProductCreate
    ):
        # Ğ—Ğ½Ğ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€ Ğ² Ğ±Ğ°Ğ·Ñ–
        db_product = db.query(models.Product).filter(
            models.Product.id == product_id
        ).first()
        
        if not db_product:
            return None

        # ---------------------------------------------------------
        # 1. ĞĞĞĞ’Ğ›Ğ•ĞĞĞ¯ ĞŸĞ ĞĞ¡Ğ¢Ğ˜Ğ¥ ĞŸĞĞ›Ğ†Ğ’
        # ---------------------------------------------------------
        db_product.name = product_data.name
        db_product.description = product_data.description
        db_product.price = product_data.price
        db_product.category_id = product_data.category_id
        db_product.has_variants = product_data.has_variants
        db_product.master_recipe_id = product_data.master_recipe_id
        db_product.output_weight = product_data.output_weight
        
        # Ğ›Ğ¾Ğ³Ñ–ĞºĞ° Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ ÑĞºĞ»Ğ°Ğ´Ñƒ (Ğ´Ğ¾Ğ·Ğ²Ğ¾Ğ»ÑÑ”Ğ¼Ğ¾ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚Ğ¸, ÑĞºÑ‰Ğ¾ Ñ‚Ñ€ĞµĞºÑ–Ğ½Ğ³ Ğ²Ğ¸Ğ¼ĞºĞ½ĞµĞ½Ğ¾)
        db_product.track_stock = product_data.track_stock
        if not product_data.track_stock:
             db_product.stock_quantity = product_data.stock_quantity

        # ---------------------------------------------------------
        # 2. ĞĞĞĞ’Ğ›Ğ•ĞĞĞ¯ ĞœĞĞ¢Ğ•Ğ Ğ†ĞĞ›Ğ†Ğ’ (CONSUMABLES)
        # Ğ¡Ñ‚Ñ€Ğ°Ñ‚ĞµĞ³Ñ–Ñ: Ğ’Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğ¸ Ğ²ÑÑ– ÑÑ‚Ğ°Ñ€Ñ– -> Ğ—Ğ°Ğ¿Ğ¸ÑĞ°Ñ‚Ğ¸ Ğ½Ğ¾Ğ²Ñ–
        # ---------------------------------------------------------
        db.query(models.ProductConsumable).filter(
            models.ProductConsumable.product_id == product_id
        ).delete()
        
        for cons in product_data.consumables:
            db.add(models.ProductConsumable(
                product_id=product_id, 
                consumable_id=cons.consumable_id, 
                quantity=cons.quantity
            ))

        # ---------------------------------------------------------
        # 3. ĞĞĞĞ’Ğ›Ğ•ĞĞĞ¯ Ğ’ĞĞ Ğ†ĞĞĞ¢Ğ†Ğ’ (Ğ¡ĞšĞ›ĞĞ”ĞĞ Ğ›ĞĞ“Ğ†ĞšĞ)
        # ---------------------------------------------------------
        if product_data.has_variants and product_data.variants:
            
            # [A] Ğ’Ğ˜Ğ”ĞĞ›Ğ•ĞĞĞ¯: Ğ—Ğ½Ğ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸, ÑĞºĞ¸Ñ… Ğ±Ñ–Ğ»ÑŒÑˆĞµ Ğ½ĞµĞ¼Ğ°Ñ” Ğ² ÑĞ¿Ğ¸ÑĞºÑƒ
            incoming_names = [v.name for v in product_data.variants]
            
            db.query(models.ProductVariant).filter(
               models.ProductVariant.product_id == product_id,
               # Ğ’Ğ¸Ğ´Ğ°Ğ»ÑÑ”Ğ¼Ğ¾ Ñ‚Ñ–, Ñ‡Ğ¸Ñ—Ñ… Ñ–Ğ¼ĞµĞ½ Ğ½ĞµĞ¼Ğ°Ñ” Ñƒ Ğ½Ğ¾Ğ²Ğ¾Ğ¼Ñƒ ÑĞ¿Ğ¸ÑĞºÑƒ
               models.ProductVariant.name.notin_(incoming_names)
            ).delete(synchronize_session=False)

            # [B] ĞĞĞĞ’Ğ›Ğ•ĞĞĞ¯ Ğ°Ğ±Ğ¾ Ğ¡Ğ¢Ğ’ĞĞ Ğ•ĞĞĞ¯: ĞŸÑ€Ğ¾Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ÑÑŒ Ğ¿Ğ¾ ÑĞ¿Ğ¸ÑĞºÑƒ
            for v in product_data.variants:
                # Ğ¨ÑƒĞºĞ°Ñ”Ğ¼Ğ¾, Ñ‡Ğ¸ Ñ–ÑĞ½ÑƒÑ” Ğ²Ğ¶Ğµ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚ Ğ· Ñ‚Ğ°ĞºĞ¸Ğ¼ Ñ–Ğ¼'ÑĞ¼
                db_variant = db.query(models.ProductVariant).filter(
                    models.ProductVariant.product_id == product_id,
                    models.ProductVariant.name == v.name
                ).first()

                if db_variant:
                    # Ğ¯ĞºÑ‰Ğ¾ Ñ” -> ĞĞ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ¿Ğ¾Ğ»Ñ
                    db_variant.price = v.price
                    db_variant.master_recipe_id = v.master_recipe_id
                    db_variant.output_weight = v.output_weight
                    db_variant.stock_quantity = v.stock_quantity
                else:
                    # Ğ¯ĞºÑ‰Ğ¾ Ğ½ĞµĞ¼Ğ°Ñ” -> Ğ¡Ñ‚Ğ²Ğ¾Ñ€ÑÑ”Ğ¼Ğ¾ Ğ½Ğ¾Ğ²Ğ¸Ğ¹
                    sku = v.sku if v.sku else str(uuid.uuid4())
                    db_variant = models.ProductVariant(
                        product_id=product_id,
                        name=v.name,
                        price=v.price,
                        sku=sku,
                        master_recipe_id=v.master_recipe_id,
                        output_weight=v.output_weight,
                        stock_quantity=v.stock_quantity
                    )
                    db.add(db_variant)
                
                db.flush() # ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ ID (Ğ´Ğ»Ñ Ğ½Ğ¾Ğ²Ğ¸Ñ… Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñ–Ğ²)

                # [C] Ğ—ĞĞŸĞĞ‘Ğ†Ğ“ĞĞĞĞ¯ Ğ”Ğ£Ğ‘Ğ›Ğ®Ğ’ĞĞĞĞ® (ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° Ğ´Ñ–Ñ‚ĞµĞ¹)
                # Ğ’Ğ¸Ğ´Ğ°Ğ»ÑÑ”Ğ¼Ğ¾ ÑÑ‚Ğ°Ñ€Ñ– Ñ–Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ğ¸ Ñ‚Ğ° Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸ Ñ†ÑŒĞ¾Ğ³Ğ¾ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ
                db.query(models.ProductVariantConsumable).filter(
                    models.ProductVariantConsumable.variant_id == db_variant.id
                ).delete()

                db.query(models.ProductVariantIngredient).filter(
                    models.ProductVariantIngredient.variant_id == db_variant.id
                ).delete()

                # [D] Ğ—ĞĞŸĞ˜Ğ¡ ĞĞĞ’Ğ˜Ğ¥ Ğ”Ğ†Ğ¢Ğ•Ğ™
                for vc in v.consumables:
                    db.add(models.ProductVariantConsumable(
                        variant_id=db_variant.id, 
                        consumable_id=vc.consumable_id, 
                        quantity=vc.quantity
                    ))
                
                for vi in v.ingredients:
                    db.add(models.ProductVariantIngredient(
                        variant_id=db_variant.id, 
                        ingredient_id=vi.ingredient_id, 
                        quantity=vi.quantity
                    ))
        else:
            # Ğ¯ĞºÑ‰Ğ¾ Ğ·Ğ½ÑĞ»Ğ¸ Ğ³Ğ°Ğ»Ğ¾Ñ‡ĞºÑƒ "ĞœĞ°Ñ” Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸" -> Ğ²Ğ¸Ğ´Ğ°Ğ»ÑÑ”Ğ¼Ğ¾ Ğ²ÑÑ– Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸
            db.query(models.ProductVariant).filter(
                models.ProductVariant.product_id == product_id
            ).delete()

        # ---------------------------------------------------------
        # 4. ĞĞĞĞ’Ğ›Ğ•ĞĞĞ¯ ĞœĞĞ”Ğ˜Ğ¤Ğ†ĞšĞĞ¢ĞĞ Ğ†Ğ’
        # Ğ¡Ñ‚Ñ€Ğ°Ñ‚ĞµĞ³Ñ–Ñ: Ğ’Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğ¸ Ğ²ÑÑ– Ğ³Ñ€ÑƒĞ¿Ğ¸ -> Ğ¡Ñ‚Ğ²Ğ¾Ñ€Ğ¸Ñ‚Ğ¸ Ğ·Ğ°Ğ½Ğ¾Ğ²Ğ¾
        # ---------------------------------------------------------
        db.query(models.ProductModifierGroup).filter(
            models.ProductModifierGroup.product_id == product_id
        ).delete()
        
        for group in product_data.modifier_groups:
            db_group = models.ProductModifierGroup(
                product_id=product_id, 
                name=group.name, 
                is_required=group.is_required
            )
            db.add(db_group)
            db.flush()
            
            for mod in group.modifiers:
                db.add(models.Modifier(
                    group_id=db_group.id, 
                    name=mod.name, 
                    price_change=mod.price_change, 
                    ingredient_id=mod.ingredient_id, 
                    quantity=mod.quantity
                ))

        # ---------------------------------------------------------
        # 5. ĞĞĞĞ’Ğ›Ğ•ĞĞĞ¯ Ğ“Ğ Ğ£ĞŸ ĞŸĞ ĞĞ¦Ğ•Ğ¡Ğ†Ğ’
        # ---------------------------------------------------------
        db_product.process_groups = [] # ĞÑ‡Ğ¸Ñ‰Ğ°Ñ”Ğ¼Ğ¾ ÑĞ¿Ğ¸ÑĞ¾Ğº
        if product_data.process_group_ids:
            for pg_id in product_data.process_group_ids:
                pg = db.query(models.ProcessGroup).filter(
                    models.ProcessGroup.id == pg_id
                ).first()
                if pg:
                    db_product.process_groups.append(pg)

        db.commit()
        db.refresh(db_product)
        return db_product

--------------------------------------------------
PATH: ./.history/product_service/services/order_service_20260120181647.py
--------------------------------------------------
from sqlalchemy.orm import Session
import models, schemas
from services.inventory_logger import InventoryLogger
import traceback # Ğ”Ğ»Ñ Ğ²Ğ¸Ğ²Ğ¾Ğ´Ñƒ Ğ¿Ğ¾Ğ¼Ğ¸Ğ»ĞºĞ¸ Ğ² ĞºĞ¾Ğ½ÑĞ¾Ğ»ÑŒ

class OrderService:
    """
    Ğ¦ĞµĞ¹ ĞºĞ»Ğ°Ñ Ğ²Ñ–Ğ´Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ°Ñ” Ğ²Ğ¸ĞºĞ»ÑÑ‡Ğ½Ğ¾ Ğ·Ğ° Ğ¾Ğ±Ñ€Ğ¾Ğ±ĞºÑƒ Ğ·Ğ°Ğ¼Ğ¾Ğ²Ğ»ĞµĞ½ÑŒ.
    Ğ ĞµĞ°Ğ»Ñ–Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ¾ Ğ¿Ñ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿ Atomic Transaction (Ğ²ÑĞµ Ğ°Ğ±Ğ¾ Ğ½Ñ–Ñ‡Ğ¾Ğ³Ğ¾).
    """
    @staticmethod
    def process_checkout(db: Session, order_data: schemas.OrderCreate):
        try:
            # 1. Ğ¡Ñ‚Ğ²Ğ¾Ñ€ÑÑ”Ğ¼Ğ¾ Ğ·Ğ°Ğ¼Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ
            new_order = models.Order(
                total_price=order_data.total_price,
                payment_method=order_data.payment_method,
                customer_id=order_data.customer_id
            )
            db.add(new_order)
            
            # Ğ’ĞĞ–Ğ›Ğ˜Ğ’Ğ: Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ flush(), Ğ° Ğ½Ğµ commit().
            # Ğ¦Ğµ Ğ´Ğ°Ñ” Ğ½Ğ°Ğ¼ ID Ğ·Ğ°Ğ¼Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ, Ğ°Ğ»Ğµ Ğ´Ğ¾Ğ·Ğ²Ğ¾Ğ»ÑÑ” Ğ²Ñ–Ğ´ĞºĞ¾Ñ‚Ğ¸Ñ‚Ğ¸ Ğ·Ğ¼Ñ–Ğ½Ğ¸, ÑĞºÑ‰Ğ¾ ÑÑ‚Ğ°Ñ”Ñ‚ÑŒÑÑ Ğ¿Ğ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ´Ğ°Ğ»Ñ–.
            db.flush() 
            db.refresh(new_order)

            transaction_reason = f"sale_order_{new_order.id}"

            # 2. ĞŸÑ€Ğ¾Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ÑÑŒ Ğ¿Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°Ñ…
            for item in order_data.items:
                product = db.query(models.Product).filter(models.Product.id == item.product_id).first()
                if not product: continue

                item_name = product.name
                price = product.price
                details_list = []
                
                target_recipe_id = None
                base_weight = 0.0

                # --- Ğ. Ğ’ĞĞ Ğ†ĞĞĞ¢Ğ˜ ---
                if item.variant_id:
                    variant = db.query(models.ProductVariant).filter(models.ProductVariant.id == item.variant_id).first()
                    if variant:
                        item_name = f"{product.name} ({variant.name})"
                        price = variant.price
                        details_list.append(f"Ğ’Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚: {variant.name}")
                        
                        target_recipe_id = variant.master_recipe_id or product.master_recipe_id
                        base_weight = variant.output_weight

                        # Ğ¡Ğ¿Ğ¸ÑĞ°Ğ½Ğ½Ñ Ğ·Ğ°Ğ»Ğ¸ÑˆĞºÑƒ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ
                        old_qty = variant.stock_quantity
                        variant.stock_quantity -= item.quantity
                        db.add(variant)
                        
                        InventoryLogger.log(
                            db, "product_variant", variant.id, item_name, 
                            old_qty, variant.stock_quantity, transaction_reason
                        )

                        # Ğ¡Ğ¿Ğ¸ÑĞ°Ğ½Ğ½Ñ Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ñ–Ğ² Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ
                        for vc in variant.consumables:
                            if vc.consumable:
                                c_old = vc.consumable.stock_quantity
                                deduction = vc.quantity * item.quantity
                                vc.consumable.stock_quantity -= deduction
                                db.add(vc.consumable)
                                InventoryLogger.log(db, "consumable", vc.consumable.id, vc.consumable.name, c_old, vc.consumable.stock_quantity, transaction_reason)

                        # !!! ĞĞĞ’Ğ•: Ğ¡Ğ¿Ğ¸ÑĞ°Ğ½Ğ½Ñ Ñ–Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ñ–Ğ² Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ !!!
                        # Ğ¯ĞºÑ‰Ğ¾ models.py Ğ½Ğµ Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾, Ñ‚ÑƒÑ‚ Ğ±ÑƒĞ´Ğµ Ğ¿Ğ¾Ğ¼Ğ¸Ğ»ĞºĞ° AttributeError.
                        # Ğ—Ğ°Ğ²Ğ´ÑĞºĞ¸ try/except Ğ¼Ğ¸ Ğ¿Ğ¾Ğ±Ğ°Ñ‡Ğ¸Ğ¼Ğ¾ Ñ†Ğµ Ğ² Ğ»Ğ¾Ğ³Ğ°Ñ…, Ğ° Ğ·Ğ°Ğ¼Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ Ğ½Ğµ ÑÑ‚Ğ²Ğ¾Ñ€Ğ¸Ñ‚ÑŒÑÑ.
                        if hasattr(variant, 'ingredients'):
                            for vi in variant.ingredients:
                                if vi.ingredient:
                                    i_old = vi.ingredient.stock_quantity
                                    deduction = vi.quantity * item.quantity
                                    vi.ingredient.stock_quantity -= deduction
                                    db.add(vi.ingredient)
                                    InventoryLogger.log(db, "ingredient", vi.ingredient.id, vi.ingredient.name, i_old, vi.ingredient.stock_quantity, transaction_reason)

                # --- Ğ‘. ĞŸĞ ĞĞ¡Ğ¢Ğ† Ğ¢ĞĞ’ĞĞ Ğ˜ ---
                else:
                    target_recipe_id = product.master_recipe_id
                    base_weight = product.output_weight
                    
                    if product.track_stock:
                        old_qty = product.stock_quantity
                        product.stock_quantity -= item.quantity
                        db.add(product)
                        InventoryLogger.log(db, "product", product.id, product.name, old_qty, product.stock_quantity, transaction_reason)

                # --- Ğ’. Ğ—ĞĞ“ĞĞ›Ğ¬ĞĞ† ĞœĞĞ¢Ğ•Ğ Ğ†ĞĞ›Ğ˜ ---
                for pc in product.consumables:
                    if pc.consumable:
                        c_old = pc.consumable.stock_quantity
                        deduction = pc.quantity * item.quantity
                        pc.consumable.stock_quantity -= deduction
                        db.add(pc.consumable)
                        InventoryLogger.log(db, "consumable", pc.consumable.id, pc.consumable.name, c_old, pc.consumable.stock_quantity, transaction_reason)

                # --- Ğ“. Ğ Ğ•Ğ¦Ğ•ĞŸĞ¢ ---
                if target_recipe_id:
                    recipe = db.query(models.MasterRecipe).filter(models.MasterRecipe.id == target_recipe_id).first()
                    if recipe:
                        for r_item in recipe.items:
                            if r_item.ingredient:
                                deduction_per_item = (r_item.quantity / 100.0 * base_weight) if r_item.is_percentage else r_item.quantity
                                total_deduction = deduction_per_item * item.quantity
                                i_old = r_item.ingredient.stock_quantity
                                r_item.ingredient.stock_quantity -= total_deduction
                                db.add(r_item.ingredient)
                                InventoryLogger.log(db, "ingredient", r_item.ingredient.id, r_item.ingredient.name, i_old, r_item.ingredient.stock_quantity, transaction_reason)

                # --- Ğ”. ĞœĞĞ”Ğ˜Ğ¤Ğ†ĞšĞĞ¢ĞĞ Ğ˜ ---
                for mod_item in item.modifiers:
                    mod = db.query(models.Modifier).filter(models.Modifier.id == mod_item.modifier_id).first()
                    if mod:
                        details_list.append(mod.name)
                        if mod.ingredient:
                            i_old = mod.ingredient.stock_quantity
                            deduction = mod.quantity * item.quantity
                            mod.ingredient.stock_quantity -= deduction
                            db.add(mod.ingredient)
                            InventoryLogger.log(db, "ingredient", mod.ingredient.id, mod.ingredient.name, i_old, mod.ingredient.stock_quantity, transaction_reason)

                # Ğ¤Ñ–ĞºÑÑƒÑ”Ğ¼Ğ¾ Ñ€ÑĞ´Ğ¾Ğº Ğ² Ñ‡ĞµĞºÑƒ
                db.add(models.OrderItem(
                    order_id=new_order.id,
                    product_name=item_name,
                    quantity=item.quantity,
                    price_at_moment=price,
                    details=", ".join(details_list)
                ))

            # 3. Ğ¢Ñ–Ğ»ÑŒĞºĞ¸ ÑĞºÑ‰Ğ¾ Ğ²ÑĞµ Ğ¿Ñ€Ğ¾Ğ¹ÑˆĞ»Ğ¾ Ğ±ĞµĞ· Ğ¿Ğ¾Ğ¼Ğ¸Ğ»Ğ¾Ğº - Ñ„Ñ–ĞºÑÑƒÑ”Ğ¼Ğ¾ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ñ–Ñ
            db.commit()
            return new_order

        except Exception as e:
            # Ğ¯ĞºÑ‰Ğ¾ ÑÑ‚Ğ°Ğ»Ğ°ÑÑŒ Ğ‘Ğ£Ğ”Ğ¬-Ğ¯ĞšĞ Ğ¿Ğ¾Ğ¼Ğ¸Ğ»ĞºĞ° - Ğ²Ñ–Ğ´ĞºĞ¾Ñ‡ÑƒÑ”Ğ¼Ğ¾ Ğ²ÑĞµ (Ñ– ÑÑ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ½Ñ Ğ·Ğ°Ğ¼Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ Ñ‚ĞµĞ¶)
            db.rollback()
            print("âŒ ĞŸĞĞœĞ˜Ğ›ĞšĞ ĞŸĞ Ğ˜ ĞĞŸĞ›ĞĞ¢Ğ† (Transaction Rollback):")
            print(traceback.format_exc()) # Ğ’Ğ¸Ğ²ĞµĞ´Ğµ Ñ‚Ğ¾Ñ‡Ğ½Ñƒ Ğ¿Ñ€Ğ¸Ñ‡Ğ¸Ğ½Ñƒ Ğ² ĞºĞ¾Ğ½ÑĞ¾Ğ»ÑŒ Docker
            raise e # ĞŸÑ€Ğ¾ĞºĞ¸Ğ´ÑƒÑ”Ğ¼Ğ¾ Ğ¿Ğ¾Ğ¼Ğ¸Ğ»ĞºÑƒ Ğ´Ğ°Ğ»Ñ–, Ñ‰Ğ¾Ğ± API Ğ¿Ğ¾Ğ²ĞµÑ€Ğ½ÑƒĞ² 500

--------------------------------------------------
PATH: ./.history/product_service/services/product_service_20260125170408.py
--------------------------------------------------
from sqlalchemy.orm import Session
from fastapi import HTTPException
import models, schemas
import uuid # ĞĞµĞ¾Ğ±Ñ…Ñ–Ğ´Ğ½Ğ¾ Ğ´Ğ»Ñ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ñ–Ñ— SKU

class ProductService:
    """
    ĞšĞ»Ğ°Ñ Ğ´Ğ»Ñ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»Ñ–Ğ½Ğ½Ñ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°Ğ¼Ğ¸.
    Ğ’ÑÑ Ğ»Ğ¾Ğ³Ñ–ĞºĞ° ÑÑ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ½Ñ Ñ‚Ğ° Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ (CRUD) Ğ¶Ğ¸Ğ²Ğµ Ñ‚ÑƒÑ‚.
    """

    @staticmethod
    def create_product(db: Session, product: schemas.ProductCreate):
        # 1. Ğ¡Ñ‚Ğ²Ğ¾Ñ€ÑÑ”Ğ¼Ğ¾ Ğ±Ğ°Ğ·Ğ¾Ğ²Ğ¸Ğ¹ Ğ·Ğ°Ğ¿Ğ¸Ñ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ
        db_product = models.Product(
            name=product.name, 
            price=product.price, 
            description=product.description,
            category_id=product.category_id, 
            has_variants=product.has_variants,
            master_recipe_id=product.master_recipe_id, 
            output_weight=product.output_weight,
            track_stock=product.track_stock,
            stock_quantity=product.stock_quantity
        )
        db.add(db_product)
        db.commit()
        db.refresh(db_product) # ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ ID

        # 2. ĞŸÑ€Ğ¸Ğ²'ÑĞ·ÑƒÑ”Ğ¼Ğ¾ Ğ²Ğ¸Ñ‚Ñ€Ğ°Ñ‚Ğ½Ñ– Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸ (Ñ€Ñ–Ğ²ĞµĞ½ÑŒ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ)
        for cons in product.consumables:
            db.add(models.ProductConsumable(
                product_id=db_product.id, 
                consumable_id=cons.consumable_id, 
                quantity=cons.quantity
            ))

        # 3. Ğ¡Ñ‚Ğ²Ğ¾Ñ€ÑÑ”Ğ¼Ğ¾ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸
        if product.has_variants and product.variants:
            for v in product.variants:
                # Ğ“ĞµĞ½ĞµÑ€ÑƒÑ”Ğ¼Ğ¾ SKU, ÑĞºÑ‰Ğ¾ Ğ½Ğµ Ğ¿ĞµÑ€ĞµĞ´Ğ°Ğ»Ğ¸
                sku = v.sku if v.sku else str(uuid.uuid4())
                
                db_variant = models.ProductVariant(
                    product_id=db_product.id, 
                    name=v.name, 
                    price=v.price, 
                    sku=sku,
                    master_recipe_id=v.master_recipe_id, 
                    output_weight=v.output_weight,
                    stock_quantity=v.stock_quantity 
                )
                db.add(db_variant)
                db.flush() # ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ ID Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ
                
                # ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ
                for vc in v.consumables:
                    db.add(models.ProductVariantConsumable(
                        variant_id=db_variant.id, 
                        consumable_id=vc.consumable_id, 
                        quantity=vc.quantity
                    ))
                
                # Ğ†Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ğ¸ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ
                for vi in v.ingredients:
                    db.add(models.ProductVariantIngredient(
                        variant_id=db_variant.id, 
                        ingredient_id=vi.ingredient_id, 
                        quantity=vi.quantity
                    ))

        # 4. ĞœĞ¾Ğ´Ğ¸Ñ„Ñ–ĞºĞ°Ñ‚Ğ¾Ñ€Ğ¸
        for group in product.modifier_groups:
            db_group = models.ProductModifierGroup(
                product_id=db_product.id, 
                name=group.name, 
                is_required=group.is_required
            )
            db.add(db_group)
            db.flush()
            for mod in group.modifiers:
                db.add(models.Modifier(
                    group_id=db_group.id, 
                    name=mod.name, 
                    price_change=mod.price_change, 
                    ingredient_id=mod.ingredient_id, 
                    quantity=mod.quantity
                ))

        # 5. Ğ“Ñ€ÑƒĞ¿Ğ¸ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ–Ğ²
        if product.process_group_ids:
            for pg_id in product.process_group_ids:
                pg = db.query(models.ProcessGroup).filter(models.ProcessGroup.id == pg_id).first()
                if pg:
                    db_product.process_groups.append(pg)

        db.commit()
        db.refresh(db_product)
        return db_product
    
    @staticmethod
    def update_product(db: Session, product_id: int, product_data: schemas.ProductCreate):
        """
        ĞĞ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ.
        Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ” ÑÑ‚Ñ€Ğ°Ñ‚ĞµĞ³Ñ–Ñ "Ğ Ğ¾Ğ·ÑƒĞ¼Ğ½Ğ¾Ğ³Ğ¾ Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ" Ğ´Ğ»Ñ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñ–Ğ², 
        Ñ‰Ğ¾Ğ± ÑƒĞ½Ğ¸ĞºĞ½ÑƒÑ‚Ğ¸ Ğ·Ğ¼Ñ–Ğ½Ğ¸ ID Ñ‚Ğ° Ğ´ÑƒĞ±Ğ»ÑĞ²Ğ°Ğ½Ğ½Ñ Ñ–Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ñ–Ğ².
        """
        # Ğ—Ğ½Ğ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€
        db_product = db.query(models.Product).filter(models.Product.id == product_id).first()
        if not db_product:
            return None

        # 1. ĞĞ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ¿Ñ€Ğ¾ÑÑ‚Ñ– Ğ¿Ğ¾Ğ»Ñ
        db_product.name = product_data.name
        db_product.description = product_data.description
        db_product.price = product_data.price
        db_product.category_id = product_data.category_id
        db_product.has_variants = product_data.has_variants
        db_product.master_recipe_id = product_data.master_recipe_id
        db_product.output_weight = product_data.output_weight
        
        # ĞĞ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ ÑĞºĞ»Ğ°Ğ´, Ñ‚Ñ–Ğ»ÑŒĞºĞ¸ ÑĞºÑ‰Ğ¾ Ğ½Ğµ Ğ²Ñ–Ğ´ÑÑ‚ĞµĞ¶ÑƒÑ”Ñ‚ÑŒÑÑ Ğ°Ğ±Ğ¾ ÑĞ²Ğ½Ğ¾ Ğ´Ğ¾Ğ·Ğ²Ğ¾Ğ»ĞµĞ½Ğ¾
        # (Ğ»Ğ¾Ğ³Ñ–ĞºĞ° Ğ·Ğ°Ğ»ĞµĞ¶Ğ¸Ñ‚ÑŒ Ğ²Ñ–Ğ´ Ğ²Ğ°ÑˆĞ¸Ñ… Ğ¿Ğ¾Ñ‚Ñ€ĞµĞ±, Ñ‚ÑƒÑ‚ Ğ´Ğ¾Ğ·Ğ²Ğ¾Ğ»ÑÑ”Ğ¼Ğ¾ Ñ€ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ñ‚Ğ¸)
        db_product.track_stock = product_data.track_stock
        if not product_data.track_stock:
             db_product.stock_quantity = product_data.stock_quantity

        # 2. ĞĞ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Consumables (Ğ—Ğ°Ğ³Ğ°Ğ»ÑŒĞ½Ñ– Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸)
        # Ğ¢ÑƒÑ‚ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾: Ğ²Ğ¸Ğ´Ğ°Ğ»ÑÑ”Ğ¼Ğ¾ Ğ²ÑÑ– ÑÑ‚Ğ°Ñ€Ñ– Ñ– Ğ¿Ğ¸ÑˆĞµĞ¼Ğ¾ Ğ½Ğ¾Ğ²Ñ–
        db.query(models.ProductConsumable).filter(models.ProductConsumable.product_id == product_id).delete()
        for cons in product_data.consumables:
            db.add(models.ProductConsumable(
                product_id=product_id, 
                consumable_id=cons.consumable_id, 
                quantity=cons.quantity
            ))

        # 3. ĞĞ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ’Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸ (ĞĞ°Ğ¹ÑĞºĞ»Ğ°Ğ´Ğ½Ñ–ÑˆĞ° Ñ‡Ğ°ÑÑ‚Ğ¸Ğ½Ğ°)
        if product_data.has_variants and product_data.variants:
            # ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ ÑĞ¿Ğ¸ÑĞ¾Ğº Ñ–Ğ¼ĞµĞ½ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñ–Ğ², ÑĞºÑ– Ğ¿Ñ€Ğ¸Ğ¹ÑˆĞ»Ğ¸ Ğ· Ñ„Ñ€Ğ¾Ğ½Ñ‚Ñƒ, Ñ‰Ğ¾Ğ± Ğ·Ğ½Ğ°Ñ‚Ğ¸, Ñ‰Ğ¾ Ğ½Ğµ Ğ²Ğ¸Ğ´Ğ°Ğ»ÑÑ‚Ğ¸
            incoming_names = [v.name for v in product_data.variants]

            # (ĞĞ¿Ñ†Ñ–Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾) ĞœĞ¾Ğ¶Ğ½Ğ° Ğ´Ğ¾Ğ´Ğ°Ñ‚Ğ¸ Ğ»Ğ¾Ğ³Ñ–ĞºÑƒ Ğ²Ğ¸Ğ´Ğ°Ğ»ĞµĞ½Ğ½Ñ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñ–Ğ², ÑĞºĞ¸Ñ… Ğ±Ñ–Ğ»ÑŒÑˆĞµ Ğ½ĞµĞ¼Ğ°Ñ” Ğ² ÑĞ¿Ğ¸ÑĞºÑƒ
            # db.query(models.ProductVariant).filter(
            #    models.ProductVariant.product_id == product_id,
            #    models.ProductVariant.name.notin_(incoming_names)
            # ).delete()

            for v in product_data.variants:
                # Ğ¡Ğ¿Ñ€Ğ¾Ğ±Ğ° Ğ·Ğ½Ğ°Ğ¹Ñ‚Ğ¸ Ñ–ÑĞ½ÑƒÑÑ‡Ğ¸Ğ¹ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚ Ğ·Ğ° Ğ½Ğ°Ğ·Ğ²Ğ¾Ñ Ğ² Ğ¼ĞµĞ¶Ğ°Ñ… Ñ†ÑŒĞ¾Ğ³Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ
                # Ğ¦Ğµ Ğ´Ğ¾Ğ·Ğ²Ğ¾Ğ»ÑÑ” Ğ·Ğ±ĞµÑ€ĞµĞ³Ñ‚Ğ¸ ID Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ Ñ– Ğ¹Ğ¾Ğ³Ğ¾ Ñ–ÑÑ‚Ğ¾Ñ€Ñ–Ñ
                db_variant = db.query(models.ProductVariant).filter(
                    models.ProductVariant.product_id == product_id,
                    models.ProductVariant.name == v.name
                ).first()

                if db_variant:
                    # === ĞĞĞĞ’Ğ›Ğ•ĞĞĞ¯ Ğ†Ğ¡ĞĞ£Ğ®Ğ§ĞĞ“Ğ ===
                    db_variant.price = v.price
                    db_variant.master_recipe_id = v.master_recipe_id
                    db_variant.output_weight = v.output_weight
                    db_variant.stock_quantity = v.stock_quantity
                    # SKU Ğ½Ğµ Ğ¼Ñ–Ğ½ÑÑ”Ğ¼Ğ¾, ÑĞºÑ‰Ğ¾ Ğ²Ñ–Ğ½ Ğ²Ğ¶Ğµ Ñ”
                else:
                    # === Ğ¡Ğ¢Ğ’ĞĞ Ğ•ĞĞĞ¯ ĞĞĞ’ĞĞ“Ğ ===
                    sku = v.sku if v.sku else str(uuid.uuid4())
                    db_variant = models.ProductVariant(
                        product_id=product_id,
                        name=v.name,
                        price=v.price,
                        sku=sku,
                        master_recipe_id=v.master_recipe_id,
                        output_weight=v.output_weight,
                        stock_quantity=v.stock_quantity
                    )
                    db.add(db_variant)
                
                db.flush() # Ğ©Ğ¾Ğ± Ğ³Ğ°Ñ€Ğ°Ğ½Ñ‚Ğ¾Ğ²Ğ°Ğ½Ğ¾ Ğ¼Ğ°Ñ‚Ğ¸ db_variant.id

                # === Ğ’Ğ˜Ğ Ğ†Ğ¨Ğ•ĞĞĞ¯ ĞŸĞ ĞĞ‘Ğ›Ğ•ĞœĞ˜ Ğ”Ğ£Ğ‘Ğ›Ğ®Ğ’ĞĞĞĞ¯ (57 Ñ–Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ñ–Ğ²) ===
                # ĞŸĞµÑ€ĞµĞ´ Ğ´Ğ¾Ğ´Ğ°Ğ²Ğ°Ğ½Ğ½ÑĞ¼ Ğ½Ğ¾Ğ²Ğ¸Ñ… Ñ–Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ñ–Ğ²/Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ñ–Ğ²,
                # Ğ¼Ğ¸ ĞŸĞĞ’ĞĞ†Ğ¡Ğ¢Ğ® ĞĞ§Ğ˜Ğ©ĞĞ„ĞœĞ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ´Ğ»Ñ Ñ†ÑŒĞ¾Ğ³Ğ¾ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾Ğ³Ğ¾ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ.
                
                # 1. Ğ§Ğ¸ÑÑ‚Ğ¸Ğ¼Ğ¾ Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ
                db.query(models.ProductVariantConsumable).filter(
                    models.ProductVariantConsumable.variant_id == db_variant.id
                ).delete()

                # 2. Ğ§Ğ¸ÑÑ‚Ğ¸Ğ¼Ğ¾ Ñ–Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ğ¸ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ (ĞÑÑŒ Ñ†Ğµ Ğ²Ğ¸Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñƒ!)
                db.query(models.ProductVariantIngredient).filter(
                    models.ProductVariantIngredient.variant_id == db_variant.id
                ).delete()

                # === Ğ—ĞĞŸĞ˜Ğ¡ ĞĞĞ’Ğ˜Ğ¥ Ğ”ĞĞĞ˜Ğ¥ ===
                # Ğ¢ĞµĞ¿ĞµÑ€ Ğ·Ğ°Ğ¿Ğ¸ÑÑƒÑ”Ğ¼Ğ¾ Ğ½Ğ°Ñ‡Ğ¸ÑÑ‚Ğ¾, Ñ€Ñ–Ğ²Ğ½Ğ¾ ÑÑ‚Ñ–Ğ»ÑŒĞºĞ¸, ÑĞºÑ–Ğ»ÑŒĞºĞ¸ Ğ¿Ñ€Ğ¸Ğ¹ÑˆĞ»Ğ¾ Ğ· Ñ„Ñ€Ğ¾Ğ½Ñ‚Ñƒ
                for vc in v.consumables:
                    db.add(models.ProductVariantConsumable(
                        variant_id=db_variant.id, 
                        consumable_id=vc.consumable_id, 
                        quantity=vc.quantity
                    ))
                
                for vi in v.ingredients:
                    db.add(models.ProductVariantIngredient(
                        variant_id=db_variant.id, 
                        ingredient_id=vi.ingredient_id, 
                        quantity=vi.quantity
                    ))

        # 4. ĞœĞ¾Ğ´Ğ¸Ñ„Ñ–ĞºĞ°Ñ‚Ğ¾Ñ€Ğ¸ (Ğ¢ÑƒÑ‚ Ğ²Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ ÑÑ‚Ğ°Ñ€Ñƒ ÑÑ‚Ñ€Ğ°Ñ‚ĞµĞ³Ñ–Ñ "Delete All", Ğ±Ğ¾ Ğ¼Ğ¾Ğ´Ğ¸Ñ„Ñ–ĞºĞ°Ñ‚Ğ¾Ñ€Ğ¸ ÑĞºĞ»Ğ°Ğ´Ğ½Ñ–ÑˆÑ–)
        # Ğ’Ğ¸Ğ´Ğ°Ğ»ÑÑ”Ğ¼Ğ¾ Ğ²ÑÑ– Ğ³Ñ€ÑƒĞ¿Ğ¸
        db.query(models.ProductModifierGroup).filter(models.ProductModifierGroup.product_id == product_id).delete()
        # Ğ¡Ñ‚Ğ²Ğ¾Ñ€ÑÑ”Ğ¼Ğ¾ Ğ·Ğ°Ğ½Ğ¾Ğ²Ğ¾
        for group in product_data.modifier_groups:
            db_group = models.ProductModifierGroup(product_id=product_id, name=group.name, is_required=group.is_required)
            db.add(db_group); db.flush()
            for mod in group.modifiers:
                db.add(models.Modifier(group_id=db_group.id, name=mod.name, price_change=mod.price_change, ingredient_id=mod.ingredient_id, quantity=mod.quantity))

        # 5. Ğ“Ñ€ÑƒĞ¿Ğ¸ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ–Ğ²
        db_product.process_groups = [] # ĞÑ‡Ğ¸Ñ‰Ğ°Ñ”Ğ¼Ğ¾ Ğ·Ğ²'ÑĞ·ĞºĞ¸
        if product_data.process_group_ids:
            for pg_id in product_data.process_group_ids:
                pg = db.query(models.ProcessGroup).filter(models.ProcessGroup.id == pg_id).first()
                if pg:
                    db_product.process_groups.append(pg)

        db.commit()
        db.refresh(db_product)
        return db_product

--------------------------------------------------
PATH: ./.history/product_service/services/order_service_20260124232907.py
--------------------------------------------------
from sqlalchemy.orm import Session
import models, schemas
from services.inventory_logger import InventoryLogger
import traceback # Ğ”Ğ»Ñ Ğ²Ğ¸Ğ²Ğ¾Ğ´Ñƒ Ğ¿Ğ¾Ğ¼Ğ¸Ğ»ĞºĞ¸ Ğ² ĞºĞ¾Ğ½ÑĞ¾Ğ»ÑŒ

class OrderService:
    """
    Ğ¦ĞµĞ¹ ĞºĞ»Ğ°Ñ Ğ²Ñ–Ğ´Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ°Ñ” Ğ²Ğ¸ĞºĞ»ÑÑ‡Ğ½Ğ¾ Ğ·Ğ° Ğ¾Ğ±Ñ€Ğ¾Ğ±ĞºÑƒ Ğ·Ğ°Ğ¼Ğ¾Ğ²Ğ»ĞµĞ½ÑŒ.
    Ğ ĞµĞ°Ğ»Ñ–Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ¾ Ğ¿Ñ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿ Atomic Transaction (Ğ²ÑĞµ Ğ°Ğ±Ğ¾ Ğ½Ñ–Ñ‡Ğ¾Ğ³Ğ¾).
    """
    @staticmethod
    def process_checkout(db: Session, order_data: schemas.OrderCreate):
        try:
            # 1. Ğ¡Ñ‚Ğ²Ğ¾Ñ€ÑÑ”Ğ¼Ğ¾ Ğ·Ğ°Ğ¼Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ
            new_order = models.Order(
                total_price=order_data.total_price,
                payment_method=order_data.payment_method,
                customer_id=order_data.customer_id
            )
            db.add(new_order)
            
            # Ğ’ĞĞ–Ğ›Ğ˜Ğ’Ğ: Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ flush(), Ğ° Ğ½Ğµ commit().
            # Ğ¦Ğµ Ğ´Ğ°Ñ” Ğ½Ğ°Ğ¼ ID Ğ·Ğ°Ğ¼Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ, Ğ°Ğ»Ğµ Ğ´Ğ¾Ğ·Ğ²Ğ¾Ğ»ÑÑ” Ğ²Ñ–Ğ´ĞºĞ¾Ñ‚Ğ¸Ñ‚Ğ¸ Ğ·Ğ¼Ñ–Ğ½Ğ¸, ÑĞºÑ‰Ğ¾ ÑÑ‚Ğ°Ñ”Ñ‚ÑŒÑÑ Ğ¿Ğ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ´Ğ°Ğ»Ñ–.
            db.flush() 
            db.refresh(new_order)

            transaction_reason = f"sale_order_{new_order.id}"

            # 2. ĞŸÑ€Ğ¾Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ÑÑŒ Ğ¿Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°Ñ…
            for item in order_data.items:
                product = db.query(models.Product).filter(models.Product.id == item.product_id).first()
                if not product: continue

                item_name = product.name
                price = product.price
                details_list = []
                
                target_recipe_id = None
                base_weight = 0.0

                # --- Ğ. Ğ’ĞĞ Ğ†ĞĞĞ¢Ğ˜ ---
                if item.variant_id:
                    variant = db.query(models.ProductVariant).filter(models.ProductVariant.id == item.variant_id).first()
                    if variant:
                        item_name = f"{product.name} ({variant.name})"
                        price = variant.price
                        details_list.append(f"Ğ’Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚: {variant.name}")
                        
                        target_recipe_id = variant.master_recipe_id or product.master_recipe_id
                        base_weight = variant.output_weight

                        # Ğ¡Ğ¿Ğ¸ÑĞ°Ğ½Ğ½Ñ Ğ·Ğ°Ğ»Ğ¸ÑˆĞºÑƒ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ
                        old_qty = variant.stock_quantity
                        variant.stock_quantity -= item.quantity
                        db.add(variant)
                        
                        InventoryLogger.log(
                            db, "product_variant", variant.id, item_name, 
                            old_qty, variant.stock_quantity, transaction_reason
                        )

                        # Ğ¡Ğ¿Ğ¸ÑĞ°Ğ½Ğ½Ñ Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ñ–Ğ² Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ
                        for vc in variant.consumables:
                            if vc.consumable:
                                c_old = vc.consumable.stock_quantity
                                deduction = vc.quantity * item.quantity
                                vc.consumable.stock_quantity -= deduction
                                db.add(vc.consumable)
                                InventoryLogger.log(db, "consumable", vc.consumable.id, vc.consumable.name, c_old, vc.consumable.stock_quantity, transaction_reason)

                        # !!! ĞĞĞ’Ğ•: Ğ¡Ğ¿Ğ¸ÑĞ°Ğ½Ğ½Ñ Ñ–Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ñ–Ğ² Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ !!!
                        # Ğ¯ĞºÑ‰Ğ¾ models.py Ğ½Ğµ Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾, Ñ‚ÑƒÑ‚ Ğ±ÑƒĞ´Ğµ Ğ¿Ğ¾Ğ¼Ğ¸Ğ»ĞºĞ° AttributeError.
                        # Ğ—Ğ°Ğ²Ğ´ÑĞºĞ¸ try/except Ğ¼Ğ¸ Ğ¿Ğ¾Ğ±Ğ°Ñ‡Ğ¸Ğ¼Ğ¾ Ñ†Ğµ Ğ² Ğ»Ğ¾Ğ³Ğ°Ñ…, Ğ° Ğ·Ğ°Ğ¼Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ Ğ½Ğµ ÑÑ‚Ğ²Ğ¾Ñ€Ğ¸Ñ‚ÑŒÑÑ.
                        if hasattr(variant, 'ingredients'):
                            for vi in variant.ingredients:
                                if vi.ingredient:
                                    i_old = vi.ingredient.stock_quantity
                                    deduction = vi.quantity * item.quantity
                                    vi.ingredient.stock_quantity -= deduction
                                    db.add(vi.ingredient)
                                    InventoryLogger.log(db, "ingredient", vi.ingredient.id, vi.ingredient.name, i_old, vi.ingredient.stock_quantity, transaction_reason)

                # --- Ğ‘. ĞŸĞ ĞĞ¡Ğ¢Ğ† Ğ¢ĞĞ’ĞĞ Ğ˜ ---
                else:
                    target_recipe_id = product.master_recipe_id
                    base_weight = product.output_weight
                    
                    if product.track_stock:
                        old_qty = product.stock_quantity
                        product.stock_quantity -= item.quantity
                        db.add(product)
                        InventoryLogger.log(db, "product", product.id, product.name, old_qty, product.stock_quantity, transaction_reason)

                # --- Ğ’. Ğ—ĞĞ“ĞĞ›Ğ¬ĞĞ† ĞœĞĞ¢Ğ•Ğ Ğ†ĞĞ›Ğ˜ ---
                for pc in product.consumables:
                    if pc.consumable:
                        c_old = pc.consumable.stock_quantity
                        deduction = pc.quantity * item.quantity
                        pc.consumable.stock_quantity -= deduction
                        db.add(pc.consumable)
                        InventoryLogger.log(db, "consumable", pc.consumable.id, pc.consumable.name, c_old, pc.consumable.stock_quantity, transaction_reason)

                # --- Ğ“. Ğ Ğ•Ğ¦Ğ•ĞŸĞ¢ ---
                if target_recipe_id:
                    recipe = db.query(models.MasterRecipe).filter(models.MasterRecipe.id == target_recipe_id).first()
                    if recipe:
                        for r_item in recipe.items:
                            if r_item.ingredient:
                                deduction_per_item = (r_item.quantity / 100.0 * base_weight) if r_item.is_percentage else r_item.quantity
                                total_deduction = deduction_per_item * item.quantity
                                i_old = r_item.ingredient.stock_quantity
                                r_item.ingredient.stock_quantity -= total_deduction
                                db.add(r_item.ingredient)
                                InventoryLogger.log(db, "ingredient", r_item.ingredient.id, r_item.ingredient.name, i_old, r_item.ingredient.stock_quantity, transaction_reason)

                # --- Ğ”. ĞœĞĞ”Ğ˜Ğ¤Ğ†ĞšĞĞ¢ĞĞ Ğ˜ ---
                for mod_item in item.modifiers:
                    mod = db.query(models.Modifier).filter(models.Modifier.id == mod_item.modifier_id).first()
                    if mod:
                        details_list.append(mod.name)
                        if mod.ingredient:
                            i_old = mod.ingredient.stock_quantity
                            deduction = mod.quantity * item.quantity
                            mod.ingredient.stock_quantity -= deduction
                            db.add(mod.ingredient)
                            InventoryLogger.log(db, "ingredient", mod.ingredient.id, mod.ingredient.name, i_old, mod.ingredient.stock_quantity, transaction_reason)

                # Ğ¤Ñ–ĞºÑÑƒÑ”Ğ¼Ğ¾ Ñ€ÑĞ´Ğ¾Ğº Ğ² Ñ‡ĞµĞºÑƒ
                db.add(models.OrderItem(
                    order_id=new_order.id,
                    product_name=item_name,
                    quantity=item.quantity,
                    price_at_moment=price,
                    details=", ".join(details_list)
                ))

            # 3. Ğ¢Ñ–Ğ»ÑŒĞºĞ¸ ÑĞºÑ‰Ğ¾ Ğ²ÑĞµ Ğ¿Ñ€Ğ¾Ğ¹ÑˆĞ»Ğ¾ Ğ±ĞµĞ· Ğ¿Ğ¾Ğ¼Ğ¸Ğ»Ğ¾Ğº - Ñ„Ñ–ĞºÑÑƒÑ”Ğ¼Ğ¾ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ñ–Ñ
            db.commit()
            return new_order

        except Exception as e:
            # Ğ¯ĞºÑ‰Ğ¾ ÑÑ‚Ğ°Ğ»Ğ°ÑÑŒ Ğ‘Ğ£Ğ”Ğ¬-Ğ¯ĞšĞ Ğ¿Ğ¾Ğ¼Ğ¸Ğ»ĞºĞ° - Ğ²Ñ–Ğ´ĞºĞ¾Ñ‡ÑƒÑ”Ğ¼Ğ¾ Ğ²ÑĞµ (Ñ– ÑÑ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ½Ñ Ğ·Ğ°Ğ¼Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ Ñ‚ĞµĞ¶)
            db.rollback()
            print("âŒ ĞŸĞĞœĞ˜Ğ›ĞšĞ ĞŸĞ Ğ˜ ĞĞŸĞ›ĞĞ¢Ğ† (Transaction Rollback):")
            print(traceback.format_exc()) # Ğ’Ğ¸Ğ²ĞµĞ´Ğµ Ñ‚Ğ¾Ñ‡Ğ½Ñƒ Ğ¿Ñ€Ğ¸Ñ‡Ğ¸Ğ½Ñƒ Ğ² ĞºĞ¾Ğ½ÑĞ¾Ğ»ÑŒ Docker
            raise e # ĞŸÑ€Ğ¾ĞºĞ¸Ğ´ÑƒÑ”Ğ¼Ğ¾ Ğ¿Ğ¾Ğ¼Ğ¸Ğ»ĞºÑƒ Ğ´Ğ°Ğ»Ñ–, Ñ‰Ğ¾Ğ± API Ğ¿Ğ¾Ğ²ĞµÑ€Ğ½ÑƒĞ² 500

--------------------------------------------------
PATH: ./.history/product_service/services/order_service_20260123212328.py
--------------------------------------------------
from sqlalchemy.orm import Session
import models, schemas
from services.inventory_logger import InventoryLogger
import traceback # Ğ”Ğ»Ñ Ğ²Ğ¸Ğ²Ğ¾Ğ´Ñƒ Ğ¿Ğ¾Ğ¼Ğ¸Ğ»ĞºĞ¸ Ğ² ĞºĞ¾Ğ½ÑĞ¾Ğ»ÑŒ

class OrderService:
    """
    Ğ¦ĞµĞ¹ ĞºĞ»Ğ°Ñ Ğ²Ñ–Ğ´Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ°Ñ” Ğ²Ğ¸ĞºĞ»ÑÑ‡Ğ½Ğ¾ Ğ·Ğ° Ğ¾Ğ±Ñ€Ğ¾Ğ±ĞºÑƒ Ğ·Ğ°Ğ¼Ğ¾Ğ²Ğ»ĞµĞ½ÑŒ.
    Ğ ĞµĞ°Ğ»Ñ–Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ¾ Ğ¿Ñ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿ Atomic Transaction (Ğ²ÑĞµ Ğ°Ğ±Ğ¾ Ğ½Ñ–Ñ‡Ğ¾Ğ³Ğ¾).
    """
    @staticmethod
    def process_checkout(db: Session, order_data: schemas.OrderCreate):
        try:
            # 1. Ğ¡Ñ‚Ğ²Ğ¾Ñ€ÑÑ”Ğ¼Ğ¾ Ğ·Ğ°Ğ¼Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ
            new_order = models.Order(
                total_price=order_data.total_price,
                payment_method=order_data.payment_method,
                customer_id=order_data.customer_id
            )
            db.add(new_order)
            
            # Ğ’ĞĞ–Ğ›Ğ˜Ğ’Ğ: Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ flush(), Ğ° Ğ½Ğµ commit().
            # Ğ¦Ğµ Ğ´Ğ°Ñ” Ğ½Ğ°Ğ¼ ID Ğ·Ğ°Ğ¼Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ, Ğ°Ğ»Ğµ Ğ´Ğ¾Ğ·Ğ²Ğ¾Ğ»ÑÑ” Ğ²Ñ–Ğ´ĞºĞ¾Ñ‚Ğ¸Ñ‚Ğ¸ Ğ·Ğ¼Ñ–Ğ½Ğ¸, ÑĞºÑ‰Ğ¾ ÑÑ‚Ğ°Ñ”Ñ‚ÑŒÑÑ Ğ¿Ğ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ´Ğ°Ğ»Ñ–.
            db.flush() 
            db.refresh(new_order)

            transaction_reason = f"sale_order_{new_order.id}"

            # 2. ĞŸÑ€Ğ¾Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ÑÑŒ Ğ¿Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°Ñ…
            for item in order_data.items:
                product = db.query(models.Product).filter(models.Product.id == item.product_id).first()
                if not product: continue

                item_name = product.name
                price = product.price
                details_list = []
                
                target_recipe_id = None
                base_weight = 0.0

                # --- Ğ. Ğ’ĞĞ Ğ†ĞĞĞ¢Ğ˜ ---
                if item.variant_id:
                    variant = db.query(models.ProductVariant).filter(models.ProductVariant.id == item.variant_id).first()
                    if variant:
                        item_name = f"{product.name} ({variant.name})"
                        price = variant.price
                        details_list.append(f"Ğ’Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚: {variant.name}")
                        
                        target_recipe_id = variant.master_recipe_id or product.master_recipe_id
                        base_weight = variant.output_weight

                        # Ğ¡Ğ¿Ğ¸ÑĞ°Ğ½Ğ½Ñ Ğ·Ğ°Ğ»Ğ¸ÑˆĞºÑƒ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ
                        old_qty = variant.stock_quantity
                        variant.stock_quantity -= item.quantity
                        db.add(variant)
                        
                        InventoryLogger.log(
                            db, "product_variant", variant.id, item_name, 
                            old_qty, variant.stock_quantity, transaction_reason
                        )

                        # Ğ¡Ğ¿Ğ¸ÑĞ°Ğ½Ğ½Ñ Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ñ–Ğ² Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ
                        for vc in variant.consumables:
                            if vc.consumable:
                                c_old = vc.consumable.stock_quantity
                                deduction = vc.quantity * item.quantity
                                vc.consumable.stock_quantity -= deduction
                                db.add(vc.consumable)
                                InventoryLogger.log(db, "consumable", vc.consumable.id, vc.consumable.name, c_old, vc.consumable.stock_quantity, transaction_reason)

                        # !!! ĞĞĞ’Ğ•: Ğ¡Ğ¿Ğ¸ÑĞ°Ğ½Ğ½Ñ Ñ–Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ñ–Ğ² Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ !!!
                        # Ğ¯ĞºÑ‰Ğ¾ models.py Ğ½Ğµ Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾, Ñ‚ÑƒÑ‚ Ğ±ÑƒĞ´Ğµ Ğ¿Ğ¾Ğ¼Ğ¸Ğ»ĞºĞ° AttributeError.
                        # Ğ—Ğ°Ğ²Ğ´ÑĞºĞ¸ try/except Ğ¼Ğ¸ Ğ¿Ğ¾Ğ±Ğ°Ñ‡Ğ¸Ğ¼Ğ¾ Ñ†Ğµ Ğ² Ğ»Ğ¾Ğ³Ğ°Ñ…, Ğ° Ğ·Ğ°Ğ¼Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ Ğ½Ğµ ÑÑ‚Ğ²Ğ¾Ñ€Ğ¸Ñ‚ÑŒÑÑ.
                        if hasattr(variant, 'ingredients'):
                            for vi in variant.ingredients:
                                if vi.ingredient:
                                    i_old = vi.ingredient.stock_quantity
                                    deduction = vi.quantity * item.quantity
                                    vi.ingredient.stock_quantity -= deduction
                                    db.add(vi.ingredient)
                                    InventoryLogger.log(db, "ingredient", vi.ingredient.id, vi.ingredient.name, i_old, vi.ingredient.stock_quantity, transaction_reason)

                # --- Ğ‘. ĞŸĞ ĞĞ¡Ğ¢Ğ† Ğ¢ĞĞ’ĞĞ Ğ˜ ---
                else:
                    target_recipe_id = product.master_recipe_id
                    base_weight = product.output_weight
                    
                    if product.track_stock:
                        old_qty = product.stock_quantity
                        product.stock_quantity -= item.quantity
                        db.add(product)
                        InventoryLogger.log(db, "product", product.id, product.name, old_qty, product.stock_quantity, transaction_reason)

                # --- Ğ’. Ğ—ĞĞ“ĞĞ›Ğ¬ĞĞ† ĞœĞĞ¢Ğ•Ğ Ğ†ĞĞ›Ğ˜ ---
                for pc in product.consumables:
                    if pc.consumable:
                        c_old = pc.consumable.stock_quantity
                        deduction = pc.quantity * item.quantity
                        pc.consumable.stock_quantity -= deduction
                        db.add(pc.consumable)
                        InventoryLogger.log(db, "consumable", pc.consumable.id, pc.consumable.name, c_old, pc.consumable.stock_quantity, transaction_reason)

                # --- Ğ“. Ğ Ğ•Ğ¦Ğ•ĞŸĞ¢ ---
                if target_recipe_id:
                    recipe = db.query(models.MasterRecipe).filter(models.MasterRecipe.id == target_recipe_id).first()
                    if recipe:
                        for r_item in recipe.items:
                            if r_item.ingredient:
                                deduction_per_item = (r_item.quantity / 100.0 * base_weight) if r_item.is_percentage else r_item.quantity
                                total_deduction = deduction_per_item * item.quantity
                                i_old = r_item.ingredient.stock_quantity
                                r_item.ingredient.stock_quantity -= total_deduction
                                db.add(r_item.ingredient)
                                InventoryLogger.log(db, "ingredient", r_item.ingredient.id, r_item.ingredient.name, i_old, r_item.ingredient.stock_quantity, transaction_reason)

                # --- Ğ”. ĞœĞĞ”Ğ˜Ğ¤Ğ†ĞšĞĞ¢ĞĞ Ğ˜ ---
                for mod_item in item.modifiers:
                    mod = db.query(models.Modifier).filter(models.Modifier.id == mod_item.modifier_id).first()
                    if mod:
                        details_list.append(mod.name)
                        if mod.ingredient:
                            i_old = mod.ingredient.stock_quantity
                            deduction = mod.quantity * item.quantity
                            mod.ingredient.stock_quantity -= deduction
                            db.add(mod.ingredient)
                            InventoryLogger.log(db, "ingredient", mod.ingredient.id, mod.ingredient.name, i_old, mod.ingredient.stock_quantity, transaction_reason)

                # Ğ¤Ñ–ĞºÑÑƒÑ”Ğ¼Ğ¾ Ñ€ÑĞ´Ğ¾Ğº Ğ² Ñ‡ĞµĞºÑƒ
                db.add(models.OrderItem(
                    order_id=new_order.id,
                    product_name=item_name,
                    quantity=item.quantity,
                    price_at_moment=price,
                    details=", ".join(details_list)
                ))

            # 3. Ğ¢Ñ–Ğ»ÑŒĞºĞ¸ ÑĞºÑ‰Ğ¾ Ğ²ÑĞµ Ğ¿Ñ€Ğ¾Ğ¹ÑˆĞ»Ğ¾ Ğ±ĞµĞ· Ğ¿Ğ¾Ğ¼Ğ¸Ğ»Ğ¾Ğº - Ñ„Ñ–ĞºÑÑƒÑ”Ğ¼Ğ¾ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ñ–Ñ
            db.commit()
            return new_order

        except Exception as e:
            # Ğ¯ĞºÑ‰Ğ¾ ÑÑ‚Ğ°Ğ»Ğ°ÑÑŒ Ğ‘Ğ£Ğ”Ğ¬-Ğ¯ĞšĞ Ğ¿Ğ¾Ğ¼Ğ¸Ğ»ĞºĞ° - Ğ²Ñ–Ğ´ĞºĞ¾Ñ‡ÑƒÑ”Ğ¼Ğ¾ Ğ²ÑĞµ (Ñ– ÑÑ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ½Ñ Ğ·Ğ°Ğ¼Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ Ñ‚ĞµĞ¶)
            db.rollback()
            print("âŒ ĞŸĞĞœĞ˜Ğ›ĞšĞ ĞŸĞ Ğ˜ ĞĞŸĞ›ĞĞ¢Ğ† (Transaction Rollback):")
            print(traceback.format_exc()) # Ğ’Ğ¸Ğ²ĞµĞ´Ğµ Ñ‚Ğ¾Ñ‡Ğ½Ñƒ Ğ¿Ñ€Ğ¸Ñ‡Ğ¸Ğ½Ñƒ Ğ² ĞºĞ¾Ğ½ÑĞ¾Ğ»ÑŒ Docker
            raise e # ĞŸÑ€Ğ¾ĞºĞ¸Ğ´ÑƒÑ”Ğ¼Ğ¾ Ğ¿Ğ¾Ğ¼Ğ¸Ğ»ĞºÑƒ Ğ´Ğ°Ğ»Ñ–, Ñ‰Ğ¾Ğ± API Ğ¿Ğ¾Ğ²ĞµÑ€Ğ½ÑƒĞ² 500

--------------------------------------------------
PATH: ./.history/product_service/services/product_service_20260125184645.py
--------------------------------------------------
from sqlalchemy.orm import Session
from fastapi import HTTPException
import models
import schemas
import uuid

class ProductService:
    """
    ĞšĞ»Ğ°Ñ Ğ´Ğ»Ñ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»Ñ–Ğ½Ğ½Ñ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°Ğ¼Ğ¸.
    Ğ’ÑÑ Ğ»Ğ¾Ğ³Ñ–ĞºĞ° ÑÑ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ½Ñ (Create) Ñ‚Ğ° Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ (Update).
    """

    @staticmethod
    def create_product(db: Session, product: schemas.ProductCreate):
        # 1. Ğ¡Ğ¢Ğ’ĞĞ Ğ•ĞĞĞ¯ Ğ‘ĞĞ—ĞĞ’ĞĞ“Ğ Ğ¢ĞĞ’ĞĞ Ğ£
        db_product = models.Product(
            name=product.name, 
            price=product.price, 
            description=product.description,
            category_id=product.category_id, 
            has_variants=product.has_variants,
            master_recipe_id=product.master_recipe_id, 
            output_weight=product.output_weight,
            track_stock=product.track_stock,
            stock_quantity=product.stock_quantity
        )
        db.add(db_product)
        db.commit()
        db.refresh(db_product)

        # 2. Ğ”ĞĞ”ĞĞ’ĞĞĞĞ¯ Ğ’Ğ˜Ğ¢Ğ ĞĞ¢ĞĞ˜Ğ¥ ĞœĞĞ¢Ğ•Ğ Ğ†ĞĞ›Ğ†Ğ’ (Ğ—ĞĞ“ĞĞ›Ğ¬ĞĞ†)
        for cons in product.consumables:
            db.add(models.ProductConsumable(
                product_id=db_product.id, 
                consumable_id=cons.consumable_id, 
                quantity=cons.quantity
            ))

        # 3. Ğ¡Ğ¢Ğ’ĞĞ Ğ•ĞĞĞ¯ Ğ’ĞĞ Ğ†ĞĞĞ¢Ğ†Ğ’
        if product.has_variants and product.variants:
            for v in product.variants:
                sku = v.sku if v.sku else str(uuid.uuid4())
                
                db_variant = models.ProductVariant(
                    product_id=db_product.id, 
                    name=v.name, 
                    price=v.price, 
                    sku=sku,
                    master_recipe_id=v.master_recipe_id, 
                    output_weight=v.output_weight,
                    stock_quantity=v.stock_quantity 
                )
                db.add(db_variant)
                db.flush() 
                
                for vc in v.consumables:
                    db.add(models.ProductVariantConsumable(
                        variant_id=db_variant.id, 
                        consumable_id=vc.consumable_id, 
                        quantity=vc.quantity
                    ))
                
                for vi in v.ingredients:
                    db.add(models.ProductVariantIngredient(
                        variant_id=db_variant.id, 
                        ingredient_id=vi.ingredient_id, 
                        quantity=vi.quantity
                    ))

        # 4. ĞœĞĞ”Ğ˜Ğ¤Ğ†ĞšĞĞ¢ĞĞ Ğ˜
        for group in product.modifier_groups:
            db_group = models.ProductModifierGroup(
                product_id=db_product.id, 
                name=group.name, 
                is_required=group.is_required
            )
            db.add(db_group)
            db.flush()
            for mod in group.modifiers:
                db.add(models.Modifier(
                    group_id=db_group.id, 
                    name=mod.name, 
                    price_change=mod.price_change, 
                    ingredient_id=mod.ingredient_id, 
                    quantity=mod.quantity
                ))

        # 5. Ğ“Ğ Ğ£ĞŸĞ˜ ĞŸĞ ĞĞ¦Ğ•Ğ¡Ğ†Ğ’
        if product.process_group_ids:
            for pg_id in product.process_group_ids:
                pg = db.query(models.ProcessGroup).filter(
                    models.ProcessGroup.id == pg_id
                ).first()
                if pg:
                    db_product.process_groups.append(pg)

        db.commit()
        db.refresh(db_product)
        return db_product
    
    @staticmethod
    def update_product(db: Session, product_id: int, product_data: schemas.ProductCreate):
        db_product = db.query(models.Product).filter(models.Product.id == product_id).first()
        if not db_product:
            return None

        # 1. ĞĞ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¸Ñ… Ğ¿Ğ¾Ğ»Ñ–Ğ²
        db_product.name = product_data.name
        db_product.description = product_data.description
        db_product.price = product_data.price
        db_product.category_id = product_data.category_id
        db_product.has_variants = product_data.has_variants
        db_product.master_recipe_id = product_data.master_recipe_id
        db_product.output_weight = product_data.output_weight
        
        db_product.track_stock = product_data.track_stock
        if not product_data.track_stock:
             db_product.stock_quantity = product_data.stock_quantity

        # 2. ĞĞ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ñ–Ğ² (Consumables)
        db.query(models.ProductConsumable).filter(
            models.ProductConsumable.product_id == product_id
        ).delete()
        
        for cons in product_data.consumables:
            db.add(models.ProductConsumable(
                product_id=product_id, 
                consumable_id=cons.consumable_id, 
                quantity=cons.quantity
            ))

        # 3. ĞĞĞĞ’Ğ›Ğ•ĞĞĞ¯ Ğ’ĞĞ Ğ†ĞĞĞ¢Ğ†Ğ’
        if product_data.has_variants and product_data.variants:
            
            # [A] Ğ’Ğ˜Ğ”ĞĞ›Ğ•ĞĞĞ¯: Ğ—Ğ½Ğ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸, ÑĞºĞ¸Ñ… Ğ½ĞµĞ¼Ğ°Ñ” Ğ² Ğ½Ğ¾Ğ²Ğ¾Ğ¼Ñƒ ÑĞ¿Ğ¸ÑĞºÑƒ
            incoming_names = [v.name for v in product_data.variants]
            
            # Ğ—Ğ½Ğ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ Ğ¾Ğ±'Ñ”ĞºÑ‚Ğ¸, ÑĞºÑ– Ñ‚Ñ€ĞµĞ±Ğ° Ğ²Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğ¸
            variants_to_delete = db.query(models.ProductVariant).filter(
               models.ProductVariant.product_id == product_id,
               models.ProductVariant.name.notin_(incoming_names)
            ).all()

            # --- Ğ’Ğ˜ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞĞ¯: Ğ‘ĞµĞ·Ğ¿ĞµÑ‡Ğ½Ğµ Ğ²Ğ¸Ğ´Ğ°Ğ»ĞµĞ½Ğ½Ñ ---
            for variant in variants_to_delete:
                # Ğ¡Ğ¿Ğ¾Ñ‡Ğ°Ñ‚ĞºÑƒ Ğ²Ğ¸Ğ´Ğ°Ğ»ÑÑ”Ğ¼Ğ¾ Ğ·Ğ°Ğ»ĞµĞ¶Ğ½Ğ¾ÑÑ‚Ñ– (Ğ´Ñ–Ñ‚ĞµĞ¹)
                db.query(models.ProductVariantConsumable).filter(
                    models.ProductVariantConsumable.variant_id == variant.id
                ).delete()
                
                db.query(models.ProductVariantIngredient).filter(
                    models.ProductVariantIngredient.variant_id == variant.id
                ).delete()
                
                # Ğ¢ĞµĞ¿ĞµÑ€ Ğ¼Ğ¾Ğ¶Ğ½Ğ° Ğ²Ğ¸Ğ´Ğ°Ğ»ÑÑ‚Ğ¸ ÑĞ°Ğ¼ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚
                db.delete(variant)
            # --------------------------------------

            # [B] ĞĞĞĞ’Ğ›Ğ•ĞĞĞ¯ Ğ°Ğ±Ğ¾ Ğ¡Ğ¢Ğ’ĞĞ Ğ•ĞĞĞ¯
            for v in product_data.variants:
                db_variant = db.query(models.ProductVariant).filter(
                    models.ProductVariant.product_id == product_id,
                    models.ProductVariant.name == v.name
                ).first()

                if db_variant:
                    # ĞĞ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾
                    db_variant.price = v.price
                    db_variant.master_recipe_id = v.master_recipe_id
                    db_variant.output_weight = v.output_weight
                    db_variant.stock_quantity = v.stock_quantity
                else:
                    # Ğ¡Ñ‚Ğ²Ğ¾Ñ€ÑÑ”Ğ¼Ğ¾
                    sku = v.sku if v.sku else str(uuid.uuid4())
                    db_variant = models.ProductVariant(
                        product_id=product_id,
                        name=v.name,
                        price=v.price,
                        sku=sku,
                        master_recipe_id=v.master_recipe_id,
                        output_weight=v.output_weight,
                        stock_quantity=v.stock_quantity
                    )
                    db.add(db_variant)
                
                db.flush() 

                # [C] ĞÑ‡Ğ¸Ñ‰Ğ°Ñ”Ğ¼Ğ¾ Ñ‚Ğ° Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿Ğ¸ÑÑƒÑ”Ğ¼Ğ¾ ÑĞºĞ»Ğ°Ğ´ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ
                db.query(models.ProductVariantConsumable).filter(
                    models.ProductVariantConsumable.variant_id == db_variant.id
                ).delete()

                db.query(models.ProductVariantIngredient).filter(
                    models.ProductVariantIngredient.variant_id == db_variant.id
                ).delete()

                for vc in v.consumables:
                    db.add(models.ProductVariantConsumable(
                        variant_id=db_variant.id, 
                        consumable_id=vc.consumable_id, 
                        quantity=vc.quantity
                    ))
                
                for vi in v.ingredients:
                    db.add(models.ProductVariantIngredient(
                        variant_id=db_variant.id, 
                        ingredient_id=vi.ingredient_id, 
                        quantity=vi.quantity
                    ))
        else:
            # Ğ¯ĞºÑ‰Ğ¾ Ğ·Ğ½ÑĞ»Ğ¸ Ğ³Ğ°Ğ»Ğ¾Ñ‡ĞºÑƒ "Ğ’Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸" - Ğ²Ğ¸Ğ´Ğ°Ğ»ÑÑ”Ğ¼Ğ¾ Ğ²ÑĞµ
            # Ğ¢ÑƒÑ‚ Ñ‚ĞµĞ¶ Ñ‚Ñ€ĞµĞ±Ğ° Ğ±ĞµĞ·Ğ¿ĞµÑ‡Ğ½Ğµ Ğ²Ğ¸Ğ´Ğ°Ğ»ĞµĞ½Ğ½Ñ, ÑĞºÑ‰Ğ¾ Ñƒ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñ–Ğ² Ñ” Ğ´Ñ–Ñ‚Ğ¸
            all_variants = db.query(models.ProductVariant).filter(
                models.ProductVariant.product_id == product_id
            ).all()
            
            for variant in all_variants:
                db.query(models.ProductVariantConsumable).filter_by(variant_id=variant.id).delete()
                db.query(models.ProductVariantIngredient).filter_by(variant_id=variant.id).delete()
                db.delete(variant)

        # 4. ĞœĞĞ”Ğ˜Ğ¤Ğ†ĞšĞĞ¢ĞĞ Ğ˜
        db.query(models.ProductModifierGroup).filter(
            models.ProductModifierGroup.product_id == product_id
        ).delete()
        
        for group in product_data.modifier_groups:
            db_group = models.ProductModifierGroup(
                product_id=product_id, 
                name=group.name, 
                is_required=group.is_required
            )
            db.add(db_group)
            db.flush()
            for mod in group.modifiers:
                db.add(models.Modifier(
                    group_id=db_group.id, 
                    name=mod.name, 
                    price_change=mod.price_change, 
                    ingredient_id=mod.ingredient_id, 
                    quantity=mod.quantity
                ))

        # 5. ĞŸĞ ĞĞ¦Ğ•Ğ¡Ğ˜
        db_product.process_groups = [] 
        if product_data.process_group_ids:
            for pg_id in product_data.process_group_ids:
                pg = db.query(models.ProcessGroup).filter(
                    models.ProcessGroup.id == pg_id
                ).first()
                if pg:
                    db_product.process_groups.append(pg)

        db.commit()
        db.refresh(db_product)
        return db_product

--------------------------------------------------
PATH: ./.history/product_service/services/inventory_logger_20260118195317.py
--------------------------------------------------
from sqlalchemy.orm import Session
import models

class InventoryLogger:
    @staticmethod
    def log(db: Session, entity_type: str, entity_id: int, entity_name: str, old_balance: float, new_balance: float, reason: str = "manual_update"):
        """
        Ğ£Ğ½Ñ–Ğ²ĞµÑ€ÑĞ°Ğ»ÑŒĞ½Ğ° Ñ„ÑƒĞ½ĞºÑ†Ñ–Ñ Ğ·Ğ°Ğ¿Ğ¸ÑÑƒ Ñ–ÑÑ‚Ğ¾Ñ€Ñ–Ñ—.
        change Ğ¾Ğ±Ñ‡Ğ¸ÑĞ»ÑÑ”Ñ‚ÑŒÑÑ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡Ğ½Ğ¾.
        """
        change = new_balance - old_balance
        
        # Ğ¯ĞºÑ‰Ğ¾ Ğ·Ğ¼Ñ–Ğ½ Ğ½ĞµĞ¼Ğ°Ñ” (Ğ½Ğ°Ğ¿Ñ€Ğ¸ĞºĞ»Ğ°Ğ´, Ğ·Ğ±ĞµÑ€ĞµĞ³Ğ»Ğ¸ Ñ‚Ğµ ÑĞ°Ğ¼Ğµ Ñ‡Ğ¸ÑĞ»Ğ¾), Ğ½Ğµ Ğ¿Ğ¸ÑˆĞµĞ¼Ğ¾
        if change == 0:
            return

        transaction = models.InventoryTransaction(
            entity_type=entity_type,
            entity_id=entity_id,
            entity_name=entity_name,
            change_amount=change,
            balance_after=new_balance,
            reason=reason
        )
        db.add(transaction)
        # db.commit() Ğ¼Ğ¸ Ñ‚ÑƒÑ‚ Ğ½Ğµ Ñ€Ğ¾Ğ±Ğ¸Ğ¼Ğ¾, Ğ±Ğ¾ Ñ†ĞµĞ¹ Ğ¼ĞµÑ‚Ğ¾Ğ´ Ğ·Ğ°Ğ·Ğ²Ğ¸Ñ‡Ğ°Ğ¹ Ğ²Ğ¸ĞºĞ»Ğ¸ĞºĞ°Ñ”Ñ‚ÑŒÑÑ Ğ²ÑĞµÑ€ĞµĞ´Ğ¸Ğ½Ñ– Ñ–Ğ½ÑˆĞ¾Ñ— Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ñ–Ñ—

--------------------------------------------------
PATH: ./.history/product_service/services/inventory_logger_20260126180651.py
--------------------------------------------------
from sqlalchemy.orm import Session
import models
from datetime import datetime

class InventoryLogger:
    @staticmethod
    def log(db: Session, entity_type: str, entity_id: int, entity_name: str, old_balance: float, new_balance: float, reason: str = "manual"):
        change = new_balance - old_balance
        if change == 0: return

        transaction = models.InventoryTransaction(
            entity_type=entity_type,
            entity_id=entity_id,
            entity_name=entity_name,
            change_amount=change,
            balance_after=new_balance,
            reason=reason,
            created_at=datetime.utcnow()
        )
        db.add(transaction)

--------------------------------------------------
PATH: ./order_service/requirements.txt
--------------------------------------------------
fastapi
uvicorn
redis
pydantic


--------------------------------------------------
PATH: ./order_service/schemas.py
--------------------------------------------------
from pydantic import BaseModel
from typing import List, Optional

class ModifierItem(BaseModel):
    modifier_id: int

class CartItemCreate(BaseModel):
    product_id: int
    variant_id: Optional[int] = None
    modifiers: List[ModifierItem] = []
    quantity: int = 1
    # ĞœĞ¸ Ğ¿ĞµÑ€ĞµĞ´Ğ°Ñ”Ğ¼Ğ¾ Ñ†Ñ– Ğ´Ğ°Ğ½Ñ– Ğ· Ñ„Ñ€Ğ¾Ğ½Ñ‚Ñƒ, Ñ‰Ğ¾Ğ± ĞºĞ¾ÑˆĞ¸Ğº Ğ½Ğµ Ñ€Ğ¾Ğ±Ğ¸Ğ² Ğ·Ğ°Ğ¿Ğ¸Ñ‚Ñ–Ğ² Ğ´Ğ¾ Product Service (ÑˆĞ²Ğ¸Ğ´ĞºĞ¾Ğ´Ñ–Ñ)
    name: str 
    price: float

class CartItem(CartItemCreate):
    cart_item_id: str # Ğ£Ğ½Ñ–ĞºĞ°Ğ»ÑŒĞ½Ğ¸Ğ¹ ID ÑĞ°Ğ¼Ğµ Ñ†ÑŒĞ¾Ğ³Ğ¾ Ñ€ÑĞ´ĞºĞ° Ğ² ĞºĞ¾ÑˆĞ¸ĞºÑƒ (UUID)

--------------------------------------------------
PATH: ./order_service/main.py
--------------------------------------------------
from fastapi import FastAPI, HTTPException
from fastapi.middleware.cors import CORSMiddleware
import redis
import os
import json
import uuid
from typing import List
from schemas import CartItemCreate, CartItem # Ğ†Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ÑƒÑ”Ğ¼Ğ¾ ÑÑ…ĞµĞ¼Ğ¸

app = FastAPI()

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

REDIS_HOST = os.getenv("REDIS_HOST", "pos_redis")
REDIS_PORT = int(os.getenv("REDIS_PORT", 6379))

# decode_responses=True ĞµĞºĞ¾Ğ½Ğ¾Ğ¼Ğ¸Ñ‚ÑŒ Ğ½Ğ°Ğ¼ Ñ‡Ğ°Ñ Ğ½Ğ° Ğ´ĞµĞºĞ¾Ğ´ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ±Ğ°Ğ¹Ñ‚Ñ–Ğ²
r = redis.Redis(host=REDIS_HOST, port=REDIS_PORT, db=0, decode_responses=True)
CART_KEY = "pos_cart_v2" # Ğ—Ğ¼Ñ–Ğ½Ğ¸Ğ¼Ğ¾ ĞºĞ»ÑÑ‡, Ñ‰Ğ¾Ğ± Ğ½Ğµ ĞºĞ¾Ğ½Ñ„Ğ»Ñ–ĞºÑ‚ÑƒĞ²Ğ°Ñ‚Ğ¸ Ğ·Ñ– ÑÑ‚Ğ°Ñ€Ğ¸Ğ¼

@app.get("/")
def read_root():
    return {"message": "Advanced Order Service is running!"}

# --- ĞĞ¢Ğ Ğ˜ĞœĞĞ¢Ğ˜ ĞšĞĞ¨Ğ˜Ğš ---
@app.get("/cart/", response_model=List[CartItem])
def get_cart():
    # ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ğ²ÑÑ– Ğ´Ğ°Ğ½Ñ– Ğ· Ñ…ĞµÑˆÑƒ
    raw_data = r.hgetall(CART_KEY)
    cart_items = []
    
    for key, value in raw_data.items():
        try:
            item = json.loads(value)
            cart_items.append(item)
        except json.JSONDecodeError:
            continue
            
    return cart_items

# --- Ğ”ĞĞ”ĞĞ¢Ğ˜ Ğ¢ĞĞ’ĞĞ  ---
@app.post("/cart/add", response_model=CartItem)
def add_item(item_data: CartItemCreate):
    # Ğ“ĞµĞ½ĞµÑ€ÑƒÑ”Ğ¼Ğ¾ ÑƒĞ½Ñ–ĞºĞ°Ğ»ÑŒĞ½Ğ¸Ğ¹ ID Ğ´Ğ»Ñ Ñ†ÑŒĞ¾Ğ³Ğ¾ Ğ·Ğ°Ğ¿Ğ¸ÑÑƒ Ğ² ĞºĞ¾ÑˆĞ¸ĞºÑƒ
    # Ğ¦Ğµ Ğ´Ğ¾Ğ·Ğ²Ğ¾Ğ»ÑÑ” Ğ¼Ğ°Ñ‚Ğ¸ Ğ´Ğ²Ğ° Ğ¾Ğ´Ğ½Ğ°ĞºĞ¾Ğ²Ğ¸Ñ… Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¸ Ğ· Ñ€Ñ–Ğ·Ğ½Ğ¸Ğ¼Ğ¸ Ğ¼Ğ¾Ğ´Ğ¸Ñ„Ñ–ĞºĞ°Ñ‚Ğ¾Ñ€Ğ°Ğ¼Ğ¸
    cart_item_id = str(uuid.uuid4())
    
    new_item = CartItem(
        cart_item_id=cart_item_id,
        **item_data.dict()
    )
    
    # Ğ—Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ñ”Ğ¼Ğ¾ JSON Ğ² Redis: Key=UUID, Value=JSON String
    r.hset(CART_KEY, cart_item_id, json.dumps(new_item.dict()))
    
    return new_item

# --- Ğ—ĞœĞ†ĞĞ˜Ğ¢Ğ˜ ĞšĞ†Ğ›Ğ¬ĞšĞ†Ğ¡Ğ¢Ğ¬ (+/-) ---
@app.post("/cart/{cart_item_id}/update")
def update_quantity(cart_item_id: str, change: int):
    raw_json = r.hget(CART_KEY, cart_item_id)
    if not raw_json:
        raise HTTPException(status_code=404, detail="Item not found")
        
    item = json.loads(raw_json)
    new_qty = item['quantity'] + change
    
    if new_qty <= 0:
        # Ğ¯ĞºÑ‰Ğ¾ ĞºÑ–Ğ»ÑŒĞºÑ–ÑÑ‚ÑŒ <= 0, Ğ²Ğ¸Ğ´Ğ°Ğ»ÑÑ”Ğ¼Ğ¾
        r.hdel(CART_KEY, cart_item_id)
        return {"status": "removed", "cart_item_id": cart_item_id}
    else:
        # ĞĞ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ ĞºÑ–Ğ»ÑŒĞºÑ–ÑÑ‚ÑŒ
        item['quantity'] = new_qty
        r.hset(CART_KEY, cart_item_id, json.dumps(item))
        return {"status": "updated", "quantity": new_qty}

# --- Ğ’Ğ˜Ğ”ĞĞ›Ğ˜Ğ¢Ğ˜ Ğ¢ĞĞ’ĞĞ  ---
@app.delete("/cart/{cart_item_id}")
def remove_item(cart_item_id: str):
    r.hdel(CART_KEY, cart_item_id)
    return {"status": "removed"}

# --- ĞĞ§Ğ˜Ğ¡Ğ¢Ğ˜Ğ¢Ğ˜ ĞšĞĞ¨Ğ˜Ğš ---
@app.delete("/cart/")
def clear_cart():
    r.delete(CART_KEY)
    return {"status": "cleared"}

--------------------------------------------------
PATH: ./order_service/Dockerfile
--------------------------------------------------
FROM python:3.9-slim

WORKDIR /app

# ĞšĞ¾Ğ¿Ñ–ÑÑ”Ğ¼Ğ¾ requirements Ñ– Ğ²ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ·Ğ°Ğ»ĞµĞ¶Ğ½Ğ¾ÑÑ‚Ñ–
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# --- Ğ’Ğ˜ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞĞ¯ Ğ¢Ğ£Ğ¢ ---
# ĞšĞ¾Ğ¿Ñ–ÑÑ”Ğ¼Ğ¾ Ğ’Ğ¡Ğ† Ñ„Ğ°Ğ¹Ğ»Ğ¸ Ğ· Ğ¿Ğ¾Ñ‚Ğ¾Ñ‡Ğ½Ğ¾Ñ— Ğ¿Ğ°Ğ¿ĞºĞ¸ (main.py, schemas.py Ñ– Ñ‚.Ğ´.)
COPY . .

CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]

--------------------------------------------------
PATH: ./frontend/index.html
--------------------------------------------------
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HITS-POS</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  </head>
  <body>
    <div id="app"></div>
    <script type="module" src="/src/main.js"></script>
  </body>
</html>

--------------------------------------------------
PATH: ./frontend/vite.config.js
--------------------------------------------------
import { fileURLToPath, URL } from 'node:url'
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'

// https://vitejs.dev/config/
export default defineConfig({
  plugins: [
    vue(),
  ],
  resolve: {
    alias: {
      '@': fileURLToPath(new URL('./src', import.meta.url))
    }
  },
  server: {
    host: '0.0.0.0',
    port: 5173,
    proxy: {
      // 1. Ğ—Ğ°Ğ¿Ğ¸Ñ‚Ğ¸ Ğ´Ğ¾ ĞšĞĞ¨Ğ˜ĞšĞ Ğ¹Ğ´ÑƒÑ‚ÑŒ Ğ½Ğ° order_service (8000)
      '/api/cart': {
        target: 'http://order_service:8000',
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/api/, '') 
      },
      // 2. Ğ’ÑÑ– Ñ–Ğ½ÑˆÑ– Ğ·Ğ°Ğ¿Ğ¸Ñ‚Ğ¸ (Categories, Units, Products) Ğ¹Ğ´ÑƒÑ‚ÑŒ Ğ½Ğ° product_service (8001)
      '/api': {
        target: 'http://product_service:8000', // Ğ’ÑĞµÑ€ĞµĞ´Ğ¸Ğ½Ñ– Docker Ğ¼ĞµÑ€ĞµĞ¶Ñ– Ğ²Ğ¾Ğ½Ğ¸ Ğ²ÑÑ– ÑĞ»ÑƒÑ…Ğ°ÑÑ‚ÑŒ 8000
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/api/, '')
      }
    }
  }
})

--------------------------------------------------
PATH: ./frontend/README.md
--------------------------------------------------
# Vue 3 + Vite

This template should help get you started developing with Vue 3 in Vite. The template uses Vue 3 `<script setup>` SFCs, check out the [script setup docs](https://v3.vuejs.org/api/sfc-script-setup.html#sfc-script-setup) to learn more.

Learn more about IDE Support for Vue in the [Vue Docs Scaling up Guide](https://vuejs.org/guide/scaling-up/tooling.html#ide-support).


--------------------------------------------------
PATH: ./frontend/package.json
--------------------------------------------------
{
  "name": "frontend",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "axios": "^1.7.0",
    "vue": "^3.5.24"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4.1.18",
    "@vitejs/plugin-vue": "^6.0.1",
    "autoprefixer": "^10.4.17",
    "postcss": "^8.4.33",
    "tailwindcss": "^3.4.17",
    "vite": "^7.2.4"
  }
}


--------------------------------------------------
PATH: ./frontend/postcss.config.js
--------------------------------------------------
export default {
  plugins: {
    tailwindcss: {}, // ĞÑ–ÑĞºĞ¸Ñ… ÑĞ¾Ğ±Ğ°Ñ‡Ğ¾Ğº @tailwindcss/postcss! ĞŸÑ€Ğ¾ÑÑ‚Ğ¾ tailwindcss.
    autoprefixer: {},
  },
}

--------------------------------------------------
PATH: ./frontend/Dockerfile
--------------------------------------------------
# --- Ğ•Ğ¢ĞĞŸ 1: Ğ—Ğ±Ñ–Ñ€ĞºĞ° (Build) ---
# Ğ’Ğ˜ĞšĞĞ Ğ˜Ğ¡Ğ¢ĞĞ’Ğ£Ğ„ĞœĞ Ğ’Ğ•Ğ Ğ¡Ğ†Ğ® 22, Ğ±Ğ¾ Vite 6/7 Ñ†ÑŒĞ¾Ğ³Ğ¾ Ğ²Ğ¸Ğ¼Ğ°Ğ³Ğ°Ñ”
FROM node:22-alpine AS build-stage

WORKDIR /app

COPY package*.json ./

RUN npm install

COPY . .

RUN npm run build

# --- Ğ•Ğ¢ĞĞŸ 2: ĞŸÑ€Ğ¾Ğ´Ğ°ĞºÑˆĞ½ (Nginx) ---
FROM nginx:alpine AS production-stage

COPY --from=build-stage /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]

--------------------------------------------------
PATH: ./frontend/tailwind.config.js
--------------------------------------------------
/** @type {import('tailwindcss').Config} */
export default {
  content: [
    "./index.html",
    "./src/**/*.{vue,js,ts,jsx,tsx}",
  ],
  theme: {
    extend: {},
  },
  plugins: [],
}

--------------------------------------------------
PATH: ./frontend/src/App.vue
--------------------------------------------------
<script setup>
import { ref, onMounted } from 'vue'
// --- Ğ†Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ÑƒÑ”Ğ¼Ğ¾ ĞĞĞ’Ğ† ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ¸ ---
import Sidebar from '@/components/common/Sidebar.vue'
import ProductCard from '@/components/pos/ProductCard.vue'
import CartDrawer from '@/components/pos/CartDrawer.vue'
import ProductModal from '@/components/pos/ProductModal.vue'

// --- Ğ†Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ÑƒÑ”Ğ¼Ğ¾ Ğ²ĞµĞ»Ğ¸ĞºÑ– Ñ€Ğ¾Ğ·Ğ´Ñ–Ğ»Ğ¸ ---
import Warehouse from '@/components/warehouse/Warehouse.vue'
import Statistics from '@/components/stats/Statistics.vue'
import Customers from '@/components/crm/Customers.vue'

// --- Ğ†Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ÑƒÑ”Ğ¼Ğ¾ Ğ»Ğ¾Ğ³Ñ–ĞºÑƒ (Composables) ---
import { useProducts } from '@/composables/useProducts'
import { useCart } from '@/composables/useCart'

// Ğ¡Ñ‚Ğ°Ğ½ Ğ½Ğ°Ğ²Ñ–Ğ³Ğ°Ñ†Ñ–Ñ—
const currentPage = ref('pos')

// --- Ğ›Ğ¾Ğ³Ñ–ĞºĞ° POS (ĞšĞ°ÑĞ¸) ---
// Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ useProducts Ğ´Ğ»Ñ Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ–Ğ² Ğ½Ğ° Ğ²Ñ–Ñ‚Ñ€Ğ¸Ğ½Ñƒ
const { 
  filteredProducts, // Ğ’Ğ¶Ğµ Ğ²Ñ–Ğ´Ñ„Ñ–Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ– Ğ¿Ğ¾ÑˆÑƒĞºĞ¾Ğ¼
  productSearch, 
  fetchProducts 
} = useProducts()

// Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ useCart Ğ´Ğ»Ñ ĞºĞ¾ÑˆĞ¸ĞºĞ° (Ğ»Ñ–Ñ‡Ğ¸Ğ»ÑŒĞ½Ğ¸Ğº, Ğ²Ñ–Ğ´ĞºÑ€Ğ¸Ñ‚Ñ‚Ñ)
const { 
  cartCount, 
  fetchCart // Ğ©Ğ¾Ğ± Ğ¾Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğ¸ Ğ»Ñ–Ñ‡Ğ¸Ğ»ÑŒĞ½Ğ¸Ğº Ğ¿Ñ€Ğ¸ ÑÑ‚Ğ°Ñ€Ñ‚Ñ–
} = useCart()

// Ğ¡Ñ‚Ğ°Ğ½ Ğ´Ğ»Ñ UI ĞºĞ°ÑĞ¸
const isCartOpen = ref(false)
const isModalOpen = ref(false)
const selectedProduct = ref(null)

// ĞĞ±Ñ€Ğ¾Ğ±ĞºĞ° ĞºĞ»Ñ–ĞºÑƒ Ğ¿Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ
const handleProductClick = (product) => {
  // Ğ¯ĞºÑ‰Ğ¾ Ñ” Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸ Ğ°Ğ±Ğ¾ Ğ¼Ğ¾Ğ´Ğ¸Ñ„Ñ–ĞºĞ°Ñ‚Ğ¾Ñ€Ğ¸ -> Ğ²Ñ–Ğ´ĞºÑ€Ğ¸Ğ²Ğ°Ñ”Ğ¼Ğ¾ Ğ¼Ğ¾Ğ´Ğ°Ğ»ĞºÑƒ
  if (product.has_variants || (product.modifier_groups && product.modifier_groups.length > 0) || (product.process_groups && product.process_groups.length > 0)) {
    selectedProduct.value = product
    isModalOpen.value = true
  } else {
    // Ğ¯ĞºÑ‰Ğ¾ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¸Ğ¹ Ñ‚Ğ¾Ğ²Ğ°Ñ€ -> Ğ´Ğ¾Ğ´Ğ°Ñ”Ğ¼Ğ¾ Ğ² ĞºĞ¾ÑˆĞ¸Ğº (Ñ‡ĞµÑ€ĞµĞ· ProductModal Ğ»Ğ¾Ğ³Ñ–ĞºÑƒ Ğ°Ğ±Ğ¾ Ğ½Ğ°Ğ¿Ñ€ÑĞ¼Ñƒ, 
    // Ğ°Ğ»Ğµ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾Ñ‚Ğ¸ Ğ²Ñ–Ğ´ĞºÑ€Ğ¸Ñ”Ğ¼Ğ¾ Ğ¼Ğ¾Ğ´Ğ°Ğ»ĞºÑƒ Ğ°Ğ±Ğ¾ Ğ¼Ğ¾Ğ¶Ğ½Ğ° Ğ²Ğ¸ĞºĞ»Ğ¸ĞºĞ°Ñ‚Ğ¸ addToCart Ğ½Ğ°Ğ¿Ñ€ÑĞ¼Ñƒ.
    // Ğ¢ÑƒÑ‚ ĞºÑ€Ğ°Ñ‰Ğµ Ğ²Ñ–Ğ´ĞºÑ€Ğ¸Ñ‚Ğ¸ Ğ¼Ğ¾Ğ´Ğ°Ğ»ĞºÑƒ Ğ´Ğ»Ñ Ğ¿Ñ–Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¶ĞµĞ½Ğ½Ñ Ğ°Ğ±Ğ¾ ÑˆĞ²Ğ¸Ğ´ĞºĞ¾Ğ³Ğ¾ Ğ´Ğ¾Ğ´Ğ°Ğ²Ğ°Ğ½Ğ½Ñ)
    selectedProduct.value = product
    isModalOpen.value = true
  }
}

// Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ´Ğ°Ğ½Ğ¸Ñ… Ğ¿Ñ€Ğ¸ ÑÑ‚Ğ°Ñ€Ñ‚Ñ–
onMounted(() => {
  fetchProducts()
  fetchCart()
})
</script>

<template>
  <div class="flex h-screen bg-gray-50 text-gray-800 font-sans overflow-hidden">
    <Sidebar :current-page="currentPage" @change-page="(page) => currentPage = page" />

    <main v-if="currentPage === 'pos'" class="flex-1 ml-64 flex flex-col h-screen relative">
      <header class="bg-white/80 backdrop-blur-md sticky top-0 z-10 border-b border-gray-200 px-8 py-4 flex justify-between items-center">
        <div>
          <h2 class="text-2xl font-bold text-gray-800">ĞœĞµĞ½Ñ</h2>
          <div class="flex items-center gap-2 mt-1">
             <i class="fas fa-search text-gray-400"></i>
             <input v-model="productSearch" type="text" placeholder="ĞŸĞ¾ÑˆÑƒĞº ĞºĞ°Ğ²Ğ¸..." class="bg-transparent outline-none text-sm w-64">
          </div>
        </div>
        
        <button @click="isCartOpen = true" class="bg-gray-900 text-white px-6 py-3 rounded-xl font-bold hover:bg-gray-800 transition shadow-lg flex items-center gap-3 active:scale-95">
          <i class="fas fa-shopping-cart"></i> <span>ĞšĞ¾ÑˆĞ¸Ğº: {{ cartCount }}</span>
        </button>
      </header>

      <div class="p-8 overflow-y-auto flex-1 custom-scrollbar">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-6">
          <ProductCard 
            v-for="item in filteredProducts" 
            :key="item.id" 
            :product="item" 
            @click="handleProductClick" 
          />
        </div>
        
        <div v-if="filteredProducts.length === 0" class="text-center text-gray-400 mt-20">
            <i class="fas fa-mug-hot text-6xl mb-4 opacity-20"></i>
            <p>Ğ¢Ğ¾Ğ²Ğ°Ñ€Ñ–Ğ² Ğ½Ğµ Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾</p>
        </div>
      </div>

      <CartDrawer 
        :is-open="isCartOpen"
        @close="isCartOpen = false"
      />
      
      <ProductModal 
        :is-open="isModalOpen"
        :product="selectedProduct"
        @close="isModalOpen = false"
      />
    </main>

    <Warehouse v-if="currentPage === 'warehouse'" />

    <Statistics v-if="currentPage === 'statistics'" />

    <Customers v-if="currentPage === 'customers'" />
    
  </div>
</template>

--------------------------------------------------
PATH: ./frontend/src/style.css
--------------------------------------------------
@tailwind base;
@tailwind components;
@tailwind utilities;


--------------------------------------------------
PATH: ./frontend/src/main.js
--------------------------------------------------
import { createApp } from 'vue'
import './style.css'
import App from './App.vue'

createApp(App).mount('#app')


--------------------------------------------------
PATH: ./frontend/src/components/common/Sidebar.vue
--------------------------------------------------
<script setup>
import { computed } from 'vue'

const props = defineProps({
  currentPage: { type: String, required: true }
})

const emit = defineEmits(['change-page'])

// ĞšĞ¾Ğ½Ñ„Ñ–Ğ³ÑƒÑ€Ğ°Ñ†Ñ–Ñ Ğ¼ĞµĞ½Ñ. Ğ›ĞµĞ³ĞºĞ¾ Ñ€Ğ¾Ğ·ÑˆĞ¸Ñ€ÑĞ²Ğ°Ñ‚Ğ¸.
const menuItems = [
  { 
    id: 'pos', 
    label: 'ĞšĞ°ÑĞ°', 
    icon: 'fas fa-cash-register', 
    activeClass: 'text-yellow-400 border-l-4 border-yellow-400 bg-gray-800' 
  },
  { 
    id: 'warehouse', 
    label: 'Ğ¡ĞºĞ»Ğ°Ğ´', 
    icon: 'fas fa-boxes', 
    activeClass: 'text-blue-400 border-l-4 border-blue-400 bg-gray-800' 
  },
  { 
    id: 'customers', 
    label: 'ĞšĞ»Ñ–Ñ”Ğ½Ñ‚Ğ¸', 
    icon: 'fas fa-users', 
    activeClass: 'text-green-400 border-l-4 border-green-400 bg-gray-800' 
  },
  { 
    id: 'statistics', 
    label: 'Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°', 
    icon: 'fas fa-chart-line', 
    activeClass: 'text-purple-400 border-l-4 border-purple-400 bg-gray-800' 
  }
]

const navigate = (pageId) => {
  emit('change-page', pageId)
}
</script>

<template>
  <aside class="w-64 bg-gray-900 text-white flex flex-col h-screen fixed left-0 top-0 border-r border-gray-800 z-50">
    
    <div class="p-6 text-2xl font-bold text-center border-b border-gray-800 flex items-center justify-center gap-2">
      <div class="w-8 h-8 bg-gradient-to-tr from-yellow-400 to-orange-500 rounded-full"></div>
      HITS POS
    </div>

    <nav class="flex-1 py-6 space-y-1">
      <a 
        v-for="item in menuItems" 
        :key="item.id"
        href="#" 
        @click.prevent="navigate(item.id)"
        class="flex items-center px-6 py-3 font-bold transition-all group"
        :class="currentPage === item.id ? item.activeClass : 'text-gray-400 hover:bg-gray-800 hover:text-white'"
      >
        <i 
          :class="[item.icon, 'w-6 text-center mr-2 transition-transform', currentPage !== item.id && 'group-hover:scale-110']"
        ></i> 
        {{ item.label }}
      </a>
    </nav>

    <div class="p-4 border-t border-gray-800 text-xs text-gray-500 text-center">
      <p>Server: <span class="text-green-500">Online ğŸŸ¢</span></p>
    </div>
  </aside>
</template>

--------------------------------------------------
PATH: ./frontend/src/components/common/IngredientSelect.vue
--------------------------------------------------
<script setup>
import { ref, computed, onMounted, onUnmounted } from 'vue'

const props = defineProps({
  modelValue: [String, Number], // ID Ñ–Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ğ°
  ingredients: { type: Array, default: () => [] },
  placeholder: { type: String, default: 'ĞĞ±ĞµÑ€Ñ–Ñ‚ÑŒ Ñ–Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚...' }
})

const emit = defineEmits(['update:modelValue'])

const isOpen = ref(false)
const searchQuery = ref('')
const containerRef = ref(null)

const selectedName = computed(() => {
  if (!props.modelValue) return ''
  const found = props.ingredients.find(i => i.id === props.modelValue)
  return found ? found.name : ''
})

const filteredList = computed(() => {
  if (!searchQuery.value) return props.ingredients
  const lower = searchQuery.value.toLowerCase()
  return props.ingredients.filter(i => i.name.toLowerCase().includes(lower))
})

const toggleDropdown = () => {
  isOpen.value = !isOpen.value
  if (isOpen.value) {
    searchQuery.value = ''
  }
}

const selectItem = (id) => {
  emit('update:modelValue', id)
  isOpen.value = false
}

// Click outside logic
const handleClickOutside = (event) => {
  if (containerRef.value && !containerRef.value.contains(event.target)) {
    isOpen.value = false
  }
}

onMounted(() => document.addEventListener('click', handleClickOutside))
onUnmounted(() => document.removeEventListener('click', handleClickOutside))
</script>

<template>
  <div class="relative w-full" ref="containerRef">
    <div 
      @click="toggleDropdown"
      class="border rounded bg-white flex items-center justify-between cursor-pointer px-2 py-1.5 min-h-[38px] transition-colors hover:border-purple-300"
      :class="isOpen ? 'border-purple-500 ring-1 ring-purple-200' : 'border-gray-200'"
    >
      <span v-if="selectedName" class="text-sm text-gray-800 font-medium truncate">{{ selectedName }}</span>
      <span v-else class="text-sm text-gray-400 truncate">{{ placeholder }}</span>
      
      <i class="fas fa-chevron-down text-xs text-gray-400 transition-transform duration-200" :class="{'rotate-180': isOpen}"></i>
    </div>

    <div v-if="isOpen" class="absolute z-50 mt-1 w-full bg-white border border-gray-200 rounded-lg shadow-xl max-h-60 overflow-hidden flex flex-col animate-fade-in-down">
      
      <div class="p-2 border-b bg-gray-50">
        <input 
          v-model="searchQuery" 
          class="w-full text-sm border border-gray-300 rounded px-2 py-1 outline-none focus:border-purple-500"
          placeholder="ĞŸĞ¾ÑˆÑƒĞº..." 
          @click.stop
        >
      </div>

      <div class="overflow-y-auto custom-scrollbar flex-1">
        <div v-if="filteredList.length === 0" class="p-3 text-xs text-gray-400 text-center">
          ĞÑ–Ñ‡Ğ¾Ğ³Ğ¾ Ğ½Ğµ Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾
        </div>
        
        <div 
          v-for="item in filteredList" 
          :key="item.id"
          @click="selectItem(item.id)"
          class="px-3 py-2 text-sm cursor-pointer hover:bg-purple-50 transition-colors flex justify-between items-center group"
          :class="item.id === modelValue ? 'bg-purple-50 text-purple-700 font-bold' : 'text-gray-700'"
        >
          <span>{{ item.name }}</span>
          <span class="text-[10px] text-gray-400 group-hover:text-purple-400 bg-gray-100 group-hover:bg-white px-1 rounded">
             {{ item.stock_quantity }} {{ item.unit?.symbol }}
          </span>
        </div>
      </div>
    </div>
  </div>
</template>

<style scoped>
.animate-fade-in-down {
  animation: fadeInDown 0.2s ease-out;
}
@keyframes fadeInDown {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}
/* Scrollbar styles (optional global) */
.custom-scrollbar::-webkit-scrollbar { width: 4px; }
.custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
</style>

--------------------------------------------------
PATH: ./frontend/src/components/warehouse/Warehouse.vue
--------------------------------------------------
<script setup>
import { ref, onMounted, defineAsyncComponent } from 'vue'
import { useWarehouse } from '@/composables/useWarehouse'

// --- ĞĞĞ’Ğ˜Ğ™ Ğ†ĞœĞŸĞĞ Ğ¢ ---
const StockTab = defineAsyncComponent(() => import('./tabs/StockTab.vue'))

const ProductsTab = defineAsyncComponent(() => import('./tabs/ProductsTab.vue'))
const IngredientsTab = defineAsyncComponent(() => import('./tabs/IngredientsTab.vue'))
const RecipesTab = defineAsyncComponent(() => import('./tabs/RecipesTab.vue'))
const ProcessesTab = defineAsyncComponent(() => import('./tabs/ProcessesTab.vue'))
const ConsumablesTab = defineAsyncComponent(() => import('./tabs/ConsumablesTab.vue'))
const UnitsTab = defineAsyncComponent(() => import('./tabs/UnitsTab.vue'))
const CategoriesTab = defineAsyncComponent(() => import('./tabs/CategoriesTab.vue'))

// Ğ—Ğ¼Ñ–Ğ½Ğ¸Ğ¼Ğ¾ Ğ´ĞµÑ„Ğ¾Ğ»Ñ‚Ğ½Ñƒ Ğ²ĞºĞ»Ğ°Ğ´ĞºÑƒ Ğ½Ğ° 'stock'
const activeTab = ref('stock')
const { fetchData, loading } = useWarehouse()

// --- Ğ”ĞĞ”ĞĞ„ĞœĞ Ğ’ ĞĞ‘'Ğ„ĞšĞ¢ ---
const tabs = {
    stock: StockTab, // <-- ĞĞ¾Ğ²Ğ° Ğ²ĞºĞ»Ğ°Ğ´ĞºĞ°
    products: ProductsTab,
    recipes: RecipesTab,
    ingredients: IngredientsTab,
    processes: ProcessesTab,
    consumables: ConsumablesTab,
    units: UnitsTab,
    categories: CategoriesTab
}

onMounted(() => {
    fetchData()
})
</script>

<template>
  <div class="p-8 h-screen overflow-y-auto bg-gray-50 ml-64 custom-scrollbar">
    <div class="flex justify-between items-center mb-8">
      <h2 class="text-3xl font-bold text-gray-800">ğŸ“¦ Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»Ñ–Ğ½Ğ½Ñ ÑĞºĞ»Ğ°Ğ´Ğ¾Ğ¼</h2>
      <button @click="fetchData" class="text-blue-600 hover:bg-blue-50 p-2 rounded-full">
        <i class="fas fa-sync-alt" :class="{'fa-spin': loading}"></i>
      </button>
    </div>

    <div class="flex space-x-1 bg-gray-200 p-1 rounded-xl w-fit mb-8 overflow-x-auto">
      <button @click="activeTab='stock'" :class="activeTab==='stock'?'bg-white text-green-600 shadow-sm':''" class="px-6 py-2 rounded-lg font-bold transition-all"><i class="fas fa-clipboard-check mr-2"></i>Ğ—Ğ°Ğ»Ğ¸ÑˆĞºĞ¸</button>
      
      <button @click="activeTab='recipes'" :class="activeTab==='recipes'?'bg-white text-orange-600 shadow-sm':''" class="px-6 py-2 rounded-lg font-bold transition-all"><i class="fas fa-book-open mr-2"></i>Ğ ĞµÑ†ĞµĞ¿Ñ‚Ğ¸</button>
      <button @click="activeTab='products'" :class="activeTab==='products'?'bg-white text-purple-600 shadow-sm':''" class="px-6 py-2 rounded-lg font-bold transition-all">Ğ¢Ğ¾Ğ²Ğ°Ñ€Ğ¸</button>
      <button @click="activeTab='processes'" :class="activeTab==='processes'?'bg-white text-indigo-600 shadow-sm':''" class="px-6 py-2 rounded-lg font-bold transition-all"><i class="fas fa-tasks mr-2"></i>ĞŸÑ€Ğ¾Ñ†ĞµÑĞ¸</button>
      
      <button @click="activeTab='ingredients'" :class="activeTab==='ingredients'?'bg-white text-blue-600 shadow-sm':''" class="px-6 py-2 rounded-lg font-bold transition-all">Ğ†Ğ½Ğ³Ñ€Ñ–Ğ´Ñ–Ñ”Ğ½Ñ‚Ğ¸</button>
      <button @click="activeTab='consumables'" :class="activeTab==='consumables'?'bg-white text-teal-600 shadow-sm':''" class="px-6 py-2 rounded-lg font-bold transition-all"><i class="fas fa-box-open mr-2"></i>Ğ’Ğ¸Ñ‚Ñ€Ğ°Ñ‚Ğ½Ñ– Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸</button>
      
      <button @click="activeTab='units'" :class="activeTab==='units'?'bg-white text-blue-600 shadow-sm':''" class="px-6 py-2 rounded-lg font-bold transition-all">ĞĞ´Ğ¸Ğ½Ğ¸Ñ†Ñ–</button>
      <button @click="activeTab='categories'" :class="activeTab==='categories'?'bg-white text-blue-600 shadow-sm':''" class="px-6 py-2 rounded-lg font-bold transition-all">ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ—</button>
    </div>

    <component :is="tabs[activeTab]" />
    
  </div>
</template>

--------------------------------------------------
PATH: ./frontend/src/components/warehouse/tabs/ProcessesTab.vue
--------------------------------------------------
<script setup>
import { ref } from 'vue'
import { useWarehouse } from '@/composables/useWarehouse'

const { processGroups, fetchData, createItem, deleteItem } = useWarehouse()

const newProcessGroup = ref({ name: '' })

const handleCreateGroup = async () => {
    if(!newProcessGroup.value.name) return alert("Ğ’ĞºĞ°Ğ¶Ñ–Ñ‚ÑŒ Ğ½Ğ°Ğ·Ğ²Ñƒ Ğ³Ñ€ÑƒĞ¿Ğ¸ (Ğ½Ğ°Ğ¿Ñ€. ĞŸĞ¾Ğ¼Ğ¾Ğ»)")
    const success = await createItem('/api/processes/groups/', { name: newProcessGroup.value.name, options: [] })
    if(success) newProcessGroup.value.name = ''
}

const handleDeleteGroup = (id) => deleteItem(`/api/processes/groups/${id}`)

const addProcessOption = async (groupId) => {
    const name = prompt("Ğ’Ğ²ĞµĞ´Ñ–Ñ‚ÑŒ Ğ½Ğ°Ğ·Ğ²Ñƒ Ğ¾Ğ¿Ñ†Ñ–Ñ— (Ğ½Ğ°Ğ¿Ñ€. ĞŸÑ–Ğ´ ĞµÑĞ¿Ñ€ĞµÑĞ¾):")
    if(!name) return
    await createItem(`/api/processes/options/?group_id=${groupId}`, { name: name })
}

const deleteProcessOption = (optionId) => deleteItem(`/api/processes/options/${optionId}`)
</script>

<template>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-indigo-100 h-fit">
            <h3 class="font-bold text-lg text-indigo-800 mb-4 border-b pb-2">â• ĞĞ¾Ğ²Ğ° Ğ³Ñ€ÑƒĞ¿Ğ° Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ–Ğ²</h3>
            <p class="text-sm text-gray-500 mb-4">ĞĞ°Ğ¿Ñ€Ğ¸ĞºĞ»Ğ°Ğ´: "ĞŸĞ¾Ğ¼Ğ¾Ğ»", "Ğ¡Ñ‚ÑƒĞ¿Ñ–Ğ½ÑŒ Ğ¿Ñ€Ğ¾ÑĞ¼Ğ°Ğ¶ĞµĞ½Ğ½Ñ", "Ğ¢ĞµĞ¼Ğ¿ĞµÑ€Ğ°Ñ‚ÑƒÑ€Ğ° Ğ¿Ğ¾Ğ´Ğ°Ñ‡Ñ–".</p>
            <div class="flex gap-2">
                <input v-model="newProcessGroup.name" placeholder="ĞĞ°Ğ·Ğ²Ğ° Ğ³Ñ€ÑƒĞ¿Ğ¸..." class="flex-1 border p-2 rounded-lg outline-none focus:ring-2 ring-indigo-200">
                <button @click="handleCreateGroup" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-indigo-700 transition">Ğ¡Ñ‚Ğ²Ğ¾Ñ€Ğ¸Ñ‚Ğ¸</button>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
             <div v-if="processGroups.length === 0" class="p-8 text-center text-gray-400">
                 ĞĞµĞ¼Ğ°Ñ” ÑÑ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ¸Ñ… Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ–Ğ²
             </div>
             
             <div v-else class="divide-y divide-gray-100">
                 <div v-for="group in processGroups" :key="group.id" class="p-6">
                     <div class="flex justify-between items-center mb-4">
                         <h4 class="font-bold text-xl text-gray-800">{{ group.name }}</h4>
                         <button @click="handleDeleteGroup(group.id)" class="text-gray-300 hover:text-red-500 transition"><i class="fas fa-trash"></i></button>
                     </div>

                     <div class="space-y-2 mb-4">
                         <div v-for="opt in group.options" :key="opt.id" class="flex items-center justify-between bg-gray-50 px-3 py-2 rounded-lg border border-gray-100">
                             <span class="text-gray-700 font-medium">{{ opt.name }}</span>
                             <button @click="deleteProcessOption(opt.id)" class="text-red-300 hover:text-red-500"><i class="fas fa-times"></i></button>
                         </div>
                     </div>

                     <button @click="addProcessOption(group.id)" class="w-full py-2 bg-indigo-50 text-indigo-600 font-bold rounded-lg hover:bg-indigo-100 border border-indigo-200 border-dashed">
                         + Ğ”Ğ¾Ğ´Ğ°Ñ‚Ğ¸ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚ (Ğ½Ğ°Ğ¿Ñ€. "ĞŸÑ–Ğ´ ĞµÑĞ¿Ñ€ĞµÑĞ¾")
                     </button>
                 </div>
             </div>
        </div>
    </div>
</template>

--------------------------------------------------
PATH: ./frontend/src/components/warehouse/tabs/RecipesTab.vue
--------------------------------------------------
<script setup>
import { ref, computed } from 'vue'
import { useWarehouse } from '@/composables/useWarehouse'
import IngredientSelect from '@/components/common/IngredientSelect.vue' 

const { recipes, ingredients, fetchData, createItem, deleteItem } = useWarehouse()

const editingRecipeId = ref(null)
const newRecipe = ref({ name: '', description: '', items: [] })
const tempRecipeItem = ref({ ingredient_id: '', quantity: 0, is_percentage: false })

const getSelectedIngredientSymbol = computed(() => {
    if (!tempRecipeItem.value.ingredient_id) return ''
    const ing = ingredients.value.find(i => i.id === tempRecipeItem.value.ingredient_id)
    return ing ? ing.unit.symbol : ''
})

const editRecipe = (r) => {
    editingRecipeId.value = r.id
    newRecipe.value = {
        name: r.name,
        description: r.description,
        items: r.items.map(item => ({ 
            ingredient_id: item.ingredient_id, 
            quantity: item.quantity,
            is_percentage: item.is_percentage, 
            ingredient_name: item.ingredient_name 
        }))
    }
}

const resetRecipeForm = () => {
    editingRecipeId.value = null
    newRecipe.value = { name: '', description: '', items: [] }
    tempRecipeItem.value = { ingredient_id: '', quantity: 0, is_percentage: false }
}

const addIngredientToMaster = () => {
    if(!tempRecipeItem.value.ingredient_id || !tempRecipeItem.value.quantity) return
    const ing = ingredients.value.find(i => i.id === tempRecipeItem.value.ingredient_id)
    newRecipe.value.items.push({
        ingredient_id: tempRecipeItem.value.ingredient_id,
        quantity: tempRecipeItem.value.quantity,
        is_percentage: tempRecipeItem.value.is_percentage, 
        ingredient_name: ing ? ing.name : ''
    })
    tempRecipeItem.value = { ingredient_id: '', quantity: 0, is_percentage: false }
}

const removeIngredientFromMaster = (idx) => {
    newRecipe.value.items.splice(idx, 1)
}

const saveRecipe = async () => {
    if(!newRecipe.value.name) return alert("Ğ’ĞºĞ°Ğ¶Ñ–Ñ‚ÑŒ Ğ½Ğ°Ğ·Ğ²Ñƒ Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ñƒ")
    
    let url = '/api/recipes/'; 
    // createItem Ğ² useWarehouse Ñ€Ğ¾Ğ±Ğ¸Ñ‚ÑŒ Ñ‚Ñ–Ğ»ÑŒĞºĞ¸ POST, Ñ‚Ğ¾Ğ¼Ñƒ Ğ´Ğ»Ñ PUT Ğ½Ğ°Ğ¼ Ñ‚Ñ€ĞµĞ±Ğ° Ğ²Ñ€ÑƒÑ‡Ğ½Ñƒ Ğ°Ğ±Ğ¾ Ñ€Ğ¾Ğ·ÑˆĞ¸Ñ€Ğ¸Ñ‚Ğ¸ composable.
    // Ğ¢ÑƒÑ‚ Ğ·Ñ€Ğ¾Ğ±Ğ¸Ğ¼Ğ¾ Ñ†Ğµ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾, Ğ±Ğ¾ Ñ†Ğµ ÑĞ¿ĞµÑ†Ğ¸Ñ„Ñ–Ñ‡Ğ½Ğ° Ğ»Ğ¾Ğ³Ñ–ĞºĞ°
    if(editingRecipeId.value) {
        await fetch(`/api/recipes/${editingRecipeId.value}`, { 
            method: 'PUT', 
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(newRecipe.value) 
        })
        await fetchData()
    } else {
        await createItem(url, newRecipe.value)
    }
    
    alert("Ğ ĞµÑ†ĞµĞ¿Ñ‚ Ğ·Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ¾!")
    resetRecipeForm()
}

const handleDelete = (id) => deleteItem(`/api/recipes/${id}`)
</script>

<template>
    <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
        <div class="xl:col-span-1 bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden h-fit">
            <div class="p-4 bg-gray-50 border-b font-bold text-gray-700">Ğ’ÑÑ– Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ğ¸</div>
            <div class="max-h-[600px] overflow-y-auto custom-scrollbar">
                <div v-for="r in recipes" :key="r.id" class="p-4 border-b hover:bg-orange-50 cursor-pointer flex justify-between items-center group">
                    <div @click="editRecipe(r)" class="flex-1">
                        <div class="font-bold text-gray-800">{{ r.name }}</div>
                        <div class="text-xs text-gray-400">{{ r.items.length }} Ñ–Ğ½Ğ³Ñ€.</div>
                    </div>
                    <button @click="handleDelete(r.id)" class="text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition"><i class="fas fa-trash"></i></button>
                </div>
            </div>
            <button @click="resetRecipeForm" class="w-full py-3 text-center text-orange-600 font-bold hover:bg-orange-50 transition border-t">
                <i class="fas fa-plus-circle"></i> Ğ¡Ñ‚Ğ²Ğ¾Ñ€Ğ¸Ñ‚Ğ¸ Ğ½Ğ¾Ğ²Ğ¸Ğ¹
            </button>
        </div>

        <div class="xl:col-span-2 bg-white rounded-2xl shadow-sm border border-orange-100 border-2 h-fit">
             <div class="p-6 border-b flex justify-between items-center bg-orange-50 rounded-t-xl">
                 <h3 class="font-bold text-xl text-orange-800">{{ editingRecipeId ? 'Ğ ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ' : 'ĞĞ¾Ğ²Ğ¸Ğ¹ Ñ€ĞµÑ†ĞµĞ¿Ñ‚' }}</h3>
                 <button v-if="editingRecipeId" @click="resetRecipeForm" class="text-xs text-red-500 hover:underline">Ğ—Ğ°ĞºÑ€Ğ¸Ñ‚Ğ¸</button>
             </div>
             
             <div class="p-6 space-y-4">
                 <input v-model="newRecipe.name" placeholder="ĞĞ°Ğ·Ğ²Ğ° Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ñƒ" class="w-full border p-2 rounded focus:ring-2 ring-orange-200 outline-none text-lg font-bold">
                 
                 <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                     <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Ğ¡ĞºĞ»Ğ°Ğ´ Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ñƒ</label>
                     <div class="space-y-2 mb-4">
                         <div v-for="(item, idx) in newRecipe.items" :key="idx" class="flex items-center gap-3 bg-white p-2 rounded border shadow-sm">
                             <span class="flex-1 font-bold text-gray-700">{{ item.ingredient_name }}</span>
                             <span class="font-mono bg-gray-100 px-2 rounded" :class="item.is_percentage ? 'text-blue-600' : ''">
                                 {{ item.quantity }} {{ item.is_percentage ? '%' : '' }}
                             </span>
                             <button @click="removeIngredientFromMaster(idx)" class="text-red-400 hover:text-red-600"><i class="fas fa-times"></i></button>
                         </div>
                     </div>

                     <div class="flex gap-2 items-end border-t pt-3">
                         <div class="flex-1">
                             <label class="text-[10px] text-gray-400 font-bold uppercase">Ğ†Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚</label>
                             <IngredientSelect v-model="tempRecipeItem.ingredient_id" :ingredients="ingredients" />
                         </div>
                         
                         <div class="flex flex-col">
                             <label class="text-[10px] text-gray-400 font-bold uppercase mb-1">Ğ¢Ğ¸Ğ¿</label>
                             <div class="flex bg-white border rounded h-[38px] overflow-hidden">
                                 <button @click="tempRecipeItem.is_percentage=false" :class="!tempRecipeItem.is_percentage ? 'bg-gray-200 font-bold':''" class="px-2 text-xs border-r hover:bg-gray-100">FIX</button>
                                 <button @click="tempRecipeItem.is_percentage=true" :class="tempRecipeItem.is_percentage ? 'bg-blue-100 text-blue-700 font-bold':''" class="px-2 text-xs hover:bg-gray-100">%</button>
                             </div>
                         </div>

                         <div class="w-24">
                             <label class="text-[10px] text-gray-400 font-bold uppercase">ĞšÑ–Ğ»ÑŒĞºÑ–ÑÑ‚ÑŒ</label>
                             <div class="relative">
                                 <input v-model="tempRecipeItem.quantity" type="number" step="0.001" class="w-full border p-2 rounded h-[38px] pr-8">
                                 <span class="absolute right-2 top-2 text-xs text-gray-400">
                                     {{ tempRecipeItem.is_percentage ? '%' : getSelectedIngredientSymbol }}
                                 </span>
                             </div>
                         </div>
                         <button @click="addIngredientToMaster" class="bg-orange-500 text-white w-10 h-[38px] rounded hover:bg-orange-600 transition"><i class="fas fa-plus"></i></button>
                     </div>
                 </div>

                 <button @click="saveRecipe" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold hover:bg-green-700 shadow-lg mt-2">Ğ—Ğ±ĞµÑ€ĞµĞ³Ñ‚Ğ¸ Ñ€ĞµÑ†ĞµĞ¿Ñ‚</button>
             </div>
        </div>
    </div>
</template>

--------------------------------------------------
PATH: ./frontend/src/components/warehouse/tabs/CategoriesTab.vue
--------------------------------------------------
<script setup>
import { ref } from 'vue'
import { useWarehouse } from '@/composables/useWarehouse'

// Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ Ğ¼ĞµÑ‚Ğ¾Ğ´Ğ¸ Ğ· Ğ½Ğ°ÑˆĞ¾Ğ³Ğ¾ composable
const { categories, createItem, updateItem, deleteItem } = useWarehouse()

// Ğ¡Ñ‚Ğ°Ğ½ Ñ„Ğ¾Ñ€Ğ¼Ğ¸
const newCategory = ref({ name: '', slug: '', color: '#3b82f6', parent_id: '' }) 
const isEditing = ref(false)
const editingId = ref(null)

// Ğ”Ğ¾Ğ¿Ğ¾Ğ¼Ñ–Ğ¶Ğ½Ğ° Ñ„ÑƒĞ½ĞºÑ†Ñ–Ñ Ğ´Ğ»Ñ Ğ²Ñ–Ğ´Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ±Ğ°Ñ‚ÑŒĞºĞ°
const getParentName = (parentId) => {
    if (!parentId) return '';
    const parent = categories.value.find(c => c.id === parentId);
    return parent ? parent.name : '???';
}

// Ğ—Ğ°Ğ¿Ğ¾Ğ²Ğ½ĞµĞ½Ğ½Ñ Ñ„Ğ¾Ñ€Ğ¼Ğ¸ Ğ´Ğ»Ñ Ñ€ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ
const prepareEdit = (category) => {
    isEditing.value = true
    editingId.value = category.id
    newCategory.value = {
        name: category.name,
        slug: category.slug,
        color: category.color || '#3b82f6',
        parent_id: category.parent_id || ''
    }
}

// Ğ¡ĞºĞ¸Ğ´Ğ°Ğ½Ğ½Ñ Ñ„Ğ¾Ñ€Ğ¼Ğ¸
const resetForm = () => {
    isEditing.value = false
    editingId.value = null
    newCategory.value = { name: '', slug: '', color: '#3b82f6', parent_id: '' }
}

// ĞĞ±Ñ€Ğ¾Ğ±ĞºĞ° Ğ·Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ½Ñ (Ğ¡Ñ‚Ğ²Ğ¾Ñ€Ğ¸Ñ‚Ğ¸ ĞĞ‘Ğ ĞĞ½Ğ¾Ğ²Ğ¸Ñ‚Ğ¸)
const handleSave = async () => {
    if (!newCategory.value.name) return alert("Ğ’ĞºĞ°Ğ¶Ñ–Ñ‚ÑŒ Ğ½Ğ°Ğ·Ğ²Ñƒ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ—!")
    
    const payload = { ...newCategory.value }
    
    // ĞĞ²Ñ‚Ğ¾Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ñ–Ñ slug, ÑĞºÑ‰Ğ¾ Ğ¿ÑƒÑÑ‚Ğ¾
    if (!payload.slug) {
        payload.slug = payload.name.toLowerCase().replace(/\s+/g, '-') + '-' + Date.now().toString().slice(-4)
    }
    // ĞÑ‡Ğ¸Ñ‰ĞµĞ½Ğ½Ñ parent_id
    if (payload.parent_id === "") payload.parent_id = null
    
    let success = false

    if (isEditing.value) {
        // ĞĞĞĞ’Ğ›Ğ•ĞĞĞ¯ (PUT)
        success = await updateItem(`/api/categories/${editingId.value}`, payload)
    } else {
        // Ğ¡Ğ¢Ğ’ĞĞ Ğ•ĞĞĞ¯ (POST)
        success = await createItem('/api/categories/', payload)
    }

    if(success) {
        resetForm()
    }
}

// ĞĞ±Ñ€Ğ¾Ğ±ĞºĞ° Ğ²Ğ¸Ğ´Ğ°Ğ»ĞµĞ½Ğ½Ñ
const handleDelete = async (id) => {
    await deleteItem(`/api/categories/${id}`)
    // Ğ¯ĞºÑ‰Ğ¾ Ğ¼Ğ¸ Ñ€ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ»Ğ¸ ÑĞ°Ğ¼Ğµ Ñ†Ñ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ - ÑĞºĞ¸Ğ´Ğ°Ñ”Ğ¼Ğ¾ Ñ„Ğ¾Ñ€Ğ¼Ñƒ
    if (editingId.value === id) {
        resetForm()
    }
}
</script>

<template>
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 h-fit">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-gray-700">
                    {{ isEditing ? 'âœï¸ Ğ ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ—' : 'ğŸ“‚ ĞĞ¾Ğ²Ğ° ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ' }}
                </h3>
                <button v-if="isEditing" @click="resetForm" class="text-xs text-red-500 hover:underline">Ğ¡ĞºĞ°ÑÑƒĞ²Ğ°Ñ‚Ğ¸</button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞĞ°Ğ·Ğ²Ğ°</label>
                    <input v-model="newCategory.name" class="border p-2 rounded w-full focus:ring-2 ring-blue-100 outline-none" placeholder="ĞĞ°Ğ¿Ñ€. ĞšĞ°Ğ²Ğ°">
                </div>
                
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞšĞ¾Ğ´ (Slug)</label>
                    <input v-model="newCategory.slug" class="border p-2 rounded w-full font-mono text-sm text-gray-600" placeholder="auto-generated">
                </div>
                
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞšĞ¾Ğ»Ñ–Ñ€</label>
                    <div class="flex items-center gap-2">
                        <input v-model="newCategory.color" type="color" class="h-10 w-16 border rounded cursor-pointer p-1 bg-white">
                        <span class="text-sm text-gray-600 font-mono">{{ newCategory.color }}</span>
                    </div>
                </div>
                
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ğ‘Ğ°Ñ‚ÑŒĞºÑ–Ğ²ÑÑŒĞºĞ° ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ</label>
                    <select v-model="newCategory.parent_id" class="border p-2 rounded w-full bg-white">
                        <option value="">(ĞĞµĞ¼Ğ°Ñ” - ĞšĞ¾Ñ€ĞµĞ½ĞµĞ²Ğ°)</option>
                        <option v-for="c in categories" :key="c.id" :value="c.id" :disabled="c.id === editingId">
                            {{ c.name }}
                        </option>
                    </select>
                </div>
                
                <button @click="handleSave" 
                    class="w-full py-3 rounded-xl font-bold text-white shadow-lg transition transform active:scale-95"
                    :class="isEditing ? 'bg-orange-500 hover:bg-orange-600 shadow-orange-200' : 'bg-blue-600 hover:bg-blue-700 shadow-blue-200'">
                    {{ isEditing ? 'Ğ—Ğ±ĞµÑ€ĞµĞ³Ñ‚Ğ¸ Ğ·Ğ¼Ñ–Ğ½Ğ¸' : 'Ğ¡Ñ‚Ğ²Ğ¾Ñ€Ğ¸Ñ‚Ğ¸ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ' }}
                </button>
            </div>
        </div>

        <div class="lg:col-span-2 bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="bg-gray-50 text-gray-500 uppercase text-xs">
                        <tr>
                            <th class="p-4">ĞšĞ¾Ğ»Ñ–Ñ€</th>
                            <th class="p-4">ĞĞ°Ğ·Ğ²Ğ°</th>
                            <th class="p-4">ĞšĞ¾Ğ´</th>
                            <th class="p-4">Ğ‘Ğ°Ñ‚ÑŒĞºĞ¾</th>
                            <th class="p-4 text-center">Ğ”Ñ–Ñ—</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        <tr v-if="categories.length === 0">
                            <td colspan="5" class="p-8 text-center text-gray-400">ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ğ¹ Ñ‰Ğµ Ğ½ĞµĞ¼Ğ°Ñ”</td>
                        </tr>
                        <tr v-for="c in categories" :key="c.id" class="hover:bg-gray-50 group">
                            <td class="p-4">
                                <div class="w-8 h-8 rounded-lg shadow-sm border border-gray-200" :style="{ backgroundColor: c.color || '#fff' }"></div>
                            </td>
                            <td class="p-4 font-bold text-gray-800 text-lg">{{ c.name }}</td>
                            <td class="p-4 font-mono text-gray-500">{{ c.slug }}</td>
                            <td class="p-4">
                                <span v-if="c.parent_id" class="bg-blue-50 text-blue-600 px-2 py-1 rounded text-xs font-bold">
                                    {{ getParentName(c.parent_id) }}
                                </span>
                                <span v-else class="text-gray-300 text-xs">-</span>
                            </td>
                            <td class="p-4 text-center">
                                <div class="flex justify-center gap-2">
                                    <button @click="prepareEdit(c)" class="p-2 text-blue-400 hover:text-blue-600 hover:bg-blue-50 rounded transition" title="Ğ ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ñ‚Ğ¸">
                                        <i class="fas fa-pen"></i>
                                    </button>
                                    <button @click="handleDelete(c.id)" class="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded transition" title="Ğ’Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğ¸">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</template>

--------------------------------------------------
PATH: ./frontend/src/components/warehouse/tabs/StockTab.vue
--------------------------------------------------
<script setup>
import { ref, computed, onMounted, defineAsyncComponent } from 'vue' // Ğ”Ğ¾Ğ´Ğ°Ğ»Ğ¸ defineAsyncComponent
import { useWarehouse } from '@/composables/useWarehouse'
import axios from 'axios'

// Ğ†Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ÑƒÑ”Ğ¼Ğ¾ Ğ¼Ğ¾Ğ´Ğ°Ğ»ĞºÑƒ Ñ–ÑÑ‚Ğ¾Ñ€Ñ–Ñ— (Ñ‚Ğ°Ğº ÑĞ°Ğ¼Ğ¾, ÑĞº Ğ±ÑƒĞ»Ğ¾ Ğ² ÑÑ‚Ğ°Ñ€Ñ–Ğ¹ Ğ²ĞµÑ€ÑÑ–Ñ—)
const HistoryModal = defineAsyncComponent(() => import('../modals/HistoryModal.vue'))

// ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ğ´Ğ°Ğ½Ñ– Ğ·Ñ– ÑÑ…Ğ¾Ğ²Ğ¸Ñ‰Ğ°
const { ingredients, consumables, products, fetchWarehouseData } = useWarehouse()

const activeTab = ref('ingredients') 
const search = ref('')
const loading = ref(false)

// Ğ—Ğ¼Ñ–Ğ½Ğ½Ñ– Ğ´Ğ»Ñ Ñ€ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ
const editingItem = ref(null)
const editValue = ref(0)

// --- Ğ—ĞœĞ†ĞĞĞ† Ğ”Ğ›Ğ¯ Ğ†Ğ¡Ğ¢ĞĞ Ğ†Ğ‡ ---
const isHistoryOpen = ref(false)
const historyItem = ref(null)

// --- Ğ¤Ğ£ĞĞšĞ¦Ğ†Ğ¯ Ğ’Ğ†Ğ”ĞšĞ Ğ˜Ğ¢Ğ¢Ğ¯ Ğ†Ğ¡Ğ¢ĞĞ Ğ†Ğ‡ ---
const openHistory = (item) => {
    // Ğ¤Ğ¾Ñ€Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ğ¾Ğ±'Ñ”ĞºÑ‚, ÑĞºĞ¸Ğ¹ Ğ¾Ñ‡Ñ–ĞºÑƒÑ” HistoryModal
    historyItem.value = {
        id: item.original_id || item.id, // ID ÑÑƒÑ‚Ğ½Ğ¾ÑÑ‚Ñ– Ğ² Ğ±Ğ°Ğ·Ñ–
        type: item.type,                 // 'ingredient', 'consumable', 'product', 'product_variant'
        name: item.display_name          // ĞĞ°Ğ·Ğ²Ğ° Ğ´Ğ»Ñ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ°
    }
    isHistoryOpen.value = true
}

// --- ĞŸĞ»Ğ¾ÑĞºĞ¸Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ´Ğ»Ñ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ– ---
const filteredItems = computed(() => {
    let list = []

    // 1. Ğ¡Ğ˜Ğ ĞĞ’Ğ˜ĞĞ
    if (activeTab.value === 'ingredients') {
        list = ingredients.value.map(i => ({ 
            ...i, 
            type: 'ingredient', 
            display_name: i.name,
            unit_symbol: i.unit?.symbol || '' 
        }))
    } 
    // 2. ĞœĞĞ¢Ğ•Ğ Ğ†ĞĞ›Ğ˜
    else if (activeTab.value === 'consumables') {
        list = consumables.value.map(c => ({ 
            ...c, 
            type: 'consumable', 
            display_name: c.name,
            unit_symbol: c.unit?.symbol || ''
        }))
    } 
    // 3. Ğ¢ĞĞ’ĞĞ Ğ˜ (Ğ Ğ¾Ğ·Ğ³Ğ¾Ñ€Ñ‚Ğ°Ñ”Ğ¼Ğ¾ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸!)
    else if (activeTab.value === 'products') {
        products.value.forEach(p => {
            if (p.has_variants && p.variants) {
                // Ğ’Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸
                p.variants.forEach(v => {
                    list.push({
                        id: v.id, 
                        original_id: v.id,
                        type: 'product_variant', 
                        display_name: `${p.name} (${v.name})`, 
                        stock_quantity: v.stock_quantity,
                        unit_symbol: 'ÑˆÑ‚',
                        product_id: p.id 
                    })
                })
            } else {
                // ĞŸÑ€Ğ¾ÑÑ‚Ñ– Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¸
                list.push({
                    id: p.id,
                    original_id: p.id,
                    type: 'product',
                    display_name: p.name,
                    stock_quantity: p.stock_quantity,
                    unit_symbol: 'ÑˆÑ‚'
                })
            }
        })
    }

    if (search.value) {
        const s = search.value.toLowerCase()
        return list.filter(i => i.display_name.toLowerCase().includes(s))
    }
    return list
})

// --- Ğ›ĞĞ“Ğ†ĞšĞ Ğ Ğ•Ğ”ĞĞ“Ğ£Ğ’ĞĞĞĞ¯ Ğ—ĞĞ›Ğ˜Ğ¨ĞšĞ†Ğ’ ---
const startEdit = (item) => {
    editingItem.value = item.id 
    editValue.value = item.stock_quantity
}

const saveEdit = async (item) => {
    if (editValue.value < 0) return alert("ĞĞµ Ğ¼Ğ¾Ğ¶Ğµ Ğ±ÑƒÑ‚Ğ¸ Ğ¼Ñ–Ğ½ÑƒÑĞ¾Ğ²Ğ¸Ğ¼")
    
    loading.value = true
    try {
        let url = ''
        let payload = {}
        let method = 'put'

        if (item.type === 'ingredient') {
            url = `/api/ingredients/${item.original_id || item.id}`
            payload = { ...item, stock_quantity: editValue.value }
        } 
        else if (item.type === 'consumable') {
            url = `/api/consumables/${item.original_id || item.id}`
            payload = { ...item, stock_quantity: editValue.value }
        }
        else if (item.type === 'product') {
            url = `/api/products/${item.original_id || item.id}/stock?qty=${editValue.value}`
            method = 'patch'
            payload = {} 
        }
        else if (item.type === 'product_variant') {
            url = `/api/products/variants/${item.original_id || item.id}/stock?qty=${editValue.value}`
            method = 'patch'
            payload = {}
        }

        if (method === 'put') {
            await axios.put(url, payload)
        } else {
            await axios.patch(url)
        }

        item.stock_quantity = editValue.value
        await fetchWarehouseData()
        editingItem.value = null
    } catch (e) {
        console.error(e)
        alert("ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ Ğ·Ğ°Ğ»Ğ¸ÑˆĞºÑƒ")
    } finally {
        loading.value = false
    }
}

onMounted(() => {
    fetchWarehouseData()
})
</script>

<template>
    <div class="h-full flex flex-col bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
        
        <div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center gap-4">
            <div class="flex p-1 bg-white rounded-xl border border-gray-200 shadow-sm">
                <button 
                    v-for="tab in ['ingredients', 'consumables', 'products']" 
                    :key="tab"
                    @click="activeTab = tab"
                    class="px-4 py-2 text-xs font-bold rounded-lg transition-all"
                    :class="activeTab === tab ? 'bg-blue-600 text-white shadow-md' : 'text-gray-500 hover:bg-gray-50'"
                >
                    {{ tab === 'ingredients' ? 'ğŸ¥¦ Ğ¡Ğ¸Ñ€Ğ¾Ğ²Ğ¸Ğ½Ğ°' : (tab === 'consumables' ? 'ğŸ“¦ ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸' : 'ğŸ¹ Ğ¢Ğ¾Ğ²Ğ°Ñ€Ğ¸') }}
                </button>
            </div>

            <input 
                v-model="search" 
                placeholder="ĞŸĞ¾ÑˆÑƒĞº..." 
                class="border border-gray-200 rounded-xl px-3 py-2 text-sm outline-none focus:border-blue-500 w-64"
            >
        </div>

        <div class="flex-1 overflow-auto">
            <table class="w-full text-left text-sm">
                <thead class="bg-gray-50 text-gray-500 uppercase text-xs sticky top-0 z-10">
                    <tr>
                        <th class="p-4">ĞĞ°Ğ·Ğ²Ğ°</th>
                        <th class="p-4 text-center">Ğ¢Ğ¸Ğ¿</th>
                        <th class="p-4 text-right">Ğ—Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº</th>
                        <th class="p-4 text-center">Ğ”Ñ–Ñ—</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    <tr v-if="filteredItems.length === 0">
                        <td colspan="4" class="p-8 text-center text-gray-400">
                            ĞÑ–Ñ‡Ğ¾Ğ³Ğ¾ Ğ½Ğµ Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾...
                        </td>
                    </tr>
                    
                    <tr v-for="item in filteredItems" :key="item.id + item.type" class="hover:bg-gray-50 group">
                        
                        <td class="p-4 font-bold text-gray-700">
                            {{ item.display_name }}
                        </td>

                        <td class="p-4 text-center">
                            <span v-if="item.type === 'ingredient'" class="bg-green-100 text-green-700 px-2 py-1 rounded text-[10px] font-bold">Ğ¡Ğ¸Ñ€Ğ¾Ğ²Ğ¸Ğ½Ğ°</span>
                            <span v-else-if="item.type === 'consumable'" class="bg-teal-100 text-teal-700 px-2 py-1 rounded text-[10px] font-bold">ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»</span>
                            <span v-else-if="item.type === 'product'" class="bg-purple-100 text-purple-700 px-2 py-1 rounded text-[10px] font-bold">Ğ¢Ğ¾Ğ²Ğ°Ñ€</span>
                            <span v-else-if="item.type === 'product_variant'" class="bg-indigo-100 text-indigo-700 px-2 py-1 rounded text-[10px] font-bold">Ğ’Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚</span>
                        </td>

                        <td class="p-4 text-right font-mono font-bold">
                            <div v-if="editingItem === item.id" class="flex items-center justify-end gap-2">
                                <input 
                                    v-model.number="editValue" 
                                    type="number" 
                                    class="w-20 border rounded p-1 text-right focus:ring-2 ring-blue-500 outline-none"
                                >
                                <span class="text-xs text-gray-400">{{ item.unit_symbol }}</span>
                            </div>
                            <span v-else :class="{'text-red-500 bg-red-50 px-2 py-1 rounded': item.stock_quantity <= 0, 'text-gray-700': item.stock_quantity > 0}">
                                {{ item.stock_quantity }} {{ item.unit_symbol }}
                            </span>
                        </td>

                        <td class="p-4 text-center">
                            <div v-if="editingItem === item.id" class="flex justify-center gap-1">
                                <button @click="saveEdit(item)" class="bg-green-500 text-white w-7 h-7 rounded hover:bg-green-600 flex items-center justify-center">
                                    <i class="fas fa-check text-xs"></i>
                                </button>
                                <button @click="editingItem = null" class="bg-gray-300 text-gray-700 w-7 h-7 rounded hover:bg-gray-400 flex items-center justify-center">
                                    <i class="fas fa-times text-xs"></i>
                                </button>
                            </div>
                            
                            <div v-else class="flex justify-center gap-2">
                                <button @click="openHistory(item)" class="text-purple-400 hover:text-purple-600 p-2 rounded hover:bg-purple-50 transition-colors" title="Ğ†ÑÑ‚Ğ¾Ñ€Ñ–Ñ Ñ€ÑƒÑ…Ñƒ">
                                    <i class="fas fa-history"></i>
                                </button>
                                <button @click="startEdit(item)" class="text-blue-400 hover:text-blue-600 p-2 rounded hover:bg-blue-50 transition-colors" title="ĞšĞ¾Ñ€ĞµĞ³ÑƒĞ²Ğ°Ñ‚Ğ¸ Ğ·Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº">
                                    <i class="fas fa-pen"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <HistoryModal 
            v-if="isHistoryOpen" 
            :is-open="isHistoryOpen" 
            :item="historyItem" 
            @close="isHistoryOpen = false" 
        />
    </div>
</template>

--------------------------------------------------
PATH: ./frontend/src/components/warehouse/tabs/IngredientsTab.vue
--------------------------------------------------
<script setup>
import { ref } from 'vue'
import { useWarehouse } from '@/composables/useWarehouse'

// Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñ– Ğ´Ğ°Ğ½Ñ–
const { ingredients, units, createItem, deleteItem } = useWarehouse()

const newIngredient = ref({ name: '', unit_id: '', cost_per_unit: 0, stock_quantity: 0 })

const handleCreate = async () => {
    if(!newIngredient.value.name) return
    const success = await createItem('/api/ingredients/', newIngredient.value)
    if(success) newIngredient.value = {name:'',unit_id:'',cost_per_unit:0,stock_quantity:0}
}

const handleDelete = (id) => deleteItem(`/api/ingredients/${id}`)
</script>

<template>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 h-fit">
            <h3 class="font-bold mb-6 text-gray-700 border-b pb-2">ğŸŒ± ĞĞ¾Ğ²Ğ¸Ğ¹ Ñ–Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚</h3>
            <div class="space-y-5">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞĞ°Ğ·Ğ²Ğ° Ñ–Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ğ°</label>
                    <input v-model="newIngredient.name" placeholder="ĞĞ°Ğ¿Ñ€. ĞšĞ°Ğ²Ğ° Ğ² Ğ·ĞµÑ€Ğ½Ğ°Ñ…" class="border p-2 rounded-lg w-full bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-100 outline-none transition">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞĞ´Ğ¸Ğ½Ğ¸Ñ†Ñ Ğ²Ğ¸Ğ¼Ñ–Ñ€Ñƒ</label>
                        <select v-model="newIngredient.unit_id" class="border p-2 rounded-lg w-full bg-white h-[42px]">
                            <option value="" disabled>ĞĞ±ĞµÑ€Ñ–Ñ‚ÑŒ...</option>
                            <option v-for="u in units" :key="u.id" :value="u.id">{{u.name}} ({{u.symbol}})</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ğ¡Ğ¾Ğ±Ñ–Ğ²Ğ°Ñ€Ñ‚Ñ–ÑÑ‚ÑŒ (â‚´/Ğ¾Ğ´)</label>
                        <input v-model="newIngredient.cost_per_unit" type="number" placeholder="0.00" class="border p-2 rounded-lg w-full">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞŸĞ¾Ñ‡Ğ°Ñ‚ĞºĞ¾Ğ²Ğ¸Ğ¹ Ğ·Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº Ğ½Ğ° ÑĞºĞ»Ğ°Ğ´Ñ–</label>
                    <input v-model="newIngredient.stock_quantity" type="number" placeholder="0" class="border p-2 rounded-lg w-full">
                </div>
                <button @click="handleCreate" class="bg-blue-600 hover:bg-blue-700 text-white w-full py-3 rounded-xl font-bold shadow-lg shadow-blue-200 transition mt-2">
                    <i class="fas fa-plus mr-2"></i> Ğ”Ğ¾Ğ´Ğ°Ñ‚Ğ¸ Ğ² Ğ±Ğ°Ğ·Ñƒ
                </button>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm overflow-hidden border border-gray-100">
            <table class="w-full text-sm text-left">
                <thead class="bg-gray-50 text-gray-500 uppercase text-xs">
                    <tr><th class="p-4">ĞĞ°Ğ·Ğ²Ğ°</th><th class="p-4 text-right">Ğ—Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº</th><th class="p-4 text-center">Ğ”Ñ–Ñ—</th></tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    <tr v-for="i in ingredients" :key="i.id" class="hover:bg-gray-50">
                        <td class="p-4 font-bold text-gray-700">
                            {{ i.name }}
                            <div class="text-xs text-gray-400 font-normal">Ğ¡Ğ¾Ğ±Ñ–Ğ²Ğ°Ñ€Ñ‚Ñ–ÑÑ‚ÑŒ: {{ i.cost_per_unit }} â‚´/{{ i.unit?.symbol }}</div>
                        </td>
                        <td class="p-4 text-right font-mono text-lg" :class="i.stock_quantity > 0 ? 'text-green-600' : 'text-red-500'">
                            {{ i.stock_quantity }} <span class="text-xs text-gray-400 font-sans">{{ i.unit?.symbol }}</span>
                        </td>
                        <td class="p-4 text-center">
                            <button @click="handleDelete(i.id)" class="text-gray-400 hover:text-red-500 px-2"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</template>

--------------------------------------------------
PATH: ./frontend/src/components/warehouse/tabs/UnitsTab.vue
--------------------------------------------------
<script setup>
import { ref } from 'vue'
import { useWarehouse } from '@/composables/useWarehouse'

const { units, createItem } = useWarehouse()
const newUnit = ref({ name: '', symbol: '' })

const handleCreate = async () => {
    if (!newUnit.value.name || !newUnit.value.symbol) return alert("Ğ—Ğ°Ğ¿Ğ¾Ğ²Ğ½Ñ–Ñ‚ÑŒ!")
    const success = await createItem('/api/units/', newUnit.value)
    if(success) newUnit.value = { name: '', symbol: '' }
}
</script>

<template>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 h-fit">
            <h3 class="font-bold mb-4 text-gray-700">ğŸ“ Ğ¡Ñ‚Ğ²Ğ¾Ñ€Ğ¸Ñ‚Ğ¸ Ğ¾Ğ´Ğ¸Ğ½Ğ¸Ñ†Ñ Ğ²Ğ¸Ğ¼Ñ–Ñ€Ñƒ</h3>
            <div class="space-y-3">
                <input v-model="newUnit.name" placeholder="ĞĞ°Ğ·Ğ²Ğ° (Ğ½Ğ°Ğ¿Ñ€. Ğ“Ñ€Ğ°Ğ¼Ğ¸)" class="border p-2 rounded w-full">
                <input v-model="newUnit.symbol" placeholder="Ğ¡Ğ¸Ğ¼Ğ²Ğ¾Ğ» (Ğ½Ğ°Ğ¿Ñ€. Ğ³)" class="border p-2 rounded w-full">
                <button @click="handleCreate" class="bg-blue-600 hover:bg-blue-700 text-white w-full py-3 rounded-xl font-bold shadow-lg shadow-blue-200 transition">Ğ—Ğ±ĞµÑ€ĞµĞ³Ñ‚Ğ¸</button>
            </div>
        </div>
        <div class="bg-white rounded-2xl shadow-sm overflow-hidden border border-gray-100">
            <table class="w-full text-sm text-left">
                <thead class="bg-gray-50 text-gray-500 uppercase text-xs"><tr><th class="p-4">ĞĞ°Ğ·Ğ²Ğ°</th><th class="p-4 text-right">Ğ¡Ğ¸Ğ¼Ğ²Ğ¾Ğ»</th></tr></thead>
                <tbody class="divide-y divide-gray-100">
                    <tr v-for="u in units" :key="u.id" class="hover:bg-gray-50">
                        <td class="p-4 font-bold text-gray-700">{{ u.name }}</td>
                        <td class="p-4 text-right font-mono">{{ u.symbol }}</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</template>

--------------------------------------------------
PATH: ./frontend/src/components/warehouse/tabs/ConsumablesTab.vue
--------------------------------------------------
<script setup>
import { ref } from 'vue'
import { useWarehouse } from '@/composables/useWarehouse'

const { consumables, units, createItem, deleteItem } = useWarehouse()

const newConsumable = ref({ name: '', unit_id: '', cost_per_unit: 0, stock_quantity: 0 })

const handleCreate = async () => {
    if(!newConsumable.value.name) return
    const success = await createItem('/api/consumables/', newConsumable.value)
    if(success) newConsumable.value={name:'',unit_id:'',cost_per_unit:0,stock_quantity:0}
}

const handleDelete = (id) => deleteItem(`/api/consumables/${id}`)
</script>

<template>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 h-fit">
            <h3 class="font-bold mb-6 text-gray-700 border-b pb-2">ğŸ“¦ ĞĞ¾Ğ²Ğ¸Ğ¹ Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»</h3>
            <div class="space-y-5">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞĞ°Ğ·Ğ²Ğ°</label>
                    <input v-model="newConsumable.name" placeholder="ĞĞ°Ğ¿Ñ€. Ğ¡Ñ‚Ğ°ĞºĞ°Ğ½ 300Ğ¼Ğ»" class="border p-2 rounded-lg w-full">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞĞ´Ğ¸Ğ½Ğ¸Ñ†Ñ</label>
                        <select v-model="newConsumable.unit_id" class="border p-2 rounded-lg w-full bg-white h-[42px]">
                            <option value="" disabled>ĞĞ±ĞµÑ€Ñ–Ñ‚ÑŒ...</option>
                            <option v-for="u in units" :key="u.id" :value="u.id">{{u.name}} ({{u.symbol}})</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ğ¦Ñ–Ğ½Ğ° (â‚´/Ğ¾Ğ´)</label>
                        <input v-model="newConsumable.cost_per_unit" type="number" class="border p-2 rounded-lg w-full">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ğ—Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº</label>
                    <input v-model="newConsumable.stock_quantity" type="number" class="border p-2 rounded-lg w-full">
                </div>
                <button @click="handleCreate" class="bg-teal-600 hover:bg-teal-700 text-white w-full py-3 rounded-xl font-bold shadow-lg shadow-teal-200 transition mt-2">Ğ”Ğ¾Ğ´Ğ°Ñ‚Ğ¸</button>
            </div>
        </div>
        <div class="bg-white rounded-2xl shadow-sm overflow-hidden border border-gray-100">
            <table class="w-full text-sm text-left">
                <thead class="bg-gray-50 text-gray-500 uppercase text-xs">
                    <tr><th class="p-4">ĞĞ°Ğ·Ğ²Ğ°</th><th class="p-4 text-right">Ğ—Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº</th><th class="p-4 text-center">Ğ”Ñ–Ñ—</th></tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    <tr v-for="c in consumables" :key="c.id" class="hover:bg-gray-50">
                        <td class="p-4 font-bold text-gray-700">{{ c.name }}
                            <div class="text-xs text-gray-400 font-normal">{{ c.cost_per_unit }} â‚´/{{ c.unit?.symbol }}</div>
                        </td>
                        <td class="p-4 text-right font-mono text-lg" :class="c.stock_quantity > 10 ? 'text-green-600' : 'text-red-500'">
                            {{ c.stock_quantity }} <span class="text-xs text-gray-400 font-sans">{{ c.unit?.symbol }}</span>
                        </td>
                        <td class="p-4 text-center">
                            <button @click="handleDelete(c.id)" class="text-gray-400 hover:text-red-500 px-2"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</template>

--------------------------------------------------
PATH: ./frontend/src/components/warehouse/tabs/ProductsTab.vue
--------------------------------------------------
<script setup>
import { ref, onMounted, computed } from 'vue' // <--- Ğ”Ğ¾Ğ´Ğ°Ğ² computed
import { useWarehouse } from '@/composables/useWarehouse'
import { useProducts } from '@/composables/useProducts'

// ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ğ´Ğ¾Ğ²Ñ–Ğ´Ğ½Ğ¸ĞºĞ¸ (ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ—, Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ğ¸ Ñ‚Ğ¾Ñ‰Ğ¾)
const { categories, recipes, ingredients, consumables } = useWarehouse()

// ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ñ„ÑƒĞ½ĞºÑ†Ñ–Ğ¾Ğ½Ğ°Ğ» Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ–Ğ²
const { 
    newProduct, isEditing, 
    variantBuilder, tempProductConsumable, tempVariantConsumable, tempVariantIngredient,
    resetForm, prepareEdit, saveProduct, deleteProduct, fetchProducts, filteredProducts, productSearch,
    
    saveVariant, editVariant, cancelVariantEdit, editingVariantIndex, removeVariant, 
    
    addProductConsumable, removeProductConsumable,
    addVariantConsumable, removeVariantConsumable,
    addIngredientToVariant, removeIngredientFromVariant
} = useProducts()

const showForm = ref(false)

const getCategoryName = (id) => {
    if (!categories.value) return '-'
    const c = categories.value.find(x => x.id === id)
    return c ? c.name : '-'
}

// --- ĞĞĞ’Ğ Ğ›ĞĞ“Ğ†ĞšĞ Ğ”Ğ›Ğ¯ ĞĞ”Ğ˜ĞĞ˜Ğ¦Ğ¬ Ğ’Ğ˜ĞœĞ†Ğ Ğ£ ---
const getIngredientUnit = (id) => {
    if (!id || !ingredients.value) return ''
    const ing = ingredients.value.find(i => i.id === id)
    return ing?.unit?.symbol || ''
}

const currentIngredientPlaceholder = computed(() => {
    const unit = getIngredientUnit(tempVariantIngredient.value.ingredient_id)
    return unit ? `Ğš-ÑÑ‚ÑŒ (${unit})` : 'Ğš-ÑÑ‚ÑŒ'
})
// --------------------------------------

const handleSave = async () => {
    const success = await saveProduct()
    if(success) {
        showForm.value = false
        await fetchProducts()
    }
}

const handleEdit = (product) => {
    prepareEdit(product)
    showForm.value = true
}

onMounted(async () => {
    console.log("ProductsTab mounted: fetching data...")
    await fetchProducts()
})
</script>

<template>
    <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
        
        <div v-if="showForm" class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 h-fit xl:col-span-1">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-gray-700">
                    {{ isEditing ? 'âœï¸ Ğ ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ' : 'ğŸ“¦ ĞĞ¾Ğ²Ğ¸Ğ¹ Ñ‚Ğ¾Ğ²Ğ°Ñ€' }}
                </h3>
                <button @click="showForm = false; resetForm()" class="text-xs text-red-500 hover:underline">Ğ—Ğ°ĞºÑ€Ğ¸Ñ‚Ğ¸</button>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞĞ°Ğ·Ğ²Ğ°</label>
                    <input v-model="newProduct.name" class="border p-2 rounded w-full focus:ring-2 ring-blue-100 outline-none">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ</label>
                        <select v-model="newProduct.category_id" class="border p-2 rounded w-full bg-white">
                            <option :value="null">-- Ğ‘ĞµĞ· ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ— --</option>
                            <option v-for="c in categories" :key="c.id" :value="c.id">{{ c.name }}</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ğ¦Ñ–Ğ½Ğ° (Ğ±Ğ°Ğ·Ğ¾Ğ²Ğ°)</label>
                        <input v-model.number="newProduct.price" type="number" class="border p-2 rounded w-full">
                    </div>
                </div>

                <div class="flex items-center gap-2 py-2">
                    <input type="checkbox" v-model="newProduct.has_variants" id="hasVar" class="w-4 h-4 text-blue-600">
                    <label for="hasVar" class="text-sm font-bold text-gray-700 select-none">Ğ¦ĞµĞ¹ Ñ‚Ğ¾Ğ²Ğ°Ñ€ Ğ¼Ğ°Ñ” Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸</label>
                </div>

                <div v-if="!newProduct.has_variants" class="bg-gray-50 p-3 rounded border border-gray-200 space-y-3">
                     <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞœĞ°Ğ¹ÑÑ‚ĞµÑ€-Ñ€ĞµÑ†ĞµĞ¿Ñ‚</label>
                        <select v-model="newProduct.master_recipe_id" class="border p-2 rounded w-full bg-white text-sm">
                            <option :value="null">-- Ğ‘ĞµĞ· Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ñƒ --</option>
                            <option v-for="r in recipes" :key="r.id" :value="r.id">{{ r.name }}</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ğ’Ğ¸Ñ…Ñ–Ğ´Ğ½Ğ° Ğ²Ğ°Ğ³Ğ° (Ğ³/Ğ¼Ğ»)</label>
                        <input v-model.number="newProduct.output_weight" type="number" class="border p-2 rounded w-full text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞŸĞ¾Ñ‡Ğ°Ñ‚ĞºĞ¾Ğ²Ğ¸Ğ¹ Ğ·Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº</label>
                        <input v-model.number="newProduct.stock_quantity" type="number" class="border p-2 rounded w-full text-sm" placeholder="0">
                    </div>
                </div>

                <div class="bg-teal-50/50 p-3 rounded border border-teal-100">
                    <label class="text-[10px] uppercase font-bold text-teal-600 mb-2 block">Ğ—Ğ°Ğ³Ğ°Ğ»ÑŒĞ½Ñ– Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸</label>
                    <div class="flex gap-2 mb-2">
                        <select v-model="tempProductConsumable.consumable_id" class="flex-1 border p-1 rounded text-sm bg-white">
                            <option value="">ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»...</option>
                            <option v-for="c in consumables" :key="c.id" :value="c.id">{{ c.name }}</option>
                        </select>
                        <button @click="addProductConsumable" class="bg-teal-500 text-white w-8 rounded hover:bg-teal-600">+</button>
                    </div>
                    <div class="flex flex-wrap gap-1">
                        <span v-for="(pc, idx) in newProduct.consumables" :key="idx" class="bg-white border border-teal-200 text-teal-700 text-xs px-2 py-1 rounded flex items-center gap-1">
                            {{ pc.name }} <button @click="removeProductConsumable(idx)" class="text-red-500 font-bold ml-1">&times;</button>
                        </span>
                    </div>
                </div>

                <div v-if="newProduct.has_variants" class="space-y-3">
                    <div class="border-t pt-2 mt-2">
                        <div class="flex justify-between items-center mb-2">
                             <h4 class="font-bold text-sm text-purple-700">
                                 {{ editingVariantIndex !== null ? 'âœï¸ Ğ ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ' : 'ĞšĞ¾Ğ½ÑÑ‚Ñ€ÑƒĞºÑ‚Ğ¾Ñ€ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñ–Ğ²' }}
                             </h4>
                             <button v-if="editingVariantIndex !== null" @click="cancelVariantEdit" class="text-xs text-gray-500 underline">Ğ¡ĞºĞ°ÑÑƒĞ²Ğ°Ñ‚Ğ¸</button>
                        </div>
                        
                        <div class="bg-purple-50 p-3 rounded-lg border border-purple-100 space-y-3" :class="{'ring-2 ring-purple-300': editingVariantIndex !== null}">
                            
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="text-[10px] uppercase font-bold text-gray-500">ĞĞ°Ğ·Ğ²Ğ°</label>
                                    <input v-model="variantBuilder.name" placeholder="Ğ½Ğ°Ğ¿Ñ€. XL" class="w-full border p-1.5 rounded text-sm">
                                </div>
                                <div>
                                    <label class="text-[10px] uppercase font-bold text-gray-500">Ğ¦Ñ–Ğ½Ğ°</label>
                                    <input v-model.number="variantBuilder.price" type="number" class="w-full border p-1.5 rounded text-sm">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="text-[10px] uppercase font-bold text-gray-500">Ğ¢ĞµÑ…. ĞºĞ°Ñ€Ñ‚Ğ°</label>
                                    <select v-model="variantBuilder.master_recipe_id" class="w-full border p-1.5 rounded text-sm bg-white">
                                        <option :value="null">-- Ğ‘ĞµĞ· Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ñƒ --</option>
                                        <option v-for="r in recipes" :key="r.id" :value="r.id">{{ r.name }}</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-[10px] uppercase font-bold text-gray-500">Ğ’Ğ°Ğ³Ğ° Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¾Ğ³Ğ¾ (Ğ³/Ğ¼Ğ»)</label>
                                    <input v-model.number="variantBuilder.output_weight" type="number" class="w-full border p-1.5 rounded text-sm">
                                </div>
                            </div>
                            
                            <div>
                                <label class="text-[10px] uppercase font-bold text-gray-500">ĞŸĞ¾Ñ‡Ğ°Ñ‚ĞºĞ¾Ğ²Ğ¸Ğ¹ Ğ·Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº (ÑˆÑ‚)</label>
                                <input v-model.number="variantBuilder.stock_quantity" type="number" class="w-full border p-1.5 rounded text-sm bg-white" placeholder="0">
                            </div>

                            <div class="bg-white/50 p-2 rounded border border-dashed border-purple-200">
                                <label class="text-[10px] uppercase font-bold text-purple-400">ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ</label>
                                <div class="flex gap-1 mb-1">
                                    <select v-model="tempVariantConsumable.consumable_id" class="flex-1 border p-1 rounded text-[10px] bg-white h-7">
                                        <option value="">ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»...</option>
                                        <option v-for="c in consumables" :key="c.id" :value="c.id">{{ c.name }}</option>
                                    </select>
                                    <input v-model.number="tempVariantConsumable.quantity" type="number" class="w-10 border p-1 rounded text-[10px] h-7" placeholder="Ğš-ÑÑ‚ÑŒ">
                                    <button @click="addVariantConsumable" class="bg-purple-500 text-white w-7 h-7 rounded hover:bg-purple-600 text-xs">+</button>
                                </div>
                                <div class="flex flex-wrap gap-1">
                                    <span v-for="(vc, idx) in variantBuilder.consumables" :key="idx" class="bg-white border text-[10px] px-1 rounded flex items-center gap-1">
                                        {{ vc.name }}: {{ vc.quantity }} <button @click="removeVariantConsumable(idx)" class="text-red-500 font-bold">&times;</button>
                                    </span>
                                </div>
                            </div>

                            <div class="bg-blue-50/50 p-2 rounded border border-dashed border-blue-200">
                                <label class="text-[10px] uppercase font-bold text-blue-500">Ğ”Ğ¾Ğ´Ğ°Ñ‚ĞºĞ¾Ğ²Ñ– Ñ–Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ğ¸</label>
                                <div class="flex gap-1 mb-1">
                                    <select v-model="tempVariantIngredient.ingredient_id" class="flex-1 border p-1 rounded text-[10px] bg-white h-7">
                                        <option value="">Ğ†Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚...</option>
                                        <option v-for="i in ingredients" :key="i.id" :value="i.id">
                                            {{ i.name }} ({{ i.unit?.symbol }})
                                        </option>
                                    </select>
                                    <input 
                                        v-model.number="tempVariantIngredient.quantity" 
                                        type="number" 
                                        class="w-16 border p-1 rounded text-[10px] h-7" 
                                        :placeholder="currentIngredientPlaceholder"
                                    >
                                    <button @click="addIngredientToVariant" class="bg-blue-500 text-white w-7 h-7 rounded hover:bg-blue-600 text-xs">+</button>
                                </div>
                                <div class="flex flex-wrap gap-1">
                                    <span v-for="(vi, idx) in variantBuilder.ingredients" :key="idx" class="bg-white border text-[10px] px-1 rounded flex items-center gap-1 text-blue-700">
                                        {{ vi.name }}: {{ vi.quantity }} {{ getIngredientUnit(vi.ingredient_id) }}
                                        <button @click="removeIngredientFromVariant(idx)" class="text-red-500 font-bold">&times;</button>
                                    </span>
                                </div>
                            </div>

                            <button @click="saveVariant" class="w-full text-xs font-bold py-2 rounded transition-colors"
                                :class="editingVariantIndex !== null ? 'bg-orange-400 text-white hover:bg-orange-500' : 'bg-purple-200 text-purple-800 hover:bg-purple-300'">
                                {{ editingVariantIndex !== null ? 'Ğ—Ğ±ĞµÑ€ĞµĞ³Ñ‚Ğ¸ Ğ·Ğ¼Ñ–Ğ½Ğ¸ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ' : 'Ğ”Ğ¾Ğ´Ğ°Ñ‚Ğ¸ Ñ†ĞµĞ¹ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚ Ñƒ ÑĞ¿Ğ¸ÑĞ¾Ğº' }}
                            </button>
                        </div>
                    </div>
                    
                    <div v-if="newProduct.variants.length > 0" class="space-y-2">
                        <div v-for="(v, idx) in newProduct.variants" :key="idx" 
                             class="bg-white border p-2 rounded flex justify-between items-center text-sm"
                             :class="{'border-purple-400 bg-purple-50': editingVariantIndex === idx}"
                        >
                            <div>
                                <span class="font-bold">{{ v.name }}</span> - {{ v.price }} Ğ³Ñ€Ğ½
                                <div class="text-xs text-gray-400">
                                    <span v-if="v.master_recipe_id" class="text-purple-600 mr-2">ğŸ“œ Ğ ĞµÑ†ĞµĞ¿Ñ‚ ID: {{ v.master_recipe_id }}</span>
                                    <span v-if="v.stock_quantity > 0" class="text-green-600 font-bold">Ğ—Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº: {{ v.stock_quantity }}</span>
                                    <span v-if="v.ingredients?.length" class="text-blue-500 ml-2">Ğ†Ğ½Ğ³Ñ€: {{ v.ingredients.length }}</span>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button @click="editVariant(idx)" class="text-blue-500 hover:text-blue-700"><i class="fas fa-pen"></i></button>
                                <button @click="removeVariant(idx)" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    </div>
                </div>

                <button @click="handleSave" class="w-full bg-green-600 text-white font-bold py-3 rounded-xl hover:bg-green-700 mt-4 shadow-lg shadow-green-100">
                    {{ isEditing ? 'Ğ—Ğ±ĞµÑ€ĞµĞ³Ñ‚Ğ¸ Ğ·Ğ¼Ñ–Ğ½Ğ¸' : 'Ğ¡Ñ‚Ğ²Ğ¾Ñ€Ğ¸Ñ‚Ğ¸ Ñ‚Ğ¾Ğ²Ğ°Ñ€' }}
                </button>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden flex flex-col h-full" :class="showForm ? 'xl:col-span-2' : 'xl:col-span-3'">
            
            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
                <div class="flex items-center gap-4">
                    <h2 class="font-bold text-gray-700">Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ–Ğ²</h2>
                    <input v-model="productSearch" placeholder="ĞŸĞ¾ÑˆÑƒĞº..." class="border rounded px-2 py-1 text-sm bg-white">
                </div>
                <button v-if="!showForm" @click="showForm = true; resetForm()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-bold text-sm shadow-md shadow-blue-100">
                    + ĞĞ¾Ğ²Ğ¸Ğ¹ Ñ‚Ğ¾Ğ²Ğ°Ñ€
                </button>
            </div>

            <div class="overflow-auto flex-1">
                <table class="w-full text-left text-sm">
                    <thead class="bg-gray-50 text-gray-500 uppercase text-xs sticky top-0">
                        <tr>
                            <th class="p-4">ĞĞ°Ğ·Ğ²Ğ°</th>
                            <th class="p-4">ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ</th>
                            <th class="p-4">Ğ¦Ñ–Ğ½Ğ° / Ğ’Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸</th>
                            <th class="p-4 text-center">Ğ”Ñ–Ñ—</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        <tr v-if="filteredProducts.length === 0">
                            <td colspan="4" class="p-8 text-center text-gray-400">
                                Ğ¢Ğ¾Ğ²Ğ°Ñ€Ñ–Ğ² Ğ½ĞµĞ¼Ğ°Ñ” Ğ°Ğ±Ğ¾ Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ...
                            </td>
                        </tr>
                        <tr v-for="p in filteredProducts" :key="p.id" class="hover:bg-gray-50 align-top group">
                            <td class="p-4 font-bold text-gray-800">{{ p.name }}</td>
                            <td class="p-4 text-gray-600">
                                <span class="bg-gray-100 px-2 py-1 rounded text-xs">{{ getCategoryName(p.category_id) }}</span>
                            </td>
                            <td class="p-4">
                                <div v-if="!p.has_variants" class="font-mono font-bold text-green-600">
                                    {{ p.price }} â‚´
                                </div>
                                
                                <div v-else class="space-y-2">
                                    <div v-for="v in p.variants" :key="v.id" class="text-xs bg-gray-50 p-2 rounded border border-gray-200">
                                        <div class="flex justify-between font-bold mb-1">
                                            <span>{{ v.name }}</span>
                                            <span>{{ v.price }} â‚´</span>
                                        </div>

                                        <div class="text-gray-500 flex flex-col gap-1">
                                            
                                            <div v-if="v.ingredients?.length" class="text-blue-600">
                                                <div class="flex items-start gap-1">
                                                    <i class="fas fa-flask mt-0.5"></i> 
                                                    <div class="flex flex-wrap gap-1">
                                                        <span v-for="vi in v.ingredients" :key="vi.id" class="bg-blue-50 border border-blue-100 px-1 rounded flex items-center gap-1">
                                                            {{ vi.ingredient_name || '?' }}: {{ vi.quantity }} {{ getIngredientUnit(vi.ingredient_id) }}
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>

                                            <div v-if="v.consumables?.length" class="text-teal-600">
                                                <div class="flex items-start gap-1">
                                                    <i class="fas fa-box-open mt-0.5"></i> 
                                                    <div class="flex flex-wrap gap-1">
                                                        <span v-for="vc in v.consumables" :key="vc.id" class="bg-teal-50 border border-teal-100 px-1 rounded">
                                                            {{ vc.consumable_name || '?' }}: {{ vc.quantity }}
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>

                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td class="p-4 text-center">
                                <div class="flex justify-center gap-2">
                                    <button @click="handleEdit(p)" class="text-blue-500 hover:text-blue-700 p-1.5 hover:bg-blue-50 rounded"><i class="fas fa-pen"></i></button>
                                    <button @click="deleteProduct(p.id)" class="text-red-400 hover:text-red-600 p-1.5 hover:bg-red-50 rounded"><i class="fas fa-trash"></i></button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</template>

--------------------------------------------------
PATH: ./frontend/src/components/warehouse/modals/HistoryModal.vue
--------------------------------------------------
<script setup>
import { ref, watch } from 'vue'

const props = defineProps({
  isOpen: Boolean,
  item: Object // { id, type, name }
})

const emit = defineEmits(['close'])
const history = ref([])
const loading = ref(false)

const formatDate = (dateStr) => {
  return new Date(dateStr).toLocaleString('uk-UA', { 
    day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' 
  })
}

const fetchHistory = async () => {
  if (!props.item) return
  
  loading.value = true
  history.value = [] 

  try {
    // Ğ’ĞĞ–Ğ›Ğ˜Ğ’Ğ: Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ Ğ²Ñ–Ğ´Ğ½Ğ¾ÑĞ½Ğ¸Ğ¹ ÑˆĞ»ÑÑ… /api/
    // Ğ‘Ñ€Ğ°ÑƒĞ·ĞµÑ€ ÑĞ°Ğ¼ Ğ¿Ñ–Ğ´ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¸Ğ¹ IP (100.100.84.4)
    const id = props.item.original_id || props.item.id
    const url = `/api/history/?entity_type=${props.item.type}&entity_id=${props.item.id || props.item.original_id}`
    
    console.log("HistoryModal requesting:", url) // Ğ”Ğ»Ñ Ğ½Ğ°Ğ»Ğ°Ğ³Ğ¾Ğ´Ğ¶ĞµĞ½Ğ½Ñ
    
    const res = await fetch(url)
    
    if (res.ok) {
        history.value = await res.json()
    } else {
        console.error("Server error:", res.status)
    }
  } catch (e) {
    console.error("Network error:", e)
  } finally {
    loading.value = false
  }
}

watch(() => props.isOpen, (val) => {
  if (val) {
    history.value = []
    fetchHistory()
  }
})
</script>

<template>
  <div v-if="isOpen" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[80vh] animate-fade-in-up">
      
      <div class="p-4 border-b flex justify-between items-center bg-gray-50">
        <div>
           <div class="text-xs uppercase font-bold text-gray-400">Ğ†ÑÑ‚Ğ¾Ñ€Ñ–Ñ Ñ€ÑƒÑ…Ñƒ</div>
           <h3 class="font-bold text-lg text-gray-800">{{ item?.name }}</h3>
        </div>
        <button @click="emit('close')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
      </div>

      <div class="flex-1 overflow-y-auto p-0 custom-scrollbar">
         <div v-if="loading" class="p-8 text-center text-gray-400"><i class="fas fa-spinner fa-spin"></i> Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ...</div>
         <div v-else-if="history.length === 0" class="p-8 text-center text-gray-400">Ğ†ÑÑ‚Ğ¾Ñ€Ñ–Ñ Ğ¿Ğ¾Ñ€Ğ¾Ğ¶Ğ½Ñ</div>
         
         <table v-else class="w-full text-sm text-left">
           <thead class="bg-gray-100 text-gray-500 text-xs uppercase sticky top-0">
             <tr>
               <th class="p-3">Ğ”Ğ°Ñ‚Ğ°</th>
               <th class="p-3">ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°</th>
               <th class="p-3 text-right">Ğ—Ğ¼Ñ–Ğ½Ğ°</th>
               <th class="p-3 text-right">Ğ—Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº</th>
             </tr>
           </thead>
           <tbody class="divide-y divide-gray-100">
             <tr v-for="h in history" :key="h.id" class="hover:bg-gray-50">
               <td class="p-3 text-gray-500 whitespace-nowrap">{{ formatDate(h.created_at) }}</td>
               <td class="p-3">
                 <span v-if="h.reason === 'manual_correction'" class="bg-gray-200 text-gray-600 px-2 py-1 rounded text-[10px] font-bold">ĞšĞ¾Ñ€ĞµĞºÑ†Ñ–Ñ</span>
                 <span v-else-if="h.reason.includes('sale')" class="bg-green-100 text-green-700 px-2 py-1 rounded text-[10px] font-bold">ĞŸÑ€Ğ¾Ğ´Ğ°Ğ¶</span>
                 <span v-else class="text-gray-700 font-bold text-xs">{{ h.reason }}</span>
               </td>
               <td class="p-3 text-right font-mono font-bold" :class="h.change_amount > 0 ? 'text-green-600' : 'text-red-500'">
                 {{ h.change_amount > 0 ? '+' : '' }}{{ h.change_amount }}
               </td>
               <td class="p-3 text-right font-mono text-gray-600">
                 {{ h.balance_after }}
               </td>
             </tr>
           </tbody>
         </table>
      </div>

    </div>
  </div>
</template>

<style scoped>
.animate-fade-in-up { animation: fadeInUp 0.3s ease-out; }
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>

--------------------------------------------------
PATH: ./frontend/src/components/pos/ProductCard.vue
--------------------------------------------------
<script setup>
import { computed } from 'vue'

const props = defineProps({ 
  product: { type: Object, required: true } 
})

// Ğ¯Ğ²Ğ½Ğ¾ Ğ²ĞºĞ°Ğ·ÑƒÑ”Ğ¼Ğ¾, Ñ‰Ğ¾ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚ Ñ€ĞµĞ°Ğ³ÑƒÑ” Ğ½Ğ° ĞºĞ»Ñ–Ğº, Ñ…Ğ¾Ñ‡Ğ° Ñ†Ğµ native event
const emit = defineEmits(['click'])

// Ğ›Ğ¾Ğ³Ñ–ĞºĞ° Ñ–ĞºĞ¾Ğ½Ğ¾Ğº (View Logic)
const productIcon = computed(() => {
  const name = props.product.name?.toLowerCase() || ''
  const cat = props.product.category?.name?.toLowerCase() || ''
  
  if (name.includes('ĞºĞ°Ğ²Ğ°') || name.includes('ĞµÑĞ¿Ñ€ĞµÑĞ¾') || cat.includes('Ğ½Ğ°Ğ¿Ğ¾Ñ—')) return 'fas fa-mug-hot'
  if (name.includes('Ñ‡Ğ°Ğ¹')) return 'fas fa-leaf'
  if (name.includes('Ñ‚Ğ¾Ñ€Ñ‚') || name.includes('Ğ´ĞµÑĞµÑ€Ñ‚') || cat.includes('Ğ´ĞµÑĞµÑ€Ñ‚Ğ¸')) return 'fas fa-birthday-cake'
  if (name.includes('ĞºÑ€ÑƒĞ°ÑĞ°Ğ½')) return 'fas fa-bread-slice'
  
  return 'fas fa-box'
})

// Ğ›Ğ¾Ğ³Ñ–ĞºĞ° ĞºĞ¾Ğ»ÑŒĞ¾Ñ€Ñ–Ğ² (View Logic)
const cardColor = computed(() => {
  const slug = props.product.category?.slug || ''
  const colors = {
    'hot-drinks': 'bg-orange-50 text-orange-600 border-orange-100',
    'desserts': 'bg-pink-50 text-pink-600 border-pink-100'
  }
  return colors[slug] || 'bg-white text-gray-700 border-gray-100'
})

const hasOptions = computed(() => {
  return props.product.has_variants || (props.product.modifier_groups && props.product.modifier_groups.length > 0)
})

// Ğ›Ğ¾Ğ³Ñ–ĞºĞ° Ñ†Ñ–Ğ½Ğ¸: Ğ¿Ğ¾ĞºĞ°Ğ·ÑƒÑ”Ğ¼Ğ¾ Ğ¼Ñ–Ğ½Ñ–Ğ¼Ğ°Ğ»ÑŒĞ½Ñƒ, ÑĞºÑ‰Ğ¾ Ñ” Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸
const displayPrice = computed(() => {
  if (props.product.has_variants && props.product.variants?.length > 0) {
    const prices = props.product.variants.map(v => v.price)
    return Math.min(...prices)
  }
  return props.product.price
})
</script>

<template>
  <div 
    @click="emit('click', product)"
    class="relative group cursor-pointer transition-all duration-200 hover:-translate-y-1 hover:shadow-xl rounded-2xl border overflow-hidden bg-white"
  >
    <div class="h-32 flex items-center justify-center text-5xl transition-transform group-hover:scale-110" :class="cardColor">
      <i :class="productIcon"></i>
    </div>

    <div class="p-4">
      <div v-if="product.category" class="text-xs font-bold uppercase tracking-wider text-gray-400 mb-1">
        {{ product.category.name }}
      </div>
      
      <h3 class="font-bold text-lg text-gray-800 leading-tight mb-2 line-clamp-2 min-h-[3.5rem]">
        {{ product.name }}
      </h3>
      
      <div class="flex justify-between items-center mt-3">
        <div class="flex flex-col">
            <span v-if="product.has_variants" class="text-xs text-gray-400">Ğ²Ñ–Ğ´</span>
            <span class="text-xl font-bold text-gray-900">{{ displayPrice }} â‚´</span>
        </div>
        
        <button class="w-8 h-8 rounded-full flex items-center justify-center transition shadow-lg"
            :class="hasOptions ? 'bg-purple-600 hover:bg-purple-700 text-white' : 'bg-gray-900 hover:bg-green-500 text-white'">
          <i class="fas" :class="hasOptions ? 'fa-sliders-h text-xs' : 'fa-plus text-xs'"></i>
        </button>
      </div>
    </div>
  </div>
</template>

--------------------------------------------------
PATH: ./frontend/src/components/pos/ProductModal.vue
--------------------------------------------------
<script setup>
import { ref, computed, watch } from 'vue'
import { useCart } from '@/composables/useCart'

const props = defineProps({
  isOpen: Boolean,
  product: Object 
})

const emit = defineEmits(['close'])

const { addToCart } = useCart()

const selectedVariant = ref(null)
const selectedModifiers = ref({}) 
const selectedProcesses = ref({}) 

// --- Ğ†Ğ½Ñ–Ñ†Ñ–Ğ°Ğ»Ñ–Ğ·Ğ°Ñ†Ñ–Ñ (Reset & Defaults) ---
watch(() => props.isOpen, (isOpen) => {
  if (isOpen && props.product) {
    selectedVariant.value = null
    selectedModifiers.value = {}
    selectedProcesses.value = {} 

    // Auto-select Variant (cheapest)
    if (props.product.variants && props.product.variants.length > 0) {
      const sorted = [...props.product.variants].sort((a, b) => a.price - b.price)
      selectedVariant.value = sorted[0]
    }

    // Auto-select Required Modifiers
    if (props.product.modifier_groups) {
      props.product.modifier_groups.forEach(group => {
        if (group.is_required && group.modifiers.length > 0) {
          selectedModifiers.value[group.id] = group.modifiers[0].id
        }
      })
    }

    // Auto-select First Process Option
    if (props.product.process_groups) {
        props.product.process_groups.forEach(pg => {
            if (pg.options && pg.options.length > 0) {
                selectedProcesses.value[pg.id] = pg.options[0].name
            }
        })
    }
  }
})

const currentPrice = computed(() => {
  if (!props.product) return 0
  let price = 0
  
  if (props.product.has_variants && selectedVariant.value) {
    price += selectedVariant.value.price
  } else {
    price += props.product.price
  }
  
  if (props.product.modifier_groups) {
    props.product.modifier_groups.forEach(group => {
      const modId = selectedModifiers.value[group.id]
      if (modId) {
        const mod = group.modifiers.find(m => m.id === modId)
        if (mod) price += mod.price_change
      }
    })
  }
  return price
})

// Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ñ–Ñ Ğ½Ğ°Ğ·Ğ²Ğ¸ Ğ´Ğ»Ñ ĞºĞ¾ÑˆĞ¸ĞºĞ°
const generateName = () => {
  let name = props.product.name
  if (selectedVariant.value) {
    name += ` (${selectedVariant.value.name})`
  }
  const processValues = Object.values(selectedProcesses.value)
  if (processValues.length > 0) {
      name += ` [${processValues.join(', ')}]`
  }
  return name
}

const handleConfirm = async () => {
  if (props.product.has_variants && !selectedVariant.value) {
      alert("Ğ‘ÑƒĞ´ÑŒ Ğ»Ğ°ÑĞºĞ°, Ğ¾Ğ±ĞµÑ€Ñ–Ñ‚ÑŒ Ñ€Ğ¾Ğ·Ğ¼Ñ–Ñ€/Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚")
      return
  }

  // Ğ¤Ğ¾Ñ€Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ğ¾Ğ±'Ñ”ĞºÑ‚ Ğ´Ğ»Ñ ĞºĞ¾ÑˆĞ¸ĞºĞ° (ÑĞ¿Ñ–Ğ²Ğ¿Ğ°Ğ´Ğ°Ñ” Ğ· backend ÑÑ…ĞµĞ¼Ğ¾Ñ)
  const payload = {
    product_id: props.product.id,
    variant_id: selectedVariant.value ? selectedVariant.value.id : null,
    modifiers: Object.values(selectedModifiers.value).map(id => ({ modifier_id: id })),
    quantity: 1, // Ğ—Ğ° Ğ·Ğ°Ğ¼Ğ¾Ğ²Ñ‡ÑƒĞ²Ğ°Ğ½Ğ½ÑĞ¼ 1
    // Ğ”Ğ¾Ğ´Ğ°Ñ‚ĞºĞ¾Ğ²Ñ– Ğ¿Ğ¾Ğ»Ñ Ğ´Ğ»Ñ UI, ÑĞºÑ– Ğ½Ğµ Ğ¹Ğ´ÑƒÑ‚ÑŒ Ğ² Ğ‘Ğ”, Ğ°Ğ»Ğµ Ğ¼Ğ¾Ğ¶ÑƒÑ‚ÑŒ Ğ±ÑƒÑ‚Ğ¸ ĞºĞ¾Ñ€Ğ¸ÑĞ½Ñ– Ğ´Ğ»Ñ Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ñ–ÑÑ‚Ğ¸Ñ‡Ğ½Ğ¾Ğ³Ğ¾ Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ
    name: generateName(),
    price: currentPrice.value
  }

  await addToCart(payload) // Ğ’Ğ¸ĞºĞ»Ğ¸ĞºĞ°Ñ”Ğ¼Ğ¾ Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñƒ Ğ´Ñ–Ñ
  emit('close')
}
</script>

<template>
  <div v-if="isOpen" class="fixed inset-0 z-50 flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" @click="emit('close')"></div>

    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg relative overflow-hidden flex flex-col max-h-[90vh] animate-fade-in-up">
      
      <div class="p-6 bg-gray-50 border-b flex justify-between items-start">
        <div>
           <div class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">
             {{ product.category?.name || 'Ğ¢Ğ¾Ğ²Ğ°Ñ€' }}
           </div>
           <h2 class="text-3xl font-bold text-gray-800 leading-none">{{ product.name }}</h2>
        </div>
        <button @click="emit('close')" class="text-gray-400 hover:text-gray-600 bg-white p-2 rounded-full shadow-sm hover:shadow transition">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>

      <div class="p-6 overflow-y-auto space-y-6 custom-scrollbar">
        
        <div v-if="product.has_variants && product.variants.length > 0">
          <label class="block text-sm font-bold text-gray-900 mb-3">ĞĞ±ĞµÑ€Ñ–Ñ‚ÑŒ Ñ€Ğ¾Ğ·Ğ¼Ñ–Ñ€/Ğ²Ğ°Ğ³Ñƒ:</label>
          <div class="grid grid-cols-3 gap-3">
            <button 
              v-for="variant in product.variants" 
              :key="variant.id"
              @click="selectedVariant = variant"
              class="py-3 px-2 rounded-xl border-2 transition-all flex flex-col items-center justify-center gap-1"
              :class="selectedVariant?.id === variant.id ? 'border-purple-600 bg-purple-50 text-purple-700' : 'border-gray-200 hover:border-gray-300 text-gray-600'"
            >
              <span class="font-bold">{{ variant.name }}</span>
              <span class="text-xs">{{ variant.price }} â‚´</span>
            </button>
          </div>
        </div>

        <div v-if="product.process_groups && product.process_groups.length > 0" class="space-y-4">
            <div v-for="pg in product.process_groups" :key="pg.id" class="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                <label class="block text-sm font-bold text-indigo-900 mb-2">
                    {{ pg.name }}
                </label>
                <div class="flex flex-wrap gap-2">
                    <button 
                        v-for="opt in pg.options" 
                        :key="opt.id"
                        @click="selectedProcesses[pg.id] = opt.name"
                        class="px-4 py-2 rounded-lg text-sm font-bold transition-all shadow-sm border"
                        :class="selectedProcesses[pg.id] === opt.name ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-gray-600 border-gray-200 hover:bg-white/80'"
                    >
                        {{ opt.name }}
                    </button>
                </div>
            </div>
        </div>

        <div v-if="product.modifier_groups && product.modifier_groups.length > 0" class="space-y-4">
          <div v-for="group in product.modifier_groups" :key="group.id" class="bg-gray-50 p-4 rounded-xl border border-gray-100">
            <label class="block text-sm font-bold text-gray-700 mb-2">
              {{ group.name }} <span v-if="!group.is_required" class="text-gray-400 font-normal text-xs">(ĞĞ¿Ñ†Ñ–Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)</span>
            </label>
            
            <div class="flex flex-wrap gap-2">
              <button 
                v-for="mod in group.modifiers" 
                :key="mod.id"
                @click="selectedModifiers[group.id] = mod.id"
                class="px-4 py-2 rounded-lg text-sm font-medium transition-all shadow-sm border"
                :class="selectedModifiers[group.id] === mod.id ? 'bg-gray-800 text-white border-gray-800' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-100'"
              >
                {{ mod.name }}
                <span v-if="mod.price_change > 0" class="text-xs opacity-70 ml-1">+{{ mod.price_change }}</span>
              </button>
            </div>
          </div>
        </div>

      </div>

      <div class="p-6 border-t bg-gray-50 flex justify-between items-center">
        <div class="text-2xl font-bold text-gray-900">
          {{ currentPrice }} â‚´
        </div>
        <button 
          @click="handleConfirm"
          class="bg-purple-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-purple-700 transition shadow-lg shadow-purple-200 active:scale-95 flex items-center gap-2"
        >
          <i class="fas fa-cart-plus"></i> Ğ”Ğ¾Ğ´Ğ°Ñ‚Ğ¸
        </button>
      </div>

    </div>
  </div>
</template>

<style scoped>
.animate-fade-in-up { animation: fadeInUp 0.3s ease-out; }
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(20px) scale(0.95); }
  to { opacity: 1; transform: translateY(0) scale(1); }
}
</style>

--------------------------------------------------
PATH: ./frontend/src/components/pos/CartDrawer.vue
--------------------------------------------------
<script setup>
import { ref, watch, onMounted } from 'vue'
import { useCart } from '@/composables/useCart'

const props = defineProps({
  isOpen: Boolean
})

const emit = defineEmits(['close'])

// ĞŸÑ–Ğ´ĞºĞ»ÑÑ‡Ğ°Ñ”Ğ¼Ğ¾ Ğ»Ğ¾Ğ³Ñ–ĞºÑƒ ĞºĞ¾ÑˆĞ¸ĞºĞ°
const { 
  cartItems, 
  totalSum, 
  paymentMethod, 
  isProcessing, 
  selectedCustomer,
  fetchCart, 
  updateQty, 
  removeItem, 
  clearCart, 
  processCheckout,
  setCustomer,
  removeCustomer
} = useCart()

// --- UI Local State (ĞŸĞ¾ÑˆÑƒĞº ĞºĞ»Ñ–Ñ”Ğ½Ñ‚Ğ°) ---
const customerSearch = ref('')
const customerResults = ref([])

const handleSearchCustomer = async () => {
  if (customerSearch.value.length < 2) { customerResults.value = []; return }
  try {
    const res = await fetch(`/api/customers/search/?q=${customerSearch.value}`)
    if (res.ok) customerResults.value = await res.json()
  } catch (err) { console.error(err) }
}

const selectCustomerUI = (c) => {
  setCustomer(c) // Ğ—Ğ°Ğ¿Ğ¸ÑÑƒÑ”Ğ¼Ğ¾ Ğ² Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ¸Ğ¹ ÑÑ‚Ğ°Ğ½
  customerSearch.value = ''
  customerResults.value = []
}

const handleCheckout = async () => {
  const res = await processCheckout()
  alert(res.text)
  if (res.success) {
    emit('close')
  }
}

// Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ÑƒÑ”Ğ¼Ğ¾ ĞºĞ¾ÑˆĞ¸Ğº Ğ¿Ñ€Ğ¸ Ğ²Ñ–Ğ´ĞºÑ€Ğ¸Ñ‚Ñ‚Ñ–
watch(() => props.isOpen, (val) => {
  if (val) fetchCart()
})
</script>

<template>
  <div class="fixed inset-0 z-50 flex justify-end transition-opacity duration-300" 
       :class="isOpen ? 'opacity-100 pointer-events-auto' : 'opacity-0 pointer-events-none'">
    
    <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" @click="emit('close')"></div>

    <div class="relative w-full max-w-md bg-white h-full shadow-2xl flex flex-col transition-transform duration-300 transform"
         :class="isOpen ? 'translate-x-0' : 'translate-x-full'">
      
      <div class="p-5 bg-gray-900 text-white flex justify-between items-center shadow-md">
        <h2 class="text-xl font-bold flex items-center gap-2"><i class="fas fa-shopping-cart"></i> ĞšĞ¾ÑˆĞ¸Ğº</h2>
        <div class="flex gap-3">
            <button @click="clearCart(false)" class="text-gray-400 hover:text-red-400 transition" title="ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚Ğ¸ Ğ²ÑĞµ"><i class="fas fa-trash-alt"></i></button>
            <button @click="emit('close')" class="text-gray-400 hover:text-white transition"><i class="fas fa-times text-xl"></i></button>
        </div>
      </div>

      <div class="flex-1 overflow-y-auto p-4 bg-gray-50 custom-scrollbar">
        <div v-if="cartItems.length === 0" class="flex flex-col items-center justify-center h-full text-gray-400">
          <i class="fas fa-shopping-basket text-6xl mb-4 opacity-20"></i>
          <p>ĞšĞ¾ÑˆĞ¸Ğº Ğ¿Ğ¾Ñ€Ğ¾Ğ¶Ğ½Ñ–Ğ¹</p>
        </div>

        <div v-else class="space-y-3">
          <div v-for="item in cartItems" :key="item.cart_item_id" 
               class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col gap-3">
            
            <div class="flex justify-between items-start">
              <span class="font-bold text-gray-800 text-lg leading-tight">{{ item.name }}</span>
              <span class="font-mono font-bold text-gray-900 whitespace-nowrap">{{ (item.price * item.quantity).toFixed(2) }} â‚´</span>
            </div>

            <div class="flex justify-between items-center bg-gray-50 rounded-lg p-1">
                <div class="flex items-center gap-3">
                    <button @click="updateQty(item.cart_item_id, -1)" 
                            class="w-8 h-8 rounded-full bg-white border border-gray-300 text-gray-600 hover:bg-gray-100 flex items-center justify-center font-bold shadow-sm active:scale-95">-</button>
                    <span class="w-6 text-center font-bold text-gray-800">{{ item.quantity }}</span>
                    <button @click="updateQty(item.cart_item_id, 1)" 
                            class="w-8 h-8 rounded-full bg-gray-800 text-white hover:bg-gray-700 flex items-center justify-center font-bold shadow-sm active:scale-95">+</button>
                </div>
                
                <button @click="removeItem(item.cart_item_id)" class="text-red-400 hover:text-red-600 p-2">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
          </div>
        </div>
      </div>

      <div class="p-6 bg-white border-t border-gray-200 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
        
        <div class="mb-4">
            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞšĞ»Ñ–Ñ”Ğ½Ñ‚</label>
            <div v-if="!selectedCustomer" class="relative">
                <div class="flex items-center border rounded-lg bg-gray-50 overflow-hidden">
                    <i class="fas fa-search text-gray-400 ml-3"></i>
                    <input v-model="customerSearch" @input="handleSearchCustomer" placeholder="Ğ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½ Ğ°Ğ±Ğ¾ Ñ–Ğ¼'Ñ..." class="w-full p-2 bg-transparent outline-none text-sm">
                </div>
                <div v-if="customerResults.length > 0" class="absolute bottom-full left-0 w-full bg-white border shadow-xl rounded-lg mb-1 max-h-40 overflow-y-auto z-10">
                    <div v-for="c in customerResults" :key="c.id" @click="selectCustomerUI(c)" class="p-2 hover:bg-blue-50 cursor-pointer border-b flex justify-between items-center">
                         <div><div class="font-bold text-sm">{{ c.name }}</div><div class="text-xs text-gray-500">{{ c.phone }}</div></div>
                         <i class="fas fa-plus-circle text-blue-500"></i>
                    </div>
                </div>
            </div>
            <div v-else class="flex justify-between items-center bg-blue-50 border border-blue-200 p-2 rounded-lg">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center text-xs font-bold">{{ selectedCustomer.name.charAt(0) }}</div>
                    <div><div class="font-bold text-sm text-blue-900">{{ selectedCustomer.name }}</div><div class="text-xs text-blue-600">{{ selectedCustomer.phone }}</div></div>
                </div>
                <button @click="removeCustomer" class="text-gray-400 hover:text-red-500 px-2"><i class="fas fa-times"></i></button>
            </div>
        </div>

        <div class="mb-4">
            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ĞĞ¿Ğ»Ğ°Ñ‚Ğ°</label>
            <div class="grid grid-cols-2 gap-3">
                <button @click="paymentMethod = 'cash'" class="py-2 px-4 rounded-lg border-2 flex items-center justify-center gap-2 transition-all" :class="paymentMethod === 'cash' ? 'border-green-500 bg-green-50 text-green-700 font-bold' : 'border-gray-200 text-gray-500'"> <i class="fas fa-money-bill-wave"></i> Ğ“Ğ¾Ñ‚Ñ–Ğ²ĞºĞ° </button>
                <button @click="paymentMethod = 'card'" class="py-2 px-4 rounded-lg border-2 flex items-center justify-center gap-2 transition-all" :class="paymentMethod === 'card' ? 'border-blue-500 bg-blue-50 text-blue-700 font-bold' : 'border-gray-200 text-gray-500'"> <i class="fas fa-credit-card"></i> ĞšĞ°Ñ€Ñ‚ĞºĞ° </button>
            </div>
        </div>

        <div class="flex justify-between items-center text-2xl font-bold mb-4 text-gray-800">
          <span>Ğ Ğ°Ğ·Ğ¾Ğ¼:</span><span>{{ totalSum.toFixed(2) }} â‚´</span>
        </div>
        
        <button @click="handleCheckout" :disabled="cartItems.length === 0 || isProcessing" class="w-full py-4 rounded-xl font-bold text-lg text-white transition shadow-lg flex justify-center items-center gap-2 disabled:bg-gray-400" :class="paymentMethod === 'cash' ? 'bg-green-600 hover:bg-green-700' : 'bg-blue-600 hover:bg-blue-700'">
          <span v-if="isProcessing"><i class="fas fa-spinner fa-spin"></i> ĞĞ±Ñ€Ğ¾Ğ±ĞºĞ°...</span>
          <span v-else>ĞĞ¿Ğ»Ğ°Ñ‚Ğ¸Ñ‚Ğ¸</span>
        </button>
      </div>
    </div>
  </div>
</template>

--------------------------------------------------
PATH: ./frontend/src/components/crm/Customers.vue
--------------------------------------------------
<script setup>
import { ref, onMounted, computed } from 'vue'
import axios from 'axios'

// --- ĞšĞĞĞ¤Ğ†Ğ“Ğ£Ğ ĞĞ¦Ğ†Ğ¯ API ---
const API_URL = 'http://localhost:8001/customers/'

// --- Ğ¡Ğ¢ĞĞ ---
const customers = ref([])
const showModal = ref(false)
const searchQuery = ref('')
const isEditing = ref(false)
const editingId = ref(null)

// Ğ¤Ğ¾Ñ€Ğ¼Ğ°
const formData = ref({
    name: '',
    phone: '',
    email: '',
    notes: ''
})

// --- API Ğ—ĞĞŸĞ˜Ğ¢Ğ˜ ---

const fetchCustomers = async () => {
    try {
        const res = await axios.get(API_URL)
        console.log("ĞÑ‚Ñ€Ğ¸Ğ¼Ğ°Ğ½Ñ– ĞºĞ»Ñ–Ñ”Ğ½Ñ‚Ğ¸:", res.data)
        customers.value = res.data
    } catch (err) {
        console.error("ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ ĞºĞ»Ñ–Ñ”Ğ½Ñ‚Ñ–Ğ²:", err)
    }
}

const handleSave = async () => {
    if (!formData.value.name) return alert("Ğ†Ğ¼'Ñ Ğ¾Ğ±Ğ¾Ğ²'ÑĞ·ĞºĞ¾Ğ²Ğµ!")
    if (!formData.value.phone) return alert("Ğ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½ Ğ¾Ğ±Ğ¾Ğ²'ÑĞ·ĞºĞ¾Ğ²Ğ¸Ğ¹!")

    try {
        if (isEditing.value) {
            await axios.put(`${API_URL}${editingId.value}`, formData.value)
        } else {
            await axios.post(API_URL, formData.value)
        }
        
        closeModal()
        await fetchCustomers()
    } catch (err) {
        console.error(err)
        alert("ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ·Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ½Ñ–. ĞœĞ¾Ğ¶Ğ»Ğ¸Ğ²Ğ¾ Ñ‚Ğ°ĞºĞ¸Ğ¹ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½ Ğ²Ğ¶Ğµ Ñ–ÑĞ½ÑƒÑ”.")
    }
}

const deleteCustomer = async (id) => {
    if(!confirm("Ğ’Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğ¸ Ñ†ÑŒĞ¾Ğ³Ğ¾ ĞºĞ»Ñ–Ñ”Ğ½Ñ‚Ğ° Ğ· Ğ±Ğ°Ğ·Ğ¸?")) return
    try {
        await axios.delete(`${API_URL}${id}`)
        fetchCustomers()
    } catch (err) {
        alert("ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ²Ğ¸Ğ´Ğ°Ğ»ĞµĞ½Ğ½Ñ")
    }
}

// --- Ğ›ĞĞ“Ğ†ĞšĞ Ğ†ĞĞ¢Ğ•Ğ Ğ¤Ğ•Ğ™Ğ¡Ğ£ ---

const openCreateModal = () => {
    isEditing.value = false
    editingId.value = null
    formData.value = { name: '', phone: '', email: '', notes: '' }
    showModal.value = true
}

const openEditModal = (customer) => {
    isEditing.value = true
    editingId.value = customer.id
    formData.value = {
        name: customer.name,
        phone: customer.phone,
        email: customer.email || '',
        notes: customer.notes || ''
    }
    showModal.value = true
}

const closeModal = () => {
    showModal.value = false
    formData.value = { name: '', phone: '', email: '', notes: '' }
}

const filteredCustomers = computed(() => {
    if (!searchQuery.value) return customers.value
    const q = searchQuery.value.toLowerCase()
    return customers.value.filter(c => 
        c.name.toLowerCase().includes(q) || 
        (c.phone && c.phone.includes(q)) ||
        (c.email && c.email.toLowerCase().includes(q))
    )
})

onMounted(fetchCustomers)
</script>

<template>
    <div class="h-full w-full bg-white rounded-2xl shadow-sm border border-gray-100 flex flex-col overflow-hidden md:ml-64 transition-all duration-300" style="width: calc(100% - 16rem);">
        
        <div class="p-6 border-b border-gray-100 flex flex-col md:flex-row justify-between items-center gap-4 bg-gray-50/50">
            <div>
                <h2 class="text-xl font-bold text-gray-800">ĞšĞ»Ñ–Ñ”Ğ½Ñ‚Ğ¸</h2>
                <p class="text-xs text-gray-500">Ğ‘Ğ°Ğ·Ğ° ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ñ–Ğ² CRM</p>
            </div>

            <div class="flex w-full md:w-auto gap-3">
                <div class="relative flex-1 md:w-64">
                    <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400">
                        <i class="fas fa-search"></i>
                    </span>
                    <input 
                        v-model="searchQuery" 
                        type="text" 
                        placeholder="ĞŸĞ¾ÑˆÑƒĞº (Ñ–Ğ¼'Ñ, Ñ‚ĞµĞ», email)..." 
                        class="w-full pl-10 pr-4 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-100 outline-none text-sm transition bg-white"
                    >
                </div>

                <button 
                    @click="openCreateModal" 
                    class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-xl font-bold shadow-lg shadow-blue-100 transition transform active:scale-95 flex items-center gap-2 whitespace-nowrap text-sm"
                >
                    <i class="fas fa-user-plus"></i>
                    <span>Ğ”Ğ¾Ğ´Ğ°Ñ‚Ğ¸</span>
                </button>
            </div>
        </div>

        <div class="flex-1 overflow-auto">
            <table class="w-full text-left text-sm text-gray-600">
                <thead class="bg-gray-50 text-xs uppercase font-bold text-gray-500 sticky top-0 z-10 shadow-sm">
                    <tr>
                        <th class="p-4 border-b">ĞšĞ»Ñ–Ñ”Ğ½Ñ‚</th>
                        <th class="p-4 border-b">Ğ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½</th>
                        <th class="p-4 border-b">Email</th>
                        <th class="p-4 border-b">ĞĞ¾Ñ‚Ğ°Ñ‚ĞºĞ¸</th>
                        <th class="p-4 border-b text-center">Ğ”Ñ–Ñ—</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    <tr v-if="filteredCustomers.length === 0">
                        <td colspan="5" class="p-8 text-center text-gray-400">
                            <div class="flex flex-col items-center gap-2">
                                <i class="fas fa-users-slash text-2xl"></i>
                                <span>ĞšĞ»Ñ–Ñ”Ğ½Ñ‚Ñ–Ğ² Ğ½Ğµ Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾</span>
                            </div>
                        </td>
                    </tr>
                    <tr v-for="c in filteredCustomers" :key="c.id" class="hover:bg-blue-50/30 transition group">
                        
                        <td class="p-4 font-medium text-gray-900">
                            <div class="flex items-center gap-3">
                                <div class="w-9 h-9 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-xs border border-blue-200 shadow-sm shrink-0">
                                    {{ c.name ? c.name.charAt(0).toUpperCase() : '?' }}
                                </div>
                                <div class="flex flex-col">
                                    <span v-if="c.name">{{ c.name }}</span>
                                    <span v-else class="text-red-500 text-xs font-bold">MISSING NAME (ID: {{ c.id }})</span>
                                </div>
                            </div>
                        </td>
                        
                        <td class="p-4">
                             <span class="font-mono text-xs text-gray-700 bg-gray-50/50 px-2 py-1 rounded border border-gray-100">
                                {{ c.phone || '---' }}
                             </span>
                        </td>
                        
                        <td class="p-4 text-blue-500">
                            {{ c.email || '-' }}
                        </td>
                        
                        <td class="p-4 text-xs italic text-gray-400 max-w-xs truncate">
                            {{ c.notes || '-' }}
                        </td>
                        
                        <td class="p-4 text-center">
                            <div class="flex justify-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button 
                                    @click="openEditModal(c)" 
                                    class="text-blue-400 hover:text-blue-600 p-2 rounded hover:bg-blue-50 transition"
                                    title="Ğ ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ñ‚Ğ¸"
                                >
                                    <i class="fas fa-pen"></i>
                                </button>
                                <button 
                                    @click="deleteCustomer(c.id)" 
                                    class="text-gray-300 hover:text-red-500 p-2 rounded hover:bg-red-50 transition"
                                    title="Ğ’Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğ¸"
                                >
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div v-if="showModal" class="fixed inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl p-6 transform transition-all scale-100">
                <div class="flex justify-between items-center mb-6 border-b pb-4 border-gray-100">
                    <h2 class="text-xl font-bold text-gray-800">
                        {{ isEditing ? 'Ğ ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ñ‚Ğ¸ ĞºĞ»Ñ–Ñ”Ğ½Ñ‚Ğ°' : 'ĞĞ¾Ğ²Ğ¸Ğ¹ ĞºĞ»Ñ–Ñ”Ğ½Ñ‚' }}
                    </h2>
                    <button @click="closeModal" class="text-gray-400 hover:text-gray-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100">
                        &times;
                    </button>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1 ml-1">Ğ†Ğ¼'Ñ <span class="text-red-500">*</span></label>
                        <input v-model="formData.name" class="w-full border-gray-200 border p-3 rounded-xl focus:ring-2 focus:ring-blue-100 outline-none bg-gray-50 focus:bg-white transition" placeholder="ĞŸĞ†Ğ‘">
                    </div>
                    
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1 ml-1">Ğ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½ <span class="text-red-500">*</span></label>
                        <input v-model="formData.phone" class="w-full border-gray-200 border p-3 rounded-xl focus:ring-2 focus:ring-blue-100 outline-none bg-gray-50 focus:bg-white transition" placeholder="+380...">
                    </div>
                    
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1 ml-1">Email</label>
                        <input v-model="formData.email" class="w-full border-gray-200 border p-3 rounded-xl focus:ring-2 focus:ring-blue-100 outline-none bg-gray-50 focus:bg-white transition" placeholder="client@mail.com">
                    </div>
                    
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1 ml-1">ĞĞ¾Ñ‚Ğ°Ñ‚ĞºĞ¸</label>
                        <textarea v-model="formData.notes" class="w-full border-gray-200 border p-3 rounded-xl focus:ring-2 focus:ring-blue-100 outline-none bg-gray-50 focus:bg-white transition h-24 resize-none" placeholder="Ğ£Ğ¿Ğ¾Ğ´Ğ¾Ğ±Ğ°Ğ½Ğ½Ñ, Ğ´ĞµĞ½ÑŒ Ğ½Ğ°Ñ€Ğ¾Ğ´Ğ¶ĞµĞ½Ğ½Ñ..."></textarea>
                    </div>
                </div>

                <div class="flex gap-3 mt-8 pt-4 border-t border-gray-50">
                    <button @click="closeModal" class="flex-1 py-3 text-gray-500 font-bold hover:bg-gray-100 rounded-xl transition">Ğ¡ĞºĞ°ÑÑƒĞ²Ğ°Ñ‚Ğ¸</button>
                    <button @click="handleSave" class="flex-1 py-3 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 shadow-lg shadow-blue-200 transition transform active:scale-95">
                        {{ isEditing ? 'Ğ—Ğ±ĞµÑ€ĞµĞ³Ñ‚Ğ¸ Ğ·Ğ¼Ñ–Ğ½Ğ¸' : 'Ğ¡Ñ‚Ğ²Ğ¾Ñ€Ğ¸Ñ‚Ğ¸' }}
                    </button>
                </div>
            </div>
        </div>

    </div>
</template>

--------------------------------------------------
PATH: ./frontend/src/components/crm/CustomersTable.vue
--------------------------------------------------
<script setup>
defineProps({
  customers: Array,
  loading: Boolean
})

const emit = defineEmits(['edit', 'delete', 'history'])
</script>

<template>
  <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
    <table class="w-full text-left">
      <thead class="bg-gray-50 text-gray-500 uppercase text-xs">
        <tr>
          <th class="p-4">Ğ†Ğ¼'Ñ</th>
          <th class="p-4">Ğ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½</th>
          <th class="p-4">Email / ĞĞ¾Ñ‚Ğ°Ñ‚ĞºĞ¸</th>
          <th class="p-4 text-center">Ğ”Ñ–Ñ—</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-100">
        <tr v-if="customers.length === 0" class="text-center text-gray-400">
          <td colspan="4" class="p-8">
              <span v-if="loading"><i class="fas fa-spinner fa-spin"></i> Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ...</span>
              <span v-else>ĞšĞ»Ñ–Ñ”Ğ½Ñ‚Ñ–Ğ² Ğ½Ğµ Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾</span>
          </td>
        </tr>

        <tr v-for="c in customers" :key="c.id" class="hover:bg-blue-50 transition group">
          <td class="p-4 font-bold text-gray-800">
              <div class="flex items-center gap-3">
                  <div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-xs font-bold">
                      {{ c.name.charAt(0) }}
                  </div>
                  {{ c.name }}
              </div>
          </td>
          <td class="p-4 font-mono text-gray-600">{{ c.phone }}</td>
          <td class="p-4 text-sm text-gray-500">
              <div v-if="c.email">{{ c.email }}</div>
              <div v-if="c.notes" class="italic text-xs mt-1">"{{ c.notes }}"</div>
          </td>
          <td class="p-4 text-center flex justify-center gap-2">
              <button @click="emit('history', c)" class="text-purple-400 hover:text-purple-600 transition px-2" title="Ğ†ÑÑ‚Ğ¾Ñ€Ñ–Ñ Ğ¿Ğ¾ĞºÑƒĞ¿Ğ¾Ğº">
                  <i class="fas fa-history"></i>
              </button>
              <button @click="emit('edit', c)" class="text-gray-400 hover:text-blue-500 transition px-2" title="Ğ ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ñ‚Ğ¸">
                  <i class="fas fa-pen"></i>
              </button>
              <button @click="emit('delete', c.id)" class="text-gray-400 hover:text-red-500 transition px-2" title="Ğ’Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğ¸">
                  <i class="fas fa-trash"></i>
              </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</template>

--------------------------------------------------
PATH: ./frontend/src/components/stats/Statistics.vue
--------------------------------------------------
<script setup>
import { onMounted } from 'vue'
import { useStatistics } from '@/composables/useStatistics'
import SalesTable from './SalesTable.vue'

const { 
  orders, loading, 
  showDetailModal, selectedOrder, 
  fetchOrders, openDetails, closeDetails 
} = useStatistics()

// Helper for date formatting (duplicate need for modal, can be util)
const formatDate = (dateString) => {
  return new Date(dateString).toLocaleString('uk-UA', {
    day: '2-digit', month: '2-digit', year: 'numeric',
    hour: '2-digit', minute: '2-digit'
  })
}

onMounted(() => fetchOrders())
</script>

<template>
  <div class="p-8 h-screen overflow-y-auto bg-gray-50 ml-64 custom-scrollbar">
    
    <div class="flex justify-between items-center mb-8">
      <div>
        <h2 class="text-3xl font-bold text-gray-800">ğŸ“Š Ğ†ÑÑ‚Ğ¾Ñ€Ñ–Ñ Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶Ñ–Ğ²</h2>
        <p class="text-gray-500">ĞĞ°Ñ‚Ğ¸ÑĞ½Ñ–Ñ‚ÑŒ Ğ½Ğ° Ğ·Ğ°Ğ¼Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ Ğ´Ğ»Ñ Ğ´ĞµÑ‚Ğ°Ğ»ĞµĞ¹</p>
      </div>
      <button @click="fetchOrders" class="text-blue-600 hover:bg-blue-50 p-2 rounded-full transition">
        <i class="fas fa-sync-alt" :class="{'fa-spin': loading}"></i>
      </button>
    </div>

    <SalesTable :orders="orders" :loading="loading" @view-details="openDetails" />

    <div v-if="showDetailModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg relative overflow-hidden flex flex-col max-h-[90vh] animate-fade-in-up">
            
            <div class="p-6 bg-gray-50 border-b flex justify-between items-start">
                <div>
                    <h3 class="text-2xl font-bold text-gray-800">Ğ§ĞµĞº #{{ selectedOrder.id }}</h3>
                    <p class="text-gray-500 text-sm">{{ formatDate(selectedOrder.created_at) }}</p>
                </div>
                <button @click="closeDetails" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <div class="p-6 overflow-y-auto custom-scrollbar">
                
                <div class="mb-6 bg-blue-50 p-4 rounded-xl border border-blue-100 flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-blue-200 text-blue-600 flex items-center justify-center text-lg">
                        <i class="fas" :class="selectedOrder.customer ? 'fa-user' : 'fa-user-secret'"></i>
                    </div>
                    <div>
                        <div class="text-xs font-bold text-blue-400 uppercase">ĞŸĞ¾ĞºÑƒĞ¿ĞµÑ†ÑŒ</div>
                        <div class="font-bold text-gray-800 text-lg">
                            {{ selectedOrder.customer ? selectedOrder.customer.name : 'Ğ“Ñ–ÑÑ‚ÑŒ' }}
                        </div>
                        <div v-if="selectedOrder.customer" class="text-sm text-gray-600">
                            {{ selectedOrder.customer.phone }}
                        </div>
                    </div>
                </div>

                <h4 class="font-bold text-gray-700 mb-3 border-b pb-2">Ğ¢Ğ¾Ğ²Ğ°Ñ€Ğ¸</h4>
                <div class="space-y-3">
                    <div v-for="item in selectedOrder.items" :key="item.id" class="flex justify-between items-center text-sm">
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-gray-800">{{ item.product_name }}</span>
                            <span v-if="item.details" class="text-xs text-gray-400">({{ item.details }})</span>
                        </div>
                        <div class="flex items-center gap-4">
                            <span class="text-gray-500">x{{ item.quantity }}</span>
                            <span class="font-mono font-bold">{{ item.price_at_moment * item.quantity }} â‚´</span>
                        </div>
                    </div>
                </div>

            </div>

            <div class="p-6 bg-gray-50 border-t">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-gray-500">ĞœĞµÑ‚Ğ¾Ğ´ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğ¸:</span>
                    <span class="font-bold uppercase text-sm" 
                          :class="selectedOrder.payment_method === 'card' ? 'text-blue-600' : 'text-green-600'">
                        {{ selectedOrder.payment_method === 'card' ? 'Ğ‘Ğ°Ğ½ĞºÑ–Ğ²ÑÑŒĞºĞ° ĞºĞ°Ñ€Ñ‚ĞºĞ°' : 'Ğ“Ğ¾Ñ‚Ñ–Ğ²ĞºĞ°' }}
                    </span>
                </div>
                <div class="flex justify-between items-center text-3xl font-bold text-gray-900 mt-2">
                    <span>Ğ Ğ°Ğ·Ğ¾Ğ¼:</span>
                    <span>{{ selectedOrder.total_price }} â‚´</span>
                </div>
            </div>

        </div>
    </div>

  </div>
</template>

<style scoped>
.animate-fade-in-up { animation: fadeInUp 0.3s ease-out; }
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>

--------------------------------------------------
PATH: ./frontend/src/components/stats/SalesTable.vue
--------------------------------------------------
<script setup>
defineProps({
  orders: Array,
  loading: Boolean
})

const emit = defineEmits(['view-details'])

// Helper for date formatting inside template
const formatDate = (dateString) => {
  const date = new Date(dateString)
  return date.toLocaleString('uk-UA', {
    day: '2-digit', month: '2-digit', year: 'numeric',
    hour: '2-digit', minute: '2-digit'
  })
}
</script>

<template>
  <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
      <table class="w-full text-left">
        <thead class="bg-gray-100 text-gray-500 uppercase text-xs">
          <tr>
            <th class="p-4">ID / Ğ§Ğ°Ñ</th>
            <th class="p-4">ĞšĞ»Ñ–Ñ”Ğ½Ñ‚</th> 
            <th class="p-4">Ğ¢Ğ¾Ğ²Ğ°Ñ€Ğ¸ (ĞšĞ¾Ñ€Ğ¾Ñ‚ĞºĞ¾)</th>
            <th class="p-4">ĞĞ¿Ğ»Ğ°Ñ‚Ğ°</th>
            <th class="p-4 text-right">Ğ¡ÑƒĞ¼Ğ°</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100">
          <tr v-if="orders.length === 0" class="text-center text-gray-400">
            <td colspan="5" class="p-8">
                <span v-if="loading"><i class="fas fa-spinner fa-spin"></i> Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ...</span>
                <span v-else>Ğ†ÑÑ‚Ğ¾Ñ€Ñ–Ñ Ğ·Ğ°Ğ¼Ğ¾Ğ²Ğ»ĞµĞ½ÑŒ Ğ¿Ğ¾Ñ€Ğ¾Ğ¶Ğ½Ñ</span>
            </td>
          </tr>

          <tr v-for="order in orders" :key="order.id" 
              @click="emit('view-details', order)"
              class="hover:bg-blue-50 transition cursor-pointer group">
            
            <td class="p-4">
              <div class="font-bold text-gray-800 group-hover:text-blue-600 transition">#{{ order.id }}</div>
              <div class="text-sm text-gray-500">{{ formatDate(order.created_at) }}</div>
            </td>

            <td class="p-4">
                <div v-if="order.customer">
                    <div class="font-bold text-gray-700">{{ order.customer.name }}</div>
                    <div class="text-xs text-gray-400">{{ order.customer.phone }}</div>
                </div>
                <div v-else class="text-gray-400 text-sm italic">Ğ“Ñ–ÑÑ‚ÑŒ</div>
            </td>

            <td class="p-4">
              <div class="text-sm text-gray-600">
                 {{ order.items.length }} Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ñ–Ğ¹
                 <span class="text-xs text-gray-400">({{ order.items[0]?.product_name }}...)</span>
              </div>
            </td>

            <td class="p-4">
              <span v-if="order.payment_method === 'card'" class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs font-bold">
                <i class="fas fa-credit-card mr-1"></i> ĞšĞ°Ñ€Ñ‚ĞºĞ°
              </span>
              <span v-else class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold">
                <i class="fas fa-money-bill-wave mr-1"></i> Ğ“Ğ¾Ñ‚Ñ–Ğ²ĞºĞ°
              </span>
            </td>

            <td class="p-4 text-right font-mono font-bold text-lg text-gray-800">
              {{ order.total_price }} â‚´
            </td>

          </tr>
        </tbody>
      </table>
    </div>
</template>

--------------------------------------------------
PATH: ./frontend/src/composables/useCustomers.js
--------------------------------------------------
import { ref, watch } from 'vue'

export function useCustomers() {
  const customers = ref([])
  const loading = ref(false)
  
  // ĞŸĞ¾ÑˆÑƒĞº
  const searchQuery = ref('')
  
  // Ğ”Ğ»Ñ Ğ¼Ğ¾Ğ´Ğ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ²Ñ–ĞºĞ½Ğ° Ñ€ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ
  const showModal = ref(false)
  const isEditing = ref(false)
  const editingId = ref(null)
  const formData = ref({ name: '', phone: '', email: '', notes: '' })

  // Ğ”Ğ»Ñ Ñ–ÑÑ‚Ğ¾Ñ€Ñ–Ñ—
  const showHistoryModal = ref(false)
  const historyLoading = ref(false)
  const currentCustomerHistory = ref(null)
  const customerOrders = ref([])

  // --- ACTIONS ---

  const fetchCustomers = async () => {
    loading.value = true
    try {
      let url = '/api/customers/'
      if (searchQuery.value.length > 0) url = `/api/customers/search/?q=${searchQuery.value}`
      const res = await fetch(url)
      if (res.ok) customers.value = await res.json()
    } catch (err) { console.error(err) } finally { loading.value = false }
  }

  // --- CRUD Operations ---
  
  const openCreateModal = () => {
    isEditing.value = false
    formData.value = { name: '', phone: '', email: '', notes: '' }
    showModal.value = true
  }

  const openEditModal = (customer) => {
    isEditing.value = true
    editingId.value = customer.id
    formData.value = { ...customer } // ĞšĞ¾Ğ¿Ñ–ÑÑ”Ğ¼Ğ¾ Ğ´Ğ°Ğ½Ñ–
    showModal.value = true
  }

  const saveCustomer = async () => {
    if (!formData.value.name || !formData.value.phone) {
        alert("Ğ†Ğ¼'Ñ Ñ‚Ğ° Ğ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½ Ğ¾Ğ±Ğ¾Ğ²'ÑĞ·ĞºĞ¾Ğ²Ñ–!")
        return false
    }
    
    try {
      let url = '/api/customers/'
      let method = 'POST'
      
      if (isEditing.value) {
        url = `/api/customers/${editingId.value}`
        method = 'PUT'
      }
      
      const res = await fetch(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData.value)
      })
      
      if (res.ok) {
        showModal.value = false
        await fetchCustomers()
        return true
      } else {
        const err = await res.json()
        alert("ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ°: " + (err.detail || "ĞĞµ Ğ²Ğ´Ğ°Ğ»Ğ¾ÑÑ Ğ·Ğ±ĞµÑ€ĞµĞ³Ñ‚Ğ¸"))
        return false
      }
    } catch (err) { 
        console.error(err)
        return false
    }
  }

  const deleteCustomer = async (id) => {
    if (!confirm("Ğ’Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğ¸ Ñ†ÑŒĞ¾Ğ³Ğ¾ ĞºĞ»Ñ–Ñ”Ğ½Ñ‚Ğ° Ğ· Ğ±Ğ°Ğ·Ğ¸?")) return
    try {
        await fetch(`/api/customers/${id}`, { method: 'DELETE' })
        await fetchCustomers()
    } catch (err) { console.error(err) }
  }

  // --- History Logic ---

  const openHistory = async (customer) => {
    currentCustomerHistory.value = customer
    customerOrders.value = []
    showHistoryModal.value = true
    historyLoading.value = true
    
    try {
      const res = await fetch(`/api/customers/${customer.id}/orders/`)
      if (res.ok) {
        customerOrders.value = await res.json()
      }
    } catch (err) {
      console.error(err)
      alert("ĞĞµ Ğ²Ğ´Ğ°Ğ»Ğ¾ÑÑ Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶Ğ¸Ñ‚Ğ¸ Ñ–ÑÑ‚Ğ¾Ñ€Ñ–Ñ")
    } finally {
      historyLoading.value = false
    }
  }

  // --- Watcher Ğ´Ğ»Ñ Ğ¿Ğ¾ÑˆÑƒĞºÑƒ ---
  let timeout = null
  watch(searchQuery, () => {
    clearTimeout(timeout)
    timeout = setTimeout(() => { fetchCustomers() }, 500)
  })

  return {
    customers,
    loading,
    searchQuery,
    showModal,
    isEditing,
    formData,
    // History
    showHistoryModal,
    historyLoading,
    currentCustomerHistory,
    customerOrders,
    // Actions
    fetchCustomers,
    openCreateModal,
    openEditModal,
    saveCustomer,
    deleteCustomer,
    openHistory
  }
}

--------------------------------------------------
PATH: ./frontend/src/composables/useCart.js
--------------------------------------------------
import { ref, computed } from 'vue'

// Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ¸Ğ¹ ÑÑ‚Ğ°Ğ½ (Ğ·Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ñ”Ñ‚ÑŒÑÑ, Ğ½Ğ°Ğ²Ñ–Ñ‚ÑŒ ÑĞºÑ‰Ğ¾ Ğ·Ğ°ĞºÑ€Ğ¸Ñ‚Ğ¸ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ¸)
const cartItems = ref([])
const isProcessing = ref(false)
const paymentMethod = ref('cash')
const selectedCustomer = ref(null)

export function useCart() {
  
  // --- GETTERS ---
  const totalSum = computed(() => {
    return cartItems.value.reduce((sum, item) => sum + (item.price * item.quantity), 0)
  })

  const cartCount = computed(() => {
    return cartItems.value.reduce((sum, item) => sum + item.quantity, 0)
  })

  // --- ACTIONS ---
  
  const fetchCart = async () => {
    try {
      const res = await fetch('/api/cart/')
      if (res.ok) {
        const items = await res.json()
        cartItems.value = items.sort((a, b) => a.name.localeCompare(b.name))
      }
    } catch (err) {
      console.error("Cart fetch error:", err)
    }
  }

  const addToCart = async (payload) => {
    // payload: { product_id, variant_id, modifiers, quantity, ... }
    try {
      // --- Ğ’Ğ˜ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞĞ¯ Ğ¢Ğ£Ğ¢: Ğ´Ğ¾Ğ´Ğ°Ğ½Ğ¾ "/add" Ğ² ĞºÑ–Ğ½Ñ†Ñ– URL ---
      const res = await fetch('/api/cart/add', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })

      // --- Ğ”ĞĞ”ĞĞ¢ĞšĞĞ’Ğ: ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ° Ğ½Ğ° Ğ¿Ğ¾Ğ¼Ğ¸Ğ»ĞºÑƒ ÑĞµÑ€Ğ²ĞµÑ€Ğ° ---
      if (!res.ok) {
        throw new Error(`Server error: ${res.status}`)
      }

      await fetchCart() // ĞĞ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ ÑĞ¿Ğ¸ÑĞ¾Ğº
    } catch (err) {
      console.error("Add to cart error:", err)
      alert("ĞĞµ Ğ²Ğ´Ğ°Ğ»Ğ¾ÑÑ Ğ´Ğ¾Ğ´Ğ°Ñ‚Ğ¸ Ñ‚Ğ¾Ğ²Ğ°Ñ€! ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€Ñ‚Ğµ ĞºĞ¾Ğ½ÑĞ¾Ğ»ÑŒ.")
    }
  }

  const updateQty = async (cartItemId, change) => {
    try {
      await fetch(`/api/cart/${cartItemId}/update?change=${change}`, { method: 'POST' })
      await fetchCart()
    } catch (err) { console.error(err) }
  }

  const removeItem = async (cartItemId) => {
    if (!confirm('Ğ’Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğ¸ Ñ†ĞµĞ¹ Ñ‚Ğ¾Ğ²Ğ°Ñ€?')) return
    try {
      await fetch(`/api/cart/${cartItemId}`, { method: 'DELETE' })
      await fetchCart()
    } catch (err) { console.error(err) }
  }

  const clearCart = async (skipConfirm = false) => {
    if (!skipConfirm && !confirm('ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚Ğ¸ Ğ²ĞµÑÑŒ ĞºĞ¾ÑˆĞ¸Ğº?')) return
    try {
      await fetch('/api/cart/', { method: 'DELETE' })
      cartItems.value = []
      selectedCustomer.value = null
    } catch (err) { console.error(err) }
  }

  const processCheckout = async () => {
    if (cartItems.value.length === 0) return
    isProcessing.value = true

    try {
      const payload = {
        items: cartItems.value.map(item => ({
          product_id: item.product_id,
          variant_id: item.variant_id,
          modifiers: item.modifiers,
          quantity: item.quantity
        })),
        payment_method: paymentMethod.value,
        total_price: totalSum.value,
        customer_id: selectedCustomer.value ? selectedCustomer.value.id : null
      }

      const res = await fetch('/api/orders/checkout/', { 
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })

      if (!res.ok) throw new Error("ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ½Ñ")

      await fetch('/api/cart/', { method: 'DELETE' })
      
      const resultMsg = {
        success: true,
        text: `âœ… ĞĞ¿Ğ»Ğ°Ñ‚Ğ° ÑƒÑĞ¿Ñ–ÑˆĞ½Ğ°!\nĞ¡ÑƒĞ¼Ğ°: ${totalSum.value} â‚´` + (selectedCustomer.value ? `\nĞšĞ»Ñ–Ñ”Ğ½Ñ‚: ${selectedCustomer.value.name}` : '')
      }
      
      cartItems.value = []
      selectedCustomer.value = null
      
      return resultMsg

    } catch (err) {
      console.error(err)
      return { success: false, text: "âŒ ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ–!" }
    } finally {
      isProcessing.value = false
    }
  }

  // Ğ Ğ¾Ğ±Ğ¾Ñ‚Ğ° Ğ· ĞºĞ»Ñ–Ñ”Ğ½Ñ‚Ğ¾Ğ¼
  const setCustomer = (customer) => { selectedCustomer.value = customer }
  const removeCustomer = () => { selectedCustomer.value = null }

  return {
    cartItems,
    isProcessing,
    paymentMethod,
    selectedCustomer,
    totalSum,
    cartCount,
    fetchCart,
    addToCart,
    updateQty,
    removeItem,
    clearCart,
    processCheckout,
    setCustomer,
    removeCustomer
  }
}

--------------------------------------------------
PATH: ./frontend/src/composables/useStatistics.js
--------------------------------------------------
import { ref } from 'vue'

export function useStatistics() {
  const orders = ref([])
  const loading = ref(true)
  
  // Ğ”Ğ»Ñ Ğ¼Ğ¾Ğ´Ğ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ²Ñ–ĞºĞ½Ğ° Ğ´ĞµÑ‚Ğ°Ğ»ĞµĞ¹
  const showDetailModal = ref(false)
  const selectedOrder = ref(null)

  const fetchOrders = async () => {
    loading.value = true
    try {
      const res = await fetch('/api/orders/')
      if (res.ok) {
        orders.value = await res.json()
      }
    } catch (err) {
      console.error("ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ¸:", err)
    } finally {
      loading.value = false
    }
  }

  const openDetails = (order) => {
    selectedOrder.value = order
    showDetailModal.value = true
  }

  const closeDetails = () => {
    showDetailModal.value = false
    selectedOrder.value = null
  }

  return {
    orders,
    loading,
    showDetailModal,
    selectedOrder,
    fetchOrders,
    openDetails,
    closeDetails
  }
}

--------------------------------------------------
PATH: ./frontend/src/composables/useWarehouse.js
--------------------------------------------------
import { ref } from 'vue'

// Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ¸Ğ¹ ÑÑ‚Ğ°Ğ½
const products = ref([]) // <--- 1. Ğ”ĞĞ”ĞĞĞ: Ğ¡Ñ…Ğ¾Ğ²Ğ¸Ñ‰Ğµ Ğ´Ğ»Ñ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ–Ğ²
const categories = ref([])
const units = ref([])
const ingredients = ref([])
const consumables = ref([])
const processGroups = ref([])
const recipes = ref([])
const loading = ref(false)

export function useWarehouse() {

  // ĞŸĞµÑ€ĞµĞ¹Ğ¼ĞµĞ½ÑƒĞ²Ğ°Ğ»Ğ¸ Ğ½Ğ° fetchWarehouseData Ğ´Ğ»Ñ ÑÑƒĞ¼Ñ–ÑĞ½Ğ¾ÑÑ‚Ñ– Ğ· ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ°Ğ¼Ğ¸
  const fetchWarehouseData = async () => {
    loading.value = true
    
    // Ğ¤ÑƒĞ½ĞºÑ†Ñ–Ñ Ğ±ĞµĞ·Ğ¿ĞµÑ‡Ğ½Ğ¾Ğ³Ğ¾ Ğ·Ğ°Ğ¿Ğ¸Ñ‚Ñƒ
    const safeFetch = async (url) => {
      try {
        const res = await fetch(url)
        return res.ok ? await res.json() : []
      } catch (e) { 
        console.error(`Error fetching ${url}:`, e)
        return [] 
      }
    }

    console.log("ğŸ”„ Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ´Ğ°Ğ½Ğ¸Ñ… ÑĞºĞ»Ğ°Ğ´Ñƒ...")

    // ĞŸĞ°Ñ€Ğ°Ğ»ĞµĞ»ÑŒĞ½Ğµ Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ²ÑÑ–Ñ… Ğ´Ğ¾Ğ²Ñ–Ğ´Ğ½Ğ¸ĞºÑ–Ğ² + Ğ¢ĞĞ’ĞĞ Ğ†Ğ’
    const results = await Promise.all([
      safeFetch('/api/categories/'),
      safeFetch('/api/units/'),
      safeFetch('/api/ingredients/'),
      safeFetch('/api/consumables/'),
      safeFetch('/api/processes/groups/'),
      safeFetch('/api/recipes/'),
      safeFetch('/api/products/') // <--- 2. Ğ”ĞĞ”ĞĞĞ: Ğ—Ğ°Ğ¿Ğ¸Ñ‚ Ğ½Ğ° Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¸
    ])

    // Ğ Ğ¾Ğ·Ğ¿Ğ¾Ğ´Ñ–Ğ»ÑÑ”Ğ¼Ğ¾ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¸
    categories.value = results[0]
    units.value = results[1]
    ingredients.value = results[2]
    consumables.value = results[3]
    processGroups.value = results[4]
    recipes.value = results[5]
    products.value = results[6] // <--- 3. Ğ”ĞĞ”ĞĞĞ: Ğ—Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ½Ñ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ–Ğ²

    console.log(`âœ… Ğ”Ğ°Ğ½Ñ– Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾. Ğ¢Ğ¾Ğ²Ğ°Ñ€Ñ–Ğ²: ${products.value.length}`)
    
    loading.value = false
  }

  // Ğ£Ğ½Ñ–Ğ²ĞµÑ€ÑĞ°Ğ»ÑŒĞ½Ğ° Ñ„ÑƒĞ½ĞºÑ†Ñ–Ñ ÑÑ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ½Ñ
  const createItem = async (url, payload, refreshFn = fetchWarehouseData) => {
    try {
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
      if (res.ok) {
        await refreshFn() // ĞĞ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ ÑĞ¿Ğ¸ÑĞºĞ¸
        return true
      }
      const err = await res.json()
      alert("ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ°: " + (err.detail || "ĞĞµ Ğ²Ğ´Ğ°Ğ»Ğ¾ÑÑ ÑÑ‚Ğ²Ğ¾Ñ€Ğ¸Ñ‚Ğ¸"))
      return false
    } catch (e) { 
      console.error(e)
      return false 
    }
  }

  // Ğ£Ğ½Ñ–Ğ²ĞµÑ€ÑĞ°Ğ»ÑŒĞ½Ğ° Ñ„ÑƒĞ½ĞºÑ†Ñ–Ñ Ğ²Ğ¸Ğ´Ğ°Ğ»ĞµĞ½Ğ½Ñ
  const deleteItem = async (url, refreshFn = fetchWarehouseData) => {
    if(!confirm("Ğ’Ğ¸ Ğ²Ğ¿ĞµĞ²Ğ½ĞµĞ½Ñ–, Ñ‰Ğ¾ Ñ…Ğ¾Ñ‡ĞµÑ‚Ğµ Ğ²Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğ¸ Ñ†Ğµ?")) return
    try {
      await fetch(url, { method: 'DELETE' })
      await refreshFn()
    } catch (e) { console.error(e) }
  }

  // Ğ£Ğ½Ñ–Ğ²ĞµÑ€ÑĞ°Ğ»ÑŒĞ½Ğ° Ñ„ÑƒĞ½ĞºÑ†Ñ–Ñ Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ (PUT)
  const updateItem = async (url, payload, refreshFn = fetchWarehouseData) => {
    try {
      const res = await fetch(url, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
      
      if (res.ok) {
        await refreshFn()
        return true
      }
      
      const err = await res.json()
      alert("ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ: " + (err.detail || "Ğ©Ğ¾ÑÑŒ Ğ¿Ñ–ÑˆĞ»Ğ¾ Ğ½Ğµ Ñ‚Ğ°Ğº"))
      return false
    } catch (e) {
      console.error(e)
      alert("ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ¼ĞµÑ€ĞµĞ¶Ñ–")
      return false
    }
  }

  return {
    // Ğ•ĞºÑĞ¿Ğ¾Ñ€Ñ‚ÑƒÑ”Ğ¼Ğ¾ products
    products, categories, units, ingredients, consumables, processGroups, recipes, loading,
    // Ğ•ĞºÑĞ¿Ğ¾Ñ€Ñ‚ÑƒÑ”Ğ¼Ğ¾ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñƒ Ğ½Ğ°Ğ·Ğ²Ñƒ Ñ„ÑƒĞ½ĞºÑ†Ñ–Ñ—
    fetchWarehouseData, 
    // Ğ—Ğ°Ğ»Ğ¸ÑˆĞ°Ñ”Ğ¼Ğ¾ ÑÑ‚Ğ°Ñ€Ñƒ Ğ½Ğ°Ğ·Ğ²Ñƒ ÑĞº Ğ°Ğ»Ñ–Ğ°Ñ Ğ¿Ñ€Ğ¾ Ğ²ÑÑĞº Ğ²Ğ¸Ğ¿Ğ°Ğ´Ğ¾Ğº
    fetchData: fetchWarehouseData,
    createItem, deleteItem, updateItem
  }
}

--------------------------------------------------
PATH: ./frontend/src/composables/useProducts.js
--------------------------------------------------
import { ref, computed } from 'vue'
import axios from 'axios'
import { useWarehouse } from '@/composables/useWarehouse'

// Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ¸Ğ¹ ÑÑ‚Ğ°Ğ½
const newProduct = ref({
    name: '', category_id: null, price: 0, has_variants: false,
    master_recipe_id: null, output_weight: 0,
    track_stock: false, stock_quantity: 0,
    consumables: [], variants: [], process_group_ids: []
})

const editingId = ref(null)
const isEditing = ref(false)
const productSearch = ref('')

// --- ĞĞĞ’Ğ•: Ğ¡Ñ‚Ğ°Ğ½ Ñ€ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ ---
const editingVariantIndex = ref(null) // null = Ñ€ĞµĞ¶Ğ¸Ğ¼ ÑÑ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ½Ñ, Ñ‡Ğ¸ÑĞ»Ğ¾ = Ñ–Ğ½Ğ´ĞµĞºÑ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ

// Ğ¢Ğ¸Ğ¼Ñ‡Ğ°ÑĞ¾Ğ²Ñ– Ğ·Ğ¼Ñ–Ğ½Ğ½Ñ–
const tempProductConsumable = ref({ consumable_id: "", quantity: 1 })
const tempVariantConsumable = ref({ consumable_id: "", quantity: 1 })
const tempVariantIngredient = ref({ ingredient_id: "", quantity: 0 })

const variantBuilder = ref({
    name: '', price: 0, master_recipe_id: null, 
    output_weight: 0, stock_quantity: 0, 
    consumables: [], ingredients: []
})

export function useProducts() {
    const warehouse = useWarehouse()
    const products = warehouse?.products || ref([])
    const consumables = warehouse?.consumables || ref([])
    const ingredients = warehouse?.ingredients || ref([])
    const fetchWarehouseData = warehouse?.fetchWarehouseData || (async ()=>{})

    const filteredProducts = computed(() => {
        if (!products.value) return []
        if (!productSearch.value) return products.value
        return products.value.filter(p => p.name.toLowerCase().includes(productSearch.value.toLowerCase()))
    })

    const fetchProducts = async () => { await fetchWarehouseData() }

    const saveProduct = async () => {
        if (!newProduct.value.name) return alert("Ğ’ĞºĞ°Ğ¶Ñ–Ñ‚ÑŒ Ğ½Ğ°Ğ·Ğ²Ñƒ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ!")
        
        const cleanPrice = newProduct.value.has_variants ? 0 : (parseFloat(newProduct.value.price) || 0)
        const cleanWeight = parseFloat(newProduct.value.output_weight) || 0
        const cleanStock = parseFloat(newProduct.value.stock_quantity) || 0
        
        const payload = {
            ...newProduct.value,
            category_id: newProduct.value.category_id || null,
            master_recipe_id: newProduct.value.master_recipe_id || null,
            price: cleanPrice,
            output_weight: cleanWeight,
            stock_quantity: cleanStock,
            variants: newProduct.value.has_variants ? newProduct.value.variants : [] 
        }

        try {
            const url = isEditing.value 
                ? `http://localhost:8001/products/${editingId.value}`
                : 'http://localhost:8001/products/'
            const method = isEditing.value ? 'put' : 'post'

            await axios[method](url, payload)
            await fetchProducts()
            resetForm()
            return true
        } catch (err) {
            console.error("Save error:", err)
            alert("ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ·Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ½Ñ")
            return false
        }
    }

    const deleteProduct = async (id) => {
        if(!confirm("Ğ’Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğ¸?")) return
        try {
            await axios.delete(`http://localhost:8001/products/${id}`)
            await fetchProducts()
        } catch(e) { alert("ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ²Ğ¸Ğ´Ğ°Ğ»ĞµĞ½Ğ½Ñ") }
    }

    const resetForm = () => {
        isEditing.value = false
        editingId.value = null
        editingVariantIndex.value = null // Ğ¡ĞºĞ¸Ğ´Ğ°Ñ”Ğ¼Ğ¾ Ñ€ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ
        newProduct.value = {
            name: '', category_id: null, price: 0, has_variants: false,
            master_recipe_id: null, output_weight: 0,
            track_stock: false, stock_quantity: 0,
            consumables: [], variants: [], process_group_ids: []
        }
        resetVariantBuilder()
    }

    const resetVariantBuilder = () => {
        variantBuilder.value = { name: '', price: 0, master_recipe_id: null, output_weight: 0, stock_quantity: 0, consumables: [], ingredients: [] }
        editingVariantIndex.value = null
    }

    const prepareEdit = (p) => {
        isEditing.value = true
        editingId.value = p.id
        const copy = JSON.parse(JSON.stringify(p))
        if (copy.variants) {
            copy.variants.forEach(v => {
                if(v.consumables) v.consumables.forEach(c => c.name = c.consumable_name || c.name)
                if(v.ingredients) v.ingredients.forEach(i => i.name = i.ingredient_name || i.name)
            })
        }
        if (copy.consumables) copy.consumables.forEach(c => c.name = c.consumable_name || c.name)
        newProduct.value = copy
    }

    // --- Ğ›ĞĞ“Ğ†ĞšĞ Ğ’ĞĞ Ğ†ĞĞĞ¢Ğ†Ğ’ (ĞĞ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ°) ---
    
    // 1. Ğ¤ÑƒĞ½ĞºÑ†Ñ–Ñ Ğ·Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ½Ñ (Ğ”Ğ¾Ğ´Ğ°Ğ²Ğ°Ğ½Ğ½Ñ ĞĞ‘Ğ ĞĞ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ)
    const saveVariant = () => {
        if(!variantBuilder.value.name) return alert("Ğ’ĞºĞ°Ğ¶Ñ–Ñ‚ÑŒ Ğ½Ğ°Ğ·Ğ²Ñƒ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ")
        
        const variantData = JSON.parse(JSON.stringify(variantBuilder.value))

        if (editingVariantIndex.value !== null) {
            // ĞĞĞĞ’Ğ›Ğ•ĞĞĞ¯ Ñ–ÑĞ½ÑƒÑÑ‡Ğ¾Ğ³Ğ¾
            newProduct.value.variants[editingVariantIndex.value] = variantData
        } else {
            // Ğ”ĞĞ”ĞĞ’ĞĞĞĞ¯ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾
            newProduct.value.variants.push(variantData)
        }
        resetVariantBuilder()
    }

    // 2. Ğ¤ÑƒĞ½ĞºÑ†Ñ–Ñ Ğ¿Ñ–Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²ĞºĞ¸ Ğ´Ğ¾ Ñ€ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ
    const editVariant = (index) => {
        editingVariantIndex.value = index
        // ĞšĞ¾Ğ¿Ñ–ÑÑ”Ğ¼Ğ¾ Ğ´Ğ°Ğ½Ñ– Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ Ğ½Ğ°Ğ·Ğ°Ğ´ Ñƒ Ñ„Ğ¾Ñ€Ğ¼Ñƒ
        variantBuilder.value = JSON.parse(JSON.stringify(newProduct.value.variants[index]))
    }

    // 3. Ğ¡ĞºĞ°ÑÑƒĞ²Ğ°Ğ½Ğ½Ñ Ñ€ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ
    const cancelVariantEdit = () => {
        resetVariantBuilder()
    }

    const removeVariant = (i) => {
        newProduct.value.variants.splice(i, 1)
        if (editingVariantIndex.value === i) resetVariantBuilder()
    }

    // Ğ†Ğ½ÑˆÑ– Ğ¼ĞµÑ‚Ğ¾Ğ´Ğ¸ (Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸/Ñ–Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ğ¸)
    const addProductConsumable = () => {
        if(!tempProductConsumable.value.consumable_id) return
        const c = consumables.value.find(x => x.id === tempProductConsumable.value.consumable_id)
        newProduct.value.consumables.push({ ...tempProductConsumable.value, name: c?.name || '???' })
        tempProductConsumable.value.quantity = 1
    }
    const removeProductConsumable = (i) => newProduct.value.consumables.splice(i, 1)

    const addVariantConsumable = () => {
        if(!tempVariantConsumable.value.consumable_id) return
        const c = consumables.value.find(x => x.id === tempVariantConsumable.value.consumable_id)
        variantBuilder.value.consumables.push({ ...tempVariantConsumable.value, name: c?.name || '???' })
        tempVariantConsumable.value.quantity = 1
    }
    const removeVariantConsumable = (i) => variantBuilder.value.consumables.splice(i, 1)

    const addIngredientToVariant = () => {
        if(!tempVariantIngredient.value.ingredient_id) return
        const i = ingredients.value.find(x => x.id === tempVariantIngredient.value.ingredient_id)
        variantBuilder.value.ingredients.push({ ...tempVariantIngredient.value, name: i?.name || '???' })
        tempVariantIngredient.value.quantity = 0
    }
    const removeIngredientFromVariant = (i) => variantBuilder.value.ingredients.splice(i, 1)

    return {
        newProduct, isEditing, editingId, productSearch, filteredProducts,
        variantBuilder, tempProductConsumable, tempVariantConsumable, tempVariantIngredient,
        // Ğ•ĞºÑĞ¿Ğ¾Ñ€Ñ‚ÑƒÑ”Ğ¼Ğ¾ Ğ½Ğ¾Ğ²Ñ– Ğ·Ğ¼Ñ–Ğ½Ğ½Ñ– Ñ‚Ğ° Ğ¼ĞµÑ‚Ğ¾Ğ´Ğ¸
        editingVariantIndex, saveVariant, editVariant, cancelVariantEdit,
        
        fetchProducts, saveProduct, deleteProduct, resetForm, prepareEdit,
        removeVariant,
        addProductConsumable, removeProductConsumable,
        addVariantConsumable, removeVariantConsumable,
        addIngredientToVariant, removeIngredientFromVariant
    }
}

--------------------------------------------------
PATH: ./product_service/requirements.txt
--------------------------------------------------
fastapi
uvicorn
sqlalchemy
psycopg2-binary
pydantic


--------------------------------------------------
PATH: ./product_service/schemas.py
--------------------------------------------------
from pydantic import BaseModel
from typing import List, Optional
from datetime import datetime

# --- BASIC ---
class Category(BaseModel):
    id: int
    name: str
    slug: str
    color: Optional[str] = "#ffffff"
    parent_id: Optional[int] = None
    class Config: from_attributes = True

class CategoryCreate(BaseModel):
    name: str
    slug: str
    color: Optional[str] = "#ffffff"
    parent_id: Optional[int] = None

class Unit(BaseModel):
    id: int
    name: str
    symbol: str
    class Config: from_attributes = True
class UnitCreate(BaseModel):
    name: str
    symbol: str

class Ingredient(BaseModel):
    id: int
    name: str
    cost_per_unit: float
    stock_quantity: float
    unit_id: Optional[int] = None
    unit: Optional[Unit] = None
    class Config: from_attributes = True
class IngredientCreate(BaseModel):
    name: str
    cost_per_unit: float
    stock_quantity: float
    unit_id: int

# --- ĞĞĞ’Ğ•: Consumables Schemas ---
class ConsumableBase(BaseModel):
    name: str
    cost_per_unit: float
    stock_quantity: float
    unit_id: Optional[int] = None

class ConsumableCreate(ConsumableBase):
    pass

class Consumable(ConsumableBase):
    id: int
    unit: Optional[Unit] = None
    class Config: from_attributes = True

# Ğ¡Ñ…ĞµĞ¼Ğ° Ğ´Ğ»Ñ Ğ·Ğ°Ğ¿Ğ¸ÑÑƒ (Link)
class ProductIngredientLink(BaseModel):
    ingredient_id: int
    quantity: float

# Ğ¡Ñ…ĞµĞ¼Ğ° Ğ´Ğ»Ñ Ñ‡Ğ¸Ñ‚Ğ°Ğ½Ğ½Ñ (Read)
class ProductIngredientRead(BaseModel):
    ingredient_id: int
    quantity: float
    ingredient_name: Optional[str] = None
    class Config: from_attributes = True

# Ğ¡Ñ…ĞµĞ¼Ğ° Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¸Ğ²'ÑĞ·ĞºĞ¸ Ğ²Ğ¸Ñ‚Ñ€Ğ°Ñ‚Ğ½Ğ¸Ñ… Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ñ–Ğ² Ğ´Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ (Ğ´Ğ»Ñ Ğ·Ğ°Ğ¿Ğ¸ÑÑƒ)
class ProductConsumableLink(BaseModel):
    consumable_id: int
    quantity: float = 1.0

# --- Ğ’ĞĞ–Ğ›Ğ˜Ğ’Ğ: ĞŸĞµÑ€ĞµĞ¼Ñ–Ñ‰ĞµĞ½Ğ¾ Ğ¡Ğ®Ğ”Ğ˜ (Ğ¿ĞµÑ€ĞµĞ´ Variants), Ñ‰Ğ¾Ğ± Pydantic Ğ¹Ğ¾Ğ³Ğ¾ Ğ±Ğ°Ñ‡Ğ¸Ğ² ---
class ProductConsumableRead(BaseModel):
    consumable_id: int
    quantity: float
    consumable_name: Optional[str] = None
    class Config: from_attributes = True

# --- PROCESSES (ĞĞĞ’Ğ•) ---
class ProcessOptionCreate(BaseModel):
    name: str # "Ğ”Ñ€Ñ–Ğ±Ğ½Ğ¸Ğ¹", "Ğ—ĞµÑ€Ğ½Ğ¾"
class ProcessOption(ProcessOptionCreate):
    id: int
    group_id: int
    class Config: from_attributes = True

class ProcessGroupCreate(BaseModel):
    name: str # "ĞŸĞ¾Ğ¼Ğ¾Ğ»"
    options: List[ProcessOptionCreate] = []

class ProcessGroup(BaseModel):
    id: int
    name: str
    options: List[ProcessOption] = []
    class Config: from_attributes = True

# --- MASTER RECIPES ---
class MasterRecipeItemCreate(BaseModel):
    ingredient_id: int
    quantity: float
    is_percentage: bool = False 

class MasterRecipeItem(MasterRecipeItemCreate):
    id: int
    ingredient_name: Optional[str] = None 
    class Config: from_attributes = True

class MasterRecipeCreate(BaseModel):
    name: str
    description: Optional[str] = None
    items: List[MasterRecipeItemCreate] = []

class MasterRecipe(MasterRecipeCreate):
    id: int
    items: List[MasterRecipeItem] = []
    class Config: from_attributes = True

# --- MODIFIERS ---
class ModifierCreate(BaseModel):
    name: str
    price_change: float = 0.0
    ingredient_id: Optional[int] = None
    quantity: float = 0.0
class Modifier(ModifierCreate):
    id: int
    class Config: from_attributes = True
class ModifierGroupCreate(BaseModel):
    name: str
    is_required: bool = False
    modifiers: List[ModifierCreate] = []
class ModifierGroup(ModifierGroupCreate):
    id: int
    modifiers: List[Modifier] = []
    class Config: from_attributes = True

# --- VARIANTS ---
class VariantCreate(BaseModel):
    name: str
    price: float
    sku: Optional[str] = None
    output_weight: float = 0.0
    master_recipe_id: Optional[int] = None
    stock_quantity: float = 0.0
    # ĞŸÑ€Ğ¸ ÑÑ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ½Ñ– Ğ²Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ Link (Ñ‚Ñ–Ğ»ÑŒĞºĞ¸ ID Ñ‚Ğ° ĞºÑ–Ğ»ÑŒĞºÑ–ÑÑ‚ÑŒ)
    consumables: List[ProductConsumableLink] = []

    ingredients: List[ProductIngredientLink] = []

class Variant(VariantCreate):
    id: int
    # ĞŸÑ€Ğ¸ Ñ‡Ğ¸Ñ‚Ğ°Ğ½Ğ½Ñ– Ğ²Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ Read (Ğ· Ğ½Ğ°Ğ·Ğ²Ğ¾Ñ), Ñ‚ĞµĞ¿ĞµÑ€ Ñ†Ğµ Ğ¿Ñ€Ğ°Ñ†ÑĞ²Ğ°Ñ‚Ğ¸Ğ¼Ğµ ĞºĞ¾Ñ€ĞµĞºÑ‚Ğ½Ğ¾
    consumables: List[ProductConsumableRead] = []
    ingredients: List[ProductIngredientRead] = [] 
    class Config: from_attributes = True

# --- PRODUCTS ---
class ProductBase(BaseModel):
    name: str
    description: Optional[str] = None
    category_id: Optional[int] = None
    has_variants: bool = False
    price: float = 0.0 
    output_weight: float = 0.0 
    master_recipe_id: Optional[int] = None

    track_stock: bool = False
    stock_quantity: float = 0.0

class ProductCreate(ProductBase):
    variants: List[VariantCreate] = []
    modifier_groups: List[ModifierGroupCreate] = []
    consumables: List[ProductConsumableLink] = []
    
    # ĞĞĞ’Ğ•: Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ID Ğ³Ñ€ÑƒĞ¿ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ–Ğ², ÑĞºÑ– Ñ‚Ñ€ĞµĞ±Ğ° Ğ¿Ñ€Ğ¸Ğ²'ÑĞ·Ğ°Ñ‚Ğ¸
    process_group_ids: List[int] = [] 

class Product(ProductBase):
    id: int
    category: Optional[Category] = None
    variants: List[Variant] = [] 
    modifier_groups: List[ModifierGroup] = []
    master_recipe: Optional[MasterRecipe] = None
    consumables: List[ProductConsumableRead] = [] 
    
    # ĞĞĞ’Ğ•: ĞŸĞ¾Ğ²ĞµÑ€Ñ‚Ğ°Ñ”Ğ¼Ğ¾ Ğ¿Ğ¾Ğ²Ğ½Ñ– Ğ¾Ğ±'Ñ”ĞºÑ‚Ğ¸ Ğ³Ñ€ÑƒĞ¿ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ–Ğ²
    process_groups: List[ProcessGroup] = []

    class Config: from_attributes = True

# --- INVENTORY TRANSACTIONS ---
class InventoryTransactionRead(BaseModel):
    id: int
    entity_type: str
    entity_id: int
    entity_name: str
    change_amount: float
    balance_after: float
    reason: str
    created_at: datetime

    class Config:
        from_attributes = True

# --- ORDERS ---
class SoldItemModifier(BaseModel):
    modifier_id: int
class SoldItem(BaseModel):
    product_id: int
    variant_id: Optional[int] = None
    modifiers: List[SoldItemModifier] = []
    quantity: int
    # Ğ¢ÑƒÑ‚ Ğ¼Ğ¸ Ğ½Ğµ Ğ´Ğ¾Ğ´Ğ°Ñ”Ğ¼Ğ¾ Ğ¾ĞºÑ€ĞµĞ¼Ğµ Ğ¿Ğ¾Ğ»Ğµ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ–Ğ², 
    # Ğ±Ğ¾ Ğ²Ğ¾Ğ½Ğ¸ Ğ¿Ñ€Ğ¸Ñ…Ğ¾Ğ´ÑÑ‚ÑŒ Ğ²Ğ¶Ğµ ÑĞº Ñ‡Ğ°ÑÑ‚Ğ¸Ğ½Ğ° Ğ½Ğ°Ğ·Ğ²Ğ¸ Ğ°Ğ±Ğ¾ details, ÑÑ„Ğ¾Ñ€Ğ¼Ğ¾Ğ²Ğ°Ğ½Ñ– Ğ½Ğ° Ñ„Ñ€Ğ¾Ğ½Ñ‚Ñ–
    # Ğ°Ğ±Ğ¾ Ğ¼Ğ¸ Ğ´Ğ¾Ğ´Ğ°Ğ¼Ğ¾ Ñ—Ñ… Ğ² Ğ¼Ğ°Ğ¹Ğ±ÑƒÑ‚Ğ½ÑŒĞ¾Ğ¼Ñƒ, ÑĞºÑ‰Ğ¾ Ñ‚Ñ€ĞµĞ±Ğ° Ğ±ÑƒĞ´Ğµ.
class OrderCreate(BaseModel):
    items: List[SoldItem]
    payment_method: str
    total_price: float
    customer_id: Optional[int] = None

class CustomerCreate(BaseModel):
    name: str
    phone: str
    email: Optional[str] = None
    notes: Optional[str] = None
class Customer(CustomerCreate):
    id: int
    class Config: from_attributes = True

class OrderItemRead(BaseModel):
    product_name: str
    quantity: int
    price_at_moment: float
    details: Optional[str] = None
    class Config: from_attributes = True
class OrderRead(BaseModel):
    id: int
    created_at: datetime
    total_price: float
    payment_method: str
    items: List[OrderItemRead]
    customer: Optional[Customer] = None
    class Config: from_attributes = True

--------------------------------------------------
PATH: ./product_service/database.py
--------------------------------------------------
from sqlalchemy import create_engine
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker
import os

# Ğ¤Ğ¾Ñ€Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ğ¿Ğ¾ÑĞ¸Ğ»Ğ°Ğ½Ğ½Ñ: postgresql://user:password@hostname/dbname
# Ğ¦Ñ– Ğ·Ğ¼Ñ–Ğ½Ğ½Ñ– Ğ¼Ğ¸ Ğ¿Ñ€Ğ¾Ğ¿Ğ¸ÑĞ°Ğ»Ğ¸ Ğ² docker-compose.yml Ñ‰Ğµ Ğ½Ğ° Ğ¿Ğ¾Ñ‡Ğ°Ñ‚ĞºÑƒ
USER = os.getenv("POSTGRES_USER", "user")
PASSWORD = os.getenv("POSTGRES_PASSWORD", "password")
DB_NAME = os.getenv("POSTGRES_DB", "products_db")
HOST = "pos_postgres" # Ğ†Ğ¼'Ñ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ° Ğ· Ğ‘Ğ”

SQLALCHEMY_DATABASE_URL = f"postgresql://{USER}:{PASSWORD}@{HOST}/{DB_NAME}"

# Ğ¡Ñ‚Ğ²Ğ¾Ñ€ÑÑ”Ğ¼Ğ¾ Ğ´Ğ²Ğ¸Ğ³ÑƒĞ½ (engine)
engine = create_engine(SQLALCHEMY_DATABASE_URL)

# Ğ¡Ñ‚Ğ²Ğ¾Ñ€ÑÑ”Ğ¼Ğ¾ Ñ„Ğ°Ğ±Ñ€Ğ¸ĞºÑƒ ÑĞµÑÑ–Ğ¹ (Ñ‡ĞµÑ€ĞµĞ· Ğ½ĞµÑ— Ğ¼Ğ¸ Ğ±ÑƒĞ´ĞµĞ¼Ğ¾ Ñ€Ğ¾Ğ±Ğ¸Ñ‚Ğ¸ Ğ·Ğ°Ğ¿Ğ¸Ñ‚Ğ¸)
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)

# Ğ‘Ğ°Ğ·Ğ¾Ğ²Ğ¸Ğ¹ ĞºĞ»Ğ°Ñ Ğ´Ğ»Ñ Ğ²ÑÑ–Ñ… Ğ½Ğ°ÑˆĞ¸Ñ… Ğ¼Ğ°Ğ¹Ğ±ÑƒÑ‚Ğ½Ñ–Ñ… Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†ÑŒ
Base = declarative_base()

# Ğ¤ÑƒĞ½ĞºÑ†Ñ–Ñ Ğ´Ğ»Ñ Ğ¾Ñ‚Ñ€Ğ¸Ğ¼Ğ°Ğ½Ğ½Ñ ÑĞµÑÑ–Ñ— (Dependency Injection)
def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()

--------------------------------------------------
PATH: ./product_service/main.py
--------------------------------------------------
# FILE: product_service/main.py

from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
import database, models

# Ğ†Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ÑƒÑ”Ğ¼Ğ¾ Ğ½Ğ°ÑˆÑ– Ğ½Ğ¾Ğ²Ñ– Ğ¼Ğ¾Ğ´ÑƒĞ»ÑŒĞ½Ñ– Ñ€Ğ¾ÑƒÑ‚ĞµÑ€Ğ¸
from routers import (
    products, 
    inventory, 
    categories, 
    recipes, 
    processes, 
    customers, 
    orders
)

app = FastAPI(title="HITS POS Product Service", version="2.0.0")

# ĞĞ°Ğ»Ğ°ÑˆÑ‚ÑƒĞ²Ğ°Ğ½Ğ½Ñ CORS (Ğ´Ğ¾Ğ·Ğ²Ğ¾Ğ»ÑÑ”Ğ¼Ğ¾ Ñ„Ñ€Ğ¾Ğ½Ñ‚ĞµĞ½Ğ´Ñƒ ÑÑ‚ÑƒĞºĞ°Ñ‚Ğ¸ÑÑŒ ÑÑĞ´Ğ¸)
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# Ğ¡Ñ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ½Ñ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†ÑŒ Ğ² Ğ‘Ğ” Ğ¿Ñ€Ğ¸ ÑÑ‚Ğ°Ñ€Ñ‚Ñ– (ÑĞºÑ‰Ğ¾ Ñ—Ñ… Ğ½ĞµĞ¼Ğ°Ñ”)
models.Base.metadata.create_all(bind=database.engine)

# --- ĞŸĞ†Ğ”ĞšĞ›Ğ®Ğ§Ğ•ĞĞĞ¯ Ğ ĞĞ£Ğ¢Ğ•Ğ Ğ†Ğ’ ---
# Ğ¢ĞµĞ¿ĞµÑ€ ĞºĞ¾Ğ¶ĞµĞ½ Ñ„Ğ°Ğ¹Ğ» Ğ²Ñ–Ğ´Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ°Ñ” Ğ·Ğ° ÑĞ²Ñ–Ğ¹ ÑˆĞ¼Ğ°Ñ‚Ğ¾Ğº URL
app.include_router(products.router)
app.include_router(orders.router)
app.include_router(inventory.router)   # /ingredients, /consumables, /units
app.include_router(categories.router)
app.include_router(recipes.router)
app.include_router(processes.router)
app.include_router(customers.router)

@app.get("/")
def read_root():
    return {
        "message": "Product Service is running", 
        "architecture": "Clean Architecture (Router-Service-Repository)",
        "status": "Healthy"
    }

--------------------------------------------------
PATH: ./product_service/models.py
--------------------------------------------------
from sqlalchemy import Column, Integer, String, Float, ForeignKey, DateTime, Boolean, Table
from sqlalchemy.orm import relationship, backref
from database import Base
from datetime import datetime

# --- ĞĞ¡ĞĞ¦Ğ†ĞĞ¢Ğ˜Ğ’ĞĞ Ğ¢ĞĞ‘Ğ›Ğ˜Ğ¦Ğ¯: Ğ¢ĞĞ’ĞĞ  <-> Ğ“Ğ Ğ£ĞŸĞ˜ ĞŸĞ ĞĞ¦Ğ•Ğ¡Ğ†Ğ’ ---
# Ğ¦Ğµ Ğ´Ğ¾Ğ·Ğ²Ğ¾Ğ»ÑÑ” Ğ¿Ñ€Ğ¸Ğ²'ÑĞ·Ğ°Ñ‚Ğ¸ "ĞŸĞ¾Ğ¼Ğ¾Ğ»" Ğ´Ğ¾ "Ğ•Ñ„Ñ–Ğ¾Ğ¿Ñ–Ñ—", "ĞšĞ¾Ğ»ÑƒĞ¼Ğ±Ñ–Ñ—" Ñ– "Ğ‘Ñ€Ğ°Ğ·Ğ¸Ğ»Ñ–Ñ—" Ğ¾Ğ´Ğ½Ğ¾Ñ‡Ğ°ÑĞ½Ğ¾
product_process_groups = Table(
    'product_process_groups_link', Base.metadata,
    Column('product_id', Integer, ForeignKey('products.id')),
    Column('process_group_id', Integer, ForeignKey('process_groups.id'))
)

# --- ĞšĞĞ¢Ğ•Ğ“ĞĞ Ğ†Ğ‡ ---
class Category(Base):
    __tablename__ = "categories"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, unique=True, index=True)
    slug = Column(String, unique=True)
    color = Column(String, default="#ffffff")
    parent_id = Column(Integer, ForeignKey("categories.id"), nullable=True)
    children = relationship("Category", backref=backref("parent", remote_side=[id]), cascade="all, delete-orphan")

# --- ĞĞ”Ğ˜ĞĞ˜Ğ¦Ğ† ---
class Unit(Base):
    __tablename__ = "units"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, unique=True)
    symbol = Column(String, unique=True)

# --- Ğ†ĞĞ“Ğ Ğ•Ğ”Ğ†Ğ„ĞĞ¢Ğ˜ ---
class Ingredient(Base):
    __tablename__ = "ingredients"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, index=True, unique=True)
    unit_id = Column(Integer, ForeignKey("units.id"))
    unit = relationship("Unit")
    cost_per_unit = Column(Float, default=0.0)
    stock_quantity = Column(Float, default=0.0)

# --- Ğ’Ğ˜Ğ¢Ğ ĞĞ¢ĞĞ† ĞœĞĞ¢Ğ•Ğ Ğ†ĞĞ›Ğ˜ ---
class Consumable(Base):
    __tablename__ = "consumables"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, index=True, unique=True)
    unit_id = Column(Integer, ForeignKey("units.id"), nullable=True)
    unit = relationship("Unit")
    cost_per_unit = Column(Float, default=0.0)
    stock_quantity = Column(Float, default=0.0)

# --- ĞœĞĞ™Ğ¡Ğ¢Ğ•Ğ -Ğ Ğ•Ğ¦Ğ•ĞŸĞ¢Ğ˜ ---
class MasterRecipe(Base):
    __tablename__ = "master_recipes"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, index=True)
    description = Column(String, nullable=True)
    items = relationship("MasterRecipeItem", back_populates="recipe", cascade="all, delete-orphan")

class MasterRecipeItem(Base):
    __tablename__ = "master_recipe_items"
    id = Column(Integer, primary_key=True, index=True)
    recipe_id = Column(Integer, ForeignKey("master_recipes.id"))
    ingredient_id = Column(Integer, ForeignKey("ingredients.id"))
    quantity = Column(Float)
    is_percentage = Column(Boolean, default=False) 
    recipe = relationship("MasterRecipe", back_populates="items")
    ingredient = relationship("Ingredient")

# --- ĞŸĞ ĞĞ¦Ğ•Ğ¡Ğ˜ (ĞĞĞ’Ğ•) ---
class ProcessGroup(Base):
    __tablename__ = "process_groups"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, index=True) # ĞĞ°Ğ¿Ñ€: "ĞŸĞ¾Ğ¼Ğ¾Ğ»", "ĞŸÑ€Ğ¾ÑĞ¼Ğ°Ğ¶ĞµĞ½Ğ½Ñ"
    
    # Ğ—Ğ²'ÑĞ·Ğ¾Ğº Ğ¾Ğ´Ğ¸Ğ½-Ğ´Ğ¾-Ğ±Ğ°Ğ³Ğ°Ñ‚ÑŒĞ¾Ñ… Ğ· Ğ¾Ğ¿Ñ†Ñ–ÑĞ¼Ğ¸
    options = relationship("ProcessOption", back_populates="group", cascade="all, delete-orphan")
    
    # Ğ—Ğ²'ÑĞ·Ğ¾Ğº Ğ±Ğ°Ğ³Ğ°Ñ‚Ğ¾-Ğ´Ğ¾-Ğ±Ğ°Ğ³Ğ°Ñ‚ÑŒĞ¾Ñ… Ğ· Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°Ğ¼Ğ¸ (Ğ·Ğ²Ğ¾Ñ€Ğ¾Ñ‚Ğ½Ñ–Ğ¹ Ğ±Ñ–Ğº)
    products = relationship("Product", secondary=product_process_groups, back_populates="process_groups")

class ProcessOption(Base):
    __tablename__ = "process_options"
    id = Column(Integer, primary_key=True, index=True)
    group_id = Column(Integer, ForeignKey("process_groups.id"))
    name = Column(String) # ĞĞ°Ğ¿Ñ€: "ĞŸÑ–Ğ´ Ñ‚ÑƒÑ€ĞºÑƒ", "ĞŸÑ–Ğ´ Ñ„Ñ–Ğ»ÑŒÑ‚Ñ€"
    
    group = relationship("ProcessGroup", back_populates="options")

# --- Ğ¢ĞĞ’ĞĞ Ğ˜ ---
class Product(Base):
    __tablename__ = "products"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, index=True)
    description = Column(String, nullable=True)
    category_id = Column(Integer, ForeignKey("categories.id"))
    category = relationship("Category")
    has_variants = Column(Boolean, default=False)
    price = Column(Float, default=0.0)
    output_weight = Column(Float, default=0.0) 
    master_recipe_id = Column(Integer, ForeignKey("master_recipes.id"), nullable=True)
    master_recipe = relationship("MasterRecipe")

    # --- ĞĞĞ’Ğ† ĞŸĞĞ›Ğ¯ ---
    track_stock = Column(Boolean, default=False) # Ğ§Ğ¸ Ğ²ĞµÑÑ‚Ğ¸ ÑĞºĞ»Ğ°Ğ´ÑÑŒĞºĞ¸Ğ¹ Ğ¾Ğ±Ğ»Ñ–Ğº Ñ†ÑŒĞ¾Ğ³Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ
    stock_quantity = Column(Float, default=0.0)  # Ğ—Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº (Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¸Ñ… Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ–Ğ²)

    variants = relationship("ProductVariant", back_populates="product", cascade="all, delete-orphan")
    modifier_groups = relationship("ProductModifierGroup", back_populates="product", cascade="all, delete-orphan")
    consumables = relationship("ProductConsumable", back_populates="product", cascade="all, delete-orphan")
    # ĞĞĞ’Ğ•: Ğ—Ğ²'ÑĞ·Ğ¾Ğº Ğ· Ğ³Ñ€ÑƒĞ¿Ğ°Ğ¼Ğ¸ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ–Ğ²
    process_groups = relationship("ProcessGroup", secondary=product_process_groups, back_populates="products")

# --- Ğ—Ğ²'ÑĞ·Ğ¾Ğº Ğ¢Ğ¾Ğ²Ğ°Ñ€ -> Ğ’Ğ¸Ñ‚Ñ€Ğ°Ñ‚Ğ½Ñ– Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸ ---
class ProductConsumable(Base):
    __tablename__ = "product_consumables"
    id = Column(Integer, primary_key=True, index=True)
    product_id = Column(Integer, ForeignKey("products.id"))
    consumable_id = Column(Integer, ForeignKey("consumables.id"))
    quantity = Column(Float, default=1.0)
    
    product = relationship("Product", back_populates="consumables")
    consumable = relationship("Consumable")

# --- Ğ’ĞĞ Ğ†ĞĞĞ¢Ğ˜ ---
class ProductVariant(Base):
    __tablename__ = "product_variants"
    id = Column(Integer, primary_key=True, index=True)
    product_id = Column(Integer, ForeignKey("products.id"))
    name = Column(String)
    price = Column(Float)
    sku = Column(String, nullable=True)
    output_weight = Column(Float, default=0.0) 
    master_recipe_id = Column(Integer, ForeignKey("master_recipes.id"), nullable=True)
    master_recipe = relationship("MasterRecipe")

    # --- ĞĞĞ’Ğ• ĞŸĞĞ›Ğ• ---
    stock_quantity = Column(Float, default=0.0) # Ğ—Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾Ğ³Ğ¾ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ

    product = relationship("Product", back_populates="variants")
    consumables = relationship("ProductVariantConsumable", back_populates="variant", cascade="all, delete-orphan")
    # !!! ĞĞĞ’Ğ•: Ğ—Ğ²'ÑĞ·Ğ¾Ğº Ğ· Ñ–Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ğ°Ğ¼Ğ¸ !!!
    ingredients = relationship("ProductVariantIngredient", back_populates="variant", cascade="all, delete-orphan")

class ProductVariantConsumable(Base):
    __tablename__ = "product_variant_consumables"
    id = Column(Integer, primary_key=True, index=True)
    variant_id = Column(Integer, ForeignKey("product_variants.id"))
    consumable_id = Column(Integer, ForeignKey("consumables.id"))
    quantity = Column(Float, default=1.0)
    
    variant = relationship("ProductVariant", back_populates="consumables")
    consumable = relationship("Consumable")

# !!! ĞĞĞ’Ğ˜Ğ™ ĞšĞ›ĞĞ¡: Ğ†Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ğ¸ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ !!!
class ProductVariantIngredient(Base):
    __tablename__ = "product_variant_ingredients"
    id = Column(Integer, primary_key=True, index=True)
    variant_id = Column(Integer, ForeignKey("product_variants.id"))
    ingredient_id = Column(Integer, ForeignKey("ingredients.id"))
    quantity = Column(Float, default=0.0) # Ğ¡ĞºÑ–Ğ»ÑŒĞºĞ¸ Ğ³Ñ€Ğ°Ğ¼/Ğ¼Ğ»
    
    variant = relationship("ProductVariant", back_populates="ingredients")
    ingredient = relationship("Ingredient")

# --- ĞœĞĞ”Ğ˜Ğ¤Ğ†ĞšĞĞ¢ĞĞ Ğ˜ ---
class ProductModifierGroup(Base):
    __tablename__ = "product_modifier_groups"
    id = Column(Integer, primary_key=True)
    product_id = Column(Integer, ForeignKey("products.id"))
    name = Column(String)
    is_required = Column(Boolean, default=False)
    product = relationship("Product", back_populates="modifier_groups")
    modifiers = relationship("Modifier", back_populates="group", cascade="all, delete-orphan")

class Modifier(Base):
    __tablename__ = "modifiers"
    id = Column(Integer, primary_key=True)
    group_id = Column(Integer, ForeignKey("product_modifier_groups.id"))
    name = Column(String) 
    price_change = Column(Float, default=0.0)
    ingredient_id = Column(Integer, ForeignKey("ingredients.id"), nullable=True)
    quantity = Column(Float, default=0.0)
    group = relationship("ProductModifierGroup", back_populates="modifiers")
    ingredient = relationship("Ingredient")

# --- CRM/ORDERS ---
class Customer(Base):
    __tablename__ = "customers"
    id = Column(Integer, primary_key=True, index=True)
    name = Column(String)
    phone = Column(String, unique=True)
    email = Column(String, nullable=True)
    notes = Column(String, nullable=True)
    created_at = Column(DateTime, default=datetime.now)

class Order(Base):
    __tablename__ = "orders"
    id = Column(Integer, primary_key=True, index=True)
    created_at = Column(DateTime, default=datetime.now)
    total_price = Column(Float)
    payment_method = Column(String)
    customer_id = Column(Integer, ForeignKey("customers.id"), nullable=True)
    customer = relationship("Customer")
    items = relationship("OrderItem", back_populates="order", cascade="all, delete-orphan")

class OrderItem(Base):
    __tablename__ = "order_items"
    id = Column(Integer, primary_key=True, index=True)
    order_id = Column(Integer, ForeignKey("orders.id"))
    product_name = Column(String)
    quantity = Column(Integer)
    price_at_moment = Column(Float)
    details = Column(String, nullable=True) 
    order = relationship("Order", back_populates="items")

# --- Ğ†Ğ¡Ğ¢ĞĞ Ğ†Ğ¯ Ğ Ğ£Ğ¥Ğ£ Ğ¢ĞĞ’ĞĞ Ğ†Ğ’ (TRANSACTIONS) ---
class InventoryTransaction(Base):
    __tablename__ = "inventory_transactions"

    id = Column(Integer, primary_key=True, index=True)
    
    # Ğ¢Ğ¸Ğ¿ ÑÑƒÑ‚Ğ½Ğ¾ÑÑ‚Ñ–: 'ingredient', 'consumable', 'product'
    entity_type = Column(String, index=True) 
    
    # ID ÑÑƒÑ‚Ğ½Ğ¾ÑÑ‚Ñ– (ingredient_id, consumable_id Ğ°Ğ±Ğ¾ product_id)
    entity_id = Column(Integer, index=True)
    
    # ĞĞ°Ğ·Ğ²Ğ° Ğ½Ğ° Ğ¼Ğ¾Ğ¼ĞµĞ½Ñ‚ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ñ–Ñ— (Ñ‰Ğ¾Ğ± ÑĞºÑ‰Ğ¾ Ğ²Ğ¸Ğ´Ğ°Ğ»Ğ¸Ğ»Ğ¸ Ñ‚Ğ¾Ğ²Ğ°Ñ€, Ñ–ÑÑ‚Ğ¾Ñ€Ñ–Ñ Ğ»Ğ¸ÑˆĞ¸Ğ»Ğ°ÑÑŒ)
    entity_name = Column(String)
    
    # Ğ—Ğ¼Ñ–Ğ½Ğ° ĞºÑ–Ğ»ÑŒĞºĞ¾ÑÑ‚Ñ–: +5.0 (Ğ¿Ñ€Ğ¸Ñ…Ñ–Ğ´), -0.5 (ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ½Ñ)
    change_amount = Column(Float)
    
    # Ğ—Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº ĞŸĞ†Ğ¡Ğ›Ğ¯ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ñ–Ñ— (Ğ´Ğ»Ñ ĞºĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»Ñ)
    balance_after = Column(Float)
    
    # ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°: 'manual_update', 'sale_order_#105', 'waste', 'restock'
    reason = Column(String)
    
    created_at = Column(DateTime, default=datetime.now)

--------------------------------------------------
PATH: ./product_service/Dockerfile
--------------------------------------------------
FROM python:3.9-slim

WORKDIR /app

# Ğ¡Ğ¿Ğ¾Ñ‡Ğ°Ñ‚ĞºÑƒ ĞºĞ¾Ğ¿Ñ–ÑÑ”Ğ¼Ğ¾ Ğ²Ğ¸Ğ¼Ğ¾Ğ³Ğ¸ Ñ– ÑÑ‚Ğ°Ğ²Ğ¸Ğ¼Ğ¾ Ğ±Ñ–Ğ±Ğ»Ñ–Ğ¾Ñ‚ĞµĞºĞ¸ (Ñ‰Ğ¾Ğ± ĞºĞµÑˆÑƒĞ²Ğ°Ğ»Ğ¾ÑÑŒ)
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Ğ¢Ğ•ĞŸĞ•Ğ  ĞšĞĞŸĞ†Ğ®Ğ„ĞœĞ Ğ’Ğ¡Ğ• (Ğ²ĞºĞ»ÑÑ‡Ğ°ÑÑ‡Ğ¸ models.py, schemas.py, database.py)
COPY . .

# Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°Ñ”Ğ¼Ğ¾
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]

--------------------------------------------------
PATH: ./product_service/routers/recipes.py
--------------------------------------------------
# FILE: product_service/routers/recipes.py

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from typing import List
import database, schemas, models

router = APIRouter(prefix="/recipes", tags=["Recipes"])

@router.post("/", response_model=schemas.MasterRecipe)
def create_recipe(recipe: schemas.MasterRecipeCreate, db: Session = Depends(database.get_db)):
    new_recipe = models.MasterRecipe(name=recipe.name, description=recipe.description)
    db.add(new_recipe); db.commit(); db.refresh(new_recipe)
    
    # Ğ”Ğ¾Ğ´Ğ°Ñ”Ğ¼Ğ¾ Ñ–Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ğ¸ Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ñƒ
    for item in recipe.items:
        db.add(models.MasterRecipeItem(
            recipe_id=new_recipe.id, 
            ingredient_id=item.ingredient_id, 
            quantity=item.quantity, 
            is_percentage=item.is_percentage
        ))
    db.commit(); db.refresh(new_recipe)
    return new_recipe

@router.get("/", response_model=List[schemas.MasterRecipe])
def read_recipes(db: Session = Depends(database.get_db)):
    recipes = db.query(models.MasterRecipe).all()
    # "Ğ›Ñ–Ğ½Ğ¸Ğ²Ğµ" Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ñ–Ğ¼ĞµĞ½ Ñ–Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ñ–Ğ² Ğ´Ğ»Ñ Ñ„Ñ€Ğ¾Ğ½Ñ‚ĞµĞ½Ğ´Ñƒ
    for r in recipes:
        for i in r.items: 
            i.ingredient_name = i.ingredient.name if i.ingredient else "Unknown"
    return recipes

@router.put("/{recipe_id}", response_model=schemas.MasterRecipe)
def update_recipe(recipe_id: int, recipe_data: schemas.MasterRecipeCreate, db: Session = Depends(database.get_db)):
    db_recipe = db.query(models.MasterRecipe).filter(models.MasterRecipe.id == recipe_id).first()
    if not db_recipe: raise HTTPException(status_code=404)
    
    db_recipe.name = recipe_data.name
    db_recipe.description = recipe_data.description
    
    # ĞÑ‡Ğ¸Ñ‰Ğ°Ñ”Ğ¼Ğ¾ ÑÑ‚Ğ°Ñ€Ñ– Ñ–Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ğ¸ Ñ– Ğ¿Ğ¸ÑˆĞµĞ¼Ğ¾ Ğ½Ğ¾Ğ²Ñ–
    # (SQLAlchemy Ğ²Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ°Ñ€Ñ– Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ items Ğ·Ğ°Ğ²Ğ´ÑĞºĞ¸ Ğ½Ğ°Ğ»Ğ°ÑˆÑ‚ÑƒĞ²Ğ°Ğ½Ğ½ÑĞ¼ Ğ¼Ğ¾Ğ´ĞµĞ»Ñ–)
    db_recipe.items = [] 
    db.flush()
    
    for item in recipe_data.items:
        db.add(models.MasterRecipeItem(
            recipe_id=db_recipe.id, 
            ingredient_id=item.ingredient_id, 
            quantity=item.quantity, 
            is_percentage=item.is_percentage
        ))
    db.commit(); db.refresh(db_recipe)
    return db_recipe

@router.delete("/{recipe_id}")
def delete_recipe(recipe_id: int, db: Session = Depends(database.get_db)):
    db_recipe = db.query(models.MasterRecipe).filter(models.MasterRecipe.id == recipe_id).first()
    if not db_recipe: raise HTTPException(status_code=404)
    db.delete(db_recipe); db.commit()
    return {"status": "deleted"}

--------------------------------------------------
PATH: ./product_service/routers/categories.py
--------------------------------------------------
from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from typing import List
import database, schemas, models

router = APIRouter(prefix="/categories", tags=["Categories"])

@router.post("/", response_model=schemas.Category)
def create_category(category: schemas.CategoryCreate, db: Session = Depends(database.get_db)):
    # ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ÑÑ”Ğ¼Ğ¾ Ğ½Ğ° Ğ´ÑƒĞ±Ğ»Ñ–ĞºĞ°Ñ‚
    db_category = db.query(models.Category).filter(models.Category.name == category.name).first()
    if db_category: 
        raise HTTPException(status_code=400, detail="Category already exists")
    
    # Ğ¡Ñ‚Ğ²Ğ¾Ñ€ÑÑ”Ğ¼Ğ¾ Ğ½Ğ¾Ğ²Ñƒ
    new_category = models.Category(
        name=category.name, 
        slug=category.slug, 
        color=category.color, 
        parent_id=category.parent_id
    )
    db.add(new_category)
    db.commit()
    db.refresh(new_category)
    return new_category

@router.get("/", response_model=List[schemas.Category])
def read_categories(skip: int = 0, limit: int = 100, db: Session = Depends(database.get_db)):
    return db.query(models.Category).offset(skip).limit(limit).all()

# !!! ĞĞĞ’Ğ•: ĞĞ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ— !!!
@router.put("/{category_id}", response_model=schemas.Category)
def update_category(category_id: int, category_data: schemas.CategoryCreate, db: Session = Depends(database.get_db)):
    db_category = db.query(models.Category).filter(models.Category.id == category_id).first()
    if not db_category:
        raise HTTPException(status_code=404, detail="Category not found")
    
    # ĞĞ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ¿Ğ¾Ğ»Ñ
    db_category.name = category_data.name
    db_category.slug = category_data.slug
    db_category.color = category_data.color
    
    # Ğ—Ğ°Ñ…Ğ¸ÑÑ‚ Ğ²Ñ–Ğ´ Ñ†Ğ¸ĞºĞ»Ñ–Ñ‡Ğ½Ğ¾ÑÑ‚Ñ– (ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ Ğ½Ğµ Ğ¼Ğ¾Ğ¶Ğµ Ğ±ÑƒÑ‚Ğ¸ Ğ±Ğ°Ñ‚ÑŒĞºĞ¾Ğ¼ ÑĞ°Ğ¼Ğ° ÑĞ¾Ğ±Ñ–)
    if category_data.parent_id == category_id:
         raise HTTPException(status_code=400, detail="Category cannot be its own parent")
         
    db_category.parent_id = category_data.parent_id

    db.commit()
    db.refresh(db_category)
    return db_category

# !!! ĞĞĞ’Ğ•: Ğ’Ğ¸Ğ´Ğ°Ğ»ĞµĞ½Ğ½Ñ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ñ–Ñ— !!!
@router.delete("/{category_id}")
def delete_category(category_id: int, db: Session = Depends(database.get_db)):
    db_category = db.query(models.Category).filter(models.Category.id == category_id).first()
    if not db_category:
        raise HTTPException(status_code=404, detail="Category not found")
    
    db.delete(db_category)
    db.commit()
    return {"status": "deleted"}

--------------------------------------------------
PATH: ./product_service/routers/orders.py
--------------------------------------------------
# FILE: product_service/routers/orders.py

from fastapi import APIRouter, Depends
from sqlalchemy.orm import Session
from typing import List
import database, schemas, models
from services.order_service import OrderService

router = APIRouter(prefix="/orders", tags=["Orders"])

@router.post("/checkout/")
def checkout(order_data: schemas.OrderCreate, db: Session = Depends(database.get_db)):
    # ĞŸĞµÑ€ĞµĞ´Ğ°Ñ”Ğ¼Ğ¾ Ğ´Ğ°Ğ½Ñ– Ğ¿Ñ€Ğ¾Ñ„ĞµÑÑ–Ğ¾Ğ½Ğ°Ğ»Ñƒ - ÑĞµÑ€Ğ²Ñ–ÑÑƒ
    new_order = OrderService.process_checkout(db, order_data)
    return {"status": "ok", "order_id": new_order.id}

@router.get("/", response_model=List[schemas.OrderRead])
def get_orders(skip: int = 0, limit: int = 50, db: Session = Depends(database.get_db)):
    # Ğ¡Ğ¾Ñ€Ñ‚ÑƒÑ”Ğ¼Ğ¾ Ğ²Ñ–Ğ´ Ğ½Ğ¾Ğ²Ğ¸Ñ… Ğ´Ğ¾ ÑÑ‚Ğ°Ñ€Ğ¸Ñ…
    return db.query(models.Order).order_by(models.Order.created_at.desc()).offset(skip).limit(limit).all()

--------------------------------------------------
PATH: ./product_service/routers/inventory.py
--------------------------------------------------
# FILE: product_service/routers/inventory.py

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from sqlalchemy import or_, desc
from typing import List
import database, schemas, models
from services.inventory_logger import InventoryLogger

router = APIRouter(tags=["Inventory"])

# --- UNITS (ĞĞ´Ğ¸Ğ½Ğ¸Ñ†Ñ– Ğ²Ğ¸Ğ¼Ñ–Ñ€Ñƒ) ---
@router.post("/units/", response_model=schemas.Unit)
def create_unit(unit: schemas.UnitCreate, db: Session = Depends(database.get_db)):
    exists = db.query(models.Unit).filter(or_(models.Unit.name == unit.name, models.Unit.symbol == unit.symbol)).first()
    if exists: raise HTTPException(status_code=400, detail="ĞĞ´Ğ¸Ğ½Ğ¸Ñ†Ñ Ñ–ÑĞ½ÑƒÑ”")
    db_unit = models.Unit(name=unit.name, symbol=unit.symbol)
    db.add(db_unit); db.commit(); db.refresh(db_unit)
    return db_unit

@router.get("/units/", response_model=List[schemas.Unit])
def read_units(db: Session = Depends(database.get_db)):
    return db.query(models.Unit).all()

# --- INGREDIENTS (Ğ¡Ğ¸Ñ€Ğ¾Ğ²Ğ¸Ğ½Ğ°) ---
@router.post("/ingredients/", response_model=schemas.Ingredient)
def create_ingredient(ingredient: schemas.IngredientCreate, db: Session = Depends(database.get_db)):
    exists = db.query(models.Ingredient).filter(models.Ingredient.name == ingredient.name).first()
    if exists: raise HTTPException(status_code=400, detail="Ingredient already exists")
    new_item = models.Ingredient(**ingredient.dict())
    db.add(new_item); db.commit(); db.refresh(new_item)
    return new_item

@router.get("/ingredients/", response_model=List[schemas.Ingredient])
def read_ingredients(db: Session = Depends(database.get_db)):
    return db.query(models.Ingredient).all()

@router.put("/ingredients/{ingredient_id}", response_model=schemas.Ingredient)
def update_ingredient(ingredient_id: int, ingredient_data: schemas.IngredientCreate, db: Session = Depends(database.get_db)):
    db_ingredient = db.query(models.Ingredient).filter(models.Ingredient.id == ingredient_id).first()
    if not db_ingredient: raise HTTPException(status_code=404, detail="Ingredient not found")
    
    # 1. Ğ—Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ñ”Ğ¼Ğ¾ ÑÑ‚Ğ°Ñ€Ğ¸Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ
    old_balance = db_ingredient.stock_quantity
    
    # 2. ĞĞ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ¿Ğ¾Ğ»Ñ
    db_ingredient.name = ingredient_data.name
    db_ingredient.unit_id = ingredient_data.unit_id
    db_ingredient.cost_per_unit = ingredient_data.cost_per_unit
    
    # 3. Ğ¯ĞºÑ‰Ğ¾ Ğ·Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº Ğ·Ğ¼Ñ–Ğ½Ğ¸Ğ²ÑÑ - Ğ¿Ğ¸ÑˆĞµĞ¼Ğ¾ Ñ†Ğµ
    if ingredient_data.stock_quantity != old_balance:
        db_ingredient.stock_quantity = ingredient_data.stock_quantity
        # Ğ›ĞĞ“Ğ£Ğ’ĞĞĞĞ¯
        InventoryLogger.log(
            db, 
            entity_type="ingredient", 
            entity_id=db_ingredient.id, 
            entity_name=db_ingredient.name, 
            old_balance=old_balance, 
            new_balance=db_ingredient.stock_quantity, 
            reason="manual_correction"
        )
    
    db.commit(); db.refresh(db_ingredient)
    return db_ingredient

@router.delete("/ingredients/{ingredient_id}")
def delete_ingredient(ingredient_id: int, db: Session = Depends(database.get_db)):
    db_ingredient = db.query(models.Ingredient).filter(models.Ingredient.id == ingredient_id).first()
    if not db_ingredient: raise HTTPException(status_code=404)
    try: 
        db.delete(db_ingredient); db.commit()
    except: 
        db.rollback(); raise HTTPException(status_code=400, detail="Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ñ‚ÑŒÑÑ Ğ² Ñ€ĞµÑ†ĞµĞ¿Ñ‚Ğ°Ñ…")
    return {"status": "deleted"}

# --- CONSUMABLES (Ğ’Ğ¸Ñ‚Ñ€Ğ°Ñ‚Ğ½Ñ– Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸) ---
@router.post("/consumables/", response_model=schemas.Consumable)
def create_consumable(item: schemas.ConsumableCreate, db: Session = Depends(database.get_db)):
    exists = db.query(models.Consumable).filter(models.Consumable.name == item.name).first()
    if exists: raise HTTPException(status_code=400, detail="Ğ’Ğ¶Ğµ Ñ–ÑĞ½ÑƒÑ”")
    new_c = models.Consumable(**item.dict())
    db.add(new_c); db.commit(); db.refresh(new_c)
    return new_c

@router.get("/consumables/", response_model=List[schemas.Consumable])
def read_consumables(db: Session = Depends(database.get_db)):
    return db.query(models.Consumable).all()

@router.put("/consumables/{id}", response_model=schemas.Consumable)
def update_consumable(id: int, item: schemas.ConsumableCreate, db: Session = Depends(database.get_db)):
    db_c = db.query(models.Consumable).filter(models.Consumable.id == id).first()
    if not db_c: raise HTTPException(status_code=404)
    
    old_balance = db_c.stock_quantity # <-- Ğ—Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ñ”Ğ¼Ğ¾ ÑÑ‚Ğ°Ñ€Ğµ

    # ĞĞ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ²ÑĞµ
    for k, v in item.dict().items(): setattr(db_c, k, v)
    
    # Ğ›ĞĞ“Ğ£Ğ’ĞĞĞĞ¯
    InventoryLogger.log(
        db,
        entity_type="consumable",
        entity_id=db_c.id,
        entity_name=db_c.name,
        old_balance=old_balance,
        new_balance=db_c.stock_quantity,
        reason="manual_correction"
    )

    db.commit(); db.refresh(db_c)
    return db_c

@router.delete("/consumables/{id}")
def delete_consumable(id: int, db: Session = Depends(database.get_db)):
    db_c = db.query(models.Consumable).filter(models.Consumable.id == id).first()
    if not db_c: raise HTTPException(status_code=404)
    db.delete(db_c); db.commit()
    return {"status": "deleted"}

# === Ğ”ĞĞ”ĞĞ¢Ğ˜ Ğ’ ĞšĞ†ĞĞ•Ğ¦Ğ¬ Ğ¤ĞĞ™Ğ›Ğ£ inventory.py ===

@router.get("/history/")
def get_inventory_history(
    entity_type: str, 
    entity_id: int, 
    limit: int = 50, 
    db: Session = Depends(database.get_db)
):
    # Ğ¦ĞµĞ¹ endpoint Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¸Ğ¹ Ğ·Ğ° Ğ°Ğ´Ñ€ĞµÑĞ¾Ñ /history/ (Ñ‡ĞµÑ€ĞµĞ· Ğ¿Ñ€Ğ¾ĞºÑÑ– /api/history/)
    return db.query(models.InventoryTransaction)\
        .filter(models.InventoryTransaction.entity_type == entity_type)\
        .filter(models.InventoryTransaction.entity_id == entity_id)\
        .order_by(desc(models.InventoryTransaction.created_at))\
        .limit(limit).all()



--------------------------------------------------
PATH: ./product_service/routers/__init__.py
--------------------------------------------------
[EMPTY FILE]

--------------------------------------------------
PATH: ./product_service/routers/products.py
--------------------------------------------------
# FILE: product_service/routers/products.py

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from typing import List
import database, schemas, models
from services.product_service import ProductService
from services.inventory_logger import InventoryLogger

router = APIRouter(prefix="/products", tags=["Products"])

@router.post("/", response_model=schemas.Product)
def create_product(product: schemas.ProductCreate, db: Session = Depends(database.get_db)):
    # Ğ’Ğ¸ĞºĞ»Ğ¸ĞºĞ°Ñ”Ğ¼Ğ¾ ÑĞµÑ€Ğ²Ñ–Ñ, ÑĞºĞ¸Ğ¹ Ğ·Ñ€Ğ¾Ğ±Ğ¸Ñ‚ÑŒ Ğ²ÑÑ Ğ±Ñ€ÑƒĞ´Ğ½Ñƒ Ñ€Ğ¾Ğ±Ğ¾Ñ‚Ñƒ
    return ProductService.create_product(db, product)

@router.put("/{product_id}", response_model=schemas.Product)
def update_product(product_id: int, product_data: schemas.ProductCreate, db: Session = Depends(database.get_db)):
    updated_product = ProductService.update_product(db, product_id, product_data)
    if not updated_product:
        raise HTTPException(status_code=404, detail="Product not found")
    return updated_product

@router.get("/", response_model=List[schemas.Product])
def read_products(db: Session = Depends(database.get_db)):
    products = db.query(models.Product).all()
    
    # --- UI Helper ---
    # Ğ”Ğ¾Ğ·Ğ°Ğ¿Ğ¾Ğ²Ğ½ÑÑ”Ğ¼Ğ¾ Ğ½Ğ°Ğ·Ğ²Ğ¸ Ğ´Ğ»Ñ ĞºÑ€Ğ°ÑĞ¸Ğ²Ğ¾Ğ³Ğ¾ Ğ²Ñ–Ğ´Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ½Ğ° Ñ„Ñ€Ğ¾Ğ½Ñ‚Ñ–
    for p in products:
        # 1. Ğ”Ğ»Ñ ÑĞ°Ğ¼Ğ¾Ğ³Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ
        for c in p.consumables:
            if c.consumable:
                c.consumable_name = c.consumable.name # ĞŸÑ–Ğ´ÑÑ‚Ğ°Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ½Ğ°Ğ·Ğ²Ñƒ

        # 2. Ğ”Ğ›Ğ¯ Ğ’ĞĞ Ğ†ĞĞĞ¢Ğ†Ğ’ (Ğ¦Ğµ Ñ‚Ğµ, Ñ‡Ğ¾Ğ³Ğ¾ Ğ½Ğµ Ğ²Ğ¸ÑÑ‚Ğ°Ñ‡Ğ°Ğ»Ğ¾)
        if p.variants:
            for v in p.variants:
                # ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ğ¸ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ
                for vc in v.consumables:
                    if vc.consumable:
                         # Pydantic ÑÑ…ĞµĞ¼Ğ° Ğ¾Ñ‡Ñ–ĞºÑƒÑ” consumable_name, Ğ·Ğ°Ğ¿Ğ¾Ğ²Ğ½ÑÑ”Ğ¼Ğ¾ Ğ¹Ğ¾Ğ³Ğ¾
                        vc.consumable_name = vc.consumable.name 
                
                # Ğ†Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ğ¸ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ
                for vi in v.ingredients:
                    if vi.ingredient:
                        vi.ingredient_name = vi.ingredient.name

    return products

# 1. ĞĞ½Ğ¾Ğ²Ğ¸Ñ‚Ğ¸ Ğ·Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾Ğ³Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ
@router.patch("/{product_id}/stock")
def update_product_stock(product_id: int, qty: float, db: Session = Depends(database.get_db)):
    product = db.query(models.Product).filter(models.Product.id == product_id).first()
    if not product: raise HTTPException(status_code=404)
    
    old_qty = product.stock_quantity
    product.stock_quantity = qty
    
    InventoryLogger.log(db, "product", product.id, product.name, old_qty, qty, "manual_correction")
    
    db.commit()
    return {"status": "updated", "new_quantity": qty}

# 2. ĞĞ½Ğ¾Ğ²Ğ¸Ñ‚Ğ¸ Ğ·Ğ°Ğ»Ğ¸ÑˆĞ¾Ğº Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ
@router.patch("/variants/{variant_id}/stock")
def update_variant_stock(variant_id: int, qty: float, db: Session = Depends(database.get_db)):
    variant = db.query(models.ProductVariant).filter(models.ProductVariant.id == variant_id).first()
    if not variant: raise HTTPException(status_code=404)
    
    old_qty = variant.stock_quantity
    variant.stock_quantity = qty
    
    # ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ğ½Ğ°Ğ·Ğ²Ñƒ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ Ğ´Ğ»Ñ ĞºÑ€Ğ°ÑĞ¸Ğ²Ğ¾Ğ³Ğ¾ Ğ»Ğ¾Ğ³Ñƒ
    p_name = variant.product.name if variant.product else "Unknown"
    full_name = f"{p_name} ({variant.name})"

    InventoryLogger.log(db, "product_variant", variant.id, full_name, old_qty, qty, "manual_correction")
    
    db.commit()
    return {"status": "updated", "new_quantity": qty}

@router.delete("/{product_id}")
def delete_product(product_id: int, db: Session = Depends(database.get_db)):
    product = db.query(models.Product).filter(models.Product.id == product_id).first()
    if not product:
        raise HTTPException(status_code=404, detail="Product not found")
    
    # Ğ’Ğ¸Ğ´Ğ°Ğ»ĞµĞ½Ğ½Ñ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñƒ ĞºĞ°ÑĞºĞ°Ğ´Ğ½Ğ¾ Ğ²Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸ Ñ‚Ğ° Ğ·Ğ²'ÑĞ·ĞºĞ¸ (Ğ·Ğ°Ğ²Ğ´ÑĞºĞ¸ Ğ½Ğ°Ğ»Ğ°ÑˆÑ‚ÑƒĞ²Ğ°Ğ½Ğ½ÑĞ¼ models.py)
    db.delete(product)
    db.commit()
    return {"status": "deleted"}

--------------------------------------------------
PATH: ./product_service/routers/processes.py
--------------------------------------------------
# FILE: product_service/routers/processes.py

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from typing import List
import database, schemas, models

router = APIRouter(prefix="/processes", tags=["Processes"])

# --- Ğ“Ñ€ÑƒĞ¿Ğ¸ (Ğ½Ğ°Ğ¿Ñ€. ĞŸĞ¾Ğ¼Ğ¾Ğ») ---
@router.post("/groups/", response_model=schemas.ProcessGroup)
def create_process_group(group: schemas.ProcessGroupCreate, db: Session = Depends(database.get_db)):
    new_group = models.ProcessGroup(name=group.name)
    db.add(new_group); db.commit(); db.refresh(new_group)
    
    for opt in group.options:
        db.add(models.ProcessOption(group_id=new_group.id, name=opt.name))
    
    db.commit(); db.refresh(new_group)
    return new_group

@router.get("/groups/", response_model=List[schemas.ProcessGroup])
def read_process_groups(db: Session = Depends(database.get_db)):
    return db.query(models.ProcessGroup).all()

@router.delete("/groups/{id}")
def delete_process_group(id: int, db: Session = Depends(database.get_db)):
    group = db.query(models.ProcessGroup).filter(models.ProcessGroup.id == id).first()
    if not group: raise HTTPException(status_code=404)
    db.delete(group); db.commit()
    return {"status": "deleted"}

# --- ĞĞ¿Ñ†Ñ–Ñ— (Ğ½Ğ°Ğ¿Ñ€. ĞŸÑ–Ğ´ Ñ‚ÑƒÑ€ĞºÑƒ) ---
@router.post("/options/", response_model=schemas.ProcessOption)
def add_process_option(option: schemas.ProcessOptionCreate, group_id: int, db: Session = Depends(database.get_db)):
    new_opt = models.ProcessOption(group_id=group_id, name=option.name)
    db.add(new_opt); db.commit(); db.refresh(new_opt)
    return new_opt

@router.delete("/options/{id}")
def delete_process_option(id: int, db: Session = Depends(database.get_db)):
    opt = db.query(models.ProcessOption).filter(models.ProcessOption.id == id).first()
    if not opt: raise HTTPException(status_code=404)
    db.delete(opt); db.commit()
    return {"status": "deleted"}

--------------------------------------------------
PATH: ./product_service/routers/customers.py
--------------------------------------------------
# FILE: product_service/routers/customers.py

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from sqlalchemy import or_
from typing import List
import database, schemas, models

router = APIRouter(prefix="/customers", tags=["Customers"])

@router.post("/", response_model=schemas.Customer)
def create_customer(customer: schemas.CustomerCreate, db: Session = Depends(database.get_db)):
    # ĞœĞ¾Ğ¶Ğ½Ğ° Ğ´Ğ¾Ğ´Ğ°Ñ‚Ğ¸ Ğ¿ĞµÑ€ĞµĞ²Ñ–Ñ€ĞºÑƒ Ğ½Ğ° ÑƒĞ½Ñ–ĞºĞ°Ğ»ÑŒĞ½Ñ–ÑÑ‚ÑŒ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ñƒ
    new_customer = models.Customer(**customer.dict())
    db.add(new_customer); db.commit(); db.refresh(new_customer)
    return new_customer

@router.get("/search/", response_model=List[schemas.Customer])
def search_customers(q: str, db: Session = Depends(database.get_db)):
    # ĞŸĞ¾ÑˆÑƒĞº Ğ·Ğ° Ñ–Ğ¼'ÑĞ¼ ĞĞ‘Ğ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ¾Ğ¼ (ilike - Ñ€ĞµĞ³Ñ–ÑÑ‚Ñ€Ğ¾Ğ½ĞµĞ·Ğ°Ğ»ĞµĞ¶Ğ½Ğ¸Ğ¹)
    return db.query(models.Customer).filter(
        or_(models.Customer.name.ilike(f"%{q}%"), models.Customer.phone.ilike(f"%{q}%"))
    ).limit(10).all()

@router.get("/", response_model=List[schemas.Customer])
def read_customers(skip: int=0, limit: int=50, db: Session = Depends(database.get_db)):
    return db.query(models.Customer).offset(skip).limit(limit).all()

@router.put("/{id}", response_model=schemas.Customer)
def update_customer(id: int, data: schemas.CustomerCreate, db: Session = Depends(database.get_db)):
    c = db.query(models.Customer).filter(models.Customer.id == id).first()
    if not c: raise HTTPException(status_code=404)
    c.name = data.name
    c.phone = data.phone
    c.email = data.email
    c.notes = data.notes
    db.commit(); db.refresh(c)
    return c

@router.delete("/{id}")
def delete_customer(id: int, db: Session = Depends(database.get_db)): 
    c = db.query(models.Customer).filter(models.Customer.id==id).first()
    if c: db.delete(c); db.commit()
    return {"status": "deleted"}

@router.get("/{customer_id}/orders/", response_model=List[schemas.OrderRead])
def read_customer_orders(customer_id: int, db: Session = Depends(database.get_db)):
    return db.query(models.Order).filter(models.Order.customer_id == customer_id).order_by(models.Order.created_at.desc()).all()

--------------------------------------------------
PATH: ./product_service/services/order_service.py
--------------------------------------------------
from sqlalchemy.orm import Session
import models, schemas
from services.inventory_logger import InventoryLogger
import traceback # Ğ”Ğ»Ñ Ğ²Ğ¸Ğ²Ğ¾Ğ´Ñƒ Ğ¿Ğ¾Ğ¼Ğ¸Ğ»ĞºĞ¸ Ğ² ĞºĞ¾Ğ½ÑĞ¾Ğ»ÑŒ

class OrderService:
    """
    Ğ¦ĞµĞ¹ ĞºĞ»Ğ°Ñ Ğ²Ñ–Ğ´Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ°Ñ” Ğ²Ğ¸ĞºĞ»ÑÑ‡Ğ½Ğ¾ Ğ·Ğ° Ğ¾Ğ±Ñ€Ğ¾Ğ±ĞºÑƒ Ğ·Ğ°Ğ¼Ğ¾Ğ²Ğ»ĞµĞ½ÑŒ.
    Ğ ĞµĞ°Ğ»Ñ–Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ¾ Ğ¿Ñ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿ Atomic Transaction (Ğ²ÑĞµ Ğ°Ğ±Ğ¾ Ğ½Ñ–Ñ‡Ğ¾Ğ³Ğ¾).
    """
    @staticmethod
    def process_checkout(db: Session, order_data: schemas.OrderCreate):
        try:
            # 1. Ğ¡Ñ‚Ğ²Ğ¾Ñ€ÑÑ”Ğ¼Ğ¾ Ğ·Ğ°Ğ¼Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ
            new_order = models.Order(
                total_price=order_data.total_price,
                payment_method=order_data.payment_method,
                customer_id=order_data.customer_id
            )
            db.add(new_order)
            
            # Ğ’ĞĞ–Ğ›Ğ˜Ğ’Ğ: Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ flush(), Ğ° Ğ½Ğµ commit().
            # Ğ¦Ğµ Ğ´Ğ°Ñ” Ğ½Ğ°Ğ¼ ID Ğ·Ğ°Ğ¼Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ, Ğ°Ğ»Ğµ Ğ´Ğ¾Ğ·Ğ²Ğ¾Ğ»ÑÑ” Ğ²Ñ–Ğ´ĞºĞ¾Ñ‚Ğ¸Ñ‚Ğ¸ Ğ·Ğ¼Ñ–Ğ½Ğ¸, ÑĞºÑ‰Ğ¾ ÑÑ‚Ğ°Ñ”Ñ‚ÑŒÑÑ Ğ¿Ğ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ´Ğ°Ğ»Ñ–.
            db.flush() 
            db.refresh(new_order)

            transaction_reason = f"sale_order_{new_order.id}"

            # 2. ĞŸÑ€Ğ¾Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ÑÑŒ Ğ¿Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°Ñ…
            for item in order_data.items:
                product = db.query(models.Product).filter(models.Product.id == item.product_id).first()
                if not product: continue

                item_name = product.name
                price = product.price
                details_list = []
                
                target_recipe_id = None
                base_weight = 0.0

                # --- Ğ. Ğ’ĞĞ Ğ†ĞĞĞ¢Ğ˜ ---
                if item.variant_id:
                    variant = db.query(models.ProductVariant).filter(models.ProductVariant.id == item.variant_id).first()
                    if variant:
                        item_name = f"{product.name} ({variant.name})"
                        price = variant.price
                        details_list.append(f"Ğ’Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚: {variant.name}")
                        
                        target_recipe_id = variant.master_recipe_id or product.master_recipe_id
                        base_weight = variant.output_weight

                        # Ğ¡Ğ¿Ğ¸ÑĞ°Ğ½Ğ½Ñ Ğ·Ğ°Ğ»Ğ¸ÑˆĞºÑƒ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ
                        old_qty = variant.stock_quantity
                        variant.stock_quantity -= item.quantity
                        db.add(variant)
                        
                        InventoryLogger.log(
                            db, "product_variant", variant.id, item_name, 
                            old_qty, variant.stock_quantity, transaction_reason
                        )

                        # Ğ¡Ğ¿Ğ¸ÑĞ°Ğ½Ğ½Ñ Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ñ–Ğ² Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ
                        for vc in variant.consumables:
                            if vc.consumable:
                                c_old = vc.consumable.stock_quantity
                                deduction = vc.quantity * item.quantity
                                vc.consumable.stock_quantity -= deduction
                                db.add(vc.consumable)
                                InventoryLogger.log(db, "consumable", vc.consumable.id, vc.consumable.name, c_old, vc.consumable.stock_quantity, transaction_reason)

                        # !!! ĞĞĞ’Ğ•: Ğ¡Ğ¿Ğ¸ÑĞ°Ğ½Ğ½Ñ Ñ–Ğ½Ğ³Ñ€ĞµĞ´Ñ–Ñ”Ğ½Ñ‚Ñ–Ğ² Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ !!!
                        # Ğ¯ĞºÑ‰Ğ¾ models.py Ğ½Ğµ Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾, Ñ‚ÑƒÑ‚ Ğ±ÑƒĞ´Ğµ Ğ¿Ğ¾Ğ¼Ğ¸Ğ»ĞºĞ° AttributeError.
                        # Ğ—Ğ°Ğ²Ğ´ÑĞºĞ¸ try/except Ğ¼Ğ¸ Ğ¿Ğ¾Ğ±Ğ°Ñ‡Ğ¸Ğ¼Ğ¾ Ñ†Ğµ Ğ² Ğ»Ğ¾Ğ³Ğ°Ñ…, Ğ° Ğ·Ğ°Ğ¼Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ Ğ½Ğµ ÑÑ‚Ğ²Ğ¾Ñ€Ğ¸Ñ‚ÑŒÑÑ.
                        if hasattr(variant, 'ingredients'):
                            for vi in variant.ingredients:
                                if vi.ingredient:
                                    i_old = vi.ingredient.stock_quantity
                                    deduction = vi.quantity * item.quantity
                                    vi.ingredient.stock_quantity -= deduction
                                    db.add(vi.ingredient)
                                    InventoryLogger.log(db, "ingredient", vi.ingredient.id, vi.ingredient.name, i_old, vi.ingredient.stock_quantity, transaction_reason)

                # --- Ğ‘. ĞŸĞ ĞĞ¡Ğ¢Ğ† Ğ¢ĞĞ’ĞĞ Ğ˜ ---
                else:
                    target_recipe_id = product.master_recipe_id
                    base_weight = product.output_weight
                    
                    if product.track_stock:
                        old_qty = product.stock_quantity
                        product.stock_quantity -= item.quantity
                        db.add(product)
                        InventoryLogger.log(db, "product", product.id, product.name, old_qty, product.stock_quantity, transaction_reason)

                # --- Ğ’. Ğ—ĞĞ“ĞĞ›Ğ¬ĞĞ† ĞœĞĞ¢Ğ•Ğ Ğ†ĞĞ›Ğ˜ ---
                for pc in product.consumables:
                    if pc.consumable:
                        c_old = pc.consumable.stock_quantity
                        deduction = pc.quantity * item.quantity
                        pc.consumable.stock_quantity -= deduction
                        db.add(pc.consumable)
                        InventoryLogger.log(db, "consumable", pc.consumable.id, pc.consumable.name, c_old, pc.consumable.stock_quantity, transaction_reason)

                # --- Ğ“. Ğ Ğ•Ğ¦Ğ•ĞŸĞ¢ ---
                if target_recipe_id:
                    recipe = db.query(models.MasterRecipe).filter(models.MasterRecipe.id == target_recipe_id).first()
                    if recipe:
                        for r_item in recipe.items:
                            if r_item.ingredient:
                                deduction_per_item = (r_item.quantity / 100.0 * base_weight) if r_item.is_percentage else r_item.quantity
                                total_deduction = deduction_per_item * item.quantity
                                i_old = r_item.ingredient.stock_quantity
                                r_item.ingredient.stock_quantity -= total_deduction
                                db.add(r_item.ingredient)
                                InventoryLogger.log(db, "ingredient", r_item.ingredient.id, r_item.ingredient.name, i_old, r_item.ingredient.stock_quantity, transaction_reason)

                # --- Ğ”. ĞœĞĞ”Ğ˜Ğ¤Ğ†ĞšĞĞ¢ĞĞ Ğ˜ ---
                for mod_item in item.modifiers:
                    mod = db.query(models.Modifier).filter(models.Modifier.id == mod_item.modifier_id).first()
                    if mod:
                        details_list.append(mod.name)
                        if mod.ingredient:
                            i_old = mod.ingredient.stock_quantity
                            deduction = mod.quantity * item.quantity
                            mod.ingredient.stock_quantity -= deduction
                            db.add(mod.ingredient)
                            InventoryLogger.log(db, "ingredient", mod.ingredient.id, mod.ingredient.name, i_old, mod.ingredient.stock_quantity, transaction_reason)

                # Ğ¤Ñ–ĞºÑÑƒÑ”Ğ¼Ğ¾ Ñ€ÑĞ´Ğ¾Ğº Ğ² Ñ‡ĞµĞºÑƒ
                db.add(models.OrderItem(
                    order_id=new_order.id,
                    product_name=item_name,
                    quantity=item.quantity,
                    price_at_moment=price,
                    details=", ".join(details_list)
                ))

            # 3. Ğ¢Ñ–Ğ»ÑŒĞºĞ¸ ÑĞºÑ‰Ğ¾ Ğ²ÑĞµ Ğ¿Ñ€Ğ¾Ğ¹ÑˆĞ»Ğ¾ Ğ±ĞµĞ· Ğ¿Ğ¾Ğ¼Ğ¸Ğ»Ğ¾Ğº - Ñ„Ñ–ĞºÑÑƒÑ”Ğ¼Ğ¾ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ñ–Ñ
            db.commit()
            return new_order

        except Exception as e:
            # Ğ¯ĞºÑ‰Ğ¾ ÑÑ‚Ğ°Ğ»Ğ°ÑÑŒ Ğ‘Ğ£Ğ”Ğ¬-Ğ¯ĞšĞ Ğ¿Ğ¾Ğ¼Ğ¸Ğ»ĞºĞ° - Ğ²Ñ–Ğ´ĞºĞ¾Ñ‡ÑƒÑ”Ğ¼Ğ¾ Ğ²ÑĞµ (Ñ– ÑÑ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ½Ñ Ğ·Ğ°Ğ¼Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ Ñ‚ĞµĞ¶)
            db.rollback()
            print("âŒ ĞŸĞĞœĞ˜Ğ›ĞšĞ ĞŸĞ Ğ˜ ĞĞŸĞ›ĞĞ¢Ğ† (Transaction Rollback):")
            print(traceback.format_exc()) # Ğ’Ğ¸Ğ²ĞµĞ´Ğµ Ñ‚Ğ¾Ñ‡Ğ½Ñƒ Ğ¿Ñ€Ğ¸Ñ‡Ğ¸Ğ½Ñƒ Ğ² ĞºĞ¾Ğ½ÑĞ¾Ğ»ÑŒ Docker
            raise e # ĞŸÑ€Ğ¾ĞºĞ¸Ğ´ÑƒÑ”Ğ¼Ğ¾ Ğ¿Ğ¾Ğ¼Ğ¸Ğ»ĞºÑƒ Ğ´Ğ°Ğ»Ñ–, Ñ‰Ğ¾Ğ± API Ğ¿Ğ¾Ğ²ĞµÑ€Ğ½ÑƒĞ² 500

--------------------------------------------------
PATH: ./product_service/services/__init__.py
--------------------------------------------------
[EMPTY FILE]

--------------------------------------------------
PATH: ./product_service/services/inventory_logger.py
--------------------------------------------------
from sqlalchemy.orm import Session
import models
from datetime import datetime

class InventoryLogger:
    @staticmethod
    def log(db: Session, entity_type: str, entity_id: int, entity_name: str, old_balance: float, new_balance: float, reason: str = "manual"):
        change = new_balance - old_balance
        if change == 0: return

        transaction = models.InventoryTransaction(
            entity_type=entity_type,
            entity_id=entity_id,
            entity_name=entity_name,
            change_amount=change,
            balance_after=new_balance,
            reason=reason,
            created_at=datetime.utcnow()
        )
        db.add(transaction)

--------------------------------------------------
PATH: ./product_service/services/product_service.py
--------------------------------------------------
from sqlalchemy.orm import Session
from fastapi import HTTPException
import models
import schemas
import uuid

class ProductService:
    """
    ĞšĞ»Ğ°Ñ Ğ´Ğ»Ñ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»Ñ–Ğ½Ğ½Ñ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°Ğ¼Ğ¸.
    Ğ’ÑÑ Ğ»Ğ¾Ğ³Ñ–ĞºĞ° ÑÑ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ½Ñ (Create) Ñ‚Ğ° Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ (Update).
    """

    @staticmethod
    def create_product(db: Session, product: schemas.ProductCreate):
        # 1. Ğ¡Ğ¢Ğ’ĞĞ Ğ•ĞĞĞ¯ Ğ‘ĞĞ—ĞĞ’ĞĞ“Ğ Ğ¢ĞĞ’ĞĞ Ğ£
        db_product = models.Product(
            name=product.name, 
            price=product.price, 
            description=product.description,
            category_id=product.category_id, 
            has_variants=product.has_variants,
            master_recipe_id=product.master_recipe_id, 
            output_weight=product.output_weight,
            track_stock=product.track_stock,
            stock_quantity=product.stock_quantity
        )
        db.add(db_product)
        db.commit()
        db.refresh(db_product)

        # 2. Ğ”ĞĞ”ĞĞ’ĞĞĞĞ¯ Ğ’Ğ˜Ğ¢Ğ ĞĞ¢ĞĞ˜Ğ¥ ĞœĞĞ¢Ğ•Ğ Ğ†ĞĞ›Ğ†Ğ’ (Ğ—ĞĞ“ĞĞ›Ğ¬ĞĞ†)
        for cons in product.consumables:
            db.add(models.ProductConsumable(
                product_id=db_product.id, 
                consumable_id=cons.consumable_id, 
                quantity=cons.quantity
            ))

        # 3. Ğ¡Ğ¢Ğ’ĞĞ Ğ•ĞĞĞ¯ Ğ’ĞĞ Ğ†ĞĞĞ¢Ğ†Ğ’
        if product.has_variants and product.variants:
            for v in product.variants:
                sku = v.sku if v.sku else str(uuid.uuid4())
                
                db_variant = models.ProductVariant(
                    product_id=db_product.id, 
                    name=v.name, 
                    price=v.price, 
                    sku=sku,
                    master_recipe_id=v.master_recipe_id, 
                    output_weight=v.output_weight,
                    stock_quantity=v.stock_quantity 
                )
                db.add(db_variant)
                db.flush() 
                
                for vc in v.consumables:
                    db.add(models.ProductVariantConsumable(
                        variant_id=db_variant.id, 
                        consumable_id=vc.consumable_id, 
                        quantity=vc.quantity
                    ))
                
                for vi in v.ingredients:
                    db.add(models.ProductVariantIngredient(
                        variant_id=db_variant.id, 
                        ingredient_id=vi.ingredient_id, 
                        quantity=vi.quantity
                    ))

        # 4. ĞœĞĞ”Ğ˜Ğ¤Ğ†ĞšĞĞ¢ĞĞ Ğ˜
        for group in product.modifier_groups:
            db_group = models.ProductModifierGroup(
                product_id=db_product.id, 
                name=group.name, 
                is_required=group.is_required
            )
            db.add(db_group)
            db.flush()
            for mod in group.modifiers:
                db.add(models.Modifier(
                    group_id=db_group.id, 
                    name=mod.name, 
                    price_change=mod.price_change, 
                    ingredient_id=mod.ingredient_id, 
                    quantity=mod.quantity
                ))

        # 5. Ğ“Ğ Ğ£ĞŸĞ˜ ĞŸĞ ĞĞ¦Ğ•Ğ¡Ğ†Ğ’
        if product.process_group_ids:
            for pg_id in product.process_group_ids:
                pg = db.query(models.ProcessGroup).filter(
                    models.ProcessGroup.id == pg_id
                ).first()
                if pg:
                    db_product.process_groups.append(pg)

        db.commit()
        db.refresh(db_product)
        return db_product
    
    @staticmethod
    def update_product(db: Session, product_id: int, product_data: schemas.ProductCreate):
        db_product = db.query(models.Product).filter(models.Product.id == product_id).first()
        if not db_product:
            return None

        # 1. ĞĞ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¸Ñ… Ğ¿Ğ¾Ğ»Ñ–Ğ²
        db_product.name = product_data.name
        db_product.description = product_data.description
        db_product.price = product_data.price
        db_product.category_id = product_data.category_id
        db_product.has_variants = product_data.has_variants
        db_product.master_recipe_id = product_data.master_recipe_id
        db_product.output_weight = product_data.output_weight
        
        db_product.track_stock = product_data.track_stock
        if not product_data.track_stock:
             db_product.stock_quantity = product_data.stock_quantity

        # 2. ĞĞ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ Ğ¼Ğ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ñ–Ğ² (Consumables)
        db.query(models.ProductConsumable).filter(
            models.ProductConsumable.product_id == product_id
        ).delete()
        
        for cons in product_data.consumables:
            db.add(models.ProductConsumable(
                product_id=product_id, 
                consumable_id=cons.consumable_id, 
                quantity=cons.quantity
            ))

        # 3. ĞĞĞĞ’Ğ›Ğ•ĞĞĞ¯ Ğ’ĞĞ Ğ†ĞĞĞ¢Ğ†Ğ’
        if product_data.has_variants and product_data.variants:
            
            # [A] Ğ’Ğ˜Ğ”ĞĞ›Ğ•ĞĞĞ¯: Ğ—Ğ½Ğ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸, ÑĞºĞ¸Ñ… Ğ½ĞµĞ¼Ğ°Ñ” Ğ² Ğ½Ğ¾Ğ²Ğ¾Ğ¼Ñƒ ÑĞ¿Ğ¸ÑĞºÑƒ
            incoming_names = [v.name for v in product_data.variants]
            
            # Ğ—Ğ½Ğ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ Ğ¾Ğ±'Ñ”ĞºÑ‚Ğ¸, ÑĞºÑ– Ñ‚Ñ€ĞµĞ±Ğ° Ğ²Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğ¸
            variants_to_delete = db.query(models.ProductVariant).filter(
               models.ProductVariant.product_id == product_id,
               models.ProductVariant.name.notin_(incoming_names)
            ).all()

            # --- Ğ’Ğ˜ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞĞ¯: Ğ‘ĞµĞ·Ğ¿ĞµÑ‡Ğ½Ğµ Ğ²Ğ¸Ğ´Ğ°Ğ»ĞµĞ½Ğ½Ñ ---
            for variant in variants_to_delete:
                # Ğ¡Ğ¿Ğ¾Ñ‡Ğ°Ñ‚ĞºÑƒ Ğ²Ğ¸Ğ´Ğ°Ğ»ÑÑ”Ğ¼Ğ¾ Ğ·Ğ°Ğ»ĞµĞ¶Ğ½Ğ¾ÑÑ‚Ñ– (Ğ´Ñ–Ñ‚ĞµĞ¹)
                db.query(models.ProductVariantConsumable).filter(
                    models.ProductVariantConsumable.variant_id == variant.id
                ).delete()
                
                db.query(models.ProductVariantIngredient).filter(
                    models.ProductVariantIngredient.variant_id == variant.id
                ).delete()
                
                # Ğ¢ĞµĞ¿ĞµÑ€ Ğ¼Ğ¾Ğ¶Ğ½Ğ° Ğ²Ğ¸Ğ´Ğ°Ğ»ÑÑ‚Ğ¸ ÑĞ°Ğ¼ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚
                db.delete(variant)
            # --------------------------------------

            # [B] ĞĞĞĞ’Ğ›Ğ•ĞĞĞ¯ Ğ°Ğ±Ğ¾ Ğ¡Ğ¢Ğ’ĞĞ Ğ•ĞĞĞ¯
            for v in product_data.variants:
                db_variant = db.query(models.ProductVariant).filter(
                    models.ProductVariant.product_id == product_id,
                    models.ProductVariant.name == v.name
                ).first()

                if db_variant:
                    # ĞĞ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾
                    db_variant.price = v.price
                    db_variant.master_recipe_id = v.master_recipe_id
                    db_variant.output_weight = v.output_weight
                    db_variant.stock_quantity = v.stock_quantity
                else:
                    # Ğ¡Ñ‚Ğ²Ğ¾Ñ€ÑÑ”Ğ¼Ğ¾
                    sku = v.sku if v.sku else str(uuid.uuid4())
                    db_variant = models.ProductVariant(
                        product_id=product_id,
                        name=v.name,
                        price=v.price,
                        sku=sku,
                        master_recipe_id=v.master_recipe_id,
                        output_weight=v.output_weight,
                        stock_quantity=v.stock_quantity
                    )
                    db.add(db_variant)
                
                db.flush() 

                # [C] ĞÑ‡Ğ¸Ñ‰Ğ°Ñ”Ğ¼Ğ¾ Ñ‚Ğ° Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿Ğ¸ÑÑƒÑ”Ğ¼Ğ¾ ÑĞºĞ»Ğ°Ğ´ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñƒ
                db.query(models.ProductVariantConsumable).filter(
                    models.ProductVariantConsumable.variant_id == db_variant.id
                ).delete()

                db.query(models.ProductVariantIngredient).filter(
                    models.ProductVariantIngredient.variant_id == db_variant.id
                ).delete()

                for vc in v.consumables:
                    db.add(models.ProductVariantConsumable(
                        variant_id=db_variant.id, 
                        consumable_id=vc.consumable_id, 
                        quantity=vc.quantity
                    ))
                
                for vi in v.ingredients:
                    db.add(models.ProductVariantIngredient(
                        variant_id=db_variant.id, 
                        ingredient_id=vi.ingredient_id, 
                        quantity=vi.quantity
                    ))
        else:
            # Ğ¯ĞºÑ‰Ğ¾ Ğ·Ğ½ÑĞ»Ğ¸ Ğ³Ğ°Ğ»Ğ¾Ñ‡ĞºÑƒ "Ğ’Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸" - Ğ²Ğ¸Ğ´Ğ°Ğ»ÑÑ”Ğ¼Ğ¾ Ğ²ÑĞµ
            # Ğ¢ÑƒÑ‚ Ñ‚ĞµĞ¶ Ñ‚Ñ€ĞµĞ±Ğ° Ğ±ĞµĞ·Ğ¿ĞµÑ‡Ğ½Ğµ Ğ²Ğ¸Ğ´Ğ°Ğ»ĞµĞ½Ğ½Ñ, ÑĞºÑ‰Ğ¾ Ñƒ Ğ²Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ñ–Ğ² Ñ” Ğ´Ñ–Ñ‚Ğ¸
            all_variants = db.query(models.ProductVariant).filter(
                models.ProductVariant.product_id == product_id
            ).all()
            
            for variant in all_variants:
                db.query(models.ProductVariantConsumable).filter_by(variant_id=variant.id).delete()
                db.query(models.ProductVariantIngredient).filter_by(variant_id=variant.id).delete()
                db.delete(variant)

        # 4. ĞœĞĞ”Ğ˜Ğ¤Ğ†ĞšĞĞ¢ĞĞ Ğ˜
        db.query(models.ProductModifierGroup).filter(
            models.ProductModifierGroup.product_id == product_id
        ).delete()
        
        for group in product_data.modifier_groups:
            db_group = models.ProductModifierGroup(
                product_id=product_id, 
                name=group.name, 
                is_required=group.is_required
            )
            db.add(db_group)
            db.flush()
            for mod in group.modifiers:
                db.add(models.Modifier(
                    group_id=db_group.id, 
                    name=mod.name, 
                    price_change=mod.price_change, 
                    ingredient_id=mod.ingredient_id, 
                    quantity=mod.quantity
                ))

        # 5. ĞŸĞ ĞĞ¦Ğ•Ğ¡Ğ˜
        db_product.process_groups = [] 
        if product_data.process_group_ids:
            for pg_id in product_data.process_group_ids:
                pg = db.query(models.ProcessGroup).filter(
                    models.ProcessGroup.id == pg_id
                ).first()
                if pg:
                    db_product.process_groups.append(pg)

        db.commit()
        db.refresh(db_product)
        return db_product
